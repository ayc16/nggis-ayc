import{a as Z}from"./chunk-R5K6EMED.js";import{b as I,c as rt}from"./chunk-XSJRPCD6.js";import{a as tt,b as et}from"./chunk-3DDJTCET.js";import{i as J,j as Q,k as _}from"./chunk-GJBALZEB.js";import{a as Y}from"./chunk-RHABF3KL.js";import{i as R}from"./chunk-OW7DVBQB.js";import{a as $}from"./chunk-NDZXQR2V.js";import{k as d,l as G,n as p,z as m}from"./chunk-ZAQLF7TN.js";import{a as j}from"./chunk-GBTN5LIS.js";import{a as q}from"./chunk-RQD6EDD6.js";import{_ as W,w as V,x as k}from"./chunk-XPCG2OJX.js";import{a as w}from"./chunk-W3WDPWBE.js";import{j as K,k as H,p as z}from"./chunk-GISCFF3Z.js";import{c as X,d as O}from"./chunk-MLSR6YE6.js";import{r as b,t as y}from"./chunk-HQMV3KQV.js";import{v as E,x as f}from"./chunk-CRMMDK2Z.js";import{a as v,h as u}from"./chunk-EAH6BNBL.js";function st(){return at??=u(this,null,function*(){let t=yield import("./chunk-3U2FW77Q.js"),e=yield t.default({locateFile:r=>q(`esri/libs/basisu/${r}`)});return e.initializeBasis(),e}),at}var at;var g;(function(t){t[t.ETC1_RGB=0]="ETC1_RGB",t[t.ETC2_RGBA=1]="ETC2_RGBA",t[t.BC1_RGB=2]="BC1_RGB",t[t.BC3_RGBA=3]="BC3_RGBA",t[t.BC4_R=4]="BC4_R",t[t.BC5_RG=5]="BC5_RG",t[t.BC7_M6_RGB=6]="BC7_M6_RGB",t[t.BC7_M5_RGBA=7]="BC7_M5_RGBA",t[t.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",t[t.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",t[t.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",t[t.ATC_RGB=11]="ATC_RGB",t[t.ATC_RGBA=12]="ATC_RGBA",t[t.FXT1_RGB=17]="FXT1_RGB",t[t.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",t[t.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",t[t.ETC2_EAC_R11=20]="ETC2_EAC_R11",t[t.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",t[t.RGBA32=13]="RGBA32",t[t.RGB565=14]="RGB565",t[t.BGR565=15]="BGR565",t[t.RGBA4444=16]="RGBA4444"})(g||(g={}));var h=null,S=null;function it(){return u(this,null,function*(){return S==null&&(S=st(),h=yield S),S})}function ot(t,e){if(h==null)return t.byteLength;let r=new h.BasisFile(new Uint8Array(t)),a=mt(r)?lt(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),e):0;return r.close(),r.delete(),a}function nt(t,e){if(h==null)return t.byteLength;let r=new h.KTX2File(new Uint8Array(t)),a=ht(r)?lt(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),e):0;return r.close(),r.delete(),a}function lt(t,e,r,a,s){let i=J(e?m.COMPRESSED_RGBA8_ETC2_EAC:m.COMPRESSED_RGB8_ETC2),o=s&&t>1?(4**t-1)/(3*4**(t-1)):1;return Math.ceil(r*a*i*o)}function mt(t){return t.getNumImages()>=1&&!t.isUASTC()}function ht(t){return t.getFaces()>=1&&t.isETC1S()}function ut(t,e,r){return u(this,null,function*(){h==null&&(h=yield it());let a=new h.BasisFile(new Uint8Array(r));if(!mt(a))return null;a.startTranscoding();let s=ct(t,e,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),(i,o)=>a.getImageTranscodedSizeInBytes(0,i,o),(i,o,n)=>a.transcodeImage(n,0,i,o,0,0));return a.close(),a.delete(),s})}function dt(t,e,r){return u(this,null,function*(){h==null&&(h=yield it());let a=new h.KTX2File(new Uint8Array(r));if(!ht(a))return null;a.startTranscoding();let s=ct(t,e,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),(i,o)=>a.getImageTranscodedSizeInBytes(i,0,0,o),(i,o,n)=>a.transcodeImage(n,i,0,0,o,0,-1,-1));return a.close(),a.delete(),s})}function ct(t,e,r,a,s,i,o,n){let{compressedTextureETC:l,compressedTextureS3TC:C}=t.capabilities,[A,M]=l?a?[g.ETC2_RGBA,m.COMPRESSED_RGBA8_ETC2_EAC]:[g.ETC1_RGB,m.COMPRESSED_RGB8_ETC2]:C?a?[g.BC3_RGBA,m.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[g.BC1_RGB,m.COMPRESSED_RGB_S3TC_DXT1_EXT]:[g.RGBA32,p.RGBA],B=e.hasMipmap?r:Math.min(1,r),T=[];for(let c=0;c<B;c++)T.push(new Uint8Array(o(c,A))),n(c,A,T[c]);return e.internalFormat=M,e.hasMipmap=T.length>1,e.samplingMode=e.hasMipmap?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,e.width=s,e.height=i,new _(t,e,{type:"compressed",levels:T})}var F=()=>b.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),ft=542327876,Rt=131072,Ct=4;function U(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function Bt(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)}var xt=U("DXT1"),Dt=U("DXT3"),Mt=U("DXT5"),wt=31,yt=0,Gt=1,It=2,St=3,Ft=4,Pt=7,vt=20,Ht=21;function pt(t,e,r){let a=Vt(r,e.hasMipmap??!1);if(a==null)throw new Error("DDS texture data is null");let{textureData:s,internalFormat:i,width:o,height:n}=a;return e.samplingMode=s.levels.length>1?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,e.hasMipmap=s.levels.length>1,e.internalFormat=i,e.width=o,e.height=n,new _(t,e,s)}function Vt(t,e){let r=new Int32Array(t,0,wt);if(r[yt]!==ft)return F().error("Invalid magic number in DDS header"),null;if(!(r[vt]&Ct))return F().error("Unsupported format, must contain a FourCC code"),null;let a=r[Ht],s,i;switch(a){case xt:s=8,i=m.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Dt:s=16,i=m.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Mt:s=16,i=m.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return F().error("Unsupported FourCC code:",Bt(a)),null}let o=1,n=r[Ft],l=r[St];(3&n||3&l)&&(F().warn("Rounding up compressed texture size to nearest multiple of 4."),n=n+3&-4,l=l+3&-4);let C=n,A=l,M,B;r[It]&Rt&&e!==!1&&(o=Math.max(1,r[Pt]));let T=r[Gt]+4,c=[];for(let N=0;N<o;++N)B=(n+3>>2)*(l+3>>2)*s,M=new Uint8Array(t,T,B),c.push(M),T+=B,n=Math.max(1,n>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:c},internalFormat:i,width:C,height:A}}var P=16;function ee(t){return Math.ceil(t/P)*P}function re(t){return Math.floor(t/P)*P}function _t(t,e){let i=t.width*t.height;if(i<4096)return t instanceof ImageData?Tt(t):t;let o=t.width,n=t.height;do o=Math.ceil(o/2),n=Math.ceil(n/2),i=o*n;while(i>1048576||e!=null&&(o>e||n>e));return L(t,o,n)}function gt(t,e){let r=Math.max(t.width,t.height);if(r<=e)return t;let a=e/r;return L(t,Math.round(t.width*a),Math.round(t.height*a))}function L(t,e,r){if(t instanceof ImageData)return L(Tt(t),e,r);let a=document.createElement("canvas");return a.width=e,a.height=r,a.getContext("2d").drawImage(t,0,0,a.width,a.height),a}function Tt(t){let e=document.createElement("canvas");e.width=t.width,e.height=t.height;let r=e.getContext("2d");if(r==null)throw new y("Failed to create 2d context from HTMLCanvasElement");return r.putImageData(t,0,0),e}var At=class extends tt{get parameters(){return this._parameters}constructor(e,r){super(),this._data=e,this.type=et.Texture,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this.events=new j,this._parameters=v(v({},Lt),r),this._startPreload(e)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(e){e!=null&&(e instanceof HTMLVideoElement?(this.frameUpdate=r=>this._frameUpdate(e,r),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(V(e.src)||e.preload==="auto"&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";let r=!e.paused;if(e.src=e.src,r&&e.autoplay){let a=()=>{e.removeEventListener("canplay",a),e.play()};e.addEventListener("canplay",a)}}}_startPreloadImageElement(e){k(e.src)||V(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){let r=new Q;return r.wrapMode=this._parameters.wrap??G.REPEAT,r.flipped=!this._parameters.noUnpackFlip,r.samplingMode=this._parameters.mipmap?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,r.hasMipmap=!!this._parameters.mipmap,r.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,r.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),r}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.usedMemory||Ut(this._data,this._parameters)}load(e){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;let r=this._data;return r==null?(this._glTexture=new _(e,this._createDescriptor(e),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),typeof r=="string"?this._loadFromURL(e,r):r instanceof Image?this._loadFromImageElement(e,r):r instanceof HTMLVideoElement?this._loadFromVideoElement(e,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this._loadFromImage(e,r):(E(r)||f(r))&&this._parameters.encoding===R.DDS_ENCODING?this._loadFromDDSData(e,r):(E(r)||f(r))&&this._parameters.encoding===R.KTX2_ENCODING?this._loadFromKTX2(e,r):(E(r)||f(r))&&this._parameters.encoding===R.BASIS_ENCODING?this._loadFromBasis(e,r):f(r)?this._loadFromPixelData(e,r):E(r)?this._loadFromPixelData(e,new Uint8Array(r)):null)}_frameUpdate(e,r){return this._glTexture==null||e.readyState<x.HAVE_CURRENT_DATA||r===e.currentTime?r:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,r){return this._glTexture=pt(e,this._createDescriptor(e),r),this._glTexture}_loadFromKTX2(e,r){return this._loadAsync(()=>dt(e,this._createDescriptor(e),r).then(a=>(this._glTexture=a,a)))}_loadFromBasis(e,r){return this._loadAsync(()=>ut(e,this._createDescriptor(e),r).then(a=>(this._glTexture=a,a)))}_loadFromPixelData(e,r){$(this._parameters.width>0&&this._parameters.height>0);let a=this._createDescriptor(e);return a.pixelFormat=this._parameters.components===1?p.LUMINANCE:this._parameters.components===3?p.RGB:p.RGBA,a.width=this._parameters.width??0,a.height=this._parameters.height??0,this._glTexture=new _(e,a,r),this._glTexture}_loadFromURL(e,r){return this._loadAsync(a=>u(this,null,function*(){let s=yield Z(r,{signal:a});return H(a),this._loadFromImage(e,s)}))}_loadFromImageElement(e,r){return r.complete?this._loadFromImage(e,r):this._loadAsync(a=>u(this,null,function*(){let s=yield W(r,r.src,!1,a);return H(a),this._loadFromImage(e,s)}))}_loadFromVideoElement(e,r){return r.readyState>=x.HAVE_CURRENT_DATA?this._loadFromImage(e,r):this._loadFromVideoElementAsync(e,r)}_loadFromVideoElementAsync(e,r){return this._loadAsync(a=>new Promise((s,i)=>{let o=()=>{r.removeEventListener("loadeddata",n),r.removeEventListener("error",l),O(C)},n=()=>{r.readyState>=x.HAVE_CURRENT_DATA&&(o(),s(this._loadFromImage(e,r)))},l=A=>{o(),i(A||new y("Failed to load video"))};r.addEventListener("loadeddata",n),r.addEventListener("error",l);let C=z(a,()=>l(K()))}))}_loadFromImage(e,r){let a=r;if(!(a instanceof HTMLVideoElement)){let{maxTextureSize:o}=e.parameters;a=this._parameters.downsampleUncompressed?_t(a,o):gt(a,o)}let s=Et(a);this._parameters.width=s.width,this._parameters.height=s.height;let i=this._createDescriptor(e);return i.pixelFormat=this._parameters.components===3?p.RGB:p.RGBA,i.width=s.width,i.height=s.height,this._glTexture=new _(e,i,a),this._glTexture}_loadAsync(e){let r=new AbortController;this._loadingController=r;let a=e(r.signal);this._loadingPromise=a;let s=()=>{this._loadingController===r&&(this._loadingController=null),this._loadingPromise===a&&(this._loadingPromise=null)};return a.then(s,s),a}unload(){if(this._glTexture=X(this._glTexture),this._loadingController!=null){let e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}};function Ut(t,e){if(t==null)return 0;if(E(t)||f(t))return e.encoding===R.KTX2_ENCODING?nt(t,!!e.mipmap):e.encoding===R.BASIS_ENCODING?ot(t,!!e.mipmap):t.byteLength;let{width:r,height:a}=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?Et(t):e;return(e.mipmap?4/3:1)*r*a*(e.components||4)||0}function Et(t){return t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t}var x;(function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(x||(x={}));var Lt={wrap:{s:G.REPEAT,t:G.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1};var D=class extends rt{};w([I({constValue:!0})],D.prototype,"hasSliceHighlight",void 0),w([I({constValue:!1})],D.prototype,"hasSliceInVertexProgram",void 0),w([I({constValue:Y.Pass})],D.prototype,"pbrTextureBindType",void 0);export{ee as a,re as b,At as c,D as d};
