import{a as f}from"./chunk-SMUMHGTW.js";import{a as v}from"./chunk-LCUC2WGG.js";import{a as b}from"./chunk-C75DYIHX.js";import{b as d}from"./chunk-TUJ6FPE6.js";import{d as p}from"./chunk-ZV7ILGPO.js";import{a as I}from"./chunk-5TVEQGKJ.js";import{r as N}from"./chunk-X3IDZTNG.js";import{a as w,b as g,h as n}from"./chunk-EAH6BNBL.js";var L=class{constructor(){this._serviceMetadatas=new Map,this._itemDatas=new Map}fetchServiceMetadata(a,t){return n(this,null,function*(){let r=this._serviceMetadatas.get(a);if(r)return r;let s=yield v(a,t);return this._serviceMetadatas.set(a,s),s})}fetchItemData(a){return n(this,null,function*(){let{id:t}=a;if(!t)return null;let{_itemDatas:r}=this;if(r.has(t))return r.get(t);let s=yield a.fetchData();return r.set(t,s),s})}fetchCustomParameters(a,t){return n(this,null,function*(){let r=yield this.fetchItemData(a);return r&&typeof r=="object"&&(t?t(r):r.customParameters)||null})}};function y(e){let a={id:e.id,name:e.name};return e.type==="Oriented Imagery Layer"&&(a.layerType="OrientedImageryLayer"),a}function M(e,a,t){return n(this,null,function*(){if(e?.layers==null||e?.tables==null){let r=yield t.fetchServiceMetadata(a,{customParameters:l(e)?.customParameters});(e=e||{}).layers=e.layers||r?.layers?.map(y),e.tables=e.tables||r?.tables?.map(y)}return e})}function T(e){let{layers:a,tables:t}=e;return a?.length?a[0].id:t?.length?t[0].id:null}function l(e){if(!e)return null;let{layers:a,tables:t}=e;return a?.length?a[0]:t?.length?t[0]:null}function S(e){return(e?.layers?.length??0)+(e?.tables?.length??0)}function C(e){let a=[];return e?.layers?.forEach(t=>{t.layerType==="SubtypeGroupLayer"&&a.push(t.id)}),a}function P(e){return e?.layers?.filter(({layerType:a})=>a==="OrientedImageryLayer").map(({id:a})=>a)}function O(e){return e?.layers?.filter(({layerType:a})=>a==="CatalogLayer").map(({id:a})=>a)}function F(e,a,t){return n(this,null,function*(){if(!e?.url)return a??{};if(a??={},!a.layers){let c=yield t.fetchServiceMetadata(e.url);a.layers=c.layers?.map(y)}let{serverUrl:r,portalItem:s}=yield f(e.url,{sceneLayerItem:e,customParameters:l(a)?.customParameters}).catch(()=>({serverUrl:null,portalItem:null}));if(r==null)return a.tables=[],a;if(!a.tables&&s){let c=yield s.fetchData();if(c?.tables)a.tables=c.tables.map(y);else{let i=yield t.fetchServiceMetadata(r,{customParameters:l(c)?.customParameters});a.tables=i?.tables?.map(y)}}if(a.tables)for(let c of a.tables)c.url=`${r}/${c.id}`;return a})}function Le(e){return n(this,null,function*(){!e.portalItem||e.portalItem instanceof I||(e=g(w({},e),{portalItem:new I(e.portalItem)}));let a=yield J(e.portalItem);return new a.constructor(w({portalItem:e.portalItem},a.properties))})}function J(e){return n(this,null,function*(){yield e.load();let a=new L;return V(yield K(e,a))})}function K(e,a){return n(this,null,function*(){switch(e.type){case"3DTiles Service":return q();case"CSV":return z();case"Feature Collection":return k(e);case"Feature Service":return j(e,a);case"Feed":return Y();case"GeoJson":return R();case"Group Layer":return Z();case"Image Service":return U(e,a);case"KML":return B();case"Map Service":return W(e,a);case"Media Layer":return ee();case"Scene Service":return $(e,a);case"Stream Service":return _();case"Vector Tile Service":return E();case"WFS":return H();case"WMS":return Q();case"WMTS":return X();default:throw new N("portal:unknown-item-type","Unknown item type '${type}'",{type:e.type})}})}function V(e){return n(this,null,function*(){let a=e.className,t=b[a];return{constructor:yield t(),properties:e.properties}})}function W(e,a){return n(this,null,function*(){return(yield ae(e,a))?{className:"TileLayer"}:{className:"MapImageLayer"}})}function j(e,a){return n(this,null,function*(){let t=yield D(e,a);if(typeof t=="object"){let{sourceJSON:r,className:s}=t,c={sourceJSON:r};return t.id!=null&&(c.layerId=t.id),{className:s||"FeatureLayer",properties:c}}return{className:"GroupLayer"}})}function $(e,a){return n(this,null,function*(){let t=yield D(e,a,()=>n(this,null,function*(){try{if(!e.url)return[];let{serverUrl:r}=yield f(e.url,{sceneLayerItem:e});return(yield a.fetchServiceMetadata(r))?.tables??[]}catch{return[]}}));if(typeof t=="object"){let r={},s;if(t.id!=null?(r.layerId=t.id,s=`${e.url}/layers/${t.id}`):s=e.url,e.typeKeywords?.length){for(let i of Object.keys(p))if(e.typeKeywords.includes(i))return{className:p[i]}}let c=yield a.fetchServiceMetadata(s,{customParameters:yield a.fetchCustomParameters(e,i=>l(i)?.customParameters)});return{className:p[c?.layerType]||"SceneLayer",properties:r}}return t===!1&&(yield a.fetchServiceMetadata(e.url))?.layerType==="Voxel"?{className:"VoxelLayer"}:{className:"GroupLayer"}})}function k(e){return n(this,null,function*(){yield e.load();let a=d(e,"Map Notes"),t=d(e,"Markup");if(a||t)return{className:"MapNotesLayer"};if(d(e,"Route Layer"))return{className:"RouteLayer"};let r=yield e.fetchData();return S(r)===1?{className:"FeatureLayer"}:{className:"GroupLayer"}})}function U(e,a){return n(this,null,function*(){yield e.load();let t=e.typeKeywords?.map(u=>u.toLowerCase())??[];if(t.includes("elevation 3d layer"))return{className:"ElevationLayer"};if(t.includes("tiled imagery"))return{className:"ImageryTileLayer"};let r=yield a.fetchItemData(e),s=r?.layerType;if(s==="ArcGISTiledImageServiceLayer")return{className:"ImageryTileLayer"};if(s==="ArcGISImageServiceLayer")return{className:"ImageryLayer"};let c=yield a.fetchServiceMetadata(e.url,{customParameters:yield a.fetchCustomParameters(e)}),i=c.cacheType?.toLowerCase(),m=c.capabilities?.toLowerCase().includes("tilesonly");return i==="map"||m?{className:"ImageryTileLayer"}:{className:"ImageryLayer"}})}function _(){return{className:"StreamLayer"}}function E(){return{className:"VectorTileLayer"}}function R(){return{className:"GeoJSONLayer"}}function q(){return{className:"IntegratedMesh3DTilesLayer"}}function z(){return{className:"CSVLayer"}}function B(){return{className:"KMLLayer"}}function H(){return{className:"WFSLayer"}}function Q(){return{className:"WMSLayer"}}function X(){return{className:"WMTSLayer"}}function Y(){return{className:"StreamLayer"}}function Z(){return{className:"GroupLayer"}}function ee(){return{className:"MediaLayer"}}function ae(e,a){return n(this,null,function*(){let{tileInfo:t}=yield a.fetchServiceMetadata(e.url,{customParameters:yield a.fetchCustomParameters(e)});return t})}function D(e,a,t){return n(this,null,function*(){let{url:r,type:s}=e,c=s==="Feature Service";if(!r)return{};if(/\/\d+$/.test(r)){if(c){let u=yield a.fetchServiceMetadata(r,{customParameters:yield a.fetchCustomParameters(e,o=>l(o)?.customParameters)});if(u.type==="Oriented Imagery Layer")return{id:u.id,className:"OrientedImageryLayer",sourceJSON:u}}return{}}yield e.load();let i=yield a.fetchItemData(e);if(c){let u=yield M(i,r,a),o=h(u);if(typeof o=="object"){let G=C(u),x=P(u),A=O(u);o.className=o.id!=null&&G.includes(o.id)?"SubtypeGroupLayer":o.id!=null&&x?.includes(o.id)?"OrientedImageryLayer":o.id!=null&&A?.includes(o.id)?"CatalogLayer":"FeatureLayer"}return o}if(s==="Scene Service"&&(i=yield F(e,i,a)),S(i)>0)return h(i);let m=yield a.fetchServiceMetadata(r);return t&&(m.tables=yield t()),h(m)})}function h(e){return S(e)===1&&{id:T(e)}}export{L as a,y as b,M as c,T as d,l as e,S as f,C as g,P as h,O as i,F as j,Le as k,K as l};
