import{a as c}from"./chunk-CPDJJRWA.js";var u=-3,v=u-1,n;(function(_){_[_.ALL=0]="ALL",_[_.SOME=1]="SOME"})(n||(n={}));var m=class{constructor(e,t,i){this.name=e,this._storage=t,this.id=y+++":",this.size=0,this.maxSize=-1,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),i&&(this._storage.registerRemoveFunc(this.id,i),this._removeFunc=!0)}destroy(){this._storage.clear(this),this._removeFunc&&this._storage.deregisterRemoveFunc(this.id),this._storage.deregister(this),this._storage=null}get hitRate(){return this._hit/(this._hit+this._miss)}get storageSize(){return this._storage.size}getSize(e){return this._storage.getSize(this,e)}resetHitRate(){this._hit=this._miss=0}put(e,t,i,h=0){this._storage.put(this,e,t,i,h)}pop(e){let t=this._storage.pop(this,e);return t===void 0?++this._miss:++this._hit,t}get(e){let t=this._storage.get(this,e);return t===void 0?++this._miss:++this._hit,t}peek(e){return this._storage.peek(this,e)}updateSize(e,t,i){this._storage.updateSize(this,e,t,i)}clear(){this._storage.clear(this)}clearAll(){this._storage.clearAll()}get performanceInfo(){return this._storage.performanceInfo}resetStats(){this._storage.resetStats()}},l=class{get size(){return this._size}constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new c,this._users=new c}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,t){this._removeFuncs.push([e,t])}deregisterRemoveFunc(e){this._removeFuncs.filterInPlace(t=>t[0]!==e)}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,-1),this._checkSize()}getSize(e,t){return this._db.get(e.id+t)?.size??0}put(e,t,i,h,r){t=e.id+t;let s=this._db.get(t);if(s&&(this._size-=s.size,e.size-=s.size,this._db.delete(t),s.entry!==i&&this._notifyRemove(t,s.entry,s.size,n.ALL)),h>this._maxSize)return void this._notifyRemove(t,i,h,n.ALL);if(i===void 0)return void console.warn("Refusing to cache undefined entry ");if(!h||h<0)return console.warn(`Refusing to cache entry with size ${h} for key ${t}`),void this._notifyRemove(t,i,0,n.ALL);let o=1+Math.max(r,v)-u;this._db.set(t,new z(i,h,o)),this._size+=h,e.size+=h,this._checkSize()}updateSize(e,t,i,h){t=e.id+t;let r=this._db.get(t);if(r&&r.entry===i){for(this._size-=r.size,e.size-=r.size;h>this._maxSize;){let s=this._notifyRemove(t,i,h,n.SOME);if(!(s!=null&&s>0))return void this._db.delete(t);h=s}r.size=h,this._size+=h,e.size+=h,this._checkSize()}}pop(e,t){t=e.id+t;let i=this._db.get(t);if(i)return this._size-=i.size,e.size-=i.size,this._db.delete(t),++this._hit,i.entry;++this._miss}get(e,t){t=e.id+t;let i=this._db.get(t);if(i!==void 0)return this._db.delete(t),i.lives=i.lifetime,this._db.set(t,i),++this._hit,i.entry;++this._miss}peek(e,t){let i=this._db.get(e.id+t);return i?++this._hit:++this._miss,i?.entry}get performanceInfo(){let e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},t={},i=new Array;this._db.forEach((s,o)=>{let a=s.lifetime;i[a]=(i[a]||0)+s.size,this._users.forAll(f=>{let{id:g,name:d}=f;if(o.startsWith(g)){let S=t[d]||0;t[d]=S+s.size}})});let h={};this._users.forAll(s=>{let o=s.name;if("hitRate"in s&&typeof s.hitRate=="number"&&!isNaN(s.hitRate)&&s.hitRate>0){let a=t[o]||0;t[o]=a,h[o]=Math.round(100*s.hitRate)+"%"}else h[o]="0%"});let r=Object.keys(t);r.sort((s,o)=>t[o]-t[s]),r.forEach(s=>e[s]=Math.round(t[s]/2**20)+"MB / "+h[s]);for(let s=i.length-1;s>=0;--s){let o=i[s];o&&(e["Priority "+(s+u-1)]=Math.round(o/this._size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll(e=>e.resetHitRate())}clear(e){let t=e.id;this._db.forEach((i,h)=>{h.startsWith(t)&&(this._size-=i.size,this._db.delete(h),this._notifyRemove(h,i.entry,i.size,n.ALL))}),e.size=0}clearAll(){this._db.forEach((e,t)=>this._notifyRemove(t,e.entry,e.size,n.ALL)),this._users.forAll(e=>e.size=0),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(e,t,i,h){let r;return this._removeFuncs.some(s=>{if(e.startsWith(s[0])){let o=s[1](t,h,i);return typeof o=="number"&&(r=o),!0}return!1}),r}_checkSize(){this._users.forAll(e=>this._checkSizeLimits(e)),this._checkSizeLimits()}_checkSizeLimits(e){let t=e??this;if(t.maxSize<0||t.size<=t.maxSize)return;let i=e?.id,h=!0;for(;h;){h=!1;for(let[r,s]of this._db)if(s.lifetime===0&&(!i||r.startsWith(i))){if(this._purgeItem(r,s,e),t.size<=.9*t.maxSize)return;h||=this._db.has(r)}}for(let[r,s]of this._db)if((!i||r.startsWith(i))&&(this._purgeItem(r,s,e),t.size<=.9*t.maxSize))return}_purgeItem(e,t,i=this._users.find(h=>e.startsWith(h.id))){if(this._db.delete(e),t.lives<=1){this._size-=t.size,i&&(i.size-=t.size);let h=this._notifyRemove(e,t.entry,t.size,n.SOME);h!=null&&h>0&&(this._size+=h,i&&(i.size+=h),t.lives=t.lifetime,t.size=h,this._db.set(e,t))}else--t.lives,this._db.set(e,t)}},y=0,z=class{constructor(e,t,i){this.entry=e,this.size=t,this.lifetime=i,this.lives=i}};export{u as a,v as b,n as c,m as d,l as e};
