import{a as dt,d as Xi,e as gt,f as yt,g as Yi}from"./chunk-2AKGSNTH.js";import{a as Ki}from"./chunk-U44ABKI5.js";import{a as Ni,b as Ei,c as Bi,d as Ai,g as Ae,i as Ji,j as zi,k as ft,m as ji,n as pt,o as Vi,p as ht,q as qi,s as Ui,t as $i}from"./chunk-D7XRN25G.js";import{a as Re,b as Li,c as Hi,d as Wi,f as mt,g as ut,h as tt,i as Gi,j as it}from"./chunk-PKOZPBAN.js";import{a as wi,b as Qe,c as Fi,d as Se,e as Mi,f as ki}from"./chunk-MUQSEGYR.js";import{b as Ne,d as Ii,e as lt,f as be,g as Ee,h as Be,i as Ze,j as bi,k as Si,l as Ri,m as ct}from"./chunk-QIHQRWLR.js";import{F as we,G as xi,H as Ie,R as Ci,a as ot,b as De,c as si,d as ni,e as ai,f as oi,g as li,h as ci,i as mi,j as ui,k as fi,l as pi,m as re,n as se}from"./chunk-WJURCFIQ.js";import{A as _i,G as Pi,a as K,q as Ye,r as hi,s as di,t as gi,u as yi,v as Ke,y as vi,z as Ti}from"./chunk-FT46PIGB.js";import"./chunk-YW3L7OMP.js";import"./chunk-OR5TQLC2.js";import"./chunk-REV6BOW7.js";import{b as $t}from"./chunk-X4LAWCTR.js";import{b as ii,d as ri}from"./chunk-YUIUJIOR.js";import{a as Oe}from"./chunk-WDTJILD4.js";import{a as Kt}from"./chunk-FEVELSXH.js";import{a as ei}from"./chunk-NHAXDXHR.js";import"./chunk-MP434LRL.js";import{a as ti}from"./chunk-KXDUJJUF.js";import{a as Qt}from"./chunk-FTVSSLGC.js";import"./chunk-7DPBVZFZ.js";import{a as Zt}from"./chunk-F4H7OIJK.js";import{a as jt}from"./chunk-IM3BGYEV.js";import{a as Gt}from"./chunk-6QEGDZGH.js";import"./chunk-ZNEMFYSX.js";import"./chunk-ZB2MLS4M.js";import{a as Vt}from"./chunk-BF4ZL3U3.js";import{a as Di}from"./chunk-U3EFYVM2.js";import{a as Ht}from"./chunk-NEL2DIHD.js";import{f as et,g as Oi}from"./chunk-6MKTTYAV.js";import{a as Qi}from"./chunk-LCWKR6WR.js";import"./chunk-PPALSVK5.js";import"./chunk-JIFV566L.js";import"./chunk-YBNLKD57.js";import"./chunk-A2WF4NJX.js";import"./chunk-VAIXCJGK.js";import"./chunk-C64FPBS5.js";import"./chunk-STCMK6X3.js";import"./chunk-2XAYS5PW.js";import"./chunk-2O2C5MZC.js";import{a as le}from"./chunk-C4OC7UNL.js";import"./chunk-WBNQAM3K.js";import"./chunk-KH5B55IZ.js";import"./chunk-NPQPIZAK.js";import"./chunk-LOEAA5XF.js";import"./chunk-LX5FIKVZ.js";import{n as Yt}from"./chunk-576BZULE.js";import"./chunk-N7KNO35F.js";import"./chunk-TALIOOAA.js";import"./chunk-6UOVQ25A.js";import"./chunk-BNSYK2BT.js";import"./chunk-DHY7QZ2H.js";import{a as Xt}from"./chunk-MFP2OFDR.js";import"./chunk-TUJ6FPE6.js";import{a as Xe,b as Z}from"./chunk-VWOJQZ7J.js";import"./chunk-V2JYXY4D.js";import"./chunk-B7SBOPIK.js";import"./chunk-PDWLAUMH.js";import"./chunk-65QIQYGA.js";import"./chunk-TLLESPR2.js";import{g as $e}from"./chunk-FI6XC3PH.js";import"./chunk-I3S324BU.js";import{c as pe}from"./chunk-YTC2EJDQ.js";import"./chunk-DCAB3MR3.js";import"./chunk-YC7IXNOA.js";import"./chunk-XDMNA7OV.js";import"./chunk-NKZ7R6T6.js";import"./chunk-VHAPMMA5.js";import"./chunk-DR5D3NPO.js";import"./chunk-ERH7ZNSC.js";import"./chunk-GUOR3BIM.js";import{a as Ut}from"./chunk-WXS2B4FF.js";import"./chunk-XFK3CDZ5.js";import"./chunk-4XBATNKX.js";import"./chunk-3IJY37BG.js";import{a as At}from"./chunk-GNCG2SQP.js";import"./chunk-5JXPUH2D.js";import"./chunk-F4I5LECK.js";import"./chunk-J4PQZSQE.js";import"./chunk-Q3WN5PJ6.js";import"./chunk-UMB6LRQI.js";import"./chunk-AQ74ANSJ.js";import"./chunk-SAOUSUZE.js";import"./chunk-IFPBW5UQ.js";import"./chunk-ZV7ILGPO.js";import"./chunk-RHHHYJSZ.js";import"./chunk-QBQKFGOZ.js";import"./chunk-K5NHJTKR.js";import{a as qt}from"./chunk-XKXYUJUA.js";import{o as Wt}from"./chunk-F7PIPM6E.js";import"./chunk-FR6Q4MSQ.js";import"./chunk-C6JT6KYF.js";import"./chunk-BCREO4Q5.js";import"./chunk-Z5Q76SB7.js";import"./chunk-E5R4OI7X.js";import"./chunk-6FWNINU2.js";import"./chunk-ES7AH7WX.js";import"./chunk-RSDQHAJX.js";import"./chunk-NYONONNN.js";import"./chunk-MZFPLWMN.js";import"./chunk-DS2JVXBM.js";import"./chunk-G3LLBABP.js";import"./chunk-T4B3RN6B.js";import"./chunk-MXADXAOS.js";import"./chunk-RJHITHLB.js";import"./chunk-5TVEQGKJ.js";import"./chunk-U4U366GW.js";import"./chunk-JTJ3UVF7.js";import"./chunk-R4TNLPIN.js";import{a as Bt}from"./chunk-5HLV7XP5.js";import"./chunk-BENVXA3L.js";import{a as Lt,j as H,t as z}from"./chunk-UI76XBLJ.js";import{b as A}from"./chunk-UE2YGKE7.js";import{U as at,o as Jt,s as zt}from"./chunk-BE76S5KT.js";import{b as Et}from"./chunk-3RDV3O6N.js";import"./chunk-D2ITYHSM.js";import"./chunk-FIITBHDP.js";import"./chunk-VSVNPPHQ.js";import{_ as Ue,g as Nt}from"./chunk-CTGIUUCS.js";import{F as S,Q as Dt,b as _t}from"./chunk-VWEBO6QK.js";import{I as Ot,S as G,z as xe}from"./chunk-KAAR5ZJN.js";import{a as I}from"./chunk-W3WDPWBE.js";import{g as Mt,k as kt,m as Ct,r as qe,y as Pt}from"./chunk-WKT5W7KT.js";import{a as Ft}from"./chunk-MLSR6YE6.js";import"./chunk-JPDAKIWT.js";import"./chunk-VU5W7W6Y.js";import{p as ie,r as P}from"./chunk-X3IDZTNG.js";import{a as Tt,p as Pe}from"./chunk-IQJU4QT3.js";import{a as N,b as B,h as T}from"./chunk-EAH6BNBL.js";var Zi=8,fr=256,pr=0,U=class extends Bt(Dt){constructor(){super(...arguments),this._tileFetchQueue=new $t({concurrency:32,process:(e,t)=>this._fetchRawTile(e.pyramidLevel,e.row,e.col,B(N({},e.options),{signal:t}))}),this.datasetName=null,this.datasetFormat=null,this.hasUniqueSourceStorageInfo=!0,this.rasterInfo=null,this.ioConfig={sampling:"closest"}}init(){return T(this,null,function*(){let e=Ne();this.addResolvingPromise(e),yield this.when()})}normalizeCtorArgs(e){return e?.ioConfig&&(e=B(N({},e),{ioConfig:N({resolution:null,bandIds:null,sampling:"closest",tileInfo:Z.create()},e.ioConfig)})),e}get _isGlobalWrappableSource(){let{rasterInfo:e}=this,t=Be(e.spatialReference);return t!=null&&e.extent.width>=t/2}get _hasNoneOrGCSShiftTransform(){let{transform:e}=this.rasterInfo;return e==null||e.type==="gcs-shift"}set rasterJobHandler(e){this._set("rasterJobHandler",e),this.datasetFormat==="Function"&&this.primaryRasters?.rasters?.forEach(t=>t.rasterJobHandler=e)}get rasterId(){return this.url||"rasterId-"+pr++}set url(e){this._set("url",$e(e,ie.getLogger(this)))}open(e){return T(this,null,function*(){throw new P("BaseRaster:open-not-implemented","open() is not implemented")})}fetchTile(s,n,a){return T(this,arguments,function*(e,t,r,i={}){let l=i.tileInfo||this.rasterInfo.storageInfo.tileInfo,o=this.getTileExtentFromTileInfo(e,t,r,l);return i=N({noClip:!0},i),this.fetchPixels(o,l.size[0],l.size[1],i)})}identify(r){return T(this,arguments,function*(e,t={}){e=xe(H,e).clone().normalize();let{multidimensionalDefinition:i,timeExtent:s}=t,{rasterInfo:n}=this,{hasMultidimensionalTranspose:a,multidimensionalInfo:l}=n,{transposedVariableName:o}=t,c=l!=null&&a&&(s!=null||tt(i));c&&!o&&(o=i!=null&&i.length>0?i[0].variableName??void 0:l.variables[0].name,t=B(N({},t),{transposedVariableName:o})),t=this._getRequestOptionsWithSliceId(t);let{spatialReference:u,extent:f}=n,{datumTransformation:p}=t,m=lt(e,u,p);if(!f.intersects(m))return{location:m,value:null};if(n.transform!=null){let C=n.transform.inverseTransform(m);if(!n.nativeExtent.intersects(C))return{location:C,value:null};m=C}let h=0,y=o!=null&&l!=null&&n.hasMultidimensionalTranspose;if(this.datasetFormat==="Function"){let C=this.primaryRasters.rasters[0];if(y)return C.identify(m,t);let{pixelSize:D}=n,E=3,J=D.x*E/2,V=D.y*E/2,W=new z({xmin:m.x-J,xmax:m.x+J,ymin:m.y-V,ymax:m.y+V,spatialReference:u}),L={interpolation:"nearest",multidimensionalDefinition:i,sliceId:t.sliceId},{pixelBlock:q}=yield C.fetchPixels(W,E,E,L),{pixelBlock:Y}=yield this.fetchPixels(W,E,E,L);if(q==null)return{location:m,value:null};let ee=Math.floor(E*E*.5),ue=!q.mask||q.mask[ee]?q.pixels.map(oe=>oe[ee]):null,ae;return Y!=null&&(ae=!Y.mask||Y.mask[ee]?Y.pixels.map(oe=>oe[ee]):void 0),{location:m,value:ue,processedValue:ae,pyramidLevel:0}}if(!y){if(t.srcResolution)h=ct(t.srcResolution,n,this.ioConfig.sampling).pyramidLevel;else if(h=yield this.computeBestPyramidLevelForLocation(e,t),h==null)return{location:m,value:null}}let g=this.identifyPixelLocation(m,h,null,y);if(g===null)return{location:m,value:null};let{row:d,col:w,rowOffset:x,colOffset:b,blockWidth:F}=g,R=o??t.sliceId,v=dt(this.rasterId,R),M=`${h}/${d}/${w}`,O=gt(v,null,M);O==null&&(O=this.fetchRawTile(h,d,w,t),yt(v,null,M,O));let _=yield O;if(!_?.pixels?.length)return{location:m,value:null};let k=x*F+b;return this._processIdentifyResult(_,{srcLocation:m,position:k,pyramidLevel:h,useTransposedTile:!!y,requestSomeSlices:c,identifyOptions:t})})}fetchPixels(s,n,a){return T(this,arguments,function*(e,t,r,i={}){e=Ri(e),i=this._getRequestOptionsWithSliceId(i);let{_hasNoneOrGCSShiftTransform:l}=this;if(i.requestRawData&&l)return this._fetchPixels(e,t,r,i);let o=Be(e.spatialReference),c=Ze(e);if(o==null||c===0||c===1&&this._isGlobalWrappableSource&&l)return this._fetchPixels(e,t,r,i);if(c>=3)return{extent:e,pixelBlock:null};let u=[],{xmin:f,xmax:p}=e,m=Math.round(o/(p-f)*t),h=m-Math.round((o/2-f)/(p-f)*t),y=0,g=[];for(let b=0;b<=c;b++){let F=new z({xmin:b===0?f:-o/2,xmax:b===c?p-o*b:o/2,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference}),R=b===0?m-h:b===c?t-y:m;y+=R,g.push(R);let v=i.disableWrapAround&&b>0?null:this._fetchPixels(F,R,r,i);u.push(v)}let d=(yield Promise.all(u)).map(b=>b?.pixelBlock),w=null,x={width:t,height:r};return this.rasterJobHandler?w=(yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:d,srcMosaicSize:x,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:g},i)).pixelBlock:w=Ye(d,x,{blockWidths:g}),{extent:e,srcExtent:be(e,this.rasterInfo.spatialReference,i.datumTransformation),pixelBlock:w}})}fetchRawPixels(s,n,a){return T(this,arguments,function*(e,t,r,i={}){t={x:Math.floor(t.x),y:Math.floor(t.y)};let l=yield this._fetchRawTiles(e,t,r,i),{nativeExtent:o,nativePixelSize:c,storageInfo:u}=this.rasterInfo,f=2**e,p=c.x*f,m=c.y*f,h=new z({xmin:o.xmin+p*t.x,xmax:o.xmin+p*(t.x+r.width-1),ymin:o.ymax-m*(t.y+r.height-1),ymax:o.ymax-m*t.y,spatialReference:o.spatialReference});if(!l)return{extent:h,srcExtent:h,pixelBlock:null};let{pixelBlocks:y,mosaicSize:g}=l;if(y.length===1&&y[0]!=null&&y[0].width===r.width&&y[0].height===r.height)return{extent:h,srcExtent:h,pixelBlock:l.pixelBlocks[0]};let d=e>0?u.pyramidBlockWidth:u.blockWidth,w=e>0?u.pyramidBlockHeight:u.blockHeight,x={x:t.x%d,y:t.y%w},b;return this.rasterJobHandler?b=(yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:y,srcMosaicSize:g,destDimension:r,clipOffset:x,clipSize:r,coefs:null,sampleSpacing:null,interpolation:i.interpolation,alignmentInfo:null,blockWidths:null},i)).pixelBlock:b=Ye(y,g,{clipOffset:x,clipSize:r}),{extent:h,srcExtent:h,pixelBlock:b}})}fetchRawTile(e,t,r,i){throw new P("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}computeExtent(e){return be(this.rasterInfo.extent,e)}decodePixelBlock(e,t){return!this.rasterJobHandler||t.useCanvas?pi(e,t):this.rasterJobHandler.decode({data:e,options:t})}request(e,t,r=0){return T(this,null,function*(){let{customFetchParameters:i}=this.ioConfig,{range:s,query:n,headers:a}=t;r=r??t.retryCount??this.ioConfig.retryCount;let l=s?{Range:`bytes=${s.from}-${s.to}`}:null;try{return yield Ue(e,B(N({},t),{query:N(N({},n),i),headers:N(N({},a),l)}))}catch(o){if(r>0)return r--,this.request(e,t,r);throw o}})}getSliceIndex(e){let{multidimensionalInfo:t}=this.rasterInfo;return t==null||e==null||e.length===0?null:it(e,t)}getTileExtentFromTileInfo(e,t,r,i){let s=i.lodAt(e);return this.getTileExtent({x:s.resolution,y:s.resolution},t,r,i.origin,i.spatialReference,i.size)}updateTileInfo(){let{storageInfo:e,spatialReference:t,extent:r,pixelSize:i}=this.rasterInfo;if(!e.tileInfo){let s=[],n=e.maximumPyramidLevel||0,a=Math.max(i.x,i.y),l=1/.0254*96*a;for(let c=0;c<=n;c++)s.unshift(new Xe({level:n-c,resolution:a,scale:l})),a*=2,l*=2;let o=new H({x:r.xmin,y:r.ymax,spatialReference:t});e.tileInfo=new Z({origin:o,size:[e.blockWidth,e.blockHeight],spatialReference:t,lods:s}),e.isVirtualTileInfo=!0}}createRemoteDatasetStorageInfo(e,t=512,r=512,i){let{width:s,height:n,nativeExtent:a,pixelSize:l,spatialReference:o}=e,c=new H({x:a.xmin,y:a.ymax,spatialReference:o});i==null&&(i=Math.max(0,Math.round(Math.log(Math.max(s,n))/Math.LN2-8)));let u=this.computeBlockBoundary(a,512,512,{x:a.xmin,y:a.ymax},[l],i);e.storageInfo=new re({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:c,firstPyramidLevel:1,maximumPyramidLevel:i,blockBoundary:u})}computeBestPyramidLevelForLocation(r){return T(this,arguments,function*(e,t={}){return 0})}computeBlockBoundary(e,t,r,i,s,n=0,a=2){if(s.length===1&&n>0){s=[...s];let{x:u,y:f}=s[0];for(let p=0;p<n;p++)u*=a,f*=a,s.push({x:u,y:f})}let l=[],{x:o,y:c}=i;for(let u=0;u<s.length;u++){let{x:f,y:p}=s[u];l.push({minCol:Math.floor((e.xmin-o+.1*f)/t/f),maxCol:Math.floor((e.xmax-o-.1*f)/t/f),minRow:Math.floor((c-e.ymax+.1*p)/r/p),maxRow:Math.floor((c-e.ymin-.1*p)/r/p)})}return l}getPyramidPixelSize(e){let{nativePixelSize:t}=this.rasterInfo,{pyramidResolutions:r,pyramidScalingFactor:i}=this.rasterInfo.storageInfo;if(e===0)return t;if(r!=null&&r.length)return r[e-1];let s=i**e;return{x:t.x*s,y:t.y*s}}identifyPixelLocation(e,t,r,i){let{spatialReference:s,nativeExtent:n,storageInfo:a}=this.rasterInfo,{maximumPyramidLevel:l,origin:o,transposeInfo:c}=a,u=i&&c!=null?c.tileSize[0]:a.blockWidth,f=i&&c!=null?c.tileSize[1]:a.blockHeight,p=lt(e,s,r);if(!n.intersects(p)||t<0||t>l)return null;let m=this.getPyramidPixelSize(t),{x:h,y}=m,g=(o.y-p.y)/y/f,d=(p.x-o.x)/h/u,w=Math.min(f-1,Math.floor((g-Math.floor(g))*f)),x=Math.min(u-1,Math.floor((d-Math.floor(d))*u));return{pyramidLevel:t,row:Math.floor(g),col:Math.floor(d),rowOffset:w,colOffset:x,blockWidth:u,srcLocation:p}}getTileExtent(e,t,r,i,s,n){let[a,l]=n,o=i.x+r*a*e.x,c=o+a*e.x,u=i.y-t*l*e.y,f=u-l*e.y;return new z({xmin:o,xmax:c,ymin:f,ymax:u,spatialReference:s})}getBlockWidthHeight(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}isBlockOutside(e,t,r){let i=this.rasterInfo.storageInfo.blockBoundary[e];return!i||i.maxRow<t||i.maxCol<r||i.minRow>t||i.minCol>r}updateImageSpaceRasterInfo(e){let{extent:t,pixelSize:r}=e;if(t.xmin===-.5&&t.ymax===.5&&r.x===1&&r.y===1&&e.transform==null)return;let{width:i,height:s}=e,n=A.WebMercator;e.spatialReference=n,e.extent=e.nativeExtent=new z({xmin:-.5,ymax:.5,xmax:i-.5,ymin:.5-s,spatialReference:n}),e.isPseudoSpatialReference=!0,e.transform=null,e.pixelSize=new H({x:1,y:1,spatialReference:n});let{extent:a,storageInfo:l}=e;if(l){l.origin=new H({x:a.xmin,y:a.ymax,spatialReference:n});let{tileInfo:o}=l;if(o){o.origin=l.origin;let c=(e.nativePixelSize.x+e.nativePixelSize.y)/2;o.lods.forEach((u,f)=>{u.resolution=c*2**f,u.scale=96*u.resolution/.0254})}}}_fetchPixels(s,n,a){return T(this,arguments,function*(e,t,r,i={}){let l=Ze(e);if(l>=2)return{extent:e,pixelBlock:null};let o=this._getSourceDataInfo(e,t,r,i),{pyramidLevel:c,srcResolution:u,srcExtent:f,srcWidth:p,srcHeight:m,ul:h}=o;if(p===0||m===0)return{extent:e,srcExtent:f,pixelBlock:null};let{rasterInfo:y}=this,g=y.transform,d=g?.type==="gcs-shift",w=Be(e.spatialReference)!=null;!d&&w||(l=Ze(o.srcExtent,d));let x=yield this._fetchRawTiles(c,h,{width:p,height:m,wrapCount:l},i);if(!x)return{extent:e,srcExtent:f,pixelBlock:null};let b=y.storageInfo,F=c>0?b.pyramidBlockWidth:b.blockWidth,R=c>0?b.pyramidBlockHeight:b.blockHeight,{x:v,y:M}=y.pixelSize;if(c>0){let{pyramidResolutions:fe,pyramidScalingFactor:ur}=b;if(fe!=null&&fe[c-1])({x:v,y:M}=fe[c-1]);else{let vt=ur**c;v*=vt,M*=vt}}let O=y.spatialReference,_=new H({x:v,y:M,spatialReference:O}),k=F===p&&R===m&&h.x%F==0&&h.y%R==0,C=new H({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/r,spatialReference:e.spatialReference}),D=!e.spatialReference.equals(O),E=O.isGeographic?1e-9:1e-4,{datumTransformation:J}=i;if(!D&&k&&x.pixelBlocks.length===1&&F===t&&R===r&&this._isSameResolution(u,C,E))return{extent:e,srcExtent:f,srcTilePixelSize:_,pixelBlock:x.pixelBlocks[0]};let V=w&&Be(f.spatialReference)!=null&&this._hasNoneOrGCSShiftTransform,W=i.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector");W&&!this.rasterJobHandler&&(yield Ne());let L=this.rasterJobHandler?yield this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:e,srcBufferExtent:x.extent,pixelSize:C.toJSON(),datumTransformation:J,rasterTransform:g,hasWrapAround:l>0||V,isAdaptive:this.ioConfig.optimizeProjectionAccuracy!==!1,includeGCSGrid:W},i):Si({projectedExtent:e,srcBufferExtent:x.extent,pixelSize:C,datumTransformation:J,rasterTransform:g,hasWrapAround:l>0||V,isAdaptive:!1,includeGCSGrid:W}),q,Y=!i.requestRawData,ee={rows:L.spacing[0],cols:L.spacing[1]},ue=this._hasNoneOrGCSShiftTransform?this._getRasterTileAlignmentInfo(c,x.extent.xmin):void 0,{pixelBlocks:ae,mosaicSize:oe,isPartiallyFilled:mr}=x,Ve=null;if(this.rasterJobHandler)({pixelBlock:q,localNorthDirections:Ve}=yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:ae,srcMosaicSize:oe,destDimension:Y?{width:t,height:r}:null,coefs:Y?L.coefficients:null,sampleSpacing:Y?ee:null,projectDirections:W,gcsGrid:W?L.gcsGrid:null,isUV:this.rasterInfo.dataType==="vector-uv",interpolation:i.interpolation,alignmentInfo:ue,blockWidths:null},i));else{let fe=Ye(ae,oe,{alignmentInfo:ue});q=Y?Ke(fe,{width:t,height:r},L.coefficients,ee,i.interpolation):fe,W&&L.gcsGrid&&(Ve=yi({width:t,height:r},L.gcsGrid),q=Ti(q,this.rasterInfo.dataType,Ve))}return i.requestRawData||W?{extent:e,srcExtent:f,srcTilePixelSize:_,pixelBlock:q,transformGrid:L,localNorthDirections:Ve,isPartiallyFilled:mr}:{extent:e,srcExtent:f,srcTilePixelSize:_,pixelBlock:q}})}_fetchRawTiles(e,t,r,i){return T(this,null,function*(){let{origin:s,blockBoundary:n}=this.rasterInfo.storageInfo,{blockWidth:a,blockHeight:l}=this.getBlockWidthHeight(e),{x:o,y:c}=t,{width:u,height:f,wrapCount:p}=r,m=this._getRasterTileAlignmentInfo(e,0);i.buffer&&(o-=i.buffer.cols,c-=i.buffer.rows,u+=2*i.buffer.cols,f+=2*i.buffer.rows);let h=0,y=0,g=0;p&&m!=null&&({worldColumnCountFromOrigin:y,originColumnOffset:g,rightPadding:h}=m,y*m.blockWidth-h>=o+u&&(h=0));let d=Math.floor(o/a),w=Math.floor(c/l),x=Math.floor((o+u+h-1)/a),b=Math.floor((c+f+h-1)/l),F=n[e];if(!F)return null;let{minRow:R,minCol:v,maxCol:M,maxRow:O}=F;if(p===0&&(b<R||x<v||w>O||d>M))return null;let _=new Array,k=!1,C=this.ioConfig.allowPartialFill==null?i.allowPartialFill:this.ioConfig.allowPartialFill;for(let q=w;q<=b;q++)for(let Y=d;Y<=x;Y++){let ee=Y;if(!i.disableWrapAround&&p&&m!=null&&y<=Y&&(ee=Y-y-g),q>=R&&ee>=v&&O>=q&&M>=ee){let ue=this._tileFetchQueue.push({pyramidLevel:e,row:q,col:ee,options:i},{signal:i.signal});C?_.push(new Promise(ae=>{ue.then(oe=>ae(oe)).catch(()=>{k=!0,ae(null)})})):_.push(ue)}else _.push(Promise.resolve(null))}if(_.length===0)return null;let D=yield Promise.all(_),E={height:(b-w+1)*l,width:(x-d+1)*a},{spatialReference:J}=this.rasterInfo,V=this.getPyramidPixelSize(e),{x:W,y:L}=V;return{extent:new z({xmin:s.x+d*a*W,xmax:s.x+(x+1)*a*W,ymin:s.y-(b+1)*l*L,ymax:s.y-w*l*L,spatialReference:J}),pixelBlocks:D,mosaicSize:E,isPartiallyFilled:k}})}_isSameResolution(e,t,r){return Math.abs(e.x-t.x)<r&&Math.abs(e.y-t.y)<r}_fetchRawTile(e,t,r,i){let s=this.rasterInfo.storageInfo.blockBoundary[e];if(!s)return Promise.resolve(null);let{minRow:n,minCol:a,maxCol:l,maxRow:o}=s;if(t<n||r<a||t>o||r>l)return Promise.resolve(null);let c=dt(this.rasterId,i.sliceId),u=`${e}/${t}/${r}`,f=gt(c,i.registryId,u);if(f==null){let p=new AbortController;f=this.fetchRawTile(e,t,r,B(N({},i),{signal:p.signal})),yt(c,i.registryId,u,f,p),f.catch(()=>Yi(c,i.registryId,u))}return i.signal&&Ct(i,()=>{Xi(c,i.registryId,u)}),f}_computeMagDirValues(e){let{bandCount:t,dataType:r}=this.rasterInfo;if(!(t===2&&r==="vector-magdir"||r==="vector-uv")||e?.length!==2||!e[0]?.length)return null;let i=e[0].length;if(r==="vector-magdir"){let o=e[1].map(c=>(c+360)%360);return[e[0],o]}let[s,n]=e,a=[],l=[];for(let o=0;o<i;o++){let[c,u]=vi([s[o],n[o]]);a.push(c),l.push(u)}return[a,l]}_getRasterTileAlignmentInfo(e,t){return this._rasterTileAlignmentInfo==null&&(this._rasterTileAlignmentInfo=bi(this.rasterInfo)),this._rasterTileAlignmentInfo.pyramidsInfo==null?null:N({startX:t,halfWorldWidth:this._rasterTileAlignmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlignmentInfo.hasGCSSShiftTransform},this._rasterTileAlignmentInfo.pyramidsInfo[e])}_getSourceDataInfo(e,t,r,i={}){let s={datumTransformation:i.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0,ul:{x:0,y:0}};i.srcResolution&&(s.srcResolution=i.srcResolution,this._updateSourceDataInfo(e,s));let n=this.rasterInfo.storageInfo.maximumPyramidLevel||0,{srcWidth:a,srcHeight:l,pyramidLevel:o}=s,c=a/t,u=l/r,f=o<n&&c*u>=16,p=o===n&&this._requireTooManySrcTiles(a,l,t,r);if(f||p||a===0||l===0){let m=new H({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/r,spatialReference:e.spatialReference}),h=Ii(m,this.rasterInfo.spatialReference,e,s.datumTransformation),y=!h||i.srcResolution&&h.x+h.y<i.srcResolution.x+i.srcResolution.y;if(f&&i.srcResolution&&y){let g=Math.round(Math.log(Math.max(c,u))/Math.LN2)-1;if(n-o+3>=g){let d=2**g;h={x:i.srcResolution.x*d,y:i.srcResolution.y*d}}}h&&(s.srcResolution=h,this._updateSourceDataInfo(e,s))}return this._requireTooManySrcTiles(s.srcWidth,s.srcHeight,t,r)&&(s.srcWidth=0,s.srcHeight=0),s}_requireTooManySrcTiles(e,t,r,i){let{tileInfo:s}=this.rasterInfo.storageInfo,n=Math.ceil(e/s.size[0])*Math.ceil(t/s.size[1]),a=e/r,l=t/i,o=Math.max(1,(r+i)/1024);return n>=fr*o||a>Zi||l>Zi}_updateSourceDataInfo(e,t){t.srcWidth=0,t.srcHeight=0;let{rasterInfo:r}=this,i=r.spatialReference,{srcResolution:s,datumTransformation:n}=t,{pyramidLevel:a,pyramidResolution:l,excessiveReading:o}=ct(s,r,this.ioConfig.sampling);if(o)return;let c=t.srcExtent||be(e,i,n);if(c==null)return;let u=r.transform;u&&(c=u.inverseTransform(c)),t.srcExtent=c;let{x:f,y:p}=r.storageInfo.origin,m=Math.floor((c.xmin-f)/l.x+.1),h=Math.floor((p-c.ymax)/l.y+.1),y=Math.floor((c.xmax-f)/l.x-.1),g=Math.floor((p-c.ymin)/l.y-.1),d=c.width<.1*l.x?0:y-m+1,w=c.height<.1*l.y?0:g-h+1;t.pyramidLevel=a,t.pyramidResolution=l,t.srcWidth=d,t.srcHeight=w,t.ul={x:m,y:h}}_getRequestOptionsWithSliceId(e){return this.rasterInfo.multidimensionalInfo!=null&&e.sliceId==null&&(e=B(N({},e),{sliceId:this.getSliceIndex(e.multidimensionalDefinition)})),e}_processIdentifyResult(e,t){let{srcLocation:r,position:i,pyramidLevel:s,useTransposedTile:n}=t,a=e.pixels[0].length/e.width/e.height;if(!(!e.mask||e.mask[i]))return{location:r,value:null};let{multidimensionalInfo:l}=this.rasterInfo;if(l==null||!n){let g=e.pixels.map(x=>x[i]),d={location:r,value:g,pyramidLevel:s},w=this._computeMagDirValues(g.map(x=>[x]));return w?.length&&(d.magdirValue=w.map(x=>x[0])),d}let o=e.pixels.map(g=>g.slice(i*a,i*a+a)),c=this._computeMagDirValues(o),{requestSomeSlices:u,identifyOptions:f}=t,p=Li(l,f.transposedVariableName);if(u){let g=Hi(p,f.multidimensionalDefinition,f.timeExtent);o=o.map(d=>g.map(w=>d[w])),c=c?.map(d=>g.map(w=>d[w])),p=g.map(d=>p[d])}let m=e.noDataValues||this.rasterInfo.noDataValue,h={pixels:o,pixelType:e.pixelType},y;return m!=null&&(ri(h,m),y=h.mask),{location:r,value:null,dataSeries:p.map((g,d)=>{let w={value:y?.[d]===0?null:o.map(x=>x[d]),multidimensionalDefinition:g.multidimensionalDefinition.map(x=>new Re(B(N({},x),{isSlice:!0})))};return c?.length&&(w.magdirValue=[c[0][d],c[1][d]]),w}),pyramidLevel:s}}};I([S()],U.prototype,"_rasterTileAlignmentInfo",void 0),I([S()],U.prototype,"_tileFetchQueue",void 0),I([S({readOnly:!0})],U.prototype,"_isGlobalWrappableSource",null),I([S({readOnly:!0})],U.prototype,"_hasNoneOrGCSShiftTransform",null),I([S()],U.prototype,"rasterJobHandler",null),I([S({readOnly:!0})],U.prototype,"rasterId",null),I([S(et)],U.prototype,"url",null),I([S({type:String,json:{write:!0}})],U.prototype,"datasetName",void 0),I([S({type:String,json:{write:!0}})],U.prototype,"datasetFormat",void 0),I([S()],U.prototype,"hasUniqueSourceStorageInfo",void 0),I([S()],U.prototype,"rasterInfo",void 0),I([S()],U.prototype,"ioConfig",void 0),I([S()],U.prototype,"sourceJSON",void 0),U=I([G("esri.layers.support.rasterDatasets.BaseRaster")],U);var $=U;function hr(e,t){if(e.spatialReference.equals(t))return e;let r=at(e.spatialReference),i=at(t);if(r===i)return e;let s=r/i;return{x:e.x*s,y:e.y*s}}function Je(e,t,r){return T(this,null,function*(){if(r.type==="extent")return gr(e,t,r);let{width:i,height:s}=e,n=new Uint8Array(i*s),{contains:a,intersects:l}=yield import("./chunk-D2DF7QWS.js");return l(t,r)?r.type==="polyline"?yr(e,t,r):a(r,t)?e:dr(e,t,r):new K({pixelType:e.pixelType,width:i,height:s,mask:n,maskIsAlpha:!1,pixels:[...e.pixels]})})}function dr(e,t,r){if(!e)return e;let{width:i,height:s}=e,n=t.width/i,a=t.height/s,{xmin:l,ymax:o}=t,c;if(r.type==="extent"){let g=(r.xmin-l)/n,d=(r.xmax-l)/n,w=(o-r.ymax)/a,x=(o-r.ymin)/a;c=[[[g,w],[g,x],[d,x],[d,w],[g,w]]]}else c=r.rings.map(g=>g.map(([d,w])=>[(d-l)/n,(o-w)/a]));let u=document.createElement("canvas");u.width=i,u.height=s;let f=u.getContext("2d");f.fillStyle="#f00",f.beginPath(),c.forEach(g=>{f.moveTo(g[0][0],g[0][1]);for(let d=0;d<g.length;d++)f.lineTo(g[d][0],g[d][1]);f.closePath()}),f.fill();let p=f.getImageData(0,0,i,s).data,m=e.mask,h=i*s,y=new Uint8Array(h);for(let g=0;g<h;g++)m&&!m[g]||(y[g]=p[4*g+3]>127?255:0);return new K({pixelType:e.pixelType,width:i,height:s,mask:y,maskIsAlpha:!1,pixels:[...e.pixels]})}function gr(e,t,r){let{width:i,height:s}=e,n=new Uint8Array(i*s),a=t.width/i,l=t.height/s;if(r.width/a<.5||r.height/l<.5)return new K({pixelType:e.pixelType,width:i,height:s,mask:n,pixels:[...e.pixels]});let{xmin:o,xmax:c,ymin:u,ymax:f}=t,{xmin:p,xmax:m,ymin:h,ymax:y}=r,g=Math.max(o,p),d=Math.min(c,m),w=Math.max(u,h),x=Math.min(f,y),b=.5*a,F=.5*l;if(d-g<b||x-w<F||d<o+b||g>c-b||w>f-F||x<u+F)return new K({pixelType:e.pixelType,width:i,height:s,mask:n,pixels:[...e.pixels]});let R=Math.max(0,(g-o)/a),v=Math.min(i,Math.max(0,(d-o)/a)),M=Math.max(0,(f-x)/l),O=Math.min(s,Math.max(0,(f-w)/l)),_=Math.round(R),k=Math.round(v)-1,C=Math.round(M),D=Math.round(O)-1;if(_===k&&R%1>.5&&v%1<.5||C===D&&M%1>.5&&O%1<.5)return new K({pixelType:e.pixelType,width:i,height:s,mask:n,pixels:[...e.pixels]});if(_===0&&C===0&&k===i&&D===s)return e;let E=e.mask;for(let J=C;J<=D;J++)for(let V=_;V<=k;V++){let W=J*i+V;n[W]=E?E[W]:255}return new K({pixelType:e.pixelType,width:i,height:s,mask:n,pixels:[...e.pixels]})}function yr(e,t,r){let{width:i,height:s}=e,n=new Uint8Array(i*s),a=t.width/i,l=t.height/s,{xmin:o,ymax:c}=t,{paths:u}=r,f=e.mask;for(let p=0;p<u.length;p++){let m=u[p];for(let h=0;h<m.length-1;h++){let[y,g]=m[h],[d,w]=m[h+1],x=Math.floor((c-g)/l),b=Math.floor((c-w)/l);if(b<x){let R=x;x=b,b=R}x=Math.max(0,x),b=Math.min(s-1,b);let F=(d-y)/(w-g);for(let R=x;R<=b;R++){let v=R===x?Math.max(g,w):(s+1-R)*l,M=R===b?Math.min(g,w):v-l,O=Math.floor(w===g?(y-o)/a:(F*(v-g)+y-o)/a),_=Math.floor(w===g?(d-o)/a:(F*(M-g)+y-o)/a);if(_<O){let C=O;O=_,_=C}let k=R*i;O=Math.max(0,O),_=Math.min(i-1,_);for(let C=k+O;C<=k+_;C++)n[C]=f?f[C]:255}}}return new K({pixelType:e.pixelType,width:i,height:s,mask:n,pixels:[...e.pixels]})}function er(e,t,r,i=!0){let{spatialReference:s}=e,{x:n,y:a}=hr(r,s),l,o,c,u=t.type==="extent"?t:t.extent,{xmin:f,xmax:p,ymax:m,ymin:h}=u,{xmin:y,ymax:g}=e.extent;return i?(f=y+(f>y?n*Math.round((f-y)/n):0),m=g-(m<g?a*Math.round((g-m)/a):0),p=y+(p>y?n*Math.round((p-y)/n):0),h=g-(h<g?a*Math.round((g-h)/a):0),l=new z({xmin:f,ymax:m,xmax:p,ymin:h,spatialReference:s}),o=Math.round(l.width/n),c=Math.round(l.height/a)):(o=Math.floor((p-f)/n+.8),c=Math.floor((m-h)/a+.8),f=y+(f>y?n*Math.floor((f-y)/n+.1):0),m=g-(m<g?a*Math.floor((g-m)/a+.1):0),p=f+o*n,h=m-c*a,l=new z({xmin:f,ymax:m,xmax:p,ymin:h,spatialReference:s})),{extent:l,width:o,height:c}}var xr=40,he=class extends ${constructor(){super(...arguments),this.datasetFormat="Function",this.tileType="Raster",this.rasterFunction=null,this._clippingGeometry=new Map}open(e){return T(this,null,function*(){yield this.init();let{rasterFunction:t}=this;this.primaryRasters?.rasters?.length?t.sourceRasters=this.primaryRasters.rasters:(this.primaryRasters=t.getPrimaryRasters(),this.rasterJobHandler&&this.primaryRasters.rasters?.forEach(c=>c.rasterJobHandler=this.rasterJobHandler));let{rasters:r,rasterIds:i}=this.primaryRasters,s=r.map(c=>c.rasterInfo?void 0:c.open(e));yield Promise.all(s);let n=r.map(({rasterInfo:c})=>c),a=t.bind({rasterInfos:n,rasterIds:i});if(t.rawSourceRasterInfos=n,!a.success||n.length===0)throw new P("raster-function:open",`cannot bind the function: ${a.error??""}`);let l=t.functionName==="Table"?t:t.functionArguments?.raster;l?.functionName==="Table"&&(t.rasterInfo.attributeTable=le.fromJSON(l.functionArguments.attributeTableAsRecordSet)),yield this.syncJobHandler();let o=n[0];this.hasUniqueSourceStorageInfo=n.length===1||n.slice(1).every(c=>this._hasSameStorageInfo(c,o)),this.set("sourceJSON",r[0].sourceJSON),this.set("rasterInfo",t.rasterInfo),yield this._updateClipGeometry()})}syncJobHandler(){return T(this,null,function*(){return this.rasterJobHandler?.updateRasterFunction(this.rasterFunction)})}fetchPixels(s,n,a){return T(this,arguments,function*(e,t,r,i={}){let{rasters:l,rasterIds:o}=this.primaryRasters,c=!1,{interpolation:u}=i,f=this.rasterFunction.flatWebGLFunctionChain?.hasFocalFunction;!i.requestRawData&&f&&(c=l.length===1&&!i.skipRasterFunction,i=B(N({},i),{interpolation:"bilinear",requestRawData:c}));let p=l.map(R=>R.fetchPixels(e,t,r,i)),m=yield Promise.all(p),h=m.map(R=>R.pixelBlock),y=c||i.requestRawData?m.map(R=>R.srcTilePixelSize):null;if(i.skipRasterFunction||h.every(R=>R==null))return m[0];let g=m.find(R=>R.pixelBlock!=null)?.extent??e,d=this.rasterJobHandler?yield this.rasterJobHandler.process({extent:g,primaryPixelBlocks:h,primaryPixelSizes:y,primaryRasterIds:o}):this.rasterFunction.process({extent:g,primaryPixelBlocks:h,primaryPixelSizes:y,primaryRasterIds:o}),{transformGrid:w}=m[0];if(!c||d==null||w==null){let R=i.noClip?null:this.getClippingGeometry(g.spatialReference);return i.noClip||i.requestRawData||d==null||!R||(d=yield Je(d,g,R)),B(N({},m[0]),{pixelBlock:d})}let x={rows:w.spacing[0],cols:w.spacing[1]},b;this.rasterJobHandler?b=(yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:[d],srcMosaicSize:{width:d.width,height:d.height},destDimension:{width:t,height:r},coefs:w.coefficients,sampleSpacing:x,projectDirections:!1,gcsGrid:null,isUV:!1,interpolation:u,alignmentInfo:void 0,blockWidths:null},i)).pixelBlock:b=Ke(d,{width:t,height:r},w.coefficients,x,u);let F=i.noClip?null:this.getClippingGeometry(e.spatialReference);return i.noClip||i.requestRawData||b==null||F==null||(b=yield Je(b,e,F)),{extent:e,srcExtent:m[0].srcExtent,pixelBlock:b}})}getClippingGeometry(e){let t=this._clippingGeometry.get("0");if(!e||!t)return t;let r=this._getSRKey(e),i=this._clippingGeometry.get(r);return i!=null||(i=e.equals(t.spatialReference)?t:Ee(t,e),this._clippingGeometry.set(r,i)),i}_hasSameStorageInfo(e,t){let{storageInfo:r,pixelSize:i,spatialReference:s,extent:n}=e,{storageInfo:a,pixelSize:l,spatialReference:o,extent:c}=t;return i.x===l.x&&i.y===l.y&&s.equals(o)&&n.equals(c)&&r.blockHeight===a.blockHeight&&r.blockWidth===a.blockWidth&&r.maximumPyramidLevel===a.maximumPyramidLevel}_updateClipGeometry(){return T(this,null,function*(){let e=this.rasterFunction.getClippingGeometries()[0],t=e?.clippingGeometry;if(t&&e.clippingType==="inside"){let{extent:r}=this.rasterInfo,{difference:i,densify:s}=yield import("./chunk-D2DF7QWS.js"),n=s(Wt.fromExtent(r),2*(r.width+r.height)/xr);n=Ee(n,t.spatialReference),t=i(n,t)}this._clippingGeometry.clear(),t&&this._clippingGeometry.set("0",t)})}_getSRKey(e){return String(e.wkid??e.wkt??e.wkt2)}};I([S({type:String,json:{write:!0}})],he.prototype,"datasetFormat",void 0),I([S()],he.prototype,"tileType",void 0),I([S()],he.prototype,"rasterFunction",void 0),I([S()],he.prototype,"primaryRasters",void 0),he=I([G("esri.layers.support.rasterDatasets.FunctionRaster")],he);var rt=he;var tr=e=>{let t=class extends e{constructor(...i){super(...i),this._isConstructedFromFunctionRaster=!1,this._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},this.bandIds=null,this.copyright=null,this.interpolation="nearest",this.multidimensionalSubset=null,this.raster=null,this.serviceRasterInfo=null,this.sourceJSON=null,this.spatialReference=null,this.symbolizer=null,this._isConstructedFromFunctionRaster=i[0]?.raster?.datasetFormat==="Function"}get fullExtent(){return this.serviceRasterInfo?.extent}set multidimensionalDefinition(i){this._set("multidimensionalDefinition",i),this.updateRenderer()}set rasterFunction(i){i?.functionName?.toLowerCase()==="none"&&(i=void 0),this._set("rasterFunction",i),this.updateRasterFunction()}get rasterInfo(){return _t(ie.getLogger(this),"rasterInfo",{replacement:"serviceRasterInfo",version:"4.29",warnOnce:!0}),this._get("serviceRasterInfo")}set url(i){this._set("url",$e(i,ie.getLogger(this)))}set renderer(i){i==null&&this.rasterFunction==null?this._configDefaultRenderer("override"):(this._set("renderer",i),this.updateRenderer())}readRenderer(i,s,n){let a=s?.layerDefinition?.drawingInfo?.renderer;return Bi(a,n)||void 0}convertVectorFieldData(i,s){return T(this,null,function*(){let{serviceRasterInfo:n}=this;if(i==null||!n)return null;let a=this._rasterJobHandler.instance,l=n.dataType;return a?a.convertVectorFieldData({pixelBlock:i,dataType:l},s):_i(i,l)})}computeStatisticsHistograms(i,s){return T(this,null,function*(){i=xe($i,i).clone();let{serviceRasterInfo:n}=this,{geometry:a}=i;if(a==null)throw new P("imagery-tile-mixin:compute-statistics-histograms","geometry must be specified");let l=a,{spatialReference:o}=n;a.spatialReference.equals(o)||(yield Ne(),l=a.type==="extent"?be(a,o):Ee(a,o));let c=i.pixelSize??new H({x:n.pixelSize.x,y:n.pixelSize.y,spatialReference:o}),{extent:u,width:f,height:p}=er(n,l,c),m=yield this.fetchPixels(u,f,p,B(N({},s),{interpolation:"nearest"}));if(m.pixelBlock==null)throw new P("imagery-tile-mixin:compute-statistics-histograms","failed to fetch pixels");let h=yield Je(m.pixelBlock,u,l),y=this._rasterJobHandler.instance;return y?y.computeStatisticsHistograms({pixelBlock:h},s):we(h)})}createFlowMesh(i,s){return T(this,null,function*(){let n=this._rasterJobHandler.instance;return n?n.createFlowMesh(i,s):Pi(i.meshType,i.simulationSettings,i.flowData,s.signal!=null?s.signal:new AbortController().signal)})}normalizeRasterFetchOptions(i){let{multidimensionalInfo:s}=this.serviceRasterInfo??{};if(s==null)return i;let n=i.multidimensionalDefinition||this.multidimensionalDefinition;n?.length||(n=ut(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset}));let a=i.timeExtent||this.timeExtent;if(n!=null&&a!=null&&(a.start!=null||a.end!=null)){n=n.map(y=>y.clone());let l=s.variables.find(({name:y})=>y===n[0].variableName)?.dimensions?.find(({name:y})=>y==="StdTime"),o=n.find(({dimensionName:y})=>y==="StdTime");if(!l||!o)return B(N({},i),{multidimensionalDefinition:null});let{start:c,end:u}=a,f=c==null?null:c.getTime(),p=u==null?null:u.getTime(),m=f??p,h=p??f;if(l.values!=null){let y=l.values.filter(g=>{if(Array.isArray(g)){if(m===h)return g[0]<=m&&g[1]>=m;let d=g[0]<=m&&g[1]>m||g[0]<h&&g[1]>=h,w=g[0]>=m&&g[1]<=h||g[0]<m&&g[1]>h;return d||w}return m===h?g===m:g>=m&&g<=h});if(y.length){let g=y.sort((d,w)=>{let x=Array.isArray(d)?d[0]:d,b=Array.isArray(d)?d[1]:d,F=Array.isArray(w)?w[0]:w,R=Array.isArray(w)?w[1]:w;return m===h?x-F:Math.abs(b-h)-Math.abs(R-h)})[0];o.values=[g]}else n=null}else if(l.hasRegularIntervals&&l.extent){let[y,g]=l.extent;m>g||h<y?n=null:o.values=m===h?[m]:[Math.max(y,m),Math.min(g,h)]}}return n!=null&&Wi(n,this.multidimensionalSubset)?B(N({},i),{multidimensionalDefinition:null}):B(N({},i),{multidimensionalDefinition:n})}updateRasterFunction(){return T(this,null,function*(){if(!this.loaded||this.type!=="imagery-tile"||!this.rasterFunction&&!this._cachedRasterFunctionJson||JSON.stringify(this.rasterFunction)===JSON.stringify(this._cachedRasterFunctionJson))return;if(this._isConstructedFromFunctionRaster&&this.raster.datasetFormat==="Function"){let u=this.raster.rasterFunction.toJSON();return!this.rasterFunction&&u&&this._set("rasterFunction",Ae.fromJSON(u)),void(this._cachedRasterFunctionJson=this.rasterFunction?.toJSON())}let i,s=this.raster,n=!1;s.datasetFormat==="Function"?(i=s.primaryRasters.rasters,s=i[0],n=!0):i=[s];let{rasterFunction:a}=this;if(a){let u={raster:s};i.length>1&&i.forEach(m=>u[m.url]=m);let f=Qe(a.functionDefinition?.toJSON()??a.toJSON(),u),p=new rt({rasterFunction:f});p.rasterJobHandler=this._rasterJobHandler.instance,yield p.open(),this._cachedRasterFunctionJson=this.rasterFunction?.toJSON(),this.raster=p}else this.raster=s,this._cachedRasterFunctionJson=null,yield s.when();if(this._cachedRendererJson=null,!n&&!a)return;let{bandIds:l}=this,{bandCount:o}=this.raster.rasterInfo,c=l?.length?l.some(u=>u>=o):o>=3;l&&(c||this.renderer&&this.renderer.type!=="raster-stretch")&&this._set("bandIds",null),this._configDefaultRenderer("auto")})}updateRenderer(){return T(this,null,function*(){let{loaded:i,symbolizer:s}=this;if(!i||!s||!this.renderer)return;let{rasterInfo:n}=this.raster,a=mt(n,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),l=a?.name,o=ht(B(N({},this.renderer.toJSON()),{variableName:l}));if(JSON.stringify(this._cachedRendererJson)===JSON.stringify(o))return;let c=this._rasterJobHandler.instance;c&&(s.rasterInfo=pt(n,l),s.rendererJSON=o,s.bind(),yield c.updateSymbolizer(s),this._cachedRendererJson=o)})}applyRenderer(i,s){return T(this,null,function*(){let n=i?.pixelBlock;if(!(n!=null&&n.pixels&&n.pixels.length>0))return null;let a;yield this.updateRenderer();let l=this._rasterJobHandler.instance,o=this.bandIds??[];return a=l?yield l.symbolize(B(N({},i),{simpleStretchParams:s,bandIds:o})):this.symbolizer.symbolize(B(N({},i),{simpleStretchParams:s,bandIds:o})),a})}getTileUrl(i,s,n){return this.raster.datasetFormat==="RasterTileServer"?`${this.url}/tile/${i}/${s}/${n}`:""}getCompatibleTileInfo(i,s,n=!1){if(!this.loaded||s==null)return null;if(n&&i.equals(this.spatialReference))return this.tileInfo;let a=Jt(i);return Z.create({size:256,spatialReference:i,origin:a?{x:a.origin[0],y:a.origin[1]}:{x:s.xmin,y:s.ymax}})}getCompatibleFullExtent(i){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(i)||(this._compatibleFullExtent=this.raster.computeExtent(i)),this._compatibleFullExtent):null}fetchTile(l,o,c){return T(this,arguments,function*(i,s,n,a={}){if(r(this),a.requestAsImageElement){let f=this.getTileUrl(i,s,n);return Ue(f,{responseType:"image",query:N(N({},this.refreshParameters),this.raster.ioConfig.customFetchParameters),signal:a.signal}).then(p=>p.data)}let{serviceRasterInfo:u}=this;if(u.multidimensionalInfo!=null&&(a=this.normalizeRasterFetchOptions(a)).multidimensionalDefinition==null){let f=a.tileInfo||u.storageInfo.tileInfo;return{extent:this.raster.getTileExtentFromTileInfo(i,s,n,f),pixelBlock:null}}return yield this._initJobHandler(),yield this.updateRasterFunction(),this.renderer?.type==="raster-shaded-relief"&&(a=B(N({},a),{buffer:{cols:1,rows:1}})),this.raster.fetchTile(i,s,n,a)})}fetchPixels(l,o,c){return T(this,arguments,function*(i,s,n,a={}){return this.serviceRasterInfo.multidimensionalInfo!=null&&(a=this.normalizeRasterFetchOptions(a)).multidimensionalDefinition==null?{extent:i,pixelBlock:null}:(yield this._initJobHandler(),yield this.updateRasterFunction(),s=Math.round(s),n=Math.round(n),this.raster.fetchPixels(i,s,n,a))})}identify(n){return T(this,arguments,function*(i,s={}){let{raster:a,serviceRasterInfo:l}=this;if(l.multidimensionalInfo!=null&&!(l.hasMultidimensionalTranspose&&(tt(s.multidimensionalDefinition)||s.transposedVariableName||s.timeExtent))&&(s=this.normalizeRasterFetchOptions(s)).multidimensionalDefinition==null)return{location:i,value:null};let o=this.multidimensionalSubset?.areaOfInterest;if(o&&!o.contains(i))throw new P("imagery-tile-mixin:identify","the request cannot be fulfilled when falling outside of the multidimensional subset");return a.identify(i,s)})}increaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount++}decreaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}hasStandardTime(){let i=this.serviceRasterInfo?.multidimensionalInfo;if(i==null||this.serviceRasterInfo?.dataType!=="standard-time")return!1;let s=this.multidimensionalDefinition,n=s?.[0]?.variableName;return i.variables.some(a=>a.name===n&&(!s?.[0].dimensionName||a.dimensions.some(l=>l.name==="StdTime")))}getStandardTimeValue(i){return new Date(24*(i-25569)*3600*1e3).toString()}getMultidimensionalSubsetVariables(i){let s=i??this.serviceRasterInfo?.multidimensionalInfo;return Gi(this.multidimensionalSubset,s)}_configDefaultSettings(){this._configDefaultInterpolation(),this.multidimensionalDefinition||(this.multidimensionalDefinition=ut(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset})),this.rasterFunction&&this.raster.datasetFormat==="Function"&&(this._cachedRasterFunctionJson=this.rasterFunction.toJSON()),this._configDefaultRenderer()}_initJobHandler(){if(this._rasterJobHandler.connectionPromise!=null)return this._rasterJobHandler.connectionPromise;let i=new zi;return this._rasterJobHandler.connectionPromise=i.initialize().then(()=>T(this,null,function*(){r(this),this._rasterJobHandler.instance=i,this.raster.rasterJobHandler=i,this.raster.datasetFormat==="Function"&&this.raster.syncJobHandler(),this.rasterFunction&&(yield this.updateRasterFunction().catch(()=>{})),this.renderer&&this.updateRenderer()})).catch(()=>{}),this._rasterJobHandler.connectionPromise}_shutdownJobHandler(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this._cachedRendererJson=null,this.raster&&(this.raster.rasterJobHandler=null)}_configDefaultInterpolation(){if(this.interpolation==null){r(this);let{raster:i}=this,s=ji(i.rasterInfo,i.tileType,this.sourceJSON?.defaultResamplingMethod);this._set("interpolation",s)}}_configDefaultRenderer(i="no"){r(this);let{rasterInfo:s}=this.raster;!this.bandIds&&s.bandCount>1&&(this.bandIds=Vi(s));let n=mt(s,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),a=n?.name;if(!this.renderer||i==="override"){let u=ft(s,{bandIds:this.bandIds,variableName:a}),f=s.statistics,p=f&&f.length>0?f[0]:null,m=p?.max??0,h=p?.min??0;this.raster.datasetFormat==="WCSServer"&&u.type==="raster-stretch"&&(m>1e24||h<-1e24)&&(u.dynamicRangeAdjustment=!0,u.statistics=null,u.stretchType==="none"&&(u.stretchType="min-max")),this.renderer=u}let l=ht(B(N({},this.renderer.toJSON()),{variableName:a})),o=pt(s,a);this.symbolizer?(this.symbolizer.rendererJSON=l,this.symbolizer.rasterInfo=o):this.symbolizer=new Ci({rendererJSON:l,rasterInfo:o});let c=this.symbolizer.bind();if(c.success){if(i==="auto"){let{colormap:u}=this.raster.rasterInfo,f=this.renderer;if(u!=null&&f.type==="raster-colormap"){let p=ft(this.raster.rasterInfo);JSON.stringify(p)!==JSON.stringify(f)&&this._configDefaultRenderer("override")}else if(f.type==="raster-stretch"){let p=this.bandIds?.length,m=f.statistics?.length;!f.dynamicRangeAdjustment&&m&&p&&m!==p&&this._configDefaultRenderer("override")}}}else ie.getLogger(this).warn("imagery-tile-mixin",c.error||"The given renderer is not supported by the layer."),i==="auto"&&this._configDefaultRenderer("override")}};function r(i){if(!i.raster||!i.serviceRasterInfo)throw new P("imagery-tile","no raster")}return I([S({clonable:!1})],t.prototype,"_cachedRendererJson",void 0),I([S({clonable:!1})],t.prototype,"_cachedRasterFunctionJson",void 0),I([S({clonable:!1})],t.prototype,"_compatibleFullExtent",void 0),I([S({clonable:!1})],t.prototype,"_isConstructedFromFunctionRaster",void 0),I([S({clonable:!1})],t.prototype,"_rasterJobHandler",void 0),I([S()],t.prototype,"bandIds",void 0),I([S({json:{origins:{service:{read:{source:"copyrightText"}}}}})],t.prototype,"copyright",void 0),I([S({json:{read:!1}})],t.prototype,"fullExtent",null),I([S()],t.prototype,"interpolation",void 0),I([S()],t.prototype,"ioConfig",void 0),I([S({type:[Re],json:{write:!0}})],t.prototype,"multidimensionalDefinition",null),I([S({type:Ji,json:{write:!0}})],t.prototype,"multidimensionalSubset",void 0),I([S()],t.prototype,"raster",void 0),I([S({type:Ae,json:{name:"renderingRule",write:!0}})],t.prototype,"rasterFunction",null),I([S({readOnly:!0})],t.prototype,"rasterInfo",null),I([S()],t.prototype,"serviceRasterInfo",void 0),I([S()],t.prototype,"sourceJSON",void 0),I([S({readOnly:!0,type:A,json:{read:!1}})],t.prototype,"spatialReference",void 0),I([S({type:Z})],t.prototype,"tileInfo",void 0),I([S(et)],t.prototype,"url",null),I([S({types:Ni,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy(){let i=this.renderer?.type==="raster-stretch"&&this.renderer.stretchType==="none"&&!this.renderer.useGamma;return{enabled:!this.loaded||this.raster.tileType==="Raster"||!i}}},origins:{"web-scene":{types:Ei,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:i=>({enabled:i&&i.type!=="vector-field"&&i.type!=="flow"})}}}}})],t.prototype,"renderer",null),I([Lt("renderer")],t.prototype,"readRenderer",null),I([S({clonable:!1})],t.prototype,"symbolizer",void 0),t=I([G("esri.layers.ImageryTileMixin")],t),t};function wr(e){let t=e.fields,r=e.records,i=t.some(c=>c.name.toLowerCase()==="oid")?"OBJECTID":"OID",s=[{name:i,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map(c=>({name:c.name,type:"esriFieldType"+c.typeName,alias:c.name}))),n=s.map(c=>c.name),a=[],l=0,o=0;return r.forEach(c=>{let u={};for(u[i]=l++,o=1;o<n.length;o++)u[n[o]]=c[o-1];a.push({attributes:u})}),{displayFieldName:"",fields:s,features:a}}var ve=class{static get supportedVersions(){return[5]}static parse(t){let r=new DataView(t),i=3&r.getUint8(0);if(i!==3)return{header:{version:i},recordSet:null};let s=r.getUint32(4,!0),n=r.getUint16(8,!0),a=r.getUint16(10,!0),l={version:i,recordCount:s,headerByteCount:n,recordByteCount:a},o=32,c=[],u=[],f;if(i===3){for(;r.getUint8(o)!==13;)f=String.fromCharCode(r.getUint8(o+11)).trim(),c.push({name:ot(new Uint8Array(t,o,11)),type:f,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(f)],length:r.getUint8(o+16)}),o+=32;if(o+=1,c.length>0)for(;u.length<s&&t.byteLength-o>a;){let p=[];r.getUint8(o)===32?(o+=1,c.forEach(m=>{if(m.type==="C")p.push(ot(new Uint8Array(t,o,m.length)).trim());else if(m.type==="N")p.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(t,o,m.length)).trim(),10));else if(m.type==="F")p.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(t,o,m.length)).trim()));else if(m.type==="D"){let h=String.fromCharCode.apply(null,new Uint8Array(t,o,m.length)).trim();p.push(new Date(parseInt(h.substring(0,4),10),parseInt(h.substring(4,6),10)-1,parseInt(h.substring(6,8),10)))}o+=m.length}),u.push(p)):o+=a}}return{header:l,fields:c,records:u,recordSet:wr({fields:c,records:u})}}};var de=new Map;de.set("int16","esriFieldTypeSmallInteger"),de.set("int32","esriFieldTypeInteger"),de.set("int64","esriFieldTypeInteger"),de.set("float32","esriFieldTypeSingle"),de.set("float64","esriFieldTypeDouble"),de.set("text","esriFieldTypeString");var ir=8,ze=class extends ${constructor(){super(...arguments),this.storageInfo=null,this.datasetFormat="CRF"}open(e){return T(this,null,function*(){yield this.init();let{data:t}=yield this.request(this.url+"/conf.json",{signal:e?.signal});if(!this._validateHeader(t))throw new P("cloudraster:open","Invalid or unsupported conf.json.");this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);let{storageInfo:r,rasterInfo:i}=this._parseHeader(t);if(i.dataType==="thematic"){let s=yield this._fetchAuxiliaryInformation();i.attributeTable=s}this._set("storageInfo",r),this._set("rasterInfo",i),this.ioConfig.retryCount=this.ioConfig.retryCount||0})}fetchRawTile(s,n,a){return T(this,arguments,function*(e,t,r,i={}){let{transposeInfo:l}=this.rasterInfo.storageInfo,{transposedVariableName:o}=i,c=!(!l||!o),u=c?0:this.rasterInfo.storageInfo.maximumPyramidLevel-e;if(u<0)return null;let f=this._buildCacheFilePath(u,t,r,i.multidimensionalDefinition,o),p=this._getIndexRecordFromBundle(t,r,c),m=yield this.request(f,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:i.signal});if(!m)return null;let h=new Uint8Array(m.data),y=this._getTileEndAndContentType(h,p);if(y.recordSize===0)return null;let g=yield this.request(f,{range:{from:y.position,to:y.position+y.recordSize},responseType:"array-buffer",signal:i.signal});if(!g)return null;let[d,w]=this._getTileSize(c);return this.decodePixelBlock(g.data,{width:d,height:w,planes:null,pixelType:null,returnInterleaved:c})})}_validateHeader(e){let t=["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"];return e&&e.type==="RasterInfo"&&!t.some(r=>!e[r])}_parseHeader(e){let t=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],{bandCount:r,colormap:i,blockWidth:s,blockHeight:n,firstPyramidLevel:a,maximumPyramidLevel:l}=e,o=e.statistics?.map(L=>({min:L.min,max:L.max,avg:L.mean,stddev:L.standardDeviation,median:L.median,mode:L.mode})),c=e.histograms?.[0]?.counts?.length?e.histograms:null,u=e.extent.spatialReference,f=e.geodataXform?.spatialReference,p=new A(u?.wkid||u?.wkt||u?.wkt2?u:f),m=new z({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:p}),h=new H({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:p}),y=Math.round((m.xmax-m.xmin)/h.x),g=Math.round((m.ymax-m.ymin)/h.y),d=this._parseTransform(e.geodataXform),w=d?m:null;d&&(m=d.forwardTransform(m),h.x=(m.xmax-m.xmin)/y,h.y=(m.ymax-m.ymin)/g);let x=e.properties??{},b=e.format.toLowerCase().replace("cache/",""),F=new H(e.origin.x,e.origin.y,p),R,v,M,O;if(i?.colors)for(R=[],v=0;v<i.colors.length;v++)M=i.colors[v],O=i.values?i.values[v]:v,R.push([O,255&M,M<<16>>>24,M<<8>>>24,M>>>24]);let _=e.LODInfos,k=[];for(v=0;v<_.levels.length;v++)k.push(new Xe({level:_.levels[v],resolution:_.resolutions[v],scale:96/.0254*_.resolutions[v]}));let C=new Z({dpi:96,lods:k,format:b,origin:F,size:[s,n],spatialReference:p}),D={recordSize:ir,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*ir+64},E=[{maxCol:Math.ceil(y/s)-1,maxRow:Math.ceil(g/n)-1,minCol:0,minRow:0}],J=2;if(l>0)for(v=0;v<l;v++)E.push({maxCol:Math.ceil(y/J/s)-1,maxRow:Math.ceil(g/J/n)-1,minCol:0,minRow:0}),J*=2;let V=e.mdInfo,W=null;if(V&&x._yxs){let L=x._yxs;W={packetSize:L.PacketSize,tileSize:[L.TileXSize,L.TileYSize]}}return{storageInfo:D,rasterInfo:new se({width:y,height:g,pixelType:t,bandCount:r,extent:m,nativeExtent:w,transform:d,spatialReference:p,pixelSize:h,keyProperties:x,statistics:o,histograms:c,multidimensionalInfo:V,colormap:R,storageInfo:new re({blockWidth:s,blockHeight:n,pyramidBlockWidth:s,pyramidBlockHeight:n,origin:F,tileInfo:C,transposeInfo:W,firstPyramidLevel:a,maximumPyramidLevel:l,blockBoundary:E})})}}_parseTransform(e){if(!Mi(e))throw new P("cloudraster:open","the data contains unsupported geodata transform types");let t=ki(e);if(t.type==="identity")return null;if(t.type!=="polynomial"||!t.forwardCoefficients?.length||!t.inverseCoefficients?.length)throw new P("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return t}_fetchAuxiliaryInformation(e){return T(this,null,function*(){let t=this.request(this.url+"/conf.vat.json",{signal:e}).then(n=>n.data).catch(()=>null),r=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:e}).then(n=>n.data).catch(()=>null),i=yield Promise.all([t,r]),s;if(i[0]){let n=i[0].fields,a=i[0].values;if(n&&a){n=n.map(o=>({type:o.name==="OID"?"esriFieldTypeOID":de.get(o.type),name:o.name,alias:o.alias||o.name}));let l=a.map(o=>({attributes:o}));n&&a&&(s={fields:n,features:l})}}return!s&&i[1]&&(s=ve.parse(i[1]).recordSet),le.fromJSON(s)})}_buildCacheFilePath(e,t,r,i,s){let n=this._getPackageSize(!!s),a=Math.floor(t/n)*n,l=Math.floor(r/n)*n,o="R"+this._toHexString4(a)+"C"+this._toHexString4(l),c="L";c+=e>=10?e.toString():"0"+e.toString();let{multidimensionalInfo:u}=this.rasterInfo,f=i?.[0];if(u==null||!f)return`${this.url}/_alllayers/${c}/${o}.bundle`;let p="_yxs";if(!s){p=u.variables.find(y=>y.name===f.variableName).dimensions[0].values.indexOf(f.values[0]).toString(16);let h=4-p.length;for(let y=0;y<h;y++)p="0"+p;p="S"+p}let m=this._getVariableFolderName(s||f.variableName);return`${this.url}/_alllayers/${m}/${p}/${c}/${o}.bundle`}_getPackageSize(e=!1){let{transposeInfo:t}=this.rasterInfo.storageInfo;return e&&t!=null?t.packetSize??0:this.storageInfo.packetSize}_getTileSize(e=!1){let{storageInfo:t}=this.rasterInfo,{transposeInfo:r}=t;return e&&r!=null?r.tileSize:t.tileInfo.size}_getVariableFolderName(e){return(e=e.trim())===""?"_v":e.replaceAll(/[\{|\}\-]/g,"_").replace("\\*","_v")}_getIndexRecordFromBundle(e,t,r=!1){let i=this._getPackageSize(r),s=i*(e%i)+t%i;if(s<0)throw new Error("Invalid level / row / col");return 20+s*this.storageInfo.recordSize+44}_getTileEndAndContentType(e,t){let r=e.subarray(t,t+8),i,s=0;for(i=0;i<5;i++)s|=(255&r[i])<<8*i;let n=0xffffffffff&s;for(s=0,i=5;i<8;i++)s|=(255&r[i])<<8*(i-5);return{position:n,recordSize:0xffffffffff&s}}_toHexString4(e){let t=e.toString(16);if(t.length!==4){let r=4-t.length;for(;r-- >0;)t="0"+t}return t}};I([S({readOnly:!0})],ze.prototype,"storageInfo",void 0),I([S({type:String,json:{write:!0}})],ze.prototype,"datasetFormat",void 0),ze=I([G("esri.layers.support.rasterDatasets.CloudRaster")],ze);var rr=ze;function It(e){return["x","e","east","long","longitude"].includes(e.toLowerCase())}function bt(e){return["y","n","west","lat","latitude"].includes(e.toLowerCase())}function Ir(e){let{axes:t}=e.domain,r=Object.keys(t),i=[],s=[],n=-1,a=-1,l=[];for(let w=0;w<r.length;w++){let x=r[w];It(x)?n=w:bt(x)&&(a=w);let b=t[x],F=[];if("values"in b){b.values.forEach(v=>F.push(typeof v=="string"?new Date(v).getTime():v));let R=F[1]-F[0];i.push([F[0]-.5*R,F[F.length-1]+.5*R]),s.push(R)}else{let{start:R,stop:v,num:M}=b,O=(v-R)/(M-1);i.push([R-.5*O,v+.5*O]),s.push(O);for(let _=0;_<M;_++)F.push(R+O*_)}l.push({name:x,values:F,extent:[F[0],F[F.length-1]]})}n>-1&&a===-1?a=n===0?1:0:a>-1&&n===-1?n=a===0?1:0:a===-1&&n===-1&&(n=0,a=1),l=l.filter((w,x)=>!(x===n||x===a));let{referencing:o}=e.domain,c=o.find(w=>w.coordinates.includes(r[n])).system.id,u=c?.slice(c.lastIndexOf("/")+1),f=u==null||u==="CRS84"?4326:Number(u),p=new A({wkid:f}),[m,h]=i[n],[y,g]=i[a],d=new z({xmin:m,xmax:h,ymin:y,ymax:g,spatialReference:p});return{width:Math.round(d.width/s[n]),height:Math.round(d.height/s[a]),extent:d,dimensions:l}}function xt(e){let t=Et();return t?e[t]??Object.values(e)[0]:Object.values(e)[0]}function wt(){return Math.round(255*Math.random())}function br(e){let t={},{parameters:r}=e;if(!r)return t;for(let[i,s]of Object.entries(r)){let{type:n,description:a,unit:l,categoryEncoding:o,observedProperty:c}=s;if(n==="Parameter"&&(t[i]={},a&&(t[i].description=xt(a)),l&&(t[i].unit=l.label?xt(l.label):null,t[i].symbol=l.symbol?.value),o)){let u=Object.entries(o).map((m,h)=>({OID:h,Value:Number(m[1]),ClassName:m[0].slice(m[0].lastIndexOf("/")+1),Count:1})),f=!1;c?.categories?.length&&(c.categories.forEach(m=>{if(!m.id)return;let h=m.id.slice(m.id.lastIndexOf("/")+1),y=u.find(d=>d.ClassName===h);if(!y)return;let g=m.label?xt(m.label):null;if(y.Label=g,m.preferredColor){let d=Xt.fromHex(m.preferredColor);d&&(f=!0,y.Red=d.r,y.Green=d.g,y.Blue=d.b)}}),f&&u.forEach(m=>{m.Red==null&&(m.Red=wt(),m.Green=wt(),m.Blue=wt())}));let p={objectIdFieldName:"",fields:[{name:"OID",type:"esriFieldTypeOID",alias:"OID",domain:null},{name:"Value",type:"esriFieldTypeInteger",alias:"Value",domain:null},{name:"Count",type:"esriFieldTypeDouble",alias:"Count",domain:null},{name:"ClassName",type:"esriFieldTypeString",alias:"ClassName",domain:null,length:50},{name:"Label",type:"esriFieldTypeString",alias:"Label",domain:null,length:50}],features:u.map(m=>({attributes:m}))};f&&p.fields.push({name:"Red",type:"esriFieldTypeInteger",alias:"Red",domain:null},{name:"Green",type:"esriFieldTypeInteger",alias:"Green",domain:null},{name:"Blue",type:"esriFieldTypeInteger",alias:"Blue",domain:null}),t[i].attributeTable=p}}return t}function Sr(e){let t=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let i=0;i<e.length;i++){let s=e[i];s!=null&&(s<t&&(t=s),s>r&&(r=s))}return ii(t,r)}function Rr(e,t,r){let i=e.map((o,c)=>({name:o,count:t[c]})).sort((o,c)=>o.name>c.name?-1:1),s=(n=1,o=>n*=o.count);var n;let a=[...i.slice(1),{name:"",count:1}].reverse().map(s).reverse(),l=0;for(let o=e.length-1;o>=0;o--)l+=a[i.findIndex(({name:c})=>c===e[o])]*(r%t[o]),r=Math.floor(r/t[o]);return l}function sr(e){let{width:t,height:r,extent:i,dimensions:s}=Ir(e),{ranges:n}=e,a=Object.keys(n).sort((p,m)=>p<m?-1:1),l=[];for(let p=0;p<a.length;p++){let m=a[p];s?.length&&l.push({name:m,dimensions:s})}let o=br(e);l.forEach(p=>o[p.name]&&Object.assign(p,o[p.name]));let c=l.length?{variables:l}:void 0,u=[];for(let p=0;p<a.length;p++){let m=a[p],{values:h,dataType:y,axisNames:g,shape:d}=n[m],w=d.length>2?p*d.slice(0,-2).reduce((M,O)=>M*O):0,x=g.slice(0,-2),b=d.slice(0,-2),F=y==="float"?"f32":Sr(h),R=t*r,v=h.length/R;for(let M=0;M<v;M++){let O=K.createEmptyBand(F,R),_=new Uint8Array(R).fill(255),k=!1,C=M*R;for(let D=0;D<R;D++){let E=h[C+D];E==null?(_[D]=0,k=!0):O[D]=E}if(p===0||s?.length){let D=new K({width:t,height:r,mask:k?_:null,pixels:[O],pixelType:F});D.updateStatistics(),s?.length?u[Rr(x,b,M)+w]=D:u.push(D)}else{let D=u[M];D.pixels.push(O),k?D.mask&&(D.mask=K.combineBandMasks([D.mask,_])):D.mask=k?_:null}}}let f=Object.values(o).find(p=>p.attributeTable)?.attributeTable;return{extent:i,pixelBlocks:u,multidimensionalInfo:c,attributeTable:f,bandNames:c?void 0:a}}var Te=class extends ${constructor(){super(...arguments),this.datasetFormat="MEMORY",this.source=null}get url(){return""}open(e){return T(this,null,function*(){yield this.init();let t=this.source,{pixelBlocks:r,attributeTable:i,statistics:s,histograms:n,name:a,nativeExtent:l,transform:o}=t,c=r[0],{width:u,height:f,pixelType:p}=c,m=t.extent??new z({xmin:-.5,ymin:.5,xmax:u-.5,ymax:f-.5,spatialReference:new A({wkid:3857})}),h=t.isPseudoSpatialReference??!t.extent,y={x:m.width/u,y:m.height/f},g=N({},t.keyProperties);i&&(g.DataType="Thematic");let d=new se({width:u,height:f,pixelType:p,extent:m,nativeExtent:l,attributeTable:i,transform:o,pixelSize:y,spatialReference:m.spatialReference,bandCount:c.pixels.length,keyProperties:g,multidimensionalInfo:t.multidimensionalInfo,statistics:s,isPseudoSpatialReference:h,histograms:n});this.ioConfig.skipMapInfo&&this.updateImageSpaceRasterInfo(d),this.createRemoteDatasetStorageInfo(d,512,512),this._set("rasterInfo",d),this.updateTileInfo(),d.multidimensionalInfo?yield this._buildMDimStats(t.pixelBlocks,d.multidimensionalInfo):yield this._buildInMemoryRaster(c,{width:512,height:512},e),d.multidimensionalInfo||(this.source=null),this.datasetName=a})}fetchRawTile(e,t,r,i={}){if(!this._pixelBlockTiles){let{rasterInfo:n}=this,[a,l]=n.storageInfo.tileInfo.size,{sliceId:o}=i,{pixelBlocks:c}=this.source,u={pixelBlock:o==null?c[0]:c[o],useBilinear:n.dataType!=="thematic",tileSize:{width:a,height:l},level:e,row:t,col:r},f=this.rasterJobHandler?this.rasterJobHandler.clipTile(u,i):gi(u);return Promise.resolve(f)}let s=this._pixelBlockTiles.get(`${e}/${t}/${r}`);return Promise.resolve(s)}_buildInMemoryRaster(e,t,r){return T(this,null,function*(){let{rasterInfo:i}=this,s=i.storageInfo.maximumPyramidLevel??0,n=i.dataType!=="thematic",a=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:e,tileSize:t,maximumPyramidLevel:s,useBilinear:n},r):Promise.resolve(di(e,t,s,n)),l=i.statistics!=null,o=i.histograms!=null,c=this.ioConfig.skipStatistics||l?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:e},r):Promise.resolve(xi(e)),u=yield qe([a,c]);if(!u[0].value&&u[1].value)throw new P("inmemory-raster:open","failed to build in memory raster");this._pixelBlockTiles=u[0].value,l||(i.statistics=u[1].value?.statistics),o||(i.histograms=u[1].value?.histograms)})}_buildMDimStats(e,t,r){return T(this,null,function*(){for(let i=0;i<t.variables.length;i++){let s=t.variables[i];if(s.statistics)continue;let n=s.dimensions.map(c=>new Re({variableName:s.name,dimensionName:c.name,values:[c.values?.[0]??c.extent?.[0]],isSlice:!0})),a=it(n,t),l=a==null?null:e[a];if(l==null)continue;let o=this.rasterJobHandler?yield this.rasterJobHandler.computeStatisticsHistograms({pixelBlock:l},r):we(l);s.statistics=o.statistics,s.histograms||(s.histograms=o.histograms)}})}};I([S({type:String,json:{write:!0}})],Te.prototype,"datasetFormat",void 0),I([S()],Te.prototype,"source",void 0),I([S()],Te.prototype,"url",null),Te=I([G("esri.layers.support.rasterDatasets.InMemoryRaster")],Te);var _e=Te;var Le=class extends ${constructor(){super(...arguments),this.datasetFormat="CovJSON"}open(e){return T(this,null,function*(){yield this.init();let{extent:t,pixelBlocks:r,multidimensionalInfo:i,attributeTable:s,bandNames:n}=yield this._fetchData(e),{statistics:a,histograms:l}=we(r[0]),o=n?.map(p=>({BandName:p})),c={DataType:s?"Thematic":i?"Scientific":"Generic",BandProperties:o},u=new _e({source:{extent:t,pixelBlocks:r,attributeTable:s?le.fromJSON(s):null,multidimensionalInfo:i,statistics:a,histograms:l,keyProperties:c,isPseudoSpatialReference:!1}});yield u.open(),this._inMemoryRaster=u;let f=this.source?"":this.url.slice(this.url.lastIndexOf("/")+1);this._set("datasetName",f.slice(0,f.indexOf("."))),this._set("rasterInfo",u.rasterInfo)})}fetchRawTile(e,t,r,i={}){return this._inMemoryRaster.fetchRawTile(e,t,r,i)}_fetchData(e){return T(this,null,function*(){let t=this.source??(yield this.request(this.url,{signal:e?.signal})).data,r="imagery-tile-layer:open-coverage-json";if(t.type?.toLowerCase()!=="coverage"||t.domain?.domainType?.toLowerCase()!=="grid")throw new P(r,"Only coverage with Grid domain type is supported");if(!t.ranges)throw new P(r,"Missing ranges in the grid coverage data");if(!t.domain.referencing?.length)throw new P(r,"Missing domain referencing in the grid coverage data");let i=Object.values(t.ranges);for(let s=0;s<i.length;s++){let{axisNames:n,shape:a,type:l,values:o}=i[s];if(!(l.toLowerCase()==="ndarray"&&o?.length&&n?.length&&a?.length))throw new P(r,"Only ranges with valid NdArray, axisNames, shape, and inline values are supported");if(!(It(n[n.length-1])&&bt(n[n.length-2])))throw new P(r,"Only row-major ordered pixel values are supported. X axis must be the last axis.")}return sr(t)})}};I([S({type:String,json:{write:!0}})],Le.prototype,"datasetFormat",void 0),I([S({constructOnly:!0})],Le.prototype,"source",void 0),Le=I([G("esri.layers.support.rasterDatasets.CovJSONRaster")],Le);var nr=Le;function ge(e,t){if(!e||!t)return[];let r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";let i=[];if(t){let n=ge(e,r);for(let a=0;a<n.length;a++)ge(n[a],t).forEach(l=>i.push(l));return i}let s=e.getElementsByTagNameNS("*",r);if(!s||s.length===0)return[];for(let n=0;n<s.length;n++)i.push(s[n]||s.item(n));return i}function Q(e,t){if(!e||!t)return null;let r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";let i=ge(e,r);return i.length>0?t?Q(i[0],t):i[0]:null}function te(e,t=null){let r=t?Q(e,t):e,i;return r?(i=r.textContent||r.nodeValue,i?i.trim():null):null}function vr(e,t){let r=ge(e,t),i=[],s;for(let n=0;n<r.length;n++)s=r[n].textContent||r[n].nodeValue,s&&(s=s.trim(),s!==""&&i.push(s));return i}function He(e,t){return vr(e,t).map(r=>Number(r))}function ce(e,t){let r=te(e,t);return Number(r)}function st(e,t){let r=e?.nodeName?.toLowerCase(),i=t.toLowerCase();return r.slice(r.lastIndexOf(":")+1)===i}function ar(e,t){if(!e||!t)return null;let r=[];for(let i=0;i<e.length;i++)r.push(e[i]),r.push(t[i]);return r}function Tr(e){let t=Q(e,"GeodataXform"),r=Fe(ce(t,"SpatialReference/WKID")||te(t,"SpatialReference/WKT"));if(t.getAttribute("xsi:type")!=="typens:PolynomialXform")return{spatialReference:r,transform:null};let i=ce(t,"PolynomialOrder")??1,s=He(t,"CoeffX/Double"),n=He(t,"CoeffY/Double"),a=He(t,"InverseCoeffX/Double"),l=He(t,"InverseCoeffY/Double"),o=ar(s,n),c=ar(a,l);return{spatialReference:r,transform:o&&c&&o.length&&c.length?new Se({spatialReference:r,polynomialOrder:i,forwardCoefficients:o,inverseCoefficients:c}):null}}function _r(e){let t=ce(e,"NoDataValue"),r=Q(e,"Histograms/HistItem"),i=ce(r,"HistMin"),s=ce(r,"HistMax"),n=ce(r,"BucketCount"),a=te(r,"HistCounts")?.split("|").map(p=>Number(p)),l,o,c,u;ge(e,"Metadata/MDI").forEach(p=>{let m=Number(p.textContent??p.nodeValue);switch(p.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":l=m;break;case"STATISTICS_MAXIMUM":o=m;break;case"STATISTICS_MEAN":c=m;break;case"STATISTICS_STDDEV":u=m}});let f=ce(e,"Metadata/SourceBandIndex");return{noDataValue:t,histogram:a?.length&&i!=null&&s!=null?{min:i,max:s,size:n||a.length,counts:a}:null,sourceBandIndex:f,statistics:l!=null&&o!=null?{min:l,max:o,avg:c,stddev:u}:null}}function Fe(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&t!==0)return new A({wkid:t});if(e=String(e).trim(),zt(e))return new A({wkt2:e});let r=e.toUpperCase();if(r.startsWith("COMPD_CS")){if(!r.includes("VERTCS")||!r.includes("GEOGCS")&&!r.startsWith("PROJCS"))return null;let i=r.indexOf("VERTCS"),s=r.indexOf("PROJCS"),n=s>-1?s:r.indexOf("GEOGCS");if(n===-1)return null;let a=e.slice(n,e.lastIndexOf("]",i)+1).trim(),l=e.slice(i,e.lastIndexOf("]")).trim();t=St(a);let o=new A(t?{wkid:t}:{wkt:a}),c=St(l);return c&&(o.vcsWkid=c),o}return r.startsWith("GEOGCS")||r.startsWith("PROJCS")?(t=St(e),new A(t!==0?{wkid:t}:{wkt:e})):null}function St(e){let t=e.replaceAll("]","[").replaceAll('"',"").split("[").map(s=>s.trim()).filter(s=>s!==""),r=t[t.length-1].split(","),i=r[0]?.toLowerCase();if((i==="epsg"||i==="esri")&&e.endsWith('"]]')){let s=Number(r[1]);if(!isNaN(s)&&s!==0)return s}return 0}function Me(e){if(e?.documentElement.tagName?.toLowerCase()!=="pamdataset")return{};let t={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach(i=>{if(i.nodeType===1){if(st(i,"SRS")){if(!t.spatialReference){let s=te(i);t.spatialReference=Fe(s)}}else if(st(i,"Metadata"))if(i.getAttribute("domain")==="xml:ESRI"){let{spatialReference:s,transform:n}=Tr(i);t.transform=n,t.spatialReference||(t.spatialReference=s)}else ge(i,"MDI").forEach(s=>t.metadata[s.getAttribute("key")]=te(s));else if(st(i,"PAMRasterBand")){let s=_r(i);s.sourceBandIndex!=null&&t.rasterBands[s.sourceBandIndex]==null?t.rasterBands[s.sourceBandIndex]=s:t.rasterBands.push(s)}}});let r=t.rasterBands;if(r.length){let i=!!r[0].statistics;t.statistics=i?r.map(n=>n.statistics).filter(Pe):null;let s=!!r[0].histogram;t.histograms=s?r.map(n=>n.histogram).filter(Pe):null}return t}var nt=class extends ${open(e){return T(this,null,function*(){yield this.init();let t=yield this._fetchData(e),{spatialReference:r,statistics:i,histograms:s,transform:n}=yield this._fetchAuxiliaryData(e),a=!r;a&&(r=new A({wkid:3857})),s?.length&&i==null&&(i=Ie(s));let{width:l,height:o}=t,c=new z({xmin:-.5,ymin:.5-o,xmax:l-.5,ymax:.5,spatialReference:r}),u=n?n.forwardTransform(c):c,f=!0;if(n){let m=n.forwardCoefficients;f=m&&m[1]===0&&m[2]===0,f&&(n=null,c=u)}let p=new _e({source:{extent:u,nativeExtent:c,transform:n,pixelBlocks:[t],statistics:i,histograms:s,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:a},ioConfig:{sampling:"closest",skipStatistics:!0}});this.ioConfig.skipMapInfo&&(p.ioConfig.skipMapInfo=!0),yield p.open(),p.source=null,this._set("rasterInfo",p.rasterInfo),this._inMemoryRaster=p})}fetchRawTile(e,t,r,i={}){return this._inMemoryRaster.fetchRawTile(e,t,r,i)}_fetchData(e){return T(this,null,function*(){let{data:t}=yield this.request(this.url,{responseType:"array-buffer",signal:e?.signal}),r=fi(t).toUpperCase();if(r!=="JPG"&&r!=="PNG"&&r!=="GIF"&&r!=="BMP")throw new P("image-aux-raster:open","the data is not a supported format");this._set("datasetFormat",r);let i=r.toLowerCase(),s=i==="gif"||i==="bmp"||!Tt("ios"),n=yield this.decodePixelBlock(t,{format:i,useCanvas:s,hasNoZlibMask:!0});if(n==null)throw new P("image-aux-raster:open","the data cannot be decoded");return n})}_fetchAuxiliaryData(e){return T(this,null,function*(){let t=e?.signal,{skipExtensions:r=[],skipMapInfo:i}=this.ioConfig,s=i||r.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:t}),n=this.datasetFormat,a=n==="JPG"?"jgw":n==="PNG"?"pgw":n==="BMP"?"bpw":null,l=a&&r.includes(a)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+a,{responseType:"text",signal:t}),o=yield qe([s,l]);if(t?.aborted)throw Mt();let c=Me(o[0].value?.data);if(!c.transform){let u=o[1].value?o[1].value.data.split(`
`).slice(0,6).map(f=>Number(f)):null;c.transform=u?.length===6?new Se({forwardCoefficients:[u[4],u[5],u[0],-u[1],u[2],-u[3]]}):null}return c})}};I([S({type:String,json:{write:!0}})],nt.prototype,"datasetFormat",void 0),nt=I([G("esri.layers.support.rasterDatasets.ImageAuxRaster")],nt);var We=nt;var Ge=class extends ${constructor(){super(...arguments),this._levelOffset=0,this._tilemapCache=null,this._slices=null,this.datasetFormat="RasterTileServer",this.tileType=null}open(e){return T(this,null,function*(){yield this.init();let t=e?.signal,r=this.sourceJSON?{data:this.sourceJSON}:yield this.request(this.url,{query:{f:"json"},signal:t});r.ssl&&(this.url=this.url.replace(/^http:/i,"https:"));let i=r.data;if(this.sourceJSON=i,!i)throw new P("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!i.tileInfo)throw new P("imageserverraster:open","use ImageryLayer to open non-tiled image services");this._fixScaleInServiceInfo();let s=["jpg","jpeg","png","png8","png24","png32","mixed"];this.tileType=i.cacheType,this.tileType==null&&(s.includes(i.tileInfo.format.toLowerCase())?this.tileType="Map":i.tileInfo.format.toLowerCase()==="lerc"?this.tileType="Elevation":this.tileType="Raster"),this.datasetName=i.name?.slice(i.name.indexOf("/")+1)??"";let n=yield this._fetchRasterInfo({signal:t});if(n==null)throw new P("image-server-raster:open","cannot initialize image service");Ui(n,i);let a=this.tileType==="Map"?Fr(i.tileInfo,i):Z.fromJSON(i.tileInfo);Ft(a);let[l,o]=this._computeMinMaxLOD(n,a),{extent:c,pixelSize:u}=n,f=.5/n.width*u.x,p=Math.max(u.x,u.y),{lods:m}=a;(this.tileType!=="Map"&&i.maxScale!==0||Math.abs(u.x-u.y)>f||!m.some(v=>Math.abs(v.resolution-p)<f))&&(u.x=u.y=l.resolution,n.width=Math.ceil((c.xmax-c.xmin)/u.x-.1),n.height=Math.ceil((c.ymax-c.ymin)/u.y-.1));let h=l.level-o.level,[y,g]=a.size,d=[],w=[];m.forEach((v,M)=>{v.level>=o.level&&v.level<=l.level&&d.push({x:v.resolution,y:v.resolution}),M<m.length-1&&w.push(Math.round(10*v.resolution/m[M+1].resolution)/10)}),d.sort((v,M)=>v.x-M.x);let x=this.computeBlockBoundary(c,y,g,a.origin,d,h),b=d.length>1?d.slice(1):null,F;i.transposeInfo&&(F={tileSize:[i.transposeInfo.rows,i.transposeInfo.cols],packetSize:n.keyProperties?._yxs.PacketSize??0});let R=w.length<=1||w.length>=3&&w.slice(0,-1).every(v=>v===w[0])?w[0]??2:Math.round(10/(o.resolution/l.resolution)**(-1/h))/10;if(n.storageInfo=new re({blockWidth:a.size[0],blockHeight:a.size[1],pyramidBlockWidth:a.size[0],pyramidBlockHeight:a.size[1],pyramidResolutions:b,pyramidScalingFactor:R,compression:a.format,origin:a.origin,firstPyramidLevel:1,maximumPyramidLevel:h,tileInfo:a,transposeInfo:F,blockBoundary:x}),this._fixGCSShift(n),this._set("rasterInfo",n),i.capabilities.toLowerCase().includes("tilemap")){let v={tileInfo:n.storageInfo.tileInfo,parsedUrl:Nt(this.url),url:this.url,tileServers:[]};this._tilemapCache=new Ki({layer:v})}})}fetchRawTile(s,n,a){return T(this,arguments,function*(e,t,r,i={}){let{storageInfo:l,extent:o}=this.rasterInfo,{transposeInfo:c}=l,u=c!=null&&!!i.transposedVariableName;if(this._slices&&!u&&i.sliceId==null)return null;let f=u?0:l.maximumPyramidLevel-e+this._levelOffset,p=`${this.url}/tile/${f}/${t}/${r}`,m=this._slices?u?{variable:i.transposedVariableName}:{sliceId:i.sliceId||0}:null,{data:h}=yield this.request(p,{query:m,responseType:"array-buffer",signal:i.signal});if(!h)return null;let y=u?c.tileSize:l.tileInfo.size,g=yield this.decodePixelBlock(h,{width:y[0],height:y[1],planes:null,pixelType:null,isPoint:this.tileType==="Elevation",returnInterleaved:u,noDataValue:this.rasterInfo.noDataValue});if(g==null)return null;let d=l.blockBoundary[e];if(l.compression!=="jpg"||r>d.minCol&&r<d.maxCol&&t>d.minRow&&t<d.maxRow)return g;let{origin:w,blockWidth:x,blockHeight:b}=l,{x:F,y:R}=this.getPyramidPixelSize(e),v=Math.round((o.xmin-w.x)/F)%x,M=Math.round((o.xmax-w.x)/F)%x||x,O=Math.round((w.y-o.ymax)/R)%b,_=Math.round((w.y-o.ymin)/R)%b||b,k=r===d.minCol?v:0,C=t===d.minRow?O:0,D=r===d.maxCol?M:x,E=t===d.maxRow?_:b;return hi(g,{x:k,y:C},{width:D-k,height:E-C}),g})}getSliceIndex(e){if(!this._slices||e==null||e.length===0)return null;let t=e;for(let r=0;r<this._slices.length;r++){let i=this._slices[r].multidimensionalDefinition;if(i.length===t.length&&!i.some(s=>{let n=t.find(a=>s.variableName===a.variableName&&a.dimensionName===s.dimensionName);return n?(Array.isArray(s.values[0])?`${s.values[0][0]}-${s.values[0][1]}`:s.values[0])!==(Array.isArray(n.values[0])?`${n.values[0][0]}-${n.values[0][1]}`:n.values[0]):!0}))return r}return null}fetchVariableStatisticsHistograms(e,t){return T(this,null,function*(){let r=this.request(this.url+"/statistics",{query:{variable:e,f:"json"},signal:t}).then(n=>n.data?.statistics),i=this.request(this.url+"/histograms",{query:{variable:e,f:"json"},signal:t}).then(n=>n.data?.histograms),s=yield Promise.all([r,i]);return s[0]&&s[0].forEach(n=>{n.avg=n.mean,n.stddev=n.standardDeviation}),s[1]?.[0]?.counts?.length||(s[1]=null),{statistics:s[0]||null,histograms:s[1]||null}})}computeBestPyramidLevelForLocation(r){return T(this,arguments,function*(e,t={}){if(!this._tilemapCache)return 0;let i=this.identifyPixelLocation(e,0,t.datumTransformation);if(i===null)return null;let s=0,{maximumPyramidLevel:n}=this.rasterInfo.storageInfo,a=n-s+this._levelOffset,l=i.srcLocation;for(;a>=0;){try{if((yield this._tilemapCache.fetchAvailability(a,i.row,i.col,t))==="available")break}catch{}if(a--,s++,i=this.identifyPixelLocation(l,s,t.datumTransformation),i===null)return null}return a===-1||i==null?null:s})}_fetchRasterInfo(e){return T(this,null,function*(){let t=this.sourceJSON;if(this.tileType==="Map"){let a=t.fullExtent||t.extent,l=Math.ceil((a.xmax-a.xmin)/t.pixelSizeX-.1),o=Math.ceil((a.ymax-a.ymin)/t.pixelSizeY-.1),c=A.fromJSON(t.spatialReference||a.spatialReference),u=new H({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:c});return new se({width:l,height:o,bandCount:3,extent:z.fromJSON(a),spatialReference:c,pixelSize:u,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}})}let{signal:r}=e,i=qi(this.url,this.sourceJSON,{signal:r,query:this.ioConfig.customFetchParameters}),s=t.hasMultidimensions?this.request(`${this.url}/slices`,{query:{f:"json"},signal:r}).then(a=>a.data?.slices).catch(()=>null):null,n=yield Promise.all([i,s]);return this._slices=n[1],n[0]})}_fixScaleInServiceInfo(){let{sourceJSON:e}=this;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}_fixGCSShift(e){let{extent:t,spatialReference:r}=e;t.xmin>-1&&t.xmax>181&&r?.wkid&&r.isGeographic&&(e.nativeExtent=e.extent,e.transform=new Fi,e.extent=e.transform.forwardTransform(t))}_computeMinMaxLOD(e,t){let{pixelSize:r}=e,i=.5/e.width*r.x,{lods:s}=t,n=t.lodAt(Math.max.apply(null,s.map(p=>p.level))),a=t.lodAt(Math.min.apply(null,s.map(p=>p.level))),{tileType:l}=this;if(l==="Map")return this._levelOffset=s[0].level,[n,a];if(l==="Raster")return[s.find(p=>p.resolution===r.x)??n,a];let{minScale:o,maxScale:c}=this.sourceJSON,u=n;c>0&&(u=s.find(p=>Math.abs(p.scale-c)<i),u||(u=s.filter(p=>p.scale>c).sort((p,m)=>p.scale>m.scale?1:-1)[0]??n));let f=a;return o>0&&(f=s.find(p=>Math.abs(p.scale-o)<i)??a,this._levelOffset=f.level-a.level),[u,f]}};function Fr(e,t){if(!e)return null;let{minScale:r,maxScale:i,minLOD:s,maxLOD:n}=t;if(s!=null&&n!=null)return Z.fromJSON(B(N({},e),{lods:e.lods.filter(({level:a})=>a!=null&&a>=s&&a<=n)}));if(r!==0&&i!==0){let a=c=>Math.round(1e4*c)/1e4,l=r?a(r):1/0,o=i?a(i):-1/0;return Z.fromJSON(B(N({},e),{lods:e.lods.filter(c=>{let u=a(c.scale);return u<=l&&u>=o})}))}return Z.fromJSON(e)}I([S({type:String,json:{write:!0}})],Ge.prototype,"datasetFormat",void 0),I([S()],Ge.prototype,"tileType",void 0),Ge=I([G("esri.layers.support.rasterDatasets.ImageServerRaster")],Ge);var or=Ge;var ne=new Map;ne.set("Int8","s8"),ne.set("UInt8","u8"),ne.set("Int16","s16"),ne.set("UInt16","u16"),ne.set("Int32","s32"),ne.set("UInt32","u32"),ne.set("Float32","f32"),ne.set("Float64","f32"),ne.set("Double64","f32");var me=new Map;me.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),me.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),me.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),me.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});var ke=class extends ${constructor(){super(...arguments),this._files=null,this._storageIndex=null,this.datasetFormat="MRF"}open(e){return T(this,null,function*(){yield this.init(),this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);let t=e?e.signal:null,r=yield this.request(this.url,{responseType:"xml",signal:t}),{rasterInfo:i,files:s}=this._parseHeader(r.data),{skipMapInfo:n,skipExtensions:a=[]}=this.ioConfig;if(!a.includes("aux.xml")&&!n){let d=yield this._fetchAuxiliaryData(e);d!=null&&(i.statistics=d.statistics??i.statistics,i.histograms=d.histograms,d.histograms&&i.statistics==null&&(i.statistics=Ie(d.histograms)))}n&&this.updateImageSpaceRasterInfo(i),this._set("rasterInfo",i),this._files=s;let l=yield this.request(s.index,{responseType:"array-buffer",signal:t});this._storageIndex=this._parseIndex(l.data);let{blockWidth:o,blockHeight:c}=this.rasterInfo.storageInfo,u=this.rasterInfo.storageInfo.pyramidScalingFactor,{width:f,height:p}=this.rasterInfo,m=[],h=this._getBandSegmentCount(),y=0,g=-1;for(;y<this._storageIndex.length;){g++;let d=Math.ceil(f/o/u**g)-1,w=Math.ceil(p/c/u**g)-1;y+=(d+1)*(w+1)*h*4,m.push({maxRow:w,maxCol:d,minCol:0,minRow:0})}this.rasterInfo.storageInfo.blockBoundary=m,g>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=g),this.updateTileInfo()})}fetchRawTile(s,n,a){return T(this,arguments,function*(e,t,r,i={}){let{blockWidth:l,blockHeight:o,blockBoundary:c}=this.rasterInfo.storageInfo,u=c[e];if(!u||u.maxRow<t||u.maxCol<r||u.minRow>t||u.minCol>r)return null;let{bandCount:f,pixelType:p}=this.rasterInfo,{ranges:m,actualTileWidth:h,actualTileHeight:y}=this._getTileLocation(e,t,r);if(!m||m.length===0)return null;if(m[0].from===0&&m[0].to===0){let E=new Uint8Array(l*o);return new K({width:l,height:o,pixels:null,mask:E,validPixelCount:0})}let{bandIds:g}=this.ioConfig,d=this._getBandSegmentCount(),w=[],x=0;for(x=0;x<d;x++)g&&!g.includes(x)||w.push(this.request(this._files.data,{range:{from:m[x].from,to:m[x].to},responseType:"array-buffer",signal:i.signal}));let b=yield Promise.all(w),F=b.map(E=>E.data.byteLength).reduce((E,J)=>E+J),R=new Uint8Array(F),v=[],M=0;for(x=0;x<d;x++)v.push(M),R.set(new Uint8Array(b[x].data),M),M+=b[x].data.byteLength;let O=me.get(this.rasterInfo.storageInfo.compression).decoderFormat,_=yield this.decodePixelBlock(R.buffer,{width:l,height:o,format:O,planes:g?.length||f,offsets:v,pixelType:p});if(_==null)return null;let{noDataValue:k}=this.rasterInfo;if(k!=null&&O!=="lerc"&&!_.mask&&(k=k[0],k!=null)){let E=_.width*_.height,J=new Uint8Array(E);if(Math.abs(k)>1e24)for(x=0;x<E;x++)Math.abs((_.pixels[0][x]-k)/k)>1e-6&&(J[x]=1);else for(x=0;x<E;x++)_.pixels[0][x]!==k&&(J[x]=1);_.mask=J}let C=0,D=0;if(h!==l||y!==o){let E=_.mask;if(E)for(x=0;x<o;x++)if(D=x*l,x<y)for(C=h;C<l;C++)E[D+C]=0;else for(C=0;C<l;C++)E[D+C]=0;else for(E=new Uint8Array(l*o),_.mask=E,x=0;x<y;x++)for(D=x*l,C=0;C<h;C++)E[D+C]=1}return _})}_parseIndex(e){if(e.byteLength%16>0)throw new Error("invalid array buffer must be multiples of 16");let t,r,i,s,n,a;if(si){for(r=new Uint8Array(e),s=new ArrayBuffer(e.byteLength),i=new Uint8Array(s),n=0;n<e.byteLength/4;n++)for(a=0;a<4;a++)i[4*n+a]=r[4*n+3-a];t=new Uint32Array(s)}else t=new Uint32Array(e);return t}_getBandSegmentCount(){return me.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}_getTileLocation(e,t,r){let{blockWidth:i,blockHeight:s,pyramidScalingFactor:n}=this.rasterInfo.storageInfo,{width:a,height:l}=this.rasterInfo,o=this._getBandSegmentCount(),c,u,f,p=0,m=0;for(f=0;f<e;f++)m=n**f,c=Math.ceil(a/i/m),u=Math.ceil(l/s/m),p+=c*u;m=n**e,c=Math.ceil(a/i/m),u=Math.ceil(l/s/m),p+=t*c+r,p*=4*o;let h=this._storageIndex.subarray(p,p+4*o),y=0,g=0,d=[];for(let w=0;w<o;w++)y=h[4*w]*2**32+h[4*w+1],g=y+h[4*w+2]*2**32+h[4*w+3],d.push({from:y,to:g});return{ranges:d,actualTileWidth:r<c-1?i:Math.ceil(a/m)-i*(c-1),actualTileHeight:t<u-1?s:Math.ceil(l/m)-s*(u-1)}}_parseHeader(e){let t=Q(e,"MRF_META/Raster");if(!t)throw new P("mrf:open","not a valid MRF format");let r=Q(t,"Size"),i=parseInt(r.getAttribute("x"),10),s=parseInt(r.getAttribute("y"),10),n=parseInt(r.getAttribute("c"),10),a=(te(t,"Compression")||"none").toLowerCase();if(!me.has(a))throw new P("mrf:open","currently does not support compression "+a);let l=te(t,"DataType")||"UInt8",o=ne.get(l);if(o==null)throw new P("mrf:open","currently does not support pixel type "+l);let c=Q(t,"PageSize"),u=parseInt(c.getAttribute("x"),10),f=parseInt(c.getAttribute("y"),10),p=Q(t,"DataValues"),m,h;if(p&&(h=p.getAttribute("NoData"),h!=null&&(m=h.trim().split(" ").map(k=>parseFloat(k)))),Q(e,"MRF_META/CachedSource"))throw new P("mrf:open","currently does not support MRF referencing other data files");let y=Q(e,"MRF_META/GeoTags"),g=Q(y,"BoundingBox"),d,w=!1;if(g!=null){let k=parseFloat(g.getAttribute("minx")),C=parseFloat(g.getAttribute("miny")),D=parseFloat(g.getAttribute("maxx")),E=parseFloat(g.getAttribute("maxy")),J=te(y,"Projection")||"",V=A.WGS84;if(J!=="LOCAL_CS[]")if(J.toLowerCase().startsWith("epsg:")){let W=Number(J.slice(5));isNaN(W)||W===0||(V=new A({wkid:W}))}else V=Fe(J)??A.WGS84;else w=!0,V=new A({wkid:3857});d=new z(k,C,D,E),d.spatialReference=V}else w=!0,d=new z({xmin:-.5,ymin:.5-s,xmax:i-.5,ymax:.5,spatialReference:new A({wkid:3857})});let x=Q(e,"MRF_META/Rsets"),b=parseInt(x?.getAttribute("scale")||"2",10),F=d.spatialReference,R=new re({origin:new H({x:d.xmin,y:d.ymax,spatialReference:F}),blockWidth:u,blockHeight:f,pyramidBlockWidth:u,pyramidBlockHeight:f,compression:a,pyramidScalingFactor:b}),v=new H({x:d.width/i,y:d.height/s,spatialReference:F}),M=new se({width:i,height:s,extent:d,isPseudoSpatialReference:w,spatialReference:F,bandCount:n,pixelType:o,pixelSize:v,noDataValue:m,storageInfo:R}),O=te(e,"datafile"),_=te(e,"IndexFile");return{rasterInfo:M,files:{mrf:this.url,index:_||this.url.replace(".mrf",".idx"),data:O||this.url.replace(".mrf",me.get(a).blobExtension)}}}_fetchAuxiliaryData(e){return T(this,null,function*(){try{let{data:t}=yield this.request(this.url+".aux.xml",{responseType:"xml",signal:e?.signal});return Me(t)}catch{return null}})}};I([S()],ke.prototype,"_files",void 0),I([S()],ke.prototype,"_storageIndex",void 0),I([S({type:String,json:{write:!0}})],ke.prototype,"datasetFormat",void 0),ke=I([G("esri.layers.support.rasterIO.MRFRaster")],ke);var lr=ke;var Rt=(e,t)=>e.get(t)?.values,je=(e,t)=>e.get(t)?.values?.[0],ye=class extends ${constructor(){super(...arguments),this._files=null,this._headerInfo=null,this._bufferSize=1048576,this.datasetFormat="TIFF"}open(e){return T(this,null,function*(){yield this.init();let t=e?e.signal:null,{data:r}=yield this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:t});if(!r)throw new P("tiffraster:open","failed to open url "+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1,this.url.lastIndexOf("."));let{littleEndian:i,firstIFDPos:s,isBigTiff:n}=mi(r),a=[];yield this._readIFDs(a,r,i,s,0,n?8:4,t);let{imageInfo:l,rasterInfo:o}=this._parseIFDs(a),c=li(a),u=ci(a);if(this._headerInfo=N({littleEndian:i,isBigTiff:n,ifds:a,pyramidIFDs:c,maskIFDs:u},l),this._set("rasterInfo",o),!l.isSupported)throw new P("tiffraster:open","this tiff is not supported: "+l.message);if(!l.tileWidth)throw new P("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");o.isPseudoSpatialReference&&ie.getLogger(this).warn("The spatial reference for this tiff is unsupported. Only EPSG spatial reference codes and Esri WKTs are supported.");let f=a[0].get("PREDICTOR")?.values?.[0];if(a[0].get("SAMPLEFORMAT")?.values?.[0]===3&&f===2)throw new P("tiffraster:open","unsupported horizontal difference encoding. Predictor=3 is supported for floating point data");let{skipMapInfo:m,skipExtensions:h=[]}=this.ioConfig;if(!h.includes("aux.xml")&&!m){let y=yield this._fetchAuxiliaryMetaData(e);y!=null&&this._processPAMInfo(y,o)}h.includes("vat.dbf")||o.bandCount!==1||o.pixelType!=="u8"||m||(o.attributeTable=yield this._fetchAuxiliaryTable(e),o.attributeTable!=null&&(o.keyProperties.DataType="thematic")),m&&this.updateImageSpaceRasterInfo(o),this.updateTileInfo()})}fetchRawTile(s,n,a){return T(this,arguments,function*(e,t,r,i={}){if(!this._headerInfo?.isSupported||this.isBlockOutside(e,t,r))return null;let l=yield this._fetchRawTiffTile(e,t,r,!1,i);if(l!=null&&this._headerInfo.hasMaskBand){let o=yield this._fetchRawTiffTile(e,t,r,!0,i);o!=null&&o.pixels[0]instanceof Uint8Array&&(l.mask=o.pixels[0])}return l})}_parseIFDs(e){let t=ai(e),{width:r,height:i,tileWidth:s,tileHeight:n,planes:a,pixelType:l,compression:o,firstPyramidLevel:c,maximumPyramidLevel:u,pyramidBlockWidth:f,pyramidBlockHeight:p,tileBoundary:m,affine:h,metadata:y}=t,g=t.extent.spatialReference?.wkt||t.extent.spatialReference?.wkid,d=Fe(g),w=!!t.isPseudoGeographic;d==null&&(w=!0,d=new A({wkid:3857}));let x=new z(B(N({},t.extent),{spatialReference:d})),b=new H(x?{x:x.xmin,y:x.ymax,spatialReference:d}:{x:0,y:0}),F=new re({blockWidth:s,blockHeight:n,pyramidBlockWidth:f,pyramidBlockHeight:p,compression:o,origin:b,firstPyramidLevel:c,maximumPyramidLevel:u,blockBoundary:m}),R=new H({x:(x.xmax-x.xmin)/r,y:(x.ymax-x.ymin)/i,spatialReference:d}),v=y?{BandProperties:y.bandProperties,DataType:y.dataType}:{},M=null,O=je(e[0],"PHOTOMETRICINTERPRETATION"),_=Rt(e[0],"COLORMAP");if(O<=3&&_?.length>3&&_.length%3==0){M=[];let C=_.length/3;for(let D=0;D<C;D++)M.push([D,_[D]>>>8,_[D+C]>>>8,_[D+2*C]>>>8])}let k=new se({width:r,height:i,bandCount:a,pixelType:l,pixelSize:R,storageInfo:F,spatialReference:d,isPseudoSpatialReference:w,keyProperties:v,extent:x,colormap:M,statistics:y?y.statistics:null});return h?.length&&(k.nativeExtent=new z({xmin:-.5,ymin:.5-i,xmax:r-.5,ymax:.5,spatialReference:d}),k.transform=new Se({polynomialOrder:1,forwardCoefficients:[h[2]+h[0]/2,h[5]-h[3]/2,h[0],h[3],-h[1],-h[4]]}),k.extent=k.transform.forwardTransform(k.nativeExtent),k.pixelSize=new H({x:(x.xmax-x.xmin)/r,y:(x.ymax-x.ymin)/i,spatialReference:d}),F.origin.x=-.5,F.origin.y=.5),{imageInfo:t,rasterInfo:k}}_processPAMInfo(e,t){if(t.statistics=e.statistics??t.statistics,t.histograms=e.histograms,e.histograms&&t.statistics==null&&(t.statistics=Ie(e.histograms)),e.transform&&t.transform==null){t.transform=e.transform,t.nativeExtent=t.extent;let r=t.transform.forwardTransform(t.nativeExtent);t.pixelSize=new H({x:(r.xmax-r.xmin)/t.width,y:(r.ymax-r.ymin)/t.height,spatialReference:t.spatialReference}),t.extent=r}t.isPseudoSpatialReference&&e.spatialReference&&(t.spatialReference=e.spatialReference,t.extent.spatialReference=t.nativeExtent.spatialReference=t.storageInfo.origin.spatialReference=t.spatialReference)}_readIFDs(e,t,r,i,s,n=4,a){return T(this,null,function*(){if(!i)return null;(i>=t.byteLength||i<0)&&(t=(yield this.request(this.url,{range:{from:i+s,to:i+s+this._bufferSize},responseType:"array-buffer",signal:a})).data,s=i+s,i=0);let l=yield this._readIFD(t,r,i,s,De.tiffTags,n,a);if(e.push(l.ifd),!l.nextIFD)return null;yield this._readIFDs(e,t,r,l.nextIFD-s,s,n,a)})}_readIFD(l,o,c,u){return T(this,arguments,function*(e,t,r,i,s=De.tiffTags,n=4,a){if(!e)return null;let f=ui(e,t,r,i,s,n);if(f.success){let p=[];if(f.ifd?.forEach(m=>{m.values||p.push(m)}),p.length>0){let m=p.map(y=>y.offlineOffsetSize).filter(Pe),h=Math.min.apply(null,m.map(y=>y[0]));if(Math.min.apply(null,m.map(y=>y[0]+y[1]))-h<=this._bufferSize){let{data:y}=yield this.request(this.url,{range:{from:h,to:h+this._bufferSize},responseType:"array-buffer",signal:a});e=y,i=h,p.forEach(g=>ni(e,t,g,i))}}if(f.ifd?.has("GEOKEYDIRECTORY")){let m=f.ifd.get("GEOKEYDIRECTORY"),h=m?.values;if(h&&h.length>4){let y=h[0]+"."+h[1]+"."+h[2],g=yield this._readIFD(e,t,m.valueOffset+6-i,i,De.geoKeys,2,a);m.data=g.ifd,m.data&&m.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[y]})}}return f}if(f.requiredBufferSize&&f.requiredBufferSize!==e.byteLength)return(e=(yield this.request(this.url,{range:{from:i,to:i+f.requiredBufferSize+4},responseType:"array-buffer",signal:a})).data).byteLength<f.requiredBufferSize?null:this._readIFD(e,t,0,i,De.tiffTags,4,a)})}_fetchRawTiffTile(n,a,l,o){return T(this,arguments,function*(e,t,r,i,s={}){let c=this._getTileLocation(e,t,r,i);if(!c)return null;let{ranges:u,actualTileWidth:f,actualTileHeight:p,ifd:m}=c,h=u.map(_=>this.request(this.url,{range:_,responseType:"array-buffer",signal:s.signal})),y=yield Promise.all(h),g=y.map(_=>_.data.byteLength).reduce((_,k)=>_+k),d=y.length===1?y[0].data:new ArrayBuffer(g),w=[0],x=[0];if(y.length>1){let _=new Uint8Array(d);for(let k=0,C=0;k<y.length;k++){let D=y[k].data;_.set(new Uint8Array(D),C),w[k]=C,C+=D.byteLength,x[k]=D.byteLength}}let{blockWidth:b,blockHeight:F}=this.getBlockWidthHeight(e),R=yield this.decodePixelBlock(d,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:m,offsets:w,sizes:x},width:b,height:F,planes:null,pixelType:null});if(R==null)return null;let v,M,O;if(f!==b||p!==F){let _=R.mask;if(_)for(v=0;v<F;v++)if(O=v*b,v<p)for(M=f;M<b;M++)_[O+M]=0;else for(M=0;M<b;M++)_[O+M]=0;else for(_=new Uint8Array(b*F),R.mask=_,v=0;v<p;v++)for(O=v*b,M=0;M<f;M++)_[O+M]=1}return R})}_getTileLocation(e,t,r,i=!1){let{firstPyramidLevel:s,blockBoundary:n}=this.rasterInfo.storageInfo,a=e===0?0:e-(s-1),{_headerInfo:l}=this;if(!l)return null;let o=i?l.maskIFDs[a]:a===0?l?.ifds[0]:l?.pyramidIFDs[a-1];if(!o)return null;let c=oi(o,l),u=Rt(o,"TILEOFFSETS");if(u===void 0)return null;let f=Rt(o,"TILEBYTECOUNTS"),{minRow:p,minCol:m,maxRow:h,maxCol:y}=n[a];if(t>h||r>y||t<p||r<m)return null;let g=je(o,"IMAGEWIDTH"),d=je(o,"IMAGELENGTH"),w=je(o,"TILEWIDTH"),x=je(o,"TILELENGTH"),b=[];if(c){let{bandCount:F}=this.rasterInfo;for(let R=0;R<F;R++){let v=R*(h+1)*(y+1)+t*(y+1)+r;b[R]={from:u[v],to:u[v]+f[v]-1}}}else{let F=t*(y+1)+r;b.push({from:u[F],to:u[F]+f[F]-1})}for(let F=0;F<b.length;F++)if(b[F].from==null||!b[F].to||b[F].to<0)return null;return{ranges:b,ifd:o,actualTileWidth:r===y&&g%w||w,actualTileHeight:t===h&&d%x||x}}_fetchAuxiliaryMetaData(e){return T(this,null,function*(){try{let{data:t}=yield this.request(this.url+".aux.xml",{responseType:"xml",signal:e?.signal});return Me(t)}catch{return null}})}_fetchAuxiliaryTable(e){return T(this,null,function*(){try{let{data:t}=yield this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:e?.signal}),r=ve.parse(t);return r?.recordSet?le.fromJSON(r.recordSet):null}catch{return null}})}};I([S()],ye.prototype,"_files",void 0),I([S()],ye.prototype,"_headerInfo",void 0),I([S()],ye.prototype,"_bufferSize",void 0),I([S({type:String,json:{write:!0}})],ye.prototype,"datasetFormat",void 0),ye=I([G("esri.layers.support.rasterDatasets.TIFFRaster")],ye);var cr=ye;var X=new Map;X.set("CRF",{desc:"Cloud Raster Format",constructor:rr}),X.set("MRF",{desc:"Meta Raster Format",constructor:lr}),X.set("TIFF",{desc:"GeoTIFF",constructor:cr}),X.set("RasterTileServer",{desc:"Raster Tile Server",constructor:or}),X.set("JPG",{desc:"JPG Raster Format",constructor:We}),X.set("PNG",{desc:"PNG Raster Format",constructor:We}),X.set("GIF",{desc:"GIF Raster Format",constructor:We}),X.set("BMP",{desc:"BMP Raster Format",constructor:We}),X.set("CovJSON",{desc:"COVJSON Raster Format",constructor:nr}),X.set("MEMORY",{desc:"In Memory Raster Format",constructor:_e});var Ce=class{static get supportedFormats(){let t=new Set;return X.forEach((r,i)=>t.add(i)),t}static open(t){return T(this,null,function*(){let{url:r,ioConfig:i,source:s,sourceJSON:n}=t,a=t.datasetFormat??i?.datasetFormat;a==null&&(r.includes(".")?a=r.slice(r.lastIndexOf(".")+1).toUpperCase():s?.type?.toLowerCase()==="coverage"?a="CovJSON":s?.extent&&s.pixelblocks&&(a="MEMORY")),a==="OVR"||a==="TIF"?a="TIFF":a==="JPG"||a==="JPEG"||a==="JFIF"?a="JPG":a==="COVJSON"&&(a="CovJSON"),r.toLowerCase().includes("/imageserver")&&!r.toLowerCase().includes("/wcsserver")&&(a="RasterTileServer");let l={url:r,source:s,sourceJSON:n,datasetFormat:a,ioConfig:i??{bandIds:null,sampling:null}};if(Object.keys(l).forEach(f=>{l[f]==null&&delete l[f]}),a){if(!this.supportedFormats.has(a))throw new P("rasterfactory:open","not a supported format "+a);if(a==="CRF"&&!i?.enableCRF)throw new P("rasterfactory:open",`cannot open raster: ${r}`);let f=new(X.get(a)).constructor(l);return yield f.open({signal:t.signal}),f}let o=Array.from(X.keys()).filter(f=>f!=="CovJSON"&&f!=="Memory"),c=0,u=()=>{if(a=o[c++],!a||a==="CRF"&&!i?.enableCRF)return null;let f=new(X.get(a)).constructor(l);return f.open({signal:t.signal}).then(()=>f).catch(()=>u())};return u()})}static register(t,r,i){X.has(t.toUpperCase())||X.set(t.toUpperCase(),{desc:r,constructor:i})}};var j=class extends Gt(Vt(Di(Zt(Qt(tr(ei(Kt(jt(Ht(Ut(Qi))))))))))){constructor(...e){super(...e),this._primaryRasters=[],this.bandIds=null,this.interpolation=null,this.legendEnabled=!0,this.isReference=null,this.listMode="show",this.sourceJSON=null,this.version=null,this.type="imagery-tile",this.operationalLayerType="ArcGISTiledImageServiceLayer",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this.source=void 0,this._debouncedSaveOperations=Pt((t,r,i)=>T(this,null,function*(){let{save:s,saveAs:n}=yield import("./chunk-7P3JCTTB.js");switch(t){case Oe.SAVE:return s(this,r);case Oe.SAVE_AS:return n(this,i,r)}}))}normalizeCtorArgs(e,t){return typeof e=="string"?N({url:e},t):e}load(e){let t=e!=null?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(kt).then(()=>this._openRaster(t))),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){let e=[new pe({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"}),new pe({name:"Raster.ServicePixelValue.Raw",alias:"Raw Pixel Value",domain:null,editable:!1,length:50,type:"string"})],{serviceRasterInfo:t}=this,r=t?.attributeTable,i=r!=null?r.fields:null,s="Raster.";if(i){let l=i.filter(o=>o.type!=="oid"&&o.name.toLowerCase()!=="value").map(o=>{let c=o.clone();return c.name=s+o.name,c});e.push(...l)}let n=t?.dataType,a=t?.multidimensionalInfo;if((n==="vector-magdir"||n==="vector-uv")&&a!=null){let l=a.variables[0].unit?.trim(),o="Magnitude"+(l?` (${l})`:"");e.push(new pe({name:"Raster.Magnitude",alias:o,domain:null,editable:!1,type:"double"})),e.push(new pe({name:"Raster.Direction",alias:"Direction (\xB0)",domain:null,editable:!1,type:"double"}))}return e}createPopupTemplate(e){let{rasterFields:t}=this,r=new Set(t.map(({name:i})=>i).filter(i=>i.toLowerCase()!=="raster.servicepixelvalue.raw"));return ti({fields:t,title:this.title},B(N({},e),{visibleFieldNames:r}))}generateRasterInfo(e,t){return T(this,null,function*(){if(!(e=xe(Ae,e)))return this.serviceRasterInfo;try{let{rasterInfo:r}=yield this._openFunctionRaster(e,t);return r}catch(r){throw r instanceof P?r:new P("imagery-tile-layer","the given raster function is not supported")}})}save(e){return T(this,null,function*(){return this._debouncedSaveOperations(Oe.SAVE,e)})}saveAs(e,t){return T(this,null,function*(){return this._debouncedSaveOperations(Oe.SAVE_AS,t,e)})}write(e,t){let r=this._primaryRasters[0]??this.raster;if(this.loaded?r.datasetFormat==="RasterTileServer"&&(r.tileType==="Raster"||r.tileType==="Map"):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return super.write(e,t);if(t?.messages){let i=`${t.origin}/${t.layerContainerType||"operational-layers"}`;t.messages.push(new P("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${i}'`,{layer:this}))}return null}_openRaster(e){return T(this,null,function*(){let t=!1;if(this.raster)yield this._openFromRaster(this.raster,e),t=this.raster.datasetFormat==="Function";else{let{url:i,rasterFunction:s,source:n}=this;if(!i&&!n)throw new P("imagery-tile-layer:open","missing url or source parameter");n?yield this._openFromSource(n,e):s?yield this._openFromUrlWithRasterFunction(i,s,e):yield this._openFromUrl(i,e)}let r=this.raster.rasterInfo;if(!r)throw new P("imagery-tile-layer:load","cannot load resources on "+this.url);if(this._set("serviceRasterInfo",t?r:this._primaryRasters[0].rasterInfo),this._set("spatialReference",r.spatialReference),this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,this.sourceJSON!=null){let i=this.raster.tileType==="Map"&&this.sourceJSON.minLOD!=null&&this.sourceJSON.maxLOD!=null?this.sourceJSON:B(N({},this.sourceJSON),{minScale:0,maxScale:0});this.read(i,{origin:"service"})}else this.read({tileInfo:this.serviceRasterInfo.storageInfo.tileInfo.toJSON()},{origin:"service"});this.title||(this.title=this.raster.datasetName),this.raster.tileType==="Map"&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles(At(()=>this.customParameters,i=>{this.raster&&(this.raster.ioConfig.customFetchParameters=i)}))})}_openFromRaster(e,t){return T(this,null,function*(){e.rasterInfo||(yield e.open({signal:t})),this._primaryRasters=e.datasetFormat==="Function"?e.primaryRasters.rasters:[e],this.url||(this.url=this._primaryRasters[0].url)})}_openFromUrlWithRasterFunction(e,t,r){return T(this,null,function*(){let i=[e];t&&wi(t.toJSON(),i);let s=yield Promise.all(i.map(a=>Ce.open({url:a,sourceJSON:this.sourceJSON,ioConfig:B(N({sampling:"closest"},this.ioConfig),{customFetchParameters:this.customParameters}),signal:r}))),n=s.findIndex(a=>a==null);if(n>-1)throw new P("imagery-tile-layer:open",`cannot open raster: ${i[n]}`);return this._primaryRasters=s,this._initializeWithFunctionRaster(t)})}_openFromUrl(e,t){return T(this,null,function*(){let r=yield Ce.open({url:e,sourceJSON:this.sourceJSON,ioConfig:B(N({sampling:"closest"},this.ioConfig),{customFetchParameters:this.customParameters}),signal:t});if(r==null)throw new P("imagery-tile-layer:open",`cannot open raster: ${e}`);this._primaryRasters=[r],this.raster=r})}_openFromSource(e,t){return T(this,null,function*(){let r="the tiled imagery data source is not supported",i=e.type?.toLowerCase()==="coverage"?"CovJSON":e.extent&&e.pixelBlock?"MEMORY":null;if(!i)throw new P("imagery-tile-layer:open",r);i==="MEMORY"&&(e={extent:e.extent,pixelBlocks:[e.pixelBlock]});let s=yield Ce.open({url:"",source:e,datasetFormat:i,ioConfig:B(N({sampling:"closest"},this.ioConfig),{customFetchParameters:this.customParameters}),signal:t});if(s==null)throw new P("imagery-tile-layer:open",r);this._primaryRasters=[s],this.rasterFunction?yield this._initializeWithFunctionRaster(this.rasterFunction):this.raster=s})}_openFunctionRaster(e,t){return T(this,null,function*(){let r={raster:this._primaryRasters[0]};this._primaryRasters.length>1&&this._primaryRasters.forEach(n=>r[n.url]=n);let i=Qe(e.functionDefinition?.toJSON()??e.toJSON(),r),s=new rt({rasterFunction:i});return yield s.open(t),s})}_initializeWithFunctionRaster(e,t){return T(this,null,function*(){try{this.raster=yield this._openFunctionRaster(e,t)}catch(r){r instanceof P&&ie.getLogger(this).error("imagery-tile-layer:open",r.message),ie.getLogger(this).warn("imagery-tile-layer:open","the raster function cannot be applied and is removed"),this._set("rasterFunction",null),this.raster=this._primaryRasters[0]}})}};I([S({clonable:!1})],j.prototype,"_primaryRasters",void 0),I([S({type:[Ot],json:{write:{overridePolicy(){return{enabled:!this.loaded||this.raster.tileType==="Raster"||this.bandIds?.join(",")!=="0,1,2"}}}}})],j.prototype,"bandIds",void 0),I([S({json:{write:{overridePolicy(){return{enabled:!this.loaded||this.raster.tileType==="Raster"||this.interpolation!=="bilinear"}}}}}),qt(Ai)],j.prototype,"interpolation",void 0),I([S(Oi)],j.prototype,"legendEnabled",void 0),I([S({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],j.prototype,"isReference",void 0),I([S({type:["show","hide"]})],j.prototype,"listMode",void 0),I([S({json:{read:!0,write:!0}})],j.prototype,"blendMode",void 0),I([S()],j.prototype,"sourceJSON",void 0),I([S({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],j.prototype,"version",void 0),I([S({readOnly:!0,json:{read:!1}})],j.prototype,"type",void 0),I([S({type:["ArcGISTiledImageServiceLayer"]})],j.prototype,"operationalLayerType",void 0),I([S({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(e,t)=>!t.disablePopup},write:{target:"disablePopup",overridePolicy(){return{enabled:!this.loaded||this.raster.tileType==="Raster"}},writer(e,t,r){t[r]=!e}}}})],j.prototype,"popupEnabled",void 0),I([S({type:Yt,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy(){return{enabled:!this.loaded||this.raster.tileType==="Raster"}}}}})],j.prototype,"popupTemplate",void 0),I([S({readOnly:!0})],j.prototype,"defaultPopupTemplate",null),I([S({readOnly:!0,type:[pe]})],j.prototype,"fields",void 0),I([S({readOnly:!0,type:[pe]})],j.prototype,"rasterFields",null),I([S({constructOnly:!0})],j.prototype,"source",void 0),j=I([G("esri.layers.ImageryTileLayer")],j);var nc=j;export{nc as default};
