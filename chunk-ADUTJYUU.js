import{a as Re,d as I,e as Z,f as ee,g as M,h as ve,i as Ie,j as re}from"./chunk-NHGP3TF3.js";import{h as xe}from"./chunk-Y6NLSDOT.js";import"./chunk-JODKM7D5.js";import"./chunk-OTMEXTR3.js";import"./chunk-IDPJW6IE.js";import"./chunk-SOLUVP7Z.js";import"./chunk-X7LBHXVA.js";import"./chunk-RSL6RCT6.js";import"./chunk-IWZCTRXU.js";import"./chunk-2KLGWXTA.js";import"./chunk-5C65GV4V.js";import"./chunk-HHJJPMV6.js";import"./chunk-6BKQ4KSA.js";import{m as V}from"./chunk-K3Q25RT2.js";import"./chunk-7QY3BMVN.js";import"./chunk-5L33MNIH.js";import{a as ke}from"./chunk-TNPL7MIN.js";import"./chunk-FYZRIMPP.js";import"./chunk-CPCG3WMS.js";import"./chunk-2MCU4TRW.js";import"./chunk-DKK2SHDE.js";import"./chunk-Y44R6ET5.js";import"./chunk-XPRH3OMS.js";import"./chunk-PFEM3IEB.js";import"./chunk-CLVC2DXO.js";import"./chunk-RZU6EEB3.js";import"./chunk-FKIHG4NK.js";import"./chunk-UC7SIIH5.js";import"./chunk-32334K7D.js";import"./chunk-AA7PSQ6G.js";import"./chunk-67J6HXBQ.js";import"./chunk-Q63RILEF.js";import"./chunk-SBPPDDZ3.js";import"./chunk-JPYM7Q24.js";import"./chunk-FBVOH3OS.js";import"./chunk-5GFUMN7C.js";import"./chunk-XUNM6EI4.js";import"./chunk-OUDBADB4.js";import"./chunk-3HFKIIGP.js";import{c as Ne}from"./chunk-SFX6QP6J.js";import"./chunk-BRJSO7CG.js";import"./chunk-AATZFFI5.js";import{a as Ae}from"./chunk-YNG4NJVY.js";import"./chunk-UOPCQUXQ.js";import"./chunk-IGVG5UOD.js";import{a as _e}from"./chunk-4DJGLT2U.js";import"./chunk-YFH7K2PU.js";import"./chunk-BXHQ44WX.js";import"./chunk-EWHTP5EW.js";import"./chunk-HGQCMOZX.js";import"./chunk-3JBDNTAW.js";import"./chunk-VEC2OYBS.js";import"./chunk-KLNZTVX6.js";import"./chunk-RKDCBEHW.js";import"./chunk-SVWANQOF.js";import"./chunk-F5LV7FRT.js";import"./chunk-X2KAPCU7.js";import"./chunk-JD3KGBGX.js";import"./chunk-DCH44U3G.js";import"./chunk-VXW5JMKD.js";import"./chunk-NJ5QXHI6.js";import"./chunk-RQ6MK374.js";import"./chunk-Y3NWBZAI.js";import"./chunk-4DZRVMTV.js";import"./chunk-227GSM7M.js";import"./chunk-BOCGOENW.js";import"./chunk-LOEAA5XF.js";import"./chunk-Q6RNQVC2.js";import"./chunk-UXJVKRGT.js";import"./chunk-O4XV2BGZ.js";import"./chunk-IY6MAS3P.js";import"./chunk-JJANIEGN.js";import"./chunk-WR6DOBQL.js";import"./chunk-UWZJQ7YC.js";import"./chunk-HKSYSHBE.js";import"./chunk-UJ6V7JUK.js";import"./chunk-MFEUIQGF.js";import"./chunk-L6VKPRBR.js";import"./chunk-I7FAWQNR.js";import"./chunk-E2G5DGVE.js";import"./chunk-CP4KE5S6.js";import"./chunk-4X6XTGI2.js";import"./chunk-VXJKEPDS.js";import"./chunk-I3S324BU.js";import"./chunk-VOTZUGKK.js";import"./chunk-6KRFVLII.js";import"./chunk-OJB2TSJ7.js";import"./chunk-MCO7DSFO.js";import"./chunk-LUPAMFKK.js";import"./chunk-7JD62GP7.js";import"./chunk-CJYUOBHK.js";import"./chunk-GFBD2RSG.js";import"./chunk-NSEXRUGB.js";import"./chunk-Y7WGW4ZH.js";import"./chunk-UCXZVNQG.js";import"./chunk-QJKOK75M.js";import"./chunk-U6WVZEYH.js";import"./chunk-KRMYHUR3.js";import"./chunk-TX7DVQYF.js";import"./chunk-IISBSAYJ.js";import"./chunk-2TKJWM7A.js";import"./chunk-PRVSRJH5.js";import"./chunk-QWLQUMDY.js";import"./chunk-4XUOIGFO.js";import"./chunk-5HCLBNUR.js";import"./chunk-ALVXTOCH.js";import"./chunk-DKZJLDQQ.js";import"./chunk-4QL3AY7F.js";import"./chunk-AMICFNC3.js";import"./chunk-SPDSGGOE.js";import"./chunk-2OKSPLJT.js";import"./chunk-7LEG2VDW.js";import"./chunk-R2HWUZ3L.js";import"./chunk-G24ZJINL.js";import"./chunk-FOMIQQJB.js";import"./chunk-ORM3VHG6.js";import"./chunk-HTWD7KCG.js";import"./chunk-AM3VOA32.js";import"./chunk-SAOUSUZE.js";import"./chunk-FVDACA4R.js";import"./chunk-UIR6P2R4.js";import"./chunk-DFTBSFIN.js";import"./chunk-4HISZWR4.js";import"./chunk-SJW4NR3T.js";import"./chunk-TQAPQODA.js";import"./chunk-M2GLXRA2.js";import"./chunk-EBWCXIFH.js";import{q as Ce}from"./chunk-M76YZBV5.js";import"./chunk-HXQMOXFX.js";import"./chunk-BKKKVIAS.js";import"./chunk-BCREO4Q5.js";import"./chunk-ZVHU7VE3.js";import"./chunk-76YVRX2R.js";import"./chunk-OZF6BMOL.js";import"./chunk-GJP6PTKT.js";import"./chunk-RSDQHAJX.js";import"./chunk-W47PGZ3Y.js";import"./chunk-2OT2C2UU.js";import"./chunk-XIMCHX2H.js";import{b as me}from"./chunk-SF6Z2K5H.js";import"./chunk-GBTN5LIS.js";import"./chunk-JOSG37QF.js";import"./chunk-SLMQFZE3.js";import"./chunk-BN2F4ATU.js";import"./chunk-DJULDHPW.js";import"./chunk-NDG5FXLR.js";import"./chunk-V477EWXM.js";import"./chunk-5ODCEDHC.js";import"./chunk-BENVXA3L.js";import{l as fe,v as Le}from"./chunk-2KZICFRS.js";import"./chunk-D2RUV6O4.js";import"./chunk-4JWMB5SM.js";import"./chunk-VOYK3LZF.js";import"./chunk-HOJTYTYD.js";import"./chunk-XNEAL2YW.js";import"./chunk-J7M5V2SQ.js";import{a as De}from"./chunk-HRFJUMCP.js";import"./chunk-375OYO4P.js";import{L as v}from"./chunk-AUTL5LCV.js";import{S as Te,t as we}from"./chunk-KUJG22IX.js";import"./chunk-OVHPPCBL.js";import{a as x}from"./chunk-W3WDPWBE.js";import{k as be}from"./chunk-GISCFF3Z.js";import"./chunk-MLSR6YE6.js";import"./chunk-SNFOAZZQ.js";import"./chunk-CPDJJRWA.js";import"./chunk-VU5W7W6Y.js";import{r as H,t as X}from"./chunk-HQMV3KQV.js";import"./chunk-CRMMDK2Z.js";import{a as Me,h as A}from"./chunk-EAH6BNBL.js";var te;(function(e){e.MULTIPLIER="multiplier",e.ABSOLUTE="absoluteValue"})(te||(te={}));var Ee,p=null;function Be(){return Ee||(Ee=import("./chunk-KQ7KS7VO.js").then(e=>e.l).then(({default:e})=>e({locateFile:i=>De(`esri/libs/linkchartlayout/${i}`)})).then(e=>{$e(e)}),Ee)}function $e(e){p=e}var S,ae;function $(e,i,n,t,a,o){let s=n.length,y=a.length,g=Float64Array.BYTES_PER_ELEMENT,m=Uint32Array.BYTES_PER_ELEMENT,f=Uint8Array.BYTES_PER_ELEMENT,c=16,D=c+s*(f+2*g)+y*(2*m),N=p._malloc(D);try{let h=N+c-N%c,k=h+s*g,L=k+s*g,b=L+y*m,P=b+y*m,d=()=>[p.HEAPF64.subarray(h>>3,(h>>3)+s),p.HEAPF64.subarray(k>>3,(k>>3)+s),p.HEAPU32.subarray(L>>2,(L>>2)+y),p.HEAPU32.subarray(b>>2,(b>>2)+y),p.HEAPU8.subarray(P,P+s)],[_,Y,U,j,z]=d();_.set(n),Y.set(t),U.set(a),j.set(o),z.set(i);let O=e(s,P,h,k,y,L,b),E=null,G=null;if(O){let l=p.getLayoutLinksTypes(),R=p.getLayoutLinksVerticesEndIndices(),B=p.getLayoutLinksVertices(),w=p.countLayoutLinksVertices();!y||l&&R?w&&!B?O=!1:(E={types:new Uint8Array(p.HEAPU8.subarray(l,l+y)),vertexEndIndex:new Uint32Array(p.HEAPU32.subarray(R>>2,(R>>2)+y)),vertices:new Float64Array(p.HEAPF64.subarray(B>>3,(B>>3)+2*w))},G=p.getAuxiliaryGraphicElements()):O=!1}let[q,J,ie,r,u]=d();return n.set(q),t.set(J),a.set(ie),o.set(r),i.set(u),{success:O,links:E,graphics:G}}finally{p._free(N),p.cleanupLayout()}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"})(S||(S={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(ae||(ae={}));var Pe=2,Ge=1,Fe=-1,oe,le,he,ue,de,pe,He,Se,Oe;(function(e){function i(){return p.getMinIdealEdgeLength()}function n(t,a,o,s,y,g=Pe,m=Ge,f=Fe){return $((c,D,N,h,k,L,b)=>p.applyForceDirectedLayout(c,D,N,h,k,L,b,g,m,f),t,a,o,s,y)}e.getMinIdealEdgeLength=i,e.apply=n})(oe||(oe={})),function(e){function i(n,t,a,o,s,y=Pe,g=Ge,m=Fe){return $((f,c,D,N,h,k,L)=>p.applyCommunityLayout(f,c,D,N,h,k,L,y,g,m),n,t,a,o,s)}e.apply=i}(le||(le={})),function(e){function i(n,t,a,o,s){return $(p.applySimpleLayout,n,t,a,o,s)}e.apply=i}(he||(he={})),function(e){function i(n,t,a,o,s){return $(p.applyHierarchicalLayout,n,t,a,o,s)}e.apply=i}(ue||(ue={})),function(e){function i(n,t,a,o,s){return $(p.applyRadialTreeLayout,n,t,a,o,s)}e.apply=i}(de||(de={})),function(e){function i(n,t,a,o,s){return $(p.applySmartTreeLayout,n,t,a,o,s)}e.apply=i}(pe||(pe={})),function(e){function i(n,t,a,o,s,y,g,m,f){return $((c,D,N,h,k,L,b)=>{if(o.length!==c||s.length!==c||m.length!==k||f.length!==k)return!1;let P=Float64Array.BYTES_PER_ELEMENT,d=16,_=p._malloc(d+c*P),Y=p._malloc(d+c*P),U=p._malloc(d+k*P),j=p._malloc(d+k*P),z=_+d-_%d,O=Y+d-Y%d,E=U+d-U%d,G=j+d-j%d;try{return p.HEAPF64.subarray(z>>3,(z>>3)+c).set(o),p.HEAPF64.subarray(O>>3,(O>>3)+c).set(s),p.HEAPF64.subarray(E>>3,(E>>3)+k).set(m),p.HEAPF64.subarray(G>>3,(G>>3)+k).set(f),p.applyChronologicalLayout(c,D,N,h,z,O,k,L,b,E,G)}finally{p._free(_),p._free(Y),p._free(U),p._free(j)}},n,t,a,y,g)}e.apply=i}(He||(He={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Se||(Se={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(Oe||(Oe={}));var T=class extends Ne(Ae(_e)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new me,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new Le({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new me,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new X("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){let o=this.url.split("/");this.title=o[o.length-2]}let i=new Set,n=[],t=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new X("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach(o=>{o.name&&this._graphTypeLookup.set(o.name,o)}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(o=>{o.name&&this._graphTypeLookup.set(o.name,o)}),e.inclusionModeDefinition?.generateAllSublayers?(n=e.knowledgeGraph.dataModel.entityTypes??[],t=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((o,s)=>{let y=this._graphTypeLookup.get(s);if(!y)return H.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);y.type==="relationship"?i.has(s)||(i.add(s),t.push(y)):y.type==="entity"?i.has(s)||(i.add(s),n.push(y)):(H.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))}):(n=e.knowledgeGraph.dataModel.entityTypes??[],t=e.knowledgeGraph.dataModel.relationshipTypes??[]);let a=new Ie({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=n,this.memberRelationshipTypes=t,this.dataManager=a}load(e){return this.addResolvingPromise(new Promise(i=>{xe(this.url).then(n=>{if(this._initializeLayerProperties({knowledgeGraph:n,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(t=>{t.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(t.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(t=>{t.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(t.name,{useAllData:!0})})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(t=>{t.useAllData=!1,t.members?.forEach(a=>{let o;o=a.linkChartLocation instanceof ke?a.linkChartLocation:a.linkChartLocation?V(a.linkChartLocation):null,o&&o.coords.length===2&&o.lengths.length===0?this.entityLinkChartDiagramLookup.set(a.id,o):this.relationshipLinkChartDiagramLookup.set(a.id,o)}),this.addResolvingPromise(this._initializeDiagram().then(()=>A(this,null,function*(){this.layers.forEach(a=>A(this,null,function*(){yield a.refreshCachedQueryEngine()})),this.tables.forEach(a=>A(this,null,function*(){yield a.refreshCachedQueryEngine()}))})))});else{let t=this.defaultLinkChartConfig?.layoutMode==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then(()=>A(this,null,function*(){be(e);let a=[],o=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(s=>{s.useAllData=!1})),yield this._initializeDiagram(),this.layers.forEach(s=>{o.push(s.refreshCachedQueryEngine()),a.push(new Promise(y=>{s.on("layerview-create",()=>{y(null)})}))}),this.tables.forEach(s=>{o.push(s.refreshCachedQueryEngine())}),yield Promise.all(o)})))}i(null)})})),Promise.resolve(this)}addRecords(e,i){return A(this,null,function*(){let n=[];i?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(n=yield Re(e,this.dataManager.knowledgeGraph));let t=e.concat(n).filter(a=>!this.sublayerIdsCache.get(a.typeName)?.has(a.id));yield this._handleNewRecords(t)})}removeRecords(t){return A(this,arguments,function*(e,{cascadeRemoveRelationships:i=!0,recalculateLayout:n=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){let a=[];for(let s of e)this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(s.typeName)?.useAllData===!1&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(s.typeName)?.members?.has(s.id)&&a.push(s);if(i){let s=new Set,y=[];for(let g of a)if(this.dataManager.nodeConnectionsLookup.has(g.id))for(let m of this.dataManager.nodeConnectionsLookup.get(g.id))s.add(m);for(let g of s)if(this.dataManager.memberIdTypeLookup.has(g))for(let m of this.dataManager.memberIdTypeLookup.get(g))this.dataManager.relationshipTypeNames.has(m)&&y.push({id:g,typeName:m});a=a.concat(y)}this.dataManager.removeFromLayer(a);for(let s of a)this.sublayerIdsCache.get(s.typeName)?.delete(s.id),this.dataManager.relationshipTypeNames.has(s.typeName)?this.relationshipLinkChartDiagramLookup.delete(s.id):this.entityLinkChartDiagramLookup.delete(s.id);n&&(yield this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,this._currentLinkChartConfig.layoutOptions));let o=[];return this.layers.forEach(s=>{o.push(s.refreshCachedQueryEngine())}),yield Promise.all(o),this._refreshNamedTypes(),a})}expand(e,i){return A(this,null,function*(){let n=yield this.dataManager.getConnectedRecordIds(e,i),t=n.filter(a=>!this.sublayerIdsCache.get(a.typeName)?.has(a.id));return yield this._handleNewRecords(n),{records:t}})}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach(e=>{let i=new re({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});i.geometryType?this.layers.push(i):this.tables.push(i),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.memberEntityTypes.forEach(e=>{let i=new re({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});i.geometryType?this.layers.push(i):this.tables.push(i),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,i)=>{let n=we(this.sublayerIdsCache,i,()=>new Set);e.members?.forEach(t=>{if(n.add(t.id),t.linkChartLocation)if(t.linkChartLocation instanceof ke)this.dataManager.relationshipTypeNames.has(i)?this.relationshipLinkChartDiagramLookup.set(t.id,t.linkChartLocation):this.entityLinkChartDiagramLookup.set(t.id,t.linkChartLocation);else{let a=V(t.linkChartLocation);this.dataManager.relationshipTypeNames.has(i)?this.relationshipLinkChartDiagramLookup.set(t.id,t.linkChartLocation?a:null):this.entityLinkChartDiagramLookup.set(t.id,t.linkChartLocation?a:null)}})})}calculateLinkChartLayout(e="RADIAL_TREE",i){return A(this,null,function*(){let n=[],t=[],a=[];this.dataManager.sublayerCaches.forEach((r,u)=>{this.dataManager.entityTypeNames.has(u)?r.forEach(l=>{n.push({typeName:u,feature:l})}):this.dataManager.relationshipTypeNames.has(u)&&r.forEach(l=>{t.push({typeName:u,feature:l})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;let o=new Map,s=new Map,y=new Map,g=new Map,m=new Uint8Array(n.length),f=new Float64Array(n.length),c=new Float64Array(n.length),D=new Uint32Array(t.length),N=new Uint32Array(t.length),h=[],k="FORCE_DIRECTED",L=new Le({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),b,P="FORCE_DIRECTED",d=0,_=0;switch(P=e==="GEOGRAPHIC"?k:e,P){case"FORCE_DIRECTED":b=oe.apply;break;case"COMMUNITY":b=le.apply;break;case"HIERARCHICAL":b=ue.apply;break;case"RADIAL_TREE":b=de.apply;break;case"SMART_TREE":b=pe.apply;break;default:b=he.apply}n.forEach(({typeName:r,feature:u})=>{if(i?.lockedNodeLocations?.has(u.attributes[I])){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(r)?m[d]=S.IsGeographic:m[d]=S.None;let l=i.lockedNodeLocations.get(u.attributes[I]);f[d]=l.x,c[d]=l.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(r)){m[d]=S.IsGeographic;let l=null,R=u.attributes[this.dataManager.geographicLookup.get(r).name];switch(this.dataManager.geographicLookup.get(r)?.geometryType){case"esriGeometryPoint":f[d]=R?.x,c[d]=R?.y;break;case"esriGeometryPolygon":l=R?.centroid,l?.x!=null&&l?.y!=null?(f[d]=l.x,c[d]=l.y):m[d]=S.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":l=R?.extent?.center,l?.x!=null&&l?.y!=null?(f[d]=l.x,c[d]=l.y):m[d]=S.IsMovable;break;default:m[d]=S.IsMovable}(f[d]==null||c[d]==null||Number.isNaN(f[d])||Number.isNaN(c[d]))&&(m[d]=S.IsMovable,f[d]=0,c[d]=0)}else m[d]=S.IsMovable,f[d]=0,c[d]=0;g.set(u.attributes[I],d),h[d]={feature:u,typeName:r},d++});let Y=!1,U=new Map;t.forEach(r=>{let u=r.feature.attributes[Z],l=r.feature.attributes[ee],R=g.get(u),B=g.get(l);if(R!==void 0&&B!==void 0){let w=u+"-"+l,F=U.get(w);F?.has(r.typeName)||(D[_]=R,N[_]=B,F===void 0?U.set(w,new Map([[r.typeName,_]])):F.set(r.typeName,_),_++),a.push(r)}else Y=!0,this.relationshipLinkChartDiagramLookup.set(u,null)}),Y&&H.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");let j=this._validateLayoutSettings(e,i),z=this._convertLayoutSettingsToCalculationSettings(j);yield Be();let{success:O,links:E}=b(m,f,c,D.subarray(0,_),N.subarray(0,_),z.computationBudgetTime,z.idealEdgeLengthMultiplier,z.repulsionRadiusMultiplier);if(!O)throw new X("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let r=0;r<h.length;r++){if(c[r]>84.9999?c[r]=84.9999:c[r]<-84.9999&&(c[r]=-84.9999),f[r]>179.9999?f[r]=179.9999:f[r]<-179.9999&&(f[r]=-179.9999),h[r].feature.attributes[M]=new fe(f[r],c[r]),o.has(h[r].typeName))o.get(h[r].typeName)?.set(h[r].feature.attributes[I],h[r].feature);else{let l=new Map;l.set(h[r].feature.attributes[I],h[r].feature),o.set(h[r].typeName,l)}y.set(h[r].feature.attributes[I],h[r].feature);let u=V(h[r].feature.attributes[M]);this.entityLinkChartDiagramLookup.set(h[r].feature.attributes[I],h[r].feature.attributes[M]?u:null),h[r].feature.attributes[M].x<L.xmin&&(L.xmin=h[r].feature.attributes[M].x),h[r].feature.attributes[M].x>L.xmax&&(L.xmax=h[r].feature.attributes[M].x),h[r].feature.attributes[M].y<L.ymin&&(L.ymin=h[r].feature.attributes[M].y),h[r].feature.attributes[M].y>L.ymax&&(L.ymax=h[r].feature.attributes[M].y)}if(this.linkChartExtent.xmin=L.xmin,this.linkChartExtent.xmax=L.xmax,this.linkChartExtent.ymin=L.ymin,this.linkChartExtent.ymax=L.ymax,!E)throw new X("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");let G=new Map,q=new Map,J=new Map,ie=new Set;for(let r=0;r<a.length;r++){let u=[],l=a[r],R=l.feature.attributes[Z],B=l.feature.attributes[ee],w=R+"-"+B,F=U.get(w).get(l.typeName),K=F===0?0:E?.vertexEndIndex[F-1];if(!ie.has(F)){if(ie.add(F),E.types[F]===ae.Recursive){let C=[E.vertices[2*K],E.vertices[2*K+1]],ge=[E.vertices[2*(K+1)],E.vertices[2*(K+1)+1]],W=[.5*(C[0]+ge[0]),.5*(C[1]+ge[1])],se=[W[0]-C[0],W[1]-C[1]],Qe=[W[0]+se[1],W[1]-se[0]],Ve=[W[0]-se[1],W[1]+se[0]];u.push(C),u.push(Qe),u.push(ge),u.push(Ve),u.push(C)}else{if(E.types[F]!==ae.Regular){H.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let C=K;C<E.vertexEndIndex[F];C++)u.push([E.vertices[2*C],E.vertices[2*C+1]])}let Q=h[g.get(R)]?.feature.attributes[M],ne=h[g.get(B)]?.feature.attributes[M];u[0][0]===Q.x&&u[0][1]===Q.y||(u[0]=[Q.x,Q.y]),u[u.length-1][0]===ne.x&&u[u.length-1][1]===ne.y||(u[u.length-1]=[ne.x,ne.y]);for(let C=1;C<u.length-1;C++)u[C][1]>85.5?u[C][1]=85.5:u[C][1]<-85.5&&(u[C][1]=-85.5),u[C][0]>179.9999?u[C][0]=179.9999:u[C][0]<-179.9999&&(u[C][0]=-179.9999);G.has(w)?G.get(w).push(u):G.set(w,[u])}let Ue=G.get(w);q.has(w)||(q.set(w,new Map),J.set(w,new Map));let ce=q.get(w),ye=J.get(w);ce.has(l.typeName)||(ce.set(l.typeName,Ue.shift()),ye.set(l.typeName,0));let ze=ce.get(l.typeName);ye.set(l.typeName,ye.get(l.typeName)+1);let Ye=new Ce({paths:ze});if(l.feature.attributes[M]=Ye,s.has(l.typeName))s.get(l.typeName)?.set(l.feature.attributes[I],l.feature);else{let Q=new Map;Q.set(l.feature.attributes[I],l.feature),s.set(l.typeName,Q)}y.set(l.feature.attributes[I],l.feature);let je=V(l.feature.attributes[M]);this.relationshipLinkChartDiagramLookup.set(l.feature.attributes[I],l.feature.attributes[M]?je:null)}for(let r of a)r.feature.attributes[ve]=J.get(r.feature.attributes[Z]+"-"+r.feature.attributes[ee])?.get(r.typeName)??null;return this._currentLinkChartConfig={layoutMode:e,layoutOptions:j},{nodes:o,links:s,idMap:y}})}applyNewLinkChartLayout(e="RADIAL_TREE",i){return A(this,null,function*(){let n=[];yield this.calculateLinkChartLayout(e,i),this.layers.forEach(t=>{n.push(t.refreshCachedQueryEngine())}),yield Promise.all(n),this._refreshNamedTypes()})}getCurrentNodeLocations(){let e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(i=>{i?.members?.forEach(n=>{let t=n.linkChartLocation,a,o=n.id;t&&(a="x"in t?{x:t.x,y:t.y}:{x:t.coords[0],y:t.coords[1]},e.set(o,new fe({x:a.x,y:a.y})))})}),e}synchronizeInclusionListWithCache(){return A(this,null,function*(){return new Promise(e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((i,n)=>{if(i.useAllData=!1,i.members&&i.members.size>0){if(!this.dataManager.sublayerCaches.get(n))return;let t=new Set(Array.from(this.dataManager.sublayerCaches.get(n).keys()));Array.from(i.members.keys()).filter(a=>!t.has(a)).forEach(a=>{i.members?.delete(a)})}}),e()})})}refreshLinkChartCache(e){return A(this,null,function*(){yield this.dataManager.refreshCacheContent(e);let i=[];this.layers.forEach(n=>{i.push(n.refreshCachedQueryEngine())}),yield Promise.all(i),this._refreshNamedTypes()})}connectEntities(e){return A(this,null,function*(){let i=[];for(let t of this.dataManager.relationshipTypeNames){let a=this.sublayerIdsCache.get(t);a&&(i=i.concat(Array.from(a.keys())))}let n=yield this.dataManager.getAttachedRelationships(e,i);return yield this._handleNewRecords(n),{records:n}})}_handleNewRecords(e){return A(this,null,function*(){let i=[];this.dataManager.addToLayer(e);for(let t of e)this.sublayerIdsCache.has(t.typeName)||(this.sublayerIdsCache.set(t.typeName,new Set),i.push(t.typeName)),this.sublayerIdsCache.get(t.typeName).add(t.id);for(let t of i){let a=this._graphTypeLookup.get(t);if(a){let o=new re({objectType:a,parentCompositeLayer:this,graphType:a.type,title:t});a.type==="entity"?this.dataManager.entityTypeNames.add(t):this.dataManager.relationshipTypeNames.add(t),o.geometryType?this.layers.push(o):this.tables.push(o),this.dataManager.sublayerCaches.set(t,new Map)}}yield this.dataManager.refreshCacheContent(e.map(t=>t.id));let n=Object.assign({},this._currentLinkChartConfig.layoutOptions);n.lockedNodeLocations=this.getCurrentNodeLocations(),yield this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,n)})}_initializeDiagram(){return A(this,null,function*(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,i)=>{e?.members?.forEach(n=>{let t=n.linkChartLocation,a,o=n.id;if(!t)return;a="x"in t?{x:t.x,y:t.y}:{x:t.coords[0],y:t.coords[1]};let s=V(a);this.dataManager.relationshipTypeNames.has(i)?this.relationshipLinkChartDiagramLookup.set(o,s):this.entityLinkChartDiagramLookup.set(o,s),this.linkChartExtent.xmin>a.x&&(this.linkChartExtent.xmin=a.x),this.linkChartExtent.xmax<a.x&&(this.linkChartExtent.xmax=a.x),this.linkChartExtent.ymin>a.y&&(this.linkChartExtent.ymin=a.y),this.linkChartExtent.ymax<a.y&&(this.linkChartExtent.ymax=a.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(i=>{let n=this.relationshipLinkChartDiagramLookup.get(i.attributes[Z]),t=this.relationshipLinkChartDiagramLookup.get(i.attributes[ee]);if(n&&t){let a=V(new Ce({paths:[[n.coords[0],n.coords[1]],[t.coords[0],t.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(i.attributes[I],a)}else this.relationshipLinkChartDiagramLookup.set(i.attributes[I],null)})})):yield this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,Me({lockedNodeLocations:this.getCurrentNodeLocations()},this.defaultLinkChartConfig.layoutOptions||{})):yield this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})})}_refreshNamedTypes(){for(let e of this.layers)e.emit("refresh",{dataChanged:!0});for(let e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateLayoutSettings(e,i){let n=h=>typeof h=="number"&&!isNaN(h),t=h=>n(h)&&h>=1,a=h=>n(h)&&h>=1,o=h=>Object.values(te).includes(h),s=h=>n(h)&&h>=0,y=new Set(["FORCE_DIRECTED","COMMUNITY","GEOGRAPHIC"]),g={};if(!y.has(e)||!i)return!y.has(e)&&i&&H.getLogger(this).warn("Layout mode options were given for a layout mode that does not utilize them, settings will be ignored"),g;let{computationBudgetTime:m,repulsionRadiusMultiplier:f,idealEdgeLength:c,idealEdgeLengthType:D}=i;a(m)?g.computationBudgetTime=m:m!==void 0&&H.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),t(f)?g.repulsionRadiusMultiplier=f:f!==void 0&&H.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting");let N=c!==void 0||D!==void 0;return e!=="GEOGRAPHIC"&&N?H.getLogger(this).warn("Ideal edge length settings were specified for an incompatible layout mode, and will be ignored"):e==="GEOGRAPHIC"&&N&&(o(D)?g.idealEdgeLengthType=D:D!==void 0&&H.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),s(c)?g.idealEdgeLength=c:c!==void 0&&H.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),g}_convertLayoutSettingsToCalculationSettings(e){let i=e.idealEdgeLength;return e.idealEdgeLengthType===te.ABSOLUTE&&(i===void 0?i=-1:i*=-1),{computationBudgetTime:e.computationBudgetTime,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier,idealEdgeLengthMultiplier:i}}};x([v()],T.prototype,"dataPreloadedInLocalCache",void 0),x([v()],T.prototype,"defaultLinkChartConfig",void 0),x([v()],T.prototype,"dataManager",void 0),x([v()],T.prototype,"knowledgeGraph",void 0),x([v()],T.prototype,"layers",void 0),x([v()],T.prototype,"entityLinkChartDiagramLookup",void 0),x([v()],T.prototype,"relationshipLinkChartDiagramLookup",void 0),x([v()],T.prototype,"linkChartExtent",void 0),x([v()],T.prototype,"memberEntityTypes",void 0),x([v()],T.prototype,"memberRelationshipTypes",void 0),x([v()],T.prototype,"sublayerIdsCache",void 0),x([v()],T.prototype,"tables",void 0),x([v({json:{read:!1}})],T.prototype,"type",void 0),T=x([Te("esri.layers.LinkChartLayer")],T);var Mt=T;export{Mt as default};
