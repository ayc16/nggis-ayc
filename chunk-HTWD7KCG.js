import{b as G}from"./chunk-D2RUV6O4.js";import{r as g,t as R}from"./chunk-HQMV3KQV.js";import{a as b,b as x,h}from"./chunk-EAH6BNBL.js";var U=()=>g.getLogger("esri.support.arcadeOnDemand"),w;function M(){return w||(w=h(this,null,function*(){let a=yield import("./chunk-AYO73M6A.js");return{arcade:a.arcade,arcadeUtils:a,Dictionary:a.Dictionary,Feature:a.arcadeFeature}})),w}var J=(a,e,s)=>p.create(a,e,s,null,["$feature","$view"],[]);var N=(a,e,s,c)=>p.create(a,e,s,c,["$feature","$view"],[]),p=class a{constructor(e,s,c,o,d,n,t){this.services=null,this.script=e,this.evaluate=o;let f=Array.isArray(n)?n:n?.fields;this.fields=f??[],this._syntaxTree=c,this._arcade=s,this._arcadeFeature=d,this._spatialReference=t,this._referencesGeometry=s.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static create(e,s,c,o,d,n){return h(this,null,function*(){let{arcade:t,Feature:f,Dictionary:v}=yield M(),m=G.fromJSON(s),i;try{i=t.parseScript(e,n)}catch(r){return U().error(new R("arcade-bad-expression","Failed to parse arcade script",{script:e,error:r})),null}let $=d.reduce((r,y)=>x(b({},r),{[y]:null}),{}),l=null;o!=null&&(l=new v(o),l.immutable=!0,$.$config=null);let F=t.scriptUsesGeometryEngine(i),A=F&&t.enableGeometrySupport(),E=t.scriptUsesFeatureSet(i)&&t.enableFeatureSetSupport(),_=t.scriptIsAsync(i),S=_&&t.enableAsyncSupport(),D={vars:$,spatialReference:m,useAsync:!!S};yield Promise.all([A,E,S]);let O=new Set;yield t.loadDependentModules(O,i,null,_,F);let u=new v;u.immutable=!1,u.setField("scale",0);let T=t.compileScript(i,D),j=(r,y)=>{let L=r.$view?.timeZone;return"$view"in r&&r.$view&&(u.setField("scale",typeof r.$view=="object"&&"scale"in r.$view?r.$view.scale:void 0),r.$view=u),l&&(r.$config=l),T({vars:r,spatialReference:m,services:y,timeZone:L})};return new a(e,t,i,j,new f,c,m)})}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}};export{M as a,J as b,N as c};
