import{c as Ai}from"./chunk-TJO74ND6.js";import{b as Us}from"./chunk-A3KX3DLS.js";import{d as Fe,e as rt,i as K,j as Hs,k as at,l as T,m as C,n as P,o as _,p as R,q as Te}from"./chunk-VOLKMATP.js";import{$ as Vs,A as ys,Aa as Ds,B as bt,Ba as Et,C as gs,Ca as Lt,D as vt,Da as Bt,E as St,Ea as Ut,F as Qe,Fa as Is,G as Mi,Ga as Rs,H as xs,Ha as Cs,I as Je,Ia as Ht,J as bs,Ja as As,K as Pi,Ka as Os,L as Vt,La as Es,M as oe,Ma as Ls,N as et,O as tt,P as Di,Pa as He,Q as wt,Qa as D,R as q,Ra as Bs,S as G,T as Ss,U as b,V as E,W as v,X as j,Y as ne,Z as _t,_ as Mt,aa as Be,b as Ye,ba as Q,c as Ti,ca as Pt,d as os,da as Ri,e as ns,ea as te,f as _i,fa as ws,g as ls,ga as Dt,ha as Ci,i as us,ia as zs,j as ps,ja as we,k as ms,ka as Fs,l as cs,la as le,m as ds,ma as ze,n as ee,na as ue,o as N,oa as pe,p as n,pa as Ts,q as g,qa as It,r as I,ra as _s,s as S,sa as Rt,t as fs,ta as Ct,u as xt,ua as it,v as k,va as Ms,w as Ee,wa as Ps,x as Re,xa as At,y as ie,ya as Ot,z as hs,za as Ue}from"./chunk-RI4EXXSR.js";import{d as gt}from"./chunk-KNDM5UGY.js";import{a as Ii,b as zt,c as vs,d as Tt}from"./chunk-EKKBMKVP.js";import{t as as}from"./chunk-V2ACH6PW.js";import{i as Le,j as Ft}from"./chunk-57GB3TOJ.js";import{G as Fi,g as is,t as zi,u as ss}from"./chunk-WD4CT5CX.js";import{a as Ji}from"./chunk-W5OI4BJ2.js";import{a as Ke,b as Yi,h as Y,i as Qi,j as ht,k as ge,l as Xe,n as De,o as Vi,p as Ie,q as yt,r as wi}from"./chunk-XSMN6VN6.js";import{a as st}from"./chunk-R4ZRZJFL.js";import{b as ts}from"./chunk-X4LAWCTR.js";import{a as rs}from"./chunk-JIFV566L.js";import{a as es}from"./chunk-TLLESPR2.js";import{a as Pe,c as Si}from"./chunk-AQ74ANSJ.js";import{U as Xi}from"./chunk-BE76S5KT.js";import{a as p,b as O}from"./chunk-W3WDPWBE.js";import{c as vi}from"./chunk-MLSR6YE6.js";import{m as Ki,p as ft,r as Oe}from"./chunk-X3IDZTNG.js";import{b as Zi,p as $i}from"./chunk-IQJU4QT3.js";import{a as m,b as f,h as $e}from"./chunk-EAH6BNBL.js";var M=class{constructor(e){this.registryName=e,this.postProcessingEnabled=!1,this.overrideStencilRef=null,this.drawPhase=Fe.MAP|Fe.HITTEST|Fe.HIGHLIGHT|Fe.DEBUG,this.symbologyPlane=K.FILL}startup(){}shutdown(e){}postProcess(e,t){}};var kt=class extends _t{};p([b(0,g)],kt.prototype,"pos",void 0);var Oi=class extends le{},qt=class extends Q{};p([v(n)],qt.prototype,"dotSize",void 0);var ke=class extends Q{};p([v(N)],ke.prototype,"locations",void 0),p([v(n)],ke.prototype,"pixelRatio",void 0),p([v(n)],ke.prototype,"tileZoomFactor",void 0);var sr=1e-6,xe=class extends Pt{vertex(e){let t=new k(1,0,0,0,-1,0,0,1,1).multiply(new I(e.pos.xy.divide(512),1)),i=G(this.draw.locations,t.xy),r=oe(this.instance.dotSize.divide(2),new n(1)),a=new n(0);a=a.add(q(i.a,new n(sr)).multiply(2));let o=r.add(this.instance.dotSize),l=this.view.displayViewScreenMat3.multiply(new I(e.pos.add(.5),1)),u=new S(l.xy,a,1),c=this.instance.dotSize.divide(o),d=new n(-1).divide(r.divide(o));return o=o.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:o,color:i,ratio:c,invEdgeRatio:d}}fragment(e){let t=Vt(e.glPointCoord.subtract(.5)).multiply(2),i=wt(new n(0),new n(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),r=new Be;return r.glFragColor=e.color.multiply(i),r}};p([v(qt)],xe.prototype,"instance",void 0),p([v(ke)],xe.prototype,"draw",void 0),p([v(zs)],xe.prototype,"view",void 0),p([O(0,E(kt))],xe.prototype,"vertex",null),p([O(0,E(Oi))],xe.prototype,"fragment",null);var Wt=class extends we{};p([b(3,n)],Wt.prototype,"inverseArea",void 0);var qe=class extends Q{};p([v(ee.ofType(S,2))],qe.prototype,"isActive",void 0),p([v(ee.ofType(S,8))],qe.prototype,"colors",void 0),p([v(n)],qe.prototype,"dotValue",void 0);var _e=class extends Q{};p([v(N)],_e.prototype,"dotTexture0",void 0),p([v(N)],_e.prototype,"dotTexture1",void 0),p([v(n)],_e.prototype,"tileZoomFactor",void 0),p([v(n)],_e.prototype,"pixelRatio",void 0),p([v(n)],_e.prototype,"tileDotsOverArea",void 0);var be=class extends ze{_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){let t=new k(2/512,0,0,0,-2/512,0,-1,1,1).multiply(new I(e.pos,1)),i=this.clip(e.id),r=new S(t.xy,i,1),a=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),o=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),l=this.draw.tileZoomFactor.multiply(512).divide(this.draw.pixelRatio),u=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),c=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),d=e.pos.add(.5).divide(l);return{glPosition:r,color:new S(0,0,0,0),textureCoords:d,thresholds0:u,thresholds1:c}}fragment(e){let t=new Be,i=G(this.draw.dotTexture0,e.textureCoords),r=G(this.draw.dotTexture1,e.textureCoords),a=e.thresholds0.subtract(i),o=e.thresholds1.subtract(r),l,u=Ee.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),c=Ee.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){let d=q(new n(0),a),h=q(new n(0),o),y=Je(d,a).add(Je(h,o)),x=q(y,new n(0)),z=new n(1).subtract(x),V=y.add(x),w=a.multiply(d).divide(V),F=o.multiply(h).divide(V),A=u.multiply(w).add(c.multiply(F));l=z.multiply(A)}else{let d=oe(Ci(a),Ci(o)),h=q(d,new n(0)),y=new n(1).subtract(h),x=q(d,a),z=q(d,o),V=u.multiply(x).add(c.multiply(z));l=y.multiply(V)}return t.glFragColor=l,t}hittest(e){return It(this.hittestRequest)}};p([ne],be.prototype,"blending",void 0),p([v(qe)],be.prototype,"instance",void 0),p([v(_e)],be.prototype,"draw",void 0),p([O(0,E(Wt))],be.prototype,"vertex",null),p([O(0,E(le))],be.prototype,"fragment",null);var ot={[Y.BYTE]:1,[Y.UNSIGNED_BYTE]:1,[Y.SHORT]:2,[Y.UNSIGNED_SHORT]:2,[Y.INT]:4,[Y.UNSIGNED_INT]:4,[Y.FLOAT]:4};var Nt=class{constructor(e,t){this._boundPart=null;let i=[];for(let a of t.vertex){let o=Ii.createVertex(e,wi.STATIC_DRAW,a);i.push(o)}let r=[];for(let a of t.index||[]){let o=Ii.createIndex(e,wi.STATIC_DRAW,a);r.push(o)}this.groups=[];for(let a of t.groups){let o;if(a.index!=null){if(!t.index)throw new Error("No index data.");let{BYTES_PER_ELEMENT:y}=t.index[a.index];y===2?o=Y.UNSIGNED_SHORT:y===4&&(o=Y.UNSIGNED_INT)}let l=a.index!=null?r[a.index]:null,u=new Map,c={},d={};for(let y of a.attributes){let{name:x,count:z,type:V,offset:w,normalized:F,divisor:A,stride:H,vertex:W,location:$}=y,L=`vertex-buffer-${W}`,ae=c[L];ae||(ae=c[L]=[]);let Ve=new Ji(x,z,V,w,H,F,A);ae.push(Ve),u.set(x,$),d[L]=i[W]}let h=new Us(e,u,c,d,l);this.groups.push(f(m({},a),{vertexArray:h,locations:u,layout:c,indexing:o}))}this.parts=t.parts}bind(e,t){this._boundPart=t;let{group:i}=this.parts[this._boundPart],{vertexArray:r}=this.groups[i];e.bindVAO(r)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");let{start:t,count:i}=this.parts[this._boundPart],{group:r}=this.parts[this._boundPart],{indexing:a,primitive:o}=this.groups[r];a?e.drawElements(o,i,a,t*ot[a]):e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(let{vertexArray:e}of this.groups)e.dispose()}};var Gt=class s extends Nt{static create(e,t){let i=[],{stride:r,hash:a}=t.layout;if(r==null){r=0;for(let{count:y,type:x,offset:z}of t.layout.attributes){if(z!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");r+=y*ot[x]}}let o=0,l=0;for(let{count:y,name:x,offset:z,type:V,normalized:w}of t.layout.attributes){z!=null&&(l=z);let F={name:x,location:o,vertex:0,count:y,type:V,offset:l,stride:r,divisor:0,normalized:w!=null&&w};i.push(F),o++,l+=y*ot[V]}let u={attributes:i,primitive:t.primitive};t.index!=null&&(u.index=0);let{count:c}=t;if(c==null&&(c=t.index?t.index.length:t.vertex.byteLength/r,Math.floor(c)!==c))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${r}.`);let d={start:0,count:c,group:0,primitive:t.primitive},h={vertex:[t.vertex],parts:[d],groups:[u]};return t.index!=null&&(h.index=[t.index]),a==null&&(a=gt(i)),new s(e,h,{hash:a,attributes:i,stride:r})}constructor(e,t,i){super(e,t),this.layout=i}bind(e,t=0){super.bind(e,t)}};var jt=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){let t=512,i=512,r=new Le(t,i);r.samplingMode=ge.NEAREST,r.wrapMode=Xe.CLAMP_TO_EDGE;let a=new vs(e,new zt(yt.DEPTH_STENCIL,t,i));this._dotFBO=new Tt(e,r,a)}return this._dotFBO}getDotDensityMesh(e){if(this._dotMesh==null){let t=512,i=t*t,r=2,a=new Int16Array(i*r);for(let u=0;u<t;u++)for(let c=0;c<t;c++)a[r*(c+u*t)]=c,a[r*(c+u*t)+1]=u;let o=[{count:2,type:Y.UNSIGNED_SHORT,name:"a_position",offset:0}],l={hash:gt(o),attributes:o,stride:4};this._dotMesh=Gt.create(e,{primitive:Yi.POINTS,vertex:a,count:i,layout:l})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),this._dotTextures===null){let r=new Zi(i);this._dotTextures=[this._allocDotDensityTexture(e,t,r),this._allocDotDensityTexture(e,t,r)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){let r=new Float32Array(t*t*4);for(let o=0;o<r.length;o++)r[o]=i.getFloat();let a=new Le;return a.dataType=Ie.FLOAT,a.samplingMode=ge.NEAREST,a.width=t,a.height=t,new Ft(e,a,r)}};var Zt=class extends M{constructor(){super(...arguments),this.shaders={polygon:new be,point:new xe,fill:new Ot},this.meshWriter=D.DotDensityMeshWriter,this._resources=new Map}render(e,t){at(e)||T(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){let{context:i,painter:r}=e;r.setShader({shader:this.shaders.fill,uniforms:f(m({},P(e,t.target)),{visualVariableColor:null,visualVariableOpacity:null}),defines:m({},_(e)),optionalAttributes:{zoomRange:!1},useComputeBuffer:T(e)}),r.setPipelineState(R(e)),r.submitDraw(i,t)}_renderDotDensity(e,t){let{context:i,painter:r,requiredLevel:a}=e,o=t.instance.getInput(),l=this._getOrCreateResourcesRecord(i),u=l.getDotDensityTextures(i,512,o.seed),c=1/2**(a-t.target.key.level),d=512,h=d*window.devicePixelRatio*d*window.devicePixelRatio,y=1/c*(1/c),x=o.dotScale?e.state.scale/o.dotScale:1,z=o.dotValue*x*y;r.setShader({shader:this.shaders.polygon,uniforms:f(m({},P(e,t.target)),{instance:{isActive:o.isActive,colors:o.colors,dotValue:Math.max(1,z)},draw:{dotTexture0:{unit:zi,texture:u[0]},dotTexture1:{unit:ss,texture:u[1]},tileZoomFactor:c,pixelRatio:window.devicePixelRatio,tileDotsOverArea:h/(512*window.devicePixelRatio*512*window.devicePixelRatio)}}),defines:f(m({},_(e)),{blending:o.blending}),optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState(R(e));let V=i.getViewport();i.setViewport(0,0,512,512);let w=i.getBoundFramebufferObject(),F=l.getFBO(i);i.bindFramebuffer(F),i.setClearColor(0,0,0,0),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.updatePipelineState(i),i.clear(Ke.COLOR_BUFFER_BIT),r.submitDraw(i,t),i.bindFramebuffer(w),i.setViewport(V.x,V.y,V.width,V.height);let A=l.getFBO(i).colorTexture;r.setShader({shader:this.shaders.point,uniforms:{view:Hs(e,t.target),instance:{dotSize:o.dotSize},draw:{locations:{unit:zi,texture:A},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:m({},_(e)),optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.submitDrawMesh(i,l.getDotDensityMesh(i))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new jt,this._resources.set(e,t)),t}};var $t=class extends M{constructor(){super(...arguments),this.meshWriter=D.ComplexFillMeshWriter,this.shaders={geometry:new Ds}}render(e,t){let{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:f(m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Te(t.target)}),defines:m({},_(e)),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(R(e)),r.submitDraw(i,t)}};function me(s){let e=1/s;return{antialiasing:e,blur:0+e}}var Kt=class extends M{constructor(){super(...arguments),this.meshWriter=D.ComplexOutlineFillMeshWriter,this.shaders={geometry:new Ls}}render(e,t){let{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:f(m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),{antialiasingControls:me(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Te(t.target)}),defines:m({},_(e)),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(R(e)),r.submitDraw(i,t)}};var Xt=class extends M{constructor(){super(...arguments),this.meshWriter=D.FillMeshWriter,this.shaders={geometry:new Ot}}render(e,t){let{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),defines:_(e),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(R(e)),r.submitDraw(i,t)}};var Yt=class extends M{constructor(){super(...arguments),this.meshWriter=D.OutlineFillMeshWriter,this.shaders={geometry:new As}}render(e,t){let{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:f(m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),{antialiasingControls:me(a)}),defines:m({},_(e)),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(R(e)),r.submitDraw(i,t)}};var Qt=class extends M{constructor(){super(...arguments),this.meshWriter=D.PatternFillMeshWriter,this.shaders={geometry:new Os}}render(e,t){let{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:f(m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Te(t.target)}),defines:m({},_(e)),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(R(e)),r.submitDraw(i,t)}};var Jt=class extends M{constructor(){super(...arguments),this.meshWriter=D.PatternOutlineFillMeshWriter,this.shaders={geometry:new Es}}render(e,t){let{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:f(m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),{antialiasingControls:me(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Te(t.target)}),defines:m({},_(e)),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(R(e)),r.submitDraw(i,t)}};var ei=class{constructor(e,t,i,r){this.dataType=e,this.samplingMode=t,this.pixelFormat=i,this.internalFormat=r}};function ks(s,e){let{textureFloat:t,colorBufferFloat:i}=s.capabilities,r=t?.textureFloatLinear,a=i?.textureFloat,o=i?.textureHalfFloat,l=i?.floatBlend,u=s.driverTest.floatBufferBlend.result;if(!a&&!o)throw new Oe("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(l&&u||o))throw new Oe("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(u?"":" This device claims support for EXT_float_blend, but does not actually support it."));let c=a&&l&&u,d=o,h=r,y=!!i?.R32F,x=!!i?.R16F;if(c&&h)return h||e.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new ei(Ie.FLOAT,h?ge.LINEAR:ge.NEAREST,y?De.RED:De.RGBA,y?Vi.R32F:De.RGBA);if(d)return new ei(Ie.HALF_FLOAT,ge.LINEAR,x?De.RED:De.RGBA,x?Vi.R16F:De.RGBA);throw new Oe("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}var rr=()=>ft.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources"),ti=class{destroy(){this._accumulateFramebuffer=vi(this._accumulateFramebuffer),this._resolveGradientTexture=vi(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(this._qualityProfile==null){let t=ks(e,rr());this._qualityProfile=f(m({},t),{defines:{usesHalfFloatPrecision:t.dataType!==Ie.FLOAT}})}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(this._accumulateFramebuffer==null){let{dataType:r,samplingMode:a,pixelFormat:o,internalFormat:l}=this.loadQualityProfile(e),u=new Le(t,i);u.pixelFormat=o,u.internalFormat=l,u.dataType=r,u.samplingMode=a,u.wrapMode=Xe.CLAMP_TO_EDGE;let c=new zt(yt.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new Tt(e,u,c)}else{let{width:r,height:a}=this._accumulateFramebuffer;r===t&&a===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(this._resolveGradientTexture==null){let r=new Le;r.wrapMode=Xe.CLAMP_TO_EDGE,this._resolveGradientTexture=new Ft(e,r)}else this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t);return this._resolveGradientTexture}};function ii(s){return s?.25:1}var si=class extends we{};p([b(5,g)],si.prototype,"offset",void 0);var Ei=class extends le{},nt=class extends Q{};p([v(n)],nt.prototype,"radius",void 0),p([v(n)],nt.prototype,"isFieldActive",void 0);var Me=class extends ze{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){let{radius:t,isFieldActive:i}=this.kernelControls,r=e.offset,a=i.multiply(this.storage.getVVData(e.id).x).add(new n(1).subtract(i)),o=this.view.displayViewScreenMat3.multiply(new I(e.pos,1)).add(this.view.displayViewMat3.multiply(new I(r,0)).multiply(t)),l=this.clip(e.id);return m({glPosition:new S(o.xy,l,1),offset:r,fieldValue:a,color:new S(0)},this.maybeRunHittest(e,{},null))}fragment(e){let{offset:t,fieldValue:i}=e,r=Vt(t),a=q(r,new n(1)),o=new n(1).subtract(r.multiply(r)),l=o.multiply(o),u=a.multiply(l).multiply(i).multiply(new n(ii(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new S(u),e)}hittest(e){let{viewMat3:t,tileMat3:i}=this.view,r=t.multiply(i).multiply(new I(e.pos,1));return _s(r.xy,this.kernelControls.radius,this.hittestRequest.position)}};p([ne],Me.prototype,"usesHalfFloatPrecision",void 0),p([v(nt)],Me.prototype,"kernelControls",void 0),p([O(0,E(si))],Me.prototype,"vertex",null),p([O(0,E(Ei))],Me.prototype,"fragment",null);var ri=class extends _t{};p([b(0,g)],ri.prototype,"pos",void 0);var Li=class extends Vs{},We=class extends Q{};p([v(N)],We.prototype,"texture",void 0),p([v(g)],We.prototype,"minAndInvRange",void 0),p([v(n)],We.prototype,"normalization",void 0);var ai=class extends Q{};p([v(N)],ai.prototype,"texture",void 0);var ve=class extends Pt{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new S(e.pos.multiply(2).subtract(1),1,1),uv:e.pos}}fragment(e){let{accumulatedDensity:t,gradient:i}=this,r=G(t.texture,e.uv).r.multiply(new n(ii(this.usesHalfFloatPrecision)));r=r.multiply(t.normalization),r=r.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);let a=G(i.texture,new g(r,.5)),o=new Be;return o.glFragColor=new S(a.rgb.multiply(a.a),a.a),o}};p([ne],ve.prototype,"usesHalfFloatPrecision",void 0),p([v(We)],ve.prototype,"accumulatedDensity",void 0),p([v(ai)],ve.prototype,"gradient",void 0),p([O(0,E(ri))],ve.prototype,"vertex",null),p([O(0,E(Li))],ve.prototype,"fragment",null);var oi=class extends M{constructor(){super(...arguments),this.meshWriter=D.HeatmapMeshWriter,this.shaders={accumulate:new Me,resolve:new ve},this.postProcessingEnabled=!0,this._isBound=!1,this._resources=new Map,this.overrideStencilRef=Ws}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){let{context:i,painter:r,state:a}=e,o=t.instance.getInput(),{isFieldActive:l}=o,u=this._getOrCreateResourcesRecord(i),c=u.loadQualityProfile(i);if(at(e))return;T(e)||this._bind(e,u,o),r.setShader({shader:this.shaders.accumulate,uniforms:f(m({},P(e,t.target)),{kernelControls:{radius:qs(o,a),isFieldActive:l?1:0}}),defines:m(m({},_(e)),c.defines),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)});let d=T(e)?or:Ns;r.setPipelineState(d),r.submitDraw(i,t)}postProcess(e,t){if(T(e)||at(e))return;let{context:i,painter:r}=e,a=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!a?.initialized)return;let{defines:o}=a.loadQualityProfile(i),{minDensity:l,maxDensity:u,radius:c}=t.getInput(),d=8,h=9,y=a.accumulateFramebuffer,x=a.resolveGradientTexture;r.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:d,texture:y.colorTexture},minAndInvRange:[l,1/(u-l)],normalization:3/(c*c*Math.PI)},gradient:{texture:{unit:h,texture:x}}},defines:o,optionalAttributes:{},useComputeBuffer:!1}),i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(y.colorTexture,d),i.bindTexture(x,h),r.setPipelineState(nr),r.submitDrawQuad(i),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new ti,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;let{context:r,state:a,pixelRatio:o}=e,l=r.getBoundFramebufferObject(),u=r.getViewport();this._prevFBO=l,this._prevViewport=u;let{gradient:c,gradientHash:d}=i;t.ensureResolveGradientTexture(r,d,c);let{width:h,height:y}=u,x=ar(qs(i,a),o),z=h*x,V=y*x,w=t.ensureAccumulateFBO(r,z,V);r.blitFramebuffer(l,w,0,0,l.width,l.height,0,0,w.width,w.height,Ke.STENCIL_BUFFER_BIT,ge.NEAREST),r.bindFramebuffer(w),r.setViewport(0,0,w.width,w.height),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(Ke.COLOR_BUFFER_BIT),this._isBound=!0}};function ar(s,e){let t=e>1.5?.25:.5;return s<1/(2*t)?1:t}function Ws(s){return s.key.level+1}var Ns={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:Ws,compare:Qi.GEQUAL,mask:255,op:{fail:ht.KEEP,zFail:ht.KEEP,zPass:ht.REPLACE}}}},or=f(m({},Ns),{stencil:!1}),nr={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function qs(s,e){let{referenceScale:t,radius:i}=s;return i*(t!==0?t/e.scale:1)}var Ce=class extends Q{getVVRotationMat4(e){return ie(Ri(e),Ee.identity(),()=>{let t=this._getNormalizedAngle(e).multiply(Ti),i=Di(t),r=Mi(t);return new Ee(r,i,0,0,i.multiply(new n(-1)),r,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return ie(Ri(e),k.identity(),()=>{let t=this._getNormalizedAngle(e).multiply(Ti),i=Di(t),r=Mi(t);return new k(r,i,0,i.multiply(new n(-1)),r,0,0,0,1)})}_getNormalizedAngle(e){let t=bt(this.rotationType,new n(Ye.Arithmatic));return ie(t,new n(90).subtract(e),e)}};p([v(n)],Ce.prototype,"rotationType",void 0);var lr=360/254,J=class extends we{};p([b(3,S)],J.prototype,"color",void 0),p([b(4,g)],J.prototype,"offset",void 0),p([b(5,g)],J.prototype,"textureUV",void 0),p([b(6,n)],J.prototype,"fontSize",void 0),p([b(7,n)],J.prototype,"referenceSize",void 0),p([b(8,n)],J.prototype,"haloFontSize",void 0),p([b(9,S)],J.prototype,"haloColor",void 0),p([b(10,g)],J.prototype,"zoomRange",void 0),p([b(11,n)],J.prototype,"clipAngle",void 0),p([b(12,S)],J.prototype,"referenceSymbol",void 0);var lt=class extends Mt{};p([b(13,g)],lt.prototype,"offsetNextVertex1",void 0),p([b(14,g)],lt.prototype,"offsetNextVertex2",void 0);var Bi=class extends le{},U=class extends ze{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.isHaloPass=!1,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){let r=t.multiply(lr),a=St(this.view.rotation.subtract(r)),o=et(new n(360).subtract(a),a),l=new n(0),u=bs(this.view.currentZoom.multiply(Fi)).divide(Fi),c=e.x,d=e.y,h=new n(1).subtract(q(c,u)).multiply(2),y=q(new n(90),o).multiply(2),x=new n(2).multiply(new n(1).subtract(q(u,d)));return l=l.add(i.multiply(h)),l=l.add(i.multiply(y)),l=l.add(x),l}vertex(e,t){let i=te(e.bitset,cs),r=new n(1).subtract(i),a=e.fontSize,o=a.divide(_i),l=this.isHaloPass?e.haloColor:this._getVertexColor(e),u=this.isLabel?l.multiply(this.storage.getAnimationValue(e.id)):l,c=this.view.displayViewScreenMat3.multiply(new I(e.pos,1)),d=e.offset,h=new n(1),y=k.identity();if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");let H=e.referenceSymbol,W=H.xy,$=H.z,L=this._unpackDirection(H.w),ae=it(this,e.id,$).divide(2),Ve=L.multiply(ae.add(is));d=d.add(W).add(Ve)}else h=it(this,e.id,e.referenceSize).divide(e.referenceSize),a=a.multiply(h),o=o.multiply(h),d=d.multiply(h),y=At(this,e.id),d=y.multiply(new I(d,0)).xy;let x=te(e.bitset,ds),z=this._getViewRotationMatrix(x).multiply(new I(d,0)),V=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,x):this.clip(e.id,e.zoomRange);V=this.isBackgroundPass?V.add(r.multiply(2)):V.add(i.multiply(2));let w=new S(c.xy.add(z.xy),V,1),F=e.textureUV.divide(this.mosaicInfo.size),A=new n(0);return this.isHaloPass&&(A=e.haloFontSize.divide(o).divide(ls)),m({glPosition:w,color:u,size:o,textureUV:F,antialiasingWidth:new n(.105*_i).divide(a).divide(this.view.pixelRatio),haloDistanceOffset:A},this.maybeRunHittest(e,t,{vvSizeAdjustment:h,vvRotation:y}))}_getViewRotationMatrix(e){let t=this.view.displayViewMat3,i=this.view.displayMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}fragment(e){let t=new n(.25),i=new n(1).subtract(t),r=G(this.mosaicInfo.texture,e.textureUV).a,a=i.subtract(e.haloDistanceOffset);this.highlight&&(a=a.divide(2));let o=e.antialiasingWidth,l=wt(a.subtract(o),a.add(o),r);return this.getFragmentOutput(e.color.multiply(l),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:r}){let a=r.multiply(new I(e.offset.multiply(i),0)),o=r.multiply(new I(t.offsetNextVertex1.multiply(i),0)),l=r.multiply(new I(t.offsetNextVertex2.multiply(i),0)),{viewMat3:u,tileMat3:c}=this.view,d=u.multiply(c).multiply(new I(e.pos,1)),h=d.add(c.multiply(a)).xy,y=d.add(c.multiply(o)).xy,x=d.add(c.multiply(l)).xy;return Ts(this.hittestRequest.position,h.xy,y.xy,x.xy)}_unpackDirection(e){let t=new xt(e),i=hs(t,new xt(2)),r=ys(t,new xt(3));return new g(new n(i).subtract(1),new n(r).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){let i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new fs(!1))}if(this.visualVariableOpacity){let i=this.storage.getOpacityValue(e.id),r=this.visualVariableOpacity.getOpacity(i);t=t.multiply(r)}return t}};p([j(Rt)],U.prototype,"visualVariableColor",void 0),p([j(Ct)],U.prototype,"visualVariableOpacity",void 0),p([j(Ce)],U.prototype,"visualVariableRotation",void 0),p([j(Et)],U.prototype,"visualVariableSizeMinMaxValue",void 0),p([j(Lt)],U.prototype,"visualVariableSizeScaleStops",void 0),p([j(Bt)],U.prototype,"visualVariableSizeStops",void 0),p([j(Ut)],U.prototype,"visualVariableSizeUnitValue",void 0),p([v(Ue)],U.prototype,"mosaicInfo",void 0),p([ne],U.prototype,"isHaloPass",void 0),p([ne],U.prototype,"isBackgroundPass",void 0),p([ne],U.prototype,"isLabel",void 0),p([O(0,E(J)),O(1,E(lt))],U.prototype,"vertex",null),p([O(0,E(Bi))],U.prototype,"fragment",null);var ni=class extends M{constructor(){super(...arguments),this.meshWriter=D.LabelMeshWriter,this.shaders={geometry:new U},this.drawPhase=Fe.LABEL|Fe.LABEL_ALPHA,this.symbologyPlane=K.TEXT}render(e,t){let{context:i,painter:r}=e,a=_(e),o=m({},R(e)),l={shader:this.shaders.geometry,uniforms:f(m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:f(m({},a),{isHaloPass:!1,isBackgroundPass:!0,isLabel:!0}),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:!1};r.setShader(l),r.setPipelineState(o),r.submitDraw(i,t),r.setShader(f(m({},l),{defines:f(m({},a),{isHaloPass:!0,isBackgroundPass:!1,isLabel:!0})})),r.setPipelineState(o),r.submitDraw(i,t),r.setShader(f(m({},l),{defines:f(m({},a),{isHaloPass:!1,isBackgroundPass:!1,isLabel:!0})})),r.setPipelineState(o),r.submitDraw(i,t)}};var li=class extends M{constructor(){super(...arguments),this.meshWriter=D.LineMeshWriter,this.shaders={geometry:new Ht},this.symbologyPlane=K.LINE}render(e,t){let{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:f(m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),{antialiasingControls:me(a)}),defines:m({},_(e)),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(R(e)),r.submitDraw(i,t)}};var Ne=class extends Is{};p([b(9,n)],Ne.prototype,"accumulatedDistance",void 0),p([b(10,g)],Ne.prototype,"segmentDirection",void 0),p([b(11,S)],Ne.prototype,"tlbr",void 0);var Ge=class extends Ht{_getLineWidthRatio(e,t){let i=new n(15.5),r=te(e.bitset,ps);return r.multiply(oe(t,new n(.25))).add(new n(1).subtract(r)).divide(i)}_getSDFAlpha(e){let{halfWidth:t,normal:i,tlbr:r,patternSize:a,accumulatedDistance:o,lineWidthRatio:l}=e,u=a.x.multiply(new n(2)).multiply(l),c=Pi(o.divide(u)),d=new n(.25).multiply(i.y).add(new n(.5)),h=tt(r.xy,r.zw,new g(c,d)),y=Dt(G(this.mosaicInfo.texture,h)).subtract(new n(.5)).multiply(t),x=Qe(new n(.5).subtract(y),new n(0),new n(1));return new S(x)}_getPatternColor(e){let{halfWidth:t,normal:i,color:r,accumulatedDistance:a,patternSize:o,sampleAlphaOnly:l,tlbr:u}=e,c=o.y.multiply(new n(2).multiply(t).divide(o.x)),d=Pi(a.divide(c)),h=new n(.5).multiply(i.y).add(new n(.5)),y=tt(u.xy,u.zw,new g(h,d)),x=G(this.mosaicInfo.texture,y);return this.visualVariableColor!=null&&(x=ie(vt(l,new n(.5)),new S(r.a),r)),x}vertex(e,t){let{segmentDirection:i,tlbr:r,bitset:a}=e,o=Cs(this,e),l=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Je(i,o.scaledOffset)),u=new g(r.z.subtract(r.x),r.w.subtract(r.y)),c=r.divide(this.mosaicInfo.size.xyxy),d=te(a,ms),h=te(a,us),y=ie(vt(d,new n(.5)),this._getLineWidthRatio(e,o.scaledHalfWidth),new n(1));return m(f(m({},o),{tlbr:c,patternSize:u,accumulatedDistance:l,isSDF:d,sampleAlphaOnly:h,lineWidthRatio:y}),this.maybeRunHittest(e,t,o.halfWidth))}fragment(e){let{color:t,opacity:i,isSDF:r}=e,a=Rs(e,this.antialiasingControls.blur),o=ie(vt(r,new n(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),l=t.multiply(i).multiply(a).multiply(o);return this.getFragmentOutput(l,e)}};p([v(Ue)],Ge.prototype,"mosaicInfo",void 0),p([O(0,E(Ne)),O(1,E(Fs))],Ge.prototype,"vertex",null);var ui=class extends M{constructor(){super(...arguments),this.meshWriter=D.TexturedLineMeshWriter,this.shaders={geometry:new Ge},this.symbologyPlane=K.LINE}render(e,t){let{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:f(m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),{antialiasingControls:me(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:m({},_(e)),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(R(e)),r.submitDraw(i,t)}};var se=class extends we{};p([b(3,S)],se.prototype,"color",void 0),p([b(4,S)],se.prototype,"outlineColor",void 0),p([b(5,g)],se.prototype,"offset",void 0),p([b(6,g)],se.prototype,"textureUV",void 0),p([b(7,S)],se.prototype,"sizing",void 0),p([b(8,n)],se.prototype,"placementAngle",void 0),p([b(9,n)],se.prototype,"sizeRatio",void 0),p([b(10,g)],se.prototype,"zoomRange",void 0);var Ae=class extends Mt{};p([b(12,g)],Ae.prototype,"offsetNextVertex1",void 0),p([b(13,g)],Ae.prototype,"offsetNextVertex2",void 0),p([b(14,g)],Ae.prototype,"textureUVNextVertex1",void 0),p([b(15,g)],Ae.prototype,"textureUVNextVertex2",void 0);var Hi=class extends le{};function Se(s,e,t,i){return e.multiply(s.x).add(t.multiply(s.y)).add(i.multiply(s.z))}function Ui(s){return s.multiply(s).divide(128)}var X=class extends ze{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){let i=Ui(e.sizing.x),r=Ui(e.sizing.y),a=Ui(e.sizing.z),o=e.placementAngle,l=te(e.bitset,He.bitset.isSDF),u=te(e.bitset,He.bitset.isMapAligned),c=te(e.bitset,He.bitset.scaleSymbolsProportionally),d=ws(e.bitset,He.bitset.colorLocked),h=Ps(this,e.id),y=Ms(this,e.id,e.color,d).multiply(h),x=this.view.displayViewScreenMat3.multiply(new I(e.pos.xy,1)),z=it(this,e.id,a).divide(a),V=i.multiply(z),w=e.offset.xy.multiply(z),F=r.multiply(c.multiply(z.subtract(1)).add(1));F=et(F,oe(V.subtract(.99),new n(0)));let A=oe(F,new n(1)),H=et(F,new n(1)),W=k.fromRotation(o.multiply(os)),$=At(this,e.id),L=this._getViewRotationMatrix(u).multiply($).multiply(W).multiply(new I(w.xy,0)),ae=this.clip(e.id,e.zoomRange),Ve=new S(x.xy.add(L.xy),ae,1),mt=e.textureUV.divide(this.mosaicInfo.size),ct=e.outlineColor.multiply(H),dt=te(e.bitset,He.bitset.overrideOutlineColor),Ze=e.sizeRatio.multiply(V).multiply(.5);return m({glPosition:Ve,color:y,textureUV:mt,outlineColor:ct,outlineSize:A,distanceToPx:Ze,isSDF:l,overrideOutlineColor:dt},this.maybeRunHittest(e,t,{pos:e.pos,size:V,sizeCorrection:z,isMapAligned:u,outlineSize:A,distanceToPx:Ze,isSDF:l}))}fragment(e){let t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return ie(gs(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){let t=this.view.displayViewMat3,i=this.view.displayMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getViewScreenMatrix(e){let t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getColor(e,t){return ie(bt(t.isSDF,new n(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return G(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){let i=G(this.mosaicInfo.texture,e),r=new n(.5).subtract(Dt(i)).multiply(t.distanceToPx).multiply(ns),a=Qe(new n(.5).subtract(r),new n(0),new n(1)),o=t.color.multiply(a),l=t.outlineSize;this.highlight&&(l=oe(l,t.overrideOutlineColor.multiply(4)));let u=l.multiply(.5),c=St(r).subtract(u),d=Qe(new n(.5).subtract(c),new n(0),new n(1)),h=tt(t.outlineColor,t.color,t.overrideOutlineColor).multiply(d);return new n(1).subtract(h.a).multiply(o).add(h)}_hittestSmallMarker(e,t,i){let{position:r,distance:a,smallSymbolDistance:o}=this.hittestRequest,l=a.subtract(o),{viewMat3:u,tileMat3:c}=this.view,d=u.multiply(c).multiply(new I(i.pos,1)).xy,h=i.size.multiply(.5);return xs(d,r).subtract(h).add(l)}_hittestMarker(e,t,i){let{pos:r,size:a,sizeCorrection:o,isMapAligned:l,outlineSize:u,isSDF:c,distanceToPx:d}=i,h=new I(e.offset.multiply(o),0),y=new I(t.offsetNextVertex1.multiply(o),0),x=new I(t.offsetNextVertex2.multiply(o),0),{viewMat3:z,tileMat3:V}=this.view,w=z.multiply(V).multiply(new I(r,1)),F=this._getViewScreenMatrix(l),A=w.add(F.multiply(h)).xy,H=w.add(F.multiply(y)).xy,W=w.add(F.multiply(x)).xy,$=this.hittestRequest.position,L=this.hittestRequest.distance,ae=pe($.add(new g(Re(L),Re(L))),A,H,W),Ve=pe($.add(new g(0,Re(L))),A,H,W),mt=pe($.add(new g(L,Re(L))),A,H,W),ct=pe($.add(new g(Re(L),0)),A,H,W),dt=pe($,A,H,W),Ze=pe($.add(new g(L,0)),A,H,W),Ni=pe($.add(new g(Re(L),L)),A,H,W),Gi=pe($.add(new g(0,L)),A,H,W),ji=pe($.add(new g(L,L)),A,H,W),de=e.textureUV.divide(this.mosaicInfo.size),fe=t.textureUVNextVertex1.divide(this.mosaicInfo.size),he=t.textureUVNextVertex2.divide(this.mosaicInfo.size),ye={color:new S(1),outlineColor:new S(1),overrideOutlineColor:new n(1),outlineSize:u,distanceToPx:d,isSDF:c},B=new n(0);return B=B.add(ue(ae).multiply(this._getColor(Se(ae,de,fe,he),ye).a)),B=B.add(ue(Ve).multiply(this._getColor(Se(Ve,de,fe,he),ye).a)),B=B.add(ue(mt).multiply(this._getColor(Se(mt,de,fe,he),ye).a)),B=B.add(ue(ct).multiply(this._getColor(Se(ct,de,fe,he),ye).a)),B=B.add(ue(dt).multiply(this._getColor(Se(dt,de,fe,he),ye).a)),B=B.add(ue(Ze).multiply(this._getColor(Se(Ze,de,fe,he),ye).a)),B=B.add(ue(Ni).multiply(this._getColor(Se(Ni,de,fe,he),ye).a)),B=B.add(ue(Gi).multiply(this._getColor(Se(Gi,de,fe,he),ye).a)),B=B.add(ue(ji).multiply(this._getColor(Se(ji,de,fe,he),ye).a)),q(B,new n(.05)).multiply(It(this.hittestRequest))}};p([j(Rt)],X.prototype,"visualVariableColor",void 0),p([j(Ct)],X.prototype,"visualVariableOpacity",void 0),p([j(Ce)],X.prototype,"visualVariableRotation",void 0),p([j(Et)],X.prototype,"visualVariableSizeMinMaxValue",void 0),p([j(Lt)],X.prototype,"visualVariableSizeScaleStops",void 0),p([j(Bt)],X.prototype,"visualVariableSizeStops",void 0),p([j(Ut)],X.prototype,"visualVariableSizeUnitValue",void 0),p([v(Ue)],X.prototype,"mosaicInfo",void 0),p([O(0,E(se)),O(1,E(Ae))],X.prototype,"vertex",null),p([O(0,E(Hi))],X.prototype,"fragment",null);var pi=class extends M{constructor(){super(...arguments),this.meshWriter=D.MarkerMeshWriter,this.shaders={geometry:new X},this.symbologyPlane=K.MARKER}render(e,t){let{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:f(m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey,!0)}),defines:m({},_(e)),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(R(e)),r.submitDraw(i,t)}};var mi=class{constructor(){this.computeAttributes={}}get locationsMap(){let e=new Map;for(let t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){let e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){let e=this.locationsMap,t=Array.from(e.entries()).map(([r,a])=>`${r}.${a}`).join("."),i=Ki(t);this._locationInfo={hash:i,locations:e}}return this._locationInfo}get renamedLocationsMap(){let e=new Map;for(let[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){let r=Object.keys(i).filter(o=>i[o]).map(o=>`${o}_${i[o].toString()}`).join("."),a=Object.keys(t).filter(o=>this.optionPropertyKeys.has(o)).join(".");return`${e.hash}.${r}.${a}`}getProgram(e,t,i,r){let a="",o="";for(let l in i)if(i[l]){let u=typeof i[l]=="boolean"?`#define ${l}
`:`#define ${l} ${i[l]}
`;a+=u,o+=u}return a+=this.vertexShader,o+=this.fragmentShader,new Ss(a,o,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){let t=[];for(let i in this.required){let r=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:r.type,uniformArrayElementType:Gs(r),uniformArrayLength:js(r)})}for(let i in e){let r=this.options[i];if(e[i])for(let a in r){let o=r[a];t.push({uniformHydrated:null,shaderModulePath:`${i}.${a}`,uniformName:a,uniformType:o.type,uniformArrayElementType:Gs(o),uniformArrayLength:js(o)})}}return t}},Gs=s=>s.type==="array"?s.elementType?.type:void 0,js=s=>s.type==="array"?s.size:void 0;var pr={hittestDist:n,hittestPos:g},mr={filterFlags:N,animation:N,visualVariableData:N,dataDriven0:N,dataDriven1:N,dataDriven2:N,gpgpu:N,size:n},cr={displayViewScreenMat3:k,displayViewMat3:k,displayMat3:k,viewMat3:k,tileMat3:k,displayZoomFactor:n,requiredZoomFactor:n,tileOffset:g,currentScale:n,currentZoom:n,metersPerSRUnit:n},ci=class extends mi{constructor(){super(...arguments),this.vertexShader=Ai("materials/pie/pie.vert"),this.fragmentShader=Ai("materials/pie/pie.frag"),this.required=f(m(m({},mr),cr),{outlineWidth:n,colors:ee,defaultColor:S,othersColor:S,outlineColor:S,donutRatio:n,sectorThreshold:n}),this.options={hittestUniforms:pr,visualVariableSizeMinMaxValue:{minMaxValueAndSize:S},visualVariableSizeScaleStops:{sizes:f(m({},ee.ofType(n,8)),{type:"array",elementType:n,size:8}),values:f(m({},ee.ofType(n,8)),{type:"array",elementType:n,size:8})},visualVariableSizeStops:{sizes:f(m({},ee.ofType(n,8)),{type:"array",elementType:n,size:8}),values:f(m({},ee.ofType(n,8)),{type:"array",elementType:n,size:8})},visualVariableSizeUnitValue:{unitValueToPixelsRatio:n},visualVariableOpacity:{opacities:f(m({},ee.ofType(n,8)),{type:"array",elementType:n,size:8}),opacityValues:f(m({},ee.ofType(n,8)),{type:"array",elementType:n,size:8})}},this.locations={pos:{index:0,type:g},id:{index:1,type:I},bitset:{index:2,type:n},offset:{index:3,type:g},texCoords:{index:4,type:g},size:{index:5,type:g},referenceSize:{index:6,type:n},zoomRange:{index:7,type:g}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors=f(m({},ee.ofType(S,e)),{type:"array",elementType:S,size:e})}};var di=class extends M{constructor(){super(...arguments),this.meshWriter=D.PieChartMeshWriter,this.shaders={geometry:new ci},this.symbologyPlane=K.MARKER}render(e,t){let{context:i,painter:r}=e,{instance:a,target:o}=t,l=this.shaders.geometry,u=a.getInput(),c=u.numberOfFields,d=T(e),h=P(e,o),y=_(e);l.setNumberOfFields(c),r.setShader({shader:l,uniforms:f(m(m(m({},C(e,t.target,u.geometry)),h.storage),h.view),{hittestUniforms:h.hittestRequest?{hittestDist:h.hittestRequest?.distance,hittestPos:h.hittestRequest?.position}:null}),defines:f(m({VV_SIZE_MIN_MAX_VALUE:!!u.geometry.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!u.geometry.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!u.geometry.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!u.geometry.visualVariableSizeUnitValue,VV_OPACITY:!!u.geometry.visualVariableOpacity,HITTEST:d,highlight:h.highlight?1:0},y),{numberOfFields:c}),optionalAttributes:{},useComputeBuffer:d}),r.setPipelineState(R(e)),r.submitDraw(i,t)}};var fi=class extends M{constructor(){super(...arguments),this.meshWriter=D.TextMeshWriter,this.shaders={geometry:new U},this.symbologyPlane=K.TEXT}render(e,t){let{context:i,painter:r}=e,a=_(e),o={shader:this.shaders.geometry,uniforms:f(m(m({},C(e,t.target,t.instance.getInput().geometry)),P(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:f(m({},a),{isHaloPass:!1,isBackgroundPass:!0,isLabel:!1}),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)};r.setShader(o),r.setPipelineState(R(e)),r.submitDraw(i,t),r.setShader(f(m({},o),{defines:f(m({},a),{isHaloPass:!0,isBackgroundPass:!1,isLabel:!1})})),r.submitDraw(i,t),r.setShader(f(m({},o),{defines:f(m({},a),{isHaloPass:!1,isBackgroundPass:!1,isLabel:!1})})),r.submitDraw(i,t)}};var re={fill:new Xt("fill"),patternFill:new Qt("patternFill"),complexFill:new $t("complexFill"),outlineFill:new Yt("outlineFill"),patternOutlineFill:new Jt("patternOutlineFill"),complexOutlineFill:new Kt("complexOutlineFill"),marker:new pi("marker"),pieChart:new di("pieChart"),line:new li("line"),texturedLine:new ui("texturedLine"),text:new fi("text"),label:new ni("label"),heatmap:new oi("heatmap"),dotDensity:new Zt("dotDensity")};function Iu(){for(let s in re)re[s].startup()}function Ru(s){for(let e in re)re[e].shutdown(s)}function ut(s,e){let t=s.slice(0,e),i=e-t.length;for(let r=0;r<i;r++){let a=t[t.length-1];t.push(a)}return t}function Zs(s){if(!s)return[0,0,0,0];let{r:e,g:t,b:i,a:r}=s;return[e*(r/255),t*(r/255),i*(r/255),r]}var hi=8,$s=hi-2,Ks=()=>ft.getLogger("esri.views.2d.layers.features.support.rendererUtils");function yi(s){return s.map(e=>dr(e)?fr(e.clone()):e)}function dr(s){return(s.type==="size"||s.type==="color"||s.type==="opacity")&&s.stops!=null}function fr(s){return s.stops=gr(s.type,s.stops??[]),s}function je(s,e,t){return(1-t)*s+t*e}function hr(s,e){let[t,...i]=e,r=i.pop(),a=i[0].value,o=i[i.length-1].value,l=(o-a)/$s,u=[];for(let c=a;c<o;c+=l){let d=0;for(;c>=i[d].value;)d++;let h=i[d],y=e[d-1],x=c-y.value,z=h.value===y.value?1:x/(h.value-y.value);if(s==="color"){let V=i[d],w=e[d-1],F=V.color.clone();F.r=je(w.color.r,F.r,z),F.g=je(w.color.g,F.g,z),F.b=je(w.color.b,F.b,z),F.a=je(w.color.a,F.a,z),u.push({value:c,color:F,label:V.label})}else if(s==="size"){let V=i[d],w=e[d-1],F=Si(V.size),A=je(Si(w.size),F,z);u.push({value:c,size:A,label:V.label})}else{let V=i[d],w=je(e[d-1].opacity,V.opacity,z);u.push({value:c,opacity:w,label:V.label})}}return[t,...u,r]}function yr(s){let[e,...t]=s,i=t.pop();for(;t.length>$s;){let r=0,a=0;for(let o=1;o<t.length;o++){let l=t[o-1],u=t[o],c=Math.abs(u.value-l.value);c>a&&(a=c,r=o)}t.splice(r,1)}return[e,...t,i]}function gr(s,e){return e.length<=hi?e:(Ks().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${hi}. Displayed stops will be simplified.`),e.length>2*hi?hr(s,e):yr(e))}function xr(){let{supportsColorBufferFloat:s,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:t}=st();return s&&e||t}function Uu(s){if(!s)return!0;switch(s.type){case"dot-density":break;case"heatmap":if(!xr()){let e=st(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(i=>!e[i]).join(", ");return Ks().errorOnce(new Oe("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}var vr=1.25,gi=128,Sr=128;function Vr(s){if(!s.stops?.length)return null;let e=s.stops.sort((a,o)=>a.value-o.value),t=ut(e,8),i=t.map(({value:a})=>a),r=t.map(({color:a})=>Zs(a));return{values:i,colors:r}}function wr(s){if(!s.stops?.length)return null;let e=s.stops.sort((i,r)=>i.value-r.value),t=ut(e,8);return{opacityValues:t.map(({value:i})=>i),opacities:t.map(({opacity:i})=>i)}}function zr(s){return{rotationType:s.rotationType==="geographic"?Ye.Geographic:Ye.Arithmatic}}function ki(s){if(!s.stops?.length)return null;if(s.stops.some(i=>i.useMaxValue||i.useMinValue))return(i,r)=>{let a=i.statisticsByLevel.get(r.key.level),o=s.stops.map(u=>({value:u.useMaxValue?a?.get(s.field)?.maxValue??0:u.useMinValue?a?.get(s.field)?.minValue??0:u.value,size:u.size?Pe(u.size):1e-30})).sort((u,c)=>u.value-c.value),l=ut(o,8);return{values:l.map(({value:u})=>u),sizes:l.map(({size:u})=>u)}};let e=s.stops.sort((i,r)=>i.value-r.value),t=ut(e,8);return{values:t.map(({value:i})=>i),sizes:t.map(({size:i})=>Pe(i))}}function Fr(s){return e=>{let{state:t}=e;return{unitValueToPixelsRatio:Xi(t.spatialReference)/es[s.valueUnit]/t.resolution}}}function Xs(s,e){let t=e.length;if(s<e[0].value||t===1)return e[0].size;for(let i=1;i<t;i++)if(s<e[i].value){let r=(s-e[i-1].value)/(e[i].value-e[i-1].value);return e[i-1].size+r*(e[i].size-e[i-1].size)}return e[t-1].size}function Tr(s){let{minDataValue:e,maxDataValue:t,minSize:i,maxSize:r}=s;if(typeof i=="object"&&typeof r=="object")return(a,o)=>{let l=a.state.scale,u=Pe(Xs(l,i.stops)),c=Pe(Xs(l,r.stops));return{minMaxValueAndSize:[e,t,u,c]}};if(typeof i=="object"||typeof r=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,t,Pe(i),Pe(r)]}}var xi={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function qi(s,e=Sr,t=vr){if(s.visualVariableSizeMinMaxValue)return s.visualVariableSizeMinMaxValue instanceof Function?gi:Math.max(s.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*t,e);if(s.visualVariableSizeScaleStops){if(s.visualVariableSizeScaleStops instanceof Function)return gi;let i=s.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*t,e)}if(s.visualVariableSizeStops){if(s.visualVariableSizeStops instanceof Function)return gi;let i=s.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*t,e)}return s.visualVariableSizeUnitValue?2*gi:0}function $u(s){let e=m({},xi);if(!s||!("visualVariables"in s)||!s.visualVariables)return e;for(let t of yi(s.visualVariables))switch(t.type){case"color":e.visualVariableColor=Vr(t);break;case"opacity":e.visualVariableOpacity=wr(t);break;case"rotation":e.visualVariableRotation=zr(t);break;case"size":switch(_r(t)){case"field-stops":e.visualVariableSizeStops=ki(t);break;case"scale-stops":t.target==="outline"?e.visualVariableSizeOutlineScaleStops=ki(t):e.visualVariableSizeScaleStops=ki(t);break;case"min-max":e.visualVariableSizeMinMaxValue=Tr(t);break;case"unit-value":e.visualVariableSizeUnitValue=Fr(t)}break;default:console.error("Unable to handle VV type")}return e}function _r(s){if(typeof s.minDataValue=="number"&&typeof s.maxDataValue=="number"&&s.minSize!=null&&s.maxSize!=null)return"min-max";if((s.expression&&s.expression==="view.scale"||s.valueExpression&&s.valueExpression==="$view.scale")&&Array.isArray(s.stops))return"scale-stops";if((s.field!=null||s.expression&&s.expression!=="view.scale"||s.valueExpression&&s.valueExpression!=="$view.scale")&&(Array.isArray(s.stops)||"levels"in s&&s.levels))return"field-stops";if((s.field!=null||s.expression&&s.expression!=="view.scale"||s.valueExpression&&s.valueExpression!=="$view.scale")&&s.valueUnit!=null)return"unit-value";throw new Error("InternalError: Found unknown sizeVV type")}function Ys(s){return!!(s.visualVariableSizeMinMaxValue||s.visualVariableSizeScaleStops||s.visualVariableSizeStops||s.visualVariableSizeUnitValue||s.visualVariableSizeOutlineScaleStops)}function Yu(s){return!!s.visualVariableRotation}function Mr(s){return s.minScale||s.maxScale?{minScale:s.minScale??0,maxScale:s.maxScale??0}:null}function ce(s){if(s==null)return null;if(Array.isArray(s)){let[e,t,i,r]=s;return[e,t,i,255*r]}return typeof s=="string"?s:f(m({},s),{defaultValue:ce(s?.defaultValue)})}function rp(s,e){return $e(this,null,function*(){let{cimResourceManager:t,cimAnalyzer:i,scaleExpression:r}=e.schemaOptions;yield Promise.all(as.fetchResources(s.symbol,t,[]));let a=i.analyzeSymbolReference(s,!1),o={scaleInfo:Mr(s),scaleExpression:r},l=[];for(let u of a)switch(u.type){case"marker":l.push(...Pr(u,e,o));break;case"fill":l.push(...Cr(u,e,o));break;case"line":l.push(...Or(u,e,o));break;case"text":l.push(...Br(u,e,o))}return l})}function Pr(s,e,t){let{uniforms:i,schemaOptions:r}=e,{store:a}=r,o=s.isOutline?f(m({},xi),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return Dr(a.ensureInstance(re.marker,{geometry:o},{zoomRange:!!t.scaleInfo}),s,i,t)}function Dr(s,e,t,{scaleInfo:i,scaleExpression:r}){let a=Ys(t);return[s.createMeshInfo({params:{size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:ce(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:i,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:ce(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||rs.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:r??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:a,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:qi(t)}})]}function Ir(s,e,t){let{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Rr(a.ensureInstance(re.fill,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!!t.scaleInfo}),s,t)}function Rr(s,e,{scaleInfo:t}){return[s.createMeshInfo({params:{color:ce(e.color)??[0,0,0,0],scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}})]}function Cr(s,e,t){if(!s.spriteRasterizationParam)return Ir(s,e,t);let{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Ar(a.ensureInstance(re.complexFill,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!!t.scaleInfo}),s,i.visualVariableColor!=null,t)}function Ar(s,e,t,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");let r=!!e.hasUnresolvedReplacementColor&&(!t||e.colorLocked),a=e.sampleAlphaOnly&&!r,o=e.spriteRasterizationParam;return[s.createMeshInfo({params:{color:ce(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:a,scaleProportionally:o.resource.type==="CIMHatchFill",sprite:o,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}})]}function Or(s,e,t){let{uniforms:i,schemaOptions:r}=e,{store:a}=r,o=s.isOutline?f(m({},xi),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},l={geometry:o},u=!!(o.visualVariableSizeMinMaxValue||o.visualVariableSizeScaleStops||o.visualVariableSizeStops||o.visualVariableSizeUnitValue);return s.spriteRasterizationParam?Lr(a.ensureInstance(re.texturedLine,l,{zoomRange:!!t.scaleInfo}),s,u,t):Er(a.ensureInstance(re.line,l,{zoomRange:!!t.scaleInfo}),s,u,t)}function Qs(s,e,{scaleInfo:t}){return{params:{color:ce(s.color)??[0,0,0,0],width:s.width,referenceWidth:s.referenceWidth,capType:s.cap,joinType:s.join,miterLimit:s.miterLimit,scaleInfo:t,hasSizeVV:e,effects:s.effects?{type:"cim-effect-infos",effectInfos:s.effects}:null}}}function Er(s,e,t,i){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");return[s.createMeshInfo({params:Qs(e,t,i).params})]}function Lr(s,e,t,i){let{spriteRasterizationParam:r,scaleDash:a,sampleAlphaOnly:o}=e;if(!r)throw new Error("InternalError: Sprite should be defined");return[s.createMeshInfo({params:f(m({},Qs(e,t,i).params),{shouldScaleDash:a??!1,shouldSampleAlphaOnly:o,isSDF:r.resource.type!=="CIMPictureStroke",sprite:r})})]}function Br(s,e,t){let{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Ur(a.ensureInstance(re.text,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue}},{zoomRange:!!t.scaleInfo,referenceSymbol:!1,clipAngle:!1}),s,i,t)}function Ur(s,e,t,{scaleInfo:i,scaleExpression:r}){return[s.createMeshInfo({params:{boxBackgroundColor:ce(e.backgroundColor),boxBorderLineColor:ce(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:ce(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:ce(e.outlineColor)??[0,0,0,0],haloFontSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:r??1,minPixelBuffer:qi(t),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}function Wi(s){return s.some(e=>e.globalId)}function pt(s){return s.filter(e=>!e.error).map(e=>e.objectId??e.globalId).filter(e=>e!=null)}function Js(s,e){let t=new Set(s);for(let i of e.values())t.add(i);return t}function er(s,e){let t=new Set(s);for(let i of e.values())t.delete(i);return t}var tr=class{constructor(e){this.updateTracking=new Bs({debugName:"FeatureCommandQueue"}),this._hasGlobalIds=!1,this._queueProcessor=new ts({concurrency:1,process:e.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}push(e){return $e(this,null,function*(){return this.updateTracking.addPromise(this._doPush(e))})}_doPush(e){return $e(this,null,function*(){let t=this._queueProcessor,i=t.last(),r=[];switch(e.type){case"update":if(i?.type===e.type)return;r.push(t.push(e));break;case"edit":{let a=i?.type==="processed-edit"?i:null;a&&t.popLast();let o=this._mergeEdits(a,e);for(let l of o)l&&r.push(t.push(l));break}}yield Promise.all(r)})}_mergeEdits(e,t){let{addedFeatures:i,deletedFeatures:r,updatedFeatures:a}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||Wi(i)||Wi(a)||Wi(r),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[...i,...a],removed:r}}];let o=new Set(pt(e?.edits.addOrModified??[])),l=new Set(pt(e?.edits.removed??[])),u=new Set([...pt(i),...pt(a)]),c=new Set(pt(r));return[{type:"processed-edit",edits:{addOrModified:Array.from(Js(er(o,c),u)).map(d=>({objectId:d})),removed:Array.from(Js(er(l,u),c)).map(d=>({objectId:d}))}}]}};function hp(s,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:st().maxTextureSize},bindings:Hr(s)}}function bi(s){switch(s){case"opacity":return rt.OPACITY;case"color":return rt.COLOR;case"rotation":return rt.ROTATION;case"size":return rt.SIZE;default:return null}}function Hr(s){if(!s)return[];switch(s.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return ir(s);case"dot-density":return kr(s);case"pie-chart":return qr(s);case"heatmap":return Wr(s)}}function kr(s){let e=[];for(let t of s.attributes)e.push({binding:e.length,expression:t.valueExpression,field:t.field});return e}function qr(s){let e=ir(s),t=4;for(let i of s.attributes)e.push({binding:t++,expression:i.valueExpression,field:i.field});return e}function Wr({valueExpression:s,field:e}){return s||e?[{binding:0,expression:s,field:e}]:[]}function ir(s){return!("visualVariables"in s)||!s.visualVariables?.length?[]:yi(s.visualVariables).map(e=>$r(e)).filter($i)}function Nr(s){return s.valueExpression==="$view.scale"?null:{binding:bi(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression,valueRepresentation:s.valueRepresentation}}function Gr(s){return{binding:bi(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function jr(s){return{binding:bi(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function Zr(s){return{binding:bi(s.type),expression:s.valueExpression,field:s.field}}function $r(s){switch(s.type){case"size":return Nr(s);case"color":return Gr(s);case"opacity":return jr(s);case"rotation":return Zr(s)}}export{re as a,Iu as b,Ru as c,Zs as d,Uu as e,xi as f,qi as g,$u as h,Ys as i,Yu as j,Mr as k,rp as l,Dr as m,Rr as n,Ar as o,Er as p,Lr as q,Ur as r,hp as s,ir as t,tr as u};
