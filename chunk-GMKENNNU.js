import{a as km,c as Wm}from"./chunk-WEEBCN5V.js";import{a as qt,c as qm}from"./chunk-R62TWUKK.js";import{b as $m}from"./chunk-66PFAINT.js";import"./chunk-TFNTL6MK.js";import{a as Ur,c as dn,d as Ea,e as Im,f as Dm,g as Vm,h as Um,i as Fm,j as Bm,k as Nm}from"./chunk-RXA6WDPO.js";import{$ as Pa,A as Pm,B as Sa,C as Lc,D as Em,J as Rm,K as Ic,L as Mr,M as Es,O as Om,P as Ct,Q as wm,R as nr,S as Be,T as Vt,U as Dc,V as Am,W as lr,X as q,Y as Ca,Z as Tm,_ as Rs,a as am,aa as Lm,ba as Vr,c as Ac,ca as Os,d as cn,da as pn,e as Oe,ea as Gc,f as dt,fa as li,g as om,ga as Gm,ha as ci,ia as Mc,j as nm,ja as hi,k as lm,ka as Vc,l as cm,la as Mm,m as hm,ma as ws,n as Bi,o as gm,p as Ni,q as xa,r as ym,s as _m,t as bm,u as vm,v as hn,w as xm,x as Sm,y as Cm}from"./chunk-QRTF6HWT.js";import"./chunk-BJQH3R2Y.js";import"./chunk-I6JXU463.js";import{b as zm}from"./chunk-VI2OGXOO.js";import"./chunk-JAAOLJTO.js";import{b as jm}from"./chunk-4QVJAXM4.js";import{b as Hm}from"./chunk-ZLYS2NZO.js";import{a as Fi}from"./chunk-AWMFYQHJ.js";import{a as Ui,b as pm,c as dm,e as Tc,f as um,g as mm,h as fm}from"./chunk-DRX336HH.js";import"./chunk-SFGIVWEM.js";import"./chunk-TB62XDET.js";import"./chunk-724MIMFK.js";import"./chunk-UJUCAWBP.js";import"./chunk-EXOOWX4Z.js";import{a as rm}from"./chunk-MKR7D3TU.js";import{b as tm}from"./chunk-EETTAW44.js";import"./chunk-RCPMQJFX.js";import{a as xs,b as qu,c as $u,d as an,e as Zu,f as St,g as Qu}from"./chunk-VS7I6ZSL.js";import{C as ju,E as oi,F as sn,G as Oc,H as Gr,I as Hu,J as ni,K as Vi,L as ku,M as Wu,a as Au,d as Tu,e as ht,f as sr,g as ii,h as Cs,i as en,j as Vu,k as tn,l as si,m as ai,n as Uu,p as Fu,q as Bu,r as H,w as rn,y as Nu,z as zu}from"./chunk-7E3X25PE.js";import"./chunk-TXV2XM7Y.js";import{a as Jo,c as Mi,d as or}from"./chunk-PJBIIWFF.js";import"./chunk-R5K6EMED.js";import"./chunk-FVCUBGKZ.js";import"./chunk-NGKFFCVN.js";import"./chunk-SLXUZRWI.js";import{b as ti}from"./chunk-LCQ5TU4N.js";import"./chunk-JT7Q7RMM.js";import"./chunk-6ZLU3GYX.js";import"./chunk-SEF6VOKB.js";import"./chunk-LCBWJNVO.js";import{a as Dt,b as Gt,c as Mt}from"./chunk-JAXR3ZUJ.js";import{d as ir,e as Lu,g as Xo}from"./chunk-XN46SLSO.js";import"./chunk-UGL7UJES.js";import"./chunk-QKPKWNQQ.js";import"./chunk-IHA7ZQ4Q.js";import{b as R}from"./chunk-XSJRPCD6.js";import"./chunk-JRJHFO7J.js";import"./chunk-JR27VNVT.js";import"./chunk-WICM2VEE.js";import"./chunk-DUZ52FW3.js";import"./chunk-VLBUZRRG.js";import"./chunk-7G763D5W.js";import{b as et,c as Iu,d as Ht,j as Du,k as ri,l as va,m as Ss,p as Te,q as ar,r as kt,s as Wt,t as Yu,u as on,v as tt,w as nn}from"./chunk-3DDJTCET.js";import{a as He}from"./chunk-UDMTFKLM.js";import"./chunk-BYXBJQAS.js";import"./chunk-L5A2ASNG.js";import"./chunk-3OLRRKKD.js";import"./chunk-PTXLSCMJ.js";import{b as Ko,c as Gu,d as Mu,e as xt,f as pt,g as Ze}from"./chunk-AW3LMT4V.js";import"./chunk-CUZMG5WC.js";import"./chunk-KSYSYYET.js";import"./chunk-LTJDZ7OM.js";import"./chunk-6EZU2A2D.js";import"./chunk-OZLCBZHH.js";import"./chunk-UTDAYTD2.js";import"./chunk-JCJ5KQ5Q.js";import"./chunk-TREMRME7.js";import"./chunk-C2FNHCAJ.js";import"./chunk-TC5CYD6H.js";import{c as Ru}from"./chunk-BYADM53I.js";import{a as No}from"./chunk-ADDH3SWI.js";import{v as zo}from"./chunk-UDPPAMEQ.js";import"./chunk-NOUYXRP4.js";import{b as Yd,c as Zd}from"./chunk-Q7K227NX.js";import{g as Hd,h as kd,j as Wd,k as qd}from"./chunk-GJBALZEB.js";import"./chunk-GHXDYQ3O.js";import"./chunk-ZOOQQO74.js";import"./chunk-XVH66ALE.js";import"./chunk-B7IX6UFG.js";import"./chunk-XAHD7XBV.js";import{i as je,j as _a}from"./chunk-DL3OPG77.js";import{a as ga,d as vs,e as bu,j as vu}from"./chunk-RBP2Z7C6.js";import{a as qo,b as Pu,c as Zo}from"./chunk-7IOYS23Y.js";import"./chunk-BYXBJQAS.js";import"./chunk-AIKSV6LF.js";import{b as Su,c as Cu}from"./chunk-LIKXTYW2.js";import{b as Yo}from"./chunk-ELGDZDOQ.js";import"./chunk-NQ4QDYDP.js";import"./chunk-S26YVN25.js";import{a as L,c as Pc,d as Ec,e as Gi,g as Dr,i as Rc,l as $o}from"./chunk-DOFADBK3.js";import"./chunk-VYC75ESO.js";import"./chunk-ZN6YLP6I.js";import"./chunk-VVVTRG42.js";import"./chunk-CETY2ZOK.js";import"./chunk-CI3GTVLF.js";import"./chunk-Y6C54FDT.js";import"./chunk-5H3X7WYB.js";import"./chunk-GMW3QDVG.js";import"./chunk-RHABF3KL.js";import{a as _u,b as j}from"./chunk-KUOODJRB.js";import"./chunk-DLJEBXJT.js";import{b as yu}from"./chunk-4HCGCIRX.js";import{a as Re,f as ct,g as ei}from"./chunk-OW7DVBQB.js";import{a as gu,c as Sc,d as Cc}from"./chunk-A2AOHK3A.js";import{a as Ir}from"./chunk-UZSTUBKI.js";import"./chunk-56SRKZHP.js";import{a as cu}from"./chunk-BEEN2Y4A.js";import"./chunk-PEVVMXZX.js";import{b as nu,d as lu}from"./chunk-K7V3EGTE.js";import{b as Bd,d as Nd,e as zd,f as rr}from"./chunk-JXODTGE4.js";import{a as wi,b as pd,c as ic}from"./chunk-IWZCTRXU.js";import"./chunk-5C65GV4V.js";import{a as cd}from"./chunk-6BKQ4KSA.js";import{m as rd}from"./chunk-YAIVKHQ7.js";import"./chunk-7QY3BMVN.js";import{a as td}from"./chunk-5L33MNIH.js";import{a as ed}from"./chunk-TNPL7MIN.js";import{a as Uo,b as Rd}from"./chunk-ZRUFSF4E.js";import{a as Go}from"./chunk-LAXYP2KV.js";import{b as Lt,d as Ke,f as bs}from"./chunk-TIXZ4OWB.js";import{a as Ee,g as xd}from"./chunk-NDZXQR2V.js";import"./chunk-W5OI4BJ2.js";import{a as g,b as Mo}from"./chunk-UVJ5D37D.js";import"./chunk-2NH7HOKA.js";import{b as Sd,c as tr,i as cc,k as Cd,l as Lr,r as Do,x as _s}from"./chunk-ZAQLF7TN.js";import"./chunk-JFY2XMDP.js";import{a as Vo,b as hc,c as Pd,d as Ed,e as Xr}from"./chunk-ZHUHFKYD.js";import{c as Gd,g as pc,h as dc,i as uc,j as mc,k as Md,m as da,n as Vd}from"./chunk-PLEVQKLM.js";import"./chunk-OB5UG54O.js";import{a as Fe,b as Dd,c as It}from"./chunk-SKXQUOOX.js";import{b as pa}from"./chunk-Z6XPPWSB.js";import{b as bt}from"./chunk-6HNTTYFF.js";import"./chunk-LWKMZQFJ.js";import{b as fd,c as oc,d as gs,e as Jr,h as nc,k as gd,l as yd,m as lc,p as ys}from"./chunk-I3DWOIS7.js";import{a as Ku,c as em}from"./chunk-XRPMTSX6.js";import{b as Ps}from"./chunk-5NHMASEK.js";import{a as im,b as sm}from"./chunk-LK45ZNWD.js";import{b as wc}from"./chunk-S3DH7XZE.js";import{a as Xu}from"./chunk-ZJHI7U3R.js";import{i as Ju}from"./chunk-HHIR5BNR.js";import{a as wu}from"./chunk-B6VNGUER.js";import{d as Ou}from"./chunk-CDCW33GU.js";import"./chunk-4D3QHJI2.js";import"./chunk-E2J2V7JN.js";import{b as Ii}from"./chunk-37H4LYIE.js";import"./chunk-HUYHDVA2.js";import{a as ba}from"./chunk-4QS7PGAF.js";import{a as Di}from"./chunk-NIYDRLW4.js";import{a as Me}from"./chunk-XHOTVM3O.js";import{b as ya,g as xu}from"./chunk-H3VY6XFU.js";import"./chunk-LNYBTIG7.js";import"./chunk-HSRIUK76.js";import"./chunk-XSGDUFLB.js";import{a as ou,b as ma}from"./chunk-4VRL7OJD.js";import"./chunk-DYBVQO6C.js";import"./chunk-BRJSO7CG.js";import"./chunk-AATZFFI5.js";import{a as ln}from"./chunk-GT3C7LC6.js";import{b as $d}from"./chunk-EWHTP5EW.js";import"./chunk-H63LVRK7.js";import"./chunk-3GCOAQPV.js";import{k as bc}from"./chunk-6NTJ4HVA.js";import"./chunk-X2KAPCU7.js";import{d as ua,e as jd}from"./chunk-JD3KGBGX.js";import"./chunk-GC4LGG7K.js";import"./chunk-VXW5JMKD.js";import"./chunk-NJ5QXHI6.js";import{F as Ye,i as hu,j as pu,l as vt,n as du,p as uu,q as fa,s as mu,u as vc,v as xc,x as fu}from"./chunk-SJTQM4NH.js";import"./chunk-AODEXMIK.js";import"./chunk-NYOCZ43I.js";import"./chunk-IFFYADB3.js";import{b as iu,c as su}from"./chunk-CBIYPMNC.js";import"./chunk-LHY2TOIB.js";import{b as tu,d as ru}from"./chunk-F4UISFW6.js";import{a as eu,c as gc}from"./chunk-TXAFMDDV.js";import"./chunk-ZCSEBPCJ.js";import{i as _c}from"./chunk-S3JJYXYO.js";import"./chunk-LOEAA5XF.js";import{a as yc}from"./chunk-R2Q5NMSG.js";import"./chunk-QL456MD5.js";import"./chunk-IY6MAS3P.js";import{f as Xd,g as Kd,i as Ho,p as ko,q as Wo,s as fc,y as au}from"./chunk-RPWH7ONJ.js";import{a as jo,b as Jd}from"./chunk-H76XKIVW.js";import"./chunk-UWZJQ7YC.js";import{n as Qd}from"./chunk-NC2NFLV7.js";import{a as re}from"./chunk-UJ6V7JUK.js";import{a as Kr,b as Td}from"./chunk-Z5FRAQHK.js";import{a as Ld,b as Id}from"./chunk-LQWMDYLF.js";import"./chunk-BW3UVZYU.js";import{a as Bo}from"./chunk-47Q3ZDMA.js";import{b as Fd}from"./chunk-XRRPDCIR.js";import{d as Ud}from"./chunk-XF4ZC6Y7.js";import"./chunk-D6QUKPEY.js";import"./chunk-VIAVLHRB.js";import"./chunk-UMZZ3I5D.js";import"./chunk-LSEOQ2KR.js";import"./chunk-VXJKEPDS.js";import"./chunk-J7IKN4ZN.js";import"./chunk-I3S324BU.js";import"./chunk-OM7Z3UKX.js";import"./chunk-6KRFVLII.js";import{a as Qr,b as sc,c as Xe,d as Ai,e as ac}from"./chunk-OJB2TSJ7.js";import"./chunk-MCO7DSFO.js";import"./chunk-LUPAMFKK.js";import"./chunk-7JD62GP7.js";import"./chunk-F47ZTJ7Y.js";import{a as hd}from"./chunk-YXPGI3LI.js";import"./chunk-LSFTWXAE.js";import"./chunk-2EF3JPLL.js";import"./chunk-FWB3IYJJ.js";import"./chunk-U6WVZEYH.js";import"./chunk-KRMYHUR3.js";import{C as wo,D as Xp,F as Kp,a as K,b as qp,d as Ar,e as $p,f as Tr,g as Ge,i as Yp,m as Zp,n as $e,o as na,p as us,q as ze,r as Eo,u as Qp,v as Jp,w as Ro,x as F,y as ms,z as Oo}from"./chunk-R4NNYEN7.js";import{a as W,b as ca,c as B,d as _d,e as Io,f as bd,g as vd}from"./chunk-PDBA6QOJ.js";import{a as Fo,d as Od,e as wd,o as ha}from"./chunk-CF52RSJZ.js";import{a as V,b as Ad,d as Li}from"./chunk-ALWV3RJ2.js";import{a as Ti}from"./chunk-7C6Z24SS.js";import{a as rc,r as Ao,v as ld}from"./chunk-7G4KK3KW.js";import"./chunk-J3ZDC5ZE.js";import{e as nd,j as Ue}from"./chunk-KYNKUTEO.js";import"./chunk-QWLQUMDY.js";import{a as To,b as ve,c as la,d as dd,g as er,k as ud,n as Lo,o as fs,r as md}from"./chunk-2ETHV3H2.js";import{a as De,b as fo,c as Cp,d as go,f as yo,g as Pp,h as _o}from"./chunk-4XUOIGFO.js";import"./chunk-5HCLBNUR.js";import{d as od}from"./chunk-OMYJOG47.js";import"./chunk-3B4QONMA.js";import"./chunk-3SZQ2UT4.js";import"./chunk-SPDSGGOE.js";import"./chunk-2OKSPLJT.js";import"./chunk-7LEG2VDW.js";import"./chunk-R2HWUZ3L.js";import"./chunk-G24ZJINL.js";import"./chunk-T25YY3N7.js";import"./chunk-ALQ3STGG.js";import{a as Qo,b as Eu}from"./chunk-EETFV2SL.js";import{a as be,b as aa,g as Oi}from"./chunk-AM3VOA32.js";import"./chunk-SAOUSUZE.js";import"./chunk-LECQV7I4.js";import"./chunk-7HZKOXPR.js";import"./chunk-DFTBSFIN.js";import"./chunk-4HISZWR4.js";import"./chunk-33BSK37G.js";import"./chunk-TQAPQODA.js";import{a as Yr,b as ad,c as ye,e as Zr,f as jt}from"./chunk-M2GLXRA2.js";import{a as $r,c as jp,e as Hp,f as wr,g as _t,h as Co,i as kp,n as Po,p as Wp,s as oa}from"./chunk-EBWCXIFH.js";import{p as ds}from"./chunk-MRVR6F6G.js";import{g as Ap,h as Tp,k as Lp}from"./chunk-WXQQZY3K.js";import{a as Ne,b as sa,f as Fp,g as Bp,i as Np,l as xo,m as zp,q as tc,t as So}from"./chunk-VPMDQK57.js";import{a as wp}from"./chunk-BCREO4Q5.js";import{b as id,d as sd}from"./chunk-ZVHU7VE3.js";import{b as Ri,d as Kl,f as Up,h as vo,i as ec}from"./chunk-76YVRX2R.js";import{C as Mp,D as Vp,E as Xl,a as Kt,b as te,c as A,d as le,e as de,f as Gp,l as k,m as ps,n as ia,q as Ei,s as J,t as z,u as qe,w as X,x as Jl}from"./chunk-OZF6BMOL.js";import{a as _,c as Je,d as Tt,e as hs,f as Or}from"./chunk-GJP6PTKT.js";import{a as Ip,c as Dp}from"./chunk-RSDQHAJX.js";import"./chunk-HMKFQDR7.js";import"./chunk-2OT2C2UU.js";import"./chunk-XIMCHX2H.js";import{b as Sp}from"./chunk-SF6Z2K5H.js";import{a as Xt}from"./chunk-GBTN5LIS.js";import{a as mo,c as ra,e as xp}from"./chunk-JOSG37QF.js";import"./chunk-SLMQFZE3.js";import"./chunk-FJDNRF2P.js";import"./chunk-VNB5ZT3P.js";import"./chunk-NDG5FXLR.js";import"./chunk-EJG3F6VR.js";import"./chunk-5ODCEDHC.js";import"./chunk-BENVXA3L.js";import{e as Rp,l as Op,v as cs}from"./chunk-SA4OMQAD.js";import{b as Ql}from"./chunk-24BLFS5R.js";import{I as Pi,ba as bo,da as Ep,l as Rr,u as Zl}from"./chunk-JDDD6VJ4.js";import"./chunk-VOYK3LZF.js";import"./chunk-HOJTYTYD.js";import"./chunk-XNEAL2YW.js";import"./chunk-J7M5V2SQ.js";import"./chunk-RQD6EDD6.js";import{A as vp}from"./chunk-XPCG2OJX.js";import{F as yp,L as v,O as Ae,r as gp}from"./chunk-AUTL5LCV.js";import{S as ie,k as dp,r as _p,s as bp}from"./chunk-KUJG22IX.js";import"./chunk-OVHPPCBL.js";import{a as u}from"./chunk-W3WDPWBE.js";import{C as Yl,a as At,k as ee,m as po,n as $l,q as up,s as qr,t as uo,z as mp}from"./chunk-GISCFF3Z.js";import{b as ge,c as ls,d as Ci,e as Ks,f as ea}from"./chunk-MLSR6YE6.js";import{b as fp}from"./chunk-SNFOAZZQ.js";import{a as ta}from"./chunk-CPDJJRWA.js";import"./chunk-VU5W7W6Y.js";import{b as ns,n as hp,q as pp,r as Q,t as _e}from"./chunk-HQMV3KQV.js";import{G as Er,a as Ve,c as ho,d as op,e as np,f as Xs,p as ql,q as Pr,r as lp,s as cp}from"./chunk-CRMMDK2Z.js";import{a as Z,b as Pe,g as ap,h as O}from"./chunk-EAH6BNBL.js";var Ym=r=>{let e=class extends r{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),em(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}_validateHeightModelInfo(){return O(this,null,function*(){let t=new AbortController,i=t.signal;this.addHandles(At(()=>t.abort())),yield go(()=>this.view.defaultsFromMap?.heightModelInfoReady,i),ee(i);let s=Ku(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(s)throw s})}};return u([v()],e.prototype,"view",void 0),u([v()],e.prototype,"slicePlaneEnabled",void 0),e=u([ie("esri.views.3d.layers.LayerView3D")],e),e};function Zm(r,e,t,i,s){return O(this,null,function*(){let{elevationProvider:a,renderCoordsHelper:o}=r,{elevationInfo:n}=e,{pointsInFeatures:l,spatialReference:c}=i,h=Ql.fromJSON(c),p=Pa(n,!0),d=yield Ca(p,h,s);ee(s);let f=[],m=new Set,y=new Set,b=new Vr,S=Di(0,0,0,Ql.WGS84),x=new lr,w=_();S.spatialReference=h;let E=r.elevationProvider.spatialReference??r.spatialReference;for(let{objectId:C,points:P}of l){let T=t(C);if(T==null){for(let I of P)f.push(I.z??0);m.add(C);continue}T.isDraped&&y.add(C);let D=T.graphic.geometry;b.setFromElevationInfo(Ou(D,n)),b.updateFeatureExpressionInfoContext(d,T.graphic,e);for(let{x:I,y:G,z:ne}of P)S.x=I,S.y=G,S.z=ne??0,yield Td(S,w,E,0,{signal:s}),Ct(w,a,b,o,x),f.push(x.z)}return{elevations:f,drapedObjectIds:y,failedObjectIds:m}})}function un(r,e){if(!r||r.symbol)return null;let t=e?.renderer;return r&&t!=null&&t.getObservationRenderer?t.getObservationRenderer(r):t}function dy(r,e){if(r.symbol!=null)return r.symbol;let t=un(r,e);return t!=null&&t.type!=="dot-density"?t.getSymbol(r,e):null}function Qm(r,e){let t=un(r,e),i=dy(r,e);if(i==null)return null;let s={renderer:t,symbol:i};if(t==null||!("visualVariables"in t)||!t.visualVariables)return s;let a=_c(t,r,e)??[],o=["proportional","proportional","proportional"];for(let{variable:n,value:l}of a)switch(n.type){case"color":s.color=l.toRgba();break;case"size":if(n.target==="outline")s.outlineSize=l;else{let c=n.axis,h=n.useSymbolValue?"symbol-value":l;switch(c){case"width":o[0]=h;break;case"depth":o[1]=h;break;case"height":o[2]=h;break;case"width-and-depth":o[0]=o[1]=h;break;default:o[0]=o[1]=o[2]=h}}break;case"opacity":s.opacity=l;break;case"rotation":switch(n.axis){case"tilt":s.tilt=l;break;case"roll":s.roll=l;break;default:s.heading=l}}return o[0]==="proportional"&&o[1]==="proportional"&&o[2]==="proportional"||(s.size=o),s}function uy(r,e){return O(this,null,function*(){if(r.symbol!=null)return r.symbol;let t=un(r,e);return t!=null?t.getSymbolAsync(r,e):null})}function Jm(r,e){return O(this,null,function*(){let t=un(r,e),i=yield uy(r,e);if(!i)return null;let s={renderer:t,symbol:i};if(!t||!("visualVariables"in t)||!t.visualVariables)return s;let a=_c(t,r,e)??[],o=["proportional","proportional","proportional"];for(let{variable:n,value:l}of a)if(n.type==="color")s.color=re.toUnitRGBA(l);else if(n.type==="size")if(n.target==="outline")s.outlineSize=l;else{let c=n.axis,h=n.useSymbolValue?"symbol-value":l;c==="width"?o[0]=h:c==="depth"?o[1]=h:c==="height"?o[2]=h:o[0]=o[1]=c==="width-and-depth"?h:o[2]=h}else n.type==="opacity"?s.opacity=l:n.type==="rotation"&&n.axis==="tilt"?s.tilt=l:n.type==="rotation"&&n.axis==="roll"?s.roll=l:n.type==="rotation"&&(s.heading=l);return(isFinite(o[0])||isFinite(o[1])||isFinite(o[2]))&&(s.size=o),s})}function Xm(r,e=0){let t=r[e];return typeof t=="number"&&isFinite(t)?t:null}function Km(r){for(let e=0;e<3;e++){let t=r[e];if(typeof t=="number")return isFinite(t)?t:0}return 0}var ef=1.2,tf=Zr;var As=class{constructor(e,t=null){this.geometry=e,this.textures=t}},Ts=class{constructor(e,t,i){this.components=e,this.minScreenSpaceRadius=t,this.pivotOffset=i;let s=this.geometries;this.numVertices=s.reduce((a,o)=>a+o.attributes.get(g.POSITION).indices.length,0)}get geometries(){return Xs(this.components.map(e=>e.geometry))}},Ls=class{constructor(e){this.levels=e,this.levels.sort((t,i)=>t.minScreenSpaceRadius===i.minScreenSpaceRadius?t.numVertices-i.numVertices:t.minScreenSpaceRadius-i.minScreenSpaceRadius)}};function Ra(r){let e=[];return r.levels.forEach(t=>t.components.forEach(i=>e.push(i.geometry.material))),Xs(e)}function Uc(r){let e=new Array;return r.levels.forEach(t=>t.components.forEach(i=>{i.textures!=null&&e.push(...i.textures)})),Xs(e)}function Fc(r){let e=new Array;return r.levels.forEach(t=>t.components.forEach(i=>e.push(i.geometry))),Xs(e)}function rf(r){switch(r){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function mn(r,e){let t=(i,s,a=!1)=>new Ls(i.map(o=>{let n=s(o.tesselation);return a&&Rm(n),new Ts([new As(n)],o.minScreenSpaceRadius)}));switch(r){case"sphere":return t([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],i=>Pm(e,.5,i,!0));case"cube":return t([{tesselation:0,minScreenSpaceRadius:0}],()=>xm(e,1));case"cone":return t(Bc,i=>Lc(e,1,.5,i,!1),!0);case"inverted-cone":return t(Bc,i=>Lc(e,1,.5,i,!0),!0);case"cylinder":return t(Bc,i=>Em(e,1,.5,i,[0,0,1],[0,0,.5]));case"tetrahedron":return t([{tesselation:0,minScreenSpaceRadius:0}],()=>Cm(e,1),!0);case"diamond":return t([{tesselation:0,minScreenSpaceRadius:0}],()=>Sm(e,1),!0);default:return}}var Bc=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];var ke=class{constructor(e){this.estimated=!1,this.verticesPerFeature=e.verticesPerFeature??0,this.verticesPerCoordinate=e.verticesPerCoordinate??0,this.drawCallsPerFeature=e.drawCallsPerFeature??0,this.memory=e.memory??new Oa}},Is=class extends ke{constructor(e){super(e),this.estimated=!0}},fn=class extends ke{constructor(e,t){super(t),this.numComplexities=e}},gn=class extends Is{constructor(e,t){super(t),this.numComplexities=e}},Oa=class{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}};var Hc=new Is({});function sf(r){return r.type==="web-style"?Hc:_n(r.symbolLayers.toArray().map(e=>kc(r,e)))}function _n(r){let e=0,t=0,i=0,s=!1,a=0,o=new Oa;for(let n of r)n!=null&&(e+=n.verticesPerFeature,t+=n.verticesPerCoordinate,i+=n.drawCallsPerFeature,o.bytesPerFeature+=n.memory.bytesPerFeature,o.bytesPerFeatureLabel+=n.memory.bytesPerFeatureLabel,o.resourceBytes+=n.memory.resourceBytes,o.draped.bytesPerFeature+=n.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=n.memory.bytesPerFeatureLabel,s=s||n.estimated,++a);return s?new gn(a,{verticesPerFeature:e,verticesPerCoordinate:t,drawCallsPerFeature:i,memory:o}):new fn(a,{verticesPerFeature:e,verticesPerCoordinate:t,drawCallsPerFeature:i,memory:o})}function af(r){let e=_n(r);return e.numComplexities>0&&(e.verticesPerFeature/=e.numComplexities,e.verticesPerCoordinate/=e.numComplexities,e.drawCallsPerFeature/=e.numComplexities,e.memory.bytesPerFeature/=e.numComplexities,e.memory.bytesPerFeatureLabel/=e.numComplexities,e.memory.resourceBytes/=e.numComplexities,e.memory.draped.bytesPerFeature/=e.numComplexities,e.memory.draped.bytesPerFeatureLabel/=e.numComplexities),e}var Nc={};function kc(r,e){let t=Wc(r,e),i=Pu(e)?2:0;switch(e.type){case"extrude":return new ke({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:i,memory:t});case"fill":if(r.type==="mesh-3d")return new ke({drawCallsPerFeature:i,memory:t});if(e.outline!=null&&e.outline.size>0)return new ke({verticesPerFeature:-12,verticesPerCoordinate:9,memory:t});case"water":return new ke({verticesPerFeature:-6,verticesPerCoordinate:3,memory:t});case"line":return new ke({verticesPerFeature:-6,verticesPerCoordinate:6,memory:t});case"object":return e.resource?.href?new Is({verticesPerFeature:100,memory:t}):Pe(Z({},fy(e.resource?.primitive??Ho)),{memory:t});case"path":{let s=0,a=0;switch(e.profile){case"circle":s=10;break;case"quad":s=4;break;default:return void(e.profile,void 0)}switch(e.join){case"round":a=3;break;case"miter":case"bevel":a=1;break;default:return}let o=2*s,n=s*a*2,l=n+o,c=-2*n-o;switch(e.cap){case"none":break;case"butt":case"square":c+=2*(s-1);break;case"round":c+=2*(s*2*2+s);break;default:return}return new ke({verticesPerFeature:c,verticesPerCoordinate:l,memory:t})}case"text":case"icon":return new ke({verticesPerFeature:6,memory:t});default:return}}function Wc(r,e){let t=r.type==="point-3d";switch(e.type){case"extrude":return e.edges&&e.edges.size>0?rt.EXTRUDE_EDGES:rt.EXTRUDE;case"fill":return e.outline!=null&&e.outline.size>0?rt.FILL_OUTLINE:rt.FILL;case"water":return rt.FILL;case"line":return e.join==="round"?rt.LINE_ROUND:rt.LINE_MITER;case"path":switch(e.join){case"round":switch(e.profile){case"circle":return rt.PATH_ROUND_CIRCLE;case"quad":return rt.PATH_ROUND_QUAD;default:return void(e.profile,void 0)}case"miter":case"bevel":switch(e.profile){case"circle":return rt.PATH_MITER_CIRCLE;case"quad":return rt.PATH_MITER_QUAD;default:return void(e.profile,void 0)}default:return}case"object":return t?rt.OBJECT_POINT:rt.OBJECT_POLYGON;case"icon":case"text":return t?rt.ICON_POINT:rt.ICON_POLYGON;default:return}}function fy(r){let e=Nc[r];if(e)return e;let t=qc(mn(r,new St({})).levels);return Nc[r]=new ke({verticesPerFeature:t}),Nc[r]}function qc(r){return r.reduce((e,t,i)=>e+t.numVertices*(1/10**i),0)/r.reduce((e,t,i)=>e+1/10**i,0)}var rt={ICON_POINT:{bytesPerFeature:2379.8272296852992,bytesPerFeatureLabel:852.246235,resourceBytes:0,draped:{bytesPerFeature:1868.2382921559424,bytesPerFeatureLabel:839.205415}},ICON_POLYGON:{bytesPerFeature:2957.8429876524656,bytesPerFeatureLabel:862.5307816666666,resourceBytes:0,draped:{bytesPerFeature:2579.7767085451133,bytesPerFeatureLabel:856.9298550000001}},OBJECT_POINT:{bytesPerFeature:603.543820573039,bytesPerFeatureLabel:717.4551849999999,resourceBytes:0,draped:{bytesPerFeature:603.543820573039,bytesPerFeatureLabel:717.4551849999999}},OBJECT_POLYGON:{bytesPerFeature:1111.1693389308373,bytesPerFeatureLabel:707.4535949999998,resourceBytes:0,draped:{bytesPerFeature:1111.1693389308373,bytesPerFeatureLabel:707.4535949999998}},LINE_MITER:{bytesPerFeature:3081.208408220661,bytesPerFeatureLabel:858.6749016666668,resourceBytes:0,draped:{bytesPerFeature:2682.57863388475,bytesPerFeatureLabel:844.6118016666666}},LINE_ROUND:{bytesPerFeature:3209.3236242927915,bytesPerFeatureLabel:858.1810416666667,resourceBytes:0,draped:{bytesPerFeature:2687.6256038096126,bytesPerFeatureLabel:849.578535}},PATH_MITER_CIRCLE:{bytesPerFeature:38708.74276663992,bytesPerFeatureLabel:858.70415,resourceBytes:0,draped:{bytesPerFeature:38708.74276663992,bytesPerFeatureLabel:858.70415}},PATH_ROUND_CIRCLE:{bytesPerFeature:42098.00590216518,bytesPerFeatureLabel:868.3632500000001,resourceBytes:0,draped:{bytesPerFeature:42098.00590216518,bytesPerFeatureLabel:868.3632500000001}},PATH_MITER_QUAD:{bytesPerFeature:25037.823002405767,bytesPerFeatureLabel:835.93355,resourceBytes:0,draped:{bytesPerFeature:25037.823002405767,bytesPerFeatureLabel:835.93355}},PATH_ROUND_QUAD:{bytesPerFeature:40320.254760224525,bytesPerFeatureLabel:851.66955,resourceBytes:0,draped:{bytesPerFeature:40320.254760224525,bytesPerFeatureLabel:851.66955}},FILL:{bytesPerFeature:3147.43349219103,bytesPerFeatureLabel:850.7598550000001,resourceBytes:0,draped:{bytesPerFeature:2673.7898488975106,bytesPerFeatureLabel:846.6459950000002}},FILL_OUTLINE:{bytesPerFeature:4565.099993465867,bytesPerFeatureLabel:855.334515,resourceBytes:0,draped:{bytesPerFeature:3904.46969705314,bytesPerFeatureLabel:844.7081016666667}},EXTRUDE:{bytesPerFeature:7551.2282834569505,bytesPerFeatureLabel:849.5513283333333,resourceBytes:0,draped:{bytesPerFeature:7551.2282834569505,bytesPerFeatureLabel:849.5513283333333}},EXTRUDE_EDGES:{bytesPerFeature:2959.8379634500698,bytesPerFeatureLabel:602.0969283333335,resourceBytes:0,draped:{bytesPerFeature:2959.8379634500698,bytesPerFeatureLabel:602.0969283333335}}};var bn=class{constructor(e,t,i){this.maximumTotalNumberOfVertices=e,this.maximumNumberOfFeatures=t,this.averageSymbolComplexity=i}};var vn=class{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,i){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}queryElevation(e,t,i,s,a){return O(this,null,function*(){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,a,i,s)})}};var Le,we;(function(r){r[r.USER=1]="USER",r[r.SCALE_RANGE=2]="SCALE_RANGE",r[r.FILTER=4]="FILTER",r[r.DECONFLICTION=8]="DECONFLICTION",r[r.ALL_GRAPHIC=15]="ALL_GRAPHIC",r[r.ALL_LABEL=255]="ALL_LABEL"})(Le||(Le={})),function(r){r[r.GRAPHIC=1]="GRAPHIC",r[r.LABEL=16]="LABEL"}(we||(we={}));var of=K(),$t=class extends Ae{constructor(r){super(r),this.events=new Xt,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(e,t)=>"graphic"in e?e.graphic.attributes[t]:wi.getAttribute(e,t),getAttributes:e=>"graphic"in e?e.graphic.attributes:wi.getAttributes(e),getObjectId:e=>"graphic"in e?rr(e.graphic,this.objectIdField)??void 0:wi.getObjectId(e),getGeometry:e=>"graphic"in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):wi.getGeometry(e),getCentroid:(e,t)=>{if("graphic"in e){let i=null;e.centroid!=null?i=e.centroid:e.graphic.geometry.type==="point"&&ld(e.graphic.geometry,nf,this.viewSpatialReference)&&(i=nf);let s=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return i==null?(s[0]=0,s[1]=0,s[2]=0,s[3]=0):(s[0]=i.x,s[1]=i.y,t.hasZ&&(s[2]=i.hasZ?i.z:0),t.hasM&&(s[t.hasZ?3:2]=i.hasM?i.m:0)),new ed([],s)}return wi.getCentroid(e,t)},cloneWithGeometry:(e,t)=>"graphic"in e?new td(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):wi.cloneWithGeometry(e,t)}}forEachInBounds(r,e){this.getSpatialIndex().forEachInBounds(r,e)}forEachBounds(r,e){let t=this.getSpatialIndex();for(let i of r){let s=this.featureAdapter.getObjectId(i);t.getBounds(s,of)!=null&&e(of)}}};u([v({constructOnly:!0})],$t.prototype,"getSpatialIndex",void 0),u([v({constructOnly:!0})],$t.prototype,"forEach",void 0),u([v({constructOnly:!0})],$t.prototype,"hasZ",void 0),u([v({constructOnly:!0})],$t.prototype,"hasM",void 0),u([v({constructOnly:!0})],$t.prototype,"objectIdField",void 0),u([v({constructOnly:!0})],$t.prototype,"viewSpatialReference",void 0),u([v({constructOnly:!0})],$t.prototype,"featureSpatialReference",void 0),$t=u([ie("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],$t);var nf={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};var wa=class{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}};var xn=class{constructor(e,t){this.scheduler=e,this.schedule=t,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}},Sn=class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};function Aa(r){return r.mapPositions!=null}function Cn(r,e,t,i,s){let a=r.stageObject,o=a.geometries,n=0;for(let l of o){if(!Aa(l))continue;let{update:c,averageGeometrySampledElevation:h}=pf(l,e,t,i,s);n+=h,c&&a.geometryVertexAttributeUpdated(l,g.POSITION)}return n/o.length}function Ft(r,e,t,i,s,a){let o=r.stageObject,n=e.centerPointInElevationSR,l=0;o.usesVerticalDistanceToGround?(i(n,st),Am(o,st.verticalDistanceToGround),l=st.sampledElevation):(i(n,st),e.mode!=="absolute-height"&&(l=st.sampledElevation));let c=$r(gy,a??o.transformation),h=A(hf,c[12],c[13],c[14]);Te.TESTS_DISABLE_OPTIMIZATIONS?(it[0]=n.x,it[1]=n.y,it[2]=st.z,bt(n.spatialReference,it,c,s.spatialReference)&&(a?$r(a,c):o.transformation=c)):s.setAltitudeOfTransformation(st.z,c);let p=$c/s.unitInMeters;return(Math.abs(c[12]-h[0])>=p||Math.abs(c[13]-h[1])>=p||Math.abs(c[14]-h[2])>=p)&&(a?$r(a,c):o.transformation=c),l}var gy=V();function lf(r,e,t,i,s){let a=r.graphics3DSymbolLayer.lodRenderer;if(a==null)return 0;let o=e.centerPointInElevationSR;i(o,st);let n=e.mode!=="absolute-height"?st.sampledElevation:0,l=a.instanceData,c=r.instanceIndex,h=yy;l.getGlobalTransform(c,h);let p=A(hf,h[12],h[13],h[14]);Te.TESTS_DISABLE_OPTIMIZATIONS?(it[0]=o.x,it[1]=o.y,it[2]=st.z,bt(o.spatialReference,it,h,s.spatialReference)&&l.setGlobalTransform(c,h)):s.setAltitudeOfTransformation(st.z,h);let d=$c/s.unitInMeters;return(Te.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(h[12]-p[0])>=d||Math.abs(h[13]-p[1])>=d||Math.abs(h[14]-p[2])>=d)&&l.setGlobalTransform(c,h),n}function cf(r,e,t,i,s){let a=r.stageObject,o=a.geometries;if(o.length===0)return 0;let n=0,l=null,c=0,h=!1;for(let p of o){if(!Aa(p))continue;let d=p.attributes.get(g.POSITION);if(d!==l){let{update:f,averageGeometrySampledElevation:m}=pf(p,e,t,i,s);c=m,l=d,h=f}h&&a.geometryVertexAttributeUpdated(p,g.POSITION),n+=c}return n/o.length}var $c=.01,it=_(),Ut=_(),Ds=_(),yy=V(),hf=_(),st=new lr;function pf(r,e,t,i,s){let a=!1,o=r.transformation,n=e.requiresSampledElevationInfo;Ut[0]=o[12],Ut[1]=o[13],Ut[2]=o[14],r.invalidateBoundingInfo();let l=r.getMutableAttribute(g.POSITION),c=l.data,h=l.size,p=c.length/h,d=new Es(r.mapPositions,t),f=0,m=0;for(let y=0;y<p;y++){if(Ds[0]=c[f],Ds[1]=c[f+1],Ds[2]=c[f+2],i(d,st),n&&(m+=st.sampledElevation),Te.TESTS_DISABLE_OPTIMIZATIONS)c[f]=d.array[d.offset],c[f+1]=d.array[d.offset+1],c[f+2]=st.z,Ue(c,t,f,c,s.spatialReference,f,1),c[f]-=Ut[0],c[f+1]-=Ut[1],c[f+2]-=Ut[2],a=!0;else{it[0]=c[f]+Ut[0],it[1]=c[f+1]+Ut[1],it[2]=c[f+2]+Ut[2],s.setAltitude(it,st.z),c[f]=it[0]-Ut[0],c[f+1]=it[1]-Ut[1],c[f+2]=it[2]-Ut[2];let b=$c/s.unitInMeters;(Math.abs(Ds[0]-c[f])>=b||Math.abs(Ds[1]-c[f+1])>=b||Math.abs(Ds[2]-c[f+2])>=b)&&(a=!0)}f+=h,d.offset+=3}return m/=p,{update:a,averageGeometrySampledElevation:m}}var Pn=class{constructor(e,t,i){this.baseMaterial=e,this.edgeMaterials=t,this.properties=i}},xe=class{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,i,s,a,o,n,l=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=i,this._uniqueMaterials=s,this._sharedResource=a,this.elevationAligner=o,this.elevationContext=n,this._edgeState=l,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e;let t=e.stage;t.addMany(this._uniqueMaterials),t.addMany(this._uniqueGeometries),t.add(this.stageObject)}destroy(){if(!this._stageLayer)return;let e=this._stageLayer.stage;e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),e.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}layerOpacityChanged(e,t){let{stageObject:i,_edgeState:s,_stageLayer:a}=this;if(s==null)return;let o=df(s.baseMaterial),n=!1;for(let l of s.edgeMaterials)l.objectTransparency!==o&&(l.objectTransparency=o,n=!0);n&&this.resetEdgeObject(t),a.stage.renderer.withEdgeView(l=>{l.updateAllComponentOpacities(i,[e])})}slicePlaneEnabledChanged(e,t){let{stageObject:i,_edgeState:s,_stageLayer:a}=this;s!=null&&a.stage.renderer.withEdgeView(o=>{o.updateAllComponentMaterials(i,s.edgeMaterials,{hasSlicePlane:e},!t),s.properties.hasSlicePlane=e})}setVisibility(e){let{_edgeState:t,stageObject:i,_stageLayer:s}=this;s!=null&&this.visible!==e&&(this._visible=e,i.visible=e,e&&!this._addedToStage&&(s.add(i),this._addedToStage=!0),t!=null&&s.stage.renderer.withEdgeView(a=>{a.hasObject(i)?a.updateObjectVisibility(i,e):e&&this._addOrUpdateEdgeObject(t,a,!1)}))}get visible(){return this._visible}alignWithElevation(e,t,i,s){if(this.elevationAligner==null)return;i!=null&&Rs(this.elevationContext.featureExpressionInfoContext,i);let a=(o,n)=>Ct(o,e,this.elevationContext,t,n);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,a,t),this.resetEdgeObject(s)}alignWithAbsoluteElevation(e,t,i){let s=(a,o)=>{o.sampledElevation=e,o.verticalDistanceToGround=0,o.z=e};this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,s,t),this.resetEdgeObject(i)}getCenterObjectSpace(e=_()){return te(e,this.stageObject.boundingVolumeObjectSpace.bounds)}getBoundingBoxObjectSpace(e=K()){let t=this.stageObject.boundingVolumeObjectSpace;return Qp(e,t.min),Jp(e,t.max),e}computeAttachmentOrigin(e){let t=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;else for(let i of this.stageObject.geometries)i.computeAttachmentOrigin(Fr)&&(X(Fr,Fr,t),le(e.render.origin,e.render.origin,Fr),e.render.num++)}getProjectedBoundingBox(e,t,i,s,a){return O(this,null,function*(){let o=this.getBoundingBoxObjectSpace(a),n=by,l=wo(o)?1:n.length;for(let h=0;h<l;h++){let p=n[h];pi[0]=o[p[0]],pi[1]=o[p[1]],pi[2]=o[p[2]],X(pi,pi,this.stageObject.transformation),zi[3*h]=pi[0],zi[3*h+1]=pi[1],zi[3*h+2]=pi[2]}if(!e(zi,0,l))return null;F(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],zi[h+p]),o[p+3]=Math.max(o[p+3],zi[h+p]);c&&i.push({location:zi.slice(h,h+3),screenSpaceBoundingRect:c})}if(t?.service&&this.elevationContext.mode!=="absolute-height"){$e(o,Fr);let h=this.elevationContext.mode==="relative-to-scene"?"scene":"ground",p=0;if(t.useViewElevation)p=t.service.getElevation(Fr[0],Fr[1],h)??0;else try{let d=ws(o,t.service.spatialReference,t);p=(yield t.service.queryElevation(Fr[0],Fr[1],s,d,h))??0}catch{}Eo(o,0,0,-this.alignedSampledElevation+p)}return o})}addObjectState(e,t){e===ct.Highlight&&t.addObject(this.stageObject,this.stageObject.highlight()),e===ct.MaskOccludee&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(e){let{_edgeState:t,stageObject:i,_stageLayer:s,_visible:a}=this;t!=null&&s.stage.renderer.withEdgeView(o=>{a?this._addOrUpdateEdgeObject(t,o,e):o.removeObject(i)})}_addOrUpdateEdgeObject(e,t,i){let s=df(e.baseMaterial);for(let a of e.edgeMaterials)a.objectTransparency=s;t.addOrUpdateObject3D(this.stageObject,e.edgeMaterials,e.properties,!i).then(()=>this._stageLayer?.sync())}};function df(r){return r.isVisible()?r.parameters.transparent?qo.TRANSPARENT:qo.OPAQUE:qo.INVISIBLE}var zi=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pi=_(),Fr=_(),by=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];var Gs=class{constructor(e,t=null){this.labelText=t,this.elevationOffset=e??0}};var N;(function(r){r[r.RecreateSymbol=0]="RecreateSymbol",r[r.RecreateGraphics=1]="RecreateGraphics",r[r.FastUpdate=2]="FastUpdate"})(N||(N={}));var di=class{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=We.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return this._loadStatus===We.LOADED?(e&&e(),this._loader??Promise.resolve()):this._loadStatus===We.FAILED?(t&&t(this._loadError),this._loader??Promise.resolve()):(this._loader==null&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=We.LOADED},i=>{throw this._loadError=i,this._abortController=null,this._loadStatus=We.FAILED,!qr(i)&&this.logger&&i.message&&this.logger.warn(i.message),i})),this._loader.then(e,t).catch(()=>{}),this._loader)}abortLoad(){this._abortController!=null?this._abortController=Ks(this._abortController):this._loadStatus===We.LOADING&&(this._loadStatus=We.FAILED),this._loader=null}},We;(function(r){r[r.LOADING=0]="LOADING",r[r.LOADED=1]="LOADED",r[r.FAILED=2]="FAILED"})(We||(We={}));var ui=()=>Q.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer"),Se=class extends di{constructor(e,t,i,s){super(i.schedule),this.symbol=e,this.symbolLayer=t,this._context=i,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this._materials=[],this.usedMemory=0,this.logger=ui(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new Vr,this.complexity=this.computeComplexity(),this.ignoreDrivers=s.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=uf(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;let t=this._drivenProperties,i=uf(e);return i.color!==t.color||i.opacity!==t.opacity||i.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||i.size!==t.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,i,s){let a=e.projectionSuccess,o="polygons"in e?e.polygons:null,n=`${s} geometry failed to be created`;a?!this._logGeometryValidationWarnings(t,i,s)&&o&&o.length===0&&i==="rings"&&t.length>0&&t[0].length>2&&ui().warnOncePerTick(`${n} (filled rings should use clockwise winding - try reversing the order of vertices)`):ui().warnOncePerTick(`${n} (failed to project geometry to view spatial reference)`)}_logGeometryValidationWarnings(e,t,i){let s=`${i} geometry failed to be created`;return!e.length||e.length===1&&!e[0].length?(ui().warnOncePerTick(`${s} (no ${t} were defined)`),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(ui().warnOncePerTick(`${s} (${t} should be defined as a 2D array)`),!0)}_validateGeometry(e,t=null,i=null){if(t!=null&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1;switch(e.type){case"point":{let s=e;if(!isFinite(s.x)||!isFinite(s.y))return ui().warn("point coordinate is not a valid number, graphic skipped"),!1;break}case"polygon":Lp(e)&&ui().warnOncePerTick("Fixed a non-closed polygon ring.")}return!0}_defaultElevationInfoNoZ(){return vy}_defaultElevationInfoZ(){return xy}_updateElevationContext(){this._elevationInfoOverride!=null?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t=new Vr){let i=e.geometry,s=this.getDefaultElevationInfo(i);t.unit=this._elevationContext.unit!=null?this._elevationContext.unit:s.unit,t.mode=this.getGeometryElevationMode(i,s),t.offsetMeters=this._elevationContext.meterUnitOffset??s.offset??0;let a=!this._elevationOptions.supportsOnTheGround&&t.mode==="on-the-ground";a&&(t.mode="relative-to-ground",t.offsetMeters=0);let o=a?Lm:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(o,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}updateTransform(e,t,i,s){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,t=mf){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(e!=null?i*=e.a:t.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e,t=mf){let i=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return ci(null,i);let s=e!=null?re.toUnitRGB(e):Or;return ci(s,i)}_getVertexOpacityAndColor(e,t=null){let i=this._drivenProperties.color?e.color:null,s=this._drivenProperties.opacity?e.opacity:null,a=ci(i,s);return t&&(a[0]*=t,a[1]*=t,a[2]*=t,a[3]*=t),a}isFastUpdatesEnabled(){return this._fastUpdates!=null}computeComplexity(){return kc(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i),!0;case"elevationInfo":{let s=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,i,s)!==q.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,i){let s=q.UPDATE;return e.forEach(a=>{let o=t(a);if(o!=null){let n=a.graphic;this.setGraphicElevationContext(n,o.elevationContext),o.needsElevationUpdates=i(o.elevationContext.mode)}else s=q.RECREATE}),s}applyRendererDiff(e,t){return N.RecreateSymbol}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;let t=this._fastUpdates.visualVariables,i=t.size?tt(t.size.field,e):0,s=t.color?tt(t.color.field,e):0,a=t.opacity?tt(t.opacity.field,e):0;return ye(i,s,a,0)}get draped(){return this._draped}ensureDrapedStatus(e){return this._draped==null?(this._draped=e,!0):(e!==this.draped&&ui().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){let e=()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null});return{drivenProperties:this._drivenProperties,getVisVarFields:e}}};function uf(r){let e={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return r&&"visualVariables"in r&&r.visualVariables&&r.visualVariables.forEach(t=>{switch(t.type){case"color":if(e.color=!0,t.stops)for(let i=0;i<t.stops.length;i++){let s=t.stops[i].color;s&&(e.opacity=!0,s.a<1&&(e.opacityAlwaysOpaque=!1))}break;case"opacity":e.opacity=!0,e.opacityAlwaysOpaque=!1;break;case"size":e.size=!0}}),e}var vy={mode:"on-the-ground",offset:0,unit:"meters"},xy={mode:"absolute-height",offset:0,unit:"meters"},mf={hasIntrinsicColor:!1};function Ms(r,e,t,i,s){if(ff(r,e))return null;t.localOrigin=Ta(r,e);let a=new dt({geometries:[t],castShadow:!1,layerUid:r.layer.uid,graphicUid:s,usesVerticalDistanceToGround:!0});return{object:a,sampledElevation:Dc(a,e,r.elevationProvider,r.renderCoordsHelper,i)}}function En(r,e,t,i){return ff(e,t)?null:Dc(r,t,e.elevationProvider,e.renderCoordsHelper,i)}function ff(r,e){let t=r.clippingExtent;return!!t&&(Kr(e,mi,r.elevationProvider.spatialReference),!us(t,mi))}function Yt(r,e,t){let i=r.elevationContext,s=t.spatialReference;Kr(e,mi,s),i.centerPointInElevationSR=Di(mi[0],mi[1],e.hasZ?mi[2]:0,s??null)}function cr(r){switch(r.type){case"point":return r;case"polygon":case"extent":return li(r);case"polyline":{let e=r.paths[0];if(!e||e.length===0)return null;let t=Tp(e,Ap(e)/2);return Di(t[0],t[1],t[2],r.spatialReference)}case"mesh":return r.origin}return null}function Ta(r,e){return Kr(e,mi,r.renderCoordsHelper.spatialReference),r.localOriginFactory.getOrigin(mi)}var mi=_();var La=class r extends Gt{initializeConfiguration(e,t){t.spherical=e.viewingMode===Me.Global}initializeProgram(e){return new Mt(e.rctx,r.shader.get().build(this.configuration),Ht)}setPipelineState(e){let t=e?cc.ALWAYS:cc.LESS;return this.configuration.depthHudEnabled?Ze({depthTest:{func:t},depthWrite:xt}):Ze({blending:Ko(tr.ONE,tr.SRC_ALPHA,tr.ONE_MINUS_SRC_ALPHA,tr.ONE_MINUS_SRC_ALPHA),depthTest:{func:t},colorWrite:pt})}initializePipeline(){return this.setPipelineState(this.configuration.multipassEnabled)}};La.shader=new Dt(zm,()=>import("./chunk-J6UILLXK.js"));var at=class extends or{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.multipassEnabled=!1}};u([R()],at.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([R()],at.prototype,"spherical",void 0),u([R()],at.prototype,"occlusionTestEnabled",void 0),u([R()],at.prototype,"hasVerticalOffset",void 0),u([R()],at.prototype,"hasScreenSizePerspective",void 0),u([R()],at.prototype,"depthHudEnabled",void 0),u([R()],at.prototype,"depthHudAlignStartEnabled",void 0),u([R()],at.prototype,"hasSlicePlane",void 0),u([R()],at.prototype,"multipassEnabled",void 0),u([R({constValue:!0})],at.prototype,"hasSliceInVertexProgram",void 0),u([R({constValue:!1})],at.prototype,"draped",void 0);var ji=class r extends ri{get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}constructor(e){super(e,new Ia),this.produces=new Map([[H.LINE_CALLOUTS,t=>t===L.Color],[H.LINE_CALLOUTS_HUD_DEPTH,t=>t===L.Color]]),this._configuration=new at,this._uniqueMaterialIdentifier=r.uniqueMaterialIdentifier(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){let i=t?.slot!==H.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.depthHudEnabled=i,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen",this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration}intersect(){}createGLMaterial(e){return new Yc(e)}createBufferWriter(){return new Zc}validateParameters(e){let t=r.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t)}static uniqueMaterialIdentifier({renderOccluded:e,isDecoration:t,horizontalScreenOffset:i,color:s,size:a,occlusionTest:o,shaderPolygonOffset:n,depthHUDAlignStart:l,centerOffsetUnits:c,hasSlicePlane:h,screenSizePerspective:p,verticalOffset:d,borderColor:f}){return pp`${e}:${t}:${i}:[${s}]:${a}:${o}:${n}:${l}:${c}:${h}:${p!=null}:{${d.screenLength}:${d.minWorldLength}:${d.maxWorldLength}}:[${f}]`}},Yc=class extends ir{beginSlot(e){return this.ensureTechnique(La,e)}},Ia=class extends Ss{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}},Sy=Lt().vec3f(g.POSITION).vec3f(g.NORMAL).vec2f(g.UV0).vec4f(g.CENTEROFFSETANDDISTANCE),gf=[Ii(0,0),Ii(1,0),Ii(0,1),Ii(1,0),Ii(1,1),Ii(0,1)],Zc=class{constructor(){this.vertexBufferLayout=Sy}elementCount(e){return 6*e.attributes.get(g.POSITION).indices.length}write(e,t,i,s,a){Nu(i.attributes.get(g.POSITION),e,s.position,a,6),zu(i.attributes.get(g.NORMAL),t,s.normal,a,6),rn(i.attributes.get(g.CENTEROFFSETANDDISTANCE),s.centerOffsetAndDistance,a,6);for(let o=0;o<gf.length;++o)s.uv0.setVec(a+o,gf[o])}};var Da=class r extends Se{constructor(e,t){super(e,null,t,Ey),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}doLoad(){return O(this,null,function*(){this._materials[0]=new ji(this._materialParameters),this._context.stage.add(this._materials[0])})}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}_perInstanceMaterialParameters(e){let t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){let e=new Ia,t=this.symbol,i=t.callout;if(e.color=i.color!=null?re.toUnitRGBA(i.color):[0,0,0,0],e.color[3]*=this._getLayerOpacity(),e.size=be(i.size||0),t.verticalOffset){let{screenLength:o,minWorldLength:n,maxWorldLength:l}=t.verticalOffset;e.verticalOffset={screenLength:be(o),minWorldLength:n||0,maxWorldLength:l??1/0}}e.borderColor=i.border?.color!=null?re.toUnitRGBA(i.border.color):null;let s=t.symbolLayers.at(0).type==="object",a=t.type==="label-3d";return e.occlusionTest=!s,e.shaderPolygonOffset=s?0:void 0,e.depthHUDAlignStart=a,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return Py}createGraphics3DGraphic(e){let t=e.renderingInfo,i=e.graphic,s=this.setGraphicElevationContext(i,new Vr,t.elevationOffset||0),a=t.symbol,o=this._elevationContext.mode==="on-the-ground"&&(a.type==="cim"||!a.symbolLayers.some(l=>l.type==="object"||l.type==="text"));if(a.type!=="label-3d"&&o||a.type==="point-3d"&&a.symbolLayers.every(l=>l.type==="text"&&!Wo(l)))return null;let n=li(i.geometry);return n==null?null:this._createAs3DShape(n,s,t,i.uid)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,i){let s=this._elevationContext.mode,a=nr(r.elevationModeChangeTypes,i,s);return a!==q.UPDATE||e.forEach(o=>{let n=t(o);n!=null&&this.updateGraphicElevationContext(o.graphic,n)}),a}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t,i=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(i),t}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata!=null?t.metadata.elevationOffset:0),t.needsElevationUpdates=Be(t.elevationContext.mode)}computeComplexity(){return new ke({verticesPerFeature:6})}_getOrCreateMaterial(e){let t=this._perInstanceMaterialParameters(e),i=ji.uniqueMaterialIdentifier(t);if(i===this._materials[0]?.uniqueMaterialIdentifier)return{material:this._materials[0],isUnique:!1};if(e.materialCollection!=null){let s=e.materialCollection.get(i);return s==null&&(s=new ji(t),e.materialCollection.add(i,s)),{material:s,isUnique:!1}}return{material:new ji(t),isUnique:!0}}_createAs3DShape(e,t,i,s){let a=this._context.layer.uid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:a}),n=this._getOrCreateMaterial(i),l=new ht(n.material,Cy(i),null,et.Point,o),c=Ms(this._context,e,l,t,s);if(c==null)return null;let h=new xe(this,c.object,[l],n.isUnique?[n.material]:null,null,Ft,t);return h.metadata=new Gs(i.elevationOffset),h.alignedSampledElevation=c.sampledElevation,h.needsElevationUpdates=Be(t.mode),Yt(h,e,this._context.elevationProvider),h}};function Cy(r){let{translation:e,centerOffset:t}=r,i=new j(e?[e[0],e[1],e[2]]:[0,0,0],Qc,3,!0),s=new j(t?[t[0],t[1],t[2],t[3]]:[0,0,0,1],Qc,4,!0);return[[g.POSITION,i],[g.NORMAL,new j([0,0,1],Qc,3,!0)],[g.CENTEROFFSETANDDISTANCE,s]]}Da.elevationModeChangeTypes={definedChanged:q.UPDATE,staysOnTheGround:q.UPDATE,onTheGroundChanged:q.RECREATE};var Qc=[0],Py={mode:"relative-to-ground",offset:0},Ey={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},Rn=class{constructor(e,t,i=_(),s=Yr(),a=0,o="world",n=0,l=null){this.renderer=e,this.symbol=t,this.translation=i,this.centerOffset=s,this.horizontalScreenOffset=a,this.centerOffsetUnits=o,this.elevationOffset=n,this.materialCollection=l}};var yf=()=>Q.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function _f(r,e){if(!ko(r))return yf().error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${r.type}' does not support callouts`),null;if(!r.callout)return null;let t=Ry[r.callout.type];return t?new t(r,e):(yf().error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${r.callout.type}`),null)}var Ry={line:Da};function Hi(r,e,t,i){return r!=null&&(Rr(e,i)?(sa(t,r),!0):(ut[0]=r[0],ut[1]=r[1],ut[2]=0,!!Ue(ut,e,0,ut,i,0,1)&&(t[0]=ut[0],t[1]=ut[1],ut[0]=r[2],ut[1]=r[3],ut[2]=0,!!Ue(ut,e,0,ut,i,0,1)&&(t[2]=ut[0],t[3]=ut[1],!0))))}var ut=_();var bf=new dp(Array,r=>Ro(r,Kp),null,10,5),Oy=Ne(),On=class{get labelLayers(){return this._labelLayers||lp}get extent(){return this._extent}get isElevationSource(){return this.layers.some(e=>e?.isElevationSource)}constructor(e,t,i,s,a){this.graphic=e,this.graphics3DSymbol=t,this.layers=i,this._visibleFlags=Le.ALL_LABEL,this.deconflictionPriority=0,++t.referenced,this._featureExpressionFeature=a?Tm(a,e,s):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic(t=>{t.initialize(e),t.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.layers==null}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(we.LABEL))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(t=>{t.type==="draped"&&(e=!0)}),e}isVisible(e=we.GRAPHIC,t){let i=t?this._visibleFlags|t|we.LABEL*t:this._visibleFlags;return e===we.GRAPHIC?(i&Le.ALL_GRAPHIC)===Le.ALL_GRAPHIC:(i&Le.ALL_LABEL)===Le.ALL_LABEL}setVisibilityFlag(e,t,i){let s=this.isVisible(e);i?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);let a=this.isVisible(e);if(s===a)return!1;if(e===we.LABEL)this._forEachLabelGraphic(o=>o.setVisibility(a));else{this._forEachSymbolLayerGraphic(n=>n.setVisibility(a));let o=this.isVisible(we.LABEL);this._forEachLabelGraphic(n=>n.setVisibility(o))}return!0}getVisibilityFlag(e,t){return!!(this._visibleFlags&e*t)}computeExtent(e){if(!this._extent){let t=this.graphic.geometry;if(t==null)return!1;this._extent=Ne(),zd(t,this._extent);let i=t.spatialReference;if(!Rr(i,e)&&!Hi(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,i){let s=e.geometry;return s.type!=="mesh"&&s.type!=="extent"||(s=ds.fromExtent(s.type==="mesh"?s.extent:s)),rd(s,t,i)}get usedMemory(){let e=cp(this.graphic.attributes);return this._forEachSymbolLayerGraphic(t=>e+=t.graphics3DSymbolLayer.usedMemory),e}computeAttachmentOrigin(){let e={render:{origin:_(),num:0},draped:{origin:W(),num:0}};for(let t of this.layers)t?.computeAttachmentOrigin(e);return e.render.num>1&&k(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&er(e.draped.origin,e.draped.origin,1/e.draped.num),e}getProjectedBoundingBox(e,t,i,s,a){return O(this,null,function*(){return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?F(a.boundingBox):a.boundingBox=F(),a.requiresDrapedElevation=!1,yield mo(this.layers,o=>O(this,null,function*(){if(o==null)return;let n=o.type==="draped"?t:e,l=bf.acquire(),c=yield o.getProjectedBoundingBox(n,i,a.screenSpaceObjects,s,l);isFinite(c[2])&&isFinite(c[5])||(a.requiresDrapedElevation=!0),c&&Ar(a.boundingBox,l),bf.release(l)})),Yp(a.boundingBox)||Np(ms(a.boundingBox,Oy))?a:null})}needsElevationUpdates(){for(let e of this.layers)if(e!=null&&(e.type==="object3d"||e.type==="lod-instance")&&e.needsElevationUpdates)return!0;return this._labelLayers?.some(e=>e?.needsElevationUpdates??!1)??!1}alignWithElevation(e,t,i){this._forEachRenderedGraphic(s=>{s.type!=="object3d"&&s.type!=="lod-instance"||s.alignWithElevation(e,t,this._featureExpressionFeature,i)})}alignWithAbsoluteElevation(e,t,i){this._forEachRenderedGraphic(s=>{s.type==="object3d"&&s.alignWithAbsoluteElevation(e,t,i)})}addObjectStateSet(e,t){this._forEachSymbolLayerGraphic(i=>i.addObjectState(e,t))}removeObjectState(e){this._forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}_forEachGraphicList(e,t){e?.forEach(i=>i&&t(i))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}};function vf(r,e,t){let i=(e.length>0?e[0]:r.length/3)-1,s=gu(r,i,t);if(s!==wp.Z){r=r.slice();for(let a=0;a<r.length;a+=3)r[a+s]=r[a+2]}return Ir(r,e,3)}function Jc(r){let e=[[g.POSITION,new j(r.attributeData.position,r.indices,3,!0)]],t=Xr(r.indices.length);return r.attributeData.colorFeature!=null?e.push([g.COLORFEATUREATTRIBUTE,new j([r.attributeData.colorFeature],t,1,!0)]):r.attributeData.color&&e.push([g.COLOR,new j(r.attributeData.color,t,4,!0)]),r.attributeData.uvMapSpace&&e.push([g.UVMAPSPACE,new j(r.attributeData.uvMapSpace,r.indices,4,!0)]),r.attributeData.boundingRect&&e.push([g.BOUNDINGRECT,new j(r.attributeData.boundingRect,r.indices,9,!0)]),new ht(r.material,e,r.mapPositions,et.Mesh,r.attributeData.objectAndLayerIdColor)}function Xc(r,e=null){let t=[[g.POSITION,new j(r.attributeData.position,r.indices,3,!0)],[g.UV0,new j(r.attributeData.uv0,r.indices,2,!0)]];return new ht(r.material,t,r.mapPositions,et.Mesh,e)}function gi(r){switch(r.type){case"extent":if(r instanceof cs)return ds.fromExtent(r);break;case"polygon":return r}return null}var fi=class{constructor(e,t,i){this.renderData=e,this.layerUid=t,this.graphicUid=i,this.outGeometries=new Array}};function Vs(r,e,t,i){let s=Sc(r.rings,!!r.hasZ&&i.mode!=="on-the-ground",Cc.CCW_IS_HOLE,r.spatialReference),a=Fe(s.position.length),o=Om(s.position,r.spatialReference,0,a,0,s.position,0,s.position.length/3,e,t,i),n=o!=null;return new th(s.position,a,Sf(s.polygons,s.position,a),xf(s.outlines,s.position,a),n,o)}function An(r,e){let t=Sc(r.rings,!1,Cc.CCW_IS_HOLE),i=Ue(t.position,r.spatialReference,0,t.position,e,0,t.position.length/3);for(let s=2;s<t.position.length;s+=3)t.position[s]=hn;return{position:t.position,polygons:Sf(t.polygons,t.position),outlines:xf(t.outlines,t.position),projectionSuccess:i}}function xf(r,e,t=null){return r.filter(({count:i})=>i>1).map(({index:i,count:s})=>{let a=3*i,o=3*s;return t!=null?new wn(i,s,It(e,a,o),It(t,a,o)):new Ga(i,s,It(e,a,o))})}function Sf(r,e,t=null){let i=new Array;for(let{index:s,count:a,holeIndices:o,pathLengths:n}of r){if(a<=1)continue;let l=3*s,c=3*a,h=o.map(d=>d-s),p=t!=null?new Kc(s,a,It(e,3*s,3*a),It(t,l,c),h,n):new eh(s,a,It(e,3*s,3*a),h,n);i.push(p)}return i}var Ga=class{constructor(e,t,i){this.index=e,this.count=t,this.position=i}},wn=class extends Ga{constructor(e,t,i,s){super(e,t,i),this.mapPositions=s}},Kc=class extends wn{constructor(e,t,i,s,a,o){super(e,t,i,s),this.holeIndices=a,this.pathLengths=o}},eh=class extends Ga{constructor(e,t,i,s,a){super(e,t,i),this.holeIndices=s,this.pathLengths=a}},th=class{constructor(e,t,i,s,a,o){this.position=e,this.mapPositions=t,this.polygons=i,this.outlines=s,this.projectionSuccess=a,this.sampledElevation=o}};var wy=["polygon","extent"],In=class extends Se{constructor(e,t,i,s){super(e,t,i,s),this.ensureDrapedStatus(!1)}doLoad(){return O(this,null,function*(){if(!this._drivenProperties.size){let n=hi(this._getSymbolSize());if(n)throw new _e("graphics3dextrudesymbollayer:invalid-size",n)}let e=this.symbolLayer?.material?.color,t=this._getCombinedOpacityAndColor(e),i=Tt(t),s=t[3],a=s<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:s,transparent:a,cullFace:a?Re.None:Re.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:Yo.Compressed};this._materials[Et.Main]=new St(o),this._materials[Et.Bottom]=new St(Pe(Z({},o),{cullFace:Re.Back})),this._context.stage.addMany(this._materials)})}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,wy,this.symbolLayer.type))return null;let i=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(t);return this._createAs3DShape(t,e.renderingInfo,i,s,t.uid)}layerOpacityChanged(e,t){let i=this.symbolLayer?.material?.color,s=this._getCombinedOpacity(i),a=s<1||this.needsDrivenTransparentPass;this._materials[Et.Main]?.setParameters({opacity:s,transparent:a}),this._materials[Et.Bottom]?.setParameters({opacity:s,transparent:a});let o=this._getLayerOpacity();e.forEach(n=>{let l=t(n);l?.layerOpacityChanged(o,this._context.isAsync)})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Vt)}slicePlaneEnabledChanged(e,t){return this._materials[Et.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[Et.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach(i=>{let s=t(i);s?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){let e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[Et.Main]?.setParameters(e),this._materials[Et.Bottom]?.setParameters(e),!0}_getExtrusionSize(e){let t;return t=e.size&&this._drivenProperties.size?Xm(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?N.RecreateSymbol:N.RecreateGraphics}queryForSnapping(e,t,i,s){return O(this,null,function*(){let a=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/bo(t),{objectId:o,target:n}=e,l=ns(n);switch(l.z=(l.z??0)+a,e.type){case"edge":{let{start:c,end:h}=e,p=ns(c),d=ns(h);return p.z=(p.z??0)+a,d.z=(d.z??0)+a,[ic(o,l,1/0,p,d)]}case"vertex":return[pd(o,l,1/0),ic(o,n,1/0,n,l)];default:return[]}})}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,t,i,s,a){let o=gi(e.geometry);if(o==null)return null;if(o.rings.length===0||!o.rings.some(G=>G.length>0))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;let n=Vs(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(n,o.rings,"rings","ExtrudeSymbol3DLayer");let l=li(o);if(l==null)return null;let c=new Array,h=new Array,p=K(),d=V(),f=_(),m=this._context.renderCoordsHelper.viewingMode===Me.Global;m||this._context.renderCoordsHelper.worldUpAtPosition(null,f),bt(o.spatialReference,[l.x,l.y,0],d,this._context.renderCoordsHelper.spatialReference);let y=V();wr(y,d);let b=Ti();ha(b,y);let{polygons:S,mapPositions:x,position:w}=n,E=new Map,C=this._materials[Et.Main];for(let G of S){let ne=G.count;if(this._context.clippingExtent&&(F(p),Ge(p,G.mapPositions),!ze(p,this._context.clippingExtent)))continue;let U=Ir(G.mapPositions,G.holeIndices,3);if(U.length===0)continue;let he=U.length,pe=6*ne,wt=hc(pe+he),Si=hc(he),Wr=Fe(3*pe),lo=Fe(3*pe),co=Fe(3*pe),rp=Fe(pe);Ay(w,x,U,G,Wr,co,lo,rp,wt,Si,this._getExtrusionSize(t),f,m),pa(Wr,Wr,y);let ip=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:this._context.layer.uid}),kl=new ih(Wr,co,Rd(lo),rp),Wl=Cf(C,wt,wt.length-Si.length,kl,i,ip),cy=ne,hy=ne,py=2*G.count,sp=new sh(cy,hy,py,he/3);Lf(Wl,sp,d),E.set(Wl,sp),c.push(Wl,Cf(this._materials[Et.Bottom],Si,0,kl,i,ip)),h.push(kl.heights)}if(c.length===0)return null;let P=new dt({geometries:c,layerUid:this._context.layer.uid,graphicUid:a,isElevationSource:!0});P.transformation=d;let T=Zo(this.symbolLayer,{opacity:this._getLayerOpacity()}),D=T!=null?{baseMaterial:this._materials[Et.Main],edgeMaterials:[T],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,I=new xe(this,P,c,null,null,(G,ne,U,he,pe)=>Iy(G,ne,U,he,pe,h,E),s,D);return I.alignedSampledElevation=n.sampledElevation,I.needsElevationUpdates=Vt(s.mode),I}};function Cf(r,e,t,i,s,a){let o=Xr(e.length),n=[[g.POSITION,new j(i.positions,e,3,!0)],[g.NORMALCOMPRESSED,new j(i.normals,e,2,!0)],[g.COLOR,new j(s,o,4,!0)]];return new ht(r,n,i.elevation,et.Mesh,a,t)}function Ay(r,e,t,i,s,a,o,n,l,c,h,p,d){{let f=t.length/3,m=2*i.count;Ty(r,e,i.index,i.count,t,0,f,s,a,o,n,l,c,m,h,p,d)}{let f=0,m=2*i.count,y=0,b=i.pathLengths[0];Pf(s,a,n,o,f,b,i.count,m,l,y,h),m+=4*b,y+=2*b,f+=b;for(let S=1;S<i.pathLengths.length;++S){let x=i.pathLengths[S];Pf(s,a,n,o,f,x,i.count,m,l,y,h),m+=4*x,y+=2*x,f+=x}}}function Ty(r,e,t,i,s,a,o,n,l,c,h,p,d,f,m,y,b){te(Pt,y);{let S=m>0?1:-1,x=3*t,w=0,E=3*w,C=i,P=3*C;for(let T=0;T<i;++T){let D=r[x],I=r[x+1],G=r[x+2];b&&(Pt[0]=D,Pt[1]=I,Pt[2]=G,J(Pt,Pt)),n[E+0]=D,n[E+1]=I,n[E+2]=G;let ne=e[x+0],U=e[x+1],he=e[x+2];l[E+0]=ne,l[E+1]=U,l[E+2]=he,c[E+0]=-S*Pt[0],c[E+1]=-S*Pt[1],c[E+2]=-S*Pt[2],h[w]=0,n[P+0]=D+m*Pt[0],n[P+1]=I+m*Pt[1],n[P+2]=G+m*Pt[2],l[P+0]=ne,l[P+1]=U,l[P+2]=he,h[C]=m,E+=3,P+=3,x+=3,w+=1,C+=1}}{let S=3*a,x=0,w=3*f,E=m<0?Tf:Af,C=m<0?Af:Tf;for(let P=0;P<o;++P)d[x]=s[S+E[0]],d[x+1]=s[S+E[1]],d[x+2]=s[S+E[2]],p[w]=s[S+C[0]]+i,p[w+1]=s[S+C[1]]+i,p[w+2]=s[S+C[2]]+i,x+=3,w+=3,S+=3}}function Tn(r,e,t,i,s,a,o){i[a]=i[o],o*=3,r[a*=3]=r[o],r[a+1]=r[o+1],r[a+2]=r[o+2],e[a]=e[o],e[a+1]=e[o+1],e[a+2]=e[o+2],t[a]=s[0],t[a+1]=s[1],t[a+2]=s[2]}var Ma=_();function Pf(r,e,t,i,s,a,o,n,l,c,h){let p=s,d=s+1,f=s+o,m=s+o+1,y=n,b=n+1,S=n+2*a,x=n+2*a+1;h<0&&(p=s+o+1,m=s);let w=3*c;for(let E=0;E<a;++E)E===a-1&&(d=s,h>0?m=s+o:p=s+o),Ly(r,p,d,f,Ma),Tn(r,e,i,t,Ma,y,p),Tn(r,e,i,t,Ma,b,d),Tn(r,e,i,t,Ma,S,f),Tn(r,e,i,t,Ma,x,m),l[w]=y,l[w+1]=S,l[w+2]=x,l[w+3]=y,l[w+4]=x,l[w+5]=b,w+=6,p++,d++,f++,m++,y+=2,b+=2,S+=2,x+=2}var rh=_(),Ef=_(),Rf=_(),Of=_(),wf=_();function Ly(r,e,t,i,s){e*=3,t*=3,i*=3,A(rh,r[e++],r[e++],r[e++]),A(Ef,r[t++],r[t++],r[t++]),A(Rf,r[i++],r[i++],r[i++]),de(Of,Ef,rh),de(wf,Rf,rh),qe(s,wf,Of),J(s,s)}var Us=_();function Iy(r,e,t,i,s,a,o){let n=r.stageObject,l=n.geometries,c=l.length,h=e.mode!=="absolute-height",p=0,d=n.transformation,f=Hp(V(),d);for(let m=0;m<c;m+=2){let y=l[m];if(!Aa(y))continue;let b=y.getMutableAttribute(g.POSITION).data,S=a[m/2],x=new Es(y.mapPositions),w=b.length/3,E=!1,C=0;{let P=0;for(let T=0;T<w;T++){Us[0]=b[P],Us[1]=b[P+1],Us[2]=b[P+2],i(x,Ln),h&&(C+=Ln.sampledElevation),Te.TESTS_DISABLE_OPTIMIZATIONS?(A(Qe,x.array[x.offset],x.array[x.offset+1],Ln.z+S[P/3]),t!=null&&s.toRenderCoords(Qe,t,Qe),X(Qe,Qe,f)):(A(Qe,b[P],b[P+1],b[P+2]),X(Qe,Qe,d),s.setAltitude(Qe,Ln.z+S[P/3]),X(Qe,Qe,f)),b[P]=Qe[0],b[P+1]=Qe[1],b[P+2]=Qe[2];let D=Dy/s.unitInMeters;(Math.abs(Us[0]-b[P])>=D||Math.abs(Us[1]-b[P+1])>=D||Math.abs(Us[2]-b[P+2])>=D)&&(E=!0),x.offset+=3,P+=3}}if(E){let P=o.get(y);P&&Lf(y,P,d),n.geometryVertexAttributeUpdated(l[m],g.NORMALCOMPRESSED),y.invalidateBoundingInfo(),n.geometryVertexAttributeUpdated(l[m],g.POSITION),l[m+1].invalidateBoundingInfo(),n.geometryVertexAttributeUpdated(l[m+1],g.POSITION)}p+=C/w}return p/c}function Lf(r,e,t){let i=r.getMutableAttribute(g.POSITION),s=r.getMutableAttribute(g.NORMALCOMPRESSED).data,{topVertexStart:a,topVertexCount:o,topFaceStart:n,topFaceCount:l}=e,c=i.data,h=o,p=r.attributes.get(g.POSITION).indices,d=n+l,f=a+o,m=Fe(3*h);for(let E=0;E<h;++E){let C=3*E;m[C+0]=0,m[C+1]=0,m[C+2]=0}let y=Gy,b=My,S=Vy,x=Uy,w=Pt;for(let E=n;E<d;++E){let C=3*E;for(let P=0;P<3;++P){let T=p[C+P];x[P]=T;let D=3*T;A(Qe,c[D+0],c[D+1],c[D+2]),X(y[P],Qe,t)}Xl(b,y[1],y[0]),Xl(S,y[2],y[0]),qe(w,b,S),J(w,w);for(let P=0;P<3;++P){let T=3*(x[P]-a);m[T+0]+=w[0],m[T+1]+=w[1],m[T+2]+=w[2]}}for(let E=a;E<f;++E){let C=3*(E-a),P=m[C+0],T=m[C+1],D=m[C+2],I=Math.sqrt(P*P+T*T+D*D);Uo(s,E,P/I,T/I,D/I)}}var Qe=_(),Pt=_(),Ln=new lr,Af=[0,2,1],Tf=[0,1,2],Dy=.01,Gy=[_(),_(),_()],My=_(),Vy=_(),Uy=[0,0,0],Et;(function(r){r[r.Main=0]="Main",r[r.Bottom=1]="Bottom"})(Et||(Et={}));var ih=class{constructor(e,t,i,s){this.positions=e,this.elevation=t,this.normals=i,this.heights=s}},sh=class{constructor(e,t,i,s){this.topVertexStart=e,this.topVertexCount=t,this.topFaceStart=i,this.topFaceCount=s}};var pr=class{constructor(e,t,i,s){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this._drapeSourceRenderer=s,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e.stage}setVisibility(e){if(this.stage!=null&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,Ac.ADD);if(e||this._addedToStage){for(let t of this.renderGeometries)t.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,cn.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,Ac.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=_()){return A(e,0,0,0)}getBoundingBoxObjectSpace(e=K()){return F(e)}addObjectState(e,t){e===ct.Highlight&&(this.renderGeometries.forEach(i=>{let s=i.geometry.addHighlight();t.addRenderGeometry(i,s,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,cn.HIGHLIGHT))}removeObjectState(e){this.renderGeometries.forEach(t=>{e.removeRenderGeometry(t)})}removeRenderGeometryObjectState(e,t){e.geometry.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,cn.HIGHLIGHT)}computeAttachmentOrigin(e){for(let t of this.renderGeometries)t.geometry.computeAttachmentOrigin(Fs)&&(e.draped.origin[0]+=Fs[0],e.draped.origin[1]+=Fs[1],e.draped.num++)}getProjectedBoundingBox(e,t,i,s,a){return O(this,null,function*(){F(a);for(let o=0;o<this.renderGeometries.length;o++){let n=this.renderGeometries[o];this._getRenderGeometryProjectedBoundingRect(n,e,If,i),$p(a,If)}if(t){let o;$e(a,Fs);let n=ws(a,t.service.spatialReference,t);try{o=yield t.service.queryElevation(Fs[0],Fs[1],s,n,"ground")}catch{}o!=null&&(a[2]=Math.min(a[2],o),a[5]=Math.max(a[5],o))}return a})}_getRenderGeometryProjectedBoundingRect(e,t,i,s){if(this.boundingBox)Ro(hr,this.boundingBox);else{let a=e.boundingSphere,o=a[3];hr[0]=a[0]-o,hr[1]=a[1]-o,hr[2]=a[2]-o,hr[3]=a[0]+o,hr[4]=a[1]+o,hr[5]=a[2]+o}return t(hr,0,2),this.calculateRelativeScreenBounds&&s.push({location:$e(hr),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),ms(hr,i)}},If=Ne(),hr=K(),Fs=_();function ki(r,e,t){return r.canvas||(r.canvas=document.createElement("canvas")),r.canvas.width=e,r.canvas.height=t,r.canvas}function Dn(r){let{size:e}=r.definition,t=r.fontString(e),i=Df.get(t);if(!i){let s=ki(Fy,0,0).getContext("2d");r.setFontProperties(s,e);let a=s.measureText(By);i=new ah(a.actualBoundingBoxAscent,a.actualBoundingBoxDescent),Df.set(t,i)}return i}var Df=new Map,ah=class{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(e,t){this.maxAscent=e,this.maxDescent=t}},Fy={canvas:null},By=(()=>{let r="";for(let e=32;e<127;e++)r+=String.fromCharCode(e);return r})();var Vn=1,Mn=class{constructor(e,t,i,s){this.text=e,this._alignment=t,this._parameters=i,this._maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${e}`,this._lines=e.replaceAll(" ","\xA0").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let e=this._metrics.firstLineAscent;for(let t=0;t<this._lines.length-1;t++)e+=this._lineSpacing;return e+=this._metrics.lastLineDescent,Math.ceil(e+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(this._metricsCached==null){let e=ki(Gf,Gn,Gn).getContext("2d"),t=this._parameters.definition.pixelRatio,i=this._fontSize*t;this._parameters.setFontProperties(e,i);let s=2*this._haloSize,a=this._parameters.definition.font;a.style!=="italic"&&a.style!=="oblique"&&a.weight!=="bold"&&a.weight!=="bolder"||(s+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let o=0,n=0,l=0,c=0,h=0;this._lines.forEach((S,x)=>{let w=e.measureText(S),E=w.width/t,C=E+s;this._textWidths.push(E),this._lineWidths.push(C),o=Math.max(o,C),c=Math.max(c,w.actualBoundingBoxAscent/t),h=Math.max(h,w.actualBoundingBoxDescent/t),x===0&&(n=w.actualBoundingBoxAscent/t),x===this._lines.length-1&&(l=w.actualBoundingBoxDescent/t)});let p=Dn(this._parameters),d=Math.max(c,p.maxAscent),f=Math.max(h,p.maxDescent),m=n,y=this._parameters.definition.font.decoration==="underline"?f:l,b=o;this._metricsCached=new oh(m,y,d,f,b)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*Ny}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,Vn)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(this._renderPixelRatio==null){let e=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(e,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case Br.Left:return this._horizontalPadding;case Br.Center:return(this.displayWidth-this._lineWidths[e])/2;case Br.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[e]}}render(e,t,i){e.save();let s=t/=this.renderPixelRatio,a=i/=this.renderPixelRatio,o=this._haloSize,n=this._firstLineYOffset+this._metrics.firstLineAscent;t+=o,i+=n;let l=this._haloSize>0;l&&this._renderHalo(e,s,a,o,n),this._parameters.setFontProperties(e,this._renderedFontSize);for(let c=0;c<this._lines.length;++c){let h=this._lines[c],p=this._getLineXOffset(c);l&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,h,t+p,i),this._renderLineDecoration(e,t+p,i,this._textWidths[c])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,h,t+this._getLineXOffset(c),i),this._renderLineDecoration(e,t+p,i,this._textWidths[c]),i+=this._lineSpacing}if(Te.TEXT_SHOW_BASELINE){e.strokeStyle=Mf,e.setLineDash([2,2]),e.lineWidth=1;let c=a+n;for(let h=0;h<this._lines.length;++h)this._drawLine(e,[s,c],[s+this.displayWidth,c]),c+=this._lineSpacing}if(Te.TEXT_SHOW_BORDER&&(e.strokeStyle=Mf,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[s,a],[this.displayWidth,this.displayHeight])),this._hasBackground){let c=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,s,a,c),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,t,i,s,a=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;let o=1,n=Math.max(this._parameters.definition.size/16,o);switch(this._parameters.definition.font.decoration){case"underline":i+=2*n;break;case"line-through":i-=.33*this._midLineAscent}let l=a?this._haloSize:0;e.strokeStyle=a?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(n+2*l),e.beginPath(),e.moveTo(this._toRenderUnit(t-l),this._toRenderUnit(i)),e.lineTo(this._toRenderUnit(t+s+l),this._toRenderUnit(i)),e.stroke()}_roundedRect(e,t,i,s){t=this._toRenderUnit(t),i=this._toRenderUnit(i);let a=this.renderedWidth,o=this.renderedHeight;s!==0?(s=Ri(s,0,Math.floor(o/2)),e.beginPath(),e.moveTo(t,i+s),e.arcTo(t,i,t+s,i,s),e.lineTo(t+a-s,i),e.arcTo(t+a,i,t+a,i+s,s),e.lineTo(t+a,i+o-s),e.arcTo(t+a,i+o,t+a-s,i+o,s),e.lineTo(t+s,i+o),e.arcTo(t,i+o,t,i+o-s,s),e.closePath()):e.rect(t,i,a,o)}_renderHalo(e,t,i,s,a){let o=this.renderedWidth,n=this.renderedHeight,l=ki(Gf,Math.max(o,Gn),Math.max(n,Gn)),c=l.getContext("2d");c.clearRect(0,0,o,n),this._parameters.setFontProperties(c,this._renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;let h=this._renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this._renderHaloEmulated(c,s,a):this._renderHaloNative(c,s,a);let p=a;for(let d=0;d<this._lines.length;++d){let f=this._getLineXOffset(d);this._renderLineDecoration(c,s+f,p,this._textWidths[d],!0),p+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(l,0,0,o,n,this._toRenderUnit(t),this._toRenderUnit(i),o,n),e.globalAlpha=1}_renderHaloEmulated(e,t,i){for(let s=0;s<this._lines.length;++s){let a=this._lines[s],o=this._getLineXOffset(s);for(let[n,l]of Vf)this._fillText(e,a,t+o+this._haloSize*n,i+this._haloSize*l);i+=this._lineSpacing}}_renderHaloNative(e,t,i){let s=2*this._haloSize;for(let a=0;a<this._lines.length;++a){let o=this._lines[a],n=this._getLineXOffset(a),l=5,c=.1;for(let h=0;h<l;h++){let p=1-(l-1)*c+h*c;e.lineWidth=this._toRenderUnit(p*s),this._strokeText(e,o,t+n,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,t,i,s){e.fillText(t,this._toRenderUnit(i),this._toRenderUnit(s))}_strokeText(e,t,i,s){e.strokeText(t,this._toRenderUnit(i),this._toRenderUnit(s))}_drawLine(e,t,i){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),e.stroke()}_drawBox(e,t,i){let s=this._toRenderUnit(t[0]),a=this._toRenderUnit(t[1]),o=this._toRenderUnit(i[0]),n=this._toRenderUnit(i[1]),l=Math.floor(s)+.5,c=Math.ceil(s+o)-.5,h=Math.floor(a)+.5,p=Math.ceil(a+n)-.5;e.beginPath(),e.moveTo(l,h),e.lineTo(c,h),e.lineTo(c,p),e.lineTo(l,p),e.lineTo(l,h),e.stroke()}},Vf=[];for(let e=0;e<360;e+=360/16)Vf.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);var Br;(function(r){r[r.Left=0]="Left",r[r.Center=1]="Center",r[r.Right=2]="Right"})(Br||(Br={}));var Gf={canvas:null},Ny=.2,Gn=512,Mf="rgb(255, 0, 255, 0.5)",oh=class{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(e,t,i,s,a){this.firstLineAscent=e,this.lastLineDescent=t,this.maxLineAscent=i,this.maxLineDescent=s,this.displayWidth=a}};var Uf=Object.freeze({left:0,center:.5,right:1}),Bs=Object.freeze({"bottom-left":B(0,0),bottom:B(.5,0),"bottom-right":B(1,0),left:B(0,.5),center:B(.5,.5),right:B(1,.5),"top-left":B(0,1),top:B(.5,1),"top-right":B(1,1)});function Ff(r){switch(r){case"left":return Br.Left;case"right":return Br.Right;default:return Br.Center}}function Bf(r,e){switch(e){case"bottom":return r==="left"?"bottom-left":r==="right"?"bottom-right":"bottom";case"center":return r;case"top":return r==="left"?"top-left":r==="right"?"top-right":"top"}}function Nf(r){return r==="middle"?"center":r}function zf(r,e){switch(r){case"top":return ve(e,0,Vn);case"bottom":return ve(e,0,-Vn);default:return To(e,Io)}}var jf=Je(0,0,1),zy=16,jy=1.5,Wi=um,Hy=[Wi/2,Wi/2,1-Wi/2,1-Wi/2],ky=[Tc*Wi,Tc*Wi],Ns=class r extends Se{getCachedSize(){return{size:this._getIconSize()}}constructor(e,t,i,s){super(e,t,i,s),this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._patchTask=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}doLoad(e){return O(this,null,function*(){this._validateOrThrow();let t=this._prepareMaterialParameters(),i=this._getPrimitive();if(i!=null)this._prepareResourcesPrimitive(t,i);else{let s=Ju(this.symbolLayer),a=Hf(s);a!=null?yield this._prepareResourcesCIM(t,JSON.parse(a),e):yield this._prepareResourcesHref(t,s,e)}})}_validateOrThrow(){if(this._drivenProperties.size)return;let e=hi(this._getIconSize());if(e)throw new _e("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){let e=this.symbolLayer,t=Math.round(e.size!=null?be(e.size):zy);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){let t=this._cimData;if(t&&t.symbol||this.logger.error("Can't create texture, CIM data is undefined"),t.primitiveOverrides){t=ns(t);let c=t.primitiveOverrides;ma.evaluateOverrides(c,e,this._arcadeInfo.geometryType,null,null),ma.applyOverrides(t.symbol,c)}let i=hp(JSON.stringify(t)),s=this._cimSymbolTextures.get(i);if(s)return s;let a=this._context.sharedResources.cimSymbolRasterizer,o=this._context.renderer&&this._context.renderer.type==="dictionary"?this._context.renderer.fieldMap:null;o&&ma.applyDictionaryTextOverrides(t.symbol,e,o,null);let n=this._cimScaleFactorOrFunction!=null?$d(this._cimScaleFactorOrFunction,e):1;n!==1&&t.symbol&&wu(t.symbol,n,!0);let l=zo.getEnvelope(t,null,a.resourceManager);if(l?.width&&l.height){let c=l.x+l.width/2,h=l.y+l.height/2,p=a.rasterize({type:"cim",data:t},l.width,l.height,c,h,1,"esriGeometryPoint"),d=new Kd({x:-l.x/l.width-.5,y:(l.height+l.y)/l.height-.5});this._cimMaterialParametersInfo.anchorPosition=kf("relative",d),s=new Mi(p,{width:p?.width??1,height:p?.height??1,reloadable:!0})}else s=new Mi(new ImageData(1,1),{width:1,height:1,reloadable:!0});return this._cimSymbolTextures.set(i,s),this._context.stage.add(s),s}_prepareMaterialParameters(){let e={anchorPosition:kf(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(Wy(t)){let{screenLength:i,minWorldLength:s,maxWorldLength:a}=t.verticalOffset;e.verticalOffset={screenLength:be(i),minWorldLength:s||0,maxWorldLength:a??1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!Ve("enable-feature:non-occluded-hud"),e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){let i=this._getOutlineSize();if(nh(t)&&i===0)throw new Error("Nothing to render");if(this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,this._context.sharedResources.textures!=null){let a=this._context.sharedResources.textures.fromData(`${t}-icon`,()=>fm(t));this._textureHandle=a,e.textureId=a.texture.id}e.textureIsSignedDistanceField=!0,e.sampleSignedDistanceFieldTexelCenter=mm(t),e.distanceFieldBoundingBox=Hy;let s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=1/Wi,this._createMaterialAndAddToStage(e,this._context.stage)}_prepareResourcesHref(e,t,i){return O(this,null,function*(){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;let s=this._getIconSize(),a=s*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(this._context.sharedResources.textures!=null){let o=yield ra(this._context.sharedResources.textures.fromUrl(t,a,{signal:i}));if(o.ok===!1)throw $l(o.error),new _e("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${t})`);this._textureHandle=o.value;let n=o.value.texture;this._size=Wf(n,s),e.textureId=n.id}this._createMaterialAndAddToStage(e,this._context.stage)})}_prepareResourcesCIM(e,t,i){return O(this,null,function*(){if(this._cimData=t,!this._context.sharedResources.cimSymbolRasterizer){let h=(yield import("./chunk-5JAQKJVD.js")).CIMSymbolRasterizer;ee(i),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new h(this._context.renderCoordsHelper.spatialReference))}let s=this._context.sharedResources.cimSymbolRasterizer,a=[],o=t,n=o?.symbol;zo.fetchResources(n,s.resourceManager,a,i),zo.fetchFonts(n,s.resourceManager,a);let l=this._context.layer.fields?this._context.layer.fields.map(h=>h.toJSON()):[],c=this._context.renderCoordsHelper.spatialReference;if(this._arcadeInfo={spatialReference:c,fields:l,geometryType:"esriGeometryPoint"},o?.primitiveOverrides&&a.push(ma.createRenderExpressions(o.primitiveOverrides,this._arcadeInfo)),a.length>0&&(yield Promise.all(a),ee(i)),this._context.renderer&&this._context.renderer.type==="dictionary"&&this._context.renderer.scaleExpression){let h=this._context.renderer;if(h.scaleExpression){let p=h.scaleExpression,d=yield Eu(p,this._context.layer.spatialReference,l);this._cimScaleFactorOrFunction=(f,m,y)=>{let b=ou(d,f,{$view:y},"esriGeometryPoint",m);return b!==null?b:1}}}ee(i),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1})}_getPrimitive(){return this.symbolLayer.resource?.href?null:this.symbolLayer.resource?.primitive??Xd}_getOutlineSize(){let e=0,t=this.symbolLayer;return t.outline?.size!=null?Math.max(be(t.outline.size),0):(e=nh(this._getPrimitive())?jy:0,Math.max(e,0))}_getOutlineColor(){let e=this._getLayerOpacity(),t=this.symbolLayer,i=t?.outline?.color;if(i!=null){let s=re.toUnitRGB(i),a=i.a*e;return[s[0],s[1],s[2],a]}return[0,0,0,0]}_getFillColor(){if(nh(this._getPrimitive()))return tf;let e=this._getPrimitive()==null,t=this.symbolLayer?.material?.color;return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_createMaterialAndAddToStage(e,t){if(this._cimData){this._fastUpdates=null;let i=e.textureId?this._cimSymbolMaterials.get(e.textureId):null;return i||(i=new Os(e),this._cimSymbolMaterials.set(e.textureId??0,i),t.add(i)),i}return this._fastUpdates=kt(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(e=Z(Z({},e),this._fastUpdates.materialParameters)),this._materials[0]=new Os(e),t.add(this._materials[0]),this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._patchTask=Ks(this._patchTask),this._forEachMaterial(e=>this._context.stage.remove(e)),this._materials.length=0,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.remove(e)),this._cimSymbolTextures.clear(),this._textureHandle=ea(this._textureHandle)}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let i=0;i<3;i++){let s=e.size[i];s&&s!=="symbol-value"&&s!=="proportional"&&(e.size[i]=be(s))}if(e.size[0]==="symbol-value")return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let i,s=[0,0];if(this._cimData){if(!this._cimData.symbol)return null;let p=this._generateTextureCIM(t),d=Z({textureId:p.id},this._cimMaterialParametersInfo);i=this._createMaterialAndAddToStage(d,this._context.stage);let f=window.devicePixelRatio||1;s=[p.parameters.width/f,p.parameters.height/f]}else s=this._size,i=this._materials[0];let a=cr(t.geometry);if(a==null)return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;let o=e.renderingInfo,n=this._getVertexOpacityAndColor(o),l=1;if(!this._fastUpdates?.visualVariables.size){let p=s[0]>s[1]?s[0]:s[1];l=this._getScaleFactor(o,p)}l*=this._symbolTextureRatio;let c=B(s[0]*l,s[1]*l),h=this.setGraphicElevationContext(t);return this.ensureDrapedStatus(h.mode==="on-the-ground")&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,a,i,n,c,e.layer.uid):this._createAs3DShape(t,a,i,n,c,h,t.uid)}layerOpacityChanged(){let e=this._getFillColor(),t=this._getOutlineColor();this._forEachMaterial(i=>{i.setParameters({color:e}),i.setParameters({outlineColor:t})})}updateGeometry(e,t){if(this.draped||!this._validateGeometry(t))return!1;let{elevationContext:i,stageObject:s}=e;if(i.mode!==this.getGeometryElevationMode(t))return!1;let a=cr(t);if(!a)return!1;let o=En(s,this._context,a,i);if(o==null)return!1;let n=Ta(this._context,a);return s.geometries[0].localOrigin===n&&(e.alignedSampledElevation=o,Yt(e,a,this._context.elevationProvider),!0)}layerElevationInfoChanged(e,t,i){let s=this._elevationContext.mode,a=nr(r.elevationModeChangeTypes,i,s);if(a!==q.UPDATE)return a;let o=Be(s)||s==="absolute-height";return this.updateGraphics3DGraphicElevationInfo(e,t,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return this._getPrimitive()!=null}applyRendererDiff(e,t){for(let i in e.diff){if(i!=="visualVariables")return N.RecreateSymbol;if(!Wt(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return N.RecreateSymbol;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return N.FastUpdate}prepareSymbolLayerPatch(e){if(this._patchTask?.abort(),e.diff.type!=="partial")return;let t=e.diff.diff;this._preparePatchResource(e,t)}_preparePatchResource(e,t){if(!t.resource||t.resource.type!=="partial")return;let i=t.resource.diff;if(i?.href?.type!=="complete")return;let s=i.href.newValue,{textures:a}=this._context.sharedResources;if(s==null||a==null||Hf(s)!=null)return;let o=this._getIconSize(),n=o*this._context.graphicsCoreOwner.view.state.pixelRatio;e.symbolLayerStatePatches.push(()=>{this._patchTask=Ks(this._patchTask),this._patchTask=xp(l=>this._context.schedule((c,h)=>O(this,null,function*(){let p=yield ra(a.fromUrl(s,n,{signal:h}));ee(h);let d=!p.ok;if(d&&$l(p.error),this._textureHandle=ea(this._textureHandle),this._patchTask=null,d){this._forEachMaterial(y=>{y.visible=!1,y.setParameters({textureId:null})});let m=`Failed to load (Request for icon resource failed: ${s})`;return void this.logger.error(new _e("graphics3diconsymbollayer:request-failed",m))}this._textureHandle=p.value;let f=p.value.texture;this._size=Wf(f,o),this._forEachMaterial(m=>{m.setParameters({textureId:f.id}),m.visible=!0})}),l))}),delete i.href}_defaultElevationInfoNoZ(){return qy}_createAs3DShape(e,t,i,s,a,o,n){let l=this.getFastUpdateAttrValues(e),c=this._context.layer.uid,h=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerUid:c}),p=Sa(i,jf,null,s,a,$y,null,l,h),d=Ms(this._context,t,p,o,n);if(d==null)return null;let f=new xe(this,d.object,[p],null,null,Ft,o);return f.alignedSampledElevation=d.sampledElevation,f.needsElevationUpdates=Be(o.mode)||o.mode==="absolute-height",f.getScreenSize=this._createScreenSizeGetter(a,l),f.calculateRelativeScreenBounds=m=>i.calculateRelativeScreenBounds(f.getScreenSize(),1,m),Yt(f,t,this._context.elevationProvider),f}_createAsOverlay(e,t,i,s,a,o){i.renderPriority=this._renderPriority;let n=_();Kr(t,n,this._context.overlaySR),n[2]=hn;let l=this._context.clippingExtent;if(l!=null&&!us(l,n))return null;let c=this.getFastUpdateAttrValues(e),h=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:e.uid,layerUid:this._context.layer.uid}),p=Sa(i,jf,n,s,a,null,null,c,h),d=new Mr(p,{layerUid:o,graphicUid:e.uid}),f=new pr(this,[d],null,this._context.drapeSourceRenderer);return f.getScreenSize=this._createScreenSizeGetter(a,c),f.calculateRelativeScreenBounds=m=>i.calculateRelativeScreenBounds(f.getScreenSize(),1,m),f}_createScreenSizeGetter(e,t){let i=this._outlineSize+2;if(this._fastUpdates&&t){let o=e[0]/this._symbolTextureRatio,n=e[1]/this._symbolTextureRatio;return(l=W())=>{let[c,h]=on(Yy,this._fastUpdates.materialParameters,t);return l[0]=c*o+i,l[1]=h*n+i,l}}let s=e[0]/this._symbolTextureRatio+i,a=e[1]/this._symbolTextureRatio+i;return(o=W())=>(o[0]=s,o[1]=a,o)}_fastVisualVariableConvertOptions(){let e=Math.max(this._size[0],this._size[1]),t=Je(e,e,e),i=aa(1),s=e*i,a=Je(s,s,s);return new ar({size:!0,color:!0,rotation:!0,opacity:!1},t,a,i)}_forEachMaterial(e){this._materials.forEach(e),this._cimSymbolMaterials.forEach(e)}test(){return Pe(Z({},super.test()),{material:this._materials[0]})}};function Wy(r){return r&&r.type==="point-3d"&&r.hasVisibleVerticalOffset()}function nh(r){return r!=null&&(r==="cross"||r==="x")}function Hf(r){let e=vp(r);return e?.mediaType==="application/json"?e.data:void 0}function kf(r,e){return r==="relative"?B((e.x||0)+.5,.5-(e.y||0)):r in Bs?Bs[r]:Bs.center}function Wf({parameters:r},e){let t=(r.width??1)/(r.height??1);return t>1?[e,Math.round(e/t)]:[Math.round(e*t),e]}Ns.PRIMITIVE_SIZE=ky,Ns.elevationModeChangeTypes={definedChanged:q.UPDATE,staysOnTheGround:q.NONE,onTheGroundChanged:q.RECREATE};var qy={mode:"relative-to-ground",offset:0},$y=ye(0,0,0,1),Yy=_();function Va(r){switch(r){case"butt":return Fi.BUTT;case"square":return Fi.SQUARE;case"round":return Fi.ROUND;default:return null}}function lh(r){return r==="diamond"?"kite":r}var ch=new Map([[g.POSITION,0],[g.PREVPOSITION,1],[g.UV0,2],[g.NORMAL,3],[g.COLOR,4],[g.COLORFEATUREATTRIBUTE,4],[g.SIZE,5],[g.SIZEFEATUREATTRIBUTE,5],[g.OPACITYFEATUREATTRIBUTE,6]]),Ua=class r extends Gt{initializeProgram(e){return new Mt(e.rctx,r.shader.get().build(this.configuration),ch)}_makePipelineState(e,t){let i=this.configuration,s=e===He.NONE;return Ze({blending:i.output===L.Color?s?sr:ii(e):null,depthTest:i.space===Ui.Draped?null:{func:si(e)},depthWrite:i.space===Ui.Draped?null:s?i.writeDepth?xt:null:Cs(e),drawBuffers:i.output===L.Depth?{buffers:[_s.NONE]}:ai(e),colorWrite:pt,stencilWrite:i.hasOccludees?Gr:null,stencilTest:i.hasOccludees?t?Vi:ni:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=Ze({blending:sr,depthTest:Oc,depthWrite:null,colorWrite:pt,stencilWrite:null,stencilTest:Wu}),this._occluderPipelineOpaque=Ze({blending:sr,depthTest:Oc,depthWrite:null,colorWrite:pt,stencilWrite:Hu,stencilTest:ku}),this._occluderPipelineMaskWrite=Ze({blending:null,depthTest:sn,depthWrite:null,colorWrite:null,stencilWrite:Gr,stencilTest:Vi})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipeline(e,t,i){return e?this._occludeePipelineState:this.configuration.occluder?i?this._occluderPipelineTransparent:t?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}};Ua.shader=new Dt(jm,()=>import("./chunk-YRD2TVZJ.js"));var Un=class extends ri{constructor(e){super(e,new ph),this.produces=new Map([[H.OPAQUE_MATERIAL,t=>t===L.Highlight||Dr(t)&&this.parameters.renderOccluded===va.OccludeAndTransparentStencil],[H.OPAQUE_NO_SSAO_DEPTH,t=>$o(t)],[H.OCCLUDER_MATERIAL,t=>Rc(t)&&this.parameters.renderOccluded===va.OccludeAndTransparentStencil],[H.TRANSPARENT_OCCLUDER_MATERIAL,t=>Rc(t)&&this.parameters.renderOccluded===va.OccludeAndTransparentStencil],[H.TRANSPARENT_MATERIAL,t=>Dr(t)&&this.parameters.writeDepth],[H.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,t=>Dr(t)&&!this.parameters.writeDepth],[H.DRAPED_MATERIAL,t=>t===L.Color||t===L.Highlight]]),this._vertexAttributeLocations=ch,this._configuration=new dm,this._layout=this.createLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.space=t.slot===H.DRAPED_MATERIAL?Ui.Draped:this.parameters.worldSpace?Ui.World:Ui.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==Fi.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===va.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){let e=Lt().vec3f(g.POSITION).vec3f(g.PREVPOSITION).vec2f(g.UV0);return this.parameters.worldSpace&&e.vec3f(g.NORMAL),this.parameters.vvSize?e.f32(g.SIZEFEATUREATTRIBUTE):e.f32(g.SIZE),this.parameters.vvColor?e.f32(g.COLORFEATUREATTRIBUTE):e.vec4f(g.COLOR),this.parameters.vvOpacity&&e.f32(g.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new dh(this._layout,this.parameters)}createGLMaterial(e){return new hh(e)}},hh=class extends Lu{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextures.release(this._markerPrimitive),this._markerPrimitive=null}_updateParameters(e){let t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextures.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(Ua,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output===L.Color&&this._updateOccludeeState(e),this._updateParameters(e)}},ph=class extends nn{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=Fi.BUTT,this.anchor=pm.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1,this.markerTexture=null}},dh=class{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t}elementCount(){return this._parameters.placement==="begin-end"?12:6}write(e,t,i,s,a){let o=i.attributes.get(g.POSITION).data,n=o.length/3,l=[1,0,0],c=i.attributes.get(g.NORMAL);this._parameters.worldSpace&&c!=null&&(l=c.data);let h=1,p=0;this._parameters.vvSize?p=i.attributes.get(g.SIZEFEATUREATTRIBUTE).data[0]:i.attributes.has(g.SIZE)&&(h=i.attributes.get(g.SIZE).data[0]);let d=[1,1,1,1],f=0;this._parameters.vvColor?f=i.attributes.get(g.COLORFEATUREATTRIBUTE).data[0]:i.attributes.has(g.COLOR)&&(d=i.attributes.get(g.COLOR).data);let m=0;this._parameters.vvOpacity&&(m=i.attributes.get(g.OPACITYFEATUREATTRIBUTE).data[0]);let y=new Float32Array(s.buffer),b=a*(this.vertexBufferLayout.stride/4),S=(C,P,T,D)=>{if(y[b++]=C[0],y[b++]=C[1],y[b++]=C[2],y[b++]=P[0],y[b++]=P[1],y[b++]=P[2],y[b++]=T[0],y[b++]=T[1],this._parameters.worldSpace&&(y[b++]=l[0],y[b++]=l[1],y[b++]=l[2]),this._parameters.vvSize?y[b++]=p:y[b++]=h,this._parameters.vvColor)y[b++]=f;else{let I=Math.min(4*D,d.length-4);y[b++]=d[I],y[b++]=d[I+1],y[b++]=d[I+2],y[b++]=d[I+3]}this._parameters.vvOpacity&&(y[b++]=m)},x;(function(C){C[C.ASCENDING=1]="ASCENDING",C[C.DESCENDING=-1]="DESCENDING"})(x||(x={}));let w=(C,P)=>{let T=A(Zy,o[3*C],o[3*C+1],o[3*C+2]),D=Qy,I=C+P;do A(D,o[3*I],o[3*I+1],o[3*I+2]),I+=P;while(Mp(T,D)&&I>=0&&I<n);e&&(X(T,T,e),X(D,D,e)),S(T,D,[-1,-1],C),S(T,D,[1,-1],C),S(T,D,[1,1],C),S(T,D,[-1,-1],C),S(T,D,[1,1],C),S(T,D,[-1,1],C)},E=this._parameters.placement;E!=="begin"&&E!=="begin-end"||w(0,x.ASCENDING),E!=="end"&&E!=="begin-end"||w(n-1,x.DESCENDING)}},Zy=_(),Qy=_();var Jy=["polyline","polygon","extent"],qf=new ar({size:!0,color:!0,rotation:!1,opacity:!0}),Ba=class r extends Se{constructor(e,t,i,s){super(e,t,i,s)}doLoad(){return O(this,null,function*(){if(this._fastUpdates=kt(this._context.renderer,qf),!this._drivenProperties.size&&(this.symbolLayer.size!=null?this.symbolLayer.size:aa(1))<0)throw new _e("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values")})}_getMaterialParameters(e,t=!1){let i=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);this._patternHidesLine&&!t&&(i[3]=0);let s={width:this._computeMaterialWidth(this.symbolLayer?.size),color:i,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:Va(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:dn(this.symbolLayer.pattern)};return this._fastUpdates?.visualVariables?Z(Z({},s),this._fastUpdates.materialParameters):s}get _materialColor(){return this.symbolLayer.material?.color}get _markerColor(){return this.symbolLayer.marker?.color}get _lineMaterial(){return this._materials[se.Line]==null&&(this._materials[se.Line]=new Bi(this._getMaterialParameters(!1)),this._context.stage.add(this._materials[se.Line])),this._materials[se.Line]}get _ringMaterial(){return this._materials[se.Ring]==null&&(this._materials[se.Ring]=new Bi(this._getMaterialParameters(!0)),this._context.stage.add(this._materials[se.Ring])),this._materials[se.Ring]}get _wireframeLineMaterial(){return this._materials[se.LineWireframe]==null&&(this._materials[se.LineWireframe]=new Bi(Pe(Z({},this._getMaterialParameters(!1)),{wireframe:!0})),this._context.stage.add(this._materials[se.LineWireframe])),this._materials[se.LineWireframe]}get _wireframeRingMaterial(){return this._materials[se.RingWireframe]==null&&(this._materials[se.RingWireframe]=new Bi(Pe(Z({},this._getMaterialParameters(!0)),{wireframe:!0})),this._context.stage.add(this._materials[se.RingWireframe])),this._materials[se.RingWireframe]}get _markerMaterial(){return this._materials[se.Marker]==null&&this.symbolLayer.marker!=null&&(this._materials[se.Marker]=new Un(Pe(Z({},this._getMaterialParameters(!1,!0)),{placement:this.symbolLayer.marker.placement,markerPrimitive:lh(this.symbolLayer.marker.style)})),this._context.stage.add(this._materials[se.Marker])),this._materials[se.Marker]}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._materials.length=0}_getDrivenSize(e){return this._drivenProperties.size&&e.size?be(Km(e.size)):1}_getDrivenColor(e){let t=ye(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Jy,this.symbolLayer.type))return null;let i=this.setGraphicElevationContext(t);return this.ensureDrapedStatus(i.mode==="on-the-ground"),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)}applyRendererDiff(e,t){for(let i in e.diff){if(i!=="visualVariables")return N.RecreateSymbol;{let s=this._fastUpdates;if(!Wt(s,t,qf))return N.RecreateSymbol;this._forEachMaterial(a=>a?.setParameters(s.materialParameters))}}return N.FastUpdate}prepareSymbolLayerPatch(e){if(e.diff.type!=="partial")return;let t=e.diff.diff,i={};t.size?.type==="complete"&&(i.width=this._computeMaterialWidth(t.size.newValue),delete t.size),t.cap?.type==="complete"&&(i.cap=Va(t.cap.newValue??"butt"),delete t.cap);let s=this._prepareMarkerPatch(e,t);this._prepareMaterialPatch(e,t,s),e.symbolLayerStatePatches.push(()=>this._forEachMaterial(a=>a?.setParameters(i)))}layerOpacityChanged(){this._forEachMaterial((e,t)=>this._updateMaterialLayerOpacity(e,t===se.Marker))}_forEachMaterial(e){this._materials.forEach(e)}_updateMaterialLayerOpacity(e,t=!1){if(e==null)return;let i=e.parameters.color,s=this.symbolLayer?.material?.color,a=this._patternHidesLine&&!t?0:this._getCombinedOpacity(s),o=ye(i[0],i[1],i[2],a);e.setParameters({color:o})}layerElevationInfoChanged(e,t,i){let s=this._elevationContext.mode,a=nr(r.elevationModeChangeTypes,i,s);if(a!==q.UPDATE)return a;let o=Be(s);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>o)}slicePlaneEnabledChanged(){let e={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial(t=>t?.setParameters(e)),!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,i){let s=$f(e.graphic.geometry),a=s.type==="polygon"?s.rings:s.paths,o=new Array,n=K(),l=Im(s,this._context.elevationProvider,this._context.renderCoordsHelper,t),c=s.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(l,a,c,"LineSymbol3DLayer");for(let d=0;d<l.lines.length;d++){let f=l.lines[d],m=f.position,y=f.mapPositions;if(this._context.clippingExtent!=null&&(F(n),Ge(n,y),!ze(n,this._context.clippingExtent)))continue;let b=this._createGeometry(s.type==="polygon"?this._ringMaterial:this._lineMaterial,e,m,y,s.type,Fa.ELEVATED,i);o.push(b),Te.LINE_WIREFRAMES&&o.push(b.instantiate({material:s.type==="polygon"?this._wireframeRingMaterial:this._wireframeLineMaterial})),this._markerMaterial!=null&&o.push(b.instantiate({material:this._markerMaterial}))}if(o.length===0)return null;let h=new dt({geometries:o,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:i}),p=new xe(this,h,o,null,null,cf,t);return p.alignedSampledElevation=l.sampledElevation,p.needsElevationUpdates=Be(t.mode),p}_createGeometry(e,t,i,s,a,o,n){let l=o===Fa.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,c=a==="polygon",h=this._fastUpdates?.visualVariables.color,p=this._fastUpdates?.visualVariables.size,d=this._fastUpdates?.visualVariables.opacity,f=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerUid:this._context.layer.uid}),m={position:i,size:p?null:this._getDrivenSize(t.renderingInfo),color:h?null:this._getDrivenColor(t.renderingInfo),sizeFeature:p?tt(p.field,t.graphic):null,colorFeature:h?tt(h.field,t.graphic):null,opacityFeature:d?tt(d.field,t.graphic):null};return Ea(e,{overlayInfo:l,removeDuplicateStartEnd:c,mapPositions:s,attributeData:m},f)}_createAsOverlay(e,t){let i=e.graphic,s=$f(i.geometry),a=s.type==="polygon"?s.rings:s.paths,o=s.type==="polygon"?this._ringMaterial:this._lineMaterial;o.renderPriority=this._renderPriority;let n=Te.LINE_WIREFRAMES?s.type==="polygon"?this._wireframeRingMaterial:this._wireframeLineMaterial:null,l=this._markerMaterial;n!=null&&(n.renderPriority=this._renderPriority-.001),l!=null&&(l.renderPriority=this._renderPriority-.002);let c=new Array,h=K(),p=F(),d=Dm(s,this._context.overlaySR),f=s.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(d,a,f,"LineSymbol3DLayer");for(let m of d.lines){if(F(h),Ge(h,m.position),!ze(h,this._context.clippingExtent))continue;Ar(p,h);let y=b=>{let S=this._createGeometry(b,e,m.position,void 0,s.type,Fa.DRAPED,i.uid),x=new Mr(S,{layerUid:t,graphicUid:i.uid});c.push(x)};if(l!=null){y(l);let b=this.symbolLayer.marker.placement;b!=="begin"&&b!=="begin-end"||Ge(h,m.position,0,1),b!=="end"&&b!=="begin-end"||Ge(h,m.position,m.position.length-3,1)}y(o),Te.LINE_WIREFRAMES&&y(n)}return new pr(this,c,p,this._context.drapeSourceRenderer)}get _patternHidesLine(){let e=this.symbolLayer.pattern;return e!=null&&e.type==="style"&&e.style==="none"}_computeMaterialWidth(e){return e=e??aa(1),this._drivenProperties.size?this._fastUpdates?.visualVariables.size?be(1):1:be(e)}_prepareMaterialPatch(e,t,i){let s=t.material;if(s==null)return void(i.changed&&i.useMaterialColor&&Fn(this._getCombinedOpacityAndColor(this._materialColor),this._materials[se.Marker],e));if(s.type==="collection")return;let a=s.type==="complete"?s.newValue?.color:s.diff.color?.type==="complete"?s.diff.color.newValue:null,o=this._getCombinedOpacityAndColor(a);i.useMaterialColor&&Fn(ad(o),this._materials[se.Marker],e),this._patternHidesLine&&(o[3]=0),Fn(o,this._materials[se.Line],e),delete t.material}_prepareMarkerPatch(e,t){let i=t.marker,s=this._markerMaterial;if(i==null||i.type!=="partial"||i.diff==null||i.diff.placement!=null||i.diff.style!=null&&i.diff.style.type!=="complete"||i.diff.color!=null&&i.diff.color.type!=="complete"||s==null)return{changed:!1,useMaterialColor:this._markerColor==null};let a=i.diff.color,o=a!=null,n=o?a.newValue:null,l=n==null&&this._markerColor==null;n&&Fn(this._getCombinedOpacityAndColor(n),s,e);let c=i.diff.style?.newValue;return c&&e.symbolLayerStatePatches.push(()=>s.setParameters({markerPrimitive:lh(c)})),delete t.marker,{changed:o,useMaterialColor:l}}};function $f(r){switch(r.type){case"extent":if(r instanceof cs)return ds.fromExtent(r);break;case"polygon":case"polyline":return r}return null}function Fn(r,e,t){e!=null&&t.symbolLayerStatePatches.push(()=>e.setParameters({color:r}))}var Fa,se;Ba.elevationModeChangeTypes={definedChanged:q.RECREATE,staysOnTheGround:q.NONE,onTheGroundChanged:q.RECREATE},function(r){r[r.DRAPED=0]="DRAPED",r[r.ELEVATED=1]="ELEVATED"}(Fa||(Fa={})),function(r){r[r.Line=0]="Line",r[r.Ring=1]="Ring",r[r.LineWireframe=2]="LineWireframe",r[r.RingWireframe=3]="RingWireframe",r[r.Marker=4]="Marker"}(se||(se={}));var Yf={disableDelayMs:2e3};var Bn=class extends xe{constructor(){super(...arguments),this.fastTransformUpdatesAllowed=!1,this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1,this._autoDisableFastUpdatesTimeoutId=0}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}destroy(){super.destroy(),this._cancelAutoDisableFastUpdates()}enableFastTransformUpdates(e,t){if(!this.fastTransformUpdatesAllowed||this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!0;let{stageObject:i}=this,s=i.geometries.slice();i.removeAllGeometries();let a=oa(uh,i.transformation),o=t.getOrigin(a);for(let n of s){let l=e(n.material),c=n.instantiate({material:l});c.localOrigin=o,i.addGeometry(c)}this._originalGeometries=s}autoDisableFastTransformUpdates(e){this._cancelAutoDisableFastUpdates(),this._autoDisableFastUpdatesTimeoutId=setTimeout(()=>{this._autoDisableFastUpdatesTimeoutId=0,e()},Yf.disableDelayMs)}updateAutoDisableFastTransformUpdates(e){this._autoDisableFastUpdatesTimeoutId&&this.autoDisableFastTransformUpdates(e)}_cancelAutoDisableFastUpdates(){clearTimeout(this._autoDisableFastUpdatesTimeoutId),this._autoDisableFastUpdatesTimeoutId=0}disableFastTransformUpdates(e){if(!this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!1;let{stageObject:t}=this,i=t.geometries.map(s=>e(s.material));t.removeAllGeometries();for(let s=0;s<this._originalGeometries.length;s++){let a=this._originalGeometries[s],o=i[s];o.setParameters({modelTransformation:null}),o===a.material?t.addGeometry(a):t.addGeometry(a.instantiate({material:o}))}this._originalGeometries.length=0}updateFastLocalOrigin(e,t,i){if(!this._fastTransformUpdatesEnabled)return;let{stageObject:s}=this;if(s.geometries.length===0)return;let a=s.geometries[0].localOrigin,o=oa(uh,e),n=i.getOrigin(o);if(n===a)return;let l=t?.localMatrix??Li;s.shaderTransformation=null,s.transformation=e,s.geometries.forEach(c=>{c.transformation=l,c.localOrigin=n})}updateTransform(e,t,i){let{stageObject:s}=this,a=t?.localMatrix??Li;if(!this._fastTransformUpdatesEnabled)return s.shaderTransformation=null,s.transformation=e,s.geometries.forEach(f=>f.transformation=a),void this._updateEdgeTransform(i);let o=s.transformation,n=s.geometries[0].transformation,l=e,c=a,h=_t(Zf,o,n),p=_t(Qf,l,c),d=_t(Jf,p,wr(Jf,n));s.shaderTransformation=d,this._setFastMaterialTransformation({matA:h,matB:p}),this._updateEdgeTransform(i)}alignWithElevation(e,t,i,s){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(e,t,i,s);i!=null&&Rs(this.elevationContext.featureExpressionInfoContext,i);let a=(m,y)=>Ct(m,e,this.elevationContext,t,y),{stageObject:o}=this;if(!o.geometries[0].material.parameters.modelTransformation)return;let n=o.transformation,l=o.geometries[0].transformation,c=_t(Zf,n,l),h=o.effectiveTransformation,p=$r(Xy,h);this.alignedSampledElevation=Ft(this,this.elevationContext,e.spatialReference,a,t,p),o.shaderTransformation=p;let d=o.geometries[0].transformation,f=_t(Qf,p,d);this._setFastMaterialTransformation({matA:c,matB:f}),this._updateEdgeTransform(s)}_setFastMaterialTransformation({matA:e,matB:t}){let{stageObject:i}=this;if(i.geometries.length===0)return;let s=i.geometries[0].localOrigin,a=Po(Ky,k(uh,s.vec3,-1)),o=_t(Xf,a,e),n=_t(Kf,a,t),l=wr(Xf,o),c=_t(Kf,n,l);for(let h of i.geometries)h.material.setParameters({modelTransformation:c})}_updateEdgeTransform(e){let{stageObject:t,_stageLayer:i}=this;i.stage.renderer.withEdgeView(s=>{s.fastUpdateObject3DEdgesTransform(t)||this.resetEdgeObject(e)})}},uh=_(),Zf=V(),Qf=V(),Xy=V(),Jf=V(),Xf=V(),Kf=V(),Ky=V();var Nn=class{constructor(){this._fastTransformOriginalMaterials=new Map,this._fastTransformClonedMaterials=new Map,this._graphicReferenceCount=0}enable(e,t,i){e.enableFastTransformUpdates(s=>{if(this._graphicReferenceCount<=1){if(this._fastTransformOriginalMaterials.has(s))return s;let o=t.byMaterial(s);return this._fastTransformOriginalMaterials.set(s,o),t.delete(s),s}let a=new St(s.parameters);return i.stage.add(a),this._fastTransformClonedMaterials.set(a,s),a},i.localOriginFactory)}disable(e,t,i){let s=new Set,a=new Set;e.disableFastTransformUpdates(o=>{if(!this._fastTransformClonedMaterials.has(o)){let c=o,h=this._fastTransformOriginalMaterials.get(c);return t.has(h.uid)?(s.add(c),t.byUid(h.uid).material):(a.add(c),h.material)}let n=o,l=this._fastTransformClonedMaterials.get(n);return this._fastTransformClonedMaterials.delete(n),i.stage.remove(n),l});for(let o of s)this._fastTransformOriginalMaterials.delete(o),i.stage.remove(o);for(let o of a){let n=this._fastTransformOriginalMaterials.get(o);this._fastTransformOriginalMaterials.delete(o),t.set(n.uid,n)}}onAddGraphic(){this._graphicReferenceCount++}onRemoveGraphic(e,t,i){this._graphicReferenceCount--,this.disable(e,t,i)}forEachMaterialInfo(e){this._fastTransformOriginalMaterials.forEach(e)}forEachClonedMaterial(e){this._fastTransformClonedMaterials.forEach(e)}destroy(e){e.removeMany(Array.from(this._fastTransformClonedMaterials.keys())),e.removeMany(Array.from(this._fastTransformOriginalMaterials.values(),({material:t})=>t)),this._fastTransformClonedMaterials.clear(),this._fastTransformOriginalMaterials.clear()}},zn=class{constructor(){this._byUid=new Map,this._byMaterial=new Map}get materials(){return Array.from(this._byUid.values(),e=>e.material)}byUid(e){return this._byUid.get(e)}byMaterial(e){return this._byMaterial.get(e)}set(e,t){this._byUid.set(e,t),this._byMaterial.set(t.material,t)}delete(e){let t=this._byMaterial.get(e)?.uid;t&&(this._byUid.delete(t),this._byMaterial.delete(e))}has(e){return this._byUid.has(e)}forEachMaterialInfo(e){this._byUid.forEach(e)}clear(){this._byUid.clear(),this._byMaterial.clear()}};var Na=class r extends Gt{initializeProgram(e){return new Mt(e.rctx,r.shader.get().build(this.configuration),Ht)}initializePipeline(){let e=this.configuration,t=Ko(tr.SRC_ALPHA,tr.ONE,tr.ONE_MINUS_SRC_ALPHA,tr.ONE_MINUS_SRC_ALPHA),i=(s,a=null,o=null)=>Ze({blending:a,depthTest:sn,depthWrite:o,colorWrite:pt,stencilWrite:e.hasOccludees?Gr:null,stencilTest:e.hasOccludees?s?Vi:ni:null});return e.output===L.Color?(this._occludeePipelineState=i(!0,e.transparent?t:null,xt),i(!1,e.transparent?t:null,xt)):i(!1)}get primitiveType(){return Sd.LINES}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}};Na.shader=new Dt(Hm,()=>import("./chunk-Q7ZR4OVE.js"));var Nr=class extends or{constructor(){super(...arguments),this.output=L.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.hasOccludees=!1}};u([R({count:L.COUNT})],Nr.prototype,"output",void 0),u([R()],Nr.prototype,"hasSlicePlane",void 0),u([R()],Nr.prototype,"hasVertexColors",void 0),u([R()],Nr.prototype,"transparent",void 0),u([R()],Nr.prototype,"hasOccludees",void 0);var zs=class extends ri{constructor(e){super(e,new bh),this._configuration=new Nr,this.produces=new Map([[H.OPAQUE_MATERIAL,t=>t===L.Color||t===L.Highlight||t===L.ObjectAndLayerIdColor]])}getConfiguration(e){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration}intersect(e,t,i,s,a,o){if(!i.options.selectionMode||!e.visible)return;if(!xd(t))return void Q.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");let n=e.attributes.get(g.POSITION).data,l=i.camera,c=t_;To(c,i.point);let h=2;A(za[0],c[0]-h,c[1]+h,0),A(za[1],c[0]+h,c[1]+h,0),A(za[2],c[0]+h,c[1]-h,0),A(za[3],c[0]-h,c[1]-h,0);for(let y=0;y<4;y++)if(!l.unprojectFromRenderScreen(za[y],zr[y]))return;fa(l.eye,zr[0],zr[1],mh),fa(l.eye,zr[1],zr[2],fh),fa(l.eye,zr[2],zr[3],gh),fa(l.eye,zr[3],zr[0],yh);let p=Number.MAX_VALUE,d=0;for(let y=0;y<n.length-5;y+=3){if(ot[0]=n[y]+t[12],ot[1]=n[y+1]+t[13],ot[2]=n[y+2]+t[14],nt[0]=n[y+3]+t[12],nt[1]=n[y+4]+t[13],nt[2]=n[y+5]+t[14],Ye(mh,ot)<0&&Ye(mh,nt)<0||Ye(fh,ot)<0&&Ye(fh,nt)<0||Ye(gh,ot)<0&&Ye(gh,nt)<0||Ye(yh,ot)<0&&Ye(yh,nt)<0)continue;if(l.projectToRenderScreen(ot,$i),l.projectToRenderScreen(nt,Yi),$i[2]<0&&Yi[2]>0){de(dr,ot,nt);let S=l.frustum,x=-Ye(S[je.NEAR],ot)/z(dr,S[je.NEAR]);k(dr,dr,x),le(ot,ot,dr),l.projectToRenderScreen(ot,$i)}else if($i[2]>0&&Yi[2]<0){de(dr,nt,ot);let S=l.frustum,x=-Ye(S[je.NEAR],nt)/z(dr,S[je.NEAR]);k(dr,dr,x),le(nt,nt,dr),l.projectToRenderScreen(nt,Yi)}else if($i[2]<0&&Yi[2]<0)continue;$i[2]=0,Yi[2]=0;let b=bu(vs($i,Yi,rg),c);b<p&&(p=b,te(eg,ot),te(tg,nt),d=y/3)}let f=i.rayBegin,m=i.rayEnd;if(p<h*h){let y=Number.MAX_VALUE;if(vu(vs(eg,tg,rg),vs(f,m,e_),qi)){de(qi,qi,f);let b=Kt(qi);k(qi,qi,1/b),y=b/ia(f,m)}o(y,qi,d,!1)}}intersectDraped(e,t,i,s,a,o){if(!i.options.selectionMode)return;let n=e.attributes.get(g.POSITION).data,l=e.attributes.get(g.SIZE),c=l?l.data[0]:0,h=s[0],p=s[1],d=((c+1)/2+4)*e.screenToWorldRatio,f=Number.MAX_VALUE,m=0;for(let y=0;y<n.length-5;y+=3){let b=n[y],S=n[y+1],x=h-b,w=p-S,E=n[y+3]-b,C=n[y+4]-S,P=Ri((E*x+C*w)/(E*E+C*C),0,1),T=E*P-x,D=C*P-w,I=T*T+D*D;I<f&&(f=I,m=y/3)}f<d*d&&a(o.dist,o.normal,m,!1)}createGLMaterial(e){return new _h(e)}createBufferWriter(){let e=this.parameters.hasVertexColors?Fm:Vm;return new oi(e)}},_h=class extends ir{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output===L.Color&&this._updateOccludeeState(e),this.ensureTechnique(Na,e)}},bh=class extends Ss{constructor(){super(...arguments),this.color=jt,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.hasOccludees=!1}},ot=_(),nt=_(),dr=_(),qi=_(),$i=Oi(),Yi=Oi(),eg=_(),tg=_(),rg=ga(),e_=ga(),t_=_(),za=[Oi(),Oi(),Oi(),Oi()],zr=[_(),_(),_(),_()],mh=vt(),fh=vt(),gh=vt(),yh=vt();var r_=["mesh"],kn=class extends Se{constructor(e,t,i,s){super(e,t,i,s),this._materialInfoCache=new zn,this._fastUpdateProcessor=new Nn,this._textures=new Map,this.ensureDrapedStatus(!1)}doLoad(){return O(this,null,function*(){Te.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new zs({color:[1,0,1,1]}),this._debugTangentNormalMaterial=new zs({color:[1,.5,0,1]}),this._debugFaceNormalMaterial=new zs({color:[0,1,1,1]}))})}destroy(){super.destroy(),this._textures.forEach(e=>e.unload()),this._context.stage.removeMany(this._materialInfoCache.materials),this._context.stage.removeMany(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy(this._context.stage)}get materials(){return this._materialInfoCache.materials}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,r_,"fill on mesh-3d"))return null;let i=this.setGraphicElevationContext(t),s=e.renderingInfo;return this._createAs3DShape(t,s,i,t.uid)}onRemoveGraphic(e){this._fastUpdateProcessor.onRemoveGraphic(e,this._materialInfoCache,this._context)}layerOpacityChanged(e,t){let i=this._getLayerOpacity();this._updateMaterialParameters(s=>{s.material.setParameters({layerOpacity:i});let a=s.material.parameters;this._setMaterialTransparentParameter(a,s),s.material.setParameters({transparent:a.transparent})}),e.forEach(s=>t(s)?.layerOpacityChanged(i,this._context.isAsync))}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Vt)}slicePlaneEnabledChanged(e,t){return this._updateMaterialParameters(({material:i})=>{i.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),e.forEach(i=>t(i)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)),!0}physicalBasedRenderingChanged(){let e=this._usePBR();return this._updateMaterialParameters(({material:t})=>t.setParameters({usePBR:e})),!0}updateTransform(e,t,i,s){if(!e.fastTransformUpdatesAllowed)return!1;let a=e.fastTransformUpdatesEnabled;switch(s){case Ur.EnableFastUpdates:if(a)return!0;break;case Ur.DisableFastUpdates:if(!a)return!0;break;default:if(!a)return!!this.updateTransform(e,t,i,Ur.EnableFastUpdates)&&(e.autoDisableFastTransformUpdates(()=>this.updateTransform(e,t,i,Ur.DisableFastUpdates)),!0)}let o=this._context.renderCoordsHelper.spatialReference,n=m_,{origin:l,transform:c}=i;if(!bt(t,A($,l.x,l.y,l.z??0),n,o))return!1;switch(s){case Ur.EnableFastUpdates:this._fastUpdateProcessor.enable(e,this._materialInfoCache,this._context);break;case Ur.DisableFastUpdates:this._fastUpdateProcessor.disable(e,this._materialInfoCache,this._context);break;case Ur.UpdateFastLocalOrigin:e.updateFastLocalOrigin(n,c,this._context.localOriginFactory)}let{elevationContext:h}=e;h.centerPointInElevationSR=this._getCenterPointInElevationSR(n);let{elevationProvider:p,renderCoordsHelper:d}=this._context,f=(m,y)=>Ct(m,p,h,d,y);return e.alignedSampledElevation=Ft(e,h,p.spatialReference,f,d,n),e.updateTransform(n,c,this._context.isAsync),e.updateAutoDisableFastTransformUpdates(()=>this.updateTransform(e,t,i,Ur.DisableFastUpdates)),!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_materialPropertiesDefault(e,t){let i=this._requiresSymbolVertexColors(),s=!!e.vertexAttributes.color,a=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:s,hasVertexTangents:a,uid:`vc:${s},vt:${a},vct${t},svc:${i}`}}_materialProperties(e,t,i){let s=this._materialPropertiesDefault(e,i);if(!t.material)return s;let{color:a,colorTexture:o,colorTextureTransform:n,normalTexture:l,normalTextureTransform:c,doubleSided:h,alphaCutoff:p,alphaMode:d}=t.material,f=Zi(a),m=Zi(o),y=Ha(n),b=Zi(l),S=Ha(c);if(s.color=a,s.colorTexture=o,s.normalTexture=l,s.uid=`${s.uid},cmuid:${f},ctmuid:${m},cttuid:${y},ntmuid:${b},nttuid:${S},ds:${h},ac:${p},am:${d}`,t.material instanceof lu){let{metallic:x,roughness:w,metallicRoughnessTexture:E,metallicRoughnessTextureTransform:C,emissiveColor:P,emissiveTexture:T,emissiveTextureTransform:D,occlusionTexture:I,occlusionTextureTransform:G}=t.material,ne=Zi(E),U=Ha(C),he=Zi(P),pe=Zi(T),wt=Ha(D),Si=Zi(I),Wr=Ha(G);s.metallic=x,s.roughness=w,s.metallicRoughnessTexture=E,s.emissiveColor=P,s.emissiveTexture=T,s.occlusionTexture=I,s.colorTextureTransform=ja(n),s.normalTextureTransform=ja(c),s.emissiveTextureTransform=ja(D),s.occlusionTextureTransform=ja(G),s.metallicRoughnessTextureTransform=ja(C),s.uid=`${s.uid},mrm:${x},mrr:${w},mrt:${ne},mrtt:${U},emuid:${he},etmuid:${pe},ett:${wt},otmuid:${Si},ott:${Wr}`}return s}_getInternalTextureId(e){return this._getInternalTexture(e,ei.Opaque)?.id}_getInternalTexture(e,t){let i=p_(e);if(!i)return null;let s=`${e.contentHash}/${t}`,a=this._textures.get(s);if(!a){let o=null,n=this._context.stage.renderView.renderingContext.parameters.maxMaxAnisotropy,l={wrap:l_(e.wrap),noUnpackFlip:!0,maxAnisotropy:n,mipmap:n>1};yu(i)?(o=i.data,l.preMultiplyAlpha=!1,l.encoding=i.encoding):(o=i,l.preMultiplyAlpha=t!==ei.Opaque,l.downsampleUncompressed=this._context.graphicsCoreOwner.view.qualitySettings.graphics3D.uncompressedTextureDownsamplingEnabled),a=new Mi(o,l),this._textures.set(s,a),a.load(this._context.stage.renderView.renderingContext),this._context.stage.add(a)}return a}_setInternalMaterialParameters(e,t){if(e.color!=null&&h_(e.color,t),e.colorTexture!=null){let s=this._getInternalTexture(e.colorTexture,t.textureAlphaMode);s?(t.textureId=s.id,t.textureAlphaPremultiplied=!!s.parameters.preMultiplyAlpha):t.textureId=void 0}e.normalTexture&&(t.normalTextureId=this._getInternalTextureId(e.normalTexture)),e.emissiveColor&&(t.emissiveFactor=re.toUnitRGB(e.emissiveColor)),e.emissiveTexture&&(t.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),e.occlusionTexture&&(t.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),e.metallicRoughnessTexture&&(t.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture)),t.colorTextureTransformMatrix=xs(e.colorTextureTransform),t.normalTextureTransformMatrix=xs(e.normalTextureTransform);let i=e.normalTextureTransform?.scale!=null?e.normalTextureTransform?.scale:bd;t.scale=[i[0],i[1]],t.occlusionTextureTransformMatrix=xs(e.occlusionTextureTransform),t.emissiveTextureTransformMatrix=xs(e.emissiveTextureTransform),t.metallicRoughnessTextureTransformMatrix=xs(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(e){let t=this._drivenProperties.color,i=this.symbolLayer.material?.colorMixMode??null;if(t)e.externalColor=jt;else{let s=this.symbolLayer.material?.color??null;s?e.externalColor=re.toUnitRGBA(s):(i=null,e.externalColor=jt)}i&&(e.colorMixMode=i),e.castShadows=!!this.symbolLayer.castShadows}_getOrCreateMaterial(e,t){let i=t.material?.color,s=t.material?.colorTexture,a=t.material?.alphaMode,o=a==="blend",n=a!=="opaque"&&(c_(e)||i!=null&&i.a<1||s?.transparent||o),l=this._materialProperties(e,t,n),c=this._materialInfoCache.byUid(l.uid);if(c)return c.material;let h={uid:l.uid,material:null,isComponentTransparent:n,alphaMode:t.material?t.material.alphaMode:"opaque"},p=qu({normalTexture:l.normalTexture,metallicRoughnessTexture:l.metallicRoughnessTexture,metallicFactor:l.metallic,roughnessFactor:l.roughness,emissiveTexture:l.emissiveTexture,emissiveFactor:re.toUnitRGB(l.emissiveColor),occlusionTexture:l.occlusionTexture}),d={usePBR:this._usePBR(),isSchematic:p,hasVertexColors:l.hasVertexColors,hasSymbolColors:l.hasSymbolVertexColors,hasVertexTangents:l.hasVertexTangents,ambient:hs,diffuse:Or,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:Re.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};d.mrrFactors=p?[...an]:[l.metallic,l.roughness,$u[2]],t.material&&(d.doubleSided=t.material.doubleSided,d.cullFace=t.material.doubleSided?Re.None:Re.Back,d.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(d),this._setMaterialTransparentParameter(d,h),this._setInternalMaterialParameters(l,d);let f=new St(d);return h.material=f,this._materialInfoCache.set(l.uid,h),this._context.stage.add(f),f}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,t.alphaMode==="auto"?e.textureAlphaMode=e.transparent?ei.MaskBlend:ei.Opaque:e.textureAlphaMode=t.alphaMode==="opaque"?ei.Opaque:t.alphaMode==="mask"?ei.Mask:ei.Blend}_createFaceDebugNormals(e,t){let i=t.length,s=e.spatialReference.isGeographic?20015077/180:1,a=.1*Math.max(e.extent.width*s,e.extent.height*s,e.extent.zmax-e.extent.zmin),o=[],n=[],l=t[0].transformation,c=ha(Ti(),l);for(let h=0;h<i;h++){let p=t[h].attributes.get(g.POSITION);if(!p)continue;let d=p.data,f=p.indices;for(let m=0;m<f.length;m+=3)Wn(d,f,m,ur),ag(d,f,m,$,Bt,js),le($,$,Bt),le($,$,js),k($,$,1/3),X($,$,l),o.push(...$),Jl(ur,ur,c),J(ur,ur),ps($,$,ur,a),o.push(...$),n.push(n.length),n.push(n.length)}return o.length?new ht(this._debugFaceNormalMaterial,[[g.POSITION,new j(o,n,3,!0)]],null,et.Line):null}_createPerVertexDebugVectors(e,t,i,s,a){let o=t.length,n=e.spatialReference.isGeographic?20015077/180:1,l=.1*a*Math.max(e.extent.width*n,e.extent.height*n,e.extent.zmax-e.extent.zmin),c=[],h=[],p=t[0].transformation,d=ha(Ti(),p);i===g.TANGENT&&Fo(d,p);for(let f=0;f<o;f++){let m=t[f],y=m.attributes.get(g.POSITION),b=m.attributes.get(i);if(!y||!b)continue;let S=y.data,x=y.indices,w=b.data,E=b.indices;for(let C=0;C<x.length;C++){let P=3*x[C],T=E[C]*b.stride;A($,S[P+0],S[P+1],S[P+2]),X($,$,p),c.push(...$),A(Bt,w[T+0],w[T+1],w[T+2]),Jl(Bt,Bt,d),J(Bt,Bt),ps($,$,Bt,l),c.push(...$),h.push(h.length),h.push(h.length)}}return c.length?new ht(s,[[g.POSITION,new j(c,h,3,!0)]],null,et.Line):null}_createAs3DShape(e,t,i,s){let a=e.geometry;if(a.type!=="mesh")return null;let o=this._createGeometryInfo(a,t,s);if(o==null)return null;let{geometries:n,objectTransformation:l}=o;if(Te.DRAW_MESH_GEOMETRY_NORMALS){let b=this._createPerVertexDebugVectors(a,n,g.NORMAL,this._debugVertexNormalMaterial,1),S=this._createPerVertexDebugVectors(a,n,g.TANGENT,this._debugTangentNormalMaterial,.5),x=this._createFaceDebugNormals(a,n);b&&n.push(b),S&&n.push(S),x&&n.push(x)}let c=new dt({geometries:n,layerUid:this._context.layer.uid,graphicUid:s,isElevationSource:!0});c.transformation=l;let h=Zo(this.symbolLayer,{opacity:this._getLayerOpacity()}),p=h?new Pn(n[0].material,[h],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null,d=new Bn(this,c,n,null,null,Ft,i,p);this._fastUpdateProcessor.onAddGraphic(),d.needsElevationUpdates=Vt(i.mode),d.useObjectOriginAsAttachmentOrigin=!0,d.fastTransformUpdatesAllowed=this._fastTransformUpdatesAllowed(a),i.centerPointInElevationSR=this._getCenterPointInElevationSR(c.transformation);let{elevationProvider:f,renderCoordsHelper:m}=this._context,y=(b,S)=>Ct(b,f,i,m,S);return d.alignedSampledElevation=Ft(d,i,f.spatialReference,y,m),d}_fastTransformUpdatesAllowed(e){let{vertexSpace:t,spatialReference:i}=e;if(!Id(t))return!1;let{type:s}=t,{view:a}=this._context.graphicsCoreOwner,{viewingMode:o}=a.state,n=a.spatialReference;return o===Me.Global&&s==="local"||o===Me.Local&&Rr(n,i)&&s==="georeferenced"&&!i.isGeographic}_getCenterPointInElevationSR(e){let t=Di(0,0,0,this._context.elevationProvider.spatialReference!=null?this._context.elevationProvider.spatialReference:null);return Nm([e[12],e[13],e[14]],this._context.renderCoordsHelper.spatialReference,t),t}_passthroughReprojectionInfo(e){return e.reprojection===mt.NONE&&!!e.objectTransformation}_createPositionBuffer(e,t){let i=e.vertexAttributes.position,s=i,a=null;if(t.reprojection===mt.NONE)return{position:s,georeferencedPositionBuffer:a};let o=t.reprojection===mt.RENDER?t.transformBeforeProject:null;o&&(s=pa(new Float64Array(s.length),s,o));let{normal:n,tangent:l}=e.vertexAttributes;this._passthroughReprojectionInfo(t)||!n&&!l||(a=s);let c=s===i||s===a?new Float64Array(s.length):s;return Ue(s,e.spatialReference,0,c,this._context.renderCoordsHelper.spatialReference,0,s.length/3),{position:c,georeferencedPositionBuffer:a}}_createNormalBuffer(e,t,i,s){let a=e.vertexAttributes.normal;if(a==null)return null;let o=a,n=s.reprojection===mt.RENDER?s.transformBeforeProject:null;n&&(o=pc(o,new Float32Array(o.length),n));let l=this._context.graphicsCoreOwner.view.viewingMode;if(s.reprojection===mt.NONE)return o;if(l==="local"){if(!Zl(this._context.renderCoordsHelper.spatialReference))return o;if(i==null)return null;if(e.spatialReference.isGeographic){let h=o===a?new Float32Array(o.length):o;return uc(o,da.NORMAL,i,h)}if(e.spatialReference.isWebMercator){let h=o===a?new Float32Array(o.length):o;return mc(o,da.NORMAL,i,h)}return o}if(i==null)return null;let c=o===a?new Float32Array(o.length):o;return Gd(o,i,t,e.spatialReference,c)}_createTangentBuffer(e,t,i,s){let a=e.vertexAttributes.tangent;if(a==null)return null;let o=a,n=s.reprojection===mt.RENDER?s.transformBeforeProject:null;n&&(o=dc(o,new Float32Array(o.length),n));let l=this._context.graphicsCoreOwner.view.viewingMode;if(s.reprojection===mt.NONE)return o;if(l==="local"){if(!Zl(this._context.renderCoordsHelper.spatialReference))return o;if(i==null)return null;if(e.spatialReference.isGeographic){let h=o===a?new Float32Array(o.length):o;return uc(o,da.TANGENT,i,h)}if(e.spatialReference.isWebMercator){let h=o===a?new Float32Array(o.length):o;return mc(o,da.TANGENT,i,h)}return o}if(i==null)return null;let c=o===a?new Float32Array(o.length):o;return Md(o,i,t,e.spatialReference,c)}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){let t=this._getVertexOpacityAndColor(e),i=Su(this.symbolLayer?.material?.colorMixMode),s=new Uint8Array(4);return Cu(t,i,s),s}return null}_createBuffers(e,t){let i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;let s=e.vertexAttributes.normal,a=e.vertexAttributes.uv,o=e.vertexAttributes.tangent;if(s&&s.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(o&&o.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(a&&a.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;let n=this._computeReprojectionInfo(e),{position:l,georeferencedPositionBuffer:c}=this._createPositionBuffer(e,n),h=d_(e),p=this._createSymbolColorBuffer(t),d=this._createNormalBuffer(e,l,c,n),f=this._createTangentBuffer(e,l,c,n),m=a,{transformation:y,position:b,normal:S,tangent:x}=this._passthroughReprojectionInfo(n)?{transformation:n.objectTransformation,position:l,normal:d,tangent:f}:this._transformOriginLocal(e,l,d,f);return{positionBuffer:b,normalBuffer:S,tangentBuffer:x,uvBuffer:m,colorBuffer:h,symbolColorBuffer:p,objectTransformation:y,geometryTransformation:n.reprojection===mt.NONE&&n.geometryTransformation?n.geometryTransformation:V()}}_computeReprojectionInfo(e){let{vertexSpace:t}=e,i=t.type==="georeferenced"?Rr(this._context.renderCoordsHelper.spatialReference,e.spatialReference)?mt.NONE:mt.RENDER:mt.NONE;if(Ld(t))return{reprojection:i};let s=t.origin,a=V(),o=e.transform?.localMatrix??Li;if(i===mt.NONE)return bt(e.spatialReference,s,a,this._context.renderCoordsHelper.spatialReference),{reprojection:i,objectTransformation:a,geometryTransformation:Ad(o)};let n=Po(V(),s);return _t(n,n,o),{reprojection:i,transformBeforeProject:n}}_transformOriginLocal(e,t,i,s){let a=this._context.renderCoordsHelper.spatialReference,o=e.anchor;jn[0]=o.x,jn[1]=o.y,jn[2]=o.z??0;let n=V();bt(e.spatialReference,jn,n,a),wr(Hn,n);let{position:l,normal:c,tangent:h}=e.vertexAttributes,p=t===l?new Float64Array(t.length):t;pa(p,t,Hn);let d=i?i===c?new Float32Array(i.length):i:null,f=s?s===h?new Float32Array(s.length):s:null;return i&&d&&pc(i,d,Hn),s&&f&&dc(s,f,Hn),{transformation:n,position:p,normal:d,tangent:f}}_validateFaces(e,t){let i=e.vertexAttributes.position.length/3,s=t.faces;if(s){let a=-1;for(let o=0;o<s.length;o++){let n=s[o];n>a&&(a=n)}if(i<=a)return this.logger.warn(`Vertex index ${a} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;let t=e.vertexAttributes?.position;if(!t)return!1;let i=this._context.elevationProvider.spatialReference,s=Vd({positions:t,transform:e.transform,vertexSpace:e.vertexSpace,inSpatialReference:e.spatialReference,outSpatialReference:i??e.spatialReference,localMode:this._context.stage.viewingMode===Me.Local});if(!s)return!1;let a=s.length/3;return F(xh),Ge(xh,s,0,a),!ze(xh,this._context.clippingExtent)}_createGeometryInfo(e,t,i){if(!Ao(e.spatialReference,this._context.renderCoordsHelper.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(!this._validateVertexSpace(e)||this._isOutsideClippingArea(e))return null;let s=this._createBuffers(e,t);if(s==null)return null;let{positionBuffer:a,uvBuffer:o,colorBuffer:n,symbolColorBuffer:l,normalBuffer:c,tangentBuffer:h,objectTransformation:p,geometryTransformation:d}=s,f=n_(e),m=new Array,y=!1,b=oa($,p),S=this._context.localOriginFactory.getOrigin(b);for(let x of f){if(!this._validateFaces(e,x))return null;let w=i_(e,x);if(w.length===0)continue;let E=s_(a,c,x,w);E.didFlipNormals&&(y=!0);let C=[[g.POSITION,new j(a,w,3,!0)],[g.NORMAL,new j(E.normals,E.indices,3,!0)]];n&&C.push([g.COLOR,new j(n,w,4,!0)]),l&&C.push([g.SYMBOLCOLOR,new j(l,Xr(w.length),4,!0)]),o&&C.push([g.UV0,new j(o,w,2,!0)]),h&&C.push([g.TANGENT,new j(h,w,4,!0)]);let P=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),T=this._getOrCreateMaterial(e,x),D=new ht(T,C,null,et.Mesh,P);D.transformation=d,D.localOrigin=S,m.push(D)}return y&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:m,objectTransformation:p}}_updateMaterialParameters(e){this._materialInfoCache.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachClonedMaterial((t,i)=>{i.setParameters(t.parameters)})}_validateVertexSpace(e){let{_context:{graphicsCoreOwner:{view:{state:{viewingMode:t}}}}}=this,{vertexSpace:i}=e;return t!==Me.Local||i.type!=="local"||(this.logger.warn("Displaying a mesh with a local vertex space in a view in local viewing mode is not supported."),!1)}test(){return Pe(Z({},super.test()),{materials:this._materialInfoCache.materials})}},ka=class{constructor(e,t,i){this.normals=e,this.indices=t,this.didFlipNormals=i}};function i_(r,e){return e.faces??Ed(r.vertexAttributes.position.length/3)}function s_(r,e,t,i){switch(t.shading||"flat"){default:case"source":return a_(r,e,t,i);case"flat":return sg(r,i);case"smooth":return o_(r,i)}}function sg(r,e){let t=Ke(e.length),i=new Array(3*e.length);for(let s=0;s<e.length;s+=3){let a=Wn(r,e,s,ur);for(let o=0;o<3;o++)t[s+o]=a[o],i[s+o]=s/3}return new ka(t,i,!1)}function a_(r,e,t,i){if(e==null)return sg(r,i);let s=!1;if(!t.trustSourceNormals)for(let a=0;a<i.length;a+=3){Wn(r,i,a,ur);for(let o=0;o<3;o++){let n=3*i[a+o];$[0]=e[n],$[1]=e[n+1],$[2]=e[n+2],z(ur,$)<0&&(e[n]=-e[n],e[n+1]=-e[n+1],e[n+2]=-e[n+2],s=!0)}}return new ka(e,i,s)}function o_(r,e){let t={};for(let a=0;a<e.length;a+=3){let o=Wn(r,e,a,ur);for(let n=0;n<3;n++){let l=e[a+n],c=t[l];c||(c={normal:_(),count:0},t[l]=c),le(c.normal,c.normal,o),c.count++}}let i=Ke(3*e.length),s=new Array(3*e.length);for(let a=0;a<e.length;a++){let o=t[e[a]];o.count!==1&&(J(o.normal,o.normal),o.count=1);for(let n=0;n<3;n++)i[3*a+n]=o.normal[n];s[a]=a}return new ka(i,s,!1)}function ag(r,e,t,i,s,a){let o=3*e[t],n=3*e[t+1],l=3*e[t+2];i[0]=r[o],i[1]=r[o+1],i[2]=r[o+2],s[0]=r[n],s[1]=r[n+1],s[2]=r[n+2],a[0]=r[l],a[1]=r[l+1],a[2]=r[l+2]}function Wn(r,e,t,i){return ag(r,e,t,$,Bt,js),de(Bt,Bt,$),de(js,js,$),qe($,Bt,js),J(i,$),i}function n_(r){return r.components??f_}function ja(r){if(!r)return null;let{scale:e,offset:t,rotation:i}=r;return{scale:e,offset:t,rotation:Up(i)}}function l_(r="repeat"){if(typeof r=="string"){let e=vh(r);return{s:e,t:e}}return{s:vh(r.horizontal),t:vh(r.vertical)}}function vh(r){switch(r){case"clamp":return Lr.CLAMP_TO_EDGE;case"mirror":return Lr.MIRRORED_REPEAT;default:return Lr.REPEAT}}function c_(r){let e=r.vertexAttributes.color;if(e==null)return!1;for(let t=3;t<e.length;t+=4)if(e[t]!==255)return!0;return!1}function h_(r,e){e.diffuse=re.toUnitRGB(r),e.opacity=r.a}function p_(r){return r.data??r.url}function Zi(r){return r==null?"-":r instanceof re?r.toHex():r.contentHash}function Ha(r){let{offset:e,scale:t,rotation:i}=r??u_;return`${e[0]},${e[1]},${i},${t[0]},${t[1]}`}function d_(r){return r.vertexAttributes.color}var u_=new nu,jn=_(),$=_(),Bt=_(),js=_(),ur=_(),Hn=V(),m_=V(),xh=K(),f_=[new cu],mt;(function(r){r[r.NONE=0]="NONE",r[r.RENDER=1]="RENDER"})(mt||(mt={}));var qn=class{constructor(e,t,i,s){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=s,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){let t=this._lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){this.instanceIndex!=null&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){Rs(this.elevationContext.featureExpressionInfoContext,i);let s=(o,n)=>Ct(o,e,this.elevationContext,t,n),a=this.elevationAligner(this,this.elevationContext,e.spatialReference,s,t);a!=null&&(this.alignedSampledElevation=a)}}getCenterObjectSpace(e=_()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,mr),X(e,this._lodRenderer.baseBoundingSphere.center,mr)}getBoundingBoxObjectSpace(e=K()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,mr);let t=this._lodRenderer.baseBoundingBox;F(e);for(let i=0;i<8;++i)A(Nt,1&i?t[3]:t[0],2&i?t[4]:t[1],4&i?t[5]:t[2]),X(Nt,Nt,mr),Tr(e,Nt);return e}computeAttachmentOrigin(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,mr),e.render.origin[0]+=mr[12],e.render.origin[1]+=mr[13],e.render.origin[2]+=mr[14],e.render.num++}getProjectedBoundingBox(e,t,i,s,a){return O(this,null,function*(){let o=this.getBoundingBoxObjectSpace(a),n=g_,l=wo(o)?1:n.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,mr);for(let h=0;h<l;h++){let p=n[h];Nt[0]=o[p[0]],Nt[1]=o[p[1]],Nt[2]=o[p[2]],X(Nt,Nt,mr),Qi[3*h]=Nt[0],Qi[3*h+1]=Nt[1],Qi[3*h+2]=Nt[2]}if(!e(Qi,0,l))return null;F(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],Qi[h+p]),o[p+3]=Math.max(o[p+3],Qi[h+p]);c&&i.push({location:Qi.slice(h,h+3),screenSpaceBoundingRect:c})}if(t&&($e(o,Sh),this.elevationContext.mode!=="absolute-height")){let h,p=ws(o,t.service.spatialReference,t);try{h=yield t.service.queryElevation(Sh[0],Sh[1],s,p,"ground")}catch{}h!=null&&Eo(o,0,0,-this.alignedSampledElevation+h)}return o})}addObjectState(e,t){if(e===ct.Highlight){let i=new Au(e);this._addHighlightId(i),t.addExternal(s=>{this._removeHighlightId(s)},i)}}removeObjectState(e){this._highlights.forEach(t=>e.remove(t))}_addHighlightId(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}},Qi=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Nt=_(),Sh=_(),g_=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],mr=V();function y_(r,e){let t=r.stageResources.geometries.map(s=>new As(s,r.stageResources.textures)),i=r.lodThreshold==null||r.lodThreshold===0&&e>0?__(t):r.lodThreshold;return new Ts(t,i,r.pivotOffset)}function og(r){return new Ls(r.map((e,t)=>y_(e,t)))}function __(r){let e=r.reduce((t,{geometry:i})=>t+i.indexCount/3,0);return Math.sqrt(e*b_/Math.PI)}var b_=20;function ng(r){return O(this,null,function*(){if(r===null||r.styleName==null&&r.styleUrl==null)return null;let e=r.name;if(e==null)throw new _e("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference");let t={portal:r.portal},i=yield tu(r,t).catch(()=>null);if(i===null)return null;let s=iu(e,i.data);if(s&&!s.formatInfos?.some(n=>n.type==="gltf_basisu"))return null;let a=yield su(i,e,t,"webRef",(n,l)=>ru(n,l,["gltf_basisu","gltf"])).catch(()=>null);if(a===null||a.type!=="point-3d")return null;let o=a.symbolLayers.items[0];return o.type==="object"?o.resource:null})}var $n=class{constructor(e,t,i){this._elementSize=t,this._buffer=No.createVertex(e,Do.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,t,i,s=0){let a=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,s*this.elementSize).set(a)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){let i=e*this._elementSize,s=t*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,s)}resize(e){let t=e*this._elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(t),this._capacity=e}};var Ch=class{constructor(e){this.modelOriginHi=e.getField(g.INSTANCEMODELORIGINHI,oc),this.modelOriginLo=e.getField(g.INSTANCEMODELORIGINLO,oc),this.model=e.getField(g.INSTANCEMODEL,Jr),this.modelNormal=e.getField(g.INSTANCEMODELNORMAL,Jr),this.featureAttribute=e.getField(g.INSTANCEFEATUREATTRIBUTE,gs),this.color=e.getField(g.INSTANCECOLOR,ys),this.objectAndLayerIdColor=e.getField(g.INSTANCEOBJECTANDLAYERIDCOLOR,ys)}},Wa=class{constructor(e,t){this._rctx=e,this._instanceBufferLayout=t,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){let e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){Ee(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){Ee(this._updating,"not updating"),this.size<np*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){Ee(this._updating,"not updating"),this.isFull&&this._grow();let e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),Ee(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){Ee(this._updating,"not updating"),Ee(this.size>0,"invalid size");let e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){let e=Math.max(qa,Math.floor(this._capacity*ho));this._resize(e)}_shrink(){let e=Math.max(qa,Math.floor(this._capacity*op));this._resize(e)}_resize(e){if(Ee(this._updating,"not updating"),e===this._capacity)return;let t=new $n(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);let i=this.size,s=this._compactInstances(t);Ee(s===i,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=s,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new Ch(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){let t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}},qa=64;var Y;function v_(r){let e=Lt().mat4f64(g.LOCALTRANSFORM).mat4f64(g.GLOBALTRANSFORM).vec4f64(g.BOUNDINGSPHERE).vec3f64(g.MODELORIGIN).mat3f(g.INSTANCEMODEL).mat3f(g.INSTANCEMODELNORMAL).vec2f(g.MODELSCALEFACTORS);return r.includes(g.FEATUREATTRIBUTE)&&(e=e.vec4f(g.FEATUREATTRIBUTE)),r.includes(g.COLOR)&&(e=e.vec4u8(g.COLOR)),r.includes(g.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(g.OBJECTANDLAYERIDCOLOR)),e=e.u8(g.STATE).u8(g.LODLEVEL),e}(function(r){r[r.ALLOCATED=1]="ALLOCATED",r[r.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",r[r.VISIBLE=4]="VISIBLE",r[r.HIGHLIGHT=8]="HIGHLIGHT",r[r.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",r[r.REMOVE=32]="REMOVE",r[r.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",r[r.ACTIVE=18]="ACTIVE"})(Y||(Y={}));var Yn=class{constructor(e){this.localTransform=e.getField(g.LOCALTRANSFORM,nc),this.globalTransform=e.getField(g.GLOBALTRANSFORM,nc),this.modelOrigin=e.getField(g.MODELORIGIN,gd),this.model=e.getField(g.INSTANCEMODEL,Jr),this.modelNormal=e.getField(g.INSTANCEMODELNORMAL,Jr),this.modelScaleFactors=e.getField(g.MODELSCALEFACTORS,fd),this.boundingSphere=e.getField(g.BOUNDINGSPHERE,yd),this.featureAttribute=e.getField(g.FEATUREATTRIBUTE,gs),this.color=e.getField(g.COLOR,ys),this.objectAndLayerIdColor=e.getField(g.OBJECTANDLAYERIDCOLOR,ys),this.state=e.getField(g.STATE,lc),this.lodLevel=e.getField(g.LODLEVEL,lc)}},Ji=class extends Ae{constructor(r,e){super(r),this.events=new Xt,this._capacity=0,this._size=0,this._next=0,this._layout=v_(e),this._capacity=qa,this._buffer=this._layout.createBuffer(this._capacity),this._view=new Yn(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();let r=this._findSlot();return this._view.state.set(r,Y.ALLOCATED),this._size++,this.events.emit("instances-changed"),r}removeInstance(r){let e=this._view.state;Ee(r>=0&&r<this._capacity&&!!(e.get(r)&Y.ALLOCATED),"invalid instance handle"),this._getStateFlag(r,Y.ACTIVE)?this._setStateFlags(r,Y.REMOVE):this.freeInstance(r),this.events.emit("instances-changed")}freeInstance(r){let e=this._view.state;Ee(r>=0&&r<this._capacity&&!!(e.get(r)&Y.ALLOCATED),"invalid instance handle"),e.set(r,0),this._size--}setLocalTransform(r,e,t=!0){this._view.localTransform.setMat(r,e),t&&this.updateModelTransform(r)}getLocalTransform(r,e){this._view.localTransform.getMat(r,e)}setGlobalTransform(r,e,t=!0){this._view.globalTransform.setMat(r,e),t&&this.updateModelTransform(r)}getGlobalTransform(r,e){this._view.globalTransform.getMat(r,e)}updateModelTransform(r){let e=this._view,t=ft,i=Zt;e.localTransform.getMat(r,lg),e.globalTransform.getMat(r,Ph);let s=_t(Ph,Ph,lg);A(t,s[12],s[13],s[14]),e.modelOrigin.setVec(r,t),Fo(i,s),e.model.setMat(r,i);let a=pu(ft,s);a.sort(),e.modelScaleFactors.set(r,0,a[1]),e.modelScaleFactors.set(r,1,a[2]),wd(i,i),Od(i,i),e.modelNormal.setMat(r,i),this._setStateFlags(r,Y.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:r})}getModelTransform(r,e){let t=this._view;t.model.getMat(r,Zt),t.modelOrigin.getVec(r,ft),e[0]=Zt[0],e[1]=Zt[1],e[2]=Zt[2],e[3]=0,e[4]=Zt[3],e[5]=Zt[4],e[6]=Zt[5],e[7]=0,e[8]=Zt[6],e[9]=Zt[7],e[10]=Zt[8],e[11]=0,e[12]=ft[0],e[13]=ft[1],e[14]=ft[2],e[15]=1}applyShaderTransformation(r,e){this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,r,e)}getCombinedModelTransform(r,e){return this.getModelTransform(r,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,r,e),e}getCombinedLocalTransform(r,e){this._view.localTransform.getMat(r,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,r,e)}getCombinedMaxScaleFactor(r){let e=this._view.modelScaleFactors.get(r,1);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(ft,this,r),e*=Math.max(ft[0],ft[1],ft[2])),e}getCombinedMedianScaleFactor(r){let e=this._view.modelScaleFactors.get(r,0);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(ft,this,r),e*=x_(ft[0],ft[1],ft[2])),e}getModel(r,e){this._view.model.getMat(r,e)}setFeatureAttribute(r,e){this._view.featureAttribute.setVec(r,e)}getFeatureAttribute(r,e){this._view.featureAttribute.getVec(r,e)}setColor(r,e){this._view.color.setVec(r,e)}setObjectAndLayerIdColor(r,e){this._view.objectAndLayerIdColor.setVec(r,e)}setVisible(r,e){e!==this.getVisible(r)&&(this._setStateFlag(r,Y.VISIBLE,e),this.events.emit("instance-visibility-changed",{index:r}))}getVisible(r){return this._getStateFlag(r,Y.VISIBLE)}setHighlight(r,e){e!==this.getHighlight(r)&&(this._setStateFlag(r,Y.HIGHLIGHT,e),this.events.emit("instance-highlight-changed"))}getHighlight(r){return this._getStateFlag(r,Y.HIGHLIGHT)}getState(r){return this._view.state.get(r)}getLodLevel(r){return this._view.lodLevel.get(r)}countFlags(r){let e=0;for(let t=0;t<this._capacity;++t)this.getState(t)&r&&++e;return e}_setStateFlags(r,e){let t=this._view.state;e=t.get(r)|e,t.set(r,e)}_clearStateFlags(r,e){let t=this._view.state;e=t.get(r)&~e,t.set(r,e)}_setStateFlag(r,e,t){t?this._setStateFlags(r,e):this._clearStateFlags(r,e)}_getStateFlag(r,e){return!!(this._view.state.get(r)&e)}_grow(){this._capacity=Math.max(qa,Math.floor(this._capacity*ho)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new Yn(this._buffer)}_findSlot(){let r=this._view.state,e=this._next;for(;r.get(e)&Y.ALLOCATED;)e=e+1===this._capacity?0:e+1;return this._next=e+1===this._capacity?0:e+1,e}};function x_(r,e,t){return Math.max(Math.min(r,e),Math.min(Math.max(r,e),t))}u([v({constructOnly:!0})],Ji.prototype,"shaderTransformation",void 0),u([v()],Ji.prototype,"_size",void 0),u([v({readOnly:!0})],Ji.prototype,"size",null),Ji=u([ie("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],Ji);var ft=_(),Zt=Ti(),lg=V(),Ph=V();var Zn=class extends _a{constructor(e,t){super(i=>this._instanceData.view.boundingSphere.getVec(i,this._tmpSphere),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=xu(),this._tmpMat4=V()}addInstance(e){let t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);X(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*hu(i),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}};var Qn=class{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,i){let s=i.computeScreenPixelSizeAt(e),a=this._worldSpaceRadius*t/s,o=0;for(let n=1;n<this._minScreenSpaceRadii.length;++n)a>=this._minScreenSpaceRadii[n]&&(o=n);return o}};var Jn=class extends ym{constructor(e,t,i,s,a,o){super(e,t),this.layerUid=e,this.graphicUid=t,this.geometryId=i,this.triangleNr=s,this.baseBoundingSphere=a,this.numLodLevels=o}};var Xn=class{constructor(e,t){let i=e.renderContext.rctx,s=t.geometry;this._materials=e.materials,s.material.setParameters({instancedDoublePrecision:!0});let a=s.material.createBufferWriter(),o=a.vertexBufferLayout,n=a.elementCount(s),l=o.createBuffer(n);a.write(null,null,s,l,0),this.geometry=s,this.material=s.material,this.glMaterials=new vm(s.material,this._materials),this.vertexBufferLayout=o,this.vbo=No.createVertex(i,Do.STATIC_DRAW,l.buffer),this.vao=new lm(i,Ht,{geometry:Go(o)},{geometry:this.vbo}),this.vertexCount=n}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,i,s,a,o,n,l){let c=this.geometry.id;this.material.intersect(this.geometry,e.transform.transform,e,i,s,(h,p,d,f,m)=>{if(h>=0){if(t!=null&&!t(e.rayBegin,e.rayEnd,h))return;let y=new Jn(o.layerUid,o.graphicUid(a),c,d,n,l);if((e.results.min.drapedLayerOrder==null||m>=e.results.min.drapedLayerOrder)&&(e.results.min.dist==null||h<e.results.min.dist)&&e.results.min.set(Ni.LOD,y,h,p,e.transform.transform,m),e.options.store!==xa.MIN&&(e.results.max.drapedLayerOrder==null||m>=e.results.max.drapedLayerOrder)&&(e.results.max.dist==null||h>e.results.max.dist)&&e.results.max.set(Ni.LOD,y,h,p,e.transform.transform,m),e.options.store===xa.ALL){let b=bm(e.results.min.ray);b.set(Ni.LOD,y,h,p,e.transform.transform,m),e.results.all.push(b)}}})}};var Kn=class r{static create(e,t,i){return O(this,null,function*(){let s=yield Promise.allSettled(t.components.map(o=>e.controller.schedule(()=>new Xn(e,o),i))),a=s.map(o=>o.status==="fulfilled"?o.value:null).filter(Pr);if(po(i)||a.length!==s.length){a.forEach(o=>o.destroy()),ee(i);for(let o of s)if(o.status==="rejected")throw o.reason}return new r(t.minScreenSpaceRadius,a)})}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,t,i,s,a,o,n){this.components.forEach(l=>l.intersect(e,t,i,s,a,o,this.boundingSphere,n))}get boundingBox(){if(this._boundingBox==null){let e=F();this.components.forEach(t=>{t.boundingInfo!=null&&(Tr(e,t.boundingInfo.bbMin),Tr(e,t.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){let e=this.boundingBox,t=_();$e(e,t),this._boundingSphere={center:t,radius:.5*Zp(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,t)=>e+t.triangleCount,0)}};var S_=r=>{let e=r.baseBoundingSphere.radius,t=r.levels.map(i=>i.minScreenSpaceRadius);return new Qn(e,t)},Rt=class extends nm{constructor(r,e){super(r),this.type=Ni.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[new Array],this._highlightRenderInstanceData=[new Array],this._allRenderInstanceData=[this._defaultRenderInstanceData[0],this._highlightRenderInstanceData[0]],this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new cm,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[H.OPAQUE_MATERIAL,t=>this._produces(t)],[H.TRANSPARENT_MATERIAL,t=>!!this._hasTransparentLevels()&&this._produces(t)]]),this._instanceData=new Ji({shaderTransformation:r.shaderTransformation},r.optionalFields),this.addHandles(e.registerTask(Xe.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=P_(this.optionalFields),this._glInstanceBufferLayout=Go(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:r})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(r)}),this._instanceData.events.on("instance-visibility-changed",({index:r})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(r)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(r){this._slicePlane=r}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get usedMemory(){return this._allRenderInstanceData.reduce((r,e)=>e.reduce((t,i)=>t+i.usedMemory,r),0)}get renderStats(){let r=this._instanceData.size,e=[];return this._levels.forEach((t,i)=>{let s=this._allRenderInstanceData[0][i].size+this._allRenderInstanceData[1][i].size,a=t.triangleCount;e.push({renderedInstances:s,renderedTriangles:s*a,trianglesPerInstance:a})}),{totalInstances:r,renderedInstances:e.reduce((t,i)=>t+i.renderedInstances,0),renderedTriangles:e.reduce((t,i)=>t+i.renderedTriangles,0),levels:e}}initializeRenderContext(r,e){return O(this,null,function*(){this._context=r;let t=r.renderContext.rctx,i=yield Promise.allSettled(this.symbol.levels.map(a=>(this._defaultRenderInstanceData[0].push(new Wa(t,this._instanceBufferLayout)),this._highlightRenderInstanceData[0].push(new Wa(t,this._instanceBufferLayout)),Kn.create(r,a,e)))),s=i.map(a=>a.status==="fulfilled"?a.value:null).filter(Pr);if(po(e)||s.length!==i.length){s.forEach(a=>a.destroy()),ee(e);for(let a of i)if(a.status==="rejected")throw a.reason}this._levels=s,this._levelSelector=S_(this)})}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(r=>r.destroy()),this._defaultRenderInstanceData[0].forEach(r=>r.destroy()),this._highlightRenderInstanceData[0].forEach(r=>r.destroy())}_hasTransparentLevels(){return this._levels.some(r=>r.components.some(e=>e.material.produces.get(H.TRANSPARENT_MATERIAL)?.(L.Color)))}hasHighlights(){return this._highlightRenderInstanceData[0].some(r=>r.size>0)}_produces(r){return r!==L.Highlight&&r!==L.ShadowHighlight||this.hasHighlights()}prepareRender(r){if(!Te.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){let e=r.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(r.bindParameters.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Ai),this._needFullCycle=!1)}}prepareTechniques(r){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(r.output))return null;let e=this._getInstanceDatas(r.output);if(!e)return null;let t=new Array;return e.forEach(i=>this.levels.forEach((s,a)=>{s.components.forEach(o=>t.push(this._beginComponent(r,i[a],o)))})),t}renderNode(r,e){let t=this._getInstanceDatas(r.output);if(!t||e==null)return;let i=0;r.rctx.bindVAO(),t.forEach(s=>this.levels.forEach((a,o)=>{a.components.forEach(n=>this._renderComponent(r,e[i++],s[o],n,o))}))}_getInstanceDatas(r){let e=r!==L.Highlight&&r!==L.ShadowHighlight,t=r!==L.ShadowExcludeHighlight;return e&&t?this._allRenderInstanceData:e?this._defaultRenderInstanceData:t?this._highlightRenderInstanceData:null}intersect(r,e,t,i){if(!this.baseMaterial.isVisible()||this._octree==null)return;let s=_();de(s,i,t);let a=o=>{this._instanceData.getCombinedModelTransform(o,pg),r.transform.set(pg),X(dg,t,r.transform.inverse),X(ug,i,r.transform.inverse);let n=this._instanceData.getState(o),l=this._instanceData.getLodLevel(o),c=this._levels.length;Ee(!!(n&Y.ACTIVE),"invalid instance state"),Ee(l>=0&&l<c,"invaid lod level"),this._levels[l].intersect(r,e,dg,ug,o,this.metadata,c)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(t,s,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){let r=this._instanceData,e=r.view?.state;if(!e)return null;this._octreeCached=new Zn(r,this.baseBoundingSphere);for(let t=0;t<r.capacity;++t)e.get(t)&Y.ACTIVE&&this._octreeCached.addInstance(t)}return this._octreeCached}_invalidateOctree(){this._octreeCached=ge(this._octreeCached)}queryDepthRange(r){if(this._octree==null)return{near:1/0,far:-1/0};let e=r.viewForward,t=this._octree.findClosest(e,_a.DepthOrder.FRONT_TO_BACK,r.frustum),i=this._octree.findClosest(e,_a.DepthOrder.BACK_TO_FRONT,r.frustum);if(t==null||i==null)return{near:1/0,far:-1/0};let s=r.eye,a=this._instanceData.view;a.boundingSphere.getVec(t,fr),de(fr,fr,s);let o=z(fr,e)-fr[3];a.boundingSphere.getVec(i,fr),de(fr,fr,s);let n=z(fr,e)+fr[3];return{near:Math.max(r.near,o),far:Math.min(r.far,n)}}_requestUpdateCycle(r=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,r&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(r=>r.forEach(e=>e.startUpdateCycle()))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(r){let{_enableLevelSelection:e,_camera:t,_levelSelector:i}=this;this._allRenderInstanceData.forEach(h=>h.forEach(p=>p.beginUpdate()));let s=this._instanceData,a=s.view,o=s.size,n=s.capacity,l=this._instanceIndex,c=Math.ceil(n/500);for(let h=0;h<o&&!r.done;++h){l===this._cycleStartIndex&&this._startUpdateCycle();let p=a.state.get(l),d=0;if(!(p&Y.ALLOCATED)){l=l+1===n?0:l+1,o++;continue}let f=a.lodLevel.get(l);if(p&Y.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[0][f].freeTail(),p&Y.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[0][f].freeTail(),p&Y.REMOVE)s.freeInstance(l);else if(p&Y.VISIBLE){let m=0;e&&(a.modelOrigin.getVec(l,hg),m=i.selectLevel(hg,s.getCombinedMedianScaleFactor(l),t)),d=p&~(Y.ACTIVE|Y.TRANSFORM_CHANGED),m>=0&&(p&Y.HIGHLIGHT?(cg(this._highlightRenderInstanceData[0][m],a,l),d|=Y.HIGHLIGHT_ACTIVE):(cg(this._defaultRenderInstanceData[0][m],a,l),d|=Y.DEFAULT_ACTIVE)),a.state.set(l,d),a.lodLevel.set(l,m)}else d=p&~(Y.ACTIVE|Y.TRANSFORM_CHANGED),a.state.set(l,d);if(this._octreeCached!=null){let m=!!(p&Y.ACTIVE),y=!!(d&Y.ACTIVE);!m&&y?this._octreeCached.addInstance(l):m&&!y?this._octreeCached.removeInstance(l):m&&y&&p&Y.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))}l=l+1===n?0:l+1,l%c==0&&r.madeProgress()}this._instanceIndex=l,this._allRenderInstanceData.forEach(h=>h.forEach(p=>p.endUpdate())),this._context.requestRender()}_beginComponent(r,e,t){if(e.size===0)return null;let i=t.glMaterials.load(r.rctx,r.bindParameters.slot,r.output);return i!=null?i.beginSlot(r.bindParameters):null}_renderComponent(r,e,t,i,s){if(!e)return;let{bindParameters:a,rctx:o}=r;o.runAppleAmdDriverHelper();let n=o.bindTechnique(e,a,i.material.parameters,E_);o.bindVAO(i.vao),e.ensureAttributeLocations(i.vao),Te.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&r.output===L.Color&&(n.setUniform4fv("externalColor",mg[Math.min(s,mg.length-1)]),n.setUniform1i("colorMixMode",Du.replace));let l=t.capacity,c=t.headIndex,h=t.tailIndex,p=t.firstIndex,d=this._glInstanceBufferLayout,f=(m,y)=>{Hd(o,Ht,t.buffer,d,m),o.drawArraysInstanced(e.primitiveType,0,i.vertexCount,y-m),kd(o,Ht,t.buffer,d)};i.material.parameters.transparent&&p!=null?c>h?(Ee(p>=h&&p<=c,"invalid firstIndex"),f(p,c),f(h,p)):c<h&&(p<=c?(Ee(p>=0&&p<=c,"invalid firstIndex"),f(p,c),f(h,l),f(0,p)):(Ee(p>=h&&p<=l,"invalid firstIndex"),f(p,l),f(0,c),f(h,p))):c>h?f(h,c):c<h&&(f(0,c),f(h,l)),o.bindVAO(null)}};function cg(r,e,t){let i=r.allocateHead();C_(e,t,r.view,i)}function C_(r,e,t,i){Tu(r.modelOrigin,e,t.modelOriginHi,t.modelOriginLo,i),t.model.copyFrom(i,r.model,e),t.modelNormal.copyFrom(i,r.modelNormal,e),r.color&&t.color&&t.color.copyFrom(i,r.color,e),r.objectAndLayerIdColor&&t.objectAndLayerIdColor&&t.objectAndLayerIdColor.copyFrom(i,r.objectAndLayerIdColor,e),r.featureAttribute&&t.featureAttribute&&t.featureAttribute.copyFrom(i,r.featureAttribute,e)}function P_(r){let e=Lt().vec3f(g.INSTANCEMODELORIGINHI).vec3f(g.INSTANCEMODELORIGINLO).mat3f(g.INSTANCEMODEL).mat3f(g.INSTANCEMODELNORMAL);return r!=null&&r.includes("featureAttribute")&&(e=e.vec4f(g.INSTANCEFEATUREATTRIBUTE)),r!=null&&r.includes("color")&&(e=e.vec4u8(g.INSTANCECOLOR)),r!=null&&r.includes("objectAndLayerIdColor")&&(e=e.vec4u8(g.INSTANCEOBJECTANDLAYERIDCOLOR)),e}u([v({constructOnly:!0})],Rt.prototype,"symbol",void 0),u([v({constructOnly:!0})],Rt.prototype,"optionalFields",void 0),u([v({constructOnly:!0})],Rt.prototype,"metadata",void 0),u([v({constructOnly:!0})],Rt.prototype,"shaderTransformation",void 0),u([v()],Rt.prototype,"_instanceData",void 0),u([v()],Rt.prototype,"_cycleStartIndex",void 0),u([v({readOnly:!0})],Rt.prototype,"_enableLevelSelection",null),u([v()],Rt.prototype,"_updateCyclesWithStaticCamera",void 0),u([v({readOnly:!0})],Rt.prototype,"running",null),Rt=u([ie("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],Rt);var hg=_(),fr=Yr(),pg=V(),dg=_(),ug=_(),mg=[ye(1,0,1,1),ye(0,0,1,1),ye(0,1,0,1),ye(1,1,0,1),ye(1,0,0,1)],E_=new Zu;var rl=class{constructor(e,t,i,s,a,o,n,l,c,h,p,d){this.lodResources=e,this.lodRenderer=t,this.stageResources=i,this.originalMaterialParameters=s,this.resourceSize=a,this.isEsriSymbolResource=o,this.isWosr=n,this.resourceBoundingBox=l,this.symbolSize=c,this.extentPadding=h,this.physicalBasedRenderingEnabled=p,this.pivotOffset=d}},il=class extends Se{getCachedSize(){let[e,t,i]=this._resources!=null?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:i}}constructor(e,t,i,s){super(e,t,i,s),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}doLoad(e){return O(this,null,function*(){if(!this._drivenProperties.size&&hi(this.symbolLayer))throw new Error;if(this._isPrimitive){let t=this.symbolLayer.resource,i=t&&rf(t?.primitive)?t.primitive:Ho;this._resources=yield this._createResourcesForPrimitive(i,e)}else{let t=yield ng(this.symbol.styleOrigin),i=t?.href??this.symbolLayer.resource?.href;this._resources=yield this._createResourcesForUrl(i,e)}this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()})}get extentPadding(){return this._resources!=null?this._resources.extentPadding:0}get _isPrimitive(){return!this.symbolLayer.resource?.href}get lodRenderer(){return this._resources?.lodRenderer}get materials(){return this._resources?.stageResources.materials??[]}_setMaterialTransparencyParameters(e,t=this.symbolLayer?.material?.color){let i=this._getCombinedOpacity(t),s=i<1||this.needsDrivenTransparentPass;return e.transparent=s,e.opacity=i,e.cullFace=s?Re.None:Re.Back,e}_createResourcesForPrimitive(e,t){return O(this,null,function*(){let i=this.symbolLayer,s=K(Jd(e)),a=Tt(na(s)),o=Tt(jo(a,i)),n=Kt(o),l=!1,c=!1,h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:[...an],ambient:Or,diffuse:Or,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},p=!!h.usePBR;this._setMaterialTransparencyParameters(h);let d=this.symbol;if(d.type==="point-3d"&&d.verticalOffset){let{screenLength:x,minWorldLength:w,maxWorldLength:E}=d.verticalOffset;h.verticalOffset={screenLength:be(x),minWorldLength:w||0,maxWorldLength:E??1/0},h.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)h.externalColor=jt;else{let x=i.material!=null?i.material.color:null,w=x!=null?re.toUnitRGBA(x):jt;h.externalColor=w}this._fastUpdates=kt(this._context.renderer,this._fastVisualVariableConvertOptions(s,o,a,null)),h.isInstanced=!0,this._fastUpdates?(Object.assign(h,this._fastUpdates.materialParameters),this._optionalFields.push(g.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(h.hasInstancedColor=!0,this._optionalFields.push(g.COLOR)),Ve("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(g.OBJECTANDLAYERIDCOLOR);let f=new St(h),m=mn(e,f);if(!m)throw new Error(`Unknown object symbol primitive: ${e}`);let y=Ra(m).map(x=>({opacity:1,transparent:x.parameters.transparent})),b=yield this._createStageResources(m,p,t),S=yield this._createLodRenderer(m,t);return new rl(m,S,b,y,a,l,c,s,o,n,p,null)})}_createResourcesForUrl(e,t){return O(this,null,function*(){let i={materialParameters:{isInstanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=kt(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)),this._fastUpdates?(Object.assign(i.materialParameters,this._fastUpdates.materialParameters),this._optionalFields.push(g.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(i.materialParameters.hasInstancedColor=!0,this._optionalFields.push(g.COLOR)),Ve("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(g.OBJECTANDLAYERIDCOLOR);let s=this.symbol;if(s.type==="point-3d"&&s.verticalOffset){let{screenLength:G,minWorldLength:ne,maxWorldLength:U}=s.verticalOffset;i.materialParameters.verticalOffset={screenLength:be(G),minWorldLength:ne||0,maxWorldLength:U??1/0},i.materialParameters.castShadows=!1}let a=this._context.physicalBasedRenderingEnabled;i.signal=t,i.usePBR=a,i.skipHighLods=this._context.skipHighSymbolLods;let o=yield Qu(e,i),n=o.isEsriSymbolResource,l=o.isWosr,c=og(o.lods),h=this._context,p=this.symbolLayer.material,d=this._getExternalColorParameters(p),f=this.symbolLayer?.material?.color,m=this._getCombinedOpacity(f,{hasIntrinsicColor:!0}),y=this.needsDrivenTransparentPass,b=Ra(c),S=Ra(c).map(G=>({opacity:G.parameters.opacity||1,transparent:G.parameters.transparent}));b.forEach(G=>{let ne=G.parameters;G.setParameters(d);let U=ne.opacity*m,he=U<1||y||ne.transparent;G.setParameters({opacity:U,transparent:he}),h.screenSizePerspectiveEnabled&&G.setParameters({screenSizePerspective:h.sharedResources.screenSizePerspectiveSettings})});let x=o.referenceBoundingBox,w=Tt(na(x)),E=Tt(c.levels[0].pivotOffset),C=Tt(jo(w,this.symbolLayer)),P=Kt(C),T=this._fastUpdates;Wt(T,this._context.renderer,this._fastVisualVariableConvertOptions(x,C,w,E))&&b.forEach(G=>G.setParameters(T.materialParameters));let D=yield this._createStageResources(c,a,t),I=yield this._createLodRenderer(c,t);return new rl(c,I,D,S,w,n,l,x,C,P,a,E)})}_addDisposeResource(e){this._disposeResourceHandles.push(e)}_createStageResources(e,t,i){return O(this,null,function*(){let s=this._context.stage,a=Ra(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(a),this._addDisposeResource(()=>s.removeMany(a));let o=Uc(e);s.addMany(o),this._addDisposeResource(()=>{o.forEach(l=>l.unload()),s.removeMany(o)}),yield Promise.all(o.map(l=>this._context.stage.schedule(()=>l.load(s.renderView.renderingContext),i))),ee(i);let n=Fc(e);return s.addMany(n),this._addDisposeResource(()=>s.removeMany(n)),{materials:a,textures:o,geometries:n}})}_createLodRenderer(e,t){return O(this,null,function*(){let i=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:l=>this._instanceIndexToGraphicUid.get(l),notifyGraphicGeometryChanged:l=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(l)),notifyGraphicVisibilityChanged:l=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(l))},a=this._fastUpdates,o=a?{applyTransform:(l,c,h)=>{l.getFeatureAttribute(c,el),$r(h,Yu(a.materialParameters,el,h))},scaleFactor:(l,c,h)=>{c.getFeatureAttribute(h,el),on(l,a.materialParameters,el)}}:null,n=new Rt({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:o},this._context.scheduler);return n.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource(()=>{i.removeRenderPlugin(n),n.destroy()}),yield i.addRenderPlugin(n,t),n})}_getExternalColorParameters(e){let t={};return this._drivenProperties.color?t.externalColor=jt:e?.color!=null?t.externalColor=re.toUnitRGBA(e.color):(t.externalColor=jt,t.colorMixMode="ignore"),t}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(e=>e()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let i=cr(t.geometry);if(i==null)return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;let s=this.setGraphicElevationContext(t),a=e.renderingInfo;return this._createAs3DShape(t,i,a,s,t.uid,e.layer.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(this._resources==null)return;let e=this._drivenProperties.opacity,t=!this._isPrimitive,i=this._resources.stageResources.materials,s=this._resources.originalMaterialParameters;for(let a=0;a<i.length;a++){let o=i[a],n=this.symbolLayer?.material?.color,l=s[a],c=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*l.opacity,h=c<1||e||l.transparent;o.setParameters({opacity:c,transparent:h}),this._isPrimitive&&o.setParameters({cullFace:h?Re.None:Re.Back})}}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Vt)}slicePlaneEnabledChanged(){if(this._resources==null)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(let e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(this._resources==null)return!0;let{stageResources:e,isWosr:t}=this._resources;for(let i of e.materials)this._isPrimitive?i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return this._hasLoadedPBRTextures!==!1||this._context.physicalBasedRenderingEnabled!==!0||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(e,t){if(this._resources==null)return N.RecreateSymbol;let{stageResources:{materials:i},lodRenderer:s,resourceBoundingBox:a,symbolSize:o,resourceSize:n,pivotOffset:l}=this._resources;for(let c in e.diff){if(c!=="visualVariables")return N.RecreateSymbol;if(!Wt(this._fastUpdates,t,this._fastVisualVariableConvertOptions(a,o,n,l)))return N.RecreateSymbol;for(let h of i)h.setParameters(this._fastUpdates.materialParameters);s.notifyShaderTransformationChanged()}return N.FastUpdate}computeComplexity(){if(this._resources==null)return super.computeComplexity();let e=this._resources.lodResources,t=qc(e.levels),i=n=>Array.from(n.attributes.values()).reduce((l,c)=>l+Er(c.data,c.indices),0),s=Fc(e).reduce((n,l)=>n+i(l),0),a=Uc(e).reduce((n,l)=>n+l.memoryEstimate,0)+s,o=Pe(Z({},Wc(this.symbol,this.symbolLayer)),{resourceBytes:a});return new ke({verticesPerFeature:t,memory:o})}_hasLodRenderer(){return this._resources!=null}_createAs3DShape(e,t,i,s,a,o){if(!this._hasLodRenderer()||this._resources==null)return null;let n=this.getFastUpdateAttrValues(e),l=this._context.clippingExtent;if(Kr(t,Hs,this._context.elevationProvider.spatialReference),l!=null&&!us(l,Hs))return null;let c=gg(s),h=this._computeGlobalTransform(t,s,Eh,tl),p=this._computeLocalTransform(this._resources,this.symbolLayer,i,yg),d=this._resources.lodRenderer.instanceData,f=d.addInstance();this._instanceIndexToGraphicUid.set(f,a),d.setLocalTransform(f,p,!1),d.setGlobalTransform(f,h),n&&d.setFeatureAttribute(f,n),this._fastUpdates==null&&this._hasPerInstanceColor()&&d.setColor(f,ci(i.color,i.opacity,255)),this._context.stage.renderView.objectAndLayerIdRenderHelper!=null&&d.setObjectAndLayerIdColor(f,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:a,layerUid:o}));let m=new qn(this,f,lf,s);return c&&(m.alignedSampledElevation=tl.sampledElevation),m.needsElevationUpdates=Vt(s.mode),Yt(m,t,this._context.elevationProvider),m}_computeGlobalTransform(e,t,i,s){return Ct(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,s),Hs[0]=e.x,Hs[1]=e.y,Hs[2]=s.z,bt(e.spatialReference,Hs,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,t,i,s){return jp(s),this._applyObjectRotation(i,!1,s),this._applyObjectRotation(t,!0,s),this._applyObjectScale(e,i,s),this._applyAnchor(e,t,s),s}_applyObjectScale(e,t,i){if(this._fastUpdates?.requiresShaderTransformation)return;let s=this._drivenProperties.size&&t.size?t.size:e.symbolSize,a=Mc(s,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);a[0]===1&&a[1]===1&&a[2]===1||kp(i,i,a)}prepareSymbolLayerPatch(e){if(e.diff.type!=="partial")return;let t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(this._resources==null)return!0;let i=t&&cr(t);if(i==null)return!1;let s=this.getGeometryElevationMode(t);return e.elevationContext.mode===s&&(this._computeGlobalTransform(i,e.elevationContext,Eh,tl),gg(e.elevationContext)&&(e.alignedSampledElevation=tl.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,Eh,!0),Yt(e,i,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition)||this._resources==null)return;let i=(m,y,b)=>(m!=null&&m.type==="complete"?m.newValue:y)??b,s=i(t.heading,this.symbolLayer.heading,0),a=i(t.tilt,this.symbolLayer.tilt,0),o=i(t.roll,this.symbolLayer.roll,0),n=i(t.width,this.symbolLayer.width,void 0),l=i(t.height,this.symbolLayer.height,void 0),c=i(t.depth,this.symbolLayer.depth,void 0),h=i(t.anchor,this.symbolLayer.anchor,void 0),p=i(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;let d={heading:s,tilt:a,roll:o,anchor:h,anchorPosition:p},f=this._resources;this.loadStatus===We.LOADED&&e.symbolLayerStatePatches.push(()=>{f.symbolSize=Tt(jo(f.resourceSize,{width:n,height:l,depth:c,isPrimitive:this.symbolLayer.isPrimitive}))}),e.graphics3DGraphicPatches.push((m,y)=>{let b=this._computeLocalTransform(f,d,y,yg),S=m.instanceIndex;f.lodRenderer.instanceData.setLocalTransform(S,b,!0)})}_preparePatchColor(e,t){if(!t.material||t.material.type!=="partial")return;let i=t.material.diff;if(!i.color||i.color.type!=="complete"||i.color.newValue==null||i.color.oldValue==null)return;let s=i.color.newValue,a=s!=null?re.toUnitRGBA(s):jt;delete i.color;let o=this._resources;o!=null&&e.graphics3DGraphicPatches.push(n=>{let l;this._hasPerInstanceColor()?(o.lodRenderer.instanceData.setColor(n.instanceIndex,a),l=this._setMaterialTransparencyParameters({},s)):l=this._setMaterialTransparencyParameters({externalColor:a},s);for(let c of o.stageResources.materials)c.setParameters(l)})}_applyObjectRotation(e,t,i){if(!this._fastUpdates?.requiresShaderTransformation||!t)return Mm(e.heading,e.tilt,e.roll,i)}_applyAnchor(e,t,i){if(this._fastUpdates?.requiresShaderTransformation)return;let s=fg(e.resourceBoundingBox,e.pivotOffset,t);s&&Co(i,i,s)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,t,i,s){let a=e!=null?Tt(na(e)):Or,o=e!=null?fg(e,s,this.symbolLayer):hs,n=this._context.renderCoordsHelper.unitInMeters,l=Mc(t??void 0,t,i,n),c=Je(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new ar({size:!0,color:!0,rotation:!0,opacity:!1},a,t??Or,n,o,l,c)}};function fg(r,e,t){let i=_();switch(t.anchor){case"center":te(i,$e(r)),Ei(i,i);break;case"top":{let s=$e(r);A(i,-s[0],-s[1],-r[5]);break}case"bottom":{let s=$e(r);A(i,-s[0],-s[1],-r[2]);break}case"relative":{let s=$e(r),a=na(r),o=t.anchorPosition,n=o?Je(o.x,o.y,o.z):hs;Gp(i,a,n),le(i,i,s),Ei(i,i);break}default:e!=null?Ei(i,e):te(i,hs)}return i}function gg(r){return r.mode!=="absolute-height"}var Hs=_(),yg=V(),Eh=V(),el=Yr(),tl=new lr;var sl=class{constructor(e,t,i,s){this.vertices=e,this.positionsES=t,this.offset=s;let a=e.length,o=Math.floor(a/2),n=this.offset+3*o,l=i[n],c=i[n+1],h=i[n+2];this.origin=Je(l,c,h),this.positions=Ke(3*a);let p=this.offset+3*a;for(let d=this.offset;d<p;d+=3)this.positions[d]=i[d]-l,this.positions[d+1]=i[d+1]-c,this.positions[d+2]=i[d+2]-h;this.updatePathVertexInformation()}get usedMemory(){return Er(this.positions)}updatePathVertexInformation(){let e=this.vertices.length,t=this.vertices[0],i=this.offset,s=this.positions;t.vRight[0]=s[i+3]-s[i],t.vRight[1]=s[i+4]-s[i+1],t.vRight[2]=s[i+5]-s[i+2],i+=3;let a=Kt(t.vRight);t.vMinSiblingLength=a,J(t.vRight,t.vRight);let o=t;for(let n=1;n<e;++n){let l=this.vertices[n];if(l.vLeft=o.vRight,n<e-1){l.vRight[0]=s[i+3]-s[i],l.vRight[1]=s[i+4]-s[i+1],l.vRight[2]=s[i+5]-s[i+2];let c=Kt(l.vRight);l.vMinSiblingLength=Math.min(a,c),a=c,J(l.vRight,l.vRight)}else te(l.vRight,l.vLeft),l.vMinSiblingLength=a;o=l,i+=3}}};var al=class{constructor(e,t,i,s,a,o={}){this.path=e,this.profile=t,this.extruder=i,this.startCap=s,this.endCap=a,this.options=o,this._extrusionVertexCount=0;let n=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*n+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.startCap.vertexBufferStart=this.numVerticesTotal;let l=this.startCap.numVertices;this.numVerticesTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;let c=this.endCap.numVertices;this.numVerticesTotal+=c,this.pathVertexData=Pd(1*this.numVerticesTotal),this.profileRightAxes=Ke(4*this.numVerticesTotal),this.profileUpAxes=Ke(4*this.numVerticesTotal),this.profileVertexAndNormals=Ke(4*this.numVerticesTotal),this.positions=bs(e.positions,e.offset,3*e.vertices.length),this._rebuildGeometry(),this.buildTopology()}get usedMemory(){return Er(this.pathVertexData,this.profileRightAxes,this.profileUpAxes,this.profileVertexAndNormals)+this.path.usedMemory+this.profile.usedMemory}emitVertex(e,t,i,s,a){let o=4*this._extrusionVertexCount;if(this.profileRightAxes[o]=t.right[0],this.profileRightAxes[o+1]=t.right[1],this.profileRightAxes[o+2]=t.right[2],this.profileUpAxes[o]=t.up[0],this.profileUpAxes[o+1]=t.up[1],this.profileUpAxes[o+2]=t.up[2],this.profileVertexAndNormals[o]=i[0],this.profileVertexAndNormals[o+1]=i[1],this.profileVertexAndNormals[o+2]=s[0],this.profileVertexAndNormals[o+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,a){let n=this.path.vertices[e],l=n.maxStretchDistance;this.profileRightAxes[o+3]=n.rotationRight[0]*l,this.profileUpAxes[o+3]=n.rotationRight[1]*l}else this.profileRightAxes[o+3]=0,this.profileUpAxes[o+3]=0;++this._extrusionVertexCount}emitCapVertex(e,t,i,s,a,o){let n=4*this._extrusionVertexCount;this.profileRightAxes[n]=t.right[0],this.profileRightAxes[n+1]=t.right[1],this.profileRightAxes[n+2]=t.right[2],this.profileRightAxes[n+3]=a,this.profileUpAxes[n]=t.up[0],this.profileUpAxes[n+1]=t.up[1],this.profileUpAxes[n+2]=t.up[2],this.profileUpAxes[n+3]=o,this.profileVertexAndNormals[n]=i[0],this.profileVertexAndNormals[n+1]=i[1],this.profileVertexAndNormals[n+2]=s[0],this.profileVertexAndNormals[n+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,++this._extrusionVertexCount}_rebuildGeometry(){this._extrusionVertexCount=0;let{positions:e,offset:t,vertices:i}=this.path;this.positions=bs(e,t,3*i.length);let s=0,a=(n,l,c,h,p)=>this.emitCapVertex(s,n,l,c,h,p),o=(n,l,c,h)=>this.emitVertex(s,n,l,c,h);for(this.startCap.rebuildConnectingProfileGeometry(i[s],this.profile,a),s=1;s<i.length-1;++s)this.extruder.extrude(i[s],this.profile,o);this.endCap.rebuildConnectingProfileGeometry(i[s],this.profile,a),s=0,this.startCap.rebuildCapGeometry(i[s],a),s=i.length-1,this.endCap.rebuildCapGeometry(i[s],a)}buildTopology(){let e=this.profile.vertices.length,t=this.profile.numSegments,i=this.numExtrusionProfiles-1,s=3*(2*(t*i));this.startCap.indexBufferStart=s,this.startCap.firstProfileVertexIndex=0,s+=this.startCap.numIndices,this.endCap.indexBufferStart=s,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);let a=new Array,o=new Array,n=new Array,l=(c,h,p)=>{a.push(c),a.push(h),a.push(p),o.push(c),o.push(h),o.push(p),n.push(this.pathVertexData[c]),n.push(this.pathVertexData[h]),n.push(this.pathVertexData[p])};for(let c=0;c<t;++c){let h=this.profile.indices[2*c],p=this.profile.indices[2*c+1];for(let d=0;d<i;++d){let f=d*e+h,m=(d+1)*e+p,y=d*e+p;l(f,(d+1)*e+h,m),l(f,m,y)}}this.startCap.buildTopology(this.path.vertices[0],l),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],l),this.vertexIndices=Vo(a),this.normalIndices=Vo(o),this.pathVertexIndices=Vo(n)}onPathChanged(){this._rebuildGeometry()}};var $a=class{rebuildConnectingProfileGeometry(e,t,i){for(let s=0;s<t.vertices.length;++s)i(e.frame,t.vertices[s],t.normals[s],0,0)}},Ya=class extends $a{constructor(){super(),this.numVertices=0,this.numIndices=0}rebuildCapGeometry(){}buildTopology(){}},Xi=class extends $a{constructor(e,t=0,i=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=i}get numVertices(){return this.profile.vertices.length}get numIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,i){let s=this.profilePlaneOffset;for(let a=0;a<t.vertices.length;++a)i(e.frame,t.vertices[a],t.normals[a],s,0)}rebuildCapGeometry(e,t){let i=this.profile,s=this.flip?1:-1,a=this.profilePlaneOffset,o=_g;ve(o,0,0);for(let n=0;n<i.vertices.length;++n)t(e.frame,i.vertices[n],o,a,s)}buildTopology(e,t){let i=this.profile,s=this.vertexBufferStart+i.indices[0];for(let a=1;a<i.numSegments;++a){let o=i.indices[2*a],n=i.indices[2*a+1],l=this.vertexBufferStart+o,c=this.vertexBufferStart+n;this.flip?t(c,l,s):t(s,l,c)}}},Za=class extends $a{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}get numVertices(){let e=this.profile.vertices.length*(this.numSegments-1)+this.profile.poles.length;return this.breakNormals&&(e+=this.profile.vertices.length),e}get numIndices(){let e=0,t=this.profile;e+=2*t.numSegments*(this.numSegments-1);for(let i=0;i<t.numSegments;++i){let s=t.indices[2*i],a=t.indices[2*i+1];t.poleIndices[s]===t.poleIndices[a]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){let i=this.profile,s=e.frame,a=.5*this.sign,o=R_,n=_g;ve(n,0,0);for(let l of i.poles)l.normal?t(s,l.position,l.normal,a,0):t(s,l.position,n,a,this.sign);if(this.breakNormals)for(let l=0;l<i.vertices.length;++l)t(s,i.vertices[l],i.normals[l],0,0);for(let l=0;l<this.numSegments-1;++l){let c=(1-(l+1)/this.numSegments)*Math.PI*.5,h=Math.sin(c),p=Math.cos(c);for(let d=0;d<i.vertices.length;++d){let f=i.poles[i.poleIndices[d]];dd(o,i.vertices[d],f.position),er(o,o,h),f.normal?(la(o,o,f.position),t(s,o,f.normal,a*p,0)):(Lo(n,o),er(n,n,h),la(o,o,f.position),t(s,o,n,a*p,this.sign*p))}}}buildTopology(e,t){let i=this.profile,s=this.breakNormals?this.vertexBufferStart+i.poles.length:this.firstProfileVertexIndex,a=this.breakNormals?this.vertexBufferStart+i.poles.length+i.vertices.length:this.vertexBufferStart+i.poles.length;for(let o=0;o<i.numSegments;++o){let n=i.indices[2*o],l=i.indices[2*o+1],c=this.vertexBufferStart+i.poleIndices[n],h=this.vertexBufferStart+i.poleIndices[l],p=s+n,d=s+l;for(let f=0;f<this.numSegments-1;++f){let m=a+f*i.vertices.length+n,y=a+f*i.vertices.length+l;this.flip?(t(m,d,p),t(d,m,y)):(t(p,d,m),t(y,m,d)),p=m,d=y}this.flip?(t(c,d,p),c!==h&&t(c,h,d)):(t(p,d,c),c!==h&&t(d,h,c))}}},R_=W(),_g=W();var ol=class{numProfilesPerJoin(){return 1}extrude(e,t,i){for(let s=0;s<t.vertices.length;++s)i(e.frame,t.vertices[s],t.normals[s],!1)}},ks=class{constructor(e,t){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,i){let s=w_,{rotationAngle:a,rotationRight:o,frame:n}=e;if(Math.abs(a)>=this.cutoffAngle){let l=e.rotationFrameUp;for(let c=0;c<this.numBendSubdivisions+1;++c){Wp(vg,.5*-a+c*a/this.numBendSubdivisions,l),O_(s,n,vg);for(let h=0;h<t.vertices.length;++h)fs(t.vertices[h],o)*a>=0?i(s,t.vertices[h],t.normals[h],!1):i(n,e.applyMiterStretch(bg,t.vertices[h]),t.normals[h],!0)}}else for(let l=0;l<this.numBendSubdivisions+1;++l)for(let c=0;c<t.vertices.length;++c){let h=fs(t.vertices[c],o)*a>=0;i(n,e.applyMiterStretch(bg,t.vertices[c]),t.normals[c],!h)}}},Qa=class{constructor(){this.up=_(),this.right=_()}};function O_(r,e,t){X(r.up,e.up,t),X(r.right,e.right,t)}var bg=W(),vg=V(),w_=new Qa;var nl=class extends ht{constructor(e,t,i,s,a,o){super(e,t,null,et.Mesh,o),this.path=i,this.geometrySR=s,this.stencilWidth=a}},zt;function ll(r){return"path"in r}(function(r){r[r.World=0]="World",r[r.Path=1]="Path"})(zt||(zt={}));var cl=class{constructor(e){this.builder=e}onPathChanged(e){this.builder.onPathChanged()}},Ja=class extends cl{constructor(e){super(e),this.vertexAttributeColor=ye(255,255,255,255),this.size=new Array,this.vertexAttributePosition=Ke(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;let{numVerticesTotal:t,pathVertexData:i,path:s,positions:a,profileRightAxes:o,profileUpAxes:n,profileVertexAndNormals:l}=this.builder;for(let c=0;c<t;++c){let h=i[c],p=h===0||h===s.vertices.length-1;h*=3;let d=I_,f=0,m=0,y=4*c,b=A(D_,o[y],o[y+1],o[y+2]),S=A(G_,n[y],n[y+1],n[y+2]),x=ve(xg,l[y]*e[0],l[y+1]*e[1]);if(p)qe(d,S,b),f=o[y+3]*e[0],m=n[y+3];else{let P=A_,T=T_;ve(P,o[y+3],n[y+3]);let D=ud(P);Lo(P,P);let I=fs(x,P);if(Math.abs(I)>D){ve(T,-P[1],P[0]);let G=fs(x,T);er(P,P,D*Math.sign(I)),er(T,T,G),la(x,P,T)}A(d,0,0,0)}let w=A(L_,b[0]*x[0]+S[0]*x[1],b[1]*x[0]+S[1]*x[1],b[2]*x[0]+S[2]*x[1]),E=3*c;this.vertexAttributePosition[E]=a[h]+w[0]+d[0]*f,this.vertexAttributePosition[E+1]=a[h+1]+w[1]+d[1]*f,this.vertexAttributePosition[E+2]=a[h+2]+w[2]+d[2]*f;let C=ve(xg,l[y+2],l[y+3]);Uo(this.vertexAttributeNormal,c,b[0]*C[0]+S[0]*C[1]+d[0]*m,b[1]*C[0]+S[1]*C[1]+d[1]*m,b[2]*C[0]+S[2]*C[1]+d[2]*m)}}createGeometryData(){let e=this.builder.vertexIndices.length,{normalIndices:t,vertexIndices:i}=this.builder;return[[g.POSITION,new j(this.vertexAttributePosition,i,3,!0)],[g.NORMALCOMPRESSED,new j(this.vertexAttributeNormal,t,2,!0)],[g.COLOR,new j(this.vertexAttributeColor,Xr(e),4)]]}onPathChanged(e){super.onPathChanged(e),this.bake(this.size)}intersect(e,t,i,s){let a=this.builder.vertexIndices,o=new _u(this.vertexAttributePosition,3),n=a.length/3;Fu(e,t,0,n,a,o,void 0,i,(l,c,h)=>{s(l,h,c,!1)})}},hl=class extends cl{constructor(e,t,i,s){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=i,this.opacityAttributeValue=s,this.vvData=null,this.baked=new Ja(e),this.vvData=Ke(4*this.builder.path.vertices.length);for(let a=0;a<this.builder.path.vertices.length;++a){this.vvData[4*a]=t,this.vvData[4*a+1]=i,this.vvData[4*a+2]=s;let o=a===0||a===this.builder.path.vertices.length-1;this.vvData[4*a+3]=o?1:0}}createGeometryData(){let{positions:e,profileRightAxes:t,profileUpAxes:i,profileVertexAndNormals:s,pathVertexIndices:a,vertexIndices:o}=this.builder;return[[g.POSITION,new j(e,a,3,!0)],[g.PROFILERIGHT,new j(t,o,4,!0)],[g.PROFILEUP,new j(i,o,4,!0)],[g.PROFILEVERTEXANDNORMAL,new j(s,o,4,!0)],[g.FEATUREVALUE,new j(this.vvData,a,4,!0)]]}onPathChanged(e){super.onPathChanged(e);let t=e.getMutableAttribute(g.POSITION);t&&(t.data=this.builder.positions)}},xg=W(),A_=W(),T_=W(),L_=_(),I_=_(),D_=_(),G_=_();function Sg(r,e){let t=null,i=r.vertices.length,s=.99619469809,a=_(),o=_(),n=_(),l=_(),c=_(),h=_(),p=vt(),d=r.vertices[0];te(o,e),A(a,0,1,0),Ic(d.vRight,o,a,a,n,o,s),te(d.frame.up,o),te(d.frame.right,n);let f=r.positions,m=r.offset;t=d;for(let y=1;y<i;++y){d=r.vertices[y],le(c,d.vLeft,d.vRight);let b=Kt(c);b>0?(b=1/Math.sqrt(b),c[0]=c[0]*b,c[1]=c[1]*b,c[2]=c[2]*b):(c[0]=d.vRight[0],c[1]=d.vRight[1],c[2]=d.vRight[2]),h[0]=f[m]+t.frame.up[0],h[1]=f[m+1]+t.frame.up[1],h[2]=f[m+2]+t.frame.up[2],m+=3;let S=A(M_,f[m],f[m+1],f[m+2]);uu(S,c,p),fu(p,ya(h,d.vLeft),l)?(l[0]-=f[m],l[1]-=f[m+1],l[2]-=f[m+2],J(o,l),qe(n,c,o),J(n,n)):Ic(c,t.frame.up,t.frame.right,a,n,o,s),te(d.frame.up,o),te(d.frame.right,n),t=d}}var M_=_();var pl=class{constructor(){this.vertices=new Array,this.normals=new Array,this.indices=new Array,this.poles=new Array,this.poleIndices=new Array}addVertex(e,t){return this.vertices.push(ca(e)),this.normals.push(ca(t)),this.vertices.length-1}addPole(e,t=null){return this.poles.push({position:ca(e),normal:t?ca(t):null}),this.poles.length-1}addSegment(e,t=null){this.indices.push(e.v0),this.indices.push(e.v1),t&&(this.poleIndices.push(t.v0),this.poleIndices.push(t.v1))}get numSegments(){return this.indices.length/2}translate(e,t){for(let i of this.vertices)i[0]+=e,i[1]+=t;for(let i of this.poles)i.position[0]+=e,i.position[1]+=t}get usedMemory(){return this.vertices.length*Er(this.vertices[0])*2+Er(this.indices)}},Cg={top:[0,-.5],bottom:[0,.5]};function Rh(r){let t=10,i=new pl,s={v0:0,v1:0};i.addPole(B(0,0));for(let o=0;o<t;++o){let n=2*o*Math.PI/t,l=Math.cos(n),c=Math.sin(n),h=B(l*.5,c*.5),p=B(l,c);i.addVertex(h,p)}for(let o=0;o<t-1;++o){let n={v0:o,v1:o+1};i.addSegment(n,s)}let a={v0:t-1,v1:0};if(i.addSegment(a,s),r!=="center"){let o=Cg[r];i.translate(o[0],o[1])}return i}var Pg={center:Rh("center"),top:Rh("top"),bottom:Rh("bottom")},Eg={center:Oh("center"),top:Oh("top"),bottom:Oh("bottom")};function Oh(r){let i=new pl,s=B(.5*-1,.5*-1),a=B(.5*1,.5*-1),o=B(.5*1,.5*1),n=B(.5*-1,.5*1),l=B(0,-1),c=B(1,0),h=B(0,1),p=B(-1,0);if(i.addPole(B(0,.5*1),h),i.addPole(B(0,.5*1)),i.addPole(B(0,.5*-1)),i.addPole(B(0,.5*-1),l),i.addVertex(s,l),i.addVertex(a,l),i.addSegment({v0:0,v1:1},{v0:3,v1:3}),i.addVertex(a,c),i.addVertex(o,c),i.addSegment({v0:2,v1:3},{v0:2,v1:1}),i.addVertex(o,h),i.addVertex(n,h),i.addSegment({v0:4,v1:5},{v0:0,v1:0}),i.addVertex(n,p),i.addVertex(s,p),i.addSegment({v0:6,v1:7},{v0:1,v1:2}),r!=="center"){let d=Cg[r];i.translate(d[0],d[1])}return i}function V_(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r}function U_(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=1,r}function wh(r,e,t,i,s){return r[0]=e,r[1]=t,r[2]=i,r[3]=s,r}function F_(r,e){if(r===e){let t=e[1];r[1]=e[2],r[2]=t}else r[0]=e[0],r[1]=e[2],r[2]=e[1],r[3]=e[3];return r}function B_(r,e){let t=e[0],i=e[1],s=e[2],a=e[3],o=t*a-s*i;return o?(o=1/o,r[0]=a*o,r[1]=-i*o,r[2]=-s*o,r[3]=t*o,r):null}function N_(r,e){let t=e[0];return r[0]=e[3],r[1]=-e[1],r[2]=-e[2],r[3]=t,r}function z_(r){return r[0]*r[3]-r[2]*r[1]}function Rg(r,e,t){let i=e[0],s=e[1],a=e[2],o=e[3],n=t[0],l=t[1],c=t[2],h=t[3];return r[0]=i*n+a*l,r[1]=s*n+o*l,r[2]=i*c+a*h,r[3]=s*c+o*h,r}function j_(r,e,t){let i=e[0],s=e[1],a=e[2],o=e[3],n=Math.sin(t),l=Math.cos(t);return r[0]=i*l+a*n,r[1]=s*l+o*n,r[2]=i*-n+a*l,r[3]=s*-n+o*l,r}function H_(r,e,t){let i=e[0],s=e[1],a=e[2],o=e[3],n=t[0],l=t[1];return r[0]=i*n,r[1]=s*n,r[2]=a*l,r[3]=o*l,r}function k_(r,e){let t=Math.sin(e),i=Math.cos(e);return r[0]=i,r[1]=t,r[2]=-t,r[3]=i,r}function W_(r,e){return r[0]=e[0],r[1]=0,r[2]=0,r[3]=e[1],r}function q_(r){return"mat2("+r[0]+", "+r[1]+", "+r[2]+", "+r[3]+")"}function $_(r){return Math.sqrt(r[0]**2+r[1]**2+r[2]**2+r[3]**2)}function Y_(r,e,t,i){return r[2]=i[2]/i[0],t[0]=i[0],t[1]=i[1],t[3]=i[3]-r[2]*t[1],[r,e,t]}function Z_(r,e,t){return r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r[3]=e[3]+t[3],r}function Og(r,e,t){return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r[3]=e[3]-t[3],r}function Q_(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]}function J_(r,e){let t=r[0],i=r[1],s=r[2],a=r[3],o=e[0],n=e[1],l=e[2],c=e[3],h=Ip();return Math.abs(t-o)<=h*Math.max(1,Math.abs(t),Math.abs(o))&&Math.abs(i-n)<=h*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(s-l)<=h*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(a-c)<=h*Math.max(1,Math.abs(a),Math.abs(c))}function X_(r,e,t){return r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r[3]=e[3]*t,r}function K_(r,e,t,i){return r[0]=e[0]+t[0]*i,r[1]=e[1]+t[1]*i,r[2]=e[2]+t[2]*i,r[3]=e[3]+t[3]*i,r}var eb=Rg,tb=Og,T1=Object.freeze(Object.defineProperty({__proto__:null,LDU:Y_,add:Z_,adjoint:N_,copy:V_,determinant:z_,equals:J_,exactEquals:Q_,frob:$_,fromRotation:k_,fromScaling:W_,identity:U_,invert:B_,mul:eb,multiply:Rg,multiplyScalar:X_,multiplyScalarAndAdd:K_,rotate:j_,scale:H_,set:wh,str:q_,sub:tb,subtract:Og,transpose:F_},Symbol.toStringTag,{value:"Module"}));function Ah(){return[1,0,0,1]}function rb(r){return[r[0],r[1],r[2],r[3]]}function ib(r,e,t,i){return[r,e,t,i]}function sb(r,e){return new Float64Array(r,e,4)}var I1=Object.freeze(Object.defineProperty({__proto__:null,clone:rb,create:Ah,createView:sb,fromValues:ib},Symbol.toStringTag,{value:"Module"}));var ul=class{constructor(){this.vLeft=_(),this.vRight=_(),this.vMinSiblingLength=0,this.frame=new Qa}setFrameFromUpVector(e){te(this.frame.up,e),le(Ka,this.vLeft,this.vRight),J(Ka,Ka),k(Tg,this.frame.up,z(Ka,this.frame.up)),de(dl,Ka,Tg),J(dl,dl),qe(this.frame.right,dl,this.frame.up)}get foldingAngle(){return Math.PI-this.rotationAngle}},Th=class extends ul{get rotationFrameUp(){return this.frame.up}get rotationRight(){return vd}get rotationAngle(){return k(yi,this.frame.up,z(this.frame.up,this.vLeft)),de(yi,this.vLeft,yi),Ei(yi,yi),J(yi,yi),k(qs,this.frame.up,z(this.frame.up,this.vRight)),de(qs,this.vRight,qs),J(qs,qs),qe(ml,this.rotationFrameUp,this.vLeft),Math.sign(z(ml,this.vRight))*(Math.PI-ec(z(yi,qs)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength/Math.cos(.5*this.foldingAngle))}applyMiterStretch(e,t){let i=this.rotationAngle;if(Math.abs(i)<=0)return t;let s=vo(Math.cos(.5*i));return ve(e,(s-1+1)*t[0],t[1])}},Lh=class extends ul{get rotationFrameUp(){let e=Math.sign(z(this.frame.right,this.vRight));return qe(Xa,this.vRight,this.vLeft),k(Xa,Xa,e),J(Xa,Xa)}get rotationRight(){let e=this.rotationFrameUp,t=z(e,this.frame.up),i=z(e,this.frame.right);return k(Ws,this.frame.up,-i),k(Ag,this.frame.right,t),le(Ws,Ws,Ag),J(Ws,Ws),ab(wg,this.frame,Ws),wg}get rotationAngle(){let e=Math.sign(z(this.frame.right,this.vRight));return Ei(ml,this.vLeft),-e*(Math.PI-ec(z(ml,this.vRight)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength*vo(Math.cos(.5*this.foldingAngle)))}applyMiterStretch(e,t){let i=this.rotationAngle;if(Math.abs(i)===0)return t;let s=vo(Math.cos(.5*i)),a=this.rotationRight,o=wh(ob,1+(s-1)*a[0]*a[0],(s-1)*a[0]*a[1],(s-1)*a[0]*a[1],1+(s-1)*a[1]*a[1]);return md(e,t,o)}};function ab(r,e,t){ve(r,z(t,e.right),z(t,e.up))}function Lg(r){switch(r){case zt.World:return new Th;case zt.Path:return new Lh}}var Xa=_(),wg=W(),Ws=_(),Ag=_(),ml=_(),yi=_(),qs=_(),Tg=_(),Ka=_(),dl=_(),ob=Ah();var Ih=new Map([[g.POSITION,0],[g.PROFILERIGHT,1],[g.PROFILEUP,2],[g.PROFILEVERTEXANDNORMAL,3],[g.FEATUREVALUE,4],[g.OBJECTANDLAYERIDCOLOR,5]]),fl=class extends km{constructor(){super(...arguments),this.ambient=Je(.2,.2,.2),this.diffuse=Je(.8,.8,.8),this.specular=Je(0,0,0),this.opacity=1,this.origin=_(),this.modelTransformation=null}},eo=class r extends Gt{initializeConfiguration(e,t){t.spherical=e.viewingMode===Me.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Mt(e.rctx,r.shader.get().build(this.configuration),Ih)}initializePipeline(){let e=this.configuration.transparencyPassType,t=this.configuration,i=e===He.NONE,s=e===He.FrontFace;return Ze({blending:t.output===L.Color&&t.transparent?i?sr:ii(e):null,culling:t.hasSlicePlane&&!t.transparent&&t.doubleSidedMode!==ti.None?Gu:null,depthTest:{func:si(e)},depthWrite:i||s?xt:null,drawBuffers:t.output===L.Depth?{buffers:[_s.NONE]}:ai(e),colorWrite:pt,stencilWrite:t.hasOccludees?Gr:null,stencilTest:t.hasOccludees?ni:null,polygonOffset:i||s?null:Vu})}};eo.shader=new Dt(Wm,()=>import("./chunk-FD56KESS.js"));var ce=class extends or{constructor(){super(...arguments),this.output=L.Color,this.doubleSidedMode=ti.None,this.transparencyPassType=He.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1,this.objectAndLayerIdColorInstanced=!1}};u([R({count:L.COUNT})],ce.prototype,"output",void 0),u([R({count:ti.COUNT})],ce.prototype,"doubleSidedMode",void 0),u([R({count:He.COUNT})],ce.prototype,"transparencyPassType",void 0),u([R()],ce.prototype,"spherical",void 0),u([R()],ce.prototype,"receiveShadows",void 0),u([R()],ce.prototype,"receiveAmbientOcclusion",void 0),u([R()],ce.prototype,"vvSize",void 0),u([R()],ce.prototype,"vvColor",void 0),u([R()],ce.prototype,"vvOpacity",void 0),u([R()],ce.prototype,"hasSlicePlane",void 0),u([R()],ce.prototype,"transparent",void 0),u([R()],ce.prototype,"hasOccludees",void 0),u([R()],ce.prototype,"multipassEnabled",void 0),u([R()],ce.prototype,"cullAboveGround",void 0),u([R()],ce.prototype,"doublePrecisionRequiresObfuscation",void 0),u([R({constValue:!1})],ce.prototype,"occlusionPass",void 0),u([R({constValue:Xo.Disabled})],ce.prototype,"pbrMode",void 0),u([R({constValue:!0})],ce.prototype,"hasVvInstancing",void 0),u([R({constValue:!1})],ce.prototype,"useCustomDTRExponentForWater",void 0),u([R({constValue:!1})],ce.prototype,"useFillLights",void 0),u([R({constValue:!1})],ce.prototype,"hasColorTexture",void 0);var gl=class r extends ri{constructor(e){super(e,new Gh),this.supportsEdges=!0,this.produces=new Map([[H.OPAQUE_MATERIAL,t=>(this.parameters.castShadows&&Pc(t)||Ec(t))&&!this.parameters.transparent],[H.TRANSPARENT_MATERIAL,t=>(this.parameters.castShadows&&Pc(t)||Ec(t))&&this.parameters.transparent]]),this._vertexAttributeLocations=Ih,this._configuration=new ce,this._vertexBufferLayout=r.getVertexBufferLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,e===L.Color&&(this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?ti.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?ti.WindingOrder:ti.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=t.ssao!=null),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}isVisibleForOutput(e){return e!==L.Shadow&&e!==L.ShadowExcludeHighlight&&e!==L.ShadowHighlight||this.parameters.castShadows}isVisible(){return super.isVisible()&&this.parameters.opacity>0}intersect(e,t,i,s,a,o){let n=e;if(!ll(n))return;let l=n.path,c=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSize){let{offset:S,factor:x,minSize:w,maxSize:E}=this.parameters.vvSize,C=l.sizeAttributeValue;c[0]*=Ri(S[0]+C*x[0],w[0],E[0]),c[1]*=Ri(S[2]+C*x[2],w[2],E[2])}let h=new Uu(!1,i.options.normalRequired),p=Math.max(c[0],c[1]),d=e.boundingInfo;if(d==null)return void Ig(l,c,s,a,h,o);let f=qp(d.bbMin[0]-p,d.bbMin[1]-p,d.bbMin[2]-p,d.bbMax[0]+p,d.bbMax[1]+p,d.bbMax[2]+p),m=[a[0]-s[0],a[1]-s[1],a[2]-s[2]],y=Math.sqrt(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]),b=[y/m[0],y/m[1],y/m[2]];Bu(f,s,b,i.tolerance)&&Ig(l,c,s,a,h,o)}createBufferWriter(){return new oi(this._vertexBufferLayout)}createGLMaterial(e){return new Dh(e)}static getVertexBufferLayout(){let e=Lt().vec3f(g.POSITION).vec4f(g.PROFILERIGHT).vec4f(g.PROFILEUP).vec4f(g.PROFILEVERTEXANDNORMAL).vec4f(g.FEATUREVALUE);return Ve("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(g.OBJECTANDLAYERIDCOLOR),e}},Dh=class extends ir{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}_updateShadowState(e){this.technique!=null&&e.shadowMap.enabled===this.technique.configuration.receiveShadows||this._material.setParameters({receiveShadows:e.shadowMap.enabled})}beginSlot(e){return this._output===L.Color&&(this._updateShadowState(e),this._updateOccludeeState(e)),this.ensureTechnique(eo,e)}};function Ig(r,e,t,i,s,a){r.baked.size&&r.baked.size[0]===e[0]&&r.baked.size[1]===e[1]||r.baked.bake(e),r.baked.intersect(t,i,s,a)}var Gh=class extends fl{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1}};var nb=["polyline"],yl=class extends Se{constructor(e,t,i,s){super(e,t,i,s),this._intrinsicSize=B(1,1),this._upVectorAlignment=zt.Path,this._stencilWidth=.1,this.usedMemory=0,this.ensureDrapedStatus(!1)}doLoad(){return O(this,null,function*(){let e=this.symbolLayer.width!=null?this.symbolLayer.width:this.symbolLayer.height,t=this.symbolLayer.height!=null?this.symbolLayer.height:e;this._vvConvertOptions=new ar({size:!0,color:!0,rotation:!1,opacity:!0},[1,1,1],[e,1,t],this._context.renderCoordsHelper.unitInMeters),this._fastUpdates=this._context.renderer?.visualVariables?.length>0?kt(this._context.renderer,this._vvConvertOptions):null;let i=this.symbolLayer.anchor||"center";this._upVectorAlignment=this.symbolLayer.profileRotation==="heading"?zt.World:zt.Path;let s=this.symbolLayer.profile||"circle";switch(s){default:case"circle":this._profile=Pg[i];break;case"quad":this._profile=Eg[i]}switch(this.symbolLayer.join){case"round":this._extruder=new ks(0,3);break;case"bevel":this._extruder=new ks(0,1);break;case"miter":this._extruder=new ks(.8*Math.PI,1);break;default:this._extruder=new ol}let a=this.symbolLayer.cap||"butt";switch(a){case"none":this._startCap=new Ya,this._endCap=new Ya;break;case"butt":default:this._startCap=new Xi(this._profile,0),this._endCap=new Xi(this._profile,0,!0);break;case"square":this._startCap=new Xi(this._profile,-.5),this._endCap=new Xi(this._profile,.5,!0);break;case"round":{let d=s==="quad";this._startCap=new Za({profile:this._profile,flip:!1,breakNormals:d,subdivisions:3}),this._endCap=new Za({profile:this._profile,flip:!0,breakNormals:d,subdivisions:3});break}}let o=this.symbolLayer?.material?.color,n=this._getCombinedOpacityAndColor(o),l=Tt(n),c=n[3],h=c<1||this.needsDrivenTransparentPass,p={diffuse:l,ambient:l,opacity:c,transparent:h,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:h||a==="none"?Re.None:Re.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(ve(this._intrinsicSize,e,t),!Vc(this._intrinsicSize[0])||!Vc(this._intrinsicSize[1])))throw new _e("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(this._fastUpdates?.visualVariables.size||er(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates){let d=Pe(Z(Z({},p),this._fastUpdates.materialParameters),{size:_d(this._intrinsicSize)});this._materials[0]=new gl(d)}else p.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,p.normalType=Yo.Compressed,this._materials[0]=new St(p);this._materials[0].setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._materials[0])})}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials[0]=null,this._materials.length=0}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,nb,this.symbolLayer.type))return null;let i=this.setGraphicElevationContext(t),s=e.renderingInfo;return this._createAs3DShape(t,s,i,t.uid)}layerOpacityChanged(){let e=this.symbolLayer?.material?.color,t=this._getCombinedOpacity(e),i=t<1||this.needsDrivenTransparentPass;this._materials[0]?.setParameters({opacity:t,transparent:i})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Vt)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._materials[0]?.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}applyRendererDiff(e,t){for(let i in e.diff){if(i!=="visualVariables")return N.RecreateSymbol;if(!Wt(this._fastUpdates,t,this._vvConvertOptions))return N.RecreateSymbol;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return N.FastUpdate}_getVertexData(e){let t=0,i=e.paths,s=[],a=e.spatialReference,o=this._context.elevationProvider.spatialReference,n=this._context.renderCoordsHelper.spatialReference;for(let p of i)t+=p.length;let l=Fe(3*t),c,h=0;for(let p of i){s.push({offset:h,numVertices:p.length});for(let d of p)l[h++]=d[0],l[h++]=d[1],l[h++]=e.hasZ?d[2]:0}return o==null||a.equals(o)||Ue(l,a,0,l,o,0,t)?(o==null||o.equals(n)?c=Dd(l):(c=Fe(3*t),Ue(l,o,0,c,n,0,t)),{pathVertexDataInfos:s,vertexDataES:l,vertexDataRS:c}):null}_createAs3DShape(e,t,i,s){this.usedMemory=0;let a=e.geometry,o=this._getVertexData(a);if(o==null)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(o.pathVertexDataInfos.length===0)return a.paths.length!==0&&a.paths.some(m=>m.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;let n=new Array,l=a.spatialReference,c=K(),h=this._context.renderCoordsHelper,p=new Es(o.vertexDataES);for(let m of o.pathVertexDataInfos){let y=m.numVertices;if(y<2)continue;let b=m.offset;if(this._context.clippingExtent!=null&&(F(c),Ge(c,o.vertexDataES,b,y),!ze(c,this._context.clippingExtent)))continue;let S=new Array,x=b+3*y;for(let I=b;I<x;I+=3){p.offset=I;let G=wm(p,this._context.elevationProvider,i,h);A(ae,o.vertexDataRS[I],o.vertexDataRS[I+1],o.vertexDataRS[I+2]),h.setAltitude(ae,G),o.vertexDataRS[I]=ae[0],o.vertexDataRS[I+1]=ae[1],o.vertexDataRS[I+2]=ae[2],S.push(Lg(this._upVectorAlignment))}let w=new sl(S,o.vertexDataES,o.vertexDataRS,b);Gg(w,this._upVectorAlignment,this._context.renderCoordsHelper);let E=new al(w,this._profile,this._extruder,this._startCap,this._endCap),C=null;if(this._fastUpdates){let I=this._fastUpdates.visualVariables,G=tt(I.size?.field,e)??0,ne=tt(I.color?.field,e)??0,U=tt(I.opacity?.field,e)??0;C=new hl(E,G,ne,U)}else{let I=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){let U=t.size;I[0]*=Dg(U[0],U[2]==="symbol-value"?this.symbolLayer.height||0:U[2],this.symbolLayer.width||0),I[1]*=Dg(U[2],U[0]==="symbol-value"?this.symbolLayer.width||0:U[0],this.symbolLayer.height||0)}let G;this._drivenProperties.color&&(G=t.color),this._drivenProperties.opacity&&t.opacity!=null&&(G=G?[G[0],G[1],G[2],t.opacity]:[1,1,1,t.opacity]);let ne=new Ja(E);ne.bake(I),G&&ne.bakeVertexColors(G),C=ne}let P=C.createGeometryData(),T=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:this._context.layer.uid}),D=new nl(this._materials[0],P,C,l,this._stencilWidth,T);D.transformation=Co(V(),Li,E.path.origin),n.push(D),this.usedMemory+=E.usedMemory}if(n.length===0)return null;let d=new dt({geometries:n,layerUid:this._context.layer.uid,graphicUid:s}),f=new xe(this,d,n,null,null,(m,y,b,S,x)=>cb(m,y,S,x,this._upVectorAlignment),i);return f.alignedSampledElevation=0,f.needsElevationUpdates=Vt(i.mode),f}};function Gg(r,e,t){let{origin:i,positions:s}=r,a=r.offset;switch(e){default:case zt.World:for(let o of r.vertices)ae[0]=s[a++]+i[0],ae[1]=s[a++]+i[1],ae[2]=s[a++]+i[2],t.worldUpAtPosition(ae,ae),o.setFrameFromUpVector(ae);break;case zt.Path:ae[0]=s[a]+i[0],ae[1]=s[a+1]+i[1],ae[2]=s[a+2]+i[2],t.worldUpAtPosition(ae,ae),Sg(r,ae)}}function Dg(r,e,t){switch(r){case"symbol-value":return t;case"proportional":return e;default:return r}}function lb(r,e,t,i){let s=0,{origin:a,vertices:o,positions:n,positionsES:l}=r,c=r.offset+3*o.length;for(let h=r.offset;h<c;h+=3)A(ae,l[h],l[h+1],l[h+2]),t(ae,Mh),s+=Mh.sampledElevation,ae[0]=n[h]+a[0],ae[1]=n[h+1]+a[1],ae[2]=n[h+2]+a[2],i.setAltitude(ae,Mh.z),n[h]=ae[0]-a[0],n[h+1]=ae[1]-a[1],n[h+2]=ae[2]-a[2];return r.updatePathVertexInformation(),s/o.length}function cb(r,e,t,i,s){let a=r.stageObject,o=a.geometries,n=0;for(let l of o){if(!ll(l))continue;let c=l.path,h=c.builder.path;n+=lb(h,e,t,i),s!==zt.World&&Gg(h,s,i),c.onPathChanged(l),l.invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(l,g.POSITION)}return n/o.length}var ae=_(),Mh=new lr;function Vg(r,e,t,i,s=1){if(t.isGeographic&&i===Me.Global){let c=Fe(e.length),h=e.length,p=Pi(t);for(let d=0;d<h;d+=3)nd(e,d,c,d,p);e=c}ve(Ce,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let c=0;c<e.length;c+=3)Ce[0]=Math.min(Ce[0],e[c]),Ce[1]=Math.min(Ce[1],e[c+1]);let a=Ce[0]%s,o=Ce[1]%s,n=Ce[0]-a,l=Ce[1]-o;for(let c=0;c<e.length;c+=3){let h=c/3*4;r[h]=(e[c]-n)/s,r[h+1]=(e[c+1]-l)/s,r[h+2]=n/s,r[h+3]=l/s}}function vl(r,e,t,i,s=1){A(Ki,1,0,0),A(es,0,1,0),A(Ys,0,0,1),pb(Vh,t),mu(Mg,t)&&hb(Mg,Ki,es,Ys,i,Vh),ve(Ce,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),ve(ts,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let h=0;h<t.length;h+=3){A($s,t[h],t[h+1],t[h+2]);let p=z(Ki,$s),d=z(es,$s);Ce[0]=Math.min(Ce[0],p),Ce[1]=Math.min(Ce[1],d),ts[0]=Math.max(ts[0],p),ts[1]=Math.max(ts[1],d)}let a=z(Ys,Vh);Fh(_i,Ce[0],Ce[1],a,Ki,es,Ys),Fh(rs,ts[0],Ce[1],a,Ki,es,Ys),Fh(is,Ce[0],ts[1],a,Ki,es,Ys),de(rs,rs,_i),k(rs,rs,.5),de(is,is,_i),k(is,is,.5),le(_i,_i,rs),le(_i,_i,is);let o=Ce[0]%s,n=Ce[1]%s,l=Ce[0]-o,c=Ce[1]-n;for(let h=0;h<t.length;h+=3){A($s,t[h],t[h+1],t[h+2]);let p=h/3,d=4*p;r[d]=(z(Ki,$s)-l)/s,r[d+1]=(z(es,$s)-c)/s,r[d+2]=l/s,r[d+3]=c/s;let f=9*p;for(let m=0;m<3;m++)e[f+m]=_i[m],e[f+m+3]=rs[m],e[f+m+6]=is[m]}}var Vh=_(),$s=_(),Mg=vt(),Ki=_(),es=_(),Ys=_(),Ce=W(),ts=W(),_i=_(),rs=_(),is=_();function hb(r,e,t,i,s,a){s!=null?(s.basisMatrixAtPosition(a,gr),A(_l,gr[0],gr[1],gr[2]),A(bl,gr[4],gr[5],gr[6]),A(Uh,gr[8],gr[9],gr[10])):(A(_l,1,0,0),A(bl,0,1,0),A(Uh,0,0,1));let o=r;z(o,Uh)<0&&k(o,o,-1),te(i,o);let n=z(o,bl),l=z(o,_l);Math.abs(n)>Math.abs(l)?(ps(e,_l,o,-l),J(e,e),qe(t,e,o),J(t,t),k(t,t,-1)):(ps(t,bl,o,-n),J(t,t),qe(e,t,o),J(e,e))}var gr=V(),_l=_(),bl=_(),Uh=_();function pb(r,e){A(to,0,0,0);for(let t=0;t<e.length-3;t+=3)to[0]+=e[t],to[1]+=e[t+1],to[2]+=e[t+2];k(r,to,1/(e.length/3-1))}var to=_();function Fh(r,e,t,i,s,a,o){A(r,e*s[0]+t*a[0]+i*o[0],e*s[1]+t*a[1]+i*o[1],e*s[2]+t*a[2]+i*o[2])}var ro=class r extends Gt{initializeProgram(e){return new Mt(e.rctx,r.shader.get().build(this.configuration),Ve("enable-feature:objectAndLayerId-rendering")?Nh:Bh)}_setPipelineState(e,t){let i=this.configuration,s=e===He.NONE,a=e===He.FrontFace;return Ze({blending:i.output===L.Color?s?sr:ii(e):null,culling:Mu(i.cullFace),depthTest:i.draped?null:{func:si(e)},depthWrite:i.draped?null:s?xt:Cs(e),drawBuffers:i.output===L.Depth?{buffers:[_s.NONE]}:ai(e),colorWrite:pt,stencilWrite:i.hasOccludees?Gr:null,stencilTest:i.hasOccludees?t?Vi:ni:null,polygonOffset:s||a?i.polygonOffset?db:null:tn(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}};ro.shader=new Dt(qm,()=>import("./chunk-AIETJZWZ.js"));var db={factor:1,units:1},ue=class extends or{constructor(){super(...arguments),this.output=L.Color,this.cullFace=Re.None,this.transparencyPassType=He.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasOccludees=!1,this.enableOffset=!0,this.multipassEnabled=!1,this.cullAboveGround=!1,this.vvColor=!1,this.objectAndLayerIdColorInstanced=!1}};u([R({count:L.COUNT})],ue.prototype,"output",void 0),u([R({count:Re.COUNT})],ue.prototype,"cullFace",void 0),u([R({count:qt.COUNT})],ue.prototype,"style",void 0),u([R({count:He.COUNT})],ue.prototype,"transparencyPassType",void 0),u([R()],ue.prototype,"hasSlicePlane",void 0),u([R()],ue.prototype,"hasVertexColors",void 0),u([R()],ue.prototype,"polygonOffset",void 0),u([R()],ue.prototype,"hasOccludees",void 0),u([R()],ue.prototype,"patternSpacing",void 0),u([R()],ue.prototype,"lineWidth",void 0),u([R()],ue.prototype,"enableOffset",void 0),u([R()],ue.prototype,"draped",void 0),u([R()],ue.prototype,"multipassEnabled",void 0),u([R()],ue.prototype,"cullAboveGround",void 0),u([R()],ue.prototype,"vvColor",void 0),u([R({constValue:!0})],ue.prototype,"writeDepth",void 0),u([R({constValue:!1})],ue.prototype,"occlusionPass",void 0),u([R({constValue:!1})],ue.prototype,"hasVvInstancing",void 0),u([R({constValue:!1})],ue.prototype,"vvSize",void 0),u([R({constValue:!1})],ue.prototype,"vvOpacity",void 0);var Bh=new Map([[g.POSITION,0],[g.COLOR,3],[g.UVMAPSPACE,4],[g.COLORFEATUREATTRIBUTE,5],[g.BOUNDINGRECT,6]]),Nh=new Map([[g.POSITION,0],[g.COLOR,3],[g.UVMAPSPACE,4],[g.COLORFEATUREATTRIBUTE,5],[g.BOUNDINGRECT,6],[g.OBJECTANDLAYERIDCOLOR,9]]);var ss=class extends pn{constructor(e){super(e,new Hh),this.supportsEdges=!0,this.produces=new Map([[H.OPAQUE_MATERIAL,t=>Gi(t)],[H.TRANSPARENT_MATERIAL,t=>Dr(t)],[H.TRANSPARENT_NO_SSAO_DEPTH,t=>$o(t)&&this.parameters.writeLinearDepth],[H.DRAPED_MATERIAL,t=>this.parameters.draped&&t===L.Color||Gi(t)]]),this._vertexAttributeLocations=Ve("enable-feature:objectAndLayerId-rendering")?Nh:Bh,this._configuration=new ue}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<en,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}createGLMaterial(e){return new zh(e)}createBufferWriter(){let e=Lt().vec3f(g.POSITION).vec4f(g.UVMAPSPACE);return this.parameters.draped||e.mat3f(g.BOUNDINGRECT),this.parameters.vvColor?e.f32(g.COLORFEATUREATTRIBUTE):e.vec4u8(g.COLOR),Ve("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(g.OBJECTANDLAYERIDCOLOR),new jh(e)}},zh=class extends ir{_updateParameters(e){return this.ensureTechnique(ro,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output===L.Color&&this._updateOccludeeState(e),this._updateParameters(e)}},jh=class extends oi{write(e,t,i,s,a){ju(i,this.vertexBufferLayout,e,t,s,a);for(let o of this.vertexBufferLayout.fields.keys()){let n=i.attributes.get(o),l=n?.indices;if(n&&l)switch(o){case g.UVMAPSPACE:{Ee(n.size===4);let c=s.getField(o,gs);c&&rn(n,c,a);break}case g.BOUNDINGRECT:{Ee(n.size===9);let c=s.getField(o,Jr);c&&ub(n,e,c,a);break}}}}};function ub(r,e,t,i){let{data:s,indices:a}=r,o=e,n=t.typedBuffer,l=t.typedBufferStride,c=a.length;i*=l;for(let h=0;h<c;++h){let p=9*a[h],d=s[p],f=s[p+1],m=s[p+2];n[i]=o[0]*d+o[4]*f+o[8]*m+o[12],n[i+1]=o[1]*d+o[5]*f+o[9]*m+o[13],n[i+2]=o[2]*d+o[6]*f+o[10]*m+o[14];for(let y=3;y<9;++y)n[i+y]=s[p+y];i+=l}}var Hh=class extends nn{constructor(){super(...arguments),this.color=ye(1,1,1,1),this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Re.None,this.hasOccludees=!1,this.style=qt.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}};function Ug(r,e){let t=r?.pattern??null;return t==null?new Gc(e):t.style==="none"||t.style==="solid"?(t.style==="none"&&(e.color=ye(0,0,0,0),e.forceTransparentMode=!0),new Gc(e)):(e.style=mb(t.style),new ss(e))}function mb(r){switch(r){case"horizontal":return qt.Horizontal;case"vertical":return qt.Vertical;case"cross":return qt.Cross;case"forward-diagonal":return qt.ForwardDiagonal;case"backward-diagonal":return qt.BackwardDiagonal;case"diagonal-cross":return qt.DiagonalCross;default:return}}function fb(r){return r.material instanceof ss&&!r.material.parameters.draped}function gb(r,e){if(fb(r)){let t=r.attributes.get(g.POSITION).data,i=r.getMutableAttribute(g.UVMAPSPACE).data,s=r.getMutableAttribute(g.BOUNDINGRECT).data;vl(i,s,t,e)}}function Fg(r,e,t,i,s){let a=Cn(r,e,t,i,s),o=r.stageObject.geometries;for(let n of o)gb(n,s);return a}var yb=["polyline","polygon","extent"],Bg=new ar({size:!1,color:!0,rotation:!1,opacity:!1}),io=class r extends Se{constructor(e,t,i,s){super(e,t,i,s),this._needsUV=!1}doLoad(){return O(this,null,function*(){this._fastUpdates=kt(this._context.renderer,Bg)})}_createMaterials(){if(this._materials.length>0)return;let e=this.symbolLayer?.material?.color,t=this._getCombinedOpacityAndColor(e);this._materials[oe.Fill]=Ug(this.symbolLayer,Z({color:t,forceTransparentMode:this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled},this._fastUpdates?.materialParameters)),this._needsUV=this._materials[oe.Fill]instanceof ss;let i=this.symbolLayer.outline;if(_b(i)){let s=dn(i.pattern);this._materials[oe.Outline]=new Bi({width:be(i.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:s,cap:Va(i.patternCap||"butt")})}this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,yb,this.symbolLayer.type))return null;let i=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(t);return this.ensureDrapedStatus(s.mode==="on-the-ground"),this._createMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,s)}applyRendererDiff(e,t){for(let i in e.diff){if(i!=="visualVariables")return N.RecreateSymbol;if(!Wt(this._fastUpdates,t,Bg))return N.RecreateSymbol;this._materials[oe.Fill]?.setParameters(this._fastUpdates.materialParameters)}return N.FastUpdate}layerOpacityChanged(){if(this._materials[oe.Fill]!=null){let e=this._materials[oe.Fill].parameters.color,t=this.symbolLayer?.material?.color,i=this._getCombinedOpacity(t);this._materials[oe.Fill].setParameters({color:[e[0],e[1],e[2],i],forceTransparentMode:this.needsDrivenTransparentPass})}if(this._materials[oe.Outline]!=null){let e=this._materials[oe.Outline].parameters.color;this._materials[oe.Outline].setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(e,t,i){let s=this._elevationContext.mode,a=nr(r.elevationModeChangeTypes,i,s);if(a!==q.UPDATE)return a;let o=Be(s);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>o)}slicePlaneEnabledChanged(){if(this._materials[oe.Fill]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[oe.Outline]){let e={hasSlicePlane:this._context.slicePlaneEnabled};this._materials[oe.Outline].setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,i){let s=gi(e.geometry);if(!s)return null;let a=Vs(s,this._context.elevationProvider,this._context.renderCoordsHelper,i),o=new kh(a,t,this._context.layer.uid,e.uid),n=o.renderData.position.length/3;if(this._needsUV&&(o.uvMapSpace=Ke(4*n,!0),o.boundingRect=Fe(9*n,!0),vl(o.uvMapSpace,o.boundingRect,o.renderData.position,this._context.renderCoordsHelper)),o.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(o),this._createAs3DShapeFill(e,o),this._materials[oe.Outline]&&this._createAs3DShapeOutline(o),this._logGeometryCreationWarnings(o.renderData,s.rings,"rings","FillSymbol3DLayer"),o.outGeometries.length===0)return null;let l=new dt({geometries:o.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:e.uid}),c=new xe(this,l,o.outGeometries,null,null,Fg,i);return c.alignedSampledElevation=o.renderData.sampledElevation,c.needsElevationUpdates=Be(i.mode),c}_createAs3DShapeFill(e,t){let i=t.renderData.polygons;for(let{position:s,mapPositions:a,holeIndices:o,index:n,count:l}of i){if(this._context.clippingExtent!=null&&(F(Qt),Ge(Qt,a),!ze(Qt,this._context.clippingExtent)))continue;let c=vf(a,o,this._context.elevationProvider.spatialReference);if(c.length===0)continue;let h=this._fastUpdates?.visualVariables.color,p=Jc({material:this._materials[oe.Fill],indices:c,mapPositions:a,attributeData:{position:s,color:h?null:t.color,colorFeature:h?tt(h.field,e):null,uvMapSpace:this._needsUV?bs(t.uvMapSpace,4*n,4*l):null,boundingRect:this._needsUV?It(t.boundingRect,9*n,9*l):null,objectAndLayerIdColor:t.objectAndLayerIdColor}});t.outGeometries.push(p)}}_createAs3DShapeOutline(e){if(this._materials[oe.Outline]==null)return;let t=e.renderData.outlines;for(let{mapPositions:i,position:s}of t){if(this._context.clippingExtent!=null&&(F(Qt),Ge(Qt,i),!ze(Qt,this._context.clippingExtent)))continue;let a=Ea(this._materials[oe.Outline],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:i,attributeData:{position:s}},e.objectAndLayerIdColor);e.outGeometries.push(a)}}_createAsOverlay(e,t){let i=gi(e.geometry);if(i==null)return null;this._materials[oe.Fill].renderPriority=this._renderPriority+this._renderPriorityStep/2,this._materials[oe.Outline]!=null&&(this._materials[oe.Outline].renderPriority=this._renderPriority);let s=An(i,this._context.overlaySR),a=new Wh(s,t,this._context.layer.uid,e.uid),o=a.renderData.position.length/3;return this._needsUV&&(a.uvMapSpace=Ke(4*o,!0),Vg(a.uvMapSpace,a.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),a.outBoundingBox=F(),a.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a),this._createAsOverlayFill(e,a),this._materials[oe.Outline]&&this._createAsOverlayOutline(a),this._logGeometryCreationWarnings(a.renderData,i.rings,"rings","FillSymbol3DLayer"),a.outGeometries.length===0?null:new pr(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e,t){let i=t.renderData.polygons;for(let{position:s,holeIndices:a,index:o,count:n}of i){let l=F(Qt);if(Ge(l,s),!ze(l,this._context.clippingExtent))continue;let c=Ir(s,a,3);if(c.length===0)continue;Ar(t.outBoundingBox,l);let h=this._fastUpdates?.visualVariables.color,p=Jc({material:this._materials[oe.Fill],indices:c,attributeData:{position:s,color:h?null:t.color,colorFeature:h?tt(h.field,e):null,uvMapSpace:this._needsUV?bs(t.uvMapSpace,4*o,4*n):null,objectAndLayerIdColor:t.objectAndLayerIdColor}});t.outGeometries.push(new Mr(p,t))}}_createAsOverlayOutline(e){if(this._materials[oe.Outline]==null)return;let t=e.renderData.outlines;for(let i=0;i<t.length;++i){let{position:s}=t[i];if(F(Qt),Ge(Qt,s),!ze(Qt,this._context.clippingExtent))continue;Ar(e.outBoundingBox,Qt);let a=Ea(this._materials[oe.Outline],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:s}},e.objectAndLayerIdColor);e.outGeometries.push(new Mr(a,e))}}_getOutlineOpacity(){let e=this.symbolLayer?.outline?.color;return(this.draped?1:this._getLayerOpacity())*(e!=null?e.a:0)}_getOutlineColor(){let e=this.symbolLayer?.outline?.color,t=this._getOutlineOpacity();return ci(e!=null?re.toUnitRGB(e):null,t)}test(){return Pe(Z({},super.test()),{createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)})}};io.elevationModeChangeTypes={definedChanged:q.RECREATE,staysOnTheGround:q.NONE,onTheGroundChanged:q.RECREATE};var Qt=K(),kh=class extends fi{constructor(e,t,i,s){super(e,i,s),this.color=t}},Wh=class extends fi{constructor(e,t,i,s){super(e,i,s),this.color=t}},oe;function _b(r){return r?.size!=null&&r.size>0&&r.color!=null&&(r.pattern==null||r.pattern.type!=="style"||r.pattern.style!=="none")}(function(r){r[r.Fill=0]="Fill",r[r.Outline=1]="Outline"})(oe||(oe={}));var xl=class{constructor(e,t="center",i=!1,s=W(),a=ye(0,0,0,-1),o="world",n=_(),l=0){this.verticalOffset=e,this.anchor=t,this.hasLabelVerticalOffset=i,this.screenOffset=s,this.centerOffset=a,this.centerOffsetUnits=o,this.translation=n,this.elevationOffset=l}},Sl=class{constructor(e,t="center",i="center",s=null,a=W()){this.placement=e,this.horizontalPlacement=t,this.verticalPlacement=i,this.text=s,this.displaySize=a}};var Cl=class r{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=Ng(e.color),this.haloStyle=bb(e.halo.color),this.backgroundStyle=e.background.color[3]!==0?Ng(e.background.color):null}fontString(e){let t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}static fromSymbol(e,t){return O(this,null,function*(){let i=e?.material?.color,s=re.toUnitRGBA(i)??Zr,a=e.size!=null?be(e.size):12,o=e.lineHeight,n=e.background!=null?re.toUnitRGBA(e.background.color):Zr,l={family:e.font?.family??"sans-serif",decoration:e.font?.decoration??"none",weight:e.font?.weight??"normal",style:e.font?.style??"normal"},c=e.halo,h=c?.color!=null&&c.size>0?{size:be(c.size),color:re.toUnitRGBA(c.color)}:{size:0,color:Zr},p=new r({color:s,size:a,background:{color:n,padding:e.background!=null?[.65*a,.5*a]:[0,0],borderRadius:e.background!=null?a*(6/16):0},lineSpacingFactor:o,font:l,halo:h,pixelRatio:t});if(e.font){let d=!1,f=p.fontString(a);try{d=(yield document.fonts.load(f)).some(m=>!Zd(m))}catch{Q.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${f}'. Some text symbology may be rendered using the default browser font.`)}if(!d&&!vb.has(e.font.family))try{yield Yd(e.font)}catch{}}return p})}};function bb(r){return`rgb(${r.slice(0,3).map(e=>Math.floor(255*e)).toString()})`}function Ng(r){return`rgba(${r.slice(0,3).map(e=>Math.floor(255*e)).toString()},${r[3]})`}var vb=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]);var bi=4096,Zs=class extends Ae{constructor(r){super(r),this.type=et.Texture,this.id=yp(),this.events=new Xt,this._glTexture=null,this._atlas=new Yh(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._stageObjects=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view._stage,this._stage.add(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=ls(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get glTexture(){return this._glTexture}static get maxSize(){return so=hm.stableRendering?jr:0,[bi-jr-so,bi-jr-so-zg]}load(r){if(this._glTexture)return this._glTexture;let e=new Wd;return e.wrapMode=Lr.CLAMP_TO_EDGE,e.samplingMode=Cd.LINEAR_MIPMAP_LINEAR,e.hasMipmap=!0,e.preMultiplyAlpha=!0,e.maxAnisotropy=r.parameters.maxMaxAnisotropy,this._glTexture=new qd(r,e,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(Xe.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=Ci(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=ls(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(r){this._canvas.setAttribute("width",r.width.toString()),this._canvas.setAttribute("height",r.height.toString())}_resizeAtlas(r,e){let{width:t,height:i}=this._atlas;t===r&&i===e||(this._atlas.width=r,this._atlas.height=e,this._glTexture?.resize(r,e),this._glTexture?.updateData(0,0,0,t,i,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(s=>{this._stageObjects.get(s.textRenderer.key)?.forEach(o=>qh(o,s))}),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(r,e,t,i){let s=this._atlas;if(s.width<t||s.height<i)return!1;let a=s.cursors.get(i);if(!a){if(s.height<s.nextY+i)return!1;a=[new Pl(s.nextY)],s.cursors.set(i,a),s.nextY+=i}let o=a.find(n=>s.width>=n.x+t);if(o==null){if(s.height<s.nextY+i)return!1;o=new Pl(s.nextY),s.nextY+=i,a.push(o)}return r.setNewPosition(o),this._elements.set(e,r),this._elementsToRender.set(e,r),o.x+=t,!0}_ensureStageObjects(r){let e=this._stageObjects.get(r);if(e)return e;let t=new Set;return this._stageObjects.set(r,t),t}_addStageObject(r,e){this._ensureStageObjects(r).add(e)}_removeStageObject(r,e){this._stageObjects.get(r)?.delete(e)&&(e.geometries[0].setAttributeData(g.SIZE,[0,0]),e.geometryVertexAttributeUpdated(e.geometries[0],g.SIZE),this._elementsToRender.delete(r))}_processAddition(r){let e=r.textRenderer.key;if(this._needsRepack)return void this._elements.set(e,r);let t=this._atlas,i=r.textRenderer.renderedWidth,s=r.textRenderer.renderedHeight,a=i+jr,o=s+jr+zg;if(!this._addAtlasElement(r,e,a,o)){if(this._canRepack)this._reset();else if(t.width<a){let n=Math.min(Jo(Math.max(a,1.5*t.width)),bi);this._resizeAtlas(n,t.height)}else{let n=t.nextY+o,l=Math.min(Jo(Math.max(n,1.5*t.height)),bi);if(l>t.height)this._resizeAtlas(t.width,l);else if(t.width<bi){let c=Math.min(Jo(1.5*t.width),bi);this._resizeAtlas(c,t.height)}}this._elements.set(e,r)}}_renderElement(r){let e=r.commitNewPosition(),t=r.textRenderer;this._ctx.clearRect(e[0]-jr,e[1]-jr,t.renderedWidth+2*jr,t.renderedHeight+2*jr),t.render(this._ctx,e[0],e[1]),this._stageObjects.get(t.key)?.forEach(s=>qh(s,r))}get running(){return this.updating}runTask(r){if(this._glTexture==null)return Qr;for(;this._needsRepack&&(this._canRepack||this._atlas.height<bi&&this._atlas.height<bi);){this._canRepack=this._needsRepack=!1;let e=this._elements;this._elements=new Map,e.forEach(t=>this._processAddition(t)),r.madeProgress()}if(this._elementsToRender.size>0){for(let[e,t]of this._elementsToRender){if(r.done)break;this._renderElement(t),this._elementsToRender.delete(e),r.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addTextTexture(r,e){let t=r.key;this._addStageObject(t,e);let i=this._elements.get(t);i==null&&(i=new $h(this._atlas,r),this._processAddition(i),this.setDirty()),xb(e,i),qh(e,i)}removeTextTexture(r,e){let t=r.key;if(!this._elements.get(t))return;this._removeStageObject(t,e);let i=this._stageObjects.get(t);i&&i.size!==0||this._elements.delete(t),i?.size===0&&this._stageObjects.delete(t),this._canRepack=!0}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}};function xb(r,e){r.geometries[0].setAttributeData(g.SIZE,[e.textRenderer.displayWidth,e.textRenderer.displayHeight]),r.geometryVertexAttributeUpdated(r.geometries[0],g.SIZE)}function qh(r,e){r.geometries[0].setAttributeData(g.UV0,e.uv),r.geometryVertexAttributeUpdated(r.geometries[0],g.UV0,!0)}u([v({constructOnly:!0})],Zs.prototype,"view",void 0),u([v({type:Boolean})],Zs.prototype,"updating",void 0),Zs=u([ie("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],Zs);var jr=2,zg=2,$h=class{constructor(e,t){this._atlas=e,this.textRenderer=t,this._uv=Yr(),this._newPosition=[0,0]}get uv(){if(this._xOffset==null||this._yOffset==null)return Zr;let{renderedWidth:e,renderedHeight:t}=this.textRenderer;return id(this._uv,this._xOffset/this._atlas.width,(this._yOffset+t)/this._atlas.height,(this._xOffset+e)/this._atlas.width,this._yOffset/this._atlas.height)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}},Yh=class{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=so}},Pl=class{constructor(e){this.y=e,this.x=so}},so=0;var El=class{constructor(e,t,i){this._renderer=new Mn(e,t,i,Zs.maxSize)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){let e=ki(Sb,this._renderer.renderedWidth,this._renderer.renderedHeight),t=e.getContext("2d");return t.save(),this._renderer.render(t,0,0),t.restore(),new Mi(e,{wrap:{s:Lr.CLAMP_TO_EDGE,t:Lr.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0})}},Sb={canvas:null};var Cb=Je(0,0,1),Rl=class extends Se{constructor(e,t,i,s){super(e,t,i,s),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}doLoad(){return O(this,null,function*(){if(!this._drivenProperties.size){let e=hi(this.symbolLayer.size);if(e)throw new _e("graphics3dtextsymbollayer:invalid-size",e)}yield this._createTextRenderParameters()})}_createTextRenderParameters(){return O(this,null,function*(){let e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=yield Cl.fromSymbol(this.symbolLayer,e)})}destroy(){super.destroy()}createGraphics3DGraphic(e){let t=e.graphic,i=cr(t.geometry);if(i==null)return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;let s=this.symbolLayer.text;if(s==null||s==="")return null;let a=ko(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(a!=null&&!Wo(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;let{verticalAlignment:o}=this.symbolLayer,n=new xl(a);zf(o,n.screenOffset);let l=new Sl(n,this.symbolLayer.horizontalAlignment,Nf(o));return this._createAs3DShape(t,i,s,l)}createLabel(e,t,i,s,a){let o=e.graphic,n=cr(o.geometry);if(n==null)return this.logger.warn(`unsupported geometry type for label: ${o.geometry.type}`),null;let l=t.text;return!l||/^\s+$/.test(l)?null:this._createAs3DShape(o,n,l,t,i,s,a)}setGraphicElevationContext(e,t,i=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(i),t}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return jg(e,t,(i,s)=>{this.updateGraphicElevationContext(s,i)}),q.UPDATE}slicePlaneEnabledChanged(e,t){return jg(e,t,i=>{for(let s of i.stageObject.geometries)s.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}updateGraphicElevationContext(e,t){let i=t.elevationContext;this.setGraphicElevationContext(e,i,t.metadata!=null?t.metadata.elevationOffset:0),t.needsElevationUpdates=Be(i.mode)||i.mode==="absolute-height"}updateGeometry(e,t){if(this.draped||!this._validateGeometry(t))return!1;let{elevationContext:i,stageObject:s}=e;if(i.mode!==this.getGeometryElevationMode(t))return!1;let a=cr(t);if(!a)return!1;let o=En(s,this._context,a,i);if(o==null)return!1;let n=Ta(this._context,a);return s.geometries[0].localOrigin===n&&(e.alignedSampledElevation=o,Yt(e,a,this._context.elevationProvider),!0)}_defaultElevationInfoNoZ(){return Eb}_createAs3DShape(e,t,i,s,a=null,o=null,n=()=>s.placement.elevationOffset){let l=this.setGraphicElevationContext(e,new Vr,s.placement.elevationOffset),c=e.geometry?.type==="polyline",h=e.uid,p=null,d=null;if(o==null){let U=Ff(s.horizontalPlacement);p=new El(i,U,this._textRenderParameters);let he=null;if(this._context.sharedResources.textures!=null){d=this._context.sharedResources.textures.fromData(p.key,()=>p.create()),d.texture.events.on("unloaded",()=>he=ea(he));let pe=this._context.stage.renderView.textures.acquire(d.texture.id);if(pe==null||mp(pe))return d.release(),null;he=pe}}let f=Pb(p,s),m={occlusionTest:!Ve("enable-feature:non-occluded-hud"),screenOffset:s.placement.screenOffset,anchorPosition:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.placement.centerOffsetUnits,drawInSecondSlot:!0};if(c&&(m.shaderPolygonOffset=1e-4),o?m.textureId=o.id:d&&(m.textureId=d.texture.id),s.placement.verticalOffset!=null){let{screenLength:U,minWorldLength:he,maxWorldLength:pe}=s.placement.verticalOffset;m.verticalOffset={screenLength:be(U),minWorldLength:he||0,maxWorldLength:pe??1/0}}let y={screenOffset:m.screenOffset,anchorPosition:f,centerOffsetUnits:m.centerOffsetUnits,verticalOffset:m.verticalOffset,shaderPolygonOffset:m.shaderPolygonOffset};if(this._context.screenSizePerspectiveEnabled){let{screenSizePerspectiveSettings:U,screenSizePerspectiveSettingsLabels:he}=this._context.sharedResources,pe=Dn(this._textRenderParameters);m.screenSizePerspective=he.overrideFontHeight(pe.maxHeight),m.screenSizePerspectiveAlignment=U,y.fontHeight=pe.maxHeight}m.hasSlicePlane=this._context.slicePlaneEnabled;let b=(U,he,pe)=>{let wt=U.get(pe);return wt==null&&(wt=new Os(he),U.add(pe,wt)),wt},S=a?b(a,m,JSON.stringify(y)):new Os(m),x=s.placement.translation,w=p?B(p.displayWidth,p.displayHeight):Io,E=s.placement.centerOffset,C=Cb,P=W(),T=Sa(S,C,x,null,w,E,P,null),D=Ms(this._context,t,T,l,h);if(D==null)return null;let I=(U,he,pe,wt,Si,Wr)=>{let lo=n()||s.placement.elevationOffset,co=this.setGraphicElevationContext(e,he,lo);return Ft(U,co,pe,wt,Si,Wr)},G=new xe(this,D.object,[T],a==null?[S]:null,d,I,l);G.alignedSampledElevation=D.sampledElevation,G.needsElevationUpdates=Be(l.mode)||l.mode==="absolute-height",G.getScreenSize=(U=W())=>(U[0]=p?p.displayWidth:s.displaySize[0],U[1]=p?p.displayHeight:s.displaySize[1],U);let ne=new Gs(s.placement.elevationOffset,i);return G.metadata=ne,Yt(G,t,this._context.elevationProvider),G}};function jg(r,e,t){r&&r.forEach(i=>{let s=e(i);s!=null&&t(s,i.graphic)})}function Pb(r,e){if(e.verticalPlacement==="baseline"){let i=Uf[e.horizontalPlacement],s=r!=null?r.baselineAnchorY:0;return B(i,s)}let t=Bf(e.horizontalPlacement,e.verticalPlacement);return Bs[t]}var Eb={mode:"relative-to-ground",offset:0};var ao=class r extends Gt{initializeConfiguration(e,t){t.spherical=e.viewingMode===Me.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Mt(e.rctx,r.shader.get().build(this.configuration),Ht)}_setPipelineState(e){let t=this.configuration,i=e===He.NONE,s=e===He.FrontFace;return Ze({blending:t.output!==L.Normal&&t.output!==L.Highlight&&t.output!==L.ObjectAndLayerIdColor&&t.transparent?i?sr:ii(e):null,depthTest:t.draped?null:{func:si(e)},depthWrite:t.draped?null:i?t.writeDepth?xt:null:Cs(e),drawBuffers:ai(e),colorWrite:pt,polygonOffset:i||s?null:tn(t.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};ao.shader=new Dt($m,()=>import("./chunk-LZ2M3LEA.js"));var me=class extends or{constructor(){super(...arguments),this.output=L.Color,this.transparencyPassType=He.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.objectAndLayerIdColorInstanced=!1,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}};u([R({count:L.COUNT})],me.prototype,"output",void 0),u([R({count:He.COUNT})],me.prototype,"transparencyPassType",void 0),u([R()],me.prototype,"spherical",void 0),u([R()],me.prototype,"receiveShadows",void 0),u([R()],me.prototype,"hasSlicePlane",void 0),u([R()],me.prototype,"transparent",void 0),u([R()],me.prototype,"enableOffset",void 0),u([R()],me.prototype,"writeDepth",void 0),u([R()],me.prototype,"hasScreenSpaceReflections",void 0),u([R()],me.prototype,"doublePrecisionRequiresObfuscation",void 0),u([R()],me.prototype,"hasCloudsReflections",void 0),u([R()],me.prototype,"objectAndLayerIdColorInstanced",void 0),u([R()],me.prototype,"draped",void 0),u([R()],me.prototype,"multipassEnabled",void 0),u([R()],me.prototype,"cullAboveGround",void 0),u([R({constValue:!1})],me.prototype,"occlusionPass",void 0),u([R({constValue:Xo.Water})],me.prototype,"pbrMode",void 0),u([R({constValue:!0})],me.prototype,"useCustomDTRExponentForWater",void 0),u([R({constValue:!0})],me.prototype,"highStepCount",void 0),u([R({constValue:!1})],me.prototype,"useFillLights",void 0);var Ol=class extends ir{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){let t=e.ssr.lastFrameColor!=null;t!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:t})}_updateCloudsReflectionState(e){let t=e.cloudsFade.data!=null;t!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:t})}ensureResources(e){return this._techniques.constructionContext.waterTextures.ensureResources(e)}beginSlot(e){return this._output===L.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniques.constructionContext.waterTextures.passParameters),this.ensureTechnique(ao,e)}};var wl=class extends pn{constructor(e){super(e,new oo),this._configuration=new me,this._animation=new Iu,this.produces=new Map([[H.OPAQUE_MATERIAL,t=>Dr(t)&&!this.parameters.transparent||Gi(t)],[H.TRANSPARENT_MATERIAL,t=>Dr(t)&&this.parameters.transparent||Gi(t)],[H.DRAPED_MATERIAL,t=>this.parameters.draped&&t===L.Color||Gi(t)],[H.DRAPED_WATER,t=>t===L.Normal]])}getConfiguration(e,t){return this._configuration.output=e,this._configuration.writeDepth=!0,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<en,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}update(e){let t=Math.min(e.camera.relativeElevation,e.camera.distance);this._animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<Rb;let i=this._animation.advance(e);return this.setParameters({timeElapsed:fp(this._animation.time)*this.parameters.animationSpeed},!1),this._animation.enabled&&i}createGLMaterial(e){return new Ol(e)}createBufferWriter(){return new oi(Ve("enable-feature:objectAndLayerId-rendering")?Bm:Um)}get test(){}},oo=class extends Ss{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=B(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=ye(0,0,0,0),this.transparent=!0,this.hasSlicePlane=!1,this.draped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.origin=_(),this.modelTransformation=null}},Rb=35e3;var Hg={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}};var Ob=["polyline","polygon","extent"],yr=class r extends Se{constructor(e,t,i,s){super(e,t,i,s)}doLoad(){return O(this,null,function*(){})}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Ob,this.symbolLayer.type))return null;let i=this.setGraphicElevationContext(t);return this.ensureDrapedStatus(i.mode==="on-the-ground"),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,i,t.uid)}ensureMaterial(){if(this._materials[0])return;let e=new oo,t=this.symbolLayer.color;t!=null&&(e.color=re.toUnitRGBA(t));let i=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=this.symbolLayer.waveDirection!=null?r.headingVectorFromAngle(this.symbolLayer.waveDirection):B(0,0);let s=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,a=Hg[s];e.waveStrength=a.waveStrength,e.waveTextureRepeat=a.textureRepeat,e.waveVelocity=a.waveVelocity,e.flowStrength=a.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.draped=this.draped,this._materials[0]=new wl(e),this._context.stage.add(this._materials[0])}layerOpacityChanged(){if(this._materials[0]==null)return;let e=this._materials[0].parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=t<1||this.needsDrivenTransparentPass;this._materials[0].setParameters({color:[e[0],e[1],e[2],t],transparent:i})}layerElevationInfoChanged(e,t,i){let s=this._elevationContext.mode,a=nr(r.elevationModeChangeTypes,i,s);if(a!==q.UPDATE)return a;let o=Be(s);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>o)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,i){let s=gi(e.geometry);if(s==null)return null;let a=Vs(s,this._context.elevationProvider,this._context.renderCoordsHelper,t),o=a.position.length/3,n=Fe(2*o);kg(n,a.mapPositions,o,this._context.elevationProvider.spatialReference);let l=new Zh(a,n,this._context.layer.uid,e.uid);if(l.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(l),this._create3DShapeGeometries(l),this._logGeometryCreationWarnings(l.renderData,s.rings,"rings","WaterSymbol3DLayer"),l.outGeometries.length===0)return null;let c=new dt({geometries:l.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:i}),h=new xe(this,c,l.outGeometries,null,null,Cn,t);return h.alignedSampledElevation=l.renderData.sampledElevation,h.needsElevationUpdates=Be(t.mode),h}_create3DShapeGeometries(e){let t=e.renderData.polygons,i=e.uvCoords;for(let{count:s,index:a,position:o,mapPositions:n,holeIndices:l}of t){if(this._context.clippingExtent!=null&&(F(as),Ge(as,n),!ze(as,this._context.clippingExtent)))continue;let c=Ir(n,l,3);if(c.length===0)continue;let h=It(i,2*a,2*s),p=Xc({material:this._materials[0],indices:c,mapPositions:n,attributeData:{position:o,uv0:h}},e.objectAndLayerIdColor);e.outGeometries.push(p)}}_createAsOverlay(e){let t=gi(e.geometry);if(t==null)return null;this._materials[0].renderPriority=this._renderPriority;let i=An(t,this._context.overlaySR),s=i.position.length/3,a=Fe(2*s);kg(a,i.position,s,this._context.overlaySR);let o=new Qh(i,a,this._context.layer.uid,e.uid);return o.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(o),o.outBoundingBox=F(),this._createAsOverlayWater(o),this._logGeometryCreationWarnings(o.renderData,t.rings,"rings","WaterSymbol3DLayer"),o.outGeometries.length===0?null:new pr(this,o.outGeometries,o.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){let t=e.uvCoords,i=e.renderData.polygons;for(let{position:s,holeIndices:a,index:o,count:n}of i){if(F(as),Ge(as,s),!ze(as,this._context.clippingExtent))continue;Ar(e.outBoundingBox,as);let l=Ir(s,a,3);if(l.length===0)continue;let c=It(t,2*o,2*n),h=Xc({material:this._materials[0],indices:l,attributeData:{position:s,uv0:c}},e.objectAndLayerIdColor);e.outGeometries.push(new Mr(h,e))}}static headingVectorFromAngle(e){let t=W(),i=Dp(e);return t[0]=Math.sin(i),t[1]=Math.cos(i),t}test(){return Pe(Z({},super.test()),{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()})}};function kg(r,e,t,i){let s=Ep(i);So(vi);for(let n=0;n<t;n++)ve(Wg,e[3*n],e[3*n+1]),Fp(vi,Wg);sd(vi,vi,s);let a=vi[0]%yr.unitSizeOfTexture,o=vi[1]%yr.unitSizeOfTexture;Al[0]=vi[0]-a,Al[1]=vi[1]-o;for(let n=0;n<t;n++)r[2*n]=(e[3*n]*s-Al[0])/yr.unitSizeOfTexture,r[2*n+1]=(e[3*n+1]*s-Al[1])/yr.unitSizeOfTexture}yr.unitSizeOfTexture=100,yr.elevationModeChangeTypes={definedChanged:q.RECREATE,staysOnTheGround:q.NONE,onTheGroundChanged:q.RECREATE};var Al=W(),vi=Ne(),Wg=W(),as=K(),Zh=class extends fi{constructor(e,t,i,s){super(e,i,s),this.uvCoords=t}},Qh=class extends fi{constructor(e,t,i,s){super(e,i,s),this.uvCoords=t}};function qg(r,e,t,i){let s=Ab[r.type]?.[e.type]||wb[e.type];return s?new s(r,e,t,i):(Q.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make",`unknown symbol type ${e.type}`),null)}var wb={icon:Ns,object:il,line:Ba,path:yl,fill:io,extrude:In,text:Rl,water:yr};var Ab={"mesh-3d":{fill:kn}};var Qs=class extends di{set symbol(e){this._symbol=e,e.symbolLayers.forEach((t,i)=>{let s=this.symbolLayers[i];s!=null&&(s.symbol=e,s.symbolLayer=t)})}get symbol(){return this._symbol}constructor(e,t,i){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}doLoad(e){return O(this,null,function*(){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));let i=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;let s=[];for(let a=0;a<i;a++){let o=t.at(a);if(o.enabled===!1)continue;Tl.renderPriority=1-(1+a)/i,Tl.renderPriorityStep=1/i,Tl.ignoreDrivers=o.ignoreDrivers;let n=qg(this.symbol,o,this._context,Tl),l=up(e,()=>{this.symbolLayers[a]=null,n.destroy()});l&&s.push(l),this.symbolLayers[a]=n}if(yield mo(this.symbolLayers,(a,o)=>O(this,null,function*(){if(a!=null)try{yield a.load(),this._extentPadding+=Math.max(this._extentPadding,a.extentPadding)}catch{this.symbolLayers[o]=null}})),s.forEach(a=>a.remove()),ee(e),this.symbolLayers.length&&!this.symbolLayers.some(a=>!!a))throw new Error})}getSymbolLayerSize(e){let t=this.symbolLayers[e];return t!=null?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>e?.queryForSnapping)}createGraphics3DGraphic(e,t){let i=e.graphic,s=this.symbolLayers.map(o=>o?.createGraphics3DGraphic(e)??null),a=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new On(i,t||this,s,e.layer,a)}get complexity(){return _n(this.symbolLayers.map(e=>e!=null?e.complexity:null))}globalPropertyChanged(e,t){let i=this.symbolLayers.length;for(let s=0;s<i;s++){let a=this.symbolLayers[s],o=n=>{let l=n.layers[s];return l instanceof xe?l:null};if(a!=null&&!a.globalPropertyChanged(e,t,o))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==We.LOADED?N.RecreateSymbol:this.symbolLayers.reduce((i,s)=>i!==N.RecreateSymbol&&s!=null?Math.min(i,s.applyRendererDiff(e,t)):i,N.FastUpdate)}prepareSymbolPatch(e){if(this.loadStatus===We.FAILED||e.diff.type!=="partial")return;let t=e.diff.diff;if(!t.symbolLayers||t.symbolLayers.type!=="partial")return;let i=t.symbolLayers.diff;this.symbolLayers.forEach((s,a)=>{if(s==null)return;let o=i[a];if(o){let n={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(n),e.symbolStatePatches.push(...n.symbolLayerStatePatches),n.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((l,c)=>{let h=l.layers[a];h!=null&&n.graphics3DGraphicPatches.forEach(p=>p(h,c))})}})}updateGeometry(e,t){return this._updateGeometryOrTransform(e,(i,s)=>i.updateGeometry(s,t))}updateTransform(e,t,i,s){return this._updateGeometryOrTransform(e,(a,o)=>a.updateTransform(o,t,i,s))}_updateGeometryOrTransform(e,t){for(let i=0;i<this.symbolLayers.length;i++){let s=this.symbolLayers[i];if(s==null)continue;let a=e.layers[i];if(!a||!t(s,a))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){let i=this.symbolLayers[t];if(i==null)continue;let s=e.layers[t];s!=null&&i.onRemoveGraphic(s)}}getFastUpdateStatus(){let e=0,t=0,i=0;return this.symbolLayers.forEach(s=>{s!=null&&(s.loadStatus===We.LOADING?e++:s.isFastUpdatesEnabled()?i++:t++)}),{loading:e,slow:t,fast:i}}queryForSnapping(e,t,i,s){return O(this,null,function*(){let a=this.symbolLayers.filter(Pr).filter(n=>n.queryForSnapping!=null).map(n=>n.queryForSnapping(e,t,i,s)),o=yield Promise.all(a);return ee(s),o.flat()})}destroy(){if(!this.destroyed){super.destroy();for(let e of this.symbolLayers)e?.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}},Tl=new Sn;var Ll=class r extends Qs{constructor(e,t,i){super(e,t,i),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=_f(this.symbol,t))}doLoad(e){return O(this,null,function*(){let t=this._calloutSymbolLayer?ra(this._calloutSymbolLayer.load()):null;try{yield ap(r.prototype,this,"doLoad").call(this,e),ee(e)}catch(i){throw this._calloutSymbolLayer?.abortLoad(),i}t&&(yield t)})}destroy(){super.destroy(),this._calloutSymbolLayer=ge(this._calloutSymbolLayer)}createGraphics3DGraphic(e,t){let i=super.createGraphics3DGraphic(e,t);if(this._calloutSymbolLayer!=null&&i!=null){let s=this._createCalloutGraphic(e);s&&i.setCalloutGraphic(s)}return i}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,i=>i.calloutLayer))}updateGeometry(e,t){let i=super.updateGeometry(e,t);if(i&&this._calloutSymbolLayer){let s=e.calloutLayer;if(s)return this._calloutSymbolLayer.updateGeometry(s,t)}return i}_createCalloutGraphic(e){let t=e.renderingInfo;return e.renderingInfo=new Rn(t.renderer,t.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(e)}};function $g(r,e,t){return r.type==="point-3d"?new Ll(r,e,t):new Qs(r,e,t)}var Il=class extends di{constructor(e,t,i){super(t),this.symbol=e,this._convert=i,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return this.graphics3DSymbol!=null?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.extentPadding:0}doLoad(e){return O(this,null,function*(){let t=yield this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),this.graphics3DSymbol!=null&&(yield this.graphics3DSymbol.load())})}createGraphics3DGraphic(e){return this.graphics3DSymbol!=null?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.complexity:Hc}globalPropertyChanged(e,t){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return this.graphics3DSymbol!=null?this.graphics3DSymbol.applyRendererDiff(e,t):N.RecreateSymbol}prepareSymbolPatch(e){this.graphics3DSymbol!=null&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.updateGeometry(e,t)}updateTransform(e,t,i,s){return this.graphics3DSymbol?.updateTransform(e,t,i,s)??!1}onRemoveGraphic(){}getFastUpdateStatus(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){this.graphics3DSymbol!=null&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}};var Dl=class{constructor(e,t,i){this.visible=e,this.missing=t,this.pending=i}};var Gl=class{constructor(e){this._graphicsCore=e,this._idToState=new Map,this._states=new Set;let t=e.owner.layer?.objectIdField;t?(this._getGraphicId=i=>rr(i,t),this._getGraphics3DGraphicById=i=>this._graphicsCore.getGraphics3DGraphicByObjectId(i)):(this._getGraphicId=i=>i.uid,this._getGraphics3DGraphicById=i=>this._graphicsCore.getGraphics3DGraphicById(i))}destroy(){this._idToState.clear(),this._states.forEach((e,t)=>this.remove(t))}add(e){let t=At(()=>this.remove(e));if(this._states.has(e))return t;let i=this._getGraphicId(e.graphic),s=this._getGraphics3DGraphicById(i);return this._states.has(e)||this._states.add(e),this._ensureStateList(i).push(e),e.displaying=s!=null&&s.isVisible(),e.isDraped=s!=null&&s.isDraped,e.tracking=!0,s!=null&&e.emit("changed"),t}remove(e){if(this._states.has(e)){if(this._idToState.size){let t=this._getGraphicId(e.graphic),i=this._idToState.get(t);i&&(ql(i,e),i.length===0&&this._idToState.delete(t))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this._forEachState(e,t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed")})}removeGraphic(e){this._forEachState(e,t=>{t.displaying=!1,t.isDraped=!1})}updateGraphicGeometry(e){this._forEachState(e,t=>t.emit("changed"))}updateGraphicVisibility(e){this._forEachState(e,t=>t.displaying=e.isVisible())}allGraphicsDeleted(){this._states.forEach(e=>e.displaying=!1)}_ensureStateList(e){let t=this._idToState.get(e);if(t)return t;let i=new Array;return this._idToState.set(e,i),i}_forEachState(e,t){if(this._states.size===0||this._idToState.size===0)return;let i=this._getGraphicId(e.graphic),s=this._idToState.get(i);s?.forEach(t)}};var br=class extends Ae{constructor(r){super(r),this._index=new cd(9,Ve("esri-csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(r){this._addMany(r)}destroy(){this._missing.clear(),this._index=ge(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(r,e,t){e!=null&&e.equals(this.spatialReference)&&(_r.minX=r[0],_r.minY=r[1],_r.maxX=r[2],_r.maxY=r[3],this.update(),this._index.search(_r,i=>t(i.graphic.uid)))}add(r){this._missing.add(r),this.updating=!0}remove(r){if(this._missing.delete(r))return void(this.updating=this._missing.size>0);if(!r.extent)return;this._index.remove(r);let e=rr(r.graphic,this._get("objectIdField"));e!=null&&this._boundsByFeature.delete(e)}_addMany(r){if(r.length===0)return;let e=this._get("objectIdField");for(let t of r){t.computeExtent(this.spatialReference);let i=rr(t.graphic,e);i!=null&&this._boundsByFeature.set(i,t.extent)}this._index.load(r)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(r,e){_r.minX=r[0],_r.minY=r[1],_r.maxX=r[2],_r.maxY=r[3],this.update(),this._index.search(_r,t=>{e(t)})}getBounds(r,e){this.update();let t=this._boundsByFeature.get(r);return t?Oo(e,t):null}};u([v({constructOnly:!0})],br.prototype,"spatialReference",void 0),u([v({constructOnly:!0})],br.prototype,"hasZ",void 0),u([v({constructOnly:!0})],br.prototype,"hasM",void 0),u([v({constructOnly:!0})],br.prototype,"objectIdField",void 0),u([v()],br.prototype,"updating",void 0),u([v({readOnly:!0})],br.prototype,"updatingRemaining",null),br=u([ie("esri.views.3d.layers.graphics.SpatialIndex2D")],br);var _r={minX:0,minY:0,maxX:0,maxY:0};function Yg(r){return 2216+4096*r.symbolLayers.length+r.complexity.memory.resourceBytes}var Ml=class{constructor(e="scene"){this.context=e,this.extent=So()}};var Tb=1,Zg=Symbol("layerHandles"),xi=class extends Xt.EventedMixin(Ae){get spatialReference(){return this.view?.spatialReference}constructor(r){super(r),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=_m(this.view.state.viewingMode),this._intersector.options.store=xa.MIN;let r=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=r[2],this._zmax=r[5];let e=this.stageLayer.events;this.addHandles([e.on(["layerObjectAdded","layerObjectRemoved","geometryAdded","geometryRemoved"],({object:t})=>this._objectChanged(t)),e.on("attributesChanged",({attribute:t,object:i})=>Mo(t)&&this._objectChanged(i)),e.on(["transformationChanged","shaderTransformationChanged"],t=>this._objectChanged(t))],Zg)}dispose(){this.removeHandles(Zg)}elevationInfoChanged(){let r=this.layer!=null?this.layer.elevationInfo:null;if(r!=null&&r.mode!=="on-the-ground"){let e=bo(this.layer.spatialReference),t=Fd(r.unit??"meters");this._elevationOffset=(r.offset??0)*t/e}else this._elevationOffset=0}getElevation(r,e,t,i){if(lt[0]=r,lt[1]=e,lt[2]=t,!this._renderCoordsHelper.toRenderCoords(lt,i,lt))return Q.getLogger(this).error("could not project point for elevation alignment"),null;let s=this._elevationOffset,a=this._zmin+s,o=this._zmax+s;this._renderCoordsHelper.setAltitude(Qg,o,lt),this._renderCoordsHelper.setAltitude(Jg,a,lt);let n=l=>!!l.lastValidElevationBB;return this._intersector.reset(Qg,Jg,null),this._intersector.intersect(this._intersectLayers,null,Tb,null,n),this._intersector.results.min.getIntersectionPoint(lt)?this._renderCoordsHelper.getAltitude(lt):null}_objectChanged(r){let e=this.spatialReference;if(!r.lastValidElevationBB||!e)return;F(Hr);let t=r.lastValidElevationBB;t.isEmpty()||this._expandExtent(e,t.min,t.max,Hr);let{min:i,max:s}=r.boundingVolumeWorldSpace;this._expandExtent(e,i,s,Hr),ms(Hr,Jh.extent),this._zmin=Math.min(this._zmin,Hr[2]),this._zmax=Math.max(this._zmax,Hr[5]),Jh.spatialReference=e,this.emit("elevation-change",Jh),te(t.min,i),te(t.max,s)}_computeLayerExtent(r,e){return F(Hr),r!=null&&e.objects.forAll(t=>this._expandExtent(r,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,Hr)),Hr}_expandExtent(r,e,t,i){for(let s=0;s<8;++s)lt[0]=1&s?e[0]:t[0],lt[1]=2&s?e[1]:t[1],lt[2]=4&s?e[2]:t[2],this._renderCoordsHelper.fromRenderCoords(lt,lt,r),Tr(i,lt);return i}};u([v({constructOnly:!0})],xi.prototype,"layer",void 0),u([v({constructOnly:!0})],xi.prototype,"stageLayer",void 0),u([v({constructOnly:!0})],xi.prototype,"view",void 0),u([v()],xi.prototype,"spatialReference",null),xi=u([ie("esri.views.3d.layers.support.StageLayerElevationProvider")],xi);var Hr=F(),Jh=new Ml,lt=_(),Qg=_(),Jg=_();function Xg(r,e,t){if(r==null||t==null)return!1;let i=!0;return gt[0]=r.xmin!=null?r.xmin:0,gt[1]=r.ymin!=null?r.ymin:0,gt[2]=r.zmin!=null?r.zmin:0,i=i&&Ue(gt,r.spatialReference,0,gt,t,0,1),e[0]=gt[0],e[1]=gt[1],gt[0]=r.xmax!=null?r.xmax:0,gt[1]=r.ymax!=null?r.ymax:0,gt[2]=r.zmax!=null?r.zmax:0,i=i&&Ue(gt,r.spatialReference,0,gt,t,0,1),e[2]=gt[0],e[3]=gt[1],r.xmin==null&&(e[0]=-1/0),r.ymin==null&&(e[1]=-1/0),r.xmax==null&&(e[2]=1/0),r.ymax==null&&(e[3]=1/0),i}var gt=_();var Kh,Xh=_(),Lb=K(),M=Kh=class extends Ae{get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new br({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get deconflictor(){return this._deconflictor}get labeler(){return this._labeler}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return this.currentRenderer!=null&&this.currentRenderer.type==="dictionary"?Oe.ASYNC:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this.dataUpdating||this._elevationAlignment?.updating||this._scaleVisibility?.updating||this._filterVisibility?.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this.running)}get dataUpdating(){return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||this._spatialIndex?.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.running||this._loadingSymbols>0)}get running(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating||this._dataUpdateQueue.running||this._updateQueue.running}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){let r=this.owner&&this.owner.view&&this.owner.view.qualitySettings,e=r?.graphics3D.minTotalNumberOfFeatures??0,t=r?.graphics3D.maxTotalNumberOfFeatures??0,i=r?.graphics3D.maxNumberOfDrawCalls??0,s=r?.graphics3D.maxTotalNumberOfVertices??0,a=this.averageSymbolComplexity,o=Math.max(1,a?.verticesPerFeature??1),n=a&&a.drawCallsPerFeature>0&&i>0?i/a.drawCallsPerFeature:t,l=Math.ceil(s/o),c=Math.max(e,Math.min(t,l,n)),h=this._get("displayFeatureLimit");return h&&h.maximumTotalNumberOfVertices===s&&h.averageSymbolComplexity===a&&h.maximumNumberOfFeatures===c?h:new bn(s,c,a)}get averageSymbolComplexity(){let r=af(this._symbolComplexities),e=this._get("averageSymbolComplexity");return r.numComplexities===0||e!=null&&(r.estimated&&(e.verticesPerFeature>=r.verticesPerFeature||e.verticesPerCoordinate>=r.verticesPerCoordinate||e.drawCallsPerFeature>=r.drawCallsPerFeature)||e.verticesPerFeature===r.verticesPerFeature&&e.verticesPerCoordinate===r.verticesPerCoordinate&&e.drawCallsPerFeature===r.drawCallsPerFeature)?e:r}get usedMemory(){let r=this.averageSymbolComplexity!=null&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,e=this._getSymbolComplexitiesUsed().reduce((a,o)=>a+o.memory.resourceBytes,0);if(this._symbolMaterials==null){this._symbolMaterials=[];for(let a of this._symbols.values())if(a!=null){for(let o of a.symbolLayers)if(o)for(let n of o.materials)n&&this._symbolMaterials.push(n)}}let t=this.owner.view._stage.renderer.plugins,i=this.owner.view.basemapTerrain.overlayManager.renderer,s=this._symbolMaterials.reduce((a,o)=>a+((t.getMaterialRenderer(o)||i.getMaterialRenderer(o))?.usedMemory??0),0);return this._usedMemory+r+e+s}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){let r=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*r}if(this.averageSymbolComplexity!=null){let r=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+r}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(r){if(r.type==="web-style")return r.clone();let e=this._symbolConversionCache.get(r.id);if(e!=null)return e;let t=gc(r,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(r),cimFallbackEnabled:!0}),i=t.symbol||null;return i==null&&t.error&&Q.getLogger(this).error(t.error.message),this._symbolConversionCache.set(r.id,i),i}_getSymbolComplexitiesUsedOrRenderer(r){if(r==null)return[];let e=r.getSymbols(),t="backgroundFillSymbol"in r?r.backgroundFillSymbol:null;if(!t&&!e?.length)return[];let i=[],s=this._getSymbolComplexityUsedOrRenderer(t);s!=null&&i.push(s);for(let a of e){let o=this._getSymbolComplexityUsedOrRenderer(a);o!=null&&i.push(o)}return i}_getSymbolComplexityUsedOrRenderer(r){if(r==null)return null;let e=this._symbols.get(r.id);if(e!=null)return e.complexity;let t=this._getConvertedSymbol(r);return t!=null?sf(t):null}_getSymbolComplexitiesUsed(){let r=[];return this._symbols.forEach(e=>{e!=null&&r.push(e.complexity)}),r}get _objectIdField(){return this.layer.objectIdField}constructor(r){super(r),this._propertiesPool=new Xu({computedExtent:cs},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=ac,this._dataUpdateQueue=new sc,this._updateQueue=new sc,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._elevationAlignment=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this._pendingUpdatesPool=new ta({allocator:e=>e||new ep,deallocator:e=>(e.clear(),e)}),this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new ta,this.preferredUpdatePolicy=Oe.SYNC,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=r.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",e=>e.destroy()),this.symbolCreationContext=new xn(r.owner.view.resourceController.scheduler,(e,t)=>this._updateQueue.push(e,t))}initialize(){this._featureStore=new $t({objectIdField:this.owner.layer?.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:t=>this.graphics3DGraphics.forEach(t)});let r=(t,i,s)=>this.spatialIndex.queryGraphicUIDsInExtent(t,i,s),{componentFactories:e}=this;this._elevationAlignment=e.elevationAlignment?.(this,r),this._scaleVisibility=e.scaleVisibility?.(this,r),this._filterVisibility=e.filterVisibility?.({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:t=>this.modifyGraphics3DGraphicVisibilities(i=>i.setVisibilityFlag(we.GRAPHIC,Le.FILTER,t(rr(i.graphic,this._objectIdField)))),setAllFeaturesVisibility:t=>this.modifyGraphics3DGraphicVisibilities(i=>i.setVisibilityFlag(we.GRAPHIC,Le.FILTER,t)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(we.GRAPHIC,Le.FILTER,!0))}),this._deconflictor=e.deconflictor?.(this),this._labeler=e.labeler?.(this,this._scaleVisibility),this._objectStates=e.objectStates?.(this),this._initializeAbortController=new AbortController,this._initializePromise=this._initializeAsync()}_initializeAsync(){return O(this,null,function*(){let r=this._initializeAbortController?.signal,e=this.owner.view;this._viewElevationProvider=new vn(this._viewSpatialReference,e),this._initializeStage(e,this.layer.uid);let t=e.sharedSymbolResources;this.symbolCreationContext.sharedResources=t,this._sharedSymbolResourcesOwnerHandle=t.addGraphicsOwner(this.owner),this.currentRenderer!=null&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=t.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=e.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new gm(e.renderSpatialReference),this.symbolCreationContext.elevationProvider=e.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=s=>this.notifyGraphicGeometryChanged(s),this.symbolCreationContext.notifyGraphicVisibilityChanged=s=>this.notifyGraphicVisibilityChanged(s);let i=Pa(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=yield Ca(i,this._viewSpatialReference,r,Q.getLogger(this)),ee(r),this.symbolCreationContext.screenSizePerspectiveEnabled=e.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,"drapeSourceType"in this.owner){let{owner:s}=this;this.symbolCreationContext.drapeSourceRenderer=e.basemapTerrain.overlayManager.registerGeometryDrapeSource(s),this.addHandles(At(()=>e.basemapTerrain.overlayManager.unregisterDrapeSource(s)))}this.addHandles([De(()=>this.suspendedOrOutsideOfView,()=>this._updateQueue.unshift(()=>this._updateLayerVisibility(),null).catch(uo)),De(()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view?.screenSizePerspectiveEnabled],()=>{let s=e.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;s!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=s,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols())}),De(()=>this.owner.slicePlaneEnabled,s=>this._slicePlaneEnabledChange(!!s)),De(()=>this.owner.view.state?.rasterPixelRatio,()=>this._pixelRatioChange()),De(()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,s=>this._physicalBasedRenderingChange(s)),De(()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,s=>this._skipHighSymbolLoDsChange(s)),fo(()=>e.basemapTerrain?.tilingScheme,s=>{if(s.spatialReference.equals(this.symbolCreationContext.overlaySR)||e.basemapTerrain.spatialReference==null||(this.symbolCreationContext.overlaySR=e.basemapTerrain.spatialReference),this.hasHandles("loaded-graphics"))this.recreateAllGraphics();else{let a=()=>this.owner?.loadedGraphics;this.addHandles([Cp(a,"change",o=>{this._graphicsCollectionChanged(o),this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}},{initial:!0}),De(()=>this.effectiveUpdatePolicy,s=>{this.stageLayer!=null&&(this.stageLayer.updatePolicy=s),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===Oe.ASYNC,s===Oe.SYNC&&this.runTask(Ai)},_o)]),this._frameTaskHandle=e.resourceController.scheduler.registerTask(Xe.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this.addHandles(De(()=>this.layer.featureReduction,()=>this._deconflictor?.featureReductionChange())),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch(()=>{}),this._initializeAbortController=null})}_abortInitialize(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}destroy(){this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._abortRendererChange(),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=ac,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),this._deconflictor=Ci(this._deconflictor),this._labeler=Ci(this._labeler),this._elevationAlignment=ge(this._elevationAlignment),this._scaleVisibility=ge(this._scaleVisibility),this._filterVisibility=ge(this._filterVisibility),this._objectStates=ge(this._objectStates),this.clear(),this._featureStore=ge(this._featureStore),this._updatingPendingLoadedGraphicsChange=Ci(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=ge(this._graphicStateTracking),this.stage&&(this.stageLayer=ge(this.stageLayer),this.stage=null),this._set("owner",null);for(let r in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[r].reject(new _e("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=Ci(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=ge(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=ge(this._spatialIndex)}clear(){this._objectStates?.allGraphicsDeleted(),this._graphicStateTracking!=null&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach(r=>r.destroy()),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(ge),this._symbols.clear(),this._symbolMaterials=null,this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("dataUpdating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed")}_initializeStage(r,e){this.stage=r._stage,this.stageLayer=new om(this.stage,{pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},e);let t=this.stageLayer.events;t.on("transformationChanged",i=>this.notifyGraphicGeometryChanged(i.graphicUid)),t.on("shaderTransformationChanged",i=>this.notifyGraphicGeometryChanged(i.graphicUid)),t.on("visibilityChanged",i=>this.notifyGraphicVisibilityChanged(i.graphicUid)),t.on("geometryAdded",i=>this.notifyGraphicGeometryChanged(i.object.graphicUid)),t.on("geometryRemoved",i=>this.notifyGraphicGeometryChanged(i.object.graphicUid)),t.on("attributesChanged",i=>Mo(i.attribute)&&this.notifyGraphicGeometryChanged(i.object.graphicUid))}notifyGraphicGeometryChanged(r){if(this._graphicStateTracking==null||r==null)return;let e=this.graphics3DGraphics.get(r);e&&this._graphicStateTracking.updateGraphicGeometry(e)}notifyGraphicVisibilityChanged(r){if(this._graphicStateTracking==null||r==null)return;let e=this.graphics3DGraphics.get(r);e&&this._graphicStateTracking.updateGraphicVisibility(e)}_updateLayerVisibility(){let r=this.displayFeatureLimit.maximumNumberOfFeatures,e=this._numberOfGraphics>r*Ib,t=!this.suspendedOrOutsideOfView&&!e;t!==this._visible&&(this._visible=t,t?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}_updateStageLayerVisibility(){this.stageLayer.visible=this._visible&&(this.layer.opacity==null||this.layer.opacity>0)}getGraphics3DGraphicById(r){return r!=null?this.graphics3DGraphics.get(r):void 0}getGraphics3DGraphicByObjectId(r){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(r):null}_getGraphicObjectID(r,e=this.owner.layer?.objectIdField){return rr(r,e)}get graphics3DGraphicsByObjectID(){let r=this.owner.layer?.objectIdField;if(!r)return;let e=new Map;return this.graphics3DGraphics.forEach(t=>{if(!t)return;let i=t.graphic,s=this._getGraphicObjectID(i,r);s!=null&&e.set(s,t)}),e}get labelsEnabled(){return!!this._labeler?.layerLabelsEnabled()}updateLabelingInfo(r){return O(this,null,function*(){let e=this._deconflictor?.labelingInfoChange(r),t=this._labeler?.labelingInfoChange(r);yield Promise.allSettled([e,t])})}updateVisibilityInfo(){this._deconflictor?.labelingInfoChange(),this._labeler?.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return"unknown";let r=0,e=0;return _p(this._symbols,(t,i)=>{if(t!=null){let s=t.getFastUpdateStatus();if(s.loading>0)return!0;this._graphicsBySymbol.has(i)&&(e+=s.fast,r+=s.slow)}return!1})?"unknown":e>=0&&r===0?"fast":r>=0&&e===0?"slow":"mixed"}runTask(r){if(this._dataUpdateQueue.runTask(r),this._updateQueue.runTask(r),this._applyPendingUpdates(r),this.notifyChange("running"),this.running||this.notifyChange("dataUpdating"),this.notifyChange("updatingRemaining"),!r.hasProgressed)return Qr}setObjectIdVisibility(r,e){e?this._objectIdInvisibleSet.delete(r):this._objectIdInvisibleSet.add(r);let t=this._findGraphics3DGraphicByObjectId(r);t!=null&&this._updateUserVisibility(t)}_findGraphics3DGraphicByObjectId(r){return bp(this.graphics3DGraphics,e=>this._getGraphicObjectID(e.graphic)===r)}_updateUserVisibility(r){if(r==null)return!1;let e=r.graphic,t=this._getGraphicObjectID(e),i=e.visible&&!this.owner.suspended&&(t==null||!this._objectIdInvisibleSet.has(t));return r.setVisibilityFlag(we.GRAPHIC,Le.USER,i)}_whenGraphics3DGraphic(r){let e=this.graphics3DGraphics.get(r.uid);if(e)return Promise.resolve(e);let t=this._whenGraphics3DGraphicRequests[r.uid];if(t)return t.promise;let i=Yl();return this._whenGraphics3DGraphicRequests[r.uid]=i,i.promise}_boundsForGraphics3DGraphic(r,e){return O(this,null,function*(){let t=this._viewSpatialReference,i=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,a=(h,p,d)=>Ue(h,i,p,h,t,p,d),o=(h,p,d)=>Ue(h,s,p,h,t,p,d),n=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:e!=null&&!!e.useViewElevation,minDemResolution:e!=null?e.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,l=yield r.getProjectedBoundingBox(a,o,n,e?.signal);if(!l)return null;let c=l.boundingBox;if(l.requiresDrapedElevation){let h=this.symbolCreationContext.elevationProvider;if(h){$e(c,Xh);let p=h.getElevation(Xh[0],Xh[1],0,t,"ground")??0;c[2]=Math.min(c[2],p),c[5]=Math.max(c[5],p)}}return{boundingBox:c,screenSpaceObjects:l.screenSpaceObjects}})}whenGraphicBounds(r,e){return O(this,null,function*(){yield go(()=>this.owner?.loadedGraphics);let t=this.owner.layer?.objectIdField,i=this.owner.loadedGraphics.find(a=>a===r||t!=null&&a.attributes!=null&&r.attributes&&a.attributes[t]===r.attributes[t]);if(!i)throw new _e("internal:graphic-not-part-of-view","Graphic is not part of this view");let s=yield this._whenGraphics3DGraphic(i);return this._boundsForGraphics3DGraphic(s,e)})}computeAttachmentOrigin(r,e){let t=this.graphics3DGraphics.get(r.uid);if(!t)return null;let i=t.computeAttachmentOrigin();if(i.render.num===0&&i.draped.num===0)return null;A(vr,0,0,0);let s=0;if(i.render.num>0){if(!ba(i.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,Js,e))return null;le(vr,vr,Js),s++}if(i.draped.num>0){let[a,o]=i.draped.origin,n=this._viewElevationProvider.getElevation(a,o,"ground")??0;if(A(Js,a,o,n),!ba(Js,this._viewElevationProvider.spatialReference,Js,e))return null;le(vr,vr,Js),s++}return s>1&&k(vr,vr,1/s),new Op({x:vr[0],y:vr[1],z:vr[2],spatialReference:e})}getSymbolLayerSize(r,e){let t=this._symbols.get(r.id);if(t==null)throw new _e("internal:symbol-not-part-of-view","Symbol is not part of this view");let i=r.symbolLayers.indexOf(e);if(i===-1)throw new _e("internal:missing-symbol-layer","Symbol layer is not in symbol");let s=t.getSymbolLayerSize(i);if(s==null)throw new _e("internal:missing-size","Symbol layer has no valid size");return s}_graphicsCollectionChanged(r){this._startCreateGraphics&&(this.add(r.added),this.remove(r.removed))}graphicUpdateHandler(r){let e=r.graphic.uid,t=this.graphics3DGraphics.get(e);if(t!=null||this._graphicsWithoutSymbol.get(e)!=null)switch(r.property){case"visible":this._graphicUpdateVisibleHandler(t);break;case"geometry":this._graphicUpdateGeometryHandler(t,r);break;case"symbol":this._graphicUpdateSymbolHandler(t,r);break;case"attributes":break;case"origin-transform":this._graphicUpdateTransformHandler(t,r)}}_graphicUpdateGeometryHandler(r,e){this._graphicUpdateGeometryOrTransformHandler(r,e,()=>!(e.newValue==null||r==null||!r.graphics3DSymbol.updateGeometry(r,e.newValue)||!(this._labeler?.updateGraphicGeometry(r)??1))&&(this._labeler?.setDirty(),!0));let t=e.graphic.geometry;t!=null&&this._expandComputedExtent(t)}_graphicUpdateTransformHandler(r,e){let t=e.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(r,e,()=>e.newValue!=null&&r!=null&&t!=null&&r.graphics3DSymbol.updateTransform(r,t.spatialReference,e.newValue,e.action))}_graphicUpdateGeometryOrTransformHandler(r,e,t){if(e.graphic.geometry!=null)if(r!=null)t()||this._recreateGraphic(r.graphic);else{let i=e.graphic.symbol?.id;if(i){let s=this._symbols.get(i);if(s!=null&&s.loadStatus===We.LOADING)return}this._recreateGraphic(e.graphic)}else this._recreateGraphic(e.graphic)}_graphicUpdateSymbolHandler(r,e){let t=e.graphic,i=r!=null?r.graphics3DSymbol:e.oldValue!=null?this._symbols.get(e.oldValue.id):null;if(i==null||e.newValue==null)return void this._recreateGraphic(t);let s=i.symbol,a=this._getConvertedSymbol(e.newValue);if(a!=null&&(a.type!==s.type||a.type==="web-style")||s.type==="web-style")return void this._recreateGraphic(t);let o=this._graphicsBySymbol.get(s.id);if(o&&o.size!==1)return void this._recreateGraphic(t);let n=ua(s,a);if(n==null)return void this._updateSymbolMapping(s.id,a);let l={diff:n,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(i.prepareSymbolPatch(l),!jd(l.diff))return void this._recreateGraphic(t);let c=this._getRenderingInfo(t);if(c==null)return void this._recreateGraphic(t);let h=i.extentPadding;for(let p of l.symbolStatePatches)p();if(h!==i.extentPadding&&this._recomputeExtentPadding(),r!=null)for(let p of l.graphics3DGraphicPatches)p(r,c);this._updateSymbolMapping(s.id,a)}_graphicUpdateVisibleHandler(r){this._updateUserVisibility(r)&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}recreateGraphics(r){this._suspendSymbolCleanup=!0,this.remove(r),this.add(r),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===Oe.SYNC&&this._cleanupSymbols()}_recreateGraphic(r){this.recreateGraphics([r])}_beginGraphicUpdate(r){let e=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(r.uid,e),this._graphicsWaitingForSymbol.size===1&&this.notifyChange("dataUpdating"),e}_endGraphicUpdate(r){r&&(this._graphicsWaitingForSymbol.delete(r.uid),this._graphicsWaitingForSymbol.size===0&&(this._cleanupSymbols(),this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let r=0;this._symbols.forEach(e=>{e!=null&&(r=Math.max(r,e.extentPadding))}),this._set("extentPadding",r)}_expandComputedExtent(r){let e=Lb,t=r.spatialReference;Nd(r,e);let i=this._viewSpatialReference,s=Kh.tmpVec;if(Rr(t,i)||rc(e[0],e[1],0,t,s,i)&&(e[0]=s[0],e[1]=s[1],rc(e[3],e[4],0,t,s,i),e[3]=s[0],e[4]=s[1]),!(isFinite(e[0])&&isFinite(e[3])&&isFinite(e[1])&&isFinite(e[4])))return;let a=this.computedExtent,o=null,n=isFinite(e[2])&&isFinite(e[5]),l=n&&(a?.zmin==null||e[2]<a.zmin),c=n&&(a?.zmax==null||e[5]>a.zmax);a?(e[0]<a.xmin||e[1]<a.ymin||e[3]>a.xmax||e[4]>a.ymax||l||c)&&(o=this._propertiesPool.get("computedExtent"),o.xmin=Math.min(e[0],a.xmin),o.ymin=Math.min(e[1],a.ymin),o.xmax=Math.max(e[3],a.xmax),o.ymax=Math.max(e[4],a.ymax),o.spatialReference=i):(o=this._propertiesPool.get("computedExtent"),o.xmin=e[0],o.ymin=e[1],o.xmax=e[3],o.ymax=e[4],o.spatialReference=i),o&&(l&&(o.zmin=e[2]),c&&(o.zmax=e[5]),this._set("computedExtent",o))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}elevationInfoChange(){return O(this,null,function*(){this._abortElevationInfoChange();let r=new AbortController;this._elevationInfoChangeAbortController=r;let e=Pa(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=yield Ca(e,this._viewSpatialReference,r.signal,Q.getLogger(this)),ee(r.signal),this._elevationInfoChangeAbortController=null,this._labeler?.elevationInfoChange(),this.forEachGraphics3DSymbol((t,i,s)=>{t.globalPropertyChanged("elevationInfo",i)?i.forEach(a=>{let o=a.graphic,n=a.labelLayers;for(let l of n)l.graphics3DSymbolLayer.updateGraphicElevationContext(o,l)}):this._recreateSymbol(s)}),this.updateStageLayerElevationProvider(),this._elevationAlignment?.elevationInfoChange()})}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&this.layer.elevationInfo.mode==="relative-to-scene"||this._numberOfGraphicsProvidingElevation===0)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=ls(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&this.layer.elevationInfo.mode!=="relative-to-scene")&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new xi({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear(),this._filterVisibility!=null&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=ls(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(r=!1){if(!this._startCreateGraphics)return;let{loadedGraphics:e,view:t}=this.owner,i=t.basemapTerrain.tilingScheme&&e?.length?e.toArray():null;!r&&i||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),i&&(r?this.add(i):this.recreateGraphics(i))}_recreateSymbol(r){let e=this._graphicsBySymbol.get(r),t=[];e&&(e.forEach((s,a)=>{let o=s.usedMemory;this._conditionalRemove(s,a),this._spatialIndex?.remove(s),t.push(s.graphic),s.destroy(),this._removeGraphics3DGraphic(a,o),this._updateLayerVisibility(),this._featureStore.events.emit("changed")}),this._graphicsBySymbol.set(r,new Map));let i=this._symbols.get(r);ge(i),this._symbols.delete(r),this._symbolMaterials=null,this.add(t)}_recreateGraphicsForSymbol(r){let e=this._graphicsBySymbol.get(r);if(e){let t=[];e.forEach(i=>t.push(i.graphic)),this.recreateGraphics(t)}}_conditionalRemove(r,e){this._graphicsDrapedUids.delete(e),this._objectStates?.removeGraphic(r),this._labeler?.removeGraphic(r),this._deconflictor?.removeGraphic(r),this._graphicStateTracking!=null&&this._graphicStateTracking.removeGraphic(r)}add(r){r&&r.length!==0&&(this.owner.view.basemapTerrain?.tilingScheme?(this._updatePolicyForGraphics(r)===Oe.ASYNC?this._addDelayed(r):this._addImmediate(r),this.notifyChange("dataUpdating")):Q.getLogger(this).error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(r){if(this.effectiveUpdatePolicy===Oe.SYNC&&(this.layer.geometryType==="mesh"||this.layer.geometryType==null)){for(let e of r)if(e.geometry!=null&&e.geometry.type==="mesh"&&!e.geometry.loaded)return Oe.ASYNC}return this.effectiveUpdatePolicy}_addImmediate(r){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(let e of r)this._addGraphic(e,this._getRenderingInfo(e,Q.getLogger(this)),Oe.SYNC);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_addDelayed(r){for(let e of r){let t=e.uid,i=this._pendingUpdates.get(t);i?i.add?i.state!==Ie.NEW&&i.abortController?.abort():this._pendingAdds++:(i=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(t,i)),i.add=e}this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}remove(r){this.effectiveUpdatePolicy===Oe.ASYNC?this._removeDelayed(r):this._removeImmediate(r),this.notifyChange("dataUpdating")}_removeImmediate(r){for(let e of r)this._removeGraphic(e);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_removeDelayed(r){for(let e of r){let t=e.uid,i=this._pendingUpdates.get(t);if(i)i.add&&(i.remove?i.add=null:this._pendingUpdates.delete(t),i.state===Ie.LOADING&&i.abortController?.abort(),this._pendingAdds--);else{let s=this._pendingUpdatesPool.pushNew();s.remove=e,this._pendingUpdates.set(t,s),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}this._pendingUpdates.size===0&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&Q.getLogger(this).warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyPendingUpdates(r){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,this._pendingUpdates.size===0&&this._spatialIndex?.updating)return this._spatialIndex.update(),void r.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(let[e,t]of this._pendingUpdates){if(r.done){this._applyPendingRemovesFirst=!0;break}if(t.remove&&!t.add&&(this._pendingRemoves--,r.madeProgress(),this._removeGraphic(t.remove),t.remove=null,this._pendingUpdates.delete(e),this._pendingRemoves===0))break}}for(let[e,t]of this._pendingUpdates){if(r.done)break;t.add&&t.state===Ie.NEW&&this._processPendingUpdateNew(t);let i=this.effectiveUpdatePolicy;if(!t.remove||t.add&&t.state!==Ie.READY||(this._pendingRemoves--,r.madeProgress(),this._removeGraphic(t.remove),t.remove=null,i=Oe.SYNC),t.add)switch(t.state){case Ie.READY:this._addGraphic(t.add,t.renderingInfo,i),t.add=null,this._pendingAdds--,r.madeProgress();break;case Ie.REJECTED:t.add=null,this._pendingAdds--;case Ie.LOADING:}t.remove==null&&t.add==null&&this._pendingUpdates.delete(e)}this._pendingUpdates.size===0&&(this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("dataUpdating"))}_processPendingUpdateNew(r){if(!r.add)return void(r.state=Ie.READY);let e=r.add.geometry;e==null||e.type!=="mesh"||e.loaded?this._processPendingUpdateNewRenderingInfo(r):this._processPendingUpdateNewMesh(r,e)}_processPendingUpdateNewMesh(r,e){return O(this,null,function*(){r.state=Ie.LOADING,r.abortController=new AbortController;let t=r.abortController.signal;try{yield e.load({signal:t})}catch(i){return this._processPendingUpdateNewError(r,i)}r.abortController=null,this._processPendingUpdateNewRenderingInfo(r)})}_processPendingUpdateNewError(r,e){r.abortController=null,qr(e)?r.state=Ie.NEW:r.state=Ie.REJECTED}_processPendingUpdateNewRenderingInfo(r){return O(this,null,function*(){if(this.layer.renderer==null||this.layer.renderer.type!=="dictionary")return r.renderingInfo=this._getRenderingInfo(r.add,Q.getLogger(this)),void(r.state=Ie.READY);r.state=Ie.LOADING,r.abortController=new AbortController;let e=null;try{e=yield this._getRenderingInfoAsync(r.add,{signal:r.abortController.signal})}catch(t){return r.abortController=null,void(qr(t)?r.state=Ie.NEW:r.state=Ie.REJECTED)}e?.symbol==null?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,Q.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),r.renderingInfo=null):r.renderingInfo=e,r.state=Ie.READY})}_addGraphic(r,e,t){if(this._graphicsWithoutSymbol.set(r.uid,r),e?.symbol==null||!Bd(r))return;if(this.stage.renderView.objectAndLayerIdRenderHelper!=null&&this.setUidToIdOnAdd){let p=od(this.owner.view.map,this.layer.uid);this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(r.objectId,r.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled&&!p&&Ru(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}let i=e.symbol,s=this.getOrCreateGraphics3DSymbol(i,e.renderer);if(s==null)return;this._expandComputedExtent(r.geometry);let a=this._beginGraphicUpdate(r),o=new wa(r,e,this.layer),n=!1,l=p=>{p===s.symbol.id&&(n=!0)};this._whenSymbolRemoved.push(l);let c=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(l),this._graphicsWaitingForSymbol.get(r.uid)!==a||n||s.destroyed||this.graphicSymbolSupported&&r.symbol&&r.symbol.id!==s.symbol.id)--s.referenced,this._cleanupSymbols();else{let p=this._createGraphics3DGraphic(s,o);this._spatialIndex&&p!=null&&this._spatialIndex.add(p),--s.referenced,this._endGraphicUpdate(r)}this._featureStore.events.emit("changed"),this._labeler?.setDirty()}},h=p=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),n||(qr(p)?this.add([r]):s.destroyed||this._endGraphicUpdate(r)))};++this._loadingSymbols,t===Oe.ASYNC?s.load(()=>this._dataUpdateQueue.push(c,null).catch(uo),p=>this._dataUpdateQueue.push(()=>h(p),null).catch(uo)):s.load(c,h)}_removeGraphic(r){let e=r.uid,t=this.graphics3DGraphics.get(e);if(t){t.graphics3DSymbol.onRemoveGraphic(t);let i=t.usedMemory,s=t.isElevationSource;this._conditionalRemove(t,e),this._spatialIndex?.remove(t);let a=t.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(a)?.delete(e),this._graphicsWithoutSymbol.delete(e),this._removeGraphics3DGraphic(e,i,s),t.destroy(),this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(e),this._graphicsWaitingForSymbol.delete(e),this._graphicsWaitingForSymbol.size===0&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(r){if(r instanceof fc||r instanceof Qd){let e=this.symbolCreationContext.layer;return!!e.labelingInfo&&e.labelingInfo.some(t=>t.symbol===r)}return!1}_hasValidSymbolCreationContext(r){return!(r instanceof fc&&!this._hasLabelingContext(r))||(Q.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}_getRenderingInfo(r,e){let t=r.geometry;if(t==null)return e&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,e.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!Ao(t.spatialReference,this._viewSpatialReference))return e&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,e.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&r.symbol!=null)return e&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,e.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;let i=this.rendererHasGeometryOperations?Ps(r,this.layer):r,s;return this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||this.currentRenderer!=null)?s=this.owner.getRenderingInfo(i,this.currentRenderer,this._arcadeOnDemand):s={symbol:i.symbol||eu(i.geometry)},s?.symbol==null?(e&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,e.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):s}_getRenderingInfoAsync(r,e){if(r.geometry==null)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,Q.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&r.symbol!=null)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,Q.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;let t=this.rendererHasGeometryOperations?Ps(r,this.layer):r;return this.owner.getRenderingInfoAsync(t,this.currentRenderer,this._arcadeOnDemand,e)}_createGraphics3DSymbol(r,e){if(!this._hasValidSymbolCreationContext(r))return null;let t=this._getConvertedSymbol(r);if(!t)return null;let i;if(e!=null&&"backgroundFillSymbol"in e&&e.backgroundFillSymbol){let a=gc(e.backgroundFillSymbol,{ignoreDrivers:!0});a.symbol!=null&&(i=a.symbol.symbolLayers)}let s=$g(t,this.symbolCreationContext,i);return s.load(()=>{let a=s.extentPadding;a>this.extentPadding&&this._set("extentPadding",a),this.notifyChange("averageSymbolComplexity")},()=>{}),s}getOrCreateGraphics3DSymbol(r,e){let t=this._symbols.get(r.id);if(t===void 0){let i=this._unusedSymbolsCache.pop(r.id);t=i??(r instanceof au?new Il(r,s=>this._dataUpdateQueue.push(s,null),s=>this._createGraphics3DSymbol(s,e)):this._createGraphics3DSymbol(r,e)),this._symbols.set(r.id,t),this._symbolMaterials=null}return t!=null&&++t.referenced,t}trackGraphicState(r){return this._graphicStateTracking==null&&(this._graphicStateTracking=new Gl(this)),this._graphicStateTracking.add(r)}_addGraphics3DGraphic(r){this._usedMemory+=r.usedMemory,this.graphics3DGraphics.set(r.graphic.uid,r),this._numberOfGraphics++,r.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(r,e,t=!1){this._usedMemory-=e,this.graphics3DGraphics.delete(r),this._numberOfGraphics--,t&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(r,e){let t=e.graphic;if(this._graphicsWithoutSymbol.delete(t.uid),!this._symbols.has(r.symbol.id))return this.add([t]),null;if(this.graphics3DGraphics.has(t.uid))return null;let i=r.createGraphics3DGraphic(e);if(i==null)return null;this._addGraphics3DGraphic(i);let s=r.symbol.id;if(this._graphicsBySymbol.has(s)||this._graphicsBySymbol.set(s,new Map),this._graphicsBySymbol.get(s).set(t.uid,i),i.isDraped&&this._graphicsDrapedUids.add(t.uid),i.centroid=null,t.geometry!=null&&t.geometry.type!=="point"&&(i.centroid=li(t.geometry,this._viewSpatialReference)),this._updateUserVisibility(i),this._scaleVisibility!=null&&this._scaleVisibility.updateVisibility(i),this._filterVisibility!=null){let{defaultVisibility:o}=this._filterVisibility;i.setVisibilityFlag(we.GRAPHIC,Le.FILTER,o),o||this._filterVisibility.reapply()}this._deconflictor?.addGraphic(i),this._labeler?.addGraphic(i),this._objectStates?.addGraphic(i),i.initialize(this.stageLayer,this.owner),this._graphicStateTracking!=null&&this._graphicStateTracking.addGraphic(i);let a=this._whenGraphics3DGraphicRequests[t.uid];return a&&(delete this._whenGraphics3DGraphicRequests[t.uid],a.resolve(i)),this._symbolMaterials=null,i}_abortRendererChange(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)}rendererChange(r){return O(this,null,function*(){if(this._abortRendererChange(),r!==this.currentRenderer)if(this._validateRenderer(r),r==null&&this._currentRendererChange(null,!1),im(r))if(r?.arcadeRequired){let e=new AbortController;this._rendererChangeAbortController=e;let{arcadeUtils:t}=yield this._ensureArcade();ee(e);let i=t.hasGeometryOperations(r);i&&(yield t.enableGeometryOperations(),ee(e)),this.effectiveUpdatePolicy===Oe.ASYNC?yield this._updateQueue.push(()=>this._currentRendererChange(r,i),e.signal):this._currentRendererChange(r,i),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===Oe.ASYNC){let e=new AbortController;this._rendererChangeAbortController=e,yield this._updateQueue.push(()=>this._currentRendererChange(r,!1),e.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(r,!1);else this._currentRendererChange(r,!1)})}_ensureArcade(){return O(this,null,function*(){return this._arcadeOnDemand==null?(this._arcadeOnDemand=yield Qo(),this._arcadeOnDemand):this._arcadeOnDemand})}_currentRendererChange(r,e){this.currentRenderer=r,this.rendererHasGeometryOperations=e,this.symbolCreationContext.arcade=this._arcadeOnDemand;let t=this.symbolCreationContext.renderer;if(r===t)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),r==null)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();let i=ua(t,r);this._updateUnchangedSymbolMappings(i,r,t),this.symbolCreationContext.renderer=r,i!=null&&(i.type==="complete"?this.recreateAllGraphicsAndSymbols():i.type==="partial"&&(this._applyRendererDiff(i,r,t)?this._labeler?.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(r){for(let e in r.diff)switch(e){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete r.diff[e];break;default:return!0}return!1}_applySymbolSetDiff(r,e,t){r=r||[],e=e||[];let i=[];for(let s of e){let a=this._graphicsBySymbol.get(s.id);a&&a.forEach((o,n)=>{let l=o.graphic,c=this.layer instanceof ln?this.layer:null,h=this._arcadeOnDemand;if(s===t.defaultSymbol&&t.getSymbol(Ps(l,c),{arcade:h})===t.defaultSymbol)return;let p=o.usedMemory;r.length||t.defaultSymbol?i.push(l):this._graphicsWithoutSymbol.set(n,l);let d=this.graphics3DGraphics.get(n);this._conditionalRemove(d,n),o.destroy(),a.delete(n),this._removeGraphics3DGraphic(n,p),this._updateLayerVisibility()}),this._whenSymbolRemoved.forAll(o=>o(s.id))}(r.length||i.length)&&(this._graphicsWithoutSymbol.forEach(s=>i.push(s)),this._graphicsWithoutSymbol.clear(),this.add(i)),this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_applyUniqueValueRendererDiff(r,e,t){let i=r.diff.defaultSymbol,s=r.diff.uniqueValueInfos;if(i||s){let a=s?s.added.map(n=>n.symbol).filter(Pr):[],o=s?s.removed.map(n=>n.symbol).filter(Pr):[];if(s)for(let n=0;n<s.changed.length;n++)a.push(s.changed[n].newValue.symbol),o.push(s.changed[n].oldValue.symbol);return i?(t.defaultSymbol&&o.push(t.defaultSymbol),e.defaultSymbol&&a.push(e.defaultSymbol)):t.defaultSymbol&&a.length&&o.push(e.defaultSymbol),this._applySymbolSetDiff(a,o,e),delete r.diff.defaultSymbol,delete r.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(r,e,t){if(e?.type!=="unique-value"||t?.type!=="unique-value"||r!=null&&r.type!=="partial")return[];let i=l=>l!=null?l.id:null,s=r&&r.diff,a=s?.defaultSymbol,o=s&&s.uniqueValueInfos,n;if(o)n=o.unchanged.map(l=>({oldId:i(l.oldValue.symbol),newId:i(l.newValue.symbol)}));else{n=[];for(let l of t.uniqueValueInfos??[]){let c=i(l.symbol),h=e.uniqueValueInfos?.find(p=>p.value===l.value);h&&c!==i(h.symbol)&&n.push({oldId:c,newId:i(h.symbol)})}}return!a&&t.defaultSymbol&&n.push({oldId:i(t.defaultSymbol),newId:i(e.defaultSymbol)}),n}_updateSymbolMapping(r,e){let t=e!=null&&e?typeof e=="string"?e:e.id:null;if(r==null||r===t)return;let i=this._graphicsBySymbol.get(r);this._graphicsBySymbol.delete(r),i!==void 0&&this._graphicsBySymbol.set(t,i);let s=this._symbols.get(r);if(s!==void 0&&(this._symbols.delete(r),this._symbols.set(t,s),this._symbolMaterials=null,s!=null)){let a=typeof e=="string"?null:e;a!=null?s.symbol=a:s.symbol.id=t}}_updateUnchangedSymbolMappings(r,e,t){let i=this._calculateUnchangedSymbolMapping(r,e,t);for(let{oldId:s,newId:a}of i)this._updateSymbolMapping(s,a)}_applyRendererDiff(r,e,t){if(this._diffHasSymbolChange(r))return!1;if(e instanceof bc&&t instanceof bc&&this._applyUniqueValueRendererDiff(r,e,t)&&Object.keys(r.diff).length===0)return!0;for(let[i]of this._graphicsBySymbol){let s=this._symbols.get(i);if(s!=null)switch(s.applyRendererDiff(r,e)){case N.RecreateSymbol:this._recreateSymbol(i);break;case N.RecreateGraphics:this._recreateGraphicsForSymbol(i);case N.FastUpdate:}}return!0}opacityChange(){this.forEachGraphics3DSymbol((r,e)=>r.globalPropertyChanged("opacity",e)),this._updateStageLayerVisibility()}_slicePlaneEnabledChange(r){r!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=r,this.stageLayer.sliceable=r,this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged("slicePlaneEnabled",t)),this._deconflictor?.slicePlaneEnabledChange(),this._labeler?.slicePlaneEnabledChange())}_physicalBasedRenderingChange(r){this.symbolCreationContext.physicalBasedRenderingEnabled=r,this.forEachGraphics3DSymbol((e,t,i)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",t)||this._recreateSymbol(i)})}_skipHighSymbolLoDsChange(r){this.symbolCreationContext.skipHighSymbolLods=r,this.forEachGraphics3DSymbol((e,t,i)=>{e.globalPropertyChanged("skipHighSymbolLods",t)||this._recreateSymbol(i)})}_pixelRatioChange(){this.forEachGraphics3DSymbol((r,e,t)=>{r.globalPropertyChanged("pixelRatio",e)||this._recreateSymbol(t)})}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=gp(()=>{this._updatingPendingLoadedGraphicsChange=null})}setClippingExtent(r,e){let t=this.symbolCreationContext.clippingExtent,i=Ne();return Xg(r,i,e)?this.symbolCreationContext.clippingExtent=Oo(K(),i):this.symbolCreationContext.clippingExtent=null,!Xp(this.symbolCreationContext.clippingExtent,t)}modifyGraphics3DGraphicVisibilities(r){if(this.destroyed)return;let e=!1;this.graphics3DGraphics.forEach(t=>{r(t)&&(e=!0)}),e&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}forEachGraphics3DSymbol(r){for(let[e,t]of this._symbols){if(t==null)return;r(t,this._graphicsBySymbol.get(e)||Db,e)}}updateAllGraphicsVisibility(){this._filterVisibility!=null&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities(r=>{let e=this._updateUserVisibility(r),t=this._scaleVisibility!=null&&this._scaleVisibility.updateVisibility(r);return e||t})}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities(r=>r.setVisibilityFlag(we.GRAPHIC,Le.USER,!1))}_validateRenderer(r){let e=()=>`'${this.layer.title?`${this.layer.title}, `:""}id:${this.layer.id}'`,t=sm(r,{geometryType:this.layer?.geometryType,logWarning:i=>Q.getLogger(this).warn(`Symbology conversion for layer ${e()}: ${i}`)});if(t){let i=`Renderer for layer ${e} is not supported in a SceneView`;Q.getLogger(this).warn(i,t.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let r=!1;this._symbols.forEach((e,t)=>{if(e==null||e.referenced>0)return;let i=this._graphicsBySymbol.get(t);i&&i.size!==0||(this._graphicsBySymbol.delete(t),this._symbols.delete(t),this._symbolMaterials=null,this._unusedSymbolsCache.put(t,e,Yg(e),hd),r=!0)}),r&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){}get performanceInfo(){return new Dl(this.graphics3DGraphics.size,this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}},Ie;M.tmpVec=_(),u([v({readOnly:!0})],M.prototype,"computedExtent",void 0),u([v()],M.prototype,"currentRenderer",void 0),u([v()],M.prototype,"rendererHasGeometryOperations",void 0),u([v()],M.prototype,"_frameTaskHandle",void 0),u([v()],M.prototype,"_dataUpdateQueue",void 0),u([v()],M.prototype,"_updateQueue",void 0),u([v({readOnly:!0})],M.prototype,"_viewSpatialReference",null),u([v()],M.prototype,"_rendererChangeAbortController",void 0),u([v()],M.prototype,"_elevationInfoChangeAbortController",void 0),u([v()],M.prototype,"_initializeAbortController",void 0),u([v()],M.prototype,"_elevationAlignment",void 0),u([v()],M.prototype,"_scaleVisibility",void 0),u([v()],M.prototype,"_filterVisibility",void 0),u([v()],M.prototype,"_initializePromise",void 0),u([v()],M.prototype,"_spatialIndex",void 0),u([v({readOnly:!0})],M.prototype,"extentPadding",void 0),u([v()],M.prototype,"_updatingPendingLoadedGraphicsChange",void 0),u([v()],M.prototype,"_featureStore",void 0),u([v()],M.prototype,"_objectStates",void 0),u([v()],M.prototype,"_loadingSymbols",void 0),u([v()],M.prototype,"preferredUpdatePolicy",void 0),u([v()],M.prototype,"_forcedUpdatePolicy",void 0),u([v({readOnly:!0})],M.prototype,"effectiveUpdatePolicy",null),u([v({constructOnly:!0})],M.prototype,"elevationFeatureExpressionEnabled",void 0),u([v({constructOnly:!0})],M.prototype,"owner",void 0),u([v({constructOnly:!0})],M.prototype,"layer",void 0),u([v({constructOnly:!0})],M.prototype,"graphicSymbolSupported",void 0),u([v({constructOnly:!0})],M.prototype,"getRenderingInfoWithoutRenderer",void 0),u([v({constructOnly:!0})],M.prototype,"componentFactories",void 0),u([v({constructOnly:!0})],M.prototype,"setUidToIdOnAdd",void 0),u([v()],M.prototype,"featureStore",null),u([v()],M.prototype,"initializePromise",null),u([v()],M.prototype,"scaleVisibility",null),u([v()],M.prototype,"elevationAlignment",null),u([v()],M.prototype,"objectStates",null),u([v()],M.prototype,"filterVisibility",null),u([v({readOnly:!0})],M.prototype,"updating",null),u([v({readOnly:!0})],M.prototype,"dataUpdating",null),u([v({readOnly:!0})],M.prototype,"running",null),u([v({readOnly:!0})],M.prototype,"suspendedOrOutsideOfView",null),u([v({readOnly:!0,dependsOn:[]})],M.prototype,"updatingRemaining",null),u([v({readOnly:!0})],M.prototype,"displayFeatureLimit",null),u([v({readOnly:!0,dependsOn:[]})],M.prototype,"averageSymbolComplexity",null),u([v({constructOnly:!0})],M.prototype,"hasZ",void 0),u([v({constructOnly:!0})],M.prototype,"hasM",void 0),u([v()],M.prototype,"_objectIdField",null),M=Kh=u([ie("esri.views.3d.layers.graphics.Graphics3DCore")],M),function(r){r[r.NEW=0]="NEW",r[r.LOADING=1]="LOADING",r[r.READY=2]="READY",r[r.REJECTED=3]="REJECTED"}(Ie||(Ie={}));var ep=class{constructor(){this.add=null,this.renderingInfo=null,this.state=Ie.NEW,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=Ie.NEW,this.abortController=null,this.remove=null}},Ib=10,vr=_(),Js=_(),Db=new Map;var Gb=.05,Vl=class{constructor(){this._extents=new ta({allocator:e=>e||Ne()}),this._tmpExtent=Ne(),this._dirty=!1}get empty(){return this._extents.length===0}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),sa(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(e=Ai){let t=this._extents,i=new Set,s=0;for(;s!==t.length;){t.sort((a,o)=>a[0]-o[0]),s=t.length,i.clear();for(let a=0;a<t.length;++a){if(e.done)return;let o=t.at(a);if(o){for(let n=a+1;n<t.length;++n){let l=t.at(n);if(l==null||l[0]>=o[2])break;i.add(l)}i.forEach(n=>{if(o===n)return;if(n[2]<=o[0])return void i.delete(n);let l=xo(o),c=xo(n),h=this._tmpExtent;Bp(o,n,h);let p=l+c;(xo(h)-p)/p<Gb&&(sa(o,h),i.delete(n),t.remove(n),e.madeProgress())}),i.add(o)}}}this._dirty=!1}_contains(e){return this._extents.some(t=>tc(t,e))}_removeContained(e){this._extents.filterInPlace(t=>!tc(e,t))}get test(){}};var xr=class extends Ae{constructor(r){super(r),this._dirtyExtents=new Vl,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new Xt}initialize(){let r=this.elevationProvider,e=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=e.registerTask(Kg(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([r.on("elevation-change",t=>this._elevationChanged(t)),De(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,De(()=>Kg(this.graphicsCore.layer.elevationInfo?.mode),t=>this._task.priority=t)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){this.graphicsCoreOwner.suspended===!0?this._updateElevation=!1:this.graphicsCoreOwner.suspended===!1&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(r){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,r.madeProgress()),r.run(()=>this._dirtyExtents.merge(r));this.running&&!r.done;)this._updateDirtyGraphics(r),this._updateDirtyExtents(r);this.notifyChange("updating")}_updateDirtyGraphics(r){let e=this.graphicsCoreOwner.view.renderCoordsHelper,t=this.graphicsCore.effectiveUpdatePolicy===Oe.ASYNC;for(let i of this._dirtyGraphicsSet.keys()){let s=this.graphicsCore.getGraphics3DGraphicById(i);if(this._dirtyGraphicsSet.delete(i),s!=null&&(s.alignWithElevation(this.elevationProvider,e,t),this.graphicsCore.deconflictor?.setDirty(),r.madeProgress()),r.done)return}}_updateDirtyExtents(r){for(;!this._dirtyExtents.empty&&!r.done;){let e=this._dirtyExtents.pop(),t=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:e,spatialReference:t});let i=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(e,t,s=>{let a=this.graphicsCore.getGraphics3DGraphicById(s);a!=null&&a.needsElevationUpdates()&&this._dirtyGraphicsSet.add(s)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-i)+.9*this._averageExtentUpdateSize,r.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((r,e)=>this._dirtyGraphicsSet.add(e))}_elevationChanged(r){if(r.context==="scene"&&(!this.graphicsCore.layer.elevationInfo||this.graphicsCore.layer.elevationInfo.mode!=="relative-to-scene"))return;let e=r.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){let t=this.graphicsCore.computedExtent;t&&e[2]>t.xmin&&e[0]<t.xmax&&e[3]>t.ymin&&e[1]<t.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",r)}else e[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(e),this.notifyChange("updating")}};function Kg(r){return r==null?Xe.ELEVATION_ALIGNMENT:r==="relative-to-scene"?Xe.ELEVATION_ALIGNMENT_SCENE:Xe.ELEVATION_ALIGNMENT}u([v()],xr.prototype,"graphicsCoreOwner",void 0),u([v()],xr.prototype,"graphicsCore",void 0),u([v()],xr.prototype,"queryGraphicUIDsInExtent",void 0),u([v()],xr.prototype,"elevationProvider",void 0),u([v({readOnly:!0})],xr.prototype,"updating",null),u([v({readOnly:!0})],xr.prototype,"updatingRemaining",null),xr=u([ie("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],xr);function ey(r,e,t,i){return Fb(r,e,t,Vb(i,e,t,!0))}var Mb={dir:_(),len:0,clip:W()};function Vb(r,e,t,i){let s=Mb;return r?(t&&i&&(s.len=ia(e,t)),te(s.dir,r)):i?(s.len=ia(e,t),de(s.dir,t,e),k(s.dir,s.dir,1/s.len)):(de(s.dir,t,e),J(s.dir,s.dir)),s}function Ub(r,e,t){let i=z(r,t.dir),s=-Ye(r,e);if(s<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return s>0;if((s<0||i<0)&&!(s<0&&i<0))return!0;let a=s/i;return i>0?a<t.clip[1]&&(t.clip[1]=a):a>t.clip[0]&&(t.clip[0]=a),t.clip[0]<=t.clip[1]}function Fb(r,e,t,i){i.clip[0]=0,i.clip[1]=t?i.len:Number.MAX_VALUE;for(let s=0;s<r.length;s++)if(!Ub(r[s],e,i))return!1;return!0}var ry=.5*Math.PI,Bb=ry/Math.PI*180,Ul=class{constructor(e){this._renderCoordsHelper=e.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:_(),direction:_()};for(let t=0;t<4;t++)this._extent[t]={origin:_(),direction:_(),cap:{next:null,direction:_()}},this._planes[t]=vt();this._planes[je.NEAR]=vt(),this._planes[je.FAR]=vt(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,i,s=!0){let a=this._extent;this._toRenderBoundingExtent(e,t,i),le(this._center.origin,a[0].origin,a[2].origin),k(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),s||k(this._center.direction,this._center.direction,-1);for(let o=0;o<4;o++){let n=a[o];this._renderCoordsHelper.worldUpAtPosition(n.origin,n.direction);let l=a[o===3?0:o+1];n.cap.next=l.origin,Vp(n.cap.direction,n.origin,l.origin),xc(n.direction,n.cap.direction,n.origin,this._planes[o]),s||k(n.direction,n.direction,-1)}xc(a[0].cap.direction,a[1].cap.direction,a[0].origin,this._planes[je.NEAR]),s?vc(this._planes[je.NEAR],this._planes[je.FAR]):(du(this._planes[je.FAR],this._planes[je.NEAR]),vc(this._planes[je.NEAR],this._planes[je.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*Pi(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,i=!1){if(e==null)return!1;if(this._renderCoordsHelper.viewingMode===Me.Global){let a=this._maxSpanSpatialReference.isGeographic?Bb:ry*t;if(this._maxSpan>a)return!0;if(e.altitude!=null&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(this._maxSpan===0){let a=this._extent[0];return!(i||!e.intersectsRay(ya(a.origin,a.direction)))}for(let a=0;a<this._extent.length;a++){let o=this._extent[a];if(!i&&e.intersectsRay(ya(o.origin,o.direction))||e.intersectsLineSegment(vs(o.origin,o.cap.next,zb),o.cap.direction))return!0}let s=i?this._planes:this._planesWithoutFar;for(let a=0;a<e.lines.length;a++){let o=e.lines[a];if(ey(s,o.origin,o.endpoint,o.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,i){zp(e,Jt),Jt[2]=i,bt(t,Jt,tp,this._renderCoordsHelper.spatialReference),wr(ty,tp),F(yt);for(let{x0:a,x1:o,y0:n,y1:l}of Nb)for(let c=0;c<5;c++){let h=c/4;Jt[0]=Kl(e[a],e[o],h),Jt[1]=Kl(e[n],e[l],h),Jt[2]=i,ba(Jt,t,Jt,this._renderCoordsHelper.spatialReference),X(Jt,Jt,ty),Tr(yt,Jt)}A(this._extent[0].origin,yt[0],yt[1],yt[2]),A(this._extent[1].origin,yt[3],yt[1],yt[2]),A(this._extent[2].origin,yt[3],yt[4],yt[2]),A(this._extent[3].origin,yt[0],yt[4],yt[2]);for(let a=0;a<4;++a)X(this._extent[a].origin,this._extent[a].origin,tp)}_toRenderBoundingExtentLocal(e,t,i){Hi(e,t,kr,this._renderCoordsHelper.spatialReference),A(this._extent[0].origin,kr[0],kr[1],i),A(this._extent[1].origin,kr[2],kr[1],i),A(this._extent[2].origin,kr[2],kr[3],i),A(this._extent[3].origin,kr[0],kr[3],i)}_toRenderBoundingExtent(e,t,i){switch(this._renderCoordsHelper.viewingMode){case Me.Global:this._toRenderBoundingExtentGlobal(e,t,i);break;case Me.Local:this._toRenderBoundingExtentLocal(e,t,i);break;default:this._renderCoordsHelper.viewingMode}}_isVisibleInFrustumGlobal(e){if(Ye(e.planes[je.NEAR],this._center.origin)<0&&z(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){let i=this._extent[t];if(Ye(e.planes[je.NEAR],i.origin)<0&&z(i.direction,e.direction)<0)return!0}return!1}},Nb=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],Jt=_(),tp=V(),ty=V(),yt=K(),kr=Ne(),zb=ga();var jb=1.2,os=class extends Ae{constructor(r){super(r),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){let{graphicsCoreOwner:r}=this;this._extentIntersection=new Ul({renderCoordsHelper:r.view.renderCoordsHelper});let e=r.view,t=e.basemapTerrain,i=e.resourceController.scheduler;this.addHandles([e.on("resize",()=>this._viewChange()),De(()=>e.state.camera,()=>this._viewChange(),yo),i.registerTask(Xe.FRUSTUM_VISIBILITY,this),De(()=>t.visibleElevationBounds,()=>this._elevationBoundsChange())]),e.viewingMode==="local"?this._isVisibleBelowSurface=!0:this.addHandles([De(()=>[t.baseOpacity,t.wireframe,e.map?.ground?.navigationConstraint?.type],()=>this._updateIsVisibleBelowSurface(),Pp)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(r){this._extent=r,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(r){this._isVisibleBelowSurfaceInternal=r,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){let r=this.graphicsCoreOwner.view,e=r.basemapTerrain,t=r.viewingMode==="local",i=r.map.ground?.navigationConstraint?.type==="none";this._isVisibleBelowSurface=t||!e.opaque||i}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;let r=this.graphicsCoreOwner.view,e;if(this._isVisibleBelowSurfaceInternal)e=-.3*Pi(r.spatialReference).radius;else{let{min:t,max:i}=r.basemapTerrain.visibleElevationBounds;e=t-Math.max(1,(i-t)*(jb-1))}this._extentIntersection.update(this._extent,r.spatialReference,e)}get running(){return this.updating}runTask(r){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),Qr;this._updateExtentIntersection();let e=this.graphicsCoreOwner.view.frustum,t=Pi(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(e,t)),r.madeProgress()}};u([v({readOnly:!0})],os.prototype,"suspended",void 0),u([v({constructOnly:!0})],os.prototype,"graphicsCoreOwner",void 0),u([v({readOnly:!0})],os.prototype,"updating",void 0),os=u([ie("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],os);var Sr;(function(r){r[r.Object=0]="Object",r[r.RenderGeometry=1]="RenderGeometry",r[r.External=2]="External",r[r.COUNT=3]="COUNT"})(Sr||(Sr={}));var Bl=class{constructor(){this._items=[]}addObject(e,t){this._items.push({type:Sr.Object,objectStateId:t,object:e})}addRenderGeometry(e,t,i){this._items.push({type:Sr.RenderGeometry,objectStateId:t,renderGeometry:e,owner:i})}addExternal(e,t){this._items.push({type:Sr.External,objectStateId:t,remove:e})}remove(e){for(let t=this._items.length-1;t>=0;--t){let i=this._items[t];i.objectStateId===e&&(Fl(i),this._items.splice(t,1))}}removeObject(e){for(let t=this._items.length-1;t>=0;--t){let i=this._items[t];i.type===Sr.Object&&i.object===e&&(Fl(i),this._items.splice(t,1))}}removeRenderGeometry(e){for(let t=this._items.length-1;t>=0;--t){let i=this._items[t];i.type===Sr.RenderGeometry&&i.renderGeometry===e&&(Fl(i),this._items.splice(t,1))}}removeAll(){this._items.forEach(e=>{Fl(e)}),this._items=[]}};function Fl(r){switch(r.type){case Sr.Object:r.objectStateId.channel===ct.Highlight?r.object.removeHighlight(r.objectStateId):r.objectStateId.channel===ct.MaskOccludee&&r.object.removeOcclude(r.objectStateId);break;case Sr.RenderGeometry:r.owner.removeRenderGeometryObjectState(r.renderGeometry,r.objectStateId);break;case Sr.External:r.remove(r.objectStateId)}}var Nl=class{constructor(e,t){this.stateType=e,this.objectIdField=t,this.objectStateSet=new Bl,this.ids=new Set,this.paused=!1}hasGraphic(e){if(this.objectIdField){let t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}};var jl=class{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(e=>e.objectStateSet.removeAll()),this._stateSets.length=0)}acquireSet(e,t){let i=new Nl(e,t);this._stateSets.push(i);let s=At(()=>this.releaseSet(i));return{set:i,handle:s}}releaseSet(e){e.objectStateSet.removeAll();let t=this._stateSets?this._stateSets.indexOf(e):-1;t!==-1&&this._stateSets.splice(t,1)}setUid(e,t){e.ids.add(t);let i=this._graphicsCore.graphics3DGraphics.get(t);i&&zl(i,e)}setUids(e,t){t.forEach(i=>this.setUid(e,i))}setObjectIds(e,t){t.forEach(i=>e.ids.add(i)),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach(t=>{!t.paused&&t.hasGraphic(e)&&zl(e,t)})}removeGraphic(e){this._stateSets.forEach(t=>{t.hasGraphic(e)&&Hb(e,t)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(e=>e.objectStateSet.removeAll())}_initializeSet(e){let t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach(i=>{i&&e.hasGraphic(i)&&zl(i,e)}):e.ids.forEach(i=>{let s=t.get(i);s&&zl(s,e)})}get test(){}};function zl(r,e){r.addObjectStateSet(e.stateType,e.objectStateSet)}function Hb(r,e){r.removeObjectState(e.objectStateSet)}var Ot=class extends Ae{constructor(r){super(r),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new Bo,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();let r=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(r.registerTask(Xe.SCALE_VISIBILITY,this)),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(r){let e=this.graphicsCoreOwner.view.spatialReference,t=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(e===t)this._extent=r??null;else{let i=Ne();Hi(r,e,i,t)?this._extent=i:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){let r=this.layer,e=r.effectiveScaleRange,t=this.layerScaleEnabled&&e!=null&&iy(e.minScale,e.maxScale);r.labelingInfo&&!t&&(t=r.labelingInfo.some(s=>s&&iy(s.minScale??0,s.maxScale??0)));let i=this._scaleRangeActive!==t;return this._scaleRangeActive=t,t&&!this.hasHandles(no)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on("scale-change",s=>this._scaleUpdateHandler(s)),no),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on("tiles-visibility-changed",()=>this._setDirty()),no)):!t&&this.hasHandles(no)&&this.removeHandles(no),i}get running(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(r){let e=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&e&&e.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return Qr;{this._layerScaleRangeVisibilityQuery=!0;let{minScale:t,maxScale:i}=this.layer.effectiveScaleRange;e.queryVisibleScaleRange(this._extent,t,i,s=>this._finishUpdate(s))}}else this._finishUpdate(!0);r.madeProgress()}_finishUpdate(r){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!r),this._dirty=!1}_visibleAtLayerScale(r){let e=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||wc(r,e.minScale||0,e.maxScale||0)}_visibleAtLabelScale(r,e){return wc(r,e.minScale||0,e.maxScale||0)}_graphicScale(r){let e;return r.centroid!=null?e=r.centroid:r.graphic.geometry!=null&&r.graphic.geometry.type==="point"&&(e=r.graphic.geometry),e?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(e):1:null}_graphicVisible(r){if(!this.layerScaleEnabled)return!0;let e=this._graphicScale(r);return this._visibleAtLayerScale(e)}updateVisibility(r){if(this._scaleRangeActive){let e=this._graphicVisible(r);return r.setVisibilityFlag(we.GRAPHIC,Le.SCALE_RANGE,e)}return!1}updateGraphicLabelScaleVisibility(r){if(!this._scaleRangeActive||!r.labelLayers||r.labelLayers.length===0)return!1;let e=this._graphicScale(r),t=this._updateLabelScaleVisibility(r,e);return t&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty()),t}_updateLabelScaleVisibility(r,e){if(!r.labelLayers||r.labelLayers.length===0)return!1;let t=r.labelLayers[0]._labelClass;if(t?.minScale!=null&&t.maxScale!=null){let i=this._visibleAtLabelScale(e,t);if(r.setVisibilityFlag(we.LABEL,Le.SCALE_RANGE,i))return!0}return!1}_scaleUpdateHandler(r){if(this._setDirty(),!this.graphicsCore.visible)return;let e=r.extent,t=r.scale,i=this._visibleAtLayerScale(t),s=!1,a=this.graphicsCoreOwner.view.spatialReference,o=r.spatialReference;if(o==null)return void Q.getLogger(this).error("scaleUpdate: Internal error, no SpatialReference given for tiles");let n=!o.equals(a);if(n&&!Hi(e,o,sy,a))return void Q.getLogger(this).error("scaleUpdate: Internal error, cannot project AABR from "+o+" to wkid "+a);let l=n?sy:e;this.queryGraphicUIDsInExtent(l,a,c=>{let h=this.graphicsCore.getGraphics3DGraphicById(c);if(h==null)return;let p=h.centroid;p!=null&&(e[0]>p.x||e[1]>p.y||e[2]<p.x||e[3]<p.y)||(h.setVisibilityFlag(we.GRAPHIC,Le.SCALE_RANGE,i)&&(s=!0),this._updateLabelScaleVisibility(h,t)&&(s=!0))}),s&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(r=>r.setVisibilityFlag(we.GRAPHIC,Le.SCALE_RANGE,!0)):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}};function iy(r,e){return r>0||e>0}u([v()],Ot.prototype,"graphicsCoreOwner",void 0),u([v()],Ot.prototype,"layer",void 0),u([v()],Ot.prototype,"queryGraphicUIDsInExtent",void 0),u([v()],Ot.prototype,"graphicsCore",void 0),u([v()],Ot.prototype,"basemapTerrain",void 0),u([v({constructOnly:!0})],Ot.prototype,"layerScaleEnabled",void 0),u([v({readOnly:!0})],Ot.prototype,"suspended",void 0),u([v({readOnly:!0})],Ot.prototype,"updating",null),u([v()],Ot.prototype,"_dirty",void 0),Ot=u([ie("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],Ot);var no="terrain-events",sy=Ne();var fe=class extends Ae{constructor(r){super(r),this.type="graphics-3d",this.graphicsCore=null,this.drapeSourceType=am.Features,this.scaleVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this._suspendResumeExtent=null,this._updatingHandles=new Bo}initialize(){let{layer:r}=this,e="effectiveScaleRange"in r?r:null,t=this.scaleVisibilityEnabled&&e!=null,i=new M({owner:this,layer:this.owner.layer,preferredUpdatePolicy:Oe.SYNC,graphicSymbolSupported:!0,componentFactories:{elevationAlignment:(s,a)=>new xr({graphicsCoreOwner:this,graphicsCore:s,queryGraphicUIDsInExtent:a,elevationProvider:this.view.elevationProvider}),scaleVisibility:t?(s,a)=>new Ot({graphicsCoreOwner:this,layer:e,queryGraphicUIDsInExtent:a,graphicsCore:s,basemapTerrain:this.owner.view.basemapTerrain}):null,objectStates:s=>new jl(s)}});if(this._set("graphicsCore",i),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new os({graphicsCoreOwner:this})),"fullOpacity"in this.owner){let s=this.owner;this._updatingHandles.add(()=>s.fullOpacity,()=>this.graphicsCore.opacityChange())}if("elevationInfo"in r){let s=r;this._updatingHandles.add(()=>s.elevationInfo,(a,o)=>{ua(a,o)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})}this._set("initializePromise",this._initializeAsync()),this._updatingHandles.addPromise(this.initializePromise)}_initializeAsync(){return O(this,null,function*(){try{yield this.graphicsCore.initializePromise}catch(r){if(qr(r))return;throw r}this.destroyed||(this.addHandles(De(()=>this.view.clippingArea,()=>this._updateClippingExtent(),yo)),this._updateClippingExtent(),this._setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())})}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",ge(this.frustumVisibility)),this._set("graphicsCore",ge(this.graphicsCore))}get layer(){return this.owner.layer}get view(){return this.owner.view}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get scaleVisibilitySuspended(){return!(this.scaleVisibility==null||!this.scaleVisibility.suspended)}get frustumVisibilitySuspended(){return this.frustumVisibility!=null&&this.frustumVisibility.suspended}get suspended(){return this.owner.suspended??!1}get updating(){return!!(this.graphicsCore?.updating||this.scaleVisibility!=null&&this.scaleVisibility.updating||this.frustumVisibility!=null&&this.frustumVisibility.updating||this._updatingHandles.updating)}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner.fullOpacity??1}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}notifyGraphicGeometryChanged(r){this.graphicsCore.notifyGraphicGeometryChanged(r)}notifyGraphicVisibilityChanged(r){this.graphicsCore.notifyGraphicVisibilityChanged(r)}getRenderingInfo(r,e,t){let i=Qm(r,{renderer:e,arcade:t});if(i?.color){let s=i.color;s[0]=s[0]/255,s[1]=s[1]/255,s[2]=s[2]/255}return i}getRenderingInfoAsync(r,e,t,i){return Jm(r,Z({renderer:e,arcade:t},i))}getHit(r){if(this.owner.loadedGraphics){let e=this.owner.loadedGraphics.find(t=>t.uid===r);if(e){let t=this.layer instanceof ln?this.layer:null,i=Ps(e,t);return{type:"graphic",graphic:i,layer:i.layer}}}return null}whenGraphicBounds(r,e){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(r,e):Promise.reject()}computeAttachmentOrigin(r,e){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(r,e):null}getSymbolLayerSize(r,e){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(r,e):null}maskOccludee(r){let e=this.graphicsCore?.objectStates;if(!e)return At();let{set:t,handle:i}=e.acquireSet(ct.MaskOccludee,null);return e.setUid(t,r.uid),i}highlight(r){let e=this.graphicsCore?.objectStates;if(!e)return At();if(r instanceof Ud)return ay;if(typeof r=="number")return this.highlight([r]);if(r instanceof yc)return this.highlight([r]);if(r instanceof Sp&&(r=r.toArray()),Array.isArray(r)&&r.length>0){if(r[0]instanceof yc){let t=r.map(a=>a.uid),{set:i,handle:s}=e.acquireSet(ct.Highlight,null);return e.setUids(i,t),s}if(typeof r[0]=="number"){let t=r,{set:i,handle:s}=e.acquireSet(ct.Highlight,null);return e.setObjectIds(i,t),s}}return ay}_setupSuspendResumeExtent(){let{scaleVisibility:r,frustumVisibility:e}=this;if(r==null&&e==null)return;let t=({computedExtent:i,extentPadding:s})=>{this._suspendResumeExtent=Gm(i,this._suspendResumeExtent,ef,s),r?.setExtent(this._suspendResumeExtent),e?.setExtent(this._suspendResumeExtent)};this.addHandles(De(()=>({computedExtent:this.graphicsCore?.computedExtent,extentPadding:this.graphicsCore?.extentPadding}),i=>t(i),_o))}_updateClippingExtent(){let r=this.view.clippingArea;this.graphicsCore.setClippingExtent(r,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()}};u([v()],fe.prototype,"type",void 0),u([v({constructOnly:!0})],fe.prototype,"owner",void 0),u([v()],fe.prototype,"layer",null),u([v()],fe.prototype,"view",null),u([v({constructOnly:!0})],fe.prototype,"graphicsCore",void 0),u([v()],fe.prototype,"scaleVisibility",null),u([v({constructOnly:!0})],fe.prototype,"frustumVisibility",void 0),u([v()],fe.prototype,"elevationAlignment",null),u([v()],fe.prototype,"scaleVisibilitySuspended",null),u([v({readOnly:!0})],fe.prototype,"frustumVisibilitySuspended",null),u([v()],fe.prototype,"suspended",null),u([v({readOnly:!0})],fe.prototype,"updating",null),u([v()],fe.prototype,"loadedGraphics",null),u([v()],fe.prototype,"fullOpacity",null),u([v()],fe.prototype,"slicePlaneEnabled",null),u([v()],fe.prototype,"drapeSourceType",void 0),u([v()],fe.prototype,"updatePolicy",null),u([v({constructOnly:!0})],fe.prototype,"scaleVisibilityEnabled",void 0),u([v({constructOnly:!0})],fe.prototype,"frustumVisibilityEnabled",void 0),u([v()],fe.prototype,"initializePromise",void 0),fe=u([ie("esri.views.3d.layers.graphics.GraphicsProcessor")],fe);var ay=At();function ny(r,e,t){return O(this,null,function*(){if(r==null||e.candidates.length===0)return oy;let i=r.graphics3DGraphicsByObjectID??r.graphics3DGraphics,s=[],a=[],{renderer:o}=r,n=o!=null&&"arcadeRequired"in o&&o.arcadeRequired?Qo():null,l=(S,x)=>O(this,[S,x],function*(m,{graphic:y,graphics3DSymbol:b}){let w=yield n,E=yield r.getRenderingInfoAsync(y,o,w,{signal:t});return E==null?[]:b.queryForSnapping(m,h,E,t)}),{candidates:c,spatialReference:h}=e;for(let m=0;m<c.length;++m){let y=c[m],{objectId:b}=y,S=typeof b=="number"?i?.get(b):void 0;if(S==null)continue;let{graphics3DSymbol:x}=S;x.symbologySnappingSupported&&(s.push(l(y,S)),a.push(m))}if(s.length===0)return oy;let p=yield Promise.all(s);ee(t);let d=[],f=[];for(let m=0;m<p.length;++m){let y=p[m],b=a[m];for(let S of y)d.push(S),f.push(b)}return{candidates:d,sourceCandidateIndices:f}})}var oy={candidates:[],sourceCandidateIndices:[]};var Hl=class{constructor(e,t=0,i=0,s=0,a=0,o=null){this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=i,this.maximumFeatures=s,this.nodes=a,this.core=o}};function ly(r){let e=r.view.spatialReference,t=r.layer.fullExtent,i=t!=null&&t.spatialReference;if(t==null||!i)return Promise.resolve(null);if(i.equals(e))return Promise.resolve(t.clone());let s=Rp(t,e);return s!=null?Promise.resolve(s):r.view.state.isLocal?tm(t,e,r.layer.portalItem).then(a=>!r.destroyed&&a?a:null).catch(()=>null):Promise.resolve(null)}var Cr=class extends Ym(rm){constructor(){super(...arguments),this.type="graphics-3d",this.symbologySnappingSupported=!0,this._slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.ignoresMemoryFactor=!0}initialize(){this._set("processor",new fe({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.initializePromise),this.addHandles(this.layer.on("graphic-update",r=>this.processor.graphicsCore.graphicUpdateHandler(r))),this.addResolvingPromise(ly(this).then(r=>this.fullExtentInLocalViewSpatialReference=r)),this.layer.internal?this.notifyChange("updating"):this.addHandles(fo(()=>this.view?.basemapTerrain?.ready,()=>()=>this.notifyChange("updating"),{once:!0}))}destroy(){this._updatingHandles.removeAll(),this._set("processor",ge(this.processor))}get loadedGraphics(){return this.layer.graphics}get legendEnabled(){return this.canResume()&&!this.processor?.frustumVisibilitySuspended}get visibleAtCurrentScale(){return!this.processor?.scaleVisibilitySuspended}get slicePlaneEnabled(){let r=this.layer.internal;return this._slicePlaneEnabled&&!r}set slicePlaneEnabled(r){this._slicePlaneEnabled=r}getSuspendInfo(){let r=super.getSuspendInfo();return r.outsideOfView=this.processor?.frustumVisibilitySuspended??!1,r}getHit(r){return this.processor.getHit(r)}whenGraphicBounds(r,e){return this.processor.whenGraphicBounds(r,e)}computeAttachmentOrigin(r,e){return this.processor?.computeAttachmentOrigin(r,e)}getSymbolLayerSize(r,e){return this.processor.getSymbolLayerSize(r,e)}queryGraphics(){return Promise.resolve(this.loadedGraphics)}maskOccludee(r){return this.processor.maskOccludee(r)}highlight(r){return this.processor.highlight(r)}elevationAlignPointsInFeatures(r,e){return O(this,null,function*(){let{processor:t}=this;if(t?.graphics3DGraphics==null)throw new _e("graphicslayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");let{graphics3DGraphics:i}=t,s=a=>typeof a=="number"?i.get(a):void 0;return Zm(this.view,this.layer,s,r,e)})}queryForSymbologySnapping(r,e){return O(this,null,function*(){return ny(this.processor,r,e)})}get updatePolicy(){return this.processor?.graphicsCore.effectiveUpdatePolicy||Oe.SYNC}isUpdating(){return this.view&&this.layer&&!(!this.processor?.updating&&(this.layer.internal||this.view.basemapTerrain?.ready))}get performanceInfo(){return new Hl(this.usedMemory,this.loadedGraphics.length,-1,-1)}get usedMemory(){return this.processor?.graphicsCore?.usedMemory??0}get unloadedMemory(){return this.processor?.graphicsCore?.unprocessedMemoryEstimate}get test(){return{graphics3DProcessor:this.processor,loadedGraphics:this.loadedGraphics}}};u([v()],Cr.prototype,"loadedGraphics",null),u([v({readOnly:!0})],Cr.prototype,"legendEnabled",null),u([v()],Cr.prototype,"layer",void 0),u([v({readOnly:!0})],Cr.prototype,"processor",void 0),u([v({readOnly:!0})],Cr.prototype,"visibleAtCurrentScale",null),u([v()],Cr.prototype,"_slicePlaneEnabled",void 0),u([v({type:Boolean})],Cr.prototype,"slicePlaneEnabled",null),Cr=u([ie("esri.views.3d.layers.GraphicsLayerView3D")],Cr);var LB=Cr;export{LB as default};
