import{a as q,b as T}from"./chunk-ALVXTOCH.js";import{B as j,I as k,J as w}from"./chunk-FOMIQQJB.js";import{a as M}from"./chunk-HTWD7KCG.js";import{n as R}from"./chunk-UIR6P2R4.js";import{a as b,b as h}from"./chunk-W47PGZ3Y.js";import{f as v,h as C,i as F}from"./chunk-XIMCHX2H.js";import{l as I,r as E}from"./chunk-HQMV3KQV.js";import{a as d,b as x,h as g}from"./chunk-EAH6BNBL.js";var K="esri.widgets.Feature.support.featureUtils",N=()=>E.getLogger(K),B=/href=(""|'')/gi,J=/(\{([^{\r\n]+)\})/g,W=/'/g,S=/^\s*expression\//i,X=/(\n)/gi,Y=/[\u00A0-\u9999<>&]/gim,ee=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,te=/^(?:mailto:|tel:)/,z="relationships/",U=C("short-date-short-time");function je(e){if(e!=null)return(e.sourceLayer||e.layer)??void 0}function ke(n){return g(this,arguments,function*({type:e,value:t,event:r}){try{return typeof t=="function"?t(r):t}catch(a){return void N().error("error",`An error occurred when calling the "${e}" function`,{error:a,graphic:r.graphic,value:t})}})}function Ue(e=""){if(e)return!te.test(e.trim().toLowerCase())}function re(e){return!!e&&S.test(e)}function ne(e,t){if(!t||!re(t)||!e)return;let r=t.replace(S,"").toLowerCase();return e.find(({name:n})=>n.toLowerCase()===r)}function De(e,t){let r=ne(t,e?.fieldName);return r?r.title||null:e?e.label||e.fieldName:null}function ie(e,t){return`{${t.get(e.toLowerCase())?.fieldName||e}}`}function ae(e){return e.replaceAll(B,"")}function G(e,t){let r=A(t,e);return r?r.name:e}function $e(e,t){return e&&e.map(r=>G(r,t))}function A(e,t){return e&&typeof e.getField=="function"&&t?e.getField(t)??null:null}function H(e){return`${e}`.trim()}function Oe({attributes:e,globalAttributes:t,layer:r,text:n,expressionAttributes:a,fieldInfoMap:i}){return n?oe({formattedAttributes:t,template:ce(n,d(d(d({},t),a),e),r),fieldInfoMap:i}):""}function oe({formattedAttributes:e,template:t,fieldInfoMap:r}){return H(ae(I(I(t,n=>ie(n,r)),e)))}function le(e,t,r=!1){let n=t[e];if(typeof n=="string"){let a="%27",i=(r?encodeURIComponent(n):n).replaceAll(W,a);t[e]=i}}function se(e,t=!1){let r=d({},e);return Object.keys(r).forEach(n=>le(n,r,t)),r}function ue(e,t,r){let n=(t=H(t))&&t[0]!=="{";return I(e,se(r,n||!1))}function fe(e,t){return e.replaceAll(J,(r,n,a)=>{let i=A(t,a);return i?`{${i.name}}`:n})}function ce(e,t,r){let n=fe(e,r);return n&&n.replaceAll(ee,(a,i,o)=>ue(a,i||o,t))}function de(e,t){if(typeof e=="string"&&t&&t.dateFormat==null&&(t.places!=null||t.digitSeparator!=null)){let r=Number(e);if(!isNaN(r))return r}return e}function pe(e){return e!=null&&typeof e=="object"&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&(e.type==="feature"||e.type==="scene"||e.type==="sublayer")&&"when"in e}function ye(e){return e!=null&&typeof e=="object"&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function me(e){return pe(e)&&ye(e)}function ge(e,t){let{fieldInfos:r,fieldName:n,preventPlacesFormatting:a,layer:i,timeZone:o}=t,s=Ie(r,n),u=A(i,n);if(s&&!w(n)){let f=u?.type,c=s.format?.dateFormat;if(f==="date"||f==="date-only"||f==="time-only"||f==="timestamp-offset"||c)return T(e,{format:c,fieldType:f,timeZoneOptions:{layerTimeZone:i&&"preferredTimeZone"in i?i.preferredTimeZone:null,viewTimeZone:o,datesInUnknownTimezone:!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone}})}let l=s?.format;return typeof e=="string"&&w(n)&&l?be(e,l):typeof(e=de(e,l))=="string"||e==null||l==null?P(e):h(e,a?x(d({},b(l)),{minimumFractionDigits:0,maximumFractionDigits:20}):b(l))}function be(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?L(e,",",", ",t):e.includes(";")?L(e,";","; ",t):e.includes(" ")?L(e," "," ",t):h(Number(e),b(t))}function L(e,t,r,n){return e.trim().split(t).map(a=>h(Number(a),b(n))).join(r)}function Ie(e,t){if(e?.length&&t)return e.find(r=>r.fieldName?.toLowerCase()===t.toLowerCase())}function he({fieldName:e,graphic:t,layer:r}){if(_(e)||!r||typeof r.getFeatureType!="function")return null;let{typeIdField:n}=r;if(!n||e!==n)return null;let a=r.getFeatureType(t);return a?a.name:null}function Fe({fieldName:e,value:t,graphic:r,layer:n}){if(_(e)||!n||typeof n.getFieldDomain!="function")return null;let a=r&&n.getFieldDomain(e,{feature:r});return a&&a.type==="coded-value"?a.getName(t):null}function Se(e,t,r,n){let{creatorField:a,creationDateField:i,editorField:o,editDateField:s}=e;if(!t)return;let u=v(n&&"preferredTimeZone"in n?n.preferredTimeZone:null,!(!n||!("datesInUnknownTimezone"in n))&&!!n.datesInUnknownTimezone,r,U,"date"),l=d(d({},U),u),f=t[s];if(typeof f=="number"){let y=t[o];return{type:"edit",date:F(f,l),user:y}}let c=t[i];if(typeof c=="number"){let y=t[a];return{type:"create",date:F(c,l),user:y}}return null}function ze(e,t){let r=new Map;if(!e)return r;for(let n of e){if(!n.fieldName)continue;let a=G(n.fieldName,t);n.fieldName=a,r.set(a.toLowerCase(),n)}return r}function Ge(e){let t=[];if(!e)return t;let{fieldInfos:r,content:n}=e;return r&&t.push(...r),n&&Array.isArray(n)&&n.forEach(a=>{if(a.type==="fields"){let i=a?.fieldInfos;i&&t.push(...i)}}),t}function He(e){return e.replaceAll(Y,t=>`&#${t.charCodeAt(0)};`)}function P(e){return typeof e=="string"?e.replaceAll(X,'<br class="esri-text-new-line" />'):e}function Q(e){let{value:t,fieldName:r,fieldInfos:n,fieldInfoMap:a,layer:i,graphic:o,timeZone:s}=e;if(t==null)return"";let u=Fe({fieldName:r,value:t,graphic:o,layer:i});if(u)return u;let l=he({fieldName:r,graphic:o,layer:i});if(l)return l;if(a.get(r.toLowerCase()))return ge(t,{fieldInfos:n||Array.from(a.values()),fieldName:r,layer:i,timeZone:s});let f=i?.fieldsIndex?.get(r);return f&&(q(f)||j(f))?T(t,{fieldType:f.type,timeZoneOptions:{layerTimeZone:i&&"preferredTimeZone"in i?i.preferredTimeZone:null,viewTimeZone:s,datesInUnknownTimezone:!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone}}):P(t)}function Pe({fieldInfos:e,attributes:t,layer:r,graphic:n,fieldInfoMap:a,relatedInfos:i,timeZone:o}){let s={};return i?.forEach(u=>Ne({attributes:s,relatedInfo:u,fieldInfoMap:a,fieldInfos:e,layer:r,timeZone:o})),t&&Object.keys(t).forEach(u=>{let l=t[u];s[u]=Q({fieldName:u,fieldInfos:e,fieldInfoMap:a,layer:r,value:l,graphic:n,timeZone:o})}),s}function Te(e,t){return g(this,null,function*(){let{layer:r,graphic:n,outFields:a,objectIds:i,returnGeometry:o,spatialReference:s}=e,u=i[0];if(typeof u!="number"&&typeof u!="string"){let f="Could not query required fields for the specified feature. The feature's ID is invalid.",c={layer:r,graphic:n,objectId:u,requiredFields:a};return N().warn(f,c),null}if(!R(r)?.operations?.supportsQuery){let f="The specified layer cannot be queried. The following fields will not be available.",c={layer:r,graphic:n,requiredFields:a,returnGeometry:o};return N().warn(f,c),null}let l=r.createQuery();return l.objectIds=i,l.outFields=a?.length?a:[r.objectIdField],l.returnGeometry=!!o,l.returnZ=!!o,l.returnM=!!o,l.outSpatialReference=s,(yield r.queryFeatures(l,t)).features[0]})}function we(e){return g(this,null,function*(){if(!e.expressionInfos?.length)return!1;let t=yield M(),{arcadeUtils:{hasGeometryFunctions:r}}=t;return r(e)})}function Qe(i,o){return g(this,arguments,function*({graphic:e,popupTemplate:t,layer:r,spatialReference:n},a){if(!r||!t||(typeof r.load=="function"&&(yield r.load(a)),!e.attributes))return;let s=r.objectIdField,u=e.attributes[s];if(u==null)return;let l=[u],f=yield t.getRequiredFields(r.fieldsIndex),c=k(f,e),y=c?[]:f.includes(s)?f:[...f,s],Z=t.returnGeometry||(yield we(t));if(c&&!Z)return;let m=yield Te({layer:r,graphic:e,outFields:y,objectIds:l,returnGeometry:Z,spatialReference:n},a);m&&(m.geometry&&(e.geometry=m.geometry),m.attributes&&(e.attributes=d(d({},e.attributes),m.attributes)))})}function _(e=""){return!!e&&e.includes(z)}function Le(e){return e?`${z}${e.layerId}/${e.fieldName}`:""}function D({attributes:e,graphic:t,relatedInfo:r,fieldInfos:n,fieldInfoMap:a,layer:i,timeZone:o}){e&&t&&r&&Object.keys(t.attributes).forEach(s=>{let u=Le({layerId:r.relation.id.toString(),fieldName:s}),l=t.attributes[s];e[u]=Q({fieldName:u,fieldInfos:n,fieldInfoMap:a,layer:i,value:l,graphic:t,timeZone:o})})}function Ne({attributes:e,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a,timeZone:i}){e&&t&&(t.relatedFeatures?.forEach(o=>D({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a,timeZone:i})),t.relatedStatsFeatures?.forEach(o=>D({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a,timeZone:i})))}var $=e=>{if(!e)return!1;let t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},V=({layer:e,method:t,query:r,definitionExpression:n})=>{if(!e.capabilities?.query?.supportsCacheHint||t==="attachments")return;let a=r.where!=null?r.where:null,i=r.geometry!=null?r.geometry:null;$(n)||$(a)||i?.type==="extent"||r.resultType==="tile"||(r.cacheHint=!0)},_e=({query:e,layer:t,method:r})=>{V({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},Ve=({queryPayload:e,layer:t,method:r})=>{V({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})};function Ke(e,t,r){return e&&t&&r?t.type==="sublayer"?p({layers:t.layer?.sublayers,map:e,relatedLayer:t,relationship:r})||p({layers:t.layer?.subtables,map:e,relatedLayer:t,relationship:r}):p({layers:e.allLayers,map:e,relatedLayer:t,relationship:r})||p({layers:e.allTables,map:e,relatedLayer:t,relationship:r}):null}function O(e,t){return e?.allTables.find(r=>r.type==="feature"&&r.layerId===t.id&&r.url===t.layer?.url)}function p({map:e,relationship:t,relationship:{relatedTableId:r},relatedLayer:n,layers:a}){if(!a)return null;for(let i of a){if(i.type==="map-image"){let s=p({layers:i.sublayers,map:e,relatedLayer:n,relationship:t})||p({layers:i.subtables,map:e,relatedLayer:n,relationship:t});if(s)return s;continue}if(!me(i))continue;if(n.type==="sublayer"){if(i!==n&&i.id===r)return i.isTable?O(e,i):i;continue}let o=n.type==="scene"&&n.associatedLayer?n.associatedLayer.url:n.url;if(!o)return null;if(i.type!=="sublayer"){if(i!==n&&i.url===o&&i.layerId===r)return i}else if(i!==n&&i.layer?.url===o&&i.id===r)return i.isTable?O(e,i):i}return null}function Be(e){let t=e.getObjectId();return t!=null?`oid:${t}`:`uid:${e.uid}`}export{je as a,ke as b,Ue as c,re as d,De as e,G as f,$e as g,Oe as h,oe as i,fe as j,me as k,Ie as l,Se as m,ze as n,Ge as o,He as p,P as q,Pe as r,Te as s,Qe as t,_ as u,_e as v,Ve as w,Ke as x,Be as y};
