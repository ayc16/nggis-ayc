import{a as G}from"./chunk-SCUHN3PY.js";import{a as h}from"./chunk-X6RI57FQ.js";import{b as C}from"./chunk-QQQSSCQB.js";import{a as f,b as w,c as O,d as k,e as g,f as I,g as b,h as R,i as E,j as N}from"./chunk-J7FQCMMY.js";import"./chunk-SMUMHGTW.js";import{a as D}from"./chunk-LCUC2WGG.js";import{a as x}from"./chunk-LCEQXLDI.js";import{a as j}from"./chunk-C75DYIHX.js";import{b as P}from"./chunk-TUJ6FPE6.js";import{b as M}from"./chunk-FI6XC3PH.js";import"./chunk-XFK3CDZ5.js";import"./chunk-4XBATNKX.js";import"./chunk-3IJY37BG.js";import"./chunk-ZV7ILGPO.js";import"./chunk-F7PIPM6E.js";import"./chunk-FR6Q4MSQ.js";import"./chunk-C6JT6KYF.js";import"./chunk-BCREO4Q5.js";import"./chunk-6FWNINU2.js";import"./chunk-ES7AH7WX.js";import"./chunk-RSDQHAJX.js";import"./chunk-G3LLBABP.js";import"./chunk-T4B3RN6B.js";import"./chunk-MXADXAOS.js";import"./chunk-RJHITHLB.js";import"./chunk-5TVEQGKJ.js";import{c as J}from"./chunk-U4U366GW.js";import"./chunk-JTJ3UVF7.js";import"./chunk-R4TNLPIN.js";import"./chunk-5HLV7XP5.js";import"./chunk-UI76XBLJ.js";import"./chunk-UE2YGKE7.js";import"./chunk-BE76S5KT.js";import"./chunk-3RDV3O6N.js";import"./chunk-D2ITYHSM.js";import"./chunk-FIITBHDP.js";import"./chunk-VSVNPPHQ.js";import"./chunk-CTGIUUCS.js";import"./chunk-VWEBO6QK.js";import"./chunk-KAAR5ZJN.js";import"./chunk-W3WDPWBE.js";import"./chunk-WKT5W7KT.js";import"./chunk-MLSR6YE6.js";import"./chunk-JPDAKIWT.js";import{r as m}from"./chunk-X3IDZTNG.js";import"./chunk-IQJU4QT3.js";import{h as p}from"./chunk-EAH6BNBL.js";function de(e,a){return p(this,null,function*(){let r=e.instance.portalItem;if(r?.id)return yield r.load(a),H(e),e.validateItem&&e.validateItem(r),Q(e,a)})}function H(e){let a=e.instance.portalItem;if(!a?.type||!e.supportedTypes.includes(a.type))throw new m("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:a?.type,expectedType:e.supportedTypes.join(", ")})}function Q(e,a){return p(this,null,function*(){let r=e.instance,t=r.portalItem;if(!t)return;let{url:o,title:s}=t,n=h(t,"portal-item");if(r.type==="group")return U(r,n,e);o&&r.type!=="media"&&r.read({url:o},n);let l=new f,i=yield A(e,l,a);return i&&r.read(i,n),r.resourceReferences={portalItem:t,paths:n.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:s},n),x(r,n)})}function U(e,a,r){return p(this,null,function*(){let t=e.portalItem;if(!e.sourceIsPortalItem)return;let{title:o,type:s}=t;if(s==="Group Layer"){if(!P(t,"Map"))throw new m("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return V(e)}return e.read({title:o},a),W(e,r)})}function V(e){return p(this,null,function*(){let a=e.portalItem,r=yield a.fetchData("json");if(!r)return;let t=h(a,"web-map");e.read(r,t),yield C(e,r,{context:t}),e.resourceReferences={portalItem:a,paths:t.readResourcePaths??[]}})}function W(e,a){return p(this,null,function*(){let r,{portalItem:t}=e;if(!t)return;let o=t.type,s=a.layerModuleTypeMap;switch(o){case"Feature Service":case"Feature Collection":r=s.FeatureLayer;break;case"Stream Service":r=s.StreamLayer;break;case"Scene Service":r=s.SceneLayer;break;default:throw new m("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}let n=new f,[l,i]=yield Promise.all([r(),A(a,n)]),c=()=>l;if(o==="Feature Service"){let K=g(i)?.customParameters;i=t.url?yield O(i,t.url,n):{};let S=b(i),T=R(i),q=E(i),y=[];if(S.length||T?.length){S.length&&y.push("SubtypeGroupLayer"),T?.length&&y.push("OrientedImageryLayer"),q?.length&&y.push("CatalogLayer");let v=[];for(let u of y){let d=s[u];v.push(d())}let B=yield Promise.all(v),F=new Map;y.forEach((u,d)=>{F.set(u,B[d])}),c=u=>u.layerType?F.get(u.layerType)??l:l}let z=yield te(t.url,{customParameters:K,loadContext:n});return yield L(e,c,i,z)}return o==="Scene Service"&&t.url&&(i=yield N(t,i,n)),I(i)>0?yield L(e,c,i):yield X(e,c)})}function X(e,a){return p(this,null,function*(){let{portalItem:r}=e;if(!r?.url)return;let t=yield D(r.url);t&&L(e,a,{layers:t.layers?.map(w),tables:t.tables?.map(w)})})}function L(e,a,r,t){return p(this,null,function*(){let o=r.layers||[],s=r.tables||[];if(e.portalItem?.type==="Feature Collection"?(o.forEach((n,l)=>{n.id=l,n?.layerDefinition?.type==="Table"&&s.push(n)}),o=o.filter(n=>n?.layerDefinition?.type!=="Table")):(o.reverse(),s.reverse()),o.forEach(n=>{let l=t?.(n);if(l||!t){let i=$(e,a(n),r,n,l);e.add(i)}}),s.length){let n=yield j.FeatureLayer();s.forEach(l=>{let i=t?.(l);if(i||!t){let c=$(e,n,r,l,i);e.tables.add(c)}})}})}function $(e,a,r,t,o){let s=e.portalItem,n={portalItem:s.clone(),layerId:t.id};t.url!=null&&(n.url=t.url);let l=new a(n);if("sourceJSON"in l&&(l.sourceJSON=o),l.type!=="subtype-group"&&l.type!=="catalog"&&(l.sublayerTitleMode="service-name"),s.type==="Feature Collection"){let i={origin:"portal-item",portal:s.portal||J.getDefault()};l.read(t,i);let c=r.showLegend;c!=null&&l.read({showLegend:c},i)}return l}function A(e,a,r){return p(this,null,function*(){if(e.supportsData===!1)return;let t=e.instance,o=t.portalItem;if(!o)return;let s=null;try{s=yield o.fetchData("json",r)}catch{}if(_(t)){let n=null,l=yield Y(o,s,a);if((s?.layers||s?.tables)&&l>0){if(t.layerId==null){let i=b(s);t.layerId=t.type==="subtype-group"?i?.[0]:k(s)}n=Z(s,t),n&&s.showLegend!=null&&(n.showLegend=s.showLegend)}return l>1&&"sublayerTitleMode"in t&&t.sublayerTitleMode!=="service-name"&&(t.sublayerTitleMode="item-title-and-service-name"),n}return s})}function Y(e,a,r){return p(this,null,function*(){if(a?.layers&&a?.tables)return I(a);let t=M(e.url);if(!t)return 1;let o=yield r.fetchServiceMetadata(t.url.path,{customParameters:g(a)?.customParameters}).catch(()=>null);return(a?.layers?.length??o?.layers?.length??0)+(a?.tables?.length??o?.tables?.length??0)})}function Z(e,a){let{layerId:r}=a,t=e.layers?.find(o=>o.id===r)||e.tables?.find(o=>o.id===r);return t&&ee(t,a)?t:null}function _(e){return e.type!=="stream"&&"layerId"in e}function ee(e,a){return!(a.type==="feature"&&"layerType"in e&&e.layerType==="SubtypeGroupLayer"||a.type==="subtype-group"&&!("layerType"in e))}function te(e,a){return p(this,null,function*(){let{layersJSON:r}=yield G(e,a);if(!r)return null;let t=[...r.layers,...r.tables];return o=>t.find(s=>s.id===o.id)})}export{de as load};
