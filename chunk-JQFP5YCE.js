import{a as _}from"./chunk-ZOL2XRTU.js";import{a as R,b as V}from"./chunk-ZISGARXA.js";import{b as I}from"./chunk-YINO7Z5Z.js";import{c as h,d as x}from"./chunk-7EQBH2NW.js";import{f as Q}from"./chunk-CPR27CS2.js";import{a as N}from"./chunk-FXKKVZVX.js";import{d as f}from"./chunk-UVZRJ2I3.js";import{b as y}from"./chunk-NFADXGWT.js";import{b as d}from"./chunk-DR5D3NPO.js";import{t as w}from"./chunk-UI76XBLJ.js";import{g as O}from"./chunk-CTGIUUCS.js";import{F as u,I as g}from"./chunk-VWEBO6QK.js";import{S as D}from"./chunk-KAAR5ZJN.js";import{a as n}from"./chunk-W3WDPWBE.js";import{o as l}from"./chunk-WKT5W7KT.js";import{r as b}from"./chunk-X3IDZTNG.js";import{a as S}from"./chunk-IQJU4QT3.js";import{a as F,h as s}from"./chunk-EAH6BNBL.js";function j(r,t,e){return s(this,null,function*(){let o=d(r),c=yield Q(o,f.from(t),F({},e)),i=c.data.extent;return!i||isNaN(i.xmin)||isNaN(i.ymin)||isNaN(i.xmax)||isNaN(i.ymax)?{count:c.data.count,extent:null}:{count:c.data.count,extent:w.fromJSON(i)}})}var a=class extends g{constructor(r){super(r),this.dynamicDataSource=null,this.fieldsIndex=null,this.gdbVersion=null,this.infoFor3D=null,this.pbfSupported=!1,this.queryAttachmentsSupported=!1,this.sourceSpatialReference=null,this.url=null}get parsedUrl(){return O(this.url)}execute(r,t){return s(this,null,function*(){let e=yield this.executeJSON(r,t);return this.featureSetFromJSON(r,e,t)})}executeJSON(r,t){return s(this,null,function*(){let e=this._normalizeQuery(r),o=r.outStatistics?.[0]!=null,c=S("featurelayer-pbf-statistics"),i=!o||c,p;if(this.pbfSupported&&i)try{p=yield _(this.url,e,t)}catch(m){if(m.name!=="query:parsing-pbf")throw m;this.pbfSupported=!1}return this.pbfSupported&&i||(p=yield I(this.url,e,t)),this._normalizeFields(p.fields),p})}featureSetFromJSON(r,t,e){return s(this,null,function*(){if(!this._queryIs3DObjectFormat(r)||this.infoFor3D==null||!t.features)return N.fromJSON(t);let{meshFeatureSetFromJSON:o}=yield l(import("./chunk-IIER7QVF.js"),e);return o(r,this.infoFor3D,t)})}executeForCount(r,t){return R(this.url,this._normalizeQuery(r),t)}executeForExtent(r,t){return j(this.url,this._normalizeQuery(r),t)}executeForIds(r,t){return V(this.url,this._normalizeQuery(r),t)}executeRelationshipQuery(r,t){return s(this,null,function*(){let[{default:e},{executeRelationshipQuery:o}]=yield l(Promise.all([import("./chunk-3D34BF6L.js"),import("./chunk-5NXW6NTW.js")]),t);return r=e.from(r),(this.gdbVersion||this.dynamicDataSource)&&((r=r.clone()).gdbVersion=r.gdbVersion||this.gdbVersion,r.dynamicDataSource=r.dynamicDataSource||this.dynamicDataSource),o(this.url,r,t)})}executeRelationshipQueryForCount(r,t){return s(this,null,function*(){let[{default:e},{executeRelationshipQueryForCount:o}]=yield l(Promise.all([import("./chunk-3D34BF6L.js"),import("./chunk-5NXW6NTW.js")]),t);return r=e.from(r),(this.gdbVersion||this.dynamicDataSource)&&((r=r.clone()).gdbVersion=r.gdbVersion||this.gdbVersion,r.dynamicDataSource=r.dynamicDataSource||this.dynamicDataSource),o(this.url,r,t)})}executeAttachmentQuery(r,t){return s(this,null,function*(){let{executeAttachmentQuery:e,fetchAttachments:o,processAttachmentQueryResult:c}=yield l(import("./chunk-TLIKO6QJ.js"),t),i=d(this.url);return c(i,yield this.queryAttachmentsSupported?e(i,r,t):o(i,r,t))})}executeTopFeaturesQuery(r,t){return s(this,null,function*(){let{executeTopFeaturesQuery:e}=yield l(import("./chunk-JZ4G6W4H.js"),t);return e(this.parsedUrl,r,this.sourceSpatialReference,t)})}executeForTopIds(r,t){return s(this,null,function*(){let{executeForTopIds:e}=yield l(import("./chunk-YOIPJVJL.js"),t);return e(this.parsedUrl,r,t)})}executeForTopExtents(r,t){return s(this,null,function*(){let{executeForTopExtents:e}=yield l(import("./chunk-WHMEZAC3.js"),t);return e(this.parsedUrl,r,t)})}executeForTopCount(r,t){return s(this,null,function*(){let{executeForTopCount:e}=yield l(import("./chunk-JY2MCOLU.js"),t);return e(this.parsedUrl,r,t)})}_normalizeQuery(r){let t=f.from(r);t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(t=t===r?t.clone():t,t.gdbVersion=r.gdbVersion||this.gdbVersion,t.dynamicDataSource=r.dynamicDataSource?y.from(r.dynamicDataSource):this.dynamicDataSource);let{infoFor3D:e}=this;if(e!=null&&this._queryIs3DObjectFormat(r)){t=t===r?t.clone():t,t.formatOf3DObjects=null;let{supportedFormats:o,queryFormats:c}=e,i=h("model/gltf-binary",o)??x("glb",o),p=h("model/gltf+json",o)??x("gltf",o);for(let m of c){if(m===i){t.formatOf3DObjects=m;break}m!==p||t.formatOf3DObjects||(t.formatOf3DObjects=m)}if(!t.formatOf3DObjects)throw new b("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(t.outFields==null||!t.outFields.includes("*")){t=t===r?t.clone():t,t.outFields==null&&(t.outFields=[]);let{originX:m,originY:q,originZ:T,translationX:J,translationY:v,translationZ:A,scaleX:U,scaleY:z,scaleZ:C,rotationX:E,rotationY:X,rotationZ:Y,rotationDeg:Z}=e.transformFieldRoles;t.outFields.push(m,q,T,J,v,A,U,z,C,E,X,Y,Z)}}return t}_normalizeFields(r){if(this.fieldsIndex!=null&&r!=null)for(let t of r){let e=this.fieldsIndex.get(t.name);e&&Object.assign(t,e.toJSON())}}_queryIs3DObjectFormat(r){return this.infoFor3D!=null&&r.returnGeometry===!0&&r.multipatchOption!=="xyFootprint"&&!r.outStatistics}};n([u({type:y})],a.prototype,"dynamicDataSource",void 0),n([u()],a.prototype,"fieldsIndex",void 0),n([u()],a.prototype,"gdbVersion",void 0),n([u()],a.prototype,"infoFor3D",void 0),n([u({readOnly:!0})],a.prototype,"parsedUrl",null),n([u()],a.prototype,"pbfSupported",void 0),n([u()],a.prototype,"queryAttachmentsSupported",void 0),n([u()],a.prototype,"sourceSpatialReference",void 0),n([u({type:String})],a.prototype,"url",void 0),a=n([D("esri.tasks.QueryTask")],a);var xt=a;export{xt as a};
