import{a as H}from"./chunk-A2WF4NJX.js";import{R,S as T,V as x}from"./chunk-CTGIUUCS.js";import{a as I,b as J,e as j,g,h as A,j as W,m as C,p as b,w as y,z as L}from"./chunk-WKT5W7KT.js";import{d}from"./chunk-MLSR6YE6.js";import{r as E}from"./chunk-X3IDZTNG.js";import{a as P}from"./chunk-IQJU4QT3.js";import{h as N}from"./chunk-EAH6BNBL.js";var Q=new FinalizationRegistry(s=>{s.close()});function oe(s,e){Q.register(s,e,e)}function B(s){Q.unregister(s)}var O="worker:port-closed",c;(function(s){s[s.HANDSHAKE=0]="HANDSHAKE",s[s.OPEN=1]="OPEN",s[s.OPENED=2]="OPENED",s[s.RESPONSE=3]="RESPONSE",s[s.INVOKE=4]="INVOKE",s[s.ABORT=5]="ABORT",s[s.CLOSE=6]="CLOSE",s[s.OPEN_PORT=7]="OPEN_PORT",s[s.ON=8]="ON"})(c||(c={}));var X=0;function V(){return X++}function Y(s){return s&&typeof s=="object"&&("result"in s||"transferList"in s)}function k(s){return s?typeof s=="string"?JSON.stringify({name:"message",message:s}):s.toJSON?JSON.stringify(s):JSON.stringify({name:s.name,message:s.message,details:s.details||{stack:s.stack}}):null}function M(s,e,t,o){if(e.type===c.OPEN_PORT)return void s.postMessage(e,[e.port]);if(e.type!==c.INVOKE&&e.type!==c.RESPONSE)return void s.postMessage(e);let r;if(Y(t)?(r=D(t.transferList),e.data=t.result):(r=D(o),e.data=t),r){if(P("ff")){for(let n of r)if("byteLength"in n&&n.byteLength>267386880){let i="Worker call with large ArrayBuffer would crash Firefox";switch(e.type){case c.INVOKE:throw i;case c.RESPONSE:return void M(s,{type:c.RESPONSE,jobId:e.jobId,error:k(i)})}}}s.postMessage(e,r)}else s.postMessage(e)}function S(s){if(!s)return null;let e=s.data;return e?typeof e=="string"?JSON.parse(e):e:null}function D(s){if(!s?.length)return null;if(P("esri-workers-arraybuffer-transfer"))return s;let e=s.filter(t=>!Z(t));return e.length?e:null}function Z(s){return s instanceof ArrayBuffer||s?.constructor?.name==="ArrayBuffer"}function K(s){return N(this,null,function*(){try{return yield s}catch(e){let t=e?.name===O;if(!(b(e)||t))throw e;return}})}function v(s,e,t){return new Proxy({},{get:(o,r,n)=>(...i)=>{let a,l,h=i[i.length-1];ee(h)&&(a=h.signal,l=h.transferList,i.pop());let u=s.apply(e?`${e}.${r.toString()}`:r.toString(),i,{transferList:l,signal:a});return t?.ignoreConnectionErrors?K(u):u}})}function ee(s){return typeof s=="object"&&!Array.isArray(s)&&s!=null&&("signal"in s||"transferList"in s||Object.keys(s).length===0)}var $={statsWorker:()=>import("./chunk-XKJLKJZZ.js"),geometryEngineWorker:()=>import("./chunk-GIFMPHQ4.js"),CSVSourceWorker:()=>import("./chunk-EA5OXG26.js"),EdgeProcessingWorker:()=>import("./chunk-BGKRAKWJ.js"),ElevationSamplerWorker:()=>import("./chunk-5SWTVUZ2.js"),FeatureServiceSnappingSourceWorker:()=>import("./chunk-LTV6XD2I.js"),GeoJSONSourceWorker:()=>import("./chunk-JAE3AB6A.js"),LercWorker:()=>import("./chunk-GBGRN74O.js"),MemorySourceWorker:()=>import("./chunk-W77ENIDJ.js"),PBFDecoderWorker:()=>import("./chunk-ASMR2ORO.js"),FeaturePipelineWorker:()=>import("./chunk-OMOP4EYE.js"),PointCloudWorker:()=>import("./chunk-AXLHVYDF.js"),RasterWorker:()=>import("./chunk-BPFSX6UD.js"),SceneLayerSnappingSourceWorker:()=>import("./chunk-CHT52ZML.js"),SceneLayerWorker:()=>import("./chunk-EBTH6AHI.js"),WFSSourceWorker:()=>import("./chunk-AYQJF3KG.js"),WorkerTileHandler:()=>import("./chunk-LSEV7QWC.js"),Lyr3DWorker:()=>import("./chunk-OIOIW5ZT.js")};var{CLOSE:F,ABORT:z,INVOKE:U,RESPONSE:_,OPEN_PORT:G,ON:te}=c,se=2,w=class{constructor(e){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=e,this._timer=null,this._process=this._process.bind(this)}push(e){e.type===c.ABORT?this._cancelledJobIds.add(e.jobId):(this._invokeMessages.push(e),this._timer===null&&(this._timer=setTimeout(this._process,0)))}clear(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null}_process(){this._timer=null;for(let e of this._invokeMessages)this._cancelledJobIds.has(e.jobId)||this._invoke(e);this._cancelledJobIds.clear(),this._invokeMessages.length=0}},m=class s{static connect(e){let t=new MessageChannel,o;o=typeof e=="function"?new e:"default"in e&&typeof e.default=="function"?new e.default:e;let r=new s(t.port1,{channel:t,client:o});return typeof o=="object"&&"remoteClient"in o&&(o.remoteClient=r),s.clients.set(r,o),t.port2}static loadWorker(e){let t=$[e];return t?t():Promise.resolve(null)}constructor(e,t,o){this._port=e,this._jobQueue=o,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new w(r=>this._onInvokeMessage(r)),this._client=t.client,this._onMessage=this._onMessage.bind(this),this._channel=t.channel,this._schedule=t.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}close(){this._post({type:F}),this._close()}isBusy(){return this._outJobs.size>0}invoke(e,t,o){return this.apply(e,[t],o)}apply(e,t,o){let r=o?.signal,n=o?.transferList;if(!this._port)return Promise.reject(new E(O,`Cannot call invoke('${e}'), port is closed`,{methodName:e,data:t}));let i=V();return new Promise((a,l)=>{if(W(r))return this._processWork(),void l(g());let h=C(r,()=>{let p=this._outJobs.get(i);p&&(this._outJobs.delete(i),this._processWork(),d(p.abortHandle),this._post({type:z,jobId:i}),l(g()))}),u={resolve:a,reject:l,abortHandle:h,debugInfo:e};this._outJobs.set(i,u),this._post({type:U,jobId:i,methodName:e,abortable:r!=null},t,n)})}createInvokeProxy(e,t){return v(this,e,t)}on(e,t){let o=new MessageChannel;function r(n){t(n.data)}return this._port.postMessage({type:c.ON,eventType:e,port:o.port2},[o.port2]),o.port1.addEventListener("message",r),o.port1.start(),I(()=>{o.port1.postMessage({type:c.CLOSE}),o.port1.close(),o.port1.removeEventListener("message",r)})}jobAdded(){this._processWork()}openPort(){let e=new MessageChannel;return this._post({type:G,port:e.port2}),e.port1}_processWork(){if(this._outJobs.size>=se)return;let e=this._jobQueue?.pop();if(!e)return;let{methodName:t,data:o,invokeOptions:r,resolver:n}=e;this.apply(t,o,r).then(i=>n.resolve(i)).catch(i=>n.reject(i))}_close(){this._channel&&(this._channel=void 0),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach(e=>{d(e.abortHandle),e.reject(g(`Worker closing, aborting job calling '${e.debugInfo}'`))}),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=null,this._client=null,this._schedule=null}_onMessage(e){this._schedule!=null?this._schedule(()=>this._processMessage(e)):this._processMessage(e)}_processMessage(e){let t=S(e);if(t)switch(t.type){case _:this._onResponseMessage(t);break;case U:this._invokeQueue.push(t);break;case z:this._onAbortMessage(t);break;case F:this._onCloseMessage();break;case G:this._onOpenPortMessage(t);break;case te:this._onOnMessage(t)}}_onAbortMessage(e){let t=this._inJobs,o=e.jobId,r=t.get(o);this._invokeQueue.push(e),r&&(r.controller&&r.controller.abort(),t.delete(o))}_onCloseMessage(){let e=this._client;this._close(),e&&"destroy"in e&&s.clients.get(this)===e&&e.destroy(),s.clients.delete(this),e?.remoteClient&&(e.remoteClient=null)}_onInvokeMessage(e){let{methodName:t,jobId:o,data:r=[],abortable:n}=e,i=n?new AbortController:null,a=this._inJobs,l,h=this._client,u=h[t];try{if(!u&&t&&t.includes(".")){let p=t.split(".");for(let f=0;f<p.length-1;f++)h=h[p[f]],u=h[p[f+1]]}if(typeof u!="function")throw new TypeError(`${t} is not a function`);r.push({client:this,signal:i?i.signal:null}),l=u.apply(h,r)}catch(p){return void this._post({type:_,jobId:o,error:k(p)})}y(l)?(a.set(o,{controller:i,promise:l}),l.then(p=>{a.has(o)&&(a.delete(o),this._post({type:_,jobId:o},p))},p=>{a.has(o)&&(a.delete(o),b(p)||this._post({type:_,jobId:o,error:k(p||{message:`Error encountered at method ${t}`})}))})):this._post({type:_,jobId:o},l)}_onOpenPortMessage(e){new s(e.port,{client:this._client})}_onOnMessage(e){let{port:t}=e,o=this._client.on(e.eventType,n=>{t.postMessage(n)}),r=j(e.port,"message",n=>{S(n)?.type===c.CLOSE&&(r.remove(),o.remove(),t.close())})}_onResponseMessage(e){let{jobId:t,error:o,data:r}=e,n=this._outJobs;if(!n.has(t))return;let i=n.get(t);n.delete(t),this._processWork(),d(i.abortHandle),o?i.reject(E.fromJSON(JSON.parse(o))):i.resolve(r)}_post(e,t,o){return M(this._port,e,t,o)}};m.kernelInfo={buildDate:R,fullVersion:x,revision:T},m.clients=new Map;var q=class{constructor(){this._inUseClients=new Array,this._clients=new Array,this._clientPromises=new Array,this._ongoingJobsQueue=new H}destroy(){this.close()}get closed(){return!this._clients?.length}open(e,t){return new Promise((o,r)=>{let n=!0,i=a=>{A(t.signal),n&&(n=!1,a())};this._clients.length=e.length,this._clientPromises.length=e.length,this._inUseClients.length=e.length;for(let a=0;a<e.length;++a){let l=e[a];y(l)?this._clientPromises[a]=l.then(h=>(this._clients[a]=new m(h,t,this._ongoingJobsQueue),i(o),this._clients[a]),()=>(i(r),null)):(this._clients[a]=new m(l,t,this._ongoingJobsQueue),this._clientPromises[a]=Promise.resolve(this._clients[a]),i(o))}})}broadcast(e,t,o){let r=new Array(this._clientPromises.length);for(let n=0;n<this._clientPromises.length;++n){let i=this._clientPromises[n];r[n]=i.then(a=>a?.invoke(e,t,o))}return r}close(){let e;for(;e=this._ongoingJobsQueue.pop();)e.resolver.reject(g(`Worker closing, aborting job calling '${e.methodName}'`));for(let t of this._clientPromises)t.then(o=>o?.close());this._clients.length=0,this._clientPromises.length=0,this._inUseClients.length=0,B(this)}invoke(e,t,o){return this.apply(e,[t],o)}apply(e,t,o){let r=L();this._ongoingJobsQueue.push({methodName:e,data:t,invokeOptions:o,resolver:r});for(let n=0;n<this._clientPromises.length;n++){let i=this._clients[n];i?i.jobAdded():this._clientPromises[n].then(a=>a?.jobAdded())}return r.promise}createInvokeProxy(e){return v(this,e)}on(e,t){return Promise.all(this._clientPromises).then(()=>J(this._clients.map(o=>o.on(e,t))))}openPorts(){return new Promise(e=>{let t=new Array(this._clientPromises.length),o=t.length;for(let r=0;r<this._clientPromises.length;++r)this._clientPromises[r].then(n=>{n&&(t[r]=n.openPort()),--o==0&&e(t)})})}get test(){return{numClients:this._clients.length}}};export{oe as a,c as b,V as c,k as d,M as e,S as f,m as g,q as h};
