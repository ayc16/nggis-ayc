import{E as $t,H as Kt,J as Xt,K as er,e as ge,f as kt,g as Ut,i as qt,k as zt,l as Gt,m as jt,o as Wt,r as Te,t as Ht}from"./chunk-7E3X25PE.js";import{c as xe,d as rr}from"./chunk-PJBIIWFF.js";import{a as At}from"./chunk-R5K6EMED.js";import{a as Ct}from"./chunk-FVCUBGKZ.js";import{b as sr}from"./chunk-NGKFFCVN.js";import{b as tr}from"./chunk-SLXUZRWI.js";import{b as B}from"./chunk-LCQ5TU4N.js";import{b as Qt,c as Zt}from"./chunk-LCBWJNVO.js";import{a as ye,b as Yt,c as Jt}from"./chunk-JAXR3ZUJ.js";import{a as $,e as Dt,g as z}from"./chunk-XN46SLSO.js";import{b as n}from"./chunk-XSJRPCD6.js";import{d as _t,h as Et,k as It,l as Bt}from"./chunk-3DDJTCET.js";import{a as Q}from"./chunk-UDMTFKLM.js";import{d as Nt,e as Vt,f as Ft,g as Lt}from"./chunk-AW3LMT4V.js";import{b as D}from"./chunk-ELGDZDOQ.js";import{a as A,c as de,d as fe}from"./chunk-DOFADBK3.js";import{b as k}from"./chunk-KUOODJRB.js";import{b as Mt,e as St,h as wt,j as Ot,k as Rt,l as Pt}from"./chunk-DLJEBXJT.js";import{b as he}from"./chunk-4HCGCIRX.js";import{a as S,b as L,g as b}from"./chunk-OW7DVBQB.js";import{b as ct,d as re}from"./chunk-TIXZ4OWB.js";import{a as T}from"./chunk-UVJ5D37D.js";import{i as Ie,l as Be,x as mt}from"./chunk-ZAQLF7TN.js";import{d as pt}from"./chunk-ZHUHFKYD.js";import{b as Tt,e as Le}from"./chunk-OB5UG54O.js";import{b as gt,d as xt,f as Ve,i as Fe}from"./chunk-Z6XPPWSB.js";import{c as _e,d as at,o as it,p as Ee,s as nt,t as lt}from"./chunk-I3DWOIS7.js";import{c as yt,d as vt}from"./chunk-37H4LYIE.js";import{a as se}from"./chunk-XHOTVM3O.js";import{a as ke}from"./chunk-NJ5QXHI6.js";import{b as bt}from"./chunk-LHY2TOIB.js";import{f as H,x as ce}from"./chunk-R4NNYEN7.js";import{f as ut}from"./chunk-PDBA6QOJ.js";import{a as ht,g as Ne,o as dt}from"./chunk-CF52RSJZ.js";import{a as ft}from"./chunk-ALWV3RJ2.js";import{a as me,b as pe}from"./chunk-7C6Z24SS.js";import{c as ot}from"./chunk-M2GLXRA2.js";import{f as st}from"./chunk-EBWCXIFH.js";import{o as De}from"./chunk-76YVRX2R.js";import{B as rt,a as le,b as Ke,c as Re,e as W,g as Pe,l as Ce,s as ue,t as Xe,v as et,w as Ae,x as tt}from"./chunk-OZF6BMOL.js";import{a as M,c as j,d as te,e as Je}from"./chunk-GJP6PTKT.js";import{c as Oe}from"./chunk-JOSG37QF.js";import{aa as Ye}from"./chunk-XPCG2OJX.js";import{a as i}from"./chunk-W3WDPWBE.js";import{n as we}from"./chunk-GISCFF3Z.js";import{r as Qe,t as Ze}from"./chunk-HQMV3KQV.js";import{a as He,t as $e}from"./chunk-CRMMDK2Z.js";import{a as F,b as ne,h as q}from"./chunk-EAH6BNBL.js";function Z(r){if(r==null)return null;let e=r.offset!=null?r.offset:yt,t=r.rotation!=null?r.rotation:0,s=r.scale!=null?r.scale:vt,m=pe(1,0,0,0,1,0,e[0],e[1],1),c=pe(Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1),u=pe(s[0],0,0,0,s[1],0,0,0,1),p=me();return Ne(p,c,u),Ne(p,m,p),p}var Ue=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},ve=class{constructor(e,t,s){this.name=e,this.lodThreshold=t,this.pivotOffset=s,this.stageResources=new Ue,this.numberOfVertices=0}};function or({normalTexture:r,metallicRoughnessTexture:e,metallicFactor:t,roughnessFactor:s,emissiveTexture:m,emissiveFactor:c,occlusionTexture:u}){return r==null&&e==null&&m==null&&(c==null||rt(c,Je))&&u==null&&(s==null||s===1)&&(t==null||t===1)}var be=[1,1,.5],ar=[0,.6,.2],ir=[0,1,.2];var Me=class extends Qt{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=te(be),this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=S.Back,this.isInstanced=!1,this.hasInstancedColor=!1,this.emissiveFactor=j(0,0,0),this.instancedDoublePrecision=!1,this.normalType=D.Attribute,this.receiveShadows=!0,this.receiveAmbientOcclusion=!0,this.castShadows=!0,this.shadowMappingEnabled=!1,this.ambient=j(.2,.2,.2),this.diffuse=j(.8,.8,.8),this.externalColor=ot(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=M(),this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.offsetTransparentBackfaces=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.modelTransformation=null,this.transparent=!1,this.writeDepth=!0,this.customDepthTest=L.Less,this.textureAlphaMode=b.Blend,this.textureAlphaCutoff=.1,this.textureAlphaPremultiplied=!1,this.hasOccludees=!1,this.renderOccluded=Bt.Occlude,this.isDecoration=!1}},nr=class extends Zt{constructor(){super(...arguments),this.origin=M(),this.slicePlaneLocalOrigin=this.origin}},G=class r extends Yt{initializeConfiguration(e,t){t.spherical=e.viewingMode===se.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result,t.textureCoordinateType=t.hasColorTexture||t.hasMetallicRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture||t.hasNormalTexture?$.Default:$.None,t.objectAndLayerIdColorInstanced=t.instanced}initializeProgram(e){return this._initializeProgram(e,r.shader)}_initializeProgram(e,t){return new Jt(e.rctx,t.get().build(this.configuration),_t)}_makePipeline(e,t){let s=this.configuration,m=e===Q.NONE,c=e===Q.FrontFace;return Lt({blending:s.output===A.Color&&s.transparent?m?kt:Ut(e):null,culling:gr(s)?Nt(s.cullFace):null,depthTest:{func:Gt(e,fr(s.customDepthTest))},depthWrite:(m||c)&&s.writeDepth?Vt:null,drawBuffers:s.output===A.Depth?{buffers:[mt.NONE]}:jt(e),colorWrite:Ft,stencilWrite:s.hasOccludees?Kt:null,stencilTest:s.hasOccludees?t?er:Xt:null,polygonOffset:m||c?null:zt(s.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._makePipeline(this.configuration.transparencyPassType,!0),this._makePipeline(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}};function fr(r){return r===L.Lequal?Ie.LEQUAL:Ie.LESS}function gr(r){return r.cullFace!==S.None||!r.hasSlicePlane&&!r.transparent&&!r.doubleSidedMode}G.shader=new ye(tr,()=>import("./chunk-45DPZFTD.js"));var a=class extends rr{constructor(){super(...arguments),this.output=A.Color,this.alphaDiscardMode=b.Opaque,this.doubleSidedMode=B.None,this.pbrMode=z.Disabled,this.cullFace=S.None,this.transparencyPassType=Q.NONE,this.normalType=D.Attribute,this.textureCoordinateType=$.None,this.customDepthTest=L.Less,this.spherical=!1,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.vvSize=!1,this.vvColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instanced=!1,this.instancedColor=!1,this.objectAndLayerIdColorInstanced=!1,this.instancedDoublePrecision=!1,this.doublePrecisionRequiresObfuscation=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.cullAboveGround=!1,this.snowCover=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1}};i([n({count:A.COUNT})],a.prototype,"output",void 0),i([n({count:b.COUNT})],a.prototype,"alphaDiscardMode",void 0),i([n({count:B.COUNT})],a.prototype,"doubleSidedMode",void 0),i([n({count:z.COUNT})],a.prototype,"pbrMode",void 0),i([n({count:S.COUNT})],a.prototype,"cullFace",void 0),i([n({count:Q.COUNT})],a.prototype,"transparencyPassType",void 0),i([n({count:D.COUNT})],a.prototype,"normalType",void 0),i([n({count:$.COUNT})],a.prototype,"textureCoordinateType",void 0),i([n({count:L.COUNT})],a.prototype,"customDepthTest",void 0),i([n()],a.prototype,"spherical",void 0),i([n()],a.prototype,"hasVertexColors",void 0),i([n()],a.prototype,"hasSymbolColors",void 0),i([n()],a.prototype,"hasVerticalOffset",void 0),i([n()],a.prototype,"hasSlicePlane",void 0),i([n()],a.prototype,"hasSliceHighlight",void 0),i([n()],a.prototype,"hasColorTexture",void 0),i([n()],a.prototype,"hasMetallicRoughnessTexture",void 0),i([n()],a.prototype,"hasEmissionTexture",void 0),i([n()],a.prototype,"hasOcclusionTexture",void 0),i([n()],a.prototype,"hasNormalTexture",void 0),i([n()],a.prototype,"hasScreenSizePerspective",void 0),i([n()],a.prototype,"hasVertexTangents",void 0),i([n()],a.prototype,"hasOccludees",void 0),i([n()],a.prototype,"multipassEnabled",void 0),i([n()],a.prototype,"hasModelTransformation",void 0),i([n()],a.prototype,"offsetBackfaces",void 0),i([n()],a.prototype,"vvSize",void 0),i([n()],a.prototype,"vvColor",void 0),i([n()],a.prototype,"receiveShadows",void 0),i([n()],a.prototype,"receiveAmbientOcclusion",void 0),i([n()],a.prototype,"textureAlphaPremultiplied",void 0),i([n()],a.prototype,"instanced",void 0),i([n()],a.prototype,"instancedColor",void 0),i([n()],a.prototype,"objectAndLayerIdColorInstanced",void 0),i([n()],a.prototype,"instancedDoublePrecision",void 0),i([n()],a.prototype,"doublePrecisionRequiresObfuscation",void 0),i([n()],a.prototype,"writeDepth",void 0),i([n()],a.prototype,"transparent",void 0),i([n()],a.prototype,"enableOffset",void 0),i([n()],a.prototype,"cullAboveGround",void 0),i([n()],a.prototype,"snowCover",void 0),i([n()],a.prototype,"hasColorTextureTransform",void 0),i([n()],a.prototype,"hasEmissionTextureTransform",void 0),i([n()],a.prototype,"hasNormalTextureTransform",void 0),i([n()],a.prototype,"hasOcclusionTextureTransform",void 0),i([n()],a.prototype,"hasMetallicRoughnessTextureTransform",void 0),i([n({constValue:!1})],a.prototype,"occlusionPass",void 0),i([n({constValue:!0})],a.prototype,"hasVvInstancing",void 0),i([n({constValue:!1})],a.prototype,"useCustomDTRExponentForWater",void 0),i([n({constValue:!1})],a.prototype,"supportsTextureAtlas",void 0),i([n({constValue:!0})],a.prototype,"useFillLights",void 0);var oe=class r extends G{initializeConfiguration(e,t){super.initializeConfiguration(e,t),t.hasMetallicRoughnessTexture=!1,t.hasEmissionTexture=!1,t.hasOcclusionTexture=!1,t.hasNormalTexture=!1,t.hasModelTransformation=!1,t.normalType=D.Attribute,t.doubleSidedMode=B.WindingOrder,t.hasVertexTangents=!1}initializeProgram(e){return this._initializeProgram(e,r.shader)}};oe.shader=new ye(sr,()=>import("./chunk-RXDV55MJ.js"));var U=class extends It{constructor(e){super(e,xr),this.supportsEdges=!0,this.produces=new Map([[Te.OPAQUE_MATERIAL,t=>(fe(t)||de(t))&&!this.parameters.transparent],[Te.TRANSPARENT_MATERIAL,t=>(fe(t)||de(t))&&this.parameters.transparent&&this.parameters.writeDepth],[Te.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,t=>(fe(t)||de(t))&&this.parameters.transparent&&!this.parameters.writeDepth]]),this._configuration=new a,this._vertexBufferLayout=Tr(this.parameters)}isVisibleForOutput(e){return e!==A.Shadow&&e!==A.ShadowExcludeHighlight&&e!==A.ShadowHighlight||this.parameters.castShadows}isVisible(){let e=this.parameters;if(!super.isVisible()||e.layerOpacity===0)return!1;let{hasInstancedColor:t,hasVertexColors:s,hasSymbolColors:m,vvColor:c}=e,u=e.colorMixMode==="replace",p=e.opacity>0,o=e.externalColor&&e.externalColor[3]>0,l=t||c||m;return s&&l?u||p:s?u?o:p:l?u||p:u?o:p}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=this.parameters.isInstanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType=this.parameters.normalType,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this.parameters.customDepthTest!=null&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?S.None:this.parameters.cullFace,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=this.parameters.modelTransformation!=null,e===A.Color&&(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=B.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?B.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?B.WindingOrder:B.None,this._configuration.instancedColor=this.parameters.hasInstancedColor,this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=this.parameters.receiveAmbientOcclusion&&t.ssao!=null,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?z.Schematic:z.Normal:z.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<qt,this._configuration.snowCover=this.hasSnowCover(t),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration}hasSnowCover(e){return e.weather!=null&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}intersect(e,t,s,m,c,u){if(this.parameters.verticalOffset!=null){let p=s.camera;Re(ze,t[12],t[13],t[14]);let o=null;switch(s.viewingMode){case se.Global:o=ue(lr,ze);break;case se.Local:o=Ke(lr,br)}let l=0,h=W(Mr,ze,p.eye),d=le(h),g=Ce(h,h,1/d),f=null;this.parameters.screenSizePerspective&&(f=Xe(o,g)),l+=Et(p,d,this.parameters.verticalOffset,f??0,this.parameters.screenSizePerspective),Ce(o,o,l),tt(qe,o,s.transform.inverseRotation),m=W(yr,m,qe),c=W(vr,c,qe)}Wt(e,s,m,c,Ht(s.verticalOffset),u)}createGLMaterial(e){return new Ge(e)}createBufferWriter(){return new $t(this._vertexBufferLayout)}},Ge=class extends Dt{constructor(e){super(F(F({},e),e.material.parameters))}_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===A.Color&&(this._updateShadowState(e),this._updateOccludeeState(e));let t=this._material.parameters;this.updateTexture(t.textureId);let s=e.camera.viewInverseTransposeMatrix;return Re(t.origin,s[3],s[7],s[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(t.treeRendering?oe:G,e)}},je=class extends Me{constructor(){super(...arguments),this.initTextureTransparent=!1,this.treeRendering=!1,this.hasVertexTangents=!1}},xr=new je;function Tr(r){let e=ct().vec3f(T.POSITION);return r.normalType===D.Compressed?e.vec2i16(T.NORMALCOMPRESSED,{glNormalized:!0}):e.vec3f(T.NORMAL),r.hasVertexTangents&&e.vec4f(T.TANGENT),(r.textureId||r.normalTextureId||r.metallicRoughnessTextureId||r.emissiveTextureId||r.occlusionTextureId)&&e.vec2f(T.UV0),r.hasVertexColors&&e.vec4u8(T.COLOR),r.hasSymbolColors&&e.vec4u8(T.SYMBOLCOLOR),He("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(T.OBJECTANDLAYERIDCOLOR),e}var yr=M(),vr=M(),br=j(0,0,1),lr=M(),qe=M(),ze=M(),Mr=M();var V=()=>Qe.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");function ur(r,e){return q(this,null,function*(){let t=yield Sr(r,e),s=yield Pr(t.textureDefinitions??{},e),m=0;for(let c in s)if(s.hasOwnProperty(c)){let u=s[c];m+=u?.image?u.image.width*u.image.height*4:0}return{resource:t,textures:s,size:m+$e(t)}})}function Sr(r,e){return q(this,null,function*(){let t=e?.streamDataRequester;if(t)return wr(r,t,e);let s=yield Oe(Ye(r,e));if(s.ok===!0)return s.value.data;we(s.error),cr(s.error)})}function wr(r,e,t){return q(this,null,function*(){let s=yield Oe(e.request(r,"json",t));if(s.ok===!0)return s.value;we(s.error),cr(s.error.details.url)})}function cr(r){throw new Ze("",`Request for object resource failed: ${r}`)}function Or(r){let e=r.params,t=e.topology,s=!0;switch(e.vertexAttributes||(V().warn("Geometry must specify vertex attributes"),s=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{let c=e.faces;if(c){if(e.vertexAttributes)for(let u in e.vertexAttributes){let p=c[u];p?.values?(p.valueType!=null&&p.valueType!=="UInt32"&&(V().warn(`Unsupported indexed geometry indices type '${p.valueType}', only UInt32 is currently supported`),s=!1),p.valuesPerElement!=null&&p.valuesPerElement!==1&&(V().warn(`Unsupported indexed geometry values per element '${p.valuesPerElement}', only 1 is currently supported`),s=!1)):(V().warn(`Indexed geometry does not specify face indices for '${u}' attribute`),s=!1)}}else V().warn("Indexed geometries must specify faces"),s=!1;break}default:V().warn(`Unsupported topology '${t}'`),s=!1}r.params.material||(V().warn("Geometry requires material"),s=!1);let m=r.params.vertexAttributes;for(let c in m)m[c].values||(V().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function mr(r,e){let t=new Array,s=new Array,m=new Array,c=new Ct,u=r.resource,p=ke.parse(u.version||"1.0","wosr");Ar.validate(p);let o=u.model.name,l=u.model.geometries,h=u.materialDefinitions??{},d=r.textures,g=0,f=new Map;for(let y=0;y<l.length;y++){let x=l[y];if(!Or(x))continue;let w=Cr(x),_=x.params.vertexAttributes,O=[],E=v=>{if(x.params.topology==="PerAttributeArray")return null;let I=x.params.faces;for(let N in I)if(N===v)return I[N].values;return null},K=_[T.POSITION],ae=K.values.length/K.valuesPerElement;for(let v in _){let I=_[v],N=I.values,Se=E(v)??pt(ae);O.push([v,new k(N,Se,I.valuesPerElement,!0)])}let R=w.texture,P=d&&d[R];if(P&&!f.has(R)){let{image:v,parameters:I}=P,N=new xe(v,I);s.push(N),f.set(R,N)}let ie=f.get(R),X=ie?ie.id:void 0,C=w.material,ee=c.get(C,R);if(ee==null){let v=h[C.substring(C.lastIndexOf("/")+1)].params;v.transparency===1&&(v.transparency=0);let I=P&&P.alphaChannelUsage,N=v.transparency>0||I==="transparency"||I==="maskAndTransparency",Se=P?pr(P.alphaChannelUsage):void 0,We={ambient:te(v.diffuse),diffuse:te(v.diffuse),opacity:1-(v.transparency||0),transparent:N,textureAlphaMode:Se,textureAlphaCutoff:.33,textureId:X,initTextureTransparent:!0,doubleSided:!0,cullFace:S.None,colorMixMode:v.externalColorMixMode||"tint",textureAlphaPremultiplied:P?.parameters.preMultiplyAlpha??!1};e?.materialParameters&&Object.assign(We,e.materialParameters),ee=new U(We),c.set(C,R,ee)}m.push(ee);let hr=new ge(ee,O);g+=O.find(v=>v[0]===T.POSITION)?.[1]?.indices.length??0,t.push(hr)}return{engineResources:[{name:o,stageResources:{textures:s,materials:m,geometries:t},pivotOffset:u.model.pivotOffset,numberOfVertices:g,lodThreshold:null}],referenceBoundingBox:Rr(t)}}function Rr(r){let e=ce();return r.forEach(t=>{let s=t.boundingInfo;s!=null&&(H(e,s.bbMin),H(e,s.bbMax))}),e}function Pr(r,e){return q(this,null,function*(){let t=new Array;for(let c in r){let u=r[c],p=u.images[0].data;if(!p){V().warn("Externally referenced texture data is not yet supported");continue}let o=u.encoding+";base64,"+p,l="/textureDefinitions/"+c,h=u.channels==="rgba"?u.alphaChannelUsage||"transparency":"none",d={noUnpackFlip:!0,wrap:{s:Be.REPEAT,t:Be.REPEAT},preMultiplyAlpha:pr(h)!==b.Opaque},g=e?.disableTextures?Promise.resolve(null):At(o,e);t.push(g.then(f=>({refId:l,image:f,parameters:d,alphaChannelUsage:h})))}let s=yield Promise.all(t),m={};for(let c of s)m[c.refId]=c;return m})}function pr(r){switch(r){case"mask":return b.Mask;case"maskAndTransparency":return b.MaskBlend;case"none":return b.Opaque;default:return b.Blend}}function Cr(r){let e=r.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}var Ar=new ke(1,2,"wosr");function ea(r,e){return q(this,null,function*(){let t=Dr(bt(r));if(t.fileType==="wosr"){let d=yield e.cache?e.cache.loadWOSR(t.url,e):ur(t.url,e),{engineResources:g,referenceBoundingBox:f}=mr(d,e);return{lods:g,referenceBoundingBox:f,isEsriSymbolResource:!1,isWosr:!0}}let s=yield e.cache?e.cache.loadGLTF(t.url,e,!!e.usePBR):Rt(new Ot(e.streamDataRequester),t.url,e,e.usePBR),m=s.model.meta?.ESRI_proxyEllipsoid,c=s.meta.isEsriSymbolResource&&m!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";c&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,Nr(s,m));let u=!!e.usePBR,p=s.meta.isEsriSymbolResource?{usePBR:u,isSchematic:!1,treeRendering:c,mrrFactors:[...ir]}:{usePBR:u,isSchematic:!1,treeRendering:!1,mrrFactors:[...be]},o=ne(F({},e.materialParameters),{treeRendering:c}),{engineResources:l,referenceBoundingBox:h}=_r(s,p,o,e.skipHighLods&&t.specifiedLodIndex==null?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:t.specifiedLodIndex});return{lods:l,referenceBoundingBox:h,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}})}function Dr(r){let e=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function _r(r,e,t,s){let m=r.model,c=new Array,u=new Map,p=new Map,o=m.lods.length,l=ce();return m.lods.forEach((h,d)=>{let g=s.skipHighLods===!0&&(o>1&&d===0||o>3&&d===1)||s.skipHighLods===!1&&s.singleLodIndex!=null&&d!==s.singleLodIndex;if(g&&d!==0)return;let f=new ve(h.name,h.lodThreshold,[0,0,0]);h.parts.forEach(y=>{let x=g?new U({}):Er(m,y,f,e,t,u,p),{geometry:w,vertexCount:_}=Ir(y,x??new U({})),O=w.boundingInfo;O!=null&&d===0&&(H(l,O.bbMin),H(l,O.bbMax)),x!=null&&(f.stageResources.geometries.push(w),f.numberOfVertices+=_)}),g||c.push(f)}),{engineResources:c,referenceBoundingBox:l}}function Er(r,e,t,s,m,c,u){let p=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),o=r.materials.get(e.material),l=e.attributes.texCoord0!=null,h=e.attributes.normal!=null;if(o==null)return null;let d=Br(o.alphaMode);if(!c.has(p)){if(l){let R=(P,ie=!1)=>{if(P!=null&&!u.has(P)){let X=r.textures.get(P);if(X!=null){let C=X.data;u.set(P,new xe(he(C)?C.data:C,ne(F({},X.parameters),{preMultiplyAlpha:!he(C)&&ie,encoding:he(C)&&C.encoding!=null?C.encoding:void 0})))}}};R(o.textureColor,d!==b.Opaque),R(o.textureNormal),R(o.textureOcclusion),R(o.textureEmissive),R(o.textureMetallicRoughness)}let f=o.color[0]**(1/2.1),y=o.color[1]**(1/2.1),x=o.color[2]**(1/2.1),w=o.emissiveFactor[0]**(1/2.1),_=o.emissiveFactor[1]**(1/2.1),O=o.emissiveFactor[2]**(1/2.1),E=o.textureColor!=null&&l?u.get(o.textureColor):null,K=or({normalTexture:o.textureNormal,metallicRoughnessTexture:o.textureMetallicRoughness,metallicFactor:o.metallicFactor,roughnessFactor:o.roughnessFactor,emissiveTexture:o.textureEmissive,emissiveFactor:o.emissiveFactor,occlusionTexture:o.textureOcclusion}),ae=o.normalTextureTransform?.scale!=null?o.normalTextureTransform?.scale:ut;c.set(p,new U(F(ne(F({},s),{transparent:d===b.Blend,customDepthTest:L.Lequal,textureAlphaMode:d,textureAlphaCutoff:o.alphaCutoff,diffuse:[f,y,x],ambient:[f,y,x],opacity:o.opacity,doubleSided:o.doubleSided,doubleSidedType:"winding-order",cullFace:o.doubleSided?S.None:S.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:h?D.Attribute:D.ScreenDerivative,castShadows:!0,receiveShadows:o.receiveShadows,receiveAmbientOcclusion:o.receiveAmbientOcclustion,textureId:E?.id,colorMixMode:o.colorMixMode,normalTextureId:o.textureNormal!=null&&l?u.get(o.textureNormal).id:void 0,textureAlphaPremultiplied:E!=null&&!!E.parameters.preMultiplyAlpha,occlusionTextureId:o.textureOcclusion!=null&&l?u.get(o.textureOcclusion).id:void 0,emissiveTextureId:o.textureEmissive!=null&&l?u.get(o.textureEmissive).id:void 0,metallicRoughnessTextureId:o.textureMetallicRoughness!=null&&l?u.get(o.textureMetallicRoughness).id:void 0,emissiveFactor:[w,_,O],mrrFactors:K?[...ar]:[o.metallicFactor,o.roughnessFactor,s.mrrFactors[2]],isSchematic:K,colorTextureTransformMatrix:Z(o.colorTextureTransform),normalTextureTransformMatrix:Z(o.normalTextureTransform),scale:[ae[0],ae[1]],occlusionTextureTransformMatrix:Z(o.occlusionTextureTransform),emissiveTextureTransformMatrix:Z(o.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:Z(o.metallicRoughnessTextureTransform)}),m)))}let g=c.get(p);if(t.stageResources.materials.push(g),l){let f=y=>{y!=null&&t.stageResources.textures.push(u.get(y))};f(o.textureColor),f(o.textureNormal),f(o.textureOcclusion),f(o.textureEmissive),f(o.textureMetallicRoughness)}return g}function Ir(r,e){let t=r.attributes.position.count,s=Pt(r.indices||t,r.primitiveType),m=re(3*t),{typedBuffer:c,typedBufferStride:u}=r.attributes.position;gt(m,c,r.transform,3,u);let p=[[T.POSITION,new k(m,s,3,!0)]];if(r.attributes.normal!=null){let l=re(3*t),{typedBuffer:h,typedBufferStride:d}=r.attributes.normal;dt(J,r.transform),xt(l,h,J,3,d),De(J)&&Fe(l,l),p.push([T.NORMAL,new k(l,s,3,!0)])}if(r.attributes.tangent!=null){let l=re(4*t),{typedBuffer:h,typedBufferStride:d}=r.attributes.tangent;ht(J,r.transform),Tt(l,h,J,4,d),De(J)&&Fe(l,l,4),p.push([T.TANGENT,new k(l,s,4,!0)])}if(r.attributes.texCoord0!=null){let l=re(2*t),{typedBuffer:h,typedBufferStride:d}=r.attributes.texCoord0;Mt(l,h,2,d),p.push([T.UV0,new k(l,s,2,!0)])}let o=r.attributes.color;if(o!=null){let l=new Uint8Array(4*t);o.elementCount===4?o instanceof at?Le(l,o,255):o instanceof Ee?wt(l,o):o instanceof lt&&Le(l,o,1/256):(l.fill(255),o instanceof _e?Ve(l,o.typedBuffer,255,4,o.typedBufferStride):r.attributes.color instanceof it?St(l,o.typedBuffer,4,r.attributes.color.typedBufferStride):r.attributes.color instanceof nt&&Ve(l,o.typedBuffer,1/256,4,o.typedBufferStride)),p.push([T.COLOR,new k(l,s,4,!0)])}return{geometry:new ge(e,p),vertexCount:t}}var J=me();function Br(r){switch(r){case"BLEND":return b.Blend;case"MASK":return b.Mask;case"OPAQUE":case null:case void 0:return b.Opaque}}function Nr(r,e){for(let t=0;t<r.model.lods.length;++t){let s=r.model.lods[t];for(let m of s.parts){let c=m.attributes.normal;if(c==null)return;let u=m.attributes.position,p=u.count,o=M(),l=M(),h=M(),d=new Uint8Array(4*p),g=new Float64Array(3*p),f=st(ft(),m.transform),y=0,x=0;for(let w=0;w<p;w++){u.getVec(w,l),c.getVec(w,o),Ae(l,l,m.transform),W(h,l,e.center),Pe(h,h,e.radius);let _=h[2],O=le(h),E=Math.min(.45+.55*O*O,1);Pe(h,h,e.radius),f!==null&&Ae(h,h,f),ue(h,h),t+1!==r.model.lods.length&&r.model.lods.length>1&&et(h,h,o,_>-1?.2:Math.min(-4*_-3.8,1)),g[y]=h[0],g[y+1]=h[1],g[y+2]=h[2],y+=3,d[x]=255*E,d[x+1]=255*E,d[x+2]=255*E,d[x+3]=255,x+=4}m.attributes.normal=new _e(g),m.attributes.color=new Ee(d)}}}export{Z as a,or as b,be as c,ar as d,nr as e,U as f,ea as g,Dr as h,_r as i};
