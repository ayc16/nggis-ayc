import{a as G}from"./chunk-GJBALZEB.js";import{b as D}from"./chunk-ZAQLF7TN.js";import{b as C,d as g}from"./chunk-76YVRX2R.js";import{b as c,c as M,d as w,l as v,q as E,v as B}from"./chunk-OZF6BMOL.js";import{a as h,c as p}from"./chunk-GJP6PTKT.js";import{c as S}from"./chunk-MLSR6YE6.js";import{a as H}from"./chunk-CPDJJRWA.js";import{h as A}from"./chunk-EAH6BNBL.js";var d=class{constructor(t=h()){this.intensity=t}},b=class{constructor(t=h(),i=p(.57735,.57735,.57735)){this.intensity=t,this.direction=i}},m=class{constructor(t=h(),i=p(.57735,.57735,.57735),r=!0,s=1,a=1){this.intensity=t,this.direction=i,this.castShadows=r,this.specularStrength=s,this.environmentStrength=a}},f=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function I(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function L(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function u(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function z(e){return(e+1)*(e+1)}function W(e){return C(Math.floor(Math.sqrt(e)-1),0,2)}function N(e,t,i){let r=e[0],s=e[1],a=e[2],o=i||[];return o.length=z(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*r,o[2]=.4886025119*a,o[3]=.4886025119*s),t>=2&&(o[4]=1.09254843059*r*s,o[5]=1.09254843059*s*a,o[6]=.31539156525*(3*a*a-1),o[7]=1.09254843059*r*a,o[8]=.54627421529*(r*r-s*s)),o}function $(e,t){let i=z(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let s=0;s<i;s++)r.r[s]=r.g[s]=r.b[s]=0;return r}function J(e,t){let i=W(t.r.length);for(let r of e)E(T,r.direction),N(T,i,l),I(l,x),L(l,r.intensity[0],_),u(t.r,_),L(l,r.intensity[1],_),u(t.g,_),L(l,r.intensity[2],_),u(t.b,_);return t}function K(e,t){N(T,0,l);for(let i of e)t.r[0]+=l[0]*x[0]*i.intensity[0]*4*Math.PI,t.g[0]+=l[0]*x[0]*i.intensity[1]*4*Math.PI,t.b[0]+=l[0]*x[0]*i.intensity[2]*4*Math.PI;return t}function V(e,t,i,r){$(t,r),M(i.intensity,0,0,0);let s=!1,a=Q,o=Y,U=Z;a.length=0,o.length=0,U.length=0;for(let n of e)n instanceof m&&!s?(c(i.direction,n.direction),c(i.intensity,n.intensity),i.specularStrength=n.specularStrength,i.environmentStrength=n.environmentStrength,i.castShadows=n.castShadows,s=!0):n instanceof m||n instanceof b?a.push(n):n instanceof d?o.push(n):n instanceof f&&U.push(n);J(a,r),K(o,r);for(let n of U)u(r.r,n.r),u(r.g,n.g),u(r.b,n.b)}var Q=[],Y=[],Z=[],l=[0],_=[0],T=h(),x=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];var y=class{constructor(){this.color=h(),this.intensity=1}},F=class{constructor(){this.direction=h(),this.ambient=new y,this.diffuse=new y}},tt=.4,k=class{constructor(){this._shOrder=2,this._legacy=new F,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new f,this._mainLight=new m(h(),p(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(t){V(t,this._shOrder,this._mainLight,this._sphericalHarmonics),c(this._legacy.direction,this._mainLight.direction);let i=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*i,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*i,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*i,v(this._legacy.diffuse.color,this._mainLight.intensity,i),c(P,this._legacy.diffuse.color),v(P,P,tt*this.globalFactor),w(this._legacy.ambient.color,this._legacy.ambient.color,P)}copyFrom(t){this._sphericalHarmonics.r=Array.from(t.sh.r),this._sphericalHarmonics.g=Array.from(t.sh.g),this._sphericalHarmonics.b=Array.from(t.sh.b),c(this._mainLight.direction,t.mainLight.direction),c(this._mainLight.intensity,t.mainLight.intensity),this._mainLight.castShadows=t.mainLight.castShadows,this._mainLight.specularStrength=t.mainLight.specularStrength,this._mainLight.environmentStrength=t.mainLight.environmentStrength,this.globalFactor=t.globalFactor,this.noonFactor=t.noonFactor}lerpLighting(t,i,r){if(B(this._mainLight.intensity,t.mainLight.intensity,i.mainLight.intensity,r),this._mainLight.environmentStrength=g(t.mainLight.environmentStrength,i.mainLight.environmentStrength,r),this._mainLight.specularStrength=g(t.mainLight.specularStrength,i.mainLight.specularStrength,r),c(this._mainLight.direction,i.mainLight.direction),this._mainLight.castShadows=i.mainLight.castShadows,this.globalFactor=g(t.globalFactor,i.globalFactor,r),this.noonFactor=g(t.noonFactor,i.noonFactor,r),t.sh.r.length===i.sh.r.length)for(let s=0;s<i.sh.r.length;s++)this._sphericalHarmonics.r[s]=g(t.sh.r[s],i.sh.r[s],r),this._sphericalHarmonics.g[s]=g(t.sh.g[s],i.sh.g[s],r),this._sphericalHarmonics.b[s]=g(t.sh.b[s],i.sh.b[s],r);else for(let s=0;s<i.sh.r.length;s++)this._sphericalHarmonics.r[s]=i.sh.r[s],this._sphericalHarmonics.g[s]=i.sh.g[s],this._sphericalHarmonics.b[s]=i.sh.b[s]}},P=h();var R=class{constructor(t,i){this._module=t,this._loadModule=i}get(){return this._module}reload(){return A(this,null,function*(){return this._module=yield this._loadModule(),this._module})}};var j=class{constructor(t,i,r){this.release=r,this.initializeConfiguration(t,i),this._configuration=i.snapshot(),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t)}destroy(){this._program=S(this._program),this._pipeline=this._configuration=null}reload(t){S(this._program),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t)}get program(){return this._program}get compiled(){return this.program.compiled}get key(){return this._configuration.key}get configuration(){return this._configuration}ensureAttributeLocations(t){this.program.assertCompatibleVertexAttributeLocations(t)}get primitiveType(){return D.TRIANGLES}getPipeline(t,i,r){return this._pipeline}initializeConfiguration(t,i){}};var O=class{constructor(t,i,r){this._context=t,this._locations=r,this._textures=new Map,this._freeTextureUnits=new H({deallocator:null}),this._glProgram=t.programCache.acquire(i.generate("vertex"),i.generate("fragment"),r),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bindPass=i.generateBindPass(this),this.bindDraw=i.generateBindDraw(this),this._fragmentUniforms=G()?i.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(t,i){this._glProgram.setUniform1i(t,i?1:0)}setUniform1i(t,i){this._glProgram.setUniform1i(t,i)}setUniform1f(t,i){this._glProgram.setUniform1f(t,i)}setUniform2fv(t,i){this._glProgram.setUniform2fv(t,i)}setUniform3fv(t,i){this._glProgram.setUniform3fv(t,i)}setUniform4fv(t,i){this._glProgram.setUniform4fv(t,i)}setUniformMatrix3fv(t,i){this._glProgram.setUniformMatrix3fv(t,i)}setUniformMatrix4fv(t,i){this._glProgram.setUniformMatrix4fv(t,i)}setUniform1fv(t,i){this._glProgram.setUniform1fv(t,i)}setUniform1iv(t,i){this._glProgram.setUniform1iv(t,i)}setUniform2iv(t,i){this._glProgram.setUniform3iv(t,i)}setUniform3iv(t,i){this._glProgram.setUniform3iv(t,i)}setUniform4iv(t,i){this._glProgram.setUniform4iv(t,i)}assertCompatibleVertexAttributeLocations(t){t.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(t,i){if(i?.glName==null){let s=this._textures.get(t);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(t)),null}let r=this._textures.get(t);return r==null?(r=this._allocTextureUnit(i),this._textures.set(t,r)):r.texture=i,this._context.useProgram(this),this.setUniform1i(t,r.unit),this._context.bindTexture(i,r.unit),r.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach((t,i)=>{this._context.bindTexture(t.texture,t.unit),this.setUniform1i(i,t.unit)}),this._fragmentUniforms?.forEach(t=>{t.type!=="sampler2D"&&t.type!=="samplerCube"||this._textures.has(t.name)||console.error(`Texture sampler ${t.name} has no bound texture`)})}_allocTextureUnit(t){return{texture:t,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(t){this._freeTextureUnits.push(t.unit)}};var q,X;(function(e){e[e.RED=0]="RED",e[e.RG=1]="RG",e[e.RGBA4=2]="RGBA4",e[e.RGBA=3]="RGBA",e[e.RGBA_MIPMAP=4]="RGBA_MIPMAP",e[e.R16F=5]="R16F",e[e.RGBA16F=6]="RGBA16F"})(q||(q={})),function(e){e[e.DEPTH_STENCIL_TEXTURE=0]="DEPTH_STENCIL_TEXTURE",e[e.DEPTH16_BUFFER=1]="DEPTH16_BUFFER"}(X||(X={}));export{R as a,j as b,O as c,q as d,X as e,d as f,tt as g,k as h};
