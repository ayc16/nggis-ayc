import{a as ze}from"./chunk-3PDNZTNN.js";import{a as Br,c as Ir,d as Dr,e as Vr,f as Fr}from"./chunk-3QUBAXI6.js";import{b as zr}from"./chunk-46WXX26I.js";import{a as Q,c as kr}from"./chunk-4RG36RMT.js";import{F as p,G as Ur,a as k,b as He,c as qe,e as W,f as Me,j as vr,k as me,m as br,n as Mr,o as Er,p as Rr,q as wr,r as We,v as Lr,w as je,x as Nr,y as Gr}from"./chunk-FKKLCRMQ.js";import{a as Ar}from"./chunk-FVCUBGKZ.js";import{a as Ee,d as Or,e as Cr,f as Sr,g as Pr}from"./chunk-LFPKLGKU.js";import"./chunk-SUFGB5QC.js";import"./chunk-PV5OLJIT.js";import"./chunk-FN7HZGXJ.js";import"./chunk-GMW3QDVG.js";import{h as nr,i as lr,j as ae}from"./chunk-57GB3TOJ.js";import{a as ir}from"./chunk-RHABF3KL.js";import"./chunk-6Z54DTZZ.js";import{a as yr,b as _r}from"./chunk-PYUETFC3.js";import{c as dt}from"./chunk-CS6GS2YZ.js";import{b as hr,e as ft,g as pr,j as fr,m as dr,o as gr,p as Tr,q as xr}from"./chunk-NKHO2WSC.js";import{b as ke}from"./chunk-IEHQFX5N.js";import{a as Ue}from"./chunk-6GEWZ7SA.js";import{a as cr,b as mr}from"./chunk-KWPZPKEZ.js";import"./chunk-PTXLSCMJ.js";import"./chunk-GEDCZS6Y.js";import{b as oe}from"./chunk-YQNUGDFH.js";import"./chunk-WB63P7CN.js";import"./chunk-SDUXSXKH.js";import{a as q,b as ie,d as J,f as G,h as be}from"./chunk-ZREXZJBZ.js";import"./chunk-MCO7DSFO.js";import{a as er,c as Pe}from"./chunk-DQ5TDMUL.js";import"./chunk-2NH7HOKA.js";import{i as Y,j as H,k as Z,l as ue,n as se,z as X}from"./chunk-XSMN6VN6.js";import{a as V}from"./chunk-I46GU3Q4.js";import{a as v}from"./chunk-H5IJXG2U.js";import{c as tr}from"./chunk-TCQOV56D.js";import"./chunk-CLDJAOGN.js";import"./chunk-YIRBKWRK.js";import"./chunk-IFFYADB3.js";import{a as ct}from"./chunk-BVW6ULEA.js";import{a as Be,b as Ge}from"./chunk-7C6Z24SS.js";import{c as rr,e as sr,g as ut}from"./chunk-H34WFTDW.js";import{D as Zt,a as Xt,b as Kt,c as Ae,d as Se,o as $t,p as ve,s as Yt,t as Qt}from"./chunk-AWOMJTYJ.js";import{c as ar,d as or}from"./chunk-37H4LYIE.js";import{a as ce}from"./chunk-XHOTVM3O.js";import{a as pt}from"./chunk-2F3ICBUH.js";import{b as ur}from"./chunk-QB2WNRL5.js";import"./chunk-TLLESPR2.js";import"./chunk-I3S324BU.js";import{e as _e,k as Ne}from"./chunk-GUOR3BIM.js";import{d as Jt}from"./chunk-2EA2KAER.js";import{g as mt,n as ht}from"./chunk-V5AJXD2Y.js";import"./chunk-3IJY37BG.js";import"./chunk-J57HR4DB.js";import"./chunk-GNCG2SQP.js";import{d as it,s as nt,t as lt}from"./chunk-K5NHJTKR.js";import"./chunk-C6JT6KYF.js";import"./chunk-BCREO4Q5.js";import{b as jt}from"./chunk-Z5Q76SB7.js";import"./chunk-E5R4OI7X.js";import"./chunk-6FWNINU2.js";import{A as Le,B as zt,D as Ht,E as ye,F as qt,H as Wt,a as B,c as Te,d as Ce,e as Gt,j as z,k as Ut,l as te,m as kt,n as xe,p as at,u as ot,v as re}from"./chunk-ES7AH7WX.js";import"./chunk-RSDQHAJX.js";import"./chunk-G3LLBABP.js";import{a as Ft}from"./chunk-T4B3RN6B.js";import{c as st}from"./chunk-MXADXAOS.js";import"./chunk-RJHITHLB.js";import"./chunk-UI76XBLJ.js";import"./chunk-UE2YGKE7.js";import"./chunk-BE76S5KT.js";import"./chunk-D2ITYHSM.js";import"./chunk-FIITBHDP.js";import{a as Lt}from"./chunk-VSVNPPHQ.js";import{Z as Vt,_ as Nt,u as rt,v as Dt}from"./chunk-CTGIUUCS.js";import"./chunk-VWEBO6QK.js";import"./chunk-KAAR5ZJN.js";import{a as h}from"./chunk-W3WDPWBE.js";import{g as Bt,h as et,k as tt,m as It}from"./chunk-WKT5W7KT.js";import{c as St,d as Pt}from"./chunk-MLSR6YE6.js";import"./chunk-JPDAKIWT.js";import{p as Fe,r as ge}from"./chunk-X3IDZTNG.js";import{a as Ot,r as Ct,t as fe,v as de}from"./chunk-IQJU4QT3.js";import{a as j,b as Ve,h as U}from"./chunk-EAH6BNBL.js";function Re(r){if(r==null)return null;let e=r.offset!=null?r.offset:ar,t=r.rotation!=null?r.rotation:0,s=r.scale!=null?r.scale:or,l=Ge(1,0,0,0,1,0,e[0],e[1],1),i=Ge(Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1),o=Ge(s[0],0,0,0,s[1],0,0,0,1),n=Be();return mt(n,i,o),mt(n,l,n),n}var gt=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},Xe=class{constructor(e,t,s){this.name=e,this.lodThreshold=t,this.pivotOffset=s,this.stageResources=new gt,this.numberOfVertices=0}};function Hr(){if(Tt==null){let r=e=>Lt(`esri/libs/basisu/${e}`);Tt=import("./chunk-ZEM2H3AO.js").then(e=>e.b).then(({default:e})=>e({locateFile:r}).then(t=>(t.initializeBasis(),delete t.then,t)))}return Tt}var Tt;var ne;(function(r){r[r.ETC1_RGB=0]="ETC1_RGB",r[r.ETC2_RGBA=1]="ETC2_RGBA",r[r.BC1_RGB=2]="BC1_RGB",r[r.BC3_RGBA=3]="BC3_RGBA",r[r.BC4_R=4]="BC4_R",r[r.BC5_RG=5]="BC5_RG",r[r.BC7_M6_RGB=6]="BC7_M6_RGB",r[r.BC7_M5_RGBA=7]="BC7_M5_RGBA",r[r.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",r[r.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",r[r.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",r[r.ATC_RGB=11]="ATC_RGB",r[r.ATC_RGBA=12]="ATC_RGBA",r[r.FXT1_RGB=17]="FXT1_RGB",r[r.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",r[r.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",r[r.ETC2_EAC_R11=20]="ETC2_EAC_R11",r[r.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",r[r.RGBA32=13]="RGBA32",r[r.RGB565=14]="RGB565",r[r.BGR565=15]="BGR565",r[r.RGBA4444=16]="RGBA4444"})(ne||(ne={}));var K=null,Ke=null;function qr(){return U(this,null,function*(){return Ke==null&&(Ke=Hr(),K=yield Ke),Ke})}function Wr(r,e){if(K==null)return r.byteLength;let t=new K.BasisFile(new Uint8Array(r)),s=Kr(t)?Xr(t.getNumLevels(0),t.getHasAlpha(),t.getImageWidth(0,0),t.getImageHeight(0,0),e):0;return t.close(),t.delete(),s}function jr(r,e){if(K==null)return r.byteLength;let t=new K.KTX2File(new Uint8Array(r)),s=$r(t)?Xr(t.getLevels(),t.getHasAlpha(),t.getWidth(),t.getHeight(),e):0;return t.close(),t.delete(),s}function Xr(r,e,t,s,l){let i=nr(e?X.COMPRESSED_RGBA8_ETC2_EAC:X.COMPRESSED_RGB8_ETC2),o=l&&r>1?(4**r-1)/(3*4**(r-1)):1;return Math.ceil(t*s*i*o)}function Kr(r){return r.getNumImages()>=1&&!r.isUASTC()}function $r(r){return r.getFaces()>=1&&r.isETC1S()}function Yr(r,e,t){return U(this,null,function*(){K==null&&(K=yield qr());let s=new K.BasisFile(new Uint8Array(t));if(!Kr(s))return null;s.startTranscoding();let l=Zr(r,e,s.getNumLevels(0),s.getHasAlpha(),s.getImageWidth(0,0),s.getImageHeight(0,0),(i,o)=>s.getImageTranscodedSizeInBytes(0,i,o),(i,o,n)=>s.transcodeImage(n,0,i,o,0,0));return s.close(),s.delete(),l})}function Qr(r,e,t){return U(this,null,function*(){K==null&&(K=yield qr());let s=new K.KTX2File(new Uint8Array(t));if(!$r(s))return null;s.startTranscoding();let l=Zr(r,e,s.getLevels(),s.getHasAlpha(),s.getWidth(),s.getHeight(),(i,o)=>s.getImageTranscodedSizeInBytes(i,0,0,o),(i,o,n)=>s.transcodeImage(n,i,0,0,o,0,-1,-1));return s.close(),s.delete(),l})}function Zr(r,e,t,s,l,i,o,n){let{compressedTextureETC:a,compressedTextureS3TC:c}=r.capabilities,[u,m]=a?s?[ne.ETC2_RGBA,X.COMPRESSED_RGBA8_ETC2_EAC]:[ne.ETC1_RGB,X.COMPRESSED_RGB8_ETC2]:c?s?[ne.BC3_RGBA,X.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[ne.BC1_RGB,X.COMPRESSED_RGB_S3TC_DXT1_EXT]:[ne.RGBA32,se.RGBA],T=e.hasMipmap?t:Math.min(1,t),d=[];for(let _=0;_<T;_++)d.push(new Uint8Array(o(_,u))),n(_,u,d[_]);return e.internalFormat=m,e.hasMipmap=d.length>1,e.samplingMode=e.hasMipmap?Z.LINEAR_MIPMAP_LINEAR:Z.LINEAR,e.width=l,e.height=i,new ae(r,e,{type:"compressed",levels:d})}var $e=()=>Fe.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),vs=542327876,bs=131072,Ms=4;function xt(r){return r.charCodeAt(0)+(r.charCodeAt(1)<<8)+(r.charCodeAt(2)<<16)+(r.charCodeAt(3)<<24)}function Es(r){return String.fromCharCode(255&r,r>>8&255,r>>16&255,r>>24&255)}var Rs=xt("DXT1"),ws=xt("DXT3"),Os=xt("DXT5"),Cs=31,Ss=0,Ps=1,Bs=2,Is=3,Ds=4,Vs=7,Fs=20,Ls=21;function Jr(r,e,t){let s=Ns(t,e.hasMipmap??!1);if(s==null)throw new Error("DDS texture data is null");let{textureData:l,internalFormat:i,width:o,height:n}=s;return e.samplingMode=l.levels.length>1?Z.LINEAR_MIPMAP_LINEAR:Z.LINEAR,e.hasMipmap=l.levels.length>1,e.internalFormat=i,e.width=o,e.height=n,new ae(r,e,l)}function Ns(r,e){let t=new Int32Array(r,0,Cs);if(t[Ss]!==vs)return $e().error("Invalid magic number in DDS header"),null;if(!(t[Fs]&Ms))return $e().error("Unsupported format, must contain a FourCC code"),null;let s=t[Ls],l,i;switch(s){case Rs:l=8,i=X.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case ws:l=16,i=X.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Os:l=16,i=X.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return $e().error("Unsupported FourCC code:",Es(s)),null}let o=1,n=t[Ds],a=t[Is];!(3&n)&&!(3&a)||($e().warn("Rounding up compressed texture size to nearest multiple of 4."),n=n+3&-4,a=a+3&-4);let c=n,u=a,m,T;t[Bs]&bs&&e!==!1&&(o=Math.max(1,t[Vs]));let d=t[Ps]+4,_=[];for(let E=0;E<o;++E)T=(n+3>>2)*(a+3>>2)*l,m=new Uint8Array(r,d,T),_.push(m),d+=T,n=Math.max(1,n>>1),a=Math.max(1,a>>1);return{textureData:{type:"compressed",levels:_},internalFormat:i,width:c,height:u}}function es(r,e){let i=r.width*r.height;if(i<4096)return r instanceof ImageData?rs(r):r;let o=r.width,n=r.height;do o=Math.ceil(o/2),n=Math.ceil(n/2),i=o*n;while(i>1048576||e!=null&&(o>e||n>e));return yt(r,o,n)}function ts(r,e){let t=Math.max(r.width,r.height);if(t<=e)return r;let s=e/t;return yt(r,Math.round(r.width*s),Math.round(r.height*s))}function yt(r,e,t){if(r instanceof ImageData)return yt(rs(r),e,t);let s=document.createElement("canvas");return s.width=e,s.height=t,s.getContext("2d").drawImage(r,0,0,s.width,s.height),s}function rs(r){let e=document.createElement("canvas");e.width=r.width,e.height=r.height;let t=e.getContext("2d");if(t==null)throw new ge("Failed to create 2d context from HTMLCanvasElement");return t.putImageData(r,0,0),e}var we=class extends mr{get parameters(){return this._parameters}constructor(e,t){super(),this._data=e,this.type=cr.Texture,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this.events=new Ft,this._parameters=j(j({},Us),t),this._startPreload(e)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(e){e!=null&&(e instanceof HTMLVideoElement?(this.frameUpdate=t=>this._frameUpdate(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(rt(e.src)||e.preload==="auto"&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";let t=!e.paused;if(e.src=e.src,t&&e.autoplay){let s=()=>{e.removeEventListener("canplay",s),e.play()};e.addEventListener("canplay",s)}}}_startPreloadImageElement(e){Dt(e.src)||rt(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){let t=new lr;return t.wrapMode=this._parameters.wrap??ue.REPEAT,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?Z.LINEAR_MIPMAP_LINEAR:Z.LINEAR,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.usedMemory||Gs(this._data,this._parameters)}load(e){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;let t=this._data;return t==null?(this._glTexture=new ae(e,this._createDescriptor(e),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),typeof t=="string"?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):(fe(t)||de(t))&&this._parameters.encoding===be.DDS_ENCODING?this._loadFromDDSData(e,t):(fe(t)||de(t))&&this._parameters.encoding===be.KTX2_ENCODING?this._loadFromKTX2(e,t):(fe(t)||de(t))&&this._parameters.encoding===be.BASIS_ENCODING?this._loadFromBasis(e,t):de(t)?this._loadFromPixelData(e,t):fe(t)?this._loadFromPixelData(e,new Uint8Array(t)):null)}_frameUpdate(e,t){return this._glTexture==null||e.readyState<Ie.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=Jr(e,this._createDescriptor(e),t),this._glTexture}_loadFromKTX2(e,t){return this._loadAsync(()=>Qr(e,this._createDescriptor(e),t).then(s=>(this._glTexture=s,s)))}_loadFromBasis(e,t){return this._loadAsync(()=>Yr(e,this._createDescriptor(e),t).then(s=>(this._glTexture=s,s)))}_loadFromPixelData(e,t){V(this._parameters.width>0&&this._parameters.height>0);let s=this._createDescriptor(e);return s.pixelFormat=this._parameters.components===1?se.LUMINANCE:this._parameters.components===3?se.RGB:se.RGBA,s.width=this._parameters.width??0,s.height=this._parameters.height??0,this._glTexture=new ae(e,s,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync(s=>U(this,null,function*(){let l=yield ze(t,{signal:s});return et(s),this._loadFromImage(e,l)}))}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync(s=>U(this,null,function*(){let l=yield Vt(t,t.src,!1,s);return et(s),this._loadFromImage(e,l)}))}_loadFromVideoElement(e,t){return t.readyState>=Ie.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync(s=>new Promise((l,i)=>{let o=()=>{t.removeEventListener("loadeddata",n),t.removeEventListener("error",a),Pt(c)},n=()=>{t.readyState>=Ie.HAVE_CURRENT_DATA&&(o(),l(this._loadFromImage(e,t)))},a=u=>{o(),i(u||new ge("Failed to load video"))};t.addEventListener("loadeddata",n),t.addEventListener("error",a);let c=It(s,()=>a(Bt()))}))}_loadFromImage(e,t){let s=t;if(!(s instanceof HTMLVideoElement)){let{maxTextureSize:o}=e.parameters;s=this._parameters.downsampleUncompressed?es(s,o):ts(s,o)}let l=ss(s);this._parameters.width=l.width,this._parameters.height=l.height;let i=this._createDescriptor(e);return i.pixelFormat=this._parameters.components===3?se.RGB:se.RGBA,i.width=l.width,i.height=l.height,this._glTexture=new ae(e,i,s),this._glTexture}_loadAsync(e){let t=new AbortController;this._loadingController=t;let s=e(t.signal);this._loadingPromise=s;let l=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===s&&(this._loadingPromise=null)};return s.then(l,l),s}unload(){if(this._glTexture=St(this._glTexture),this._loadingController!=null){let e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}};function Gs(r,e){if(r==null)return 0;if(fe(r)||de(r))return e.encoding===be.KTX2_ENCODING?jr(r,!!e.mipmap):e.encoding===be.BASIS_ENCODING?Wr(r,!!e.mipmap):r.byteLength;let{width:t,height:s}=r instanceof Image||r instanceof ImageData||r instanceof HTMLCanvasElement||r instanceof HTMLVideoElement?ss(r):e;return(e.mipmap?4/3:1)*t*s*(e.components||4)||0}function ss(r){return r instanceof HTMLVideoElement?{width:r.videoWidth,height:r.videoHeight}:r}var Ie;(function(r){r[r.HAVE_NOTHING=0]="HAVE_NOTHING",r[r.HAVE_METADATA=1]="HAVE_METADATA",r[r.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",r[r.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",r[r.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(Ie||(Ie={}));var Us={wrap:{s:ue.REPEAT,t:ue.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1};var _t=class{constructor(e=0){this.offset=e,this.tmpVertex=B()}applyToVertex(e,t,s){let l=te(bt,e,t,s),i=kt(is,l,this.localOrigin),o=this.offset/z(i);return re(this.tmpVertex,l,i,o),this.tmpVertex}applyToAabb(e){let t=ks,s=zs,l=Hs;for(let a=0;a<3;++a)t[a]=e[0+a]+this.localOrigin[a],s[a]=e[3+a]+this.localOrigin[a],l[a]=t[a];let i=this.applyToVertex(t[0],t[1],t[2]);for(let a=0;a<3;++a)e[a]=i[a],e[a+3]=i[a];let o=a=>{let c=this.applyToVertex(a[0],a[1],a[2]);for(let u=0;u<3;++u)e[u]=Math.min(e[u],c[u]),e[u+3]=Math.max(e[u+3],c[u])};for(let a=1;a<8;++a){for(let c=0;c<3;++c)l[c]=a&1<<c?s[c]:t[c];o(l)}let n=0;for(let a=0;a<3;++a)t[a]*s[a]<0&&(n|=1<<a);if(n!==0&&n!==7){for(let a=0;a<8;++a)if(!(n&a)){for(let c=0;c<3;++c)l[c]=n&1<<c?0:a&1<<c?t[c]:s[c];o(l)}}for(let a=0;a<3;++a)e[a]-=this.localOrigin[a],e[a+3]-=this.localOrigin[a];return e}},At=class{constructor(e=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=B(),this._tmpMbs=dt(),this._tmpObb=new yr,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=z(e)}applyToVertex(e,t,s){let l=te(bt,e,t,s),i=te(is,e,t,s+this.componentLocalOriginLength),o=this._totalOffset/z(i);return re(this._tmpVertex,l,i,o),this._tmpVertex}applyToAabb(e){let t=this.componentLocalOriginLength,s=e[0],l=e[1],i=e[2]+t,o=e[3],n=e[4],a=e[5]+t,c=Math.abs(s),u=Math.abs(l),m=Math.abs(i),T=Math.abs(o),d=Math.abs(n),_=Math.abs(a),E=.5*(1+Math.sign(s*o))*Math.min(c,T),S=.5*(1+Math.sign(l*n))*Math.min(u,d),D=.5*(1+Math.sign(i*a))*Math.min(m,_),P=Math.max(c,T),I=Math.max(u,d),N=Math.max(m,_),F=Math.sqrt(E*E+S*S+D*D),O=Math.sign(c+s),A=Math.sign(u+l),b=Math.sign(m+i),R=Math.sign(T+o),x=Math.sign(d+n),y=Math.sign(_+a),M=this._totalOffset;if(F<M)return e[0]-=(1-O)*M,e[1]-=(1-A)*M,e[2]-=(1-b)*M,e[3]+=R*M,e[4]+=x*M,e[5]+=y*M,e;let g=M/Math.sqrt(P*P+I*I+N*N),w=M/F,C=w-g,L=-C;return e[0]+=s*(O*L+w),e[1]+=l*(A*L+w),e[2]+=i*(b*L+w),e[3]+=o*(R*C+g),e[4]+=n*(x*C+g),e[5]+=a*(y*C+g),e}applyToMbs(e){let t=z(e),s=this._totalOffset/t;return re(this._tmpMbs,e,e,s),this._tmpMbs[3]=e[3]+e[3]*this._totalOffset/t,this._tmpMbs}applyToObb(e){return _r(e,this._totalOffset,this._totalOffset,ce.Global,this._tmpObb),this._tmpObb}},vt=class{constructor(e=0){this.offset=e,this.sphere=dt(),this.tmpVertex=B()}applyToVertex(e,t,s){let l=this.objectTransform.transform,i=te(bt,e,t,s),o=ye(i,i,l),n=this.offset/z(o);re(o,o,o,n);let a=this.objectTransform.inverse;return ye(this.tmpVertex,o,a),this.tmpVertex}applyToMinMax(e,t){let s=this.offset/z(e);re(e,e,e,s);let l=this.offset/z(t);re(t,t,t,l)}applyToAabb(e){let t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;let s=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*s,e[4]+=e[4]*s,e[5]+=e[5]*s,e}applyToBoundingSphere(e){let t=z(e),s=this.offset/t;return re(this.sphere,e,e,s),this.sphere[3]=e[3]+e[3]*this.offset/t,this.sphere}},as=new vt;function os(r){return r!=null?(as.offset=r,as):null}var Ao=new At;var vo=new _t;var bt=B(),is=B(),ks=B(),zs=B(),Hs=B();function ns(r,e,t){let{data:s,indices:l}=r,i=e.typedBuffer,o=e.typedBufferStride,n=l.length;t*=o;for(let a=0;a<n;++a){let c=2*l[a];i[t]=s[c],i[t+1]=s[c+1],t+=o}}function ls(r,e,t,s){let{data:l,indices:i}=r,o=e.typedBuffer,n=e.typedBufferStride,a=i.length;if(t*=n,s==null||s===1)for(let c=0;c<a;++c){let u=3*i[c];o[t]=l[u],o[t+1]=l[u+1],o[t+2]=l[u+2],t+=n}else for(let c=0;c<a;++c){let u=3*i[c];for(let m=0;m<s;++m)o[t]=l[u],o[t+1]=l[u+1],o[t+2]=l[u+2],t+=n}}function us(r,e,t,s=1){let{data:l,indices:i}=r,o=e.typedBuffer,n=e.typedBufferStride,a=i.length;if(t*=n,s===1)for(let c=0;c<a;++c){let u=4*i[c];o[t]=l[u],o[t+1]=l[u+1],o[t+2]=l[u+2],o[t+3]=l[u+3],t+=n}else for(let c=0;c<a;++c){let u=4*i[c];for(let m=0;m<s;++m)o[t]=l[u],o[t+1]=l[u+1],o[t+2]=l[u+2],o[t+3]=l[u+3],t+=n}}function qs(r,e,t,s,l=1){if(!e)return void ls(r,t,s,l);let{data:i,indices:o}=r,n=t.typedBuffer,a=t.typedBufferStride,c=o.length,u=e[0],m=e[1],T=e[2],d=e[4],_=e[5],E=e[6],S=e[8],D=e[9],P=e[10],I=e[12],N=e[13],F=e[14];s*=a;let O=0,A=0,b=0,R=lt(e)?x=>{O=i[x]+I,A=i[x+1]+N,b=i[x+2]+F}:x=>{let y=i[x],M=i[x+1],g=i[x+2];O=u*y+d*M+S*g+I,A=m*y+_*M+D*g+N,b=T*y+E*M+P*g+F};if(l===1)for(let x=0;x<c;++x)R(3*o[x]),n[s]=O,n[s+1]=A,n[s+2]=b,s+=a;else for(let x=0;x<c;++x){R(3*o[x]);for(let y=0;y<l;++y)n[s]=O,n[s+1]=A,n[s+2]=b,s+=a}}function Ws(r,e,t,s,l=1){if(!e)return void ls(r,t,s,l);let{data:i,indices:o}=r,n=e,a=t.typedBuffer,c=t.typedBufferStride,u=o.length,m=n[0],T=n[1],d=n[2],_=n[4],E=n[5],S=n[6],D=n[8],P=n[9],I=n[10],N=!nt(n),F=1e-6,O=1-F;s*=c;let A=0,b=0,R=0,x=lt(n)?y=>{A=i[y],b=i[y+1],R=i[y+2]}:y=>{let M=i[y],g=i[y+1],w=i[y+2];A=m*M+_*g+D*w,b=T*M+E*g+P*w,R=d*M+S*g+I*w};if(l===1)if(N)for(let y=0;y<u;++y){x(3*o[y]);let M=A*A+b*b+R*R;if(M<O&&M>F){let g=1/Math.sqrt(M);a[s]=A*g,a[s+1]=b*g,a[s+2]=R*g}else a[s]=A,a[s+1]=b,a[s+2]=R;s+=c}else for(let y=0;y<u;++y)x(3*o[y]),a[s]=A,a[s+1]=b,a[s+2]=R,s+=c;else for(let y=0;y<u;++y){if(x(3*o[y]),N){let M=A*A+b*b+R*R;if(M<O&&M>F){let g=1/Math.sqrt(M);A*=g,b*=g,R*=g}}for(let M=0;M<l;++M)a[s]=A,a[s+1]=b,a[s+2]=R,s+=c}}function js(r,e,t,s,l=1){if(!e)return void us(r,t,s,l);let{data:i,indices:o}=r,n=e,a=t.typedBuffer,c=t.typedBufferStride,u=o.length,m=n[0],T=n[1],d=n[2],_=n[4],E=n[5],S=n[6],D=n[8],P=n[9],I=n[10],N=!nt(n),F=1e-6,O=1-F;if(s*=c,l===1)for(let A=0;A<u;++A){let b=4*o[A],R=i[b],x=i[b+1],y=i[b+2],M=i[b+3],g=m*R+_*x+D*y,w=T*R+E*x+P*y,C=d*R+S*x+I*y;if(N){let L=g*g+w*w+C*C;if(L<O&&L>F){let $=1/Math.sqrt(L);g*=$,w*=$,C*=$}}a[s]=g,a[s+1]=w,a[s+2]=C,a[s+3]=M,s+=c}else for(let A=0;A<u;++A){let b=4*o[A],R=i[b],x=i[b+1],y=i[b+2],M=i[b+3],g=m*R+_*x+D*y,w=T*R+E*x+P*y,C=d*R+S*x+I*y;if(N){let L=g*g+w*w+C*C;if(L<O&&L>F){let $=1/Math.sqrt(L);g*=$,w*=$,C*=$}}for(let L=0;L<l;++L)a[s]=g,a[s+1]=w,a[s+2]=C,a[s+3]=M,s+=c}}function Xs(r,e,t,s,l=1){let{data:i,indices:o}=r,n=t.typedBuffer,a=t.typedBufferStride,c=o.length;if(s*=a,e!==i.length||e!==4)if(l!==1)if(e!==4)for(let u=0;u<c;++u){let m=3*o[u];for(let T=0;T<l;++T)n[s]=i[m],n[s+1]=i[m+1],n[s+2]=i[m+2],n[s+3]=255,s+=a}else for(let u=0;u<c;++u){let m=4*o[u];for(let T=0;T<l;++T)n[s]=i[m],n[s+1]=i[m+1],n[s+2]=i[m+2],n[s+3]=i[m+3],s+=a}else{if(e===4){for(let u=0;u<c;++u){let m=4*o[u];n[s]=i[m],n[s+1]=i[m+1],n[s+2]=i[m+2],n[s+3]=i[m+3],s+=a}return}for(let u=0;u<c;++u){let m=3*o[u];n[s]=i[m],n[s+1]=i[m+1],n[s+2]=i[m+2],n[s+3]=255,s+=a}}else{n[s]=i[0],n[s+1]=i[1],n[s+2]=i[2],n[s+3]=i[3];let u=new Uint32Array(t.typedBuffer.buffer,t.start),m=a/4,T=u[s/=4];s+=m;let d=c*l;for(let _=1;_<d;++_)u[s]=T,s+=m}}function Ks(r,e,t){let{data:s,indices:l}=r,i=e.typedBuffer,o=e.typedBufferStride,n=l.length,a=s[0];t*=o;for(let c=0;c<n;++c)i[t]=a,t+=o}function $s(r,e,t,s,l=1){let i=e.typedBuffer,o=e.typedBufferStride;if(s*=o,l===1)for(let n=0;n<t;++n)i[s]=r[0],i[s+1]=r[1],i[s+2]=r[2],i[s+3]=r[3],s+=o;else for(let n=0;n<t;++n)for(let a=0;a<l;++a)i[s]=r[0],i[s+1]=r[1],i[s+2]=r[2],i[s+3]=r[3],s+=o}function cs(r,e,t,s,l,i){for(let o of e.fields.keys()){let n=r.attributes.get(o),a=n?.indices;if(n&&a)Ys(o,n,t,s,l,i);else if(o===v.OBJECTANDLAYERIDCOLOR&&r.objectAndLayerIdColor!=null){let c=r.attributes.get(v.POSITION)?.indices;if(c){let u=c.length,m=l.getField(o,ve);$s(r.objectAndLayerIdColor,m,u,i)}}}}function Ys(r,e,t,s,l,i){switch(r){case v.POSITION:{V(e.size===3);let o=l.getField(r,Ae);V(!!o,`No buffer view for ${r}`),o&&qs(e,t,o,i);break}case v.NORMAL:{V(e.size===3);let o=l.getField(r,Ae);V(!!o,`No buffer view for ${r}`),o&&Ws(e,s,o,i);break}case v.NORMALCOMPRESSED:{V(e.size===2);let o=l.getField(r,Zt);V(!!o,`No buffer view for ${r}`),o&&ns(e,o,i);break}case v.UV0:{V(e.size===2);let o=l.getField(r,Kt);V(!!o,`No buffer view for ${r}`),o&&ns(e,o,i);break}case v.COLOR:case v.SYMBOLCOLOR:{let o=l.getField(r,ve);V(!!o,`No buffer view for ${r}`),V(e.size===3||e.size===4),!o||e.size!==3&&e.size!==4||Xs(e,e.size,o,i);break}case v.COLORFEATUREATTRIBUTE:{let o=l.getField(r,Xt);V(!!o,`No buffer view for ${r}`),V(e.size===1),o&&e.size===1&&Ks(e,o,i);break}case v.TANGENT:{V(e.size===4);let o=l.getField(r,Se);V(!!o,`No buffer view for ${r}`),o&&js(e,s,o,i);break}case v.PROFILERIGHT:case v.PROFILEUP:case v.PROFILEVERTEXANDNORMAL:case v.FEATUREVALUE:{V(e.size===4);let o=l.getField(r,Se);V(!!o,`No buffer view for ${r}`),o&&us(e,o,i)}}}var Ye=class{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.attributes.get(v.POSITION).indices.length}write(e,t,s,l,i){cs(s,this.vertexBufferLayout,e,t,l,i)}};var Do={func:Y.LESS},Vo={func:Y.ALWAYS},ms={mask:255};var hs={function:{func:Y.ALWAYS,ref:J.OutlineVisualElementMask,mask:J.OutlineVisualElementMask},operation:{fail:H.KEEP,zFail:H.KEEP,zPass:H.ZERO}},ps={function:{func:Y.ALWAYS,ref:J.OutlineVisualElementMask,mask:J.OutlineVisualElementMask},operation:{fail:H.KEEP,zFail:H.KEEP,zPass:H.REPLACE}},Fo={function:{func:Y.EQUAL,ref:J.OutlineVisualElementMask,mask:J.OutlineVisualElementMask},operation:{fail:H.KEEP,zFail:H.KEEP,zPass:H.KEEP}},Lo={function:{func:Y.NOTEQUAL,ref:J.OutlineVisualElementMask,mask:J.OutlineVisualElementMask},operation:{fail:H.KEEP,zFail:H.KEEP,zPass:H.KEEP}};function fs({normalTexture:r,metallicRoughnessTexture:e,metallicFactor:t,roughnessFactor:s,emissiveTexture:l,emissiveFactor:i,occlusionTexture:o}){return r==null&&e==null&&l==null&&(i==null||Wt(i,Gt))&&o==null&&(s==null||s===1)&&(t==null||t===1)}var Qe=[1,1,.5],ds=[0,.6,.2],gs=[0,1,.2];var Ze=class extends Lr{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=Ce(Qe),this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=q.Back,this.isInstanced=!1,this.hasInstancedColor=!1,this.emissiveFactor=Te(0,0,0),this.instancedDoublePrecision=!1,this.normalType=W.Attribute,this.receiveShadows=!0,this.receiveAmbientOcclusion=!0,this.castShadows=!0,this.shadowMappingEnabled=!1,this.ambient=Te(.2,.2,.2),this.diffuse=Te(.8,.8,.8),this.externalColor=jt(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=B(),this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.offsetTransparentBackfaces=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.modelTransformation=null,this.transparent=!1,this.writeDepth=!0,this.customDepthTest=ie.Less,this.textureAlphaMode=G.Blend,this.textureAlphaCutoff=.1,this.textureAlphaPremultiplied=!1,this.hasOccludees=!1,this.renderOccluded=wr.Occlude,this.isDecoration=!1}};var he=class r extends Nr{initializeConfiguration(e,t){t.spherical=e.viewingMode===ce.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result,t.textureCoordinateType=t.hasColorTexture||t.hasMetallicRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture||t.hasNormalTexture?Me.Default:Me.None,t.objectAndLayerIdColorInstanced=t.instanced}initializeProgram(e){return this._initializeProgram(e,r.shader)}_initializeProgram(e,t){return new Gr(e.rctx,t.get().build(this.configuration),br)}_convertDepthTestFunction(e){return e===ie.Lequal?Y.LEQUAL:Y.LESS}_makePipeline(e,t){let s=this.configuration,l=e===Ee.NONE,i=e===Ee.FrontFace;return Pr({blending:s.output!==k.Color&&s.output!==k.Alpha||!s.transparent?null:l?Br:Ir(e),culling:Zs(s)?Or(s.cullFace):null,depthTest:{func:Fr(e,this._convertDepthTestFunction(s.customDepthTest))},depthWrite:(l||i)&&s.writeDepth?Cr:null,colorWrite:Sr,stencilWrite:s.hasOccludees?ms:null,stencilTest:s.hasOccludees?t?ps:hs:null,polygonOffset:l||i?null:Vr(s.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._makePipeline(this.configuration.transparencyPassType,!0),this._makePipeline(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}};function Zs(r){return r.cullFace!==q.None||!r.hasSlicePlane&&!r.transparent&&!r.doubleSidedMode}he.shader=new je(kr,()=>import("./chunk-FGUF2RBF.js"));var pe=class extends Ur{};h([p({constValue:!0})],pe.prototype,"hasSliceHighlight",void 0),h([p({constValue:!1})],pe.prototype,"hasSliceInVertexProgram",void 0),h([p({constValue:ir.Pass})],pe.prototype,"pbrTextureBindType",void 0);var f=class extends pe{constructor(){super(...arguments),this.output=k.Color,this.alphaDiscardMode=G.Opaque,this.doubleSidedMode=Q.None,this.pbrMode=me.Disabled,this.cullFace=q.None,this.transparencyPassType=Ee.NONE,this.normalType=W.Attribute,this.textureCoordinateType=Me.None,this.customDepthTest=ie.Less,this.spherical=!1,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.vvSize=!1,this.vvColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instanced=!1,this.instancedColor=!1,this.objectAndLayerIdColorInstanced=!1,this.instancedDoublePrecision=!1,this.doublePrecisionRequiresObfuscation=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.cullAboveGround=!1,this.snowCover=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1}};h([p({count:k.COUNT})],f.prototype,"output",void 0),h([p({count:G.COUNT})],f.prototype,"alphaDiscardMode",void 0),h([p({count:Q.COUNT})],f.prototype,"doubleSidedMode",void 0),h([p({count:me.COUNT})],f.prototype,"pbrMode",void 0),h([p({count:q.COUNT})],f.prototype,"cullFace",void 0),h([p({count:Ee.COUNT})],f.prototype,"transparencyPassType",void 0),h([p({count:W.COUNT})],f.prototype,"normalType",void 0),h([p({count:Me.COUNT})],f.prototype,"textureCoordinateType",void 0),h([p({count:ie.COUNT})],f.prototype,"customDepthTest",void 0),h([p()],f.prototype,"spherical",void 0),h([p()],f.prototype,"hasVertexColors",void 0),h([p()],f.prototype,"hasSymbolColors",void 0),h([p()],f.prototype,"hasVerticalOffset",void 0),h([p()],f.prototype,"hasSlicePlane",void 0),h([p()],f.prototype,"hasSliceHighlight",void 0),h([p()],f.prototype,"hasColorTexture",void 0),h([p()],f.prototype,"hasMetallicRoughnessTexture",void 0),h([p()],f.prototype,"hasEmissionTexture",void 0),h([p()],f.prototype,"hasOcclusionTexture",void 0),h([p()],f.prototype,"hasNormalTexture",void 0),h([p()],f.prototype,"hasScreenSizePerspective",void 0),h([p()],f.prototype,"hasVertexTangents",void 0),h([p()],f.prototype,"hasOccludees",void 0),h([p()],f.prototype,"multipassEnabled",void 0),h([p()],f.prototype,"hasModelTransformation",void 0),h([p()],f.prototype,"offsetBackfaces",void 0),h([p()],f.prototype,"vvSize",void 0),h([p()],f.prototype,"vvColor",void 0),h([p()],f.prototype,"receiveShadows",void 0),h([p()],f.prototype,"receiveAmbientOcclusion",void 0),h([p()],f.prototype,"textureAlphaPremultiplied",void 0),h([p()],f.prototype,"instanced",void 0),h([p()],f.prototype,"instancedColor",void 0),h([p()],f.prototype,"objectAndLayerIdColorInstanced",void 0),h([p()],f.prototype,"instancedDoublePrecision",void 0),h([p()],f.prototype,"doublePrecisionRequiresObfuscation",void 0),h([p()],f.prototype,"writeDepth",void 0),h([p()],f.prototype,"transparent",void 0),h([p()],f.prototype,"enableOffset",void 0),h([p()],f.prototype,"cullAboveGround",void 0),h([p()],f.prototype,"snowCover",void 0),h([p()],f.prototype,"hasColorTextureTransform",void 0),h([p()],f.prototype,"hasEmissionTextureTransform",void 0),h([p()],f.prototype,"hasNormalTextureTransform",void 0),h([p()],f.prototype,"hasOcclusionTextureTransform",void 0),h([p()],f.prototype,"hasMetallicRoughnessTextureTransform",void 0),h([p({constValue:!1})],f.prototype,"occlusionPass",void 0),h([p({constValue:!0})],f.prototype,"hasVvInstancing",void 0),h([p({constValue:!1})],f.prototype,"useCustomDTRExponentForWater",void 0),h([p({constValue:!1})],f.prototype,"supportsTextureAtlas",void 0),h([p({constValue:!0})],f.prototype,"useFillLights",void 0);var De=class r extends he{initializeConfiguration(e,t){super.initializeConfiguration(e,t),t.hasMetallicRoughnessTexture=!1,t.hasEmissionTexture=!1,t.hasOcclusionTexture=!1,t.hasNormalTexture=!1,t.hasModelTransformation=!1,t.normalType=W.Attribute,t.doubleSidedMode=Q.WindingOrder,t.hasVertexTangents=!1}initializeProgram(e){return this._initializeProgram(e,r.shader)}};De.shader=new je(zr,()=>import("./chunk-7D7EL4GU.js"));var le=class extends Rr{constructor(e){super(e,Js),this.supportsEdges=!0,this.produces=new Map([[We.OPAQUE_MATERIAL,t=>(qe(t)||He(t))&&!this.parameters.transparent],[We.TRANSPARENT_MATERIAL,t=>(qe(t)||He(t))&&this.parameters.transparent&&this.parameters.writeDepth],[We.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,t=>(qe(t)||He(t))&&this.parameters.transparent&&!this.parameters.writeDepth]]),this._configuration=new f,this._vertexBufferLayout=ea(this.parameters)}isVisibleForOutput(e){return e!==k.Shadow&&e!==k.ShadowExcludeHighlight&&e!==k.ShadowHighlight||this.parameters.castShadows}isVisible(){let e=this.parameters;if(!super.isVisible()||e.layerOpacity===0)return!1;let{hasInstancedColor:t,hasVertexColors:s,hasSymbolColors:l,vvColor:i}=e,o=e.colorMixMode==="replace",n=e.opacity>0,a=e.externalColor&&e.externalColor[3]>0,c=t||i||l;return s&&c?o||n:s?o?a:n:c?o||n:o?a:n}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=this.parameters.isInstanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType=this.parameters.normalType,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this.parameters.customDepthTest!=null&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?q.None:this.parameters.cullFace,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=this.parameters.modelTransformation!=null,e!==k.Color&&e!==k.Alpha||(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=Q.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?Q.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?Q.WindingOrder:Q.None,this._configuration.instancedColor=this.parameters.hasInstancedColor,this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=this.parameters.receiveAmbientOcclusion&&t.ssao!=null,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?me.Schematic:me.Normal:me.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Dr,this._configuration.snowCover=this.hasSnowCover(t),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration}hasSnowCover(e){return e.weather!=null&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}intersect(e,t,s,l,i,o){if(this.parameters.verticalOffset!=null){let n=s.camera;te(Et,t[12],t[13],t[14]);let a=null;switch(s.viewingMode){case ce.Global:a=Le(Ts,Et);break;case ce.Local:a=Ut(Ts,sa)}let c=0,u=xe(aa,Et,n.eye),m=z(u),T=ot(u,u,1/m),d=null;this.parameters.screenSizePerspective&&(d=zt(a,T)),c+=Er(n,m,this.parameters.verticalOffset,d??0,this.parameters.screenSizePerspective),ot(a,a,c),qt(Mt,a,s.transform.inverseRotation),l=xe(ta,l,Mt),i=xe(ra,i,Mt)}Mr(e,s,l,i,os(s.verticalOffset),o)}createGLMaterial(e){return new Rt(e)}createBufferWriter(){return new Ye(this._vertexBufferLayout)}},Rt=class extends vr{constructor(e){super(j(j({},e),e.material.parameters))}_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==k.Color&&this._output!==k.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e));let t=this._material.parameters;this.updateTexture(t.textureId);let s=e.camera.viewInverseTransposeMatrix;return te(t.origin,s[3],s[7],s[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(t.treeRendering?De:he,e)}},wt=class extends Ze{constructor(){super(...arguments),this.initTextureTransparent=!1,this.treeRendering=!1,this.hasVertexTangents=!1}},Js=new wt;function ea(r){let e=er().vec3f(v.POSITION);return r.normalType===W.Compressed?e.vec2i16(v.NORMALCOMPRESSED,{glNormalized:!0}):e.vec3f(v.NORMAL),r.hasVertexTangents&&e.vec4f(v.TANGENT),(r.textureId||r.normalTextureId||r.metallicRoughnessTextureId||r.emissiveTextureId||r.occlusionTextureId)&&e.vec2f(v.UV0),r.hasVertexColors&&e.vec4u8(v.COLOR),r.hasSymbolColors&&e.vec4u8(v.SYMBOLCOLOR),Ot("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(v.OBJECTANDLAYERIDCOLOR),e}var ta=B(),ra=B(),sa=Te(0,0,1),Ts=B(),Mt=B(),Et=B(),aa=B();var ee=()=>Fe.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");function xs(r,e){return U(this,null,function*(){let t=yield oa(r,e),s=yield ua(t.textureDefinitions??{},e),l=0;for(let i in s)if(s.hasOwnProperty(i)){let o=s[i];l+=o?.image?o.image.width*o.image.height*4:0}return{resource:t,textures:s,size:l+Ct(t)}})}function oa(r,e){return U(this,null,function*(){let t=e?.streamDataRequester;if(t)return ia(r,t,e);let s=yield st(Nt(r,e));if(s.ok===!0)return s.value.data;tt(s.error),ys(s.error)})}function ia(r,e,t){return U(this,null,function*(){let s=yield st(e.request(r,"json",t));if(s.ok===!0)return s.value;tt(s.error),ys(s.error.details.url)})}function ys(r){throw new ge("",`Request for object resource failed: ${r}`)}function na(r){let e=r.params,t=e.topology,s=!0;switch(e.vertexAttributes||(ee().warn("Geometry must specify vertex attributes"),s=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{let i=e.faces;if(i){if(e.vertexAttributes)for(let o in e.vertexAttributes){let n=i[o];n?.values?(n.valueType!=null&&n.valueType!=="UInt32"&&(ee().warn(`Unsupported indexed geometry indices type '${n.valueType}', only UInt32 is currently supported`),s=!1),n.valuesPerElement!=null&&n.valuesPerElement!==1&&(ee().warn(`Unsupported indexed geometry values per element '${n.valuesPerElement}', only 1 is currently supported`),s=!1)):(ee().warn(`Indexed geometry does not specify face indices for '${o}' attribute`),s=!1)}}else ee().warn("Indexed geometries must specify faces"),s=!1;break}default:ee().warn(`Unsupported topology '${t}'`),s=!1}r.params.material||(ee().warn("Geometry requires material"),s=!1);let l=r.params.vertexAttributes;for(let i in l)l[i].values||(ee().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function _s(r,e){let t=new Array,s=new Array,l=new Array,i=new Ar,o=r.resource,n=pt.parse(o.version||"1.0","wosr");ma.validate(n);let a=o.model.name,c=o.model.geometries,u=o.materialDefinitions??{},m=r.textures,T=0,d=new Map;for(let _=0;_<c.length;_++){let E=c[_];if(!na(E))continue;let S=ca(E),D=E.params.vertexAttributes,P=[],I=g=>{if(E.params.topology==="PerAttributeArray")return null;let w=E.params.faces;for(let C in w)if(C===g)return w[C].values;return null},N=D[v.POSITION],F=N.values.length/N.valuesPerElement;for(let g in D){let w=D[g],C=w.values,L=I(g)??tr(F);P.push([g,new oe(C,L,w.valuesPerElement,!0)])}let O=S.texture,A=m&&m[O];if(A&&!d.has(O)){let{image:g,parameters:w}=A,C=new we(g,w);s.push(C),d.set(O,C)}let b=d.get(O),R=b?b.id:void 0,x=S.material,y=i.get(x,O);if(y==null){let g=u[x.substring(x.lastIndexOf("/")+1)].params;g.transparency===1&&(g.transparency=0);let w=A&&A.alphaChannelUsage,C=g.transparency>0||w==="transparency"||w==="maskAndTransparency",L=A?As(A.alphaChannelUsage):void 0,$={ambient:Ce(g.diffuse),diffuse:Ce(g.diffuse),opacity:1-(g.transparency||0),transparent:C,textureAlphaMode:L,textureAlphaCutoff:.33,textureId:R,initTextureTransparent:!0,doubleSided:!0,cullFace:q.None,colorMixMode:g.externalColorMixMode||"tint",textureAlphaPremultiplied:A?.parameters.preMultiplyAlpha??!1};e?.materialParameters&&Object.assign($,e.materialParameters),y=new le($),i.set(x,O,y)}l.push(y);let M=new Ue(y,P);T+=P.find(g=>g[0]===v.POSITION)?.[1]?.indices.length??0,t.push(M)}return{engineResources:[{name:a,stageResources:{textures:s,materials:l,geometries:t},pivotOffset:o.model.pivotOffset,numberOfVertices:T,lodThreshold:null}],referenceBoundingBox:la(t)}}function la(r){let e=Ne();return r.forEach(t=>{let s=t.boundingInfo;s!=null&&(_e(e,s.bbMin),_e(e,s.bbMax))}),e}function ua(r,e){return U(this,null,function*(){let t=new Array;for(let i in r){let o=r[i],n=o.images[0].data;if(!n){ee().warn("Externally referenced texture data is not yet supported");continue}let a=o.encoding+";base64,"+n,c="/textureDefinitions/"+i,u=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",m={noUnpackFlip:!0,wrap:{s:ue.REPEAT,t:ue.REPEAT},preMultiplyAlpha:As(u)!==G.Opaque},T=e!=null&&e.disableTextures?Promise.resolve(null):ze(a,e);t.push(T.then(d=>({refId:c,image:d,parameters:m,alphaChannelUsage:u})))}let s=yield Promise.all(t),l={};for(let i of s)l[i.refId]=i;return l})}function As(r){switch(r){case"mask":return G.Mask;case"maskAndTransparency":return G.MaskBlend;case"none":return G.Opaque;default:return G.Blend}}function ca(r){let e=r.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}var ma=new pt(1,2,"wosr");function rl(r,e){return U(this,null,function*(){let t=ha(ur(r));if(t.fileType==="wosr"){let m=yield e.cache?e.cache.loadWOSR(t.url,e):xs(t.url,e),{engineResources:T,referenceBoundingBox:d}=_s(m,e);return{lods:T,referenceBoundingBox:d,isEsriSymbolResource:!1,isWosr:!0}}let s=yield e.cache?e.cache.loadGLTF(t.url,e,!!e.usePBR):Tr(new gr(e.streamDataRequester),t.url,e,e.usePBR),l=s.model.meta?.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&l!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,Ta(s,l));let o=!!e.usePBR,n=s.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:i,mrrFactors:[...gs]}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:[...Qe]},a=Ve(j({},e.materialParameters),{treeRendering:i}),{engineResources:c,referenceBoundingBox:u}=pa(s,n,a,e.skipHighLods&&t.specifiedLodIndex==null?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:t.specifiedLodIndex});return{lods:c,referenceBoundingBox:u,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}})}function ha(r){let e=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function pa(r,e,t,s){let l=r.model,i=new Array,o=new Map,n=new Map,a=l.lods.length,c=Ne();return l.lods.forEach((u,m)=>{let T=s.skipHighLods===!0&&(a>1&&m===0||a>3&&m===1)||s.skipHighLods===!1&&s.singleLodIndex!=null&&m!==s.singleLodIndex;if(T&&m!==0)return;let d=new Xe(u.name,u.lodThreshold,[0,0,0]);u.parts.forEach(_=>{let E=T?new le({}):fa(l,_,d,e,t,o,n),{geometry:S,vertexCount:D}=da(_,E??new le({})),P=S.boundingInfo;P!=null&&m===0&&(_e(c,P.bbMin),_e(c,P.bbMax)),E!=null&&(d.stageResources.geometries.push(S),d.numberOfVertices+=D)}),T||i.push(d)}),{engineResources:i,referenceBoundingBox:c}}function fa(r,e,t,s,l,i,o){let n=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),a=r.materials.get(e.material),c=e.attributes.texCoord0!=null,u=e.attributes.normal!=null;if(a==null)return null;let m=ga(a.alphaMode);if(!i.has(n)){if(c){let O=(A,b=!1)=>{if(A!=null&&!o.has(A)){let R=r.textures.get(A);if(R!=null){let x=R.data;o.set(A,new we(ke(x)?x.data:x,Ve(j({},R.parameters),{preMultiplyAlpha:!ke(x)&&b,encoding:ke(x)&&x.encoding!=null?x.encoding:void 0})))}}};O(a.textureColor,m!==G.Opaque),O(a.textureNormal),O(a.textureOcclusion),O(a.textureEmissive),O(a.textureMetallicRoughness)}let d=a.color[0]**(1/2.1),_=a.color[1]**(1/2.1),E=a.color[2]**(1/2.1),S=a.emissiveFactor[0]**(1/2.1),D=a.emissiveFactor[1]**(1/2.1),P=a.emissiveFactor[2]**(1/2.1),I=a.textureColor!=null&&c?o.get(a.textureColor):null,N=fs({normalTexture:a.textureNormal,metallicRoughnessTexture:a.textureMetallicRoughness,metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor,emissiveTexture:a.textureEmissive,emissiveFactor:a.emissiveFactor,occlusionTexture:a.textureOcclusion}),F=a.normalTextureTransform?.scale!=null?a.normalTextureTransform?.scale:Jt;i.set(n,new le(j(Ve(j({},s),{transparent:m===G.Blend,customDepthTest:ie.Lequal,textureAlphaMode:m,textureAlphaCutoff:a.alphaCutoff,diffuse:[d,_,E],ambient:[d,_,E],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",cullFace:a.doubleSided?q.None:q.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:u?W.Attribute:W.ScreenDerivative,castShadows:!0,receiveShadows:a.receiveShadows,receiveAmbientOcclusion:a.receiveAmbientOcclustion,textureId:I?.id,colorMixMode:a.colorMixMode,normalTextureId:a.textureNormal!=null&&c?o.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:I!=null&&!!I.parameters.preMultiplyAlpha,occlusionTextureId:a.textureOcclusion!=null&&c?o.get(a.textureOcclusion).id:void 0,emissiveTextureId:a.textureEmissive!=null&&c?o.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:a.textureMetallicRoughness!=null&&c?o.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[S,D,P],mrrFactors:N?[...ds]:[a.metallicFactor,a.roughnessFactor,s.mrrFactors[2]],isSchematic:N,colorTextureTransformMatrix:Re(a.colorTextureTransform),normalTextureTransformMatrix:Re(a.normalTextureTransform),scale:[F[0],F[1]],occlusionTextureTransformMatrix:Re(a.occlusionTextureTransform),emissiveTextureTransformMatrix:Re(a.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:Re(a.metallicRoughnessTextureTransform)}),l)))}let T=i.get(n);if(t.stageResources.materials.push(T),c){let d=_=>{_!=null&&t.stageResources.textures.push(o.get(_))};d(a.textureColor),d(a.textureNormal),d(a.textureOcclusion),d(a.textureEmissive),d(a.textureMetallicRoughness)}return T}function da(r,e){let t=r.attributes.position.count,s=xr(r.indices||t,r.primitiveType),l=Pe(3*t),{typedBuffer:i,typedBufferStride:o}=r.attributes.position;rr(l,i,r.transform,3,o);let n=[[v.POSITION,new oe(l,s,3,!0)]];if(r.attributes.normal!=null){let a=Pe(3*t),{typedBuffer:c,typedBufferStride:u}=r.attributes.normal;ht(Je,r.transform),sr(a,c,Je,3,u),n.push([v.NORMAL,new oe(a,s,3,!0)])}if(r.attributes.tangent!=null){let a=Pe(4*t),{typedBuffer:c,typedBufferStride:u}=r.attributes.tangent;ht(Je,r.transform),hr(a,c,Je,4,u),n.push([v.TANGENT,new oe(a,s,4,!0)])}if(r.attributes.texCoord0!=null){let a=Pe(2*t),{typedBuffer:c,typedBufferStride:u}=r.attributes.texCoord0;pr(a,c,2,u),n.push([v.UV0,new oe(a,s,2,!0)])}if(r.attributes.color!=null){let a=new Uint8Array(4*t);r.attributes.color.elementCount===4?r.attributes.color instanceof Se?ft(a,r.attributes.color,255):r.attributes.color instanceof ve?dr(a,r.attributes.color):r.attributes.color instanceof Qt&&ft(a,r.attributes.color,1/256):(a.fill(255),r.attributes.color instanceof Ae?ut(a,r.attributes.color,255,4):r.attributes.color instanceof $t?fr(a,r.attributes.color.typedBuffer,4,r.attributes.color.typedBufferStride):r.attributes.color instanceof Yt&&ut(a,r.attributes.color,1/256,4)),n.push([v.COLOR,new oe(a,s,4,!0)])}return{geometry:new Ue(e,n),vertexCount:t}}var Je=Be();function ga(r){switch(r){case"BLEND":return G.Blend;case"MASK":return G.Mask;case"OPAQUE":case null:case void 0:return G.Opaque}}function Ta(r,e){for(let t=0;t<r.model.lods.length;++t){let s=r.model.lods[t];for(let l of s.parts){let i=l.attributes.normal;if(i==null)return;let o=l.attributes.position,n=o.count,a=B(),c=B(),u=B(),m=new Uint8Array(4*n),T=new Float64Array(3*n),d=it(ct(),l.transform),_=0,E=0;for(let S=0;S<n;S++){o.getVec(S,c),i.getVec(S,a),ye(c,c,l.transform),xe(u,c,e.center),at(u,u,e.radius);let D=u[2],P=z(u),I=Math.min(.45+.55*P*P,1);at(u,u,e.radius),d!==null&&ye(u,u,d),Le(u,u),t+1!==r.model.lods.length&&r.model.lods.length>1&&Ht(u,u,a,D>-1?.2:Math.min(-4*D-3.8,1)),T[_]=u[0],T[_+1]=u[1],T[_+2]=u[2],_+=3,m[E]=255*I,m[E+1]=255*I,m[E+2]=255*I,m[E+3]=255,E+=4}l.attributes.normal=new Ae(T),l.attributes.color=new ve(m)}}}export{rl as fetch,pa as gltfToEngineResources,ha as parseUrl};
