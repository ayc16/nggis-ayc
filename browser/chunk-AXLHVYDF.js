import{a as g,b as v}from"./chunk-XAHD7XBV.js";import{b as R,c as B,d as V}from"./chunk-VOXN5EXG.js";import{a as k,b as U,c as J,d as N}from"./chunk-6SLEAPTS.js";import{a as T}from"./chunk-PYUETFC3.js";import"./chunk-YQNUGDFH.js";import"./chunk-SDUXSXKH.js";import"./chunk-H5IJXG2U.js";import"./chunk-CLDJAOGN.js";import{d as F}from"./chunk-YIRBKWRK.js";import{a as C}from"./chunk-IFFYADB3.js";import"./chunk-BVW6ULEA.js";import"./chunk-7C6Z24SS.js";import"./chunk-XHOTVM3O.js";import"./chunk-2XAYS5PW.js";import"./chunk-MFP2OFDR.js";import"./chunk-2EA2KAER.js";import"./chunk-V5AJXD2Y.js";import{l as x}from"./chunk-3IJY37BG.js";import"./chunk-SAOUSUZE.js";import"./chunk-K5NHJTKR.js";import"./chunk-XKXYUJUA.js";import"./chunk-Z5Q76SB7.js";import"./chunk-E5R4OI7X.js";import"./chunk-6FWNINU2.js";import{G as O}from"./chunk-ES7AH7WX.js";import"./chunk-RSDQHAJX.js";import{b as y}from"./chunk-UE2YGKE7.js";import"./chunk-BE76S5KT.js";import"./chunk-FIITBHDP.js";import"./chunk-VSVNPPHQ.js";import"./chunk-CTGIUUCS.js";import"./chunk-VWEBO6QK.js";import"./chunk-KAAR5ZJN.js";import"./chunk-W3WDPWBE.js";import"./chunk-WKT5W7KT.js";import"./chunk-MLSR6YE6.js";import"./chunk-JPDAKIWT.js";import"./chunk-X3IDZTNG.js";import{p as S,t as D}from"./chunk-IQJU4QT3.js";import"./chunk-EAH6BNBL.js";function _(c,t,l,a){let{rendererJSON:u,isRGBRenderer:b}=c,o=null,i=null;if(t&&b)o=t;else if(t&&u?.type==="pointCloudUniqueValueRenderer"){i=V.fromJSON(u);let e=i.colorUniqueValueInfos;o=new Uint8Array(3*a);let s=I(i.fieldTransformType);for(let r=0;r<a;r++){let f=(s?s(t[r]):t[r])+"";for(let n=0;n<e.length;n++)if(e[n].values.includes(f)){o[3*r]=e[n].color.r,o[3*r+1]=e[n].color.g,o[3*r+2]=e[n].color.b;break}}}else if(t&&u?.type==="pointCloudStretchRenderer"){i=B.fromJSON(u);let e=i.stops;o=new Uint8Array(3*a);let s=I(i.fieldTransformType);for(let r=0;r<a;r++){let f=s?s(t[r]):t[r],n=e.length-1;if(f<e[0].value)o[3*r]=e[0].color.r,o[3*r+1]=e[0].color.g,o[3*r+2]=e[0].color.b;else if(f>=e[n].value)o[3*r]=e[n].color.r,o[3*r+1]=e[n].color.g,o[3*r+2]=e[n].color.b;else for(let m=1;m<e.length;m++)if(f<e[m].value){let p=(f-e[m-1].value)/(e[m].value-e[m-1].value);o[3*r]=e[m].color.r*p+e[m-1].color.r*(1-p),o[3*r+1]=e[m].color.g*p+e[m-1].color.g*(1-p),o[3*r+2]=e[m].color.b*p+e[m-1].color.b*(1-p);break}}}else if(t&&u?.type==="pointCloudClassBreaksRenderer"){i=R.fromJSON(u);let e=i.colorClassBreakInfos;o=new Uint8Array(3*a);let s=I(i.fieldTransformType);for(let r=0;r<a;r++){let f=s?s(t[r]):t[r];for(let n=0;n<e.length;n++)if(f>=e[n].minValue&&f<=e[n].maxValue){o[3*r]=e[n].color.r,o[3*r+1]=e[n].color.g,o[3*r+2]=e[n].color.b;break}}}else o=new Uint8Array(3*a).fill(255);if(l&&i?.colorModulation){let e=i.colorModulation.minValue,s=i.colorModulation.maxValue,r=.3;for(let f=0;f<a;f++){let n=l[f],m=n>=s?1:n<=e?r:r+(1-r)*(n-e)/(s-e);o[3*f]=m*o[3*f],o[3*f+1]=m*o[3*f+1],o[3*f+2]=m*o[3*f+2]}}return o}function q(c,t){if(c.encoding==null||c.encoding===""){let l=J(t,c);if(l.vertexAttributes.position==null)return;let a=U(t,l.vertexAttributes.position),u=l.header.fields,b=[u.offsetX,u.offsetY,u.offsetZ],o=[u.scaleX,u.scaleY,u.scaleZ],i=a.length/3,e=new Float64Array(3*i);for(let s=0;s<i;s++)e[3*s]=a[3*s]*o[0]+b[0],e[3*s+1]=a[3*s+1]*o[1]+b[1],e[3*s+2]=a[3*s+2]*o[2]+b[2];return e}if(c.encoding==="lepcc-xyz")return k(t).result}function d(c,t,l){return c?.attributeInfo.useElevation?t?z(t,l):null:c?.attributeInfo.storageInfo?N(c.attributeInfo.storageInfo,c.buffer,l):null}function z(c,t){let l=new Float64Array(t);for(let a=0;a<t;a++)l[a]=c[3*a+2];return l}function E(c,t,l,a,u){let b=c.length/3,o=0;for(let i=0;i<b;i++){let e=!0;for(let s=0;s<a.length&&e;s++){let{filterJSON:r}=a[s],f=u[s].values[i];switch(r.type){case"pointCloudValueFilter":{let n=r.mode==="exclude";r.values.includes(f)===n&&(e=!1);break}case"pointCloudBitfieldFilter":{let n=P(r.requiredSetBits),m=P(r.requiredClearBits);(f&n)===n&&!(f&m)||(e=!1);break}case"pointCloudReturnFilter":{let n=15&f,m=f>>>4&15,p=m>1,j=n===1,w=n===m,M=!1;for(let h of r.includedReturns)if(h==="last"&&w||h==="firstOfMany"&&j&&p||h==="lastOfMany"&&w&&p||h==="single"&&!p){M=!0;break}M||(e=!1);break}}}e&&(l[o]=i,c[3*o]=c[3*i],c[3*o+1]=c[3*i+1],c[3*o+2]=c[3*i+2],t[3*o]=t[3*i],t[3*o+1]=t[3*i+1],t[3*o+2]=t[3*i+2],o++)}return o}function I(c){switch(c){default:case null:case"none":return t=>t;case"low-four-bit":return t=>15&t;case"high-four-bit":return t=>(240&t)>>4;case"absolute-value":return t=>Math.abs(t);case"modulo-ten":return t=>t%10}}function P(c){let t=0;for(let l of c||[])t|=1<<l;return t}var A=class{transform(t){let l=this._transform(t),a=[l.points.buffer,l.rgb.buffer];l.pointIdFilterMap!=null&&a.push(l.pointIdFilterMap.buffer);for(let u of l.attributes)"buffer"in u.values&&D(u.values.buffer)&&u.values.buffer!==l.rgb.buffer&&a.push(u.values.buffer);return Promise.resolve({result:l,transferList:a})}_transform(t){let l=q(t.schema,t.geometryBuffer),a=l.length/3,u=null,b=new Array,o=d(t.primaryAttributeData,l,a);t.primaryAttributeData!=null&&o&&b.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:o});let i=d(t.modulationAttributeData,l,a);t.modulationAttributeData!=null&&i&&b.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:i});let e=_(t.rendererInfo,o,i,a);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){let r=t.filterAttributesData.filter(S).map(f=>{let n=d(f,l,a),m={attributeInfo:f.attributeInfo,values:n};return b.push(m),m});u=new Uint32Array(a),a=E(l,e,u,t.filterInfo,r)}for(let r of t.userAttributesData){let f=d(r,l,a);b.push({attributeInfo:r.attributeInfo,values:f})}3*a<e.length&&(e=new Uint8Array(e.buffer.slice(0,3*a))),this._applyElevationOffsetInPlace(l,a,t.elevationOffset);let s=this._transformCoordinates(l,a,T.fromData(t.obbData),y.fromJSON(t.inSR),y.fromJSON(t.outSR));return{obbData:t.obbData,points:s,rgb:e,attributes:b,pointIdFilterMap:u}}_transformCoordinates(t,l,a,u,b){if(!x(t,u,0,t,b,0,l))throw new Error("Can't reproject");let o=v(a.center),i=g(),e=g(),s=v(a.halfSize);F(G,a.quaternion);let r=new Float32Array(3*l);for(let f=0;f<l;f++){let n=3*f;i[0]=t[n]-o[0],i[1]=t[n+1]-o[1],i[2]=t[n+2]-o[2],O(e,i,G),s[0]=Math.max(s[0],Math.abs(e[0])),s[1]=Math.max(s[1],Math.abs(e[1])),s[2]=Math.max(s[2],Math.abs(e[2])),r[n++]=i[0],r[n++]=i[1],r[n]=i[2]}return a.halfSize=s,r}_applyElevationOffsetInPlace(t,l,a){if(a!==0)for(let u=0;u<l;u++)t[3*u+2]+=a}},G=C();function st(){return new A}export{st as default};
