import{C as v,G as T,c as g,d as N,z as P}from"./chunk-JIFV566L.js";import{a as G}from"./chunk-VAIXCJGK.js";import{a as w}from"./chunk-MFP2OFDR.js";import{d as E}from"./chunk-KYP6LPQU.js";import{c as O,d as h,e as k,f as S}from"./chunk-6ZT4EXDX.js";import{b as y,p as d,r as x}from"./chunk-X3IDZTNG.js";import{a as f,b as m,h as u}from"./chunk-EAH6BNBL.js";function F(o,e,r,t,s){if(o==null)return null;let i=o.referencesGeometry()&&s?R(e,t,s):e,n=o.repurposeFeature(i);try{return o.evaluate(m(f({},r),{$feature:n}),o.services)}catch(a){return d.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}var b=new Map;function R(o,e,r){let{transform:t,hasZ:s,hasM:i}=r;b.has(e)||b.set(e,A(e));let n=b.get(e)(o.geometry,t,s,i);return m(f({},o),{geometry:n})}function A(o){let e={};switch(o){case"esriGeometryPoint":return(r,t,s,i)=>h(t,e,r,s,i);case"esriGeometryPolygon":return(r,t,s,i)=>k(t,e,r,s,i);case"esriGeometryPolyline":return(r,t,s,i)=>S(t,e,r,s,i);case"esriGeometryMultipoint":return(r,t,s,i)=>O(t,e,r,s,i);default:return d.getLogger("esri.views.2d.support.arcadeOnDemand").error(new x("mapview-arcade",`Unable to handle geometryType: ${o}`)),r=>r}}var L=o=>{if(!o)return[0,0,0,0];let{r:e,g:r,b:t,a:s}=o;return[e,r,t,255*s]},M=class o{static findApplicableOverrides(e,r,t){if(e&&r){if(e.primitiveName){let s=!1;for(let i of t)if(i.primitiveName===e.primitiveName){s=!0;break}if(!s)for(let i of r)i.primitiveName===e.primitiveName&&t.push(i)}switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(e.effects)for(let s of e.effects)o.findApplicableOverrides(s,r,t);if(e.symbolLayers)for(let s of e.symbolLayers)o.findApplicableOverrides(s,r,t);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(e.effects)for(let s of e.effects)o.findApplicableOverrides(s,r,t);if(e.markerPlacement&&o.findApplicableOverrides(e.markerPlacement,r,t),e.type==="CIMVectorMarker"){if(e.markerGraphics)for(let s of e.markerGraphics)o.findApplicableOverrides(s,r,t),o.findApplicableOverrides(s.symbol,r,t)}else e.type==="CIMCharacterMarker"?o.findApplicableOverrides(e.symbol,r,t):e.type==="CIMHatchFill"?o.findApplicableOverrides(e.lineSymbol,r,t):e.type==="CIMPictureMarker"&&o.findApplicableOverrides(e.animatedSymbolProperties,r,t)}}}static findEffectOverrides(e,r){if(!e)return null;if(e.type==="CIMGeometricEffectDashes"&&T(e),!r||!e.primitiveName)return{type:"cim-effect-info",effect:e,overrides:[]};let t=e.primitiveName,s=[];for(let i of r)i.primitiveName===t&&s.push(m(f({},i),{propertyName:v(i.propertyName)}));return{type:"cim-effect-info",effect:e,overrides:s}}static resolveSymbolOverrides(e,r,t,s,i,n,a){return u(this,null,function*(){if(!e?.symbol)return null;let{symbol:l,primitiveOverrides:c}=e,C=!!c;if(!C&&!s)return l;l=y(l),c=y(c);let I=!0;if(r||(r={attributes:{}},I=!1),C){if(I||(c=c.filter(p=>!p.valueExpressionInfo?.expression.includes("$feature"))),a||(c=c.filter(p=>!p.valueExpressionInfo?.expression.includes("$view"))),c.length>0){let p={spatialReference:t,fields:P(r.attributes),geometryType:i};yield o.createRenderExpressions(c,p),o.evaluateOverrides(c,r,i??"esriGeometryPoint",n,a)}o.applyOverrides(l,c)}return s&&o.applyDictionaryTextOverrides(l,r,s,null),l})}static createRenderExpressions(e,r){return u(this,null,function*(){let t=[];for(let s of e){let i=s.valueExpressionInfo;if(!i||o._expressionToRenderExpression.has(i.expression))continue;let n=E(i.expression,r.spatialReference,r.fields);t.push(n),n.then(a=>o._expressionToRenderExpression.set(i.expression,a))}t.length>0&&(yield Promise.all(t))})}static evaluateOverrides(e,r,t,s,i){let n={$view:{scale:i?.scale}};for(let a of e){a.value&&typeof a.value=="object"&&G(a.value)&&(a.propertyName==="Color"||a.propertyName==="StrokeColor")&&(a.value=L(a.value));let l=a.valueExpressionInfo;if(!l)continue;let c=o._expressionToRenderExpression.get(l.expression);c&&(a.value=F(c,r,n,t,s))}}static applyDictionaryTextOverrides(e,r,t,s,i="Normal"){if(e?.type)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":case"CIMTextSymbol":{let n=e.symbolLayers;if(!n)return;for(let a of n)a&&a.type==="CIMVectorMarker"&&o.applyDictionaryTextOverrides(a,r,t,s,e.type==="CIMTextSymbol"?e.textCase:i)}break;case"CIMVectorMarker":{let n=e.markerGraphics;if(!n)return;for(let a of n)a&&o.applyDictionaryTextOverrides(a,r,t,s)}break;case"CIMMarkerGraphic":{let n=e.textString;if(n&&n.includes("[")){let a=g(n,t);e.textString=N(r,a,s,i)}}}}static applyOverrides(e,r,t,s){if(e.primitiveName){for(let i of r)if(i.primitiveName===e.primitiveName){let n=v(i.propertyName);if(s&&s.push({cim:e,nocapPropertyName:n,value:e[n]}),t){let a=!1;for(let l of t)l.primitiveName===e.primitiveName&&(a=!0);a||t.push(i)}i.value!=null&&(e[n]=i.value)}}switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(e.effects)for(let i of e.effects)o.applyOverrides(i,r,t,s);if(e.symbolLayers)for(let i of e.symbolLayers)o.applyOverrides(i,r,t,s);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(e.effects)for(let i of e.effects)o.applyOverrides(i,r,t,s);if(e.type==="CIMVectorMarker"&&e.markerGraphics)for(let i of e.markerGraphics)o.applyOverrides(i,r,t,s),o.applyOverrides(i.symbol,r,t,s)}}static restoreOverrides(e){for(let r of e)r.cim[r.nocapPropertyName]=r.value}static buildOverrideKey(e){let r="";for(let t of e)t.value!==void 0&&(r+=`${t.primitiveName}${t.propertyName}${JSON.stringify(t.value)}`);return r}static toValue(e,r){if(e==="DashTemplate")return r.split(" ").map(t=>Number(t));if(e==="Color"){let t=new w(r).toRgba();return t[3]*=255,t}return r}};M._expressionToRenderExpression=new Map;export{M as a};
