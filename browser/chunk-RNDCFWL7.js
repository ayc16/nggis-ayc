import{c as L}from"./chunk-V2KSICSA.js";import{a as A}from"./chunk-T4B3RN6B.js";import{_ as U}from"./chunk-CTGIUUCS.js";import{S}from"./chunk-KAAR5ZJN.js";import{a as w}from"./chunk-W3WDPWBE.js";import{z as j}from"./chunk-WKT5W7KT.js";import{b as c}from"./chunk-X3IDZTNG.js";import{h as F}from"./chunk-EAH6BNBL.js";var C=L(),g=new Map,H=new Map;function q(e,i,o){return F(this,null,function*(){if(!e||!o)return!1;if(!i)return!0;let n=new URL(e).host,r=g.get(n);if(!r){let t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");r=(yield U(t,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return r===i})}function G(e,i,o=!1){return F(this,null,function*(){if(!e||!i)return!0;let n=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),r=H.get(n)?.entries();if(r){for(let[t,a]of r)if(a.name===i){let d=!a.stack?.hasForwardEdits();if(!d&&o){let[{deleteForwardEdits:u},{default:m}]=yield Promise.all([import("./chunk-IONSYE7Z.js"),import("./chunk-HSTWYY6V.js")]);return u(n,t,new m({sessionId:C,moment:a.moment}))}return d}}return!0})}function R(e,i){if(!e)return!1;let o=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=H.get(o)?.entries();if(n){for(let[r,t]of n)if(t.name===i)return t.lockType==="edit"}return!1}var y=new A.EventEmitter;function N(e){return y.on("apply-edits",new WeakRef(e))}function W(e){return y.on("update-moment",new WeakRef(e))}function se(e,i,o=null,n=!1){let r=j();return n=i==null||n,y.emit("apply-edits",{serviceUrl:e,layerId:i,gdbVersion:o,mayReceiveServiceEdits:n,result:r.promise}),r}var k="esri.layers.mixins.EditBusLayer",x=Symbol(k);function ie(e){return e!=null&&typeof e=="object"&&x in e}function h(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function I(e,i,o){let n=new URL(e).host,r=g.get(n),t=a=>!a||a===r;return t(i)&&t(o)||i===o}var re=e=>{var i;let o=class extends e{constructor(...n){super(...n),this[i]=!0,this._applyEditsHandler=r=>{let{serviceUrl:t,layerId:a,gdbVersion:d,mayReceiveServiceEdits:u,result:m}=r,b=t===this.url,p=a!=null&&this.layerId!=null&&a===this.layerId,B=h(this),T=h(this)&&I(t,d,this.gdbVersion);if(!b||B&&!T||!p&&!u)return;let _=m.then(s=>{if(p&&(s.addedFeatures.length||s.updatedFeatures.length||s.deletedFeatures.length||s.addedAttachments.length||s.updatedAttachments.length||s.deletedAttachments.length))return this.emit("edits",c(s)),s;let v=s.editedFeatures?.find(({layerId:f})=>f===this.layerId);if(v){let{adds:f,updates:M,deletes:E}=v.editedFeatures,V={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:f?f.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],deletedFeatures:E?E.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],updatedFeatures:M?M.map(({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],editedFeatures:c(s.editedFeatures),exceededTransferLimit:!1,historicMoment:c(s.historicMoment)};return this.emit("edits",V),V}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:c(s.editedFeatures),exceededTransferLimit:!1,historicMoment:c(s.historicMoment)}}).then(s=>("historicMoment"in this&&this.historicMoment!==s.historicMoment&&R(t,d)&&(this.historicMoment=s.historicMoment),s));this.emit("apply-edits",{result:_})},this._updateMomentHandler=r=>{let{serviceUrl:t,gdbVersion:a,moment:d}=r,u=t===this.url,m=h(this),b=h(this)&&I(t,a,this.gdbVersion),p=h(this)&&!I(t,this.gdbVersion,null);u&&m&&b&&p&&"historicMoment"in this&&this.historicMoment!==d&&(this.historicMoment=d)},this.when().then(()=>{this.addHandles(N(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(W(this._updateMomentHandler))},()=>{})}};return i=x,o=w([S(k)],o),o};export{C as a,q as b,G as c,R as d,se as e,ie as f,re as g};
