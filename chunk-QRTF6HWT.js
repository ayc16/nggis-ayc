import{b as Jn}from"./chunk-BJQH3R2Y.js";import{b as hl}from"./chunk-I6JXU463.js";import{b as il}from"./chunk-JAAOLJTO.js";import{a as Kn,b as el,c as tl,e as rl}from"./chunk-AWMFYQHJ.js";import{b as $n}from"./chunk-DRX336HH.js";import{a as Zn,c as Qn}from"./chunk-SFGIVWEM.js";import{a as rr,b as al,d as ol}from"./chunk-TB62XDET.js";import{b as Ki,c as ll}from"./chunk-724MIMFK.js";import{a as sl,b as nl}from"./chunk-UJUCAWBP.js";import{a as qn}from"./chunk-RCPMQJFX.js";import{A as Ln,B as Nn,E as Vn,F as Fn,G as $i,H as Ir,I as Un,J as xs,K as Dr,L as jn,M as Bn,a as zi,b as qi,c as ki,e as ye,f as Qt,g as $t,h as Sn,i as Cn,j as En,k as Mn,l as ws,m as Kt,o as An,r as U,s as Pn,t as Xi,w as Ji,x as Zi,y as In,z as Dn}from"./chunk-7E3X25PE.js";import{a as _n,b as yn,d as Ss}from"./chunk-PJBIIWFF.js";import{a as Xt}from"./chunk-FVCUBGKZ.js";import{c as Qi}from"./chunk-LCBWJNVO.js";import{a as Ze,b as Qe,c as $e,d as tr,e as Hn,f as Wn,h as Rs}from"./chunk-JAXR3ZUJ.js";import{d as Ts,e as vn,f as Tn}from"./chunk-XN46SLSO.js";import{a as bs,b as D}from"./chunk-XSJRPCD6.js";import{a as vs,b as lt,d as _t,e as On,f as Yi,g as wn,h as xn,k as Jt,l as le,p as er,u as Gn,w as Lr}from"./chunk-3DDJTCET.js";import{a as ae,c as zn}from"./chunk-UDMTFKLM.js";import{a as Os,b as bn,d as Rn,e as Zt,f as Re,g as ve}from"./chunk-AW3LMT4V.js";import{a as $o}from"./chunk-ADDH3SWI.js";import{j as Ko,k as Er}from"./chunk-GJBALZEB.js";import{a as Le,b as Gi,c as te}from"./chunk-XAHD7XBV.js";import{e as un,f as dn,g as pn,i as Pr,j as mn}from"./chunk-DL3OPG77.js";import{a as Hi,d as ds,e as on,j as nn}from"./chunk-RBP2Z7C6.js";import{a as E,b as fn,f as gs,h as _s,j as ys,k as Wi,l as Yt}from"./chunk-DOFADBK3.js";import{b as G}from"./chunk-KUOODJRB.js";import{a as Ar,d as sn,f as Bi,h as an}from"./chunk-OW7DVBQB.js";import{a as qo}from"./chunk-LAXYP2KV.js";import{b as zt,d as De,e as Ui}from"./chunk-TIXZ4OWB.js";import{a as ee,b as At,d as Sr,e as Uo,f as jo,g as Bo}from"./chunk-NDZXQR2V.js";import{a as f,b as ko}from"./chunk-UVJ5D37D.js";import{a as qt,b as kt,c as Ge,i as Go,k as Ho,m as Wo,r as zo,x as Pt}from"./chunk-ZAQLF7TN.js";import{d as Yo,e as Fi}from"./chunk-ZHUHFKYD.js";import{a as Jo}from"./chunk-SKXQUOOX.js";import{b as Xo}from"./chunk-6HNTTYFF.js";import{p as Fo}from"./chunk-I3DWOIS7.js";import{a as kn,c as Yn,d as Xn}from"./chunk-5NHMASEK.js";import{a as fs}from"./chunk-NIYDRLW4.js";import{a as ze}from"./chunk-XHOTVM3O.js";import{a as Je,b as ln,c as ps,d as hn,f as cn,g as ms}from"./chunk-H3VY6XFU.js";import{F as We,b as en,i as us,l as It,p as tn,q as Mr,x as rn}from"./chunk-SJTQM4NH.js";import{a as Zo,b as Qo}from"./chunk-XRRPDCIR.js";import{c as Do,d as Lo}from"./chunk-OJB2TSJ7.js";import{b as Io,c as Li}from"./chunk-YXPGI3LI.js";import{j as So,k as Co,l as Eo}from"./chunk-R4NNYEN7.js";import{a as Y,c as cs}from"./chunk-PDBA6QOJ.js";import{a as ji}from"./chunk-CF52RSJZ.js";import{a as V,d as He}from"./chunk-ALWV3RJ2.js";import{a as Cr}from"./chunk-7C6Z24SS.js";import{v as Po}from"./chunk-7G4KK3KW.js";import{j as Rr}from"./chunk-KYNKUTEO.js";import{a as Ht,b as hs,c as gt,d as Et,g as Mt,j as Ni,m as No,n as Vi,o as ne,q as Wt,v as Vo}from"./chunk-2ETHV3H2.js";import{a as is,c as to,h as bi}from"./chunk-4XUOIGFO.js";import{a as gn}from"./chunk-EETFV2SL.js";import{e as _o,g as ot}from"./chunk-AM3VOA32.js";import{a as de,b as Mo,c as ft,d as Ao,e as Di,f as ls}from"./chunk-M2GLXRA2.js";import{A as os,C as bo,E as Ro,a as _e,d as as,f as Xe,g as be,h as Mi,k as yo,l as vo,m as To,n as Oo,y as wo,z as xo}from"./chunk-EBWCXIFH.js";import{f as ao}from"./chunk-MRVR6F6G.js";import{g as so,h as io}from"./chunk-WXQQZY3K.js";import{a as at,b as go,r as Ei}from"./chunk-VPMDQK57.js";import{a as xr,b as br,d as Ai,e as Pi,k as nt,l as ns,m as Ii}from"./chunk-ZVHU7VE3.js";import{a as mo,b as mt,d as Ct,i as fo}from"./chunk-76YVRX2R.js";import{B as it,D as uo,E as Si,G as po,I as Ci,a as Pe,b as B,c as z,d as k,e as $,l as q,n as st,q as ho,s as Q,t as Be,u as Ie,v as Ri,w as J,x as co}from"./chunk-OZF6BMOL.js";import{a as S,b as wr,c as je,d as oo,f as no,i as lo}from"./chunk-GJP6PTKT.js";import{a as ss}from"./chunk-GBTN5LIS.js";import{da as ro}from"./chunk-JDDD6VJ4.js";import{F as rs,L as R,O as Gt,h as Ka,w as ts}from"./chunk-AUTL5LCV.js";import{S as Ye,r as Ue}from"./chunk-KUJG22IX.js";import{a as m}from"./chunk-W3WDPWBE.js";import{k as eo}from"./chunk-GISCFF3Z.js";import{b as es,c as pt,f as St}from"./chunk-MLSR6YE6.js";import{a as ue}from"./chunk-CPDJJRWA.js";import{r as dt}from"./chunk-HQMV3KQV.js";import{a as xe,m as xi,o as $a}from"./chunk-CRMMDK2Z.js";import{a as Or,b as Qa,h as Rt}from"./chunk-EAH6BNBL.js";var Dt;(function(t){t[t.ASYNC=0]="ASYNC",t[t.SYNC=1]="SYNC"})(Dt||(Dt={}));var sr,Nr,Cs;(function(t){t[t.RasterImage=0]="RasterImage",t[t.Features=1]="Features"})(sr||(sr={})),function(t){t[t.MapLayer=0]="MapLayer",t[t.ViewLayer=1]="ViewLayer",t[t.Outline=2]="Outline",t[t.SnappingHint=3]="SnappingHint"}(Nr||(Nr={})),function(t){t[t.WithRasterImage=0]="WithRasterImage",t[t.WithoutRasterImage=1]="WithoutRasterImage"}(Cs||(Cs={}));function Es(t){return t.type==="point"}var cl=class{constructor(e,r=null,s=0){this.array=e,this.spatialReference=r,this.offset=s}};function ea(t){return"array"in t}function Vr(t,e,r="ground"){if(Es(e))return t.getElevation(e.x,e.y,e.z||0,e.spatialReference,r);if(ea(e)){let s=e.offset;return t.getElevation(e.array[s++],e.array[s++],e.array[s]||0,e.spatialReference??t.spatialReference,r)}return t.getElevation(e[0],e[1],e[2]||0,t.spatialReference,r)}function Ic(t,e,r,s,i,a,o,n,h,l,c){let u=yh[c.mode],d,p,g=0;if(Rr(t,e,r,s,h.spatialReference,i,n))return u.requiresAlignment(c)?(g=u.applyElevationAlignmentBuffer(s,i,a,o,n,h,l,c),d=a,p=o):(d=s,p=i),Rr(d,h.spatialReference,p,a,l.spatialReference,o,n)?g:void 0}function ul(t,e,r,s,i){let a=(Es(t)?t.z:ea(t)?t.array[t.offset+2]:t[2])||0;switch(r.mode){case"on-the-ground":{let o=Vr(e,t,"ground")??0;return i.verticalDistanceToGround=0,i.sampledElevation=o,void(i.z=o)}case"relative-to-ground":{let o=Vr(e,t,"ground")??0,n=r.geometryZWithOffset(a,s);return i.verticalDistanceToGround=n,i.sampledElevation=o,void(i.z=n+o)}case"relative-to-scene":{let o=Vr(e,t,"scene")??0,n=r.geometryZWithOffset(a,s);return i.verticalDistanceToGround=n,i.sampledElevation=o,void(i.z=n+o)}case"absolute-height":{let o=r.geometryZWithOffset(a,s),n=Vr(e,t,"ground")??0;return i.verticalDistanceToGround=o-n,i.sampledElevation=n,void(i.z=o)}default:return void(i.z=0)}}function Dc(t,e,r,s){return ul(t,e,r,s,ir),ir.z}function Lc(t,e,r){return e==="on-the-ground"&&r==="on-the-ground"?t.staysOnTheGround:e===r||e!=="on-the-ground"&&r!=="on-the-ground"?e==null||r==null?t.definedChanged:ra.UPDATE:t.onTheGroundChanged}function Nc(t){return t==="relative-to-ground"||t==="relative-to-scene"}function Vc(t){return t!=="absolute-height"}function Fc(t,e,r,s,i){ul(e,r,i,s,ir),dh(t,ir.verticalDistanceToGround);let a=ir.sampledElevation,o=_e(vh,t.transformation);return Ms[0]=e.x,Ms[1]=e.y,Ms[2]=ir.z,Xo(e.spatialReference,Ms,o,s.spatialReference)?t.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),a}function dh(t,e){for(let r=0;r<t.geometries.length;++r){let s=t.geometries[r].getMutableAttribute(f.CENTEROFFSETANDDISTANCE);s&&s.data[3]!==e&&(s.data[3]=e,t.geometryVertexAttributeUpdated(t.geometries[r],f.CENTEROFFSETANDDISTANCE))}}function ph(t,e,r,s,i,a){let o=0,n=a.spatialReference;e*=3,s*=3;for(let h=0;h<i;++h){let l=t[e],c=t[e+1],u=t[e+2],d=a.getElevation(l,c,u,n,"ground")??0;o+=d,r[s]=l,r[s+1]=c,r[s+2]=d,e+=3,s+=3}return o/i}function mh(t,e,r,s,i,a,o,n){let h=0,l=n.calculateOffsetRenderUnits(o),c=n.featureExpressionInfoContext,u=a.spatialReference;e*=3,s*=3;for(let d=0;d<i;++d){let p=t[e],g=t[e+1],_=t[e+2],O=a.getElevation(p,g,_,u,"ground")??0;h+=O,r[s]=p,r[s+1]=g,r[s+2]=c==null?_+O+l:O+l,e+=3,s+=3}return h/i}function fh(t,e,r,s,i,a,o,n){let h=0,l=n.calculateOffsetRenderUnits(o),c=n.featureExpressionInfoContext,u=a.spatialReference;e*=3,s*=3;for(let d=0;d<i;++d){let p=t[e],g=t[e+1],_=t[e+2],O=a.getElevation(p,g,_,u,"scene")??0;h+=O,r[s]=p,r[s+1]=g,r[s+2]=c==null?_+O+l:O+l,e+=3,s+=3}return h/i}function gh(t){let e=t.meterUnitOffset,r=t.featureExpressionInfoContext;return e!==0||r!=null}function _h(t,e,r,s,i,a,o,n){let h=n.calculateOffsetRenderUnits(o),l=n.featureExpressionInfoContext;e*=3,s*=3;for(let c=0;c<i;++c){let u=t[e],d=t[e+1],p=t[e+2];r[s]=u,r[s+1]=d,r[s+2]=l==null?p+h:h,e+=3,s+=3}return 0}var ta=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}},ra;(function(t){t[t.NONE=0]="NONE",t[t.UPDATE=1]="UPDATE",t[t.RECREATE=2]="RECREATE"})(ra||(ra={}));var yh={"absolute-height":{applyElevationAlignmentBuffer:_h,requiresAlignment:gh},"on-the-ground":{applyElevationAlignmentBuffer:ph,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:mh,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:fh,requiresAlignment:()=>!0}},vh=V(),ir=new ta,Ms=S();var Th=()=>dt.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function dl(t){return{cachedResult:t.cachedResult,arcade:t.arcade?{func:t.arcade.func,context:t.arcade.modules.arcadeUtils.createExecContext(null,{sr:t.arcade.context.spatialReference}),modules:t.arcade.modules}:null}}function Wc(t,e,r,s){return Rt(this,null,function*(){let i=t?.expression;if(typeof i!="string")return null;let a=Oh(i);if(a!=null)return{cachedResult:a};let o=yield gn();eo(r);let n=o.arcadeUtils,h=n.createSyntaxTree(i);return n.dependsOnView(h)?(s?.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:n.createFunction(h),context:n.createExecContext(null,{sr:e}),modules:o}}})}function pl(t,e,r){return t.arcadeUtils.createFeature(e.attributes,e.geometry,r)}function ml(t,e){if(t!=null&&!gl(t)){if(!e||!t.arcade)return void Th().errorOncePerTick("Arcade support required but not provided");let r=e;r._geometry&&(r._geometry=Yn(r._geometry)),t.arcade.modules.arcadeUtils.updateExecContext(t.arcade.context,e)}}function fl(t){if(t!=null){if(gl(t))return t.cachedResult;let e=t.arcade,r=e?.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof r!="number"&&(t.cachedResult=0,r=0),r}return 0}function zc(t,e=!1){let r=t?.featureExpressionInfo,s=r?.expression;return e||s==="0"||(r=null),r??null}var qc={cachedResult:0};function gl(t){return t.cachedResult!=null}function Oh(t){return t==="0"?0:null}var _l=class t{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=Qo(e)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,r){let s=this.calculateOffsetRenderUnits(r);return this.featureExpressionInfoContext!=null?s:e+s}calculateOffsetRenderUnits(e){let r=this._meterUnitOffset,s=this.featureExpressionInfoContext;return s!=null&&(r+=fl(s)*this._metersPerElevationInfoUnit),r/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=Zo(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,r,s){if(e==null)return void(this._featureExpressionInfoContext=null);let i=e?.arcade;i&&r!=null&&s!=null?(this._featureExpressionInfoContext=dl(e),ml(this._featureExpressionInfoContext,pl(i.modules,r,s))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){let r=new t;return e!=null&&r.setFromElevationInfo(e),r}};function cu(t,e){if(t.type==="point")return yt(t,e,!1);if(kn(t))switch(t.type){case"extent":return yt(t.center,e,!1);case"polygon":return yt(t.centroid,e,!1);case"polyline":return yt(yl(t),e,!0);case"mesh":return yt(t.origin,e,!1)}else switch(t.type){case"extent":return yt(wh(t),e,!0);case"polygon":return yt(xh(t),e,!0);case"polyline":return yt(yl(t),e,!0)}}function yl(t){let e=t.paths[0];if(!e||e.length===0)return null;let r=io(e,so(e)/2);return fs(r[0],r[1],r[2],t.spatialReference)}function wh(t){return fs(.5*(t.xmax+t.xmin),.5*(t.ymax+t.ymin),t.zmin!=null&&t.zmax!=null&&isFinite(t.zmin)&&isFinite(t.zmax)?.5*(t.zmax+t.zmin):void 0,t.spatialReference)}function xh(t){let e=t.rings[0];if(!e||e.length===0)return null;let r=ao(t.rings,!!t.hasZ);return fs(r[0],r[1],r[2],t.spatialReference)}function yt(t,e,r){let s=r?t:Xn(t);return e&&t?Po(t,s,e)?s:null:s}function uu(t,e,r,s=0){if(t){e||(e=at());let i=t,a=.5*i.width*(r-1),o=.5*i.height*(r-1);return i.width<1e-7*i.height?a+=o/20:i.height<1e-7*i.width&&(o+=a/20),br(e,i.xmin-a-s,i.ymin-o-s,i.xmax+a+s,i.ymax+o+s),e}return null}function du(t,e,r=null){let s=Mo(ls);return t!=null&&(s[0]=t[0],s[1]=t[1],s[2]=t[2]),e!=null?s[3]=e:t!=null&&t.length>3&&(s[3]=t[3]),r&&(s[0]*=r,s[1]*=r,s[2]*=r,s[3]*=r),s}function pu(t=no,e,r,s=1){let i=new Array(3);if(e==null||r==null)i[0]=1,i[1]=1,i[2]=1;else{let a,o=0;for(let n=2;n>=0;n--){let h=t[n],l,c=h!=null,u=n===0&&!a&&!c,d=r[n];h==="symbol-value"||u?l=d!==0?e[n]/d:1:c&&h!=="proportional"&&isFinite(h)&&(l=d!==0?h/d:1),l!=null&&(i[n]=l,a=l,o=Math.max(o,Math.abs(l)))}for(let n=2;n>=0;n--)i[n]==null?i[n]=a:i[n]===0&&(i[n]=.001*o)}for(let a=2;a>=0;a--)i[a]/=s;return oo(i)}function bh(t){return t.isPrimitive!=null}function mu(t){return Rh(bh(t)?[t.width,t.depth,t.height]:t)?null:"Symbol sizes may not be negative values"}function Rh(t){let e=r=>r==null||r>=0;return Array.isArray(t)?t.every(e):e(t)}function fu(t,e,r,s=V()){return t&&To(s,s,-t/180*Math.PI),e&&yo(s,s,e/180*Math.PI),r&&vo(s,s,r/180*Math.PI),s}function gu(t,e,r){if(r.minDemResolution!=null)return r.minDemResolution;let s=ro(e),i=So(t)*s,a=Co(t)*s,o=Eo(t)*(e.isGeographic?1:s);return i===0&&a===0&&o===0?r.minDemResolutionForPoints:.01*Math.max(i,a,o)}var As=class extends vs{get geometries(){return this._geometries}get transformation(){return this._transformation??He}set transformation(e){this._transformation=_e(this._transformation??V(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?_e(this._shaderTransformation??V(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(e={}){super(),this.type=lt.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new Ps),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){ee(this._parentLayer==null||e==null,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._emit("geometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){let r=this._geometries.splice(e,1)[0];r&&(this._emit("geometryRemoved",{object:this,geometry:r}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,r,s=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:r,sync:s}),ko(r)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(let r of this._geometries)r.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){let e=new zi(Bi.MaskOccludee);for(let r of this._geometries)r.occludees=qi(r.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(let r of this._geometries)r.occludees=ki(r.occludees,e);this._emit("occlusionChanged",this)}highlight(){let e=new zi(Bi.Highlight);for(let r of this._geometries)r.highlights=qi(r.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(let r of this._geometries)r.highlights=ki(r.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,r){return be(r,this.transformation,e.transformation)}getCombinedShaderTransformation(e,r=V()){return be(r,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new Is,this._validateBoundingVolume(this._bvWorldSpace,Fr.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new Is,this._validateBoundingVolume(this._bvObjectSpace,Fr.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,r){let s=r===Fr.ObjectSpace;for(let i of this._geometries){let a=i.boundingInfo;a&&Sh(a,e,s?i.transformation:this.getCombinedShaderTransformation(i))}Ri(e.bounds,e.min,e.max,.5);for(let i of this._geometries){let a=i.boundingInfo;if(a==null)continue;let o=s?i.transformation:this.getCombinedShaderTransformation(i),n=us(o);J(vl,a.center,o);let h=st(vl,e.bounds),l=a.radius*n;e.bounds[3]=Math.max(e.bounds[3],h+l)}}_invalidateBoundingVolume(){let e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,r){this._parentLayer&&this._parentLayer.events.emit(e,r)}get test(){}},Ps=class{constructor(){this.min=je(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=je(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}},Is=class extends Ps{constructor(){super(...arguments),this.bounds=ms()}};function Sh(t,e,r){let s=t.bbMin,i=t.bbMax;if(Ro(r)){let a=z(Ch,r[12],r[13],r[14]);k(Se,s,a),k(qe,i,a);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],Se[o]),e.max[o]=Math.max(e.max[o],qe[o])}else if(J(Se,s,r),it(s,i))for(let a=0;a<3;++a)e.min[a]=Math.min(e.min[a],Se[a]),e.max[a]=Math.max(e.max[a],Se[a]);else{J(qe,i,r);for(let a=0;a<3;++a)e.min[a]=Math.min(e.min[a],Se[a],qe[a]),e.max[a]=Math.max(e.max[a],Se[a],qe[a]);for(let a=0;a<3;++a){B(Se,s),B(qe,i),Se[a]=i[a],qe[a]=s[a],J(Se,Se,r),J(qe,qe,r);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],Se[o],qe[o]),e.max[o]=Math.max(e.max[o],Se[o],qe[o])}}}var Ch=S(),Se=S(),qe=S(),vl=S(),Fr;(function(t){t[t.WorldSpace=0]="WorldSpace",t[t.ObjectSpace=1]="ObjectSpace"})(Fr||(Fr={}));var Ol=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];var Ds=class extends vs{get objects(){return this._objects}constructor(e,r,s=""){super(),this.stage=e,this.apiLayerUid=s,this.type=lt.Layer,this.events=new ss,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new ue,this._objectsAdded=new ue,this._handles=new Ka,this.apiLayerUid=s,this.visible=r?.visible??!0,this.pickable=r?.pickable??!0,this.updatePolicy=r?.updatePolicy??Dt.ASYNC,this._disableOctree=r?.disableOctree??!1,e.add(this);for(let i of Ol)this._handles.add(this.events.on(i,a=>e.handleEvent(i,a)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),this._octree!=null&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(let r of e)r.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),this._octree!=null&&this._objectsAdded.pushArray(e)}removeMany(e){let r=new Array;if(this._objects.removeUnorderedMany(e,e.length,r),r.length!==0){for(let s of r)s.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:r}),this._octree!=null){for(let s=0;s<r.length;)this._objectsAdded.removeUnordered(r[s])?(r[s]=r[r.length-1],r.length-=1):++s;this._octree.remove(r)}}}sync(){this.updatePolicy!==Dt.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,r){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,r)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.length>50&&!this._disableOctree?(this._octree=new mn(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=es(this._octree),this._objectsAdded.clear()}};function wl(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/e)}function xl(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/r)}function bl(t,e,r){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}function Rl(t,e,r){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}var Ls=class{constructor(){this.adds=new ue,this.removes=new ue,this.updates=new ue({allocator:e=>e||new sa,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},sa=class{},Ns=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var Sl,j;function Cl(t){let e=new Map,r=s=>{let i=e.get(s);return i||(i=new Ns,e.set(s,i)),i};return t.removes.forAll(s=>{ia(s)&&r(s.material).removes.push(s)}),t.adds.forAll(s=>{ia(s)&&r(s.material).adds.push(s)}),t.updates.forAll(s=>{ia(s.renderGeometry)&&r(s.renderGeometry.material).updates.push(s)}),e}function ia(t){return t.geometry.indexCount>=1}(function(t){t[t.Default=0]="Default",t[t.Screenshot=1]="Screenshot",t[t.ObjectAndLayerID=2]="ObjectAndLayerID"})(Sl||(Sl={})),function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(j||(j={}));var na,I=na=class extends Gt{constructor(t){super(t),this._ray=Je(),this._viewport=ft(0,0,1,1),this._padding=ft(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=cs(1,1e3),this._viewDirty=!0,this._viewMatrix=V(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=V(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=V(),this._frustumDirty=!0,this._frustum=un(),this._fullViewport=de(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=S(),this._up=S(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get rows(){return this._rows}set rows(t){this._rows=Math.max(1,t)}get columns(){return this._columns}set columns(t){this._columns=Math.max(1,t)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return $(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){_e(this._viewMatrix,t),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),z(S(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),z(S(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),z(S(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;let t=Ai(de(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&Ii(t,e)?e:t}get screenPadding(){if(this.pixelRatio===1)return this._padding;let t=Ai(de(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&Ii(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[j.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[j.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[j.RIGHT]+this._padding[j.LEFT]}set fullWidth(t){this.width=t-(this._padding[j.RIGHT]+this._padding[j.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[j.TOP]+this._padding[j.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[j.TOP]+this._padding[j.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[j.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[j.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){ns(this._padding,t)||(this._viewport[0]+=t[j.LEFT]-this._padding[j.LEFT],this._viewport[1]+=t[j.BOTTOM]-this._padding[j.BOTTOM],this._viewport[2]-=t[j.RIGHT]+t[j.LEFT]-(this._padding[j.RIGHT]+this._padding[j.LEFT]),this._viewport[3]-=t[j.TOP]+t[j.BOTTOM]-(this._padding[j.TOP]+this._padding[j.BOTTOM]),xr(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(be(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return Xe(V(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||V()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return bl(this._fov,this.width,this.height)}set fovX(t){this._fov=wl(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Rl(this._fov,this.width,this.height)}set fovY(t){this._fov=xl(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return st(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Xe(this._viewInverseTransposeMatrix,this.viewMatrix),as(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){let e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){let t=this.width,e=this.height,r=this.near*Math.tan(this.fovY/2)*2,s=r*this._aspect,i=r/this.rows,a=s/this.columns,o=-s/2+this.column*a,n=o+a,h=-r/2+this.row*i,l=h+i,c=wo(V(),o*(1+2*this._padding[j.LEFT]/t),n*(1+2*this._padding[j.RIGHT]/t),h*(1+2*this._padding[j.BOTTOM]/e),l*(1+2*this._padding[j.TOP]/e),this.near,this.far),u=this._get("projectionMatrix");return u&&bo(u,c)?u:c}copyFrom(t){B(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,xr(this._viewport,t.viewport),this.notifyChange("_viewport"),xr(this._padding,t.padding),this.notifyChange("_padding"),Ht(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.row=t.row,this.column=t.column,this.rows=t.rows,this.columns=t.columns,this.relativeElevation=t.relativeElevation;let e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(_e(this._viewMatrix,t.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(dn(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(_e(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),xr(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return new na().copyFrom(this)}equals(t){return it(this.eye,t.eye)&&it(this.center,t.center)&&it(this.up,t.up)&&ns(this._viewport,t.viewport)&&ns(this._padding,t.padding)&&Vo(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation&&this.row===t.row&&this.column===t.column&&this.rows===t.rows&&this.columns===t.columns}almostEquals(t){let e=Math.max(1,1/this.pixelRatio,1/t.pixelRatio);if(Math.abs(t.fov-this._fov)>=.001||Pi(t.screenPadding,this.screenPadding)>=e||Pi(this.screenViewport,t.screenViewport)>=e||this.row!==t.row||this.column!==t.column||this.rows!==t.rows||this.columns!==t.columns)return!1;Si(he,t.eye,t.center),Si(aa,this.eye,this.center);let r=Be(he,aa),s=Ci(he),i=Ci(aa),a=5e-4;return r*r>=(1-1e-10)*s*i&&po(t.eye,this.eye)<Math.max(s,i)*a*a}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(en(this.viewForward,$(he,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=_o()){return t[0]=(this.padding[j.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[j.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,r=.5){return t[0]=this.padding[j.LEFT]+this.width*e,t[1]=this.padding[j.BOTTOM]+this.height*r,t[2]=.5,t}setGLViewport(t){let e=this.viewport,r=this.padding;t.setViewport(e[0]-r[3],e[1]-r[2],e[2]+r[1]+r[3],e[3]+r[0]+r[2])}applyProjection(t,e){t!==L&&B(L,t),L[3]=1,nt(L,L,this.projectionMatrix);let r=Math.abs(L[3]);q(L,L,1/r);let s=this.fullViewport;e[0]=Ct(0,s[0]+s[2],.5+.5*L[0]),e[1]=Ct(0,s[1]+s[3],.5+.5*L[1]),e[2]=.5*(L[2]+1),e[3]=r}unapplyProjection(t,e){let r=this.fullViewport;L[0]=(t[0]/(r[0]+r[2])*2-1)*t[3],L[1]=(t[1]/(r[1]+r[3])*2-1)*t[3],L[2]=(2*t[2]-1)*t[3],L[3]=t[3],this.inverseProjectionMatrix!=null&&(nt(L,L,this.inverseProjectionMatrix),e[0]=L[0],e[1]=L[1],e[2]=L[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,oa),this.renderToScreen(oa,e),e}projectToRenderScreen(t,e){if(L[0]=t[0],L[1]=t[1],L[2]=t[2],L[3]=1,nt(L,L,this.viewProjectionMatrix),L[3]===0)return null;let r=L;q(r,r,1/Math.abs(L[3]));let s=this.fullViewport,i=Ct(0,s[0]+s[2],.5+.5*r[0]),a=Ct(0,s[1]+s[3],.5+.5*r[1]);return"x"in e?(e.x=i,e.y=a):(e[0]=i,e[1]=a,e.length>2&&(e[2]=.5*(r[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,oa),e)}unprojectFromRenderScreen(t,e){if(be(Vs,this.projectionMatrix,this.viewMatrix),!Xe(Vs,Vs))return null;let r=this.fullViewport;return L[0]=2*(t[0]-r[0])/r[2]-1,L[1]=2*(t[1]-r[1])/r[3]-1,L[2]=2*t[2]-1,L[3]=1,nt(L,L,Vs),L[3]===0?null:(e[0]=L[0]/L[3],e[1]=L[1]/L[3],e[2]=L[2]/L[3],e)}constrainWindowSize(t,e,r,s){let i=t*this.pixelRatio,a=e*this.pixelRatio,o=Math.max(i-r/2,0),n=Math.max(this.fullHeight-a-s/2,0),h=-Math.min(i-r/2,0),l=-Math.min(this.fullHeight-a-s/2,0),c=r-h- -Math.min(this.fullWidth-i-r/2,0),u=s-l- -Math.min(a-s/2,0);return[Math.round(o),Math.round(n),Math.round(c),Math.round(u)]}computeUp(t){t===ze.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){let r=t[0]*this.pixelRatio,s=this.fullHeight-t[1]*this.pixelRatio;return e[0]=r,e[1]=s,e}renderToScreen(t,e){let r=t[0]/this.pixelRatio,s=(this.fullHeight-t[1])/this.pixelRatio;e[0]=r,e[1]=s}_computeUpGlobal(){$(he,this.center,this.eye);let t=Pe(this.center);t<1?(z(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(Be(he,this.center))>.9999*Pe(he)*t||(Ie(this._up,he,this.center),Ie(this._up,this._up,he),Q(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){uo(he,this.eye,this.center),Math.abs(he[2])<=.9999&&(q(he,he,he[2]),z(this._up,-he[0],-he[1],1-he[2]),Q(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,r=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?it(t,e)||(B(e,t),this._markViewDirty(),r.length&&this.notifyChange(r)):dt.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(pn(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(os(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};m([R()],I.prototype,"_viewport",void 0),m([R()],I.prototype,"_padding",void 0),m([R()],I.prototype,"_fov",void 0),m([R()],I.prototype,"_nearFar",void 0),m([R()],I.prototype,"_viewDirty",void 0),m([R()],I.prototype,"_viewMatrix",void 0),m([R()],I.prototype,"_pixelRatio",void 0),m([R()],I.prototype,"pixelRatio",null),m([R()],I.prototype,"row",void 0),m([R()],I.prototype,"column",void 0),m([R()],I.prototype,"_rows",void 0),m([R()],I.prototype,"rows",null),m([R()],I.prototype,"_columns",void 0),m([R()],I.prototype,"columns",null),m([R()],I.prototype,"eye",null),m([R()],I.prototype,"center",null),m([R()],I.prototype,"_center",void 0),m([R()],I.prototype,"up",null),m([R()],I.prototype,"_up",void 0),m([R()],I.prototype,"viewMatrix",null),m([R({readOnly:!0})],I.prototype,"viewForward",null),m([R({readOnly:!0})],I.prototype,"viewUp",null),m([R({readOnly:!0})],I.prototype,"viewRight",null),m([R({readOnly:!0})],I.prototype,"nearFar",null),m([R()],I.prototype,"near",null),m([R()],I.prototype,"far",null),m([R()],I.prototype,"viewport",null),m([R({readOnly:!0})],I.prototype,"screenViewport",null),m([R({readOnly:!0})],I.prototype,"screenPadding",null),m([R()],I.prototype,"x",null),m([R()],I.prototype,"y",null),m([R()],I.prototype,"width",null),m([R()],I.prototype,"height",null),m([R()],I.prototype,"fullWidth",null),m([R()],I.prototype,"fullHeight",null),m([R({readOnly:!0})],I.prototype,"_aspect",null),m([R()],I.prototype,"padding",null),m([R({readOnly:!0})],I.prototype,"projectionMatrix",null),m([R({readOnly:!0})],I.prototype,"inverseProjectionMatrix",null),m([R()],I.prototype,"fov",null),m([R()],I.prototype,"fovX",null),m([R()],I.prototype,"fovY",null),m([R()],I.prototype,"viewInverseTransposeMatrix",null),m([R({readOnly:!0})],I.prototype,"_projectionMatrixInternal",null),m([R()],I.prototype,"relativeElevation",void 0),I=na=m([Ye("esri.views.3d.webgl.RenderCamera")],I);var vt=I,L=de(),Vs=V(),he=S(),aa=S(),oa=ot();var la=new Map([[f.POSITION,0],[f.PREVPOSITION,1],[f.NEXTPOSITION,2],[f.SUBDIVISIONFACTOR,3],[f.UV0,4],[f.COLOR,5],[f.COLORFEATUREATTRIBUTE,5],[f.SIZE,6],[f.SIZEFEATUREATTRIBUTE,6],[f.OPACITYFEATUREATTRIBUTE,7],[f.OBJECTANDLAYERIDCOLOR,8]]),Ur=class t extends Qe{initializeProgram(e){return new $e(e.rctx,t.shader.get().build(this.configuration),la)}_makePipelineState(e,r){let s=this.configuration,i=e===ae.NONE,a=e===ae.FrontFace,o=fn(s.output);return ve({blending:s.output===E.Color?i?Qt:$t(e):null,depthTest:{func:ws(e)},depthWrite:i?s.writeDepth||o?Zt:null:Sn(e),drawBuffers:s.output===E.Depth?{buffers:[Pt.NONE]}:Kt(e),colorWrite:Re,stencilWrite:s.hasOccludees?Ir:null,stencilTest:s.hasOccludees?r?Dr:xs:null,polygonOffset:i||a?s.hasPolygonOffset?El:null:En})}initializePipeline(){let e=this.configuration;if(e.occluder){let r=e.hasPolygonOffset?El:null;this._occluderPipelineTransparent=ve({blending:Qt,polygonOffset:r,depthTest:$i,depthWrite:null,colorWrite:Re,stencilWrite:null,stencilTest:Bn,drawBuffers:e.output===E.Depth?{buffers:[Pt.NONE]}:null}),this._occluderPipelineOpaque=ve({blending:Qt,polygonOffset:r,depthTest:$i,depthWrite:null,colorWrite:Re,stencilWrite:Un,stencilTest:jn,drawBuffers:e.output===E.Depth?{buffers:[Pt.NONE]}:null}),this._occluderPipelineMaskWrite=ve({blending:null,polygonOffset:r,depthTest:Fn,depthWrite:null,colorWrite:null,stencilWrite:Ir,stencilTest:Dr,drawBuffers:e.output===E.Depth?{buffers:[Pt.NONE]}:null})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?kt.LINES:kt.TRIANGLE_STRIP}getPipeline(e,r,s){return e?this._occludeePipelineState:this.configuration.occluder?s?this._occluderPipelineTransparent:r?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}};Ur.shader=new Ze(rl,()=>import("./chunk-EQ55HBWZ.js"));var El={factor:0,units:-4};var Te;(function(t){t[t.LEFT_JOIN_START=-2]="LEFT_JOIN_START",t[t.LEFT_JOIN_END=-1]="LEFT_JOIN_END",t[t.LEFT_CAP_START=-4]="LEFT_CAP_START",t[t.LEFT_CAP_END=-5]="LEFT_CAP_END",t[t.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",t[t.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",t[t.RIGHT_CAP_START=4]="RIGHT_CAP_START",t[t.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(Te||(Te={}));var Fs=class extends Jt{constructor(e){super(e,new fa),this._configuration=new el,this.produces=new Map([[U.OPAQUE_MATERIAL,r=>r===E.Highlight||r===E.ObjectAndLayerIdColor||r===E.Color&&this.parameters.renderOccluded===le.OccludeAndTransparentStencil],[U.OPAQUE_NO_SSAO_DEPTH,r=>Yt(r)],[U.OCCLUDER_MATERIAL,r=>Wi(r)&&this.parameters.renderOccluded===le.OccludeAndTransparentStencil],[U.TRANSPARENT_OCCLUDER_MATERIAL,r=>Wi(r)&&this.parameters.renderOccluded===le.OccludeAndTransparentStencil],[U.TRANSPARENT_MATERIAL,r=>r===E.Color&&this.parameters.writeDepth&&this.parameters.renderOccluded!==le.OccludeAndTransparentStencil],[U.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,r=>r===E.Color&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==le.OccludeAndTransparentStencil],[U.DRAPED_MATERIAL,r=>gs(r)]]),this._vertexAttributeLocations=la}getConfiguration(e,r){this._configuration.output=e,this._configuration.draped=r.slot===U.DRAPED_MATERIAL;let s=this.parameters.stipplePattern!=null&&e!==E.Highlight;return this._configuration.stippleEnabled=s,this._configuration.stippleOffColorEnabled=s&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=s&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&Eh(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===le.OccludeAndTransparentStencil,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.multipassEnabled=r.multipassEnabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,r,s,i,a,o){if(!s.options.selectionMode)return;let n=e.attributes.get(f.POSITION).data,h=e.attributes.get(f.SIZE),l=this.parameters.width;if(this.parameters.vvSize){let _=e.attributes.get(f.SIZEFEATUREATTRIBUTE).data[0];l*=mt(this.parameters.vvSize.offset[0]+_*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else h&&(l*=h.data[0]);let c=i[0],u=i[1],d=(l/2+4)*e.screenToWorldRatio,p=Number.MAX_VALUE,g=0;for(let _=0;_<n.length-5;_+=3){let O=n[_],v=n[_+1],w=c-O,y=u-v,C=n[_+3]-O,x=n[_+4]-v,A=mt((C*w+x*y)/(C*C+x*x),0,1),T=C*A-w,W=x*A-y,H=T*T+W*W;H<p&&(p=H,g=_/3)}p<d*d&&a(o.dist,o.normal,g,!1)}intersect(e,r,s,i,a,o){if(!s.options.selectionMode||!e.visible)return;if(!Bo(r))return void dt.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");let n=e.attributes,h=n.get(f.POSITION).data,l=this.parameters.width;if(this.parameters.vvSize){let w=n.get(f.SIZEFEATUREATTRIBUTE).data[0];l*=mt(this.parameters.vvSize.offset[0]+w*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else n.has(f.SIZE)&&(l*=n.get(f.SIZE).data[0]);let c=s.camera,u=Mh;Ht(u,s.point);let d=l*c.pixelRatio/2+4*c.pixelRatio;z(jr[0],u[0]-d,u[1]+d,0),z(jr[1],u[0]+d,u[1]+d,0),z(jr[2],u[0]+d,u[1]-d,0),z(jr[3],u[0]-d,u[1]-d,0);for(let w=0;w<4;w++)if(!c.unprojectFromRenderScreen(jr[w],ht[w]))return;Mr(c.eye,ht[0],ht[1],ca),Mr(c.eye,ht[1],ht[2],ua),Mr(c.eye,ht[2],ht[3],da),Mr(c.eye,ht[3],ht[0],pa);let p=Number.MAX_VALUE,g=0,_=Il(this.parameters,n)?h.length-2:h.length-5;for(let w=0;w<_;w+=3){me[0]=h[w]+r[12],me[1]=h[w+1]+r[13],me[2]=h[w+2]+r[14];let y=(w+3)%h.length;if(fe[0]=h[y]+r[12],fe[1]=h[y+1]+r[13],fe[2]=h[y+2]+r[14],We(ca,me)<0&&We(ca,fe)<0||We(ua,me)<0&&We(ua,fe)<0||We(da,me)<0&&We(da,fe)<0||We(pa,me)<0&&We(pa,fe)<0)continue;if(c.projectToRenderScreen(me,Nt),c.projectToRenderScreen(fe,Vt),Nt[2]<0&&Vt[2]>0){$(Ke,me,fe);let x=c.frustum,A=-We(x[Pr.NEAR],me)/Be(Ke,x[Pr.NEAR]);q(Ke,Ke,A),k(me,me,Ke),c.projectToRenderScreen(me,Nt)}else if(Nt[2]>0&&Vt[2]<0){$(Ke,fe,me);let x=c.frustum,A=-We(x[Pr.NEAR],fe)/Be(Ke,x[Pr.NEAR]);q(Ke,Ke,A),k(fe,fe,Ke),c.projectToRenderScreen(fe,Vt)}else if(Nt[2]<0&&Vt[2]<0)continue;Nt[2]=0,Vt[2]=0;let C=on(ds(Nt,Vt,Pl),u);C<p&&(p=C,B(Ml,me),B(Al,fe),g=w/3)}let O=s.rayBegin,v=s.rayEnd;if(p<d*d){let w=Number.MAX_VALUE;if(nn(ds(Ml,Al,Pl),ds(O,v,Ah),Lt)){$(Lt,Lt,O);let y=Pe(Lt);q(Lt,Lt,1/y),w=y/st(O,v)}o(w,Lt,g,!1)}}get _layout(){let e=zt().vec3f(f.POSITION).vec3f(f.PREVPOSITION).vec3f(f.NEXTPOSITION).f32(f.SUBDIVISIONFACTOR).vec2f(f.UV0);return this.parameters.vvSize?e.f32(f.SIZEFEATUREATTRIBUTE):e.f32(f.SIZE),this.parameters.vvColor?e.f32(f.COLORFEATUREATTRIBUTE):e.vec4f(f.COLOR),this.parameters.vvOpacity&&e.f32(f.OPACITYFEATUREATTRIBUTE),xe("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(f.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new ga(this._layout,this.parameters)}createGLMaterial(e){return new ma(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}},ma=class extends Ts{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===E.Color&&this._updateOccludeeState(e);let r=this._material.parameters.stipplePattern;return this._stipplePattern!==r&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(r,this._stipplePattern)}),this._stipplePattern=r),this.ensureTechnique(Ur,e)}},fa=class extends Lr{constructor(){super(...arguments),this.width=0,this.color=ls,this.join="miter",this.cap=Kn.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}},ga=class{constructor(e,r){this.vertexBufferLayout=e,this._parameters=r,this.numJoinSubdivisions=0;let s=r.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=s;break;case"round":this.numJoinSubdivisions=tl+s}}_isClosed(e){return Il(this._parameters,e.attributes)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){let s=e.attributes.get(f.POSITION).indices.length/2+1,i=this._isClosed(e),a=i?2:2*2;return a+=((i?s:s-1)-(i?0:1))*(2*this.numJoinSubdivisions+4),a+=2,this._parameters.wireframe&&(a=2+4*(a-2)),a}write(e,r,s,i,a){let o=Ph,n=Ih,h=Dh,l=s.attributes.get(f.POSITION),c=l.indices,u=l.data.length/3,d=s.attributes.get(f.DISTANCETOSTART)?.data;c&&c.length!==2*(u-1)&&console.warn("RibbonLineMaterial does not support indices");let p=s.attributes.get(f.SIZEFEATUREATTRIBUTE)?.data[0]??s.attributes.get(f.SIZE)?.data[0]??1,g=[1,1,1,1],_=0,O=this.vertexBufferLayout.fields.has(f.COLORFEATUREATTRIBUTE);O?_=s.attributes.get(f.COLORFEATUREATTRIBUTE).data[0]:s.attributes.has(f.COLOR)&&(g=s.attributes.get(f.COLOR).data);let v=xe("enable-feature:objectAndLayerId-rendering")?s.objectAndLayerIdColor:null,w=this.vertexBufferLayout.fields.has(f.OPACITYFEATUREATTRIBUTE),y=w?s.attributes.get(f.OPACITYFEATUREATTRIBUTE).data[0]:0,C=new Float32Array(i.buffer),x=xe("enable-feature:objectAndLayerId-rendering")?new Uint8Array(i.buffer):null,A=this.vertexBufferLayout.stride/4,T=a*A,W=T,H=0,M=d?(Z,Ae,P)=>H=d[P]:(Z,Ae,P)=>H+=st(Z,Ae),ie=xe("enable-feature:objectAndLayerId-rendering"),F=(Z,Ae,P,ut,we,vr,Tr)=>{if(C[T++]=Ae[0],C[T++]=Ae[1],C[T++]=Ae[2],C[T++]=Z[0],C[T++]=Z[1],C[T++]=Z[2],C[T++]=P[0],C[T++]=P[1],C[T++]=P[2],C[T++]=ut,C[T++]=Tr,C[T++]=we,C[T++]=p,O)C[T++]=_;else{let Bt=Math.min(4*vr,g.length-4);C[T++]=g[Bt],C[T++]=g[Bt+1],C[T++]=g[Bt+2],C[T++]=g[Bt+3]}w&&(C[T++]=y),ie&&(v!=null&&(x[4*T]=v[0],x[4*T+1]=v[1],x[4*T+2]=v[2],x[4*T+3]=v[3]),T++)};T+=A,z(n,l.data[0],l.data[1],l.data[2]),e&&J(n,n,e);let tt=this._isClosed(s);if(tt){let Z=l.data.length-3;z(o,l.data[Z],l.data[Z+1],l.data[Z+2]),e&&J(o,o,e)}else z(h,l.data[3],l.data[4],l.data[5]),e&&J(h,h,e),F(n,n,h,1,Te.LEFT_CAP_START,0,0),F(n,n,h,1,Te.RIGHT_CAP_START,0,0),B(o,n),B(n,h);let yr=tt?0:1,rt=tt?u:u-1;for(let Z=yr;Z<rt;Z++){let Ae=(Z+1)%u*3;z(h,l.data[Ae],l.data[Ae+1],l.data[Ae+2]),e&&J(h,h,e),M(o,n,Z),F(o,n,h,0,Te.LEFT_JOIN_END,Z,H),F(o,n,h,0,Te.RIGHT_JOIN_END,Z,H);let P=this.numJoinSubdivisions;for(let ut=0;ut<P;++ut){let we=(ut+1)/(P+1);F(o,n,h,we,Te.LEFT_JOIN_END,Z,H),F(o,n,h,we,Te.RIGHT_JOIN_END,Z,H)}F(o,n,h,1,Te.LEFT_JOIN_START,Z,H),F(o,n,h,1,Te.RIGHT_JOIN_START,Z,H),B(o,n),B(n,h)}tt?(z(h,l.data[3],l.data[4],l.data[5]),e&&J(h,h,e),H=M(o,n,rt),F(o,n,h,0,Te.LEFT_JOIN_END,yr,H),F(o,n,h,0,Te.RIGHT_JOIN_END,yr,H)):(H=M(o,n,rt),F(o,n,n,0,Te.LEFT_CAP_END,rt,H),F(o,n,n,0,Te.RIGHT_CAP_END,rt,H)),ha(C,W+A,C,W,A),T=ha(C,T-A,C,T,A),this._parameters.wireframe&&this._addWireframeVertices(i,W,T,A)}_addWireframeVertices(e,r,s,i){let a=new Float32Array(e.buffer,s*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT,s-r),n=0,h=l=>n=ha(o,l,a,n,i);for(let l=0;l<o.length-1;l+=2*i)h(l),h(l+2*i),h(l+1*i),h(l+2*i),h(l+1*i),h(l+3*i)}};function ha(t,e,r,s,i){for(let a=0;a<i;a++)r[s++]=t[e++];return s}function Il(t,e){return t.isClosed?e.get(f.POSITION).indices.length>2:!1}function Eh(t){return t.anchor===$n.Tip&&t.hideOnShortSegments&&t.placement==="begin-end"&&t.worldSpace}var me=S(),fe=S(),Ke=S(),Lt=S(),Mh=S(),Nt=ot(),Vt=ot(),Ml=S(),Al=S(),Pl=Hi(),Ah=Hi(),Ph=S(),Ih=S(),Dh=S(),jr=[ot(),ot(),ot(),ot()],ht=[S(),S(),S(),S()],ca=It(),ua=It(),da=It(),pa=It();var _a=class{constructor(e,r){this.vec3=e,this.id=r}};function ar(t,e,r,s){return new _a(je(t,e,r),s)}var ap={stableRendering:!1},Dl={rootOrigin:null};var Us=class{constructor(e){this._originSR=e,this._rootOriginId="root/"+rs(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){let r=this._origins.get(this._rootOriginId);if(r==null){let c=Dl.rootOrigin;if(c!=null)return this._origins.set(this._rootOriginId,ar(c[0],c[1],c[2],this._rootOriginId)),this.getOrigin(e);let u=ar(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,u),u}let s=this._gridSize,i=Math.round(e[0]/s),a=Math.round(e[1]/s),o=Math.round(e[2]/s),n=`${i}/${a}/${o}`,h=this._origins.get(n),l=.5*s;if($(oe,e,r.vec3),oe[0]=Math.abs(oe[0]),oe[1]=Math.abs(oe[1]),oe[2]=Math.abs(oe[2]),oe[0]<l&&oe[1]<l&&oe[2]<l){if(h){let c=Math.max(...oe);if($(oe,e,h.vec3),oe[0]=Math.abs(oe[0]),oe[1]=Math.abs(oe[1]),oe[2]=Math.abs(oe[2]),Math.max(...oe)<c)return h}return r}return h||(h=ar(i*s,a*s,o*s,n),this._origins.set(n,h)),h}_drawOriginBox(e,r=ft(1,1,0,1)){let s=window.view,i=s._stage,a=r.toString();if(!this._objects.has(a)){this._material=new Fs({width:2,color:r}),i.add(this._material);let p=new Ds(i,{pickable:!1}),g=new As({castShadow:!1});i.add(g),p.add(g),this._objects.set(a,g)}let o=this._objects.get(a),n=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],h=n.length,l=new Array(3*h),c=new Array,u=.5*this._gridSize;for(let p=0;p<h;p++)l[3*p]=e[0]+(1&n[p]?u:-u),l[3*p+1]=e[1]+(2&n[p]?u:-u),l[3*p+2]=e[2]+(4&n[p]?u:-u),p>0&&c.push(p-1,p);Rr(l,this._originSR,0,l,s.renderSpatialReference,0,h);let d=new ye(this._material,[[f.POSITION,new G(l,c,3,!0)]],null,lt.Line);i.add(d),o.addGeometry(d)}get test(){}},oe=S();var Br=class{constructor(){this._extent=at(),this.resolution=0,this.renderLocalOrigin=ar(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new ya}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();let r=.001*e.range;if(this._extent[0]-r<=e.min){let s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Ei(this._extent,e.range,0,s)}if(this._extent[2]+r>=e.max){let s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Ei(this._extent,-e.range,0,s)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,go(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){let r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},ya=class{constructor(){this.extents=[at(),at(),at()],this.numViews=0}};var se;(function(t){t[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.WaterNormal=3]="WaterNormal",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"})(se||(se={}));var js=class{constructor(e,r,s){this._fbos=e,this._format=r,this._name=s}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=St(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,r,s){this._handle&&this._handle.fbo?.width===r&&this._handle.fbo?.height===s||(this._handle?.release(),this._handle=this._fbos.acquire(r,s,this._name,this._format)),e.unbindTexture(this._handle?.fbo?.colorTexture),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}};var Tt=class{constructor(e,r,s,i,a=tr.RGBA_MIPMAP){this.output=s,this.content=i,this.fbo=new js(e,a,r)}get valid(){return this.fbo.valid}},Bs=class{constructor(e){this.targets=[new Tt(e,"overlay color",E.Color,se.Color),new Tt(e,"overlay IM color",E.Color,se.ColorNoRasterImage),new Tt(e,"overlay highlight",E.Highlight,se.Highlight,tr.RGBA4),new Tt(e,"overlay water",E.Normal,se.WaterNormal),new Tt(e,"overlay occluded",E.Color,se.Occluded)],xe("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new Tt(e,"overlay oid",E.ObjectAndLayerIdColor,se.ObjectAndLayerIdColor))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(let e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce((e,r,s)=>r.valid?e|=1<<s:e,0)}};var va;(function(t){t[t.Material=0]="Material",t[t.ShadowMap=1]="ShadowMap",t[t.Highlight=2]="Highlight",t[t.ViewshedShadowMap=3]="ViewshedShadowMap"})(va||(va={}));var Ft;(function(t){t[t.Disabled=0]="Disabled",t[t.Enabled=1]="Enabled",t[t.EnabledWithWater=2]="EnabledWithWater",t[t.COUNT=3]="COUNT"})(Ft||(Ft={}));var dm=de();var Gs=class{constructor(e){this._context=e,this._perConstructorInstances=new Xt,this._frameCounter=0,this._keepAliveFrameCount=Ll}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach(e=>e.forEach(r=>r.technique.destroy())),this._perConstructorInstances.clear()}acquire(e,r=Lh){let s=r.key,i=this._perConstructorInstances.get(e,s);if(i==null){let a=new e(this._context,r,()=>this.release(a));i=new Ta(a),this._perConstructorInstances.set(e,s,i)}return++i.refCount,i.technique}releaseAndAcquire(e,r,s){if(s!=null){if(r.key===s.key)return s;this.release(s)}return this.acquire(e,r)}release(e){if(e==null||this._perConstructorInstances.empty)return;let r=this._perConstructorInstances.get(e.constructor,e.key);r!=null&&(--r.refCount,r.refCount===0&&(r.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==Ll&&this._perConstructorInstances.forEach((e,r)=>{e.forEach((s,i)=>{s.refCount===0&&s.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(s.technique.destroy(),this._perConstructorInstances.delete(r,i))})})}reloadAll(){return Rt(this,null,function*(){let e=new Array;this._perConstructorInstances.forEach((r,s)=>{let i=(a,o)=>Rt(this,null,function*(){let n=o.shader;n&&(yield n.reload(),a.forEach(h=>h.technique.reload(this._context)))});e.push(i(r,s))}),yield Promise.all(e)})}},Ta=class{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}},Ll=-1,Lh=new bs;var Nh={required:[]},Tm={required:[E.Depth]},Gr=class extends Gt{consumes(){return Nh}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}get materialReference(){return null}modify(e){}get numGeometries(){return 0}get hasOccludees(){return!1}queryRenderOccludedState(e){return!1}},Hs=class extends Gr{},Ws=class extends Gr{constructor(){super(...arguments),this.drapedPriority=0}};var Nl=class extends Gr{};var zs=class{constructor(e,r,s,i){this._textures=e,this._techniques=r,this.materialChanged=s,this.requestRender=i,this._id2glMaterialRef=new Xt}dispose(){this._textures.destroy()}acquire(e,r,s){if(this._ownMaterial(e),!e.produces.get(r)?.(s))return null;let a=this._id2glMaterialRef.get(s,e.id);if(a==null){let o=e.createGLMaterial({material:e,techniques:this._techniques,textures:this._textures,output:s});a=new Oa(o),this._id2glMaterialRef.set(s,e.id,a)}return a.ref(),a.glMaterial}release(e,r){let s=this._id2glMaterialRef.get(r,e.id);s!=null&&(s.unref(),s.referenced||(pt(s.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&dt.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Oa=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,ee(this._refCnt>=0)}get referenced(){return this._refCnt>0}};var qs=class{constructor(e,r){this.shadowMap=e,this.slicePlane=r,this.slot=U.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=ae.NONE,this.alignPixelEnabled=!1,this.decorations=an.ON,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new vt,this._inverseViewport=Y(),this.oldLighting=new Rs,this.newLighting=new Rs,this._fadedLighting=new Rs,this._lighting=this.newLighting,this.ssr=new wa,this.multipassEnabled=!1,this.multipassTerrain=new zn,this.multipassGeometry=new il,this.hudRenderStyle=sl.Occluded,this.cloudsFade=new Jn,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){let{oldLighting:r,newLighting:s}=this;e>=1?this._lighting=s:(this._fadedLighting.lerpLighting(r,s,e),this._lighting=this._fadedLighting)}},wa=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=V()}};var ks=class{constructor(e,r,s=null){this.rctx=e,this.sliceHelper=s,this.lastFrameCamera=new vt,this.output=E.Color,this.renderOccludedMask=Ys,this.bindParameters=new qs(r,s!=null?s.plane:null),this.bindParameters.alignPixelEnabled=!0}};var Ys=le.Occlude|le.OccludeAndTransparent|le.OccludeAndTransparentStencil;var or=class extends vt{constructor(){super(...arguments),this._projectionMatrix=V()}get projectionMatrix(){return this._projectionMatrix}};m([R()],or.prototype,"_projectionMatrix",void 0),m([R({readOnly:!0})],or.prototype,"projectionMatrix",null),or=m([Ye("esri.views.3d.webgl-engine.lib.CascadeCamera")],or);var Sa;(function(t){t[t.Highlight=0]="Highlight",t[t.ExcludeHighlight=1]="ExcludeHighlight"})(Sa||(Sa={}));var cr=class{constructor(){this.camera=new or,this.lightMat=V()}},Ca=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},Js=class{constructor(e,r){this._fbos=e,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Ca,this._projectionView=V(),this._projectionViewInverse=V(),this._modelViewLight=V(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=de(),this._cascades=[new cr,new cr,new cr,new cr],this._lastOrigin=null,this._maxTextureWidth=Math.min(xe("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return br(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=St(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=mt(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)ba[e]=this._cascades[e];return ba.length=this._numCascades,ba}start(e,r,s,i,a){ee(this.enabled);let{near:o,far:n}=Gh(s);this._computeCascadeDistances(o,n,i),this._textureHeight=this._computeTextureHeight(e,a,i),this._setupMatrices(e,r);let{viewMatrix:h,projectionMatrix:l}=e;for(let c=0;c<this._numCascades;++c)this._constructCascade(c,l,h,r);this._lastOrigin=null,this.clear()}finish(){ee(this.enabled),this._handle?.detachDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!it(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||S(),B(this._lastOrigin,e);for(let r=0;r<this._numCascades;++r){Mi(Gl,this._cascades[r].lightMat,e);for(let s=0;s<16;++s)Hl[16*r+s]=Gl[s]}}return Hl}moveSnapshot(e){ee(this.enabled),this._handle?.detachDepth(),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle=null,this.clear()}copySnapshot(e){let r=this._handle?.getTexture()?.descriptor;if(!this.enabled||!r)return;this._snapshots[e]?.release();let{width:s,height:i}=r,a=e===Sa.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[e]=this._fbos.acquire(s,i,a,tr.RGBA4);let o=this._fbos.rctx;this._bindFbo();let n=o.bindTexture(this._snapshots[e]?.getTexture(),Er.TEXTURE_UNIT_FOR_UPDATES);o.gl.copyTexSubImage2D(Wo.TEXTURE_2D,0,0,0,0,0,s,i),o.bindTexture(n,Er.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture():null}clear(){let e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clear(qt.COLOR_BUFFER_BIT|qt.DEPTH_BUFFER_BIT)}_computeTextureHeight(e,r,s){let i=Math.min(window.devicePixelRatio,r)/e.pixelRatio,a=s?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,o=_n(Math.floor(Math.max(e.fullWidth,e.fullHeight)*i*a)),n=Math.min(this._maxTextureWidth,this._numCascades*o);return yn(n/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",tr.RGBA4)),this._handle?.acquireDepth(Hn.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=St(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){let e=this._fbos.rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,r,s,i){let a=this._cascades[e],o=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],h=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]),l=(r[10]*n+r[14])/Math.abs(r[11]*n+r[15]);ee(h<l);for(let p=0;p<8;++p){br(Vl,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?h:l,1);let g=Ne[p];nt(g,Vl,this._projectionViewInverse),g[0]/=g[3],g[1]/=g[3],g[2]/=g[3]}ho(xa,Ne[0]),a.camera.viewMatrix=Mi(Vh,this._modelViewLight,xa);for(let p=0;p<8;++p)J(Ne[p],Ne[p],a.camera.viewMatrix);let c=Ne[0][2],u=Ne[0][2];for(let p=1;p<8;++p)c=Math.min(c,Ne[p][2]),u=Math.max(u,Ne[p][2]);c-=200,u+=200,a.camera.near=-u,a.camera.far=-c,Bh(s,i,c,u,a.camera),be(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);let d=this._textureHeight;a.camera.viewport=[e*d,0,d,d]}_setupMatrices(e,r){be(this._projectionView,e.projectionMatrix,e.viewMatrix),Xe(this._projectionViewInverse,this._projectionView);let s=this._viewingMode===ze.Global?e.eye:z(xa,0,0,1);os(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],s)}_computeCascadeDistances(e,r,s){let i=s?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Uo(r/e,4)),i);let a=(r-e)/this._numCascades,o=(r/e)**(1/this._numCascades),n=e,h=e;for(let l=0;l<this._numCascades+1;++l)this._cascadeDistances[l]=Ct(n,h,this.settings.splitSchemeLambda),n*=o,h+=a}get test(){}},Vh=V(),Vl=de(),Ne=[];for(let t=0;t<8;++t)Ne.push(de());var Fl=Y(),Ul=Y(),Fh=Y(),jl=Y(),Bl=Y(),xa=S(),ba=[],Gl=V(),Hl=He.concat(He,He,He,He),Ce=Y(),nr=Y(),Ut=[Y(),Y(),Y(),Y()],re=Y(),Ra=Y(),Ot=Y(),Hr=Y(),lr=Y(),hr=Y(),Xs=Y();function Uh(t,e,r,s,i,a,o,n){hs(Ce,0,0);for(let x=0;x<4;++x)gt(Ce,Ce,t[x]);Mt(Ce,Ce,.25),hs(nr,0,0);for(let x=4;x<8;++x)gt(nr,nr,t[x]);Mt(nr,nr,.25),Wt(Ut[0],t[4],t[5],.5),Wt(Ut[1],t[5],t[6],.5),Wt(Ut[2],t[6],t[7],.5),Wt(Ut[3],t[7],t[4],.5);let h=0,l=Ni(Ut[0],Ce);for(let x=1;x<4;++x){let A=Ni(Ut[x],Ce);A<l&&(l=A,h=x)}Et(re,Ut[h],t[h+4]);let c=re[0],u,d;re[0]=-re[1],re[1]=c,Et(Ra,nr,Ce),ne(Ra,re)<0&&No(re,re),Wt(re,re,Ra,r),Vi(re,re),u=d=ne(Et(Ot,t[0],Ce),re);for(let x=1;x<8;++x){let A=ne(Et(Ot,t[x],Ce),re);A<u?u=A:A>d&&(d=A)}Ht(s,Ce),Mt(Ot,re,u-e),gt(s,s,Ot);let p=-1,g=1,_=0,O=0;for(let x=0;x<8;++x){Et(Hr,t[x],s),Vi(Hr,Hr);let A=re[0]*Hr[1]-re[1]*Hr[0];A>0?A>p&&(p=A,_=x):A<g&&(g=A,O=x)}At(p>0,"leftArea"),At(g<0,"rightArea"),Mt(lr,re,u),gt(lr,lr,Ce),Mt(hr,re,d),gt(hr,hr,Ce),Xs[0]=-re[1],Xs[1]=re[0];let v=Sr(s,t[O],hr,gt(Ot,hr,Xs),1,i),w=Sr(s,t[_],hr,Ot,1,a),y=Sr(s,t[_],lr,gt(Ot,lr,Xs),1,o),C=Sr(s,t[O],lr,Ot,1,n);At(v,"rayRay"),At(w,"rayRay"),At(y,"rayRay"),At(C,"rayRay")}function N(t,e){return 3*e+t}var Wl=Y();function Oe(t,e){return hs(Wl,t[e],t[e+3]),Wl}var ge=Y(),b=Cr();function jh(t,e,r,s,i){Et(ge,r,s),Mt(ge,ge,.5),b[0]=ge[0],b[1]=ge[1],b[2]=0,b[3]=ge[1],b[4]=-ge[0],b[5]=0,b[6]=ge[0]*ge[0]+ge[1]*ge[1],b[7]=ge[0]*ge[1]-ge[1]*ge[0],b[8]=1,b[N(0,2)]=-ne(Oe(b,0),t),b[N(1,2)]=-ne(Oe(b,1),t);let a=ne(Oe(b,0),r)+b[N(0,2)],o=ne(Oe(b,1),r)+b[N(1,2)],n=ne(Oe(b,0),s)+b[N(0,2)],h=ne(Oe(b,1),s)+b[N(1,2)];a=-(a+n)/(o+h),b[N(0,0)]+=b[N(1,0)]*a,b[N(0,1)]+=b[N(1,1)]*a,b[N(0,2)]+=b[N(1,2)]*a,a=1/(ne(Oe(b,0),r)+b[N(0,2)]),o=1/(ne(Oe(b,1),r)+b[N(1,2)]),b[N(0,0)]*=a,b[N(0,1)]*=a,b[N(0,2)]*=a,b[N(1,0)]*=o,b[N(1,1)]*=o,b[N(1,2)]*=o,b[N(2,0)]=b[N(1,0)],b[N(2,1)]=b[N(1,1)],b[N(2,2)]=b[N(1,2)],b[N(1,2)]+=1,a=ne(Oe(b,1),e)+b[N(1,2)],o=ne(Oe(b,2),e)+b[N(2,2)],n=ne(Oe(b,1),r)+b[N(1,2)],h=ne(Oe(b,2),r)+b[N(2,2)],a=-.5*(a/o+n/h),b[N(1,0)]+=b[N(2,0)]*a,b[N(1,1)]+=b[N(2,1)]*a,b[N(1,2)]+=b[N(2,2)]*a,a=ne(Oe(b,1),e)+b[N(1,2)],o=ne(Oe(b,2),e)+b[N(2,2)],n=-o/a,b[N(1,0)]*=n,b[N(1,1)]*=n,b[N(1,2)]*=n,i[0]=b[0],i[1]=b[1],i[2]=0,i[3]=b[2],i[4]=b[3],i[5]=b[4],i[6]=0,i[7]=b[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=b[6],i[13]=b[7],i[14]=0,i[15]=b[8]}function Bh(t,e,r,s,i){let a=1/Ne[0][3],o=1/Ne[4][3];ee(a<o);let n=a+Math.sqrt(a*o),h=Math.sin(fo(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));n/=h,Uh(Ne,n,h,Fl,Ul,Fh,jl,Bl),jh(Fl,Ul,jl,Bl,i.projectionMatrix),i.projectionMatrix[10]=2/(r-s),i.projectionMatrix[14]=-(r+s)/(r-s)}function Gh(t){let{near:e,far:r}=t;return e<2&&(e=2),r<2&&(r=2),e>=r&&(e=2,r=4),{near:e,far:r}}var Ve,ct;(function(t){t[t.OBJECT=0]="OBJECT",t[t.HUD=1]="HUD",t[t.TERRAIN=2]="TERRAIN",t[t.OVERLAY=3]="OVERLAY",t[t.I3S=4]="I3S",t[t.PCL=5]="PCL",t[t.LOD=6]="LOD",t[t.VOXEL=7]="VOXEL",t[t.TILES3D=8]="TILES3D"})(Ve||(Ve={}));var Zs=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=ct.ALL,this.normalRequired=!0}};(function(t){t[t.MIN=0]="MIN",t[t.MINMAX=1]="MINMAX",t[t.ALL=2]="ALL"})(ct||(ct={}));var Ea=class{constructor(e,r,s){this.object=e,this.geometryId=r,this.triangleNr=s}},Qs=class extends Ea{constructor(e,r,s,i){super(e,r,s),this.center=i!=null?wr(i):null}};var Ma=class{constructor(e){this.layerUid=e}},$s=class extends Ma{constructor(e,r){super(e),this.graphicUid=r}};function Aa(t){return t?.dist!=null}var Pf=S();var Ks=class extends $s{constructor(e,r,s){super(e,r),this.triangleNr=s}};var zl=1e-5,Pa=class{constructor(e){this.options=new Zs,this._results=new Ia,this.transform=new Pn,this.tolerance=zl,this.verticalOffset=null,this._ray=Je(),this._rayEnd=S(),this._rayBeginTransformed=S(),this._rayEndTransformed=S(),this.viewingMode=e??ze.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,r,s){this.resetWithRay(hn(e,r,this._ray),s)}resetWithRay(e,r){this.camera=r,e!==this._ray&&ps(e,this._ray),this.options.verticalOffset!==0?this.viewingMode===ze.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,k(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,r,s,i,a){this.point=r,this.filterPredicate=i,this.tolerance=s??zl;let o=Xi(this.verticalOffset);if(e&&e.length>0){let n=a?h=>{a(h)&&this.intersectObject(h)}:h=>{this.intersectObject(h)};for(let h of e){let l=h.getSpatialQueryAccelerator?.();l!=null?(o!=null?l.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,n,o):l.forEachAlongRay(this._ray.origin,this._ray.direction,n),this.options.selectionMode&&this.options.hud&&l.forEachDegenerateObject(n)):h.objects.forAll(c=>n(c))}}this.sortResults()}intersectObject(e){let r=e.geometries;if(!r)return;let s=e.effectiveTransformation,i=Xi(this.verticalOffset);for(let a of r){if(!a.visible)continue;let{material:o,id:n}=a;this.transform.setAndInvalidateLazyTransforms(s,a.transformation),J(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),J(this._rayEndTransformed,this.rayEnd,this.transform.inverse);let h=this.transform.transform;i!=null&&(i.objectTransform=this.transform),o.intersect(a,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(l,c,u,d,p,g)=>{if(l>=0){if(this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,l))return;let _=d?this._results.hud:this._results,O=d?v=>{let w=new Qs(e,n,u,g);v.set(Ve.HUD,w,l,c,He,p)}:v=>v.set(Ve.OBJECT,{object:e,geometryId:n,triangleNr:u},l,c,h,p);if((_.min.drapedLayerOrder==null||p>=_.min.drapedLayerOrder)&&(_.min.dist==null||l<_.min.dist)&&O(_.min),this.options.store!==ct.MIN&&(_.max.drapedLayerOrder==null||p<_.max.drapedLayerOrder)&&(_.max.dist==null||l>_.max.dist)&&O(_.max),this.options.store===ct.ALL)if(d){let v=new zr(this._ray);O(v),this._results.hud.all.push(v)}else{let v=new wt(this._ray);O(v),this._results.all.push(v)}}})}}sortResults(e=this._results.all){e.sort((r,s)=>r.dist!==s.dist?(r.dist??0)-(s.dist??0):r.drapedLayerOrder!==s.drapedLayerOrder?ql(r.drapedLayerOrder,s.drapedLayerOrder):ql(r.drapedLayerGraphicOrder,s.drapedLayerGraphicOrder))}};function ql(t,e){return(e??-Number.MAX_VALUE)-(t??-Number.MAX_VALUE)}function Jf(t){return new Pa(t)}var Ia=class{constructor(){this.min=new wt(Je()),this.max=new wt(Je()),this.hud={min:new zr(Je()),max:new zr(Je()),all:new Array},this.ground=new wt(Je()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}},wt=class{get ray(){return this._ray}get distanceInRenderSpace(){return this.dist!=null?(q(ei,this.ray.direction,this.dist),Pe(ei)):null}getIntersectionPoint(e){return!!Aa(this)&&(q(ei,this.ray.direction,this.dist),k(e,this.ray.origin,ei),!0)}getTransformedNormal(e){return B(Wr,this.normal),Wr[3]=0,nt(Wr,Wr,this.transformation),B(e,Wr),Q(e,e)}constructor(e){this.intersector=Ve.OBJECT,this.normal=S(),this.transformation=V(),this._ray=Je(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=Ve.OBJECT,ps(e,this._ray)}set(e,r,s,i,a,o,n){this.intersector=e,this.dist=s,B(this.normal,i??lo),_e(this.transformation,a??He),this.target=r,this.drapedLayerOrder=o,this.drapedLayerGraphicOrder=n}copy(e){ps(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,B(this.normal,e.normal),_e(this.transformation,e.transformation)}},zr=class extends wt{constructor(){super(...arguments),this.intersector=Ve.HUD}};function kl(t){return new wt(t)}var ei=S(),Wr=de();var qr,Fe;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(qr||(qr={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(Fe||(Fe={}));var ti=class{constructor(e,r){this._material=e,this._repository=r,this._map=new Map}dispose(){this._map.forEach((e,r)=>{e!=null&&this._repository.release(this._material,r)})}load(e,r,s){if(!this._material.produces.get(r)?.(s))return null;this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,r,s));let a=this._map.get(s);if(a!=null){if(a.ensureResources(e)===sn.LOADED)return a;this._repository.requestRender()}return null}};var ri=class extends Qi{constructor(e=S()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}};var xt=class{constructor(e=0,r=0){this.from=e,this.to=r}get numElements(){return this.to-this.from}};function Da(t){let e=new Map;t.forAll(s=>e.set(s.from,s));let r=!0;for(;r;){r=!1;for(let s=0;s<t.length;++s){let i=t.data[s],a=e.get(i.to);if(!a)return;i.to=a.to,e.delete(a.from),t.removeUnordered(a),r=!0}}}var kr=class extends xt{constructor(e,r,s){super(r,s),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.geometry.highlights!=null&&this.isVisible}get hasOccludees(){return this.geometry.occludees!=null}};var si=class{constructor(){this.first=0,this.count=0}};var ai=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new ue({allocator:e=>e||new xt,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=ii(),this.drawCommandsHighlight=ii(),this.drawCommandsOccludees=ii(),this.drawCommandsShadowHighlightRest=ii()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,r){this.deleteInstance(e),this._instances.set(e,r),this._numElements+=r.numElements}deleteInstance(e){let r=this._instances.get(e);r&&(this._numElements-=r.numElements,this._instances.delete(e))}updateInstance(e,r,s){let i=this._instances.get(e);i&&(this._numElements-=i.numElements,i.from=r,i.to=s,this._numElements+=i.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){let s=this.drawCommandsDefault.pushNew(),i=this.holes.front();return this.vao!=null&&this.holes.length===1&&i.to===Math.floor(this.vao.byteSize/e)?(s.first=0,void(s.count=i.from)):(s.first=1/0,s.count=0,this._instances.forEach(a=>{s.first=Math.min(s.first,a.from),s.count=Math.max(s.count,a.to)}),void(s.count-=s.first))}let r=Array.from(this._instances.values()).sort((s,i)=>s.from===i.from?s.to-i.to:s.from-i.from);for(let s of r)s.isVisible&&(Yl(s.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,s),Yl(s.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,s))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function Xl(t){return t.vao!=null}function ii(){return new ue({allocator:t=>t||new si,deallocator:t=>t})}function Yl(t,e){let r=t.back();if(r==null){let s=t.pushNew();return s.first=e.from,void(s.count=e.numElements)}if(Hh(r,e)){let s=e.from-r.first+e.numElements;r.count=s}else{let s=t.pushNew();s.first=e.from,s.count=e.numElements}}function Hh(t,e){return t.first+t.count>=e.from}var oi=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(r=>r.instances.has(e))}};var ni=class{constructor(e,r){this._cache=e(r,(s,i,a)=>{switch(i){case Li.ALL:return s.forEach(o=>o.dispose()),0;case Li.SOME:{let o=s.shift();return o&&(a-=Math.round(o.usedMemory),o.dispose()),a}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){let r=this._cache.peek(e);if(!r)return;let s=r.pop();if(r.length>0){if(s){let i=this._cache.getSize(e)-Math.round(s.usedMemory);this._cache.updateSize(e,r,i)}}else this._cache.pop(e);return s}put(e,r,s=Io){let i=this._cache.peek(e);if(!i)return void this._cache.put(e,[r],r.usedMemory,s);i.push(r);let a=this._cache.getSize(e)+Math.round(r.usedMemory);this._cache.updateSize(e,i,a)}};var li=class extends qn{};var hi=class{constructor(e,r,s){this._rctx=e,this._locations=r,this._layout=s,this._cache=new ni(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){let r=e.toString(),s=this._cache.pop(r);return s||(s=new li(this._rctx,this._locations,{geometry:this._layout},{geometry:$o.createVertex(this._rctx,zo.STATIC_DRAW)}),s.vertexBuffers.geometry.setSize(e),s)}deleteVao(e){if(e==null)return;let r=e.byteSize.toString();this._cache.put(r,e)}};var Yr=class extends Ws{constructor(t){super(t),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._produces=new Map,this.drapedPriority=0}destroy(){this._glMaterials=pt(this._glMaterials),this._dataByOrigin.forEach(t=>t.dispose()),this._dataByOrigin.clear(),this._vaoCache=pt(this._vaoCache)}initialize(){this.material.produces.forEach((t,e)=>{this._produces.set(e,r=>!(this._dataByOrigin.size===0||!(r!==E.Highlight&&r!==E.ShadowHighlight||this._hasHighlights))&&t(r))})}get produces(){return this._produces}initializeRenderContext(t,e){let{rctx:r}=t.renderContext;this._glMaterials=new ti(this.material,e??t.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new hi(r,this.material.vertexAttributeLocations,qo(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(t){return this.material.queryRenderOccludedState(t)}get materialReference(){return this.material}get numGeometries(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((r,s)=>r+s.instances.size,0)),t}get usedMemory(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((r,s)=>r+s.vao.usedMemory,0)),t}forEachGeometry(t){this._dataByOrigin.forEach(e=>e.buffers.forEach(r=>r.instances.forEach(s=>t(s.geometry))))}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateDrawCommands()}_updateGeometries(t){let e=this._bufferWriter;if(e===null)return;let r=e.vertexBufferLayout.stride/4;for(let s of t){let i=s.renderGeometry,a=this._dataByOrigin.get(i.localOrigin.id),o=a?.findBuffer(i.id);if(o==null)return;let n=o.instances.get(i.id);if(s.updateType&(Fe.GEOMETRY|Fe.TRANSFORMATION)){let h=di(e.elementCount(n.geometry.geometry)*r),l=e.vertexBufferLayout.createView(h.buffer);this._writeGeometry(i,l,0),o.vao.vertexBuffers.geometry.setSubData(h,n.from*r,0,n.numElements*r)}s.updateType&(Fe.HIGHLIGHT|Fe.OCCLUDEE|Fe.VISIBILITY)&&(o.drawCommandsDirty=!0)}}_computeDeltas(t,e){let r=new Xt;for(let s of t){let i=s.localOrigin;if(i==null)continue;let a=r.get(i.id,null);a==null&&(a=new pi(i.vec3),r.set(i.id,null,a)),a.changes.push(s)}for(let s of e){let i=s.localOrigin;if(i==null)continue;let a=this._dataByOrigin.get(i.id),o=a?.findBuffer(s.id);if(o==null)continue;let n=r.get(i.id,o);n==null&&(n=new pi(i.vec3),r.set(i.id,o,n)),n.changes.push(s)}return r}_addAndRemoveGeometries(t,e){if(this._bufferWriter===null||this._vaoCache===null)return;let{_bufferWriter:r,_dataByOrigin:s}=this,i=r.vertexBufferLayout.stride/4,a=this._computeDeltas(t,e);a.forEach((o,n)=>{let h=o.get(null),l=h!=null?h.changes:[];a.delete(n,null);let c=s.get(n);if(o.forEach((u,d)=>{if(a.delete(n,d),d==null)return void ee(!1,"No VAO for removed geometries");if(d.instances.size===u.changes.length)return this._vaoCache.deleteVao(d.vao),xi(c.buffers,d),void(c.buffers.length===0&&l.length===0&&s.delete(n));let p=d.numElements,g=d.vao.byteSize/4,_=l.reduce((y,C)=>y+r.elementCount(C.geometry),0),O=u.changes.reduce((y,C)=>y+r.elementCount(C.geometry),0),v=Math.min((p+_-O)*i,ui),w=v>g;v>mi&&v<g/2?(u.changes.forEach(({id:y})=>d.deleteInstance(y)),d.instances.forEach(({geometry:y})=>l.push(y)),this._vaoCache.deleteVao(d.vao),xi(c.buffers,d)):w?this._applyAndRebuild(d,l,u):this._applyRemoves(d,u)}),l.length>0)for(c==null&&(c=new oi(h.origin),s.set(n,c)),c.buffers.forEach(u=>this._applyAdds(u,l));l.length>0;)c.buffers.push(this._applyAndRebuild(new ai,l,null))})}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(t=>{t.buffers.forEach(e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,Ue(e.instances,r=>(e.updateDrawState(r),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees})})}_applyAndRebuild(t,e,r){if(r!=null)for(let p of r.changes)t.deleteInstance(p.id);let s=this._bufferWriter,i=s.vertexBufferLayout.stride,a=i/4,o=Math.floor(ui/a),n=t.numElements;for(;e.length>0;){let p=e.pop(),g=s.elementCount(p.geometry);if(n+g>o&&n>0){e.push(p);break}n+=g;let _=new kr(p,0,0);ee(t.instances.get(p.id)==null),t.addInstance(p.id,_)}let h=n*a,l=di(h),c=s.vertexBufferLayout.createView(l.buffer),u=0;t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,t.instances.forEach((p,g)=>{this._writeGeometry(p.geometry,c,u);let _=u;u+=s.elementCount(p.geometry.geometry),t.updateInstance(g,_,u),t.updateDrawState(p)}),this._vaoCache.deleteVao(t.vao),t.vao=this._vaoCache.newVao(Ql(h)),t.vao.vertexBuffers.geometry.setSubData(l,0,0,u*a),t.holes.clear();let d=t.holes.pushNew();return d.from=u,d.to=Math.floor(t.vao.byteSize/i),t.updateDrawCommands(i),t}_applyRemoves(t,e){if(e.changes.length===0||this._bufferWriter===null)return;for(let o of e.changes){let n=o.id,h=t.instances.get(n);if(!h)continue;t.deleteInstance(n);let l=et.back();if(l){if(l.to===h.from){l.to=h.to;continue}if(l.from===h.to){l.from=h.from;continue}}let c=et.pushNew();c.from=h.from,c.to=h.to}Da(et);let r=this._bufferWriter.vertexBufferLayout.stride/4,s=et.reduce((o,n)=>Math.max(o,n.numElements),0)*r,i=di(s);i.fill(0,0,s);let a=t.vao.vertexBuffers.geometry;et.forAll(o=>a.setSubData(i,o.from*r,0,o.numElements*r)),t.holes.pushArray(et.data,et.length),et.forAll((o,n)=>et.data[n]=null),et.clear(),t.drawCommandsDirty=!0}_applyAdds(t,e){if(e.length===0||this._bufferWriter===null)return;if(!Xl(t))return void this._applyAndRebuild(t,e,null);let r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,i=t.numElements,a=e.reduce((O,v)=>O+r.elementCount(v.geometry),0),o=Math.min((i+a)*s,ui),n=4*o;if(t.vao.byteSize<Ql(ui-mi)&&n>t.vao.byteSize)return void this._applyAndRebuild(t,e,null);Da(t.holes);let h=new Array;for(let O of e){let v=r.elementCount(O.geometry),w=Wh(t.holes,v);h.push(w)}let l=t.vao.vertexBuffers.geometry,c=0,u=0,d=0,p=di(o),g=r.vertexBufferLayout.createView(p.buffer);e.forEach((O,v)=>{let w=h[v];if(w==null)return;if(d!==w){let x=d-u;x>0&&l.setSubData(p,u*s,0,x*s),u=w,c=0}let y=r.elementCount(O.geometry);this._writeGeometry(O,g,c),c+=y,d=w+y;let C=new kr(O,w,w+y);ee(t.instances.get(O.id)==null),t.addInstance(O.id,C),t.drawCommandsDirty=!0});let _=d-u;_>0&&l.setSubData(p,u*s,0,_*s),$a(e,(O,v)=>h[v]==null)}_writeGeometry(t,e,r){if(this._bufferWriter===null)return;let s=t.localOrigin.vec3;jo(Jl,-s[0],-s[1],-s[2]);let i=be(zh,Jl,t.transformation);Xe(ci,i),as(ci,ci),this._bufferWriter.write(i,ci,t.geometry,e,r)}updateAnimation(t){return this.material.update(t)}prepareTechnique(t){if(!this.material.shouldRender(t))return null;let{output:e,bindParameters:r}=t;if(!this.material.produces.get(r.slot)?.(e))return null;let i=e===E.Highlight||e===E.ShadowHighlight;if(i&&!this._hasHighlights)return null;let a=e===E.ShadowExcludeHighlight,o=!(i||a);for(let n of this._dataByOrigin.values())for(let h of n.buffers){if(i&&!h.hasHighlights)continue;let l=(i?h.drawCommandsHighlight:a&&h.needsMultipleCommands()?h.drawCommandsShadowHighlightRest:h.drawCommandsDefault)||null,c=o&&h.drawCommandsOccludees||null;if(l?.length||c?.length){let u=this._glMaterials.load(t.rctx,r.slot,e),d=u!=null?u.beginSlot(r):null;if(d!=null)return d}}return null}renderNode(t,e){let{output:r,bindParameters:s}=t,i=r===E.Highlight||r===E.ShadowHighlight,a=r===E.ShadowExcludeHighlight,o=!(i||a),n=s.slot===U.OCCLUDER_MATERIAL,h=s.slot===U.TRANSPARENT_OCCLUDER_MATERIAL,l=t.rctx;l.runAppleAmdDriverHelper(),l.bindTechnique(e,s,this.material.parameters);for(let c of this._dataByOrigin.values())for(let u of c.buffers){if(i&&!u.hasHighlights)continue;let d=(i?u.drawCommandsHighlight:a&&u.needsMultipleCommands()?u.drawCommandsShadowHighlightRest:u.drawCommandsDefault)||null,p=o&&u.drawCommandsOccludees||null;(d?.length||p?.length)&&(e.program.bindDraw(new ri(c.origin),s,this.material.parameters),e.ensureAttributeLocations(u.vao),l.bindVAO(u.vao),d?.length&&(l.setPipelineState(e.getPipeline(!1,n,h)),d.forAll(g=>l.drawArrays(e.primitiveType,g.first,g.count))),p?.length&&(l.setPipelineState(e.getPipeline(!0,n,h)),p.forAll(g=>l.drawArrays(e.primitiveType,g.first,g.count))))}}get test(){}};m([R({constructOnly:!0})],Yr.prototype,"material",void 0),Yr=m([Ye("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],Yr);var pi=class{constructor(e){this.origin=e,this.changes=new Array}};function Wh(t,e){let r;if(!t.some(i=>!(i.numElements<e)&&(r=i,!0)))return null;let s=r.from;return r.from+=e,r.from>=r.to&&t.removeUnordered(r),s}var Jl=V(),zh=V(),ci=V(),et=new ue({allocator:t=>t||new xt,deallocator:null}),mi=65536,La=4*mi,Zl=1024,$l=16777216,ui=$l/4,Na=new Float32Array(mi);function di(t){return Na.length<t&&(Na=new Float32Array(t)),Na}function Ql(t){let e=4*t;return e<=Zl?Zl:e<La?mo(e):Math.max(Math.min(Math.ceil(1.5*e/La)*La,$l),e)}var Ee=class extends Gt{constructor(t){super(t),this._pending=new Fa,this._changes=new Ls,this._materialRenderers=new Map,this._sortedMaterialRenderers=new ue,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(t=>t.destroy()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return Ue(this._materialRenderers,t=>t.numGeometries!==0&&!t.queryRenderOccludedState(le.Occlude))}get isEmpty(){return!this.updating&&this._materialRenderers.size===0&&this._geometries.size===0}getMaterialRenderer(t){return this._materialRenderers.get(t)}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();let t=Cl(this._changes),e=!1;return t.forEach((r,s)=>{let i=this.getMaterialRenderer(s);if(!i&&r.adds.length>0){let a=new Yr({material:s});a.initializeRenderContext(this.rendererContext.pluginContext,this._materials),i=a,this._materialRenderers.set(s,i),e=!0}i&&(i.modify(r),i.numGeometries===0&&(this._materialRenderers.delete(s),i.destroy(),e=!0))}),this._changes.clear(),e&&this._updateSortedMaterialRenderers(),this._hasHighlights=Ue(this._materialRenderers,r=>{let s=r.produces.get(U.DRAPED_MATERIAL);return!!s&&s(E.Highlight)}),this._hasWater=Ue(this._materialRenderers,r=>{let s=r.produces.get(U.DRAPED_WATER);return!!s&&s(E.Normal)}),this.notifyChange("updating"),!0}addGeometries(t,e){if(t.length===0)return;let r=this._validateRenderGeometries(t);for(let i of r)this._geometries.set(i.id,i);let s=this._pending.empty;for(let i of r)this._pending.adds.add(i);s&&this.notifyChange("updating"),e===qr.UPDATE&&this._notifyGraphicGeometryChanged(t)}removeGeometries(t,e){let r=this._pending.empty,s=this._pending.adds;for(let i of t)s.has(i)?(this._pending.removed.add(i),s.delete(i)):this._pending.removed.has(i)||this._pending.removes.add(i),this._geometries.delete(i.id);r&&!this._pending.empty&&this.notifyChange("updating"),e===qr.UPDATE&&this._notifyGraphicGeometryChanged(t)}modifyGeometries(t,e){let r=this._changes.updates.length===0;for(let s of t){let i=this._changes.updates.pushNew();i.renderGeometry=this._validateRenderGeometry(s),i.updateType=e}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),e){case Fe.TRANSFORMATION:case Fe.GEOMETRY:return this._notifyGraphicGeometryChanged(t);case Fe.VISIBILITY:return this._notifyGraphicVisibilityChanged(t)}}updateAnimation(t){let e=!1;return this._sortedMaterialRenderers.forAll(r=>e=!!r.updateAnimation&&r.updateAnimation(t)||e),e}shouldRender(t){return this._sortedMaterialRenderers.some(e=>e.prepareTechnique(t))}render(t){this._sortedMaterialRenderers.forAll(e=>{let r=e.prepareTechnique(t);r!=null&&e.renderNode(t,r)})}intersect(t,e,r,s,i){return this._geometries.forEach(a=>{if(s&&!s(a))return;this._intersectRenderGeometry(a,r,e,0,t,i);let o=this.rendererContext.longitudeCyclical;o&&(a.boundingSphere[0]-a.boundingSphere[3]<o.min&&this._intersectRenderGeometry(a,r,e,o.range,t,i),a.boundingSphere[0]+a.boundingSphere[3]>o.max&&this._intersectRenderGeometry(a,r,e,-o.range,t,i)),i++}),i}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let t=0;for(let e of this._materialRenderers.values())e.drapedPriority=t++,this._sortedMaterialRenderers.push(e);this._sortedMaterialRenderers.sort((e,r)=>r.materialReference?.renderPriority===e.materialReference?.renderPriority?e.drapedPriority-r.drapedPriority:(r.materialReference?.renderPriority||0)-(e.materialReference?.renderPriority||0))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let t=0;t<this._changes.updates.length;){let e=this._changes.updates.data[t];this._pending.has(e.renderGeometry)?this._changes.updates.removeUnorderedIndex(t):t++}this._pending.clear()}_intersectRenderGeometry(t,e,r,s,i,a){if(!t.visible)return;let o=0;s+=t.transformation[12],o=t.transformation[13],Va[0]=r[0]-s,Va[1]=r[1]-o,t.screenToWorldRatio=this.rendererContext.screenToWorldRatio,t.material.intersectDraped(t,null,i,Va,(n,h,l)=>{qh(e,l,a,t.material.renderPriority,i,t.layerUid,t.graphicUid)},e)}_notifyGraphicGeometryChanged(t){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let e;for(let r of t){let s=r.graphicUid;s!=null&&s!==e&&(this.drapeSource.notifyGraphicGeometryChanged(s),e=s)}}_notifyGraphicVisibilityChanged(t){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let e;for(let r of t){let s=r.graphicUid;s!=null&&s!==e&&(this.drapeSource.notifyGraphicVisibilityChanged(s),e=s)}}_validateRenderGeometries(t){for(let e of t)this._validateRenderGeometry(e);return t}_validateRenderGeometry(t){return t.localOrigin==null&&(t.localOrigin=this._localOriginFactory.getOrigin(t.boundingSphere)),t}get test(){}};m([R()],Ee.prototype,"drapeSource",void 0),m([R()],Ee.prototype,"updating",null),m([R()],Ee.prototype,"rctx",null),m([R({constructOnly:!0})],Ee.prototype,"rendererContext",void 0),m([R()],Ee.prototype,"_materials",null),m([R()],Ee.prototype,"_localOriginFactory",null),m([R({readOnly:!0})],Ee.prototype,"isEmpty",null),m([R()],Ee.prototype,"_materialRenderers",void 0),m([R()],Ee.prototype,"_geometries",void 0),Ee=m([Ye("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Ee);var Fa=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function qh(t,e,r,s,i,a,o){let n=new Ks(a,o,e),h=l=>{l.set(Ve.OVERLAY,n,t.dist,t.normal,t.transformation,r,s)};if((i.results.min.drapedLayerOrder==null||r>=i.results.min.drapedLayerOrder)&&(i.results.min.dist==null||i.results.ground.dist<=i.results.min.dist)&&h(i.results.min),i.options.store!==ct.MIN&&(i.results.max.drapedLayerOrder==null||r<i.results.max.drapedLayerOrder)&&(i.results.max.dist==null||i.results.ground.dist>i.results.max.dist)&&h(i.results.max),i.options.store===ct.ALL){let l=kl(i.ray);h(l),i.results.all.push(l)}}var Va=Y();var Xr=class t extends Qe{initializeProgram(e){return new $e(e.rctx,t.shader.get().build(),_t)}initializePipeline(){return this.configuration.hasAlpha?ve({blending:bn(Ge.SRC_ALPHA,Ge.ONE,Ge.ONE_MINUS_SRC_ALPHA,Ge.ONE_MINUS_SRC_ALPHA),colorWrite:Re}):ve({colorWrite:Re})}};Xr.shader=new Ze(Qn,()=>import("./chunk-IWZSGB3O.js"));var Jr=class extends bs{constructor(){super(...arguments),this.hasAlpha=!1}};m([D()],Jr.prototype,"hasAlpha",void 0);var Zr=class t extends Qe{initializeProgram(e){return new $e(e.rctx,t.shader.get().build(),_t)}initializePipeline(){return ve({blending:Os(Ge.ONE,Ge.ONE_MINUS_SRC_ALPHA),colorWrite:Re})}};Zr.shader=new Ze(ol,()=>import("./chunk-V2MJCTMW.js"));var ke=class extends Hs{constructor(t){super(t),this._overlays=null,this._renderTargets=null,this._overlayParameters=new al,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new ue,this._passParameters=new Zn,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new vt,this.worldToPCSRatio=1,this.events=new ss,this.longitudeCyclical=null,this.produces=new Map([[U.DRAPED_MATERIAL,e=>e!==E.Highlight||this.hasHighlights],[U.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){let t=this.view._stage.renderer.fboCache,e=this.view._stage.renderView,{waterTextures:r,stippleTextures:s,markerTextures:i}=e;this._techniques=new Gs({rctx:this._rctx,viewingMode:ze.Local,stippleTextures:s,markerTextures:i,waterTextures:r}),this._renderContext=new ks(this._rctx,new Js(t,this.view.state.viewingMode),null),this.addHandles([is(()=>r.updating,()=>this.events.emit("content-changed"),bi),is(()=>this.spatialReference,a=>this._localOriginFactory=new Us(a),bi),to(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]),this._materials=new zs(e.textures,this._techniques,()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed")),this._bindParameters.slot=U.DRAPED_MATERIAL,this._bindParameters.mainDepth=null,this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=ae.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new Wn(je(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(Do.STAGE,this))}destroy(){this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._debugTextureTechnique=St(this._debugTextureTechnique),this._passParameters.texture=pt(this._passParameters.texture),this._techniques=es(this._techniques),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}initializeRenderContext(t){this.pluginContext=t}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||Ue(this._renderers,t=>t.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(t){for(let e of this._renderers.values()){let r=e.getMaterialRenderer(t);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(t=>t.drapeSource.layer).filter(t=>!!t)}createGeometryDrapeSourceRenderer(t){return this.createDrapeSourceRenderer(t,Ee)}createDrapeSourceRenderer(t,e,r){let s=this._renderers.get(t);s?.destroy();let i=new e(Qa(Or({},r),{rendererContext:this,drapeSource:t}));return this._renderers.set(t,i),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in t&&this.addHandles(is(()=>t.fullOpacity,()=>this.events.emit("content-changed")),t),i}removeDrapeSourceRenderer(t){if(t==null)return;let e=this._renderers.get(t);e!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(t),this.removeHandles(t),e.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(t){this._hasTargetWithoutRasterImage=!!this._overlays&&ts(t,e=>e.drapeTargetType===Cs.WithoutRasterImage)}ensureDrapeSources(t){this._overlays?(this._hasDrapedFeatureSource=ts(t,e=>e.drapeSourceType===sr.Features),this._hasDrapedRasterSource=ts(t,e=>e.drapeSourceType===sr.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(t,e,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new Bs(this.view._stage.renderer.fboCache),this._overlays=[new Br,new Br]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=pt(this._renderTargets),this.events.emit("textures-disposed")}getTexture(t){if(t!=null)return t===se.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(se.Color):this._renderTargets?.getTexture(t)}get running(){return this.updating}runTask(t){this._processDrapeSources(t,()=>!0)}_processDrapeSources(t,e){let r=!1;for(let[s,i]of this._renderers){if(t.done)break;(s.destroyed||e(s))&&i.commitChanges()&&(r=!0,t.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=Ue(this._renderers,s=>s.hasHighlights),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Lo,t=>t.updatePolicy===Dt.SYNC)}get isEmpty(){return!er.OVERLAY_DRAW_DEBUG_TEXTURE&&!Ue(this._renderers,t=>!t.isEmpty)}get hasWater(){return this._hasWater}get rendersOccludedDraped(){let t=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=Kl;let e=this._sortedRenderers.some(({renderer:r})=>r.shouldRender(this._renderContext));return this._renderContext.renderOccludedMask=t,e}renders(t){return er.OVERLAY_DRAW_DEBUG_TEXTURE&&t!==se.Occluded||this._sortedRenderers.some(({renderer:e})=>e.shouldRender(this._renderContext))}get mode(){return this.isEmpty?Ft.Disabled:this._renderTargets?.getTexture(se.WaterNormal)?Ft.EnabledWithWater:this._renderTargets?.getTexture(se.Color)?Ft.Enabled:Ft.Disabled}updateAnimation(t){let e=!1;return this._renderers.forEach(r=>e=r.updateAnimation(t)||e),e}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(t){if(this._overlays&&this._renderTargets){for(let e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryViewsDirect();for(let e of this._renderTargets.targets){if(e.content===se.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;let r=this._drawTarget(rr.INNER,e,t),s=this._drawTarget(rr.OUTER,e,t);(r||s)&&e.fbo.generateMipMap()}}}_drawTarget(t,e,r){let s=this._overlays[t],i=s.canvasGeometries;if(i.numViews===0)return!1;let{alignPixelEnabled:a,contentPixelRatio:o}=r;this._screenToWorldRatio=o*s.mapUnitsPerPixel/this._bindParameters.overlayStretch;let n=e.output;if(this.isEmpty||n===E.Highlight&&!this.hasHighlights||n===E.Normal&&!this.hasWater||!s.hasSomeSizedView())return!1;let h=this._rctx;if(this._camera.pixelRatio=s.pixelRatio*o,this._renderContext.output=n,this._bindParameters.alignPixelEnabled=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=n===E.Normal?U.DRAPED_WATER:U.DRAPED_MATERIAL,e.content===se.Occluded&&(this._renderContext.renderOccludedMask=Kl),!this.renders(e.content))return this._renderContext.renderOccludedMask=Ys,!1;let l=s.resolution;this._rctx.setViewport(t===rr.INNER?0:l,0,l,l);let c=2*s.resolution,u=s.resolution,d=e.fbo;if(d.bind(h,c,u),t===rr.INNER&&(h.setClearColor(0,0,0,0),h.clear(qt.COLOR_BUFFER_BIT)),er.OVERLAY_DRAW_DEBUG_TEXTURE&&e.content!==se.Occluded)for(let p=0;p<i.numViews;p++)this._setViewParameters(i.extents[p],s),this._ensureDebugPatternResources(s.resolution,kh[t]),this._rctx.bindTechnique(this._debugTextureTechnique,this._renderContext.bindParameters,this._passParameters),this._rctx.screen.draw();return this._sortedRenderers.forAll(({drapeSource:p,renderer:g})=>{if(e.content===se.ColorNoRasterImage&&p.drapeSourceType===sr.RasterImage)return;let{fullOpacity:_}=p,O=_!=null&&_<1&&n===E.Color?this.bindTemporaryFramebuffer(c,u):null;for(let v=0;v<i.numViews;v++)this._setViewParameters(i.extents[v],s),g.render(this._renderContext);if(O){d.bind(h,c,u),this._overlayParameters.texture=O.getTexture(),this._overlayParameters.opacity=_,this._overlayParameters.overlayIndex=t;let v=this.pluginContext.techniques.acquire(Zr);this._rctx.bindTechnique(v,this._renderContext.bindParameters,this._overlayParameters),this._rctx.screen.draw(),v.release(),O.release()}}),h.bindFramebuffer(null),this._renderContext.renderOccludedMask=Ys,!0}bindTemporaryFramebuffer(t,e){let r=this.view._stage.renderer.fboCache,s=r.acquire(t,e,"overlay tmp");return r.rctx.unbindTexture(s.fbo?.colorTexture),r.rctx.bindFramebuffer(s.fbo),r.rctx.clear(qt.COLOR_BUFFER_BIT),s}reloadShaders(){return Rt(this,null,function*(){yield this._techniques.reloadAll()})}notifyContentChanged(){this.events.emit("content-changed")}intersect(t,e,r,s){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(let{renderer:a}of this._sortedRenderers)i=a.intersect?.(t,e,r,s,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;let t=this.view.map.allLayers,e=t.length;this._renderers.forEach((r,s)=>{let i=t.indexOf(s.layer),a=i>=0,o=s.renderGroup??(a?Nr.MapLayer:Nr.ViewLayer),n=e*o+(a?i:0);this._sortedRenderers.push(new Ua(s,r,n))}),this._sortedRenderers.sort((r,s)=>r.index-s.index)}_setViewParameters(t,e){let r=this._camera;r.viewport=[0,0,e.resolution,e.resolution],xo(r.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],r.near,r.far),Oo(r.viewMatrix,[-t[0],-t[1],0])}_updateHasWater(){let t=Ue(this._renderers,e=>e.hasWater);t!==this._hasWater&&(this._hasWater=t,this.events.emit("has-water",t))}_ensureDebugPatternResources(t,e){if(z(this._passParameters.color,e[0],e[1],e[2]),this._passParameters.texture)return;let r=new Uint8Array(t*t*4),s=0;for(let o=0;o<t;o++)for(let n=0;n<t;n++){let h=Math.floor(n/10),l=Math.floor(o/10);h<2||l<2||10*h>t-20||10*l>t-20?(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=255):(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=1&h&&1&l?1&n^1&o?0:255:1&h^1&l?0:128)}let i=new Ko(t);i.samplingMode=Ho.NEAREST,this._passParameters.texture=new Er(this._rctx,i,r);let a=new Jr;a.hasAlpha=!0,this._debugTextureTechnique=this._techniques.acquire(Xr,a)}get test(){}};m([R()],ke.prototype,"hasHighlights",void 0),m([R()],ke.prototype,"_sortedDrapeSourceRenderersDirty",void 0),m([R()],ke.prototype,"_techniques",void 0),m([R({constructOnly:!0})],ke.prototype,"view",void 0),m([R()],ke.prototype,"worldToPCSRatio",void 0),m([R()],ke.prototype,"spatialReference",void 0),m([R({type:Boolean,readOnly:!0})],ke.prototype,"updating",null),m([R()],ke.prototype,"isEmpty",null),m([R({readOnly:!0})],ke.prototype,"rendersOccludedDraped",null),ke=m([Ye("esri.views.3d.terrain.OverlayRenderer")],ke);var Ua=class{constructor(e,r,s){this.drapeSource=e,this.renderer=r,this.index=s}},kh=[[1,.5,.5],[.5,.5,1]],My=-2,Kl=le.OccludeAndTransparent;var fi;(function(t){function e(o,n){let h=o[n],l=o[n+1],c=o[n+2];return Math.sqrt(h*h+l*l+c*c)}function r(o,n){let h=o[n],l=o[n+1],c=o[n+2],u=1/Math.sqrt(h*h+l*l+c*c);o[n]*=u,o[n+1]*=u,o[n+2]*=u}function s(o,n,h){o[n]*=h,o[n+1]*=h,o[n+2]*=h}function i(o,n,h,l,c,u=n){(c=c||o)[u]=o[n]+h[l],c[u+1]=o[n+1]+h[l+1],c[u+2]=o[n+2]+h[l+2]}function a(o,n,h,l,c,u=n){(c=c||o)[u]=o[n]-h[l],c[u+1]=o[n+1]-h[l+1],c[u+2]=o[n+2]-h[l+2]}t.length=e,t.normalize=r,t.scale=s,t.add=i,t.subtract=a})(fi||(fi={}));var ur=fi,ja=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],Yh=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],Xh=[0,0,1,0,1,1,0,1],Jh=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],rh=new Array(36);for(let t=0;t<6;t++)for(let e=0;e<6;e++)rh[6*t+e]=t;var jt=new Array(36);for(let t=0;t<6;t++)jt[6*t]=0,jt[6*t+1]=1,jt[6*t+2]=2,jt[6*t+3]=2,jt[6*t+4]=3,jt[6*t+5]=0;function Jy(t,e){Array.isArray(e)||(e=[e,e,e]);let r=new Array(24);for(let s=0;s<8;s++)r[3*s]=ja[s][0]*e[0],r[3*s+1]=ja[s][1]*e[1],r[3*s+2]=ja[s][2]*e[2];return new ye(t,[[f.POSITION,new G(r,Jh,3,!0)],[f.NORMAL,new G(Yh,rh,3)],[f.UV0,new G(Xh,jt,2)]])}var Ba=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],Zh=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],Qh=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],$h=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function Zy(t,e){Array.isArray(e)||(e=[e,e,e]);let r=new Array(18);for(let s=0;s<6;s++)r[3*s]=Ba[s][0]*e[0],r[3*s+1]=Ba[s][1]*e[1],r[3*s+2]=Ba[s][2]*e[2];return new ye(t,[[f.POSITION,new G(r,Qh,3,!0)],[f.NORMAL,new G(Zh,$h,3)]])}var gi=te(-.5,0,-.5),_i=te(.5,0,-.5),yi=te(0,0,.5),vi=te(0,.5,0),dr=Le(),pr=Le(),fr=Le(),gr=Le(),_r=Le();$(dr,gi,vi),$(pr,gi,_i),Ie(fr,dr,pr),Q(fr,fr),$(dr,_i,vi),$(pr,_i,yi),Ie(gr,dr,pr),Q(gr,gr),$(dr,yi,vi),$(pr,yi,gi),Ie(_r,dr,pr),Q(_r,_r);var Ga=[gi,_i,yi,vi],Kh=[0,-1,0,fr[0],fr[1],fr[2],gr[0],gr[1],gr[2],_r[0],_r[1],_r[2]],ec=[0,1,2,3,1,0,3,2,1,3,0,2],tc=[0,0,0,1,1,1,2,2,2,3,3,3];function Qy(t,e){Array.isArray(e)||(e=[e,e,e]);let r=new Array(12);for(let s=0;s<4;s++)r[3*s]=Ga[s][0]*e[0],r[3*s+1]=Ga[s][1]*e[1],r[3*s+2]=Ga[s][2]*e[2];return new ye(t,[[f.POSITION,new G(r,ec,3,!0)],[f.NORMAL,new G(Kh,tc,3)]])}function $y(t,e,r,s,i={uv:!0}){let a=-Math.PI,o=2*Math.PI,n=-Math.PI/2,h=Math.PI,l=Math.max(3,Math.floor(r)),c=Math.max(2,Math.floor(s)),u=(l+1)*(c+1),d=De(3*u),p=De(3*u),g=De(2*u),_=[],O=0;for(let y=0;y<=c;y++){let C=[],x=y/c,A=n+x*h,T=Math.cos(A);for(let W=0;W<=l;W++){let H=W/l,M=a+H*o,ie=Math.cos(M)*T,F=Math.sin(A),tt=-Math.sin(M)*T;d[3*O]=ie*e,d[3*O+1]=F*e,d[3*O+2]=tt*e,p[3*O]=ie,p[3*O+1]=F,p[3*O+2]=tt,g[2*O]=H,g[2*O+1]=x,C.push(O),++O}_.push(C)}let v=new Array;for(let y=0;y<c;y++)for(let C=0;C<l;C++){let x=_[y][C],A=_[y][C+1],T=_[y+1][C+1],W=_[y+1][C];y===0?(v.push(x),v.push(T),v.push(W)):y===c-1?(v.push(x),v.push(A),v.push(T)):(v.push(x),v.push(A),v.push(T),v.push(T),v.push(W),v.push(x))}let w=[[f.POSITION,new G(d,v,3,!0)],[f.NORMAL,new G(p,v,3,!0)]];return i.uv&&w.push([f.UV0,new G(g,v,2,!0)]),i.offset&&(w[0][0]=f.OFFSET,w.push([f.POSITION,new G(Float64Array.from(i.offset),Fi(v.length),3,!0)])),new ye(t,w)}function Ky(t,e,r,s){let i=rc(e,r,s);return new ye(t,i)}function rc(t,e,r){let s=t,i,a;if(r)i=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],a=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{let l=s*(1+Math.sqrt(5))/2;i=[-s,l,0,s,l,0,-s,-l,0,s,-l,0,0,-s,l,0,s,l,0,-s,-l,0,s,-l,l,0,-s,l,0,s,-l,0,-s,-l,0,s],a=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let l=0;l<i.length;l+=3)ur.scale(i,l,t/ur.length(i,l));let o={};function n(l,c){l>c&&([l,c]=[c,l]);let u=l.toString()+"."+c.toString();if(o[u])return o[u];let d=i.length;return i.length+=3,ur.add(i,3*l,i,3*c,i,d),ur.scale(i,d,t/ur.length(i,d)),d/=3,o[u]=d,d}for(let l=0;l<e;l++){let c=a.length,u=new Array(4*c);for(let d=0;d<c;d+=3){let p=a[d],g=a[d+1],_=a[d+2],O=n(p,g),v=n(g,_),w=n(_,p),y=4*d;u[y]=p,u[y+1]=O,u[y+2]=w,u[y+3]=g,u[y+4]=v,u[y+5]=O,u[y+6]=_,u[y+7]=w,u[y+8]=v,u[y+9]=O,u[y+10]=v,u[y+11]=w}a=u,o={}}let h=Ui(i);for(let l=0;l<h.length;l+=3)ur.normalize(h,l);return[[f.POSITION,new G(Ui(i),a,3,!0)],[f.NORMAL,new G(h,a,3,!0)]]}function e0(t,e,r,s,i,a,o,n,h=null){let l=r?wr(r):S(),c=e?wr(e):je(0,0,1);o??=Y();let u=s?[255*s[0],255*s[1],255*s[2],s.length>3?255*s[3]:255]:[255,255,255,255],d=i!=null&&i.length===2?i:[1,1],p=Fi(1),g=[[f.POSITION,new G(l,p,3,!0)],[f.NORMAL,new G(c,p,3,!0)],[f.UV0,new G(o,p,o.length)],[f.COLOR,new G(u,p,4,!0)],[f.SIZE,new G(d,p,2)]];if(a!=null&&(a=[a[0],a[1],a[2],a[3]],g.push([f.CENTEROFFSETANDDISTANCE,new G(a,p,4)])),n){let _=[n[0],n[1],n[2],n[3]];g.push([f.FEATUREATTRIBUTE,new G(_,p,4)])}return new ye(t,g,null,lt.Point,h)}function t0(t,e,r,s,i,a=!0,o=!0){let n=0,h=r,l=e,c=te(0,n,0),u=te(0,n+l,0),d=te(0,-1,0),p=te(0,1,0);i&&(n=l,u=te(0,0,0),c=te(0,n,0),d=te(0,1,0),p=te(0,-1,0));let g=[u,c],_=[d,p],O=s+2,v=Math.sqrt(l*l+h*h);if(i)for(let T=s-1;T>=0;T--){let W=T*(2*Math.PI/s),H=te(Math.cos(W)*h,n,Math.sin(W)*h);g.push(H);let M=te(l*Math.cos(W)/v,-h/v,l*Math.sin(W)/v);_.push(M)}else for(let T=0;T<s;T++){let W=T*(2*Math.PI/s),H=te(Math.cos(W)*h,n,Math.sin(W)*h);g.push(H);let M=te(l*Math.cos(W)/v,h/v,l*Math.sin(W)/v);_.push(M)}let w=new Array,y=new Array;if(a){for(let T=3;T<g.length;T++)w.push(1),w.push(T-1),w.push(T),y.push(0),y.push(0),y.push(0);w.push(g.length-1),w.push(2),w.push(1),y.push(0),y.push(0),y.push(0)}if(o){for(let T=3;T<g.length;T++)w.push(T),w.push(T-1),w.push(0),y.push(T),y.push(T-1),y.push(1);w.push(0),w.push(2),w.push(g.length-1),y.push(1),y.push(2),y.push(_.length-1)}let C=De(3*O);for(let T=0;T<O;T++)C[3*T]=g[T][0],C[3*T+1]=g[T][1],C[3*T+2]=g[T][2];let x=De(3*O);for(let T=0;T<O;T++)x[3*T]=_[T][0],x[3*T+1]=_[T][1],x[3*T+2]=_[T][2];let A=[[f.POSITION,new G(C,w,3,!0)],[f.NORMAL,new G(x,y,3,!0)]];return new ye(t,A)}function r0(t,e,r,s,i,a,o){let n=i?Gi(i):te(1,0,0),h=a?Gi(a):te(0,0,0);o??=!0;let l=Le();Q(l,n);let c=Le();q(c,l,Math.abs(e));let u=Le();q(u,c,-.5),k(u,u,h);let d=te(0,1,0);Math.abs(1-Be(l,d))<.2&&z(d,0,0,1);let p=Le();Ie(p,l,d),Q(p,p),Ie(d,p,l);let g=2*s+(o?2:0),_=s+(o?2:0),O=De(3*g),v=De(3*_),w=De(2*g),y=new Array(3*s*(o?4:2)),C=new Array(3*s*(o?4:2));o&&(O[3*(g-2)]=u[0],O[3*(g-2)+1]=u[1],O[3*(g-2)+2]=u[2],w[2*(g-2)]=0,w[2*(g-2)+1]=0,O[3*(g-1)]=O[3*(g-2)]+c[0],O[3*(g-1)+1]=O[3*(g-2)+1]+c[1],O[3*(g-1)+2]=O[3*(g-2)+2]+c[2],w[2*(g-1)]=1,w[2*(g-1)+1]=1,v[3*(_-2)]=-l[0],v[3*(_-2)+1]=-l[1],v[3*(_-2)+2]=-l[2],v[3*(_-1)]=l[0],v[3*(_-1)+1]=l[1],v[3*(_-1)+2]=l[2]);let x=(M,ie,F)=>{y[M]=ie,C[M]=F},A=0,T=Le(),W=Le();for(let M=0;M<s;M++){let ie=M*(2*Math.PI/s);q(T,d,Math.sin(ie)),q(W,p,Math.cos(ie)),k(T,T,W),v[3*M]=T[0],v[3*M+1]=T[1],v[3*M+2]=T[2],q(T,T,r),k(T,T,u),O[3*M]=T[0],O[3*M+1]=T[1],O[3*M+2]=T[2],w[2*M]=M/s,w[2*M+1]=0,O[3*(M+s)]=O[3*M]+c[0],O[3*(M+s)+1]=O[3*M+1]+c[1],O[3*(M+s)+2]=O[3*M+2]+c[2],w[2*(M+s)]=M/s,w[2*M+1]=1;let F=(M+1)%s;x(A++,M,M),x(A++,M+s,M),x(A++,F,F),x(A++,F,F),x(A++,M+s,M),x(A++,F+s,F)}if(o){for(let M=0;M<s;M++){let ie=(M+1)%s;x(A++,g-2,_-2),x(A++,M,_-2),x(A++,ie,_-2)}for(let M=0;M<s;M++){let ie=(M+1)%s;x(A++,M+s,_-1),x(A++,g-1,_-1),x(A++,ie+s,_-1)}}let H=[[f.POSITION,new G(O,y,3,!0)],[f.NORMAL,new G(v,C,3,!0)],[f.UV0,new G(w,y,2,!0)]];return new ye(t,H)}function s0(t,e,r,s,i,a){s=s||10,i=i==null||i,ee(e.length>1);let o=[[0,0,0]],n=[],h=[];for(let l=0;l<s;l++){n.push([0,-l-1,-(l+1)%s-1]);let c=l/s*2*Math.PI;h.push([Math.cos(c)*r,Math.sin(c)*r])}return sc(t,h,e,o,n,i,a)}function sc(t,e,r,s,i,a,o=te(0,0,0)){let n=e.length,h=De(r.length*n*3+(6*s.length||0)),l=De(r.length*n*3+(s?6:0)),c=new Array,u=new Array,d=0,p=0,g=S(),_=S(),O=S(),v=S(),w=S(),y=S(),C=S(),x=S(),A=S(),T=S(),W=S(),H=S(),M=S(),ie=It();z(A,0,1,0),$(_,r[1],r[0]),Q(_,_),a?(k(x,r[0],o),Q(O,x)):z(O,0,0,1),eh(_,O,A,A,w,O,th),B(v,O),B(H,w);for(let P=0;P<s.length;P++)q(y,w,s[P][0]),q(x,O,s[P][2]),k(y,y,x),k(y,y,r[0]),h[d++]=y[0],h[d++]=y[1],h[d++]=y[2];l[p++]=-_[0],l[p++]=-_[1],l[p++]=-_[2];for(let P=0;P<i.length;P++)c.push(i[P][0]>0?i[P][0]:-i[P][0]-1+s.length),c.push(i[P][1]>0?i[P][1]:-i[P][1]-1+s.length),c.push(i[P][2]>0?i[P][2]:-i[P][2]-1+s.length),u.push(0),u.push(0),u.push(0);let F=s.length,tt=s.length-1;for(let P=0;P<r.length;P++){let ut=!1;P>0&&(B(g,_),P<r.length-1?($(_,r[P+1],r[P]),Q(_,_)):ut=!0,k(T,g,_),Q(T,T),k(W,r[P-1],v),tn(r[P],T,ie),rn(ie,ln(W,g),x)?($(x,x,r[P]),Q(O,x),Ie(w,T,O),Q(w,w)):eh(T,v,H,A,w,O,th),B(v,O),B(H,w)),a&&(k(x,r[P],o),Q(M,x));for(let we=0;we<n;we++)if(q(y,w,e[we][0]),q(x,O,e[we][1]),k(y,y,x),Q(C,y),l[p++]=C[0],l[p++]=C[1],l[p++]=C[2],k(y,y,r[P]),h[d++]=y[0],h[d++]=y[1],h[d++]=y[2],!ut){let vr=(we+1)%n;c.push(F+we),c.push(F+n+we),c.push(F+vr),c.push(F+vr),c.push(F+n+we),c.push(F+n+vr);for(let Tr=0;Tr<6;Tr++){let Bt=c.length-6;u.push(c[Bt+Tr]-tt)}}F+=n}let yr=r[r.length-1];for(let P=0;P<s.length;P++)q(y,w,s[P][0]),q(x,O,s[P][1]),k(y,y,x),k(y,y,yr),h[d++]=y[0],h[d++]=y[1],h[d++]=y[2];let rt=p/3;l[p++]=_[0],l[p++]=_[1],l[p++]=_[2];let Z=F-n;for(let P=0;P<i.length;P++)c.push(i[P][0]>=0?F+i[P][0]:-i[P][0]-1+Z),c.push(i[P][2]>=0?F+i[P][2]:-i[P][2]-1+Z),c.push(i[P][1]>=0?F+i[P][1]:-i[P][1]-1+Z),u.push(rt),u.push(rt),u.push(rt);let Ae=[[f.POSITION,new G(h,c,3,!0)],[f.NORMAL,new G(l,u,3,!0)]];return new ye(t,Ae)}function i0(t,e,r,s){ee(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),ee(e[0].length===3,"createPolylineGeometry(): malformed vertex"),ee(r==null||r.length===e.length,"createPolylineGeometry: need same number of points and normals"),ee(r==null||r[0].length===3,"createPolylineGeometry(): malformed normal");let i=Jo(3*e.length),a=new Array(2*(e.length-1)),o=0,n=0;for(let l=0;l<e.length;l++){for(let c=0;c<3;c++)i[o++]=e[l][c];l>0&&(a[n++]=l-1,a[n++]=l)}let h=[[f.POSITION,new G(i,a,3,!0)]];if(r){let l=De(3*r.length),c=0;for(let u=0;u<e.length;u++)for(let d=0;d<3;d++)l[c++]=r[u][d];h.push([f.NORMAL,new G(l,a,3,!0)])}return s&&h.push([f.COLOR,new G(s,Yo(s.length/4),4)]),new ye(t,h,null,lt.Line)}function a0(t,e,r,s,i,a=0){let o=new Array(18),n=[[-r,a,i/2],[s,a,i/2],[0,e+a,i/2],[-r,a,-i/2],[s,a,-i/2],[0,e+a,-i/2]],h=[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5];for(let l=0;l<6;l++)o[3*l]=n[l][0],o[3*l+1]=n[l][1],o[3*l+2]=n[l][2];return new ye(t,[[f.POSITION,new G(o,h,3,!0)]])}function o0(t,e){let r=t.getMutableAttribute(f.POSITION).data;for(let s=0;s<r.length;s+=3){let i=r[s],a=r[s+1],o=r[s+2];z(mr,i,a,o),J(mr,mr,e),r[s]=mr[0],r[s+1]=mr[1],r[s+2]=mr[2]}}function n0(t,e=t){let r=t.attributes,s=r.get(f.POSITION).data,i=r.get(f.NORMAL).data;if(i){let a=e.getMutableAttribute(f.NORMAL).data;for(let o=0;o<i.length;o+=3){let n=i[o+1];a[o+1]=-i[o+2],a[o+2]=n}}if(s){let a=e.getMutableAttribute(f.POSITION).data;for(let o=0;o<s.length;o+=3){let n=s[o+1];a[o+1]=-s[o+2],a[o+2]=n}}}function Ha(t,e,r,s,i){return!(Math.abs(Be(e,t))>i)&&(Ie(r,t,e),Q(r,r),Ie(s,r,t),Q(s,s),!0)}function eh(t,e,r,s,i,a,o){return Ha(t,e,i,a,o)||Ha(t,r,i,a,o)||Ha(t,s,i,a,o)}var th=.99619469809,mr=S();var sh=class{constructor(e,r={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=V(),this._shaderTransformation=null,this._boundingSphere=null,this.id=rs(),this.layerUid=r.layerUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation!=null&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){_e(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=V(),be(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??=ms(),J(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*us(this.shaderTransformation)),this._boundingSphere):cn}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};var Ti=class extends Jt{intersect(e,r,s,i,a,o){return An(e,s,i,a,void 0,o)}};var Qr=class t extends Qe{initializeProgram(e){return new $e(e.rctx,t.shader.get().build(this.configuration),_t)}_createPipeline(e,r){let s=this.configuration,i=e===ae.NONE,a=e===ae.FrontFace;return ve({blending:s.output===E.Color&&s.transparent?i?Qt:$t(e):null,culling:Rn(s.cullFace),depthTest:s.draped?null:{func:ws(e)},depthWrite:s.draped?null:(i||a)&&s.writeDepth?Zt:null,drawBuffers:s.output===E.Depth?{buffers:[Pt.NONE]}:Kt(e),colorWrite:Re,stencilWrite:s.hasOccludees?Ir:null,stencilTest:s.hasOccludees?r?Dr:xs:null,polygonOffset:i||a?s.polygonOffset?ic:null:Mn(s.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}};Qr.shader=new Ze(hl,()=>import("./chunk-FIQPYHSR.js"));var ic={factor:1,units:1};var K=class extends Ss{constructor(){super(...arguments),this.output=E.Color,this.cullFace=Ar.None,this.transparencyPassType=ae.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1}};m([D({count:E.COUNT})],K.prototype,"output",void 0),m([D({count:Ar.COUNT})],K.prototype,"cullFace",void 0),m([D({count:ae.COUNT})],K.prototype,"transparencyPassType",void 0),m([D()],K.prototype,"hasSlicePlane",void 0),m([D()],K.prototype,"hasVertexColors",void 0),m([D()],K.prototype,"transparent",void 0),m([D()],K.prototype,"polygonOffset",void 0),m([D()],K.prototype,"enableOffset",void 0),m([D()],K.prototype,"writeDepth",void 0),m([D()],K.prototype,"hasOccludees",void 0),m([D()],K.prototype,"multipassEnabled",void 0),m([D()],K.prototype,"cullAboveGround",void 0),m([D()],K.prototype,"objectAndLayerIdColorInstanced",void 0),m([D()],K.prototype,"vvColor",void 0),m([D()],K.prototype,"draped",void 0),m([D({constValue:!1})],K.prototype,"occlusionPass",void 0),m([D({constValue:!0})],K.prototype,"hasVvInstancing",void 0),m([D({constValue:!1})],K.prototype,"vvSize",void 0),m([D({constValue:!1})],K.prototype,"vvOpacity",void 0);var ih=class extends Ti{constructor(e){super(e,new za),this.supportsEdges=!0,this.produces=new Map([[U.OPAQUE_MATERIAL,r=>r===E.Highlight||_s(r)&&!this._isTransparent],[U.OPAQUE_NO_SSAO_DEPTH,r=>Yt(r)&&this.parameters.writeLinearDepth&&!this._isTransparent],[U.TRANSPARENT_MATERIAL,r=>_s(r)&&this._isTransparent&&this.parameters.writeDepth],[U.TRANSPARENT_NO_SSAO_DEPTH,r=>Yt(r)&&this.parameters.writeLinearDepth&&this._isTransparent&&this.parameters.writeDepth],[U.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,r=>(_s(r)||Yt(r)&&this.parameters.writeLinearDepth)&&this._isTransparent&&!this.parameters.writeDepth],[U.DRAPED_MATERIAL,r=>gs(r)]]),this._configuration=new K}getConfiguration(e,r){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._isTransparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<Cn,this._configuration.multipassEnabled=r.multipassEnabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}createGLMaterial(e){return new Wa(e)}createBufferWriter(){let e=zt().vec3f(f.POSITION);return xe("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(f.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?e.f32(f.COLORFEATUREATTRIBUTE):e.vec4u8(f.COLOR),new Vn(e)}get _isTransparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}},Wa=class extends Ts{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output===E.Color&&this._updateOccludeeState(e),this.ensureTechnique(Qr,e)}},za=class extends Lr{constructor(){super(...arguments),this.color=Di,this.forceTransparentMode=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Ar.None,this.hasOccludees=!1,this.draped=!1}};function ac(t){return t instanceof Float32Array&&t.length>=16}function oc(t){return Array.isArray(t)&&t.length>=16}function ah(t){return ac(t)||oc(t)}var Oi=class{constructor(){this.factor=new wi,this.factorAlignment=new wi}},wi=class{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}};var $r=class t extends Qe{initializeConfiguration(e,r){r.spherical=e.viewingMode===ze.Global}initializeProgram(e){return new $e(e.rctx,t.shader.get().build(this.configuration),_t)}initializePipeline(){let e=this.configuration.transparencyPassType,r=this.configuration,s=e===ae.NONE,i=e===ae.FrontFace,a=this.configuration.hasPolygonOffset?nc:null,o=r.draped?null:(s||i)&&r.output!==E.Highlight&&(r.depthEnabled||r.occlusionPass)?Zt:null;return ve({blending:r.output===E.Color||r.output===E.Highlight?s?lc:$t(e):null,depthTest:r.draped?null:{func:Go.LEQUAL},depthWrite:o,drawBuffers:Kt(e),colorWrite:Re,polygonOffset:a})}get primitiveType(){return this.configuration.occlusionPass?kt.POINTS:kt.TRIANGLES}};$r.shader=new Ze(ll,()=>import("./chunk-CYHBLZU5.js"));var nc={factor:0,units:-4},lc=Os(Ge.ONE,Ge.ONE_MINUS_SRC_ALPHA);var X=class extends Ss{constructor(){super(...arguments),this.output=E.Color,this.transparencyPassType=ae.NONE,this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}};m([D({count:E.COUNT})],X.prototype,"output",void 0),m([D({count:ae.COUNT})],X.prototype,"transparencyPassType",void 0),m([D()],X.prototype,"screenCenterOffsetUnitsEnabled",void 0),m([D()],X.prototype,"spherical",void 0),m([D()],X.prototype,"occlusionTestEnabled",void 0),m([D()],X.prototype,"signedDistanceFieldEnabled",void 0),m([D()],X.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),m([D()],X.prototype,"vvSize",void 0),m([D()],X.prototype,"vvColor",void 0),m([D()],X.prototype,"hasVerticalOffset",void 0),m([D()],X.prototype,"hasScreenSizePerspective",void 0),m([D()],X.prototype,"debugDrawLabelBorder",void 0),m([D()],X.prototype,"hasSlicePlane",void 0),m([D()],X.prototype,"hasPolygonOffset",void 0),m([D()],X.prototype,"depthEnabled",void 0),m([D()],X.prototype,"pixelSnappingEnabled",void 0),m([D()],X.prototype,"draped",void 0),m([D()],X.prototype,"multipassEnabled",void 0),m([D()],X.prototype,"cullAboveGround",void 0),m([D()],X.prototype,"occlusionPass",void 0),m([D()],X.prototype,"objectAndLayerIdColorInstanced",void 0),m([D({constValue:!0})],X.prototype,"hasSliceInVertexProgram",void 0),m([D({constValue:!1})],X.prototype,"hasVvInstancing",void 0);var oh=class extends Jt{constructor(e){super(e,new Ja),this._configuration=new X,this.produces=new Map([[U.HUD_MATERIAL,r=>ys(r)&&!this.parameters.drawInSecondSlot],[U.LABEL_MATERIAL,r=>ys(r)&&this.parameters.drawInSecondSlot],[U.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[U.DRAPED_MATERIAL,r=>ys(r)]])}getConfiguration(e,r){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen",this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=r.slot===U.OCCLUSION_PIXELS&&this.parameters.occlusionTest,e===E.Color&&(this._configuration.debugDrawLabelBorder=!!er.LABELS_SHOW_BORDER),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.multipassEnabled=r.multipassEnabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}intersect(e,r,s,i,a,o){if(!(s.options.selectionMode&&s.options.hud&&e.visible&&s.point))return;let n=this.parameters,h=s.point,l=s.camera,{scaleX:c,scaleY:u}=this._getScreenScale(e);c*=l.pixelRatio,u*=l.pixelRatio,ji(ka,r),e.attributes.has(f.FEATUREATTRIBUTE)&&cc(ka);let d=e.attributes.get(f.POSITION),p=e.attributes.get(f.SIZE),g=e.attributes.get(f.NORMAL),_=e.attributes.get(f.CENTEROFFSETANDDISTANCE);ee(d.size>=3);let O=Ki(n),v=this.parameters.centerOffsetUnits==="screen";for(let w=0;w<d.data.length/d.size;w++){let y=w*d.size;z(ce,d.data[y],d.data[y+1],d.data[y+2]),J(ce,ce,r);let C=w*p.size;bt[0]=p.data[C]*c,bt[1]=p.data[C+1]*u,J(ce,ce,l.viewMatrix);let x=w*_.size;if(z(Me,_.data[x],_.data[x+1],_.data[x+2]),!v&&(ce[0]+=Me[0],ce[1]+=Me[1],Me[2]!==0)){let T=Me[2];Q(Me,ce),$(ce,ce,q(Me,Me,T))}let A=w*g.size;if(z(Kr,g.data[A],g.data[A+1],g.data[A+2]),nh(Kr,ka,l,Ya),this._applyVerticalOffsetTransformationView(ce,Ya,l,qa),l.applyProjection(ce,pe),pe[0]>-1){v&&(Me[0]||Me[1])&&(pe[0]+=Me[0]*l.pixelRatio,Me[1]!==0&&(pe[1]+=On(Me[1],qa.factorAlignment)*l.pixelRatio),l.unapplyProjection(pe,ce)),pe[0]+=this.parameters.screenOffset[0]*l.pixelRatio,pe[1]+=this.parameters.screenOffset[1]*l.pixelRatio,pe[0]=Math.floor(pe[0]),pe[1]=Math.floor(pe[1]),wn(bt,qa.factor,bt);let T=fc*l.pixelRatio,W=0;if(n.textureIsSignedDistanceField&&(W=n.outlineSize*l.pixelRatio/2),lh(h,pe[0],pe[1],bt,T,W,n,O)){let H=s.ray;if(J(hh,ce,Xe(dc,l.viewMatrix)),pe[0]=h[0],pe[1]=h[1],l.unprojectFromRenderScreen(pe,ce)){let M=S();B(M,H.direction);let ie=1/Pe(M);q(M,M,ie),o(st(H.origin,ce)*ie,M,-1,!0,1,hh)}}}}}intersectDraped(e,r,s,i,a,o){let n=e.attributes.get(f.POSITION),h=e.attributes.get(f.SIZE),l=this.parameters,c=Ki(l),{scaleX:u,scaleY:d}=this._getScreenScale(e);u*=e.screenToWorldRatio,d*=e.screenToWorldRatio;let p=gc*e.screenToWorldRatio;for(let g=0;g<n.data.length/n.size;g++){let _=g*n.size,O=n.data[_],v=n.data[_+1],w=g*h.size;bt[0]=h.data[w]*u,bt[1]=h.data[w+1]*d;let y=0;l.textureIsSignedDistanceField&&(y=l.outlineSize*e.screenToWorldRatio/2),lh(i,O,v,bt,p,y,l,c)&&a(o.dist,o.normal,-1,!1)}}createBufferWriter(){return new Za(this)}_updateScaleInfo(e,r,s){let i=this.parameters;i.screenSizePerspective!=null?Yi(s,r,i.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),i.screenSizePerspectiveAlignment!=null?Yi(s,r,i.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,r,s,i,a,o,n){let h=nh(r,s,a,Ya);return this._applyVerticalGroundOffsetView(e,h,a,n),this._applyVerticalOffsetTransformationView(n,h,a,o),this._applyPolygonOffsetView(n,h,i[3],a,n),this._applyCenterOffsetView(n,i,n),n}applyShaderOffsetsNDC(e,r,s,i,a){return this._applyCenterOffsetNDC(e,r,s,i),a!=null&&B(a,i),this._applyPolygonOffsetNDC(i,r,s,i),i}_applyPolygonOffsetView(e,r,s,i,a){let o=i.aboveGround?1:-1,n=Math.sign(s);n===0&&(n=o);let h=o*n;if(this.parameters.shaderPolygonOffset<=0)return B(a,e);let l=mt(Math.abs(r.cosAngle),.01,1),c=1-Math.sqrt(1-l*l)/l/i.viewport[2];return q(a,e,h>0?c:1/c),a}_applyVerticalGroundOffsetView(e,r,s,i){let a=Pe(e),o=s.aboveGround?1:-1,n=s.computeRenderPixelSizeAtDist(a)*nl,h=q(ce,r.normal,o*n);return k(i,e,h),i}_applyVerticalOffsetTransformationView(e,r,s,i){let a=this.parameters;if(!a.verticalOffset?.screenLength){if(a.screenSizePerspective||a.screenSizePerspectiveAlignment){let l=Pe(e);this._updateScaleInfo(i,l,r.cosAngle)}else i.factor.scale=1,i.factorAlignment.scale=1;return e}let o=Pe(e),n=a.screenSizePerspectiveAlignment??a.screenSizePerspective,h=xn(s,o,a.verticalOffset,r.cosAngle,n);return this._updateScaleInfo(i,o,r.cosAngle),q(r.normal,r.normal,h),k(e,e,r.normal)}_applyCenterOffsetView(e,r,s){let i=this.parameters.centerOffsetUnits!=="screen";return s!==e&&B(s,e),i&&(s[0]+=r[0],s[1]+=r[1],r[2]&&(Q(Kr,s),k(s,s,q(Kr,Kr,r[2])))),s}_applyCenterOffsetNDC(e,r,s,i){let a=this.parameters.centerOffsetUnits!=="screen";return i!==e&&B(i,e),a||(i[0]+=r[0]/s.fullWidth*2,i[1]+=r[1]/s.fullHeight*2),i}_applyPolygonOffsetNDC(e,r,s,i){let a=this.parameters.shaderPolygonOffset;if(e!==i&&B(i,e),a){let o=s.aboveGround?1:-1,n=o*Math.sign(r[3]);i[2]-=(n||o)*a}return i}createGLMaterial(e){return new Xa(e)}calculateRelativeScreenBounds(e,r,s=at()){return hc(this.parameters,e,r,s),s[2]=s[0]+e[0],s[3]=s[1]+e[1],s}_getScreenScale(e){let r=e.attributes.get(f.FEATUREATTRIBUTE);if(r==null)return{scaleX:1,scaleY:1};let s=Ao(r.data,mc),[i,a]=Gn(pc,this.parameters,s);return{scaleX:i,scaleY:a}}},Xa=class extends vn{constructor(e){super(Or(Or({},e),e.material.parameters))}selectProgram(e){return this.ensureTechnique($r,e)}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}};function hc(t,e,r,s){s[0]=t.anchorPosition[0]*-e[0]+t.screenOffset[0]*r,s[1]=t.anchorPosition[1]*-e[1]+t.screenOffset[1]*r}function nh(t,e,r,s){return ah(e)&&(e=ji(uc,e)),co(s.normal,t,e),J(s.normal,s.normal,r.viewInverseTransposeMatrix),s.cosAngle=Be(ch,_c),s}function cc(t){let e=t[0],r=t[1],s=t[2],i=t[3],a=t[4],o=t[5],n=t[6],h=t[7],l=t[8],c=1/Math.sqrt(e*e+r*r+s*s),u=1/Math.sqrt(i*i+a*a+o*o),d=1/Math.sqrt(n*n+h*h+l*l);return t[0]=e*c,t[1]=r*c,t[2]=s*c,t[3]=i*u,t[4]=a*u,t[5]=o*u,t[6]=n*d,t[7]=h*d,t[8]=l*d,t}function lh(t,e,r,s,i,a,o,n){let h=e-i-(n[0]>0?s[0]*n[0]:0),l=h+s[0]+2*i,c=r-i-(n[1]>0?s[1]*n[1]:0),u=c+s[1]+2*i,d=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&d!=null&&(h+=s[0]*d[0],c+=s[1]*d[1],l-=s[0]*(1-d[2]),u-=s[1]*(1-d[3]),h-=a,l+=a,c-=a,u+=a),t[0]>h&&t[0]<l&&t[1]>c&&t[1]<u}var qa=new Oi,ce=S(),Kr=S(),pe=de(),ch=S(),hh=S(),ka=Cr(),uc=Cr(),dc=V(),Me=S(),pc=S(),mc=de(),Ya={normal:ch,cosAngle:0},fc=1,gc=2,bt=[0,0],_c=je(0,0,1),Ja=class extends Tn{constructor(){super(...arguments),this.renderOccluded=le.Occlude,this.isDecoration=!1,this.color=ft(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=cs(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=ft(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1}},uh=zt().vec3f(f.POSITION).vec3f(f.NORMAL).vec2f(f.UV0).vec4u8(f.COLOR).vec2f(f.SIZE).vec4f(f.CENTEROFFSETANDDISTANCE).vec4f(f.FEATUREATTRIBUTE),yc=uh.clone().vec4u8(f.OBJECTANDLAYERIDCOLOR),Za=class{constructor(e){this._material=e,this.vertexBufferLayout=xe("enable-feature:objectAndLayerId-rendering")?yc:uh}elementCount(e){return 6*e.attributes.get(f.POSITION).indices.length}write(e,r,s,i,a){In(s.attributes.get(f.POSITION),e,i.position,a,6),Dn(s.attributes.get(f.NORMAL),r,i.normal,a,6);let o=s.attributes.get(f.UV0).data,n,h,l,c;if(o==null||o.length<4){let v=this._material.parameters;n=0,h=0,l=v.texCoordScale[0],c=v.texCoordScale[1]}else n=o[0],h=o[1],l=o[2],c=o[3];l=Math.min(1.99999,l+1),c=Math.min(1.99999,c+1);let u=s.attributes.get(f.POSITION).indices.length,d=a,p=i.uv0;for(let v=0;v<u;++v)p.set(d,0,n),p.set(d,1,h),d++,p.set(d,0,l),p.set(d,1,h),d++,p.set(d,0,l),p.set(d,1,c),d++,p.set(d,0,l),p.set(d,1,c),d++,p.set(d,0,n),p.set(d,1,c),d++,p.set(d,0,n),p.set(d,1,h),d++;Ln(s.attributes.get(f.COLOR),4,i.color,a,6);let{data:g,indices:_}=s.attributes.get(f.SIZE);u=_.length;let O=i.size;d=a;for(let v=0;v<u;++v){let w=g[2*_[v]],y=g[2*_[v]+1];for(let C=0;C<6;++C)O.set(d,0,w),O.set(d,1,y),d++}if(s.attributes.get(f.CENTEROFFSETANDDISTANCE)?Ji(s.attributes.get(f.CENTEROFFSETANDDISTANCE),i.centerOffsetAndDistance,a,6):Zi(i.centerOffsetAndDistance,a,6*u),s.attributes.get(f.FEATUREATTRIBUTE)?Ji(s.attributes.get(f.FEATUREATTRIBUTE),i.featureAttribute,a,6):Zi(i.featureAttribute,a,6*u),s.objectAndLayerIdColor!=null){let v=s.attributes.get(f.POSITION)?.indices;if(v){let w=v.length,y=i.getField(f.OBJECTANDLAYERIDCOLOR,Fo);Nn(s.objectAndLayerIdColor,y,w,a,6)}}}};export{sr as a,Nr as b,qr as c,Fe as d,Dt as e,As as f,Ds as g,Tm as h,Ws as i,Nl as j,li as k,vt as l,ap as m,Fs as n,Us as o,Ve as p,ct as q,$s as r,Jf as s,kl as t,ti as u,My as v,Jy as w,Zy as x,Qy as y,$y as z,Ky as A,e0 as B,t0 as C,r0 as D,s0 as E,sc as F,i0 as G,a0 as H,o0 as I,n0 as J,eh as K,sh as L,cl as M,Vr as N,Ic as O,ul as P,Dc as Q,Lc as R,Nc as S,Vc as T,Fc as U,dh as V,ta as W,ra as X,Wc as Y,pl as Z,ml as _,zc as $,qc as aa,_l as ba,oh as ca,Ti as da,ih as ea,cu as fa,uu as ga,du as ha,pu as ia,mu as ja,Rh as ka,fu as la,gu as ma};
