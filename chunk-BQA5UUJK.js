import{a as A,b as P,c as K,d as R,e as E,f as x,g as N,h as C,i as D,j as U}from"./chunk-VFYABGLK.js";import"./chunk-RCVEJHJJ.js";import{a as g}from"./chunk-FQTXYWH5.js";import"./chunk-KLXERNY4.js";import{a as M}from"./chunk-SCUHN3PY.js";import"./chunk-X6RI57FQ.js";import"./chunk-LCUC2WGG.js";import"./chunk-M5FU6NQM.js";import{a as G}from"./chunk-C75DYIHX.js";import{a as L,d as w,e as v,f as b,g as y}from"./chunk-TUJ6FPE6.js";import{b as f}from"./chunk-FI6XC3PH.js";import"./chunk-XFK3CDZ5.js";import"./chunk-4XBATNKX.js";import"./chunk-3IJY37BG.js";import{g as J}from"./chunk-ZV7ILGPO.js";import"./chunk-F7PIPM6E.js";import"./chunk-FR6Q4MSQ.js";import"./chunk-C6JT6KYF.js";import"./chunk-BCREO4Q5.js";import"./chunk-6FWNINU2.js";import"./chunk-ES7AH7WX.js";import"./chunk-RSDQHAJX.js";import"./chunk-RJHITHLB.js";import"./chunk-5TVEQGKJ.js";import"./chunk-U4U366GW.js";import"./chunk-JTJ3UVF7.js";import"./chunk-R4TNLPIN.js";import"./chunk-5HLV7XP5.js";import"./chunk-UI76XBLJ.js";import"./chunk-UE2YGKE7.js";import"./chunk-BE76S5KT.js";import"./chunk-3RDV3O6N.js";import"./chunk-D2ITYHSM.js";import"./chunk-FIITBHDP.js";import"./chunk-VSVNPPHQ.js";import"./chunk-CTGIUUCS.js";import"./chunk-VWEBO6QK.js";import"./chunk-KAAR5ZJN.js";import"./chunk-W3WDPWBE.js";import"./chunk-WKT5W7KT.js";import"./chunk-MLSR6YE6.js";import"./chunk-JPDAKIWT.js";import{r as p}from"./chunk-X3IDZTNG.js";import{e as O,g as $,p as F}from"./chunk-IQJU4QT3.js";import{h as l}from"./chunk-EAH6BNBL.js";var I="Feature Service",T="feature-layer-utils",Z=`${T}-save`,ee=`${T}-save-as`,m=`${T}-saveall`,d=`${T}-saveall-as`;function S(e){return{isValid:J(e)&&(e.type!=="feature"||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function z(e){let a=[],r=[];for(let{layer:t,layerJSON:o}of e)t.isTable?r.push(o):a.push(o);return{layers:a,tables:r}}function B(e){return z([e])}function j(e,a){return l(this,null,function*(){return/\/\d+\/?$/.test(e.url)?B(a[0]):q(a,e)})}function q(e,a){return l(this,null,function*(){if(e.reverse(),!a)return z(e);let r=yield ae(a,e);for(let t of e)V(t.layer,t.layerJSON,r);return se(r,e),r})}function ae(e,a){return l(this,null,function*(){let r=yield e.fetchData("json");if(re(r))return r;r||={},te(r);let{layer:{url:t,customParameters:o,apiKey:n}}=a[0];return yield ne(r,{url:t??"",customParameters:o,apiKey:n},a.map(s=>s.layer.layerId)),r})}function re(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function te(e){e.layers||=[],e.tables||=[]}function se(e,a){let r=[],t=[];for(let{layer:o}of a){let{isTable:n,layerId:s}=o;n?t.push(s):r.push(s)}Y(e.layers,r),Y(e.tables,t)}function Y(e,a){if(e.length<2)return;let r=[];for(let{id:t}of e)r.push(t);O(r.sort(_),a.slice().sort(_))&&e.sort((t,o)=>{let n=a.indexOf(t.id),s=a.indexOf(o.id);return n<s?-1:n>s?1:0})}function _(e,a){return e<a?-1:e>a?1:0}function ne(e,a,r){return l(this,null,function*(){let{url:t,customParameters:o,apiKey:n}=a,{serviceJSON:s,layersJSON:i}=yield M(t,{customParameters:o,apiKey:n}),c=k(e.layers,s.layers,r),u=k(e.tables,s.tables,r);e.layers=c.itemResources,e.tables=u.itemResources;let h=[...c.added,...u.added],X=i?[...i.layers,...i.tables]:[];yield oe(e,h,t,X)})}function k(e,a,r){let t=$(e,a,(n,s)=>n.id===s.id);e=e.filter(n=>!t.removed.some(s=>s.id===n.id));let o=t.added;return o.forEach(({id:n})=>{e.push({id:n})}),{itemResources:e,added:o.filter(({id:n})=>!r.includes(n))}}function oe(e,a,r,t){return l(this,null,function*(){let o=yield ie(a),n=a.map(({id:s,type:i})=>new(o.get(i))({url:r,layerId:s,sourceJSON:t.find(({id:c})=>c===s)}));yield Promise.allSettled(n.map(s=>s.load())),n.forEach(s=>{let{layerId:i,loaded:c,defaultPopupTemplate:u}=s;if(!c||u==null)return;let h={id:i,popupInfo:u.toJSON()};s.operationalLayerType!=="ArcGISFeatureLayer"&&(h.layerType=s.operationalLayerType),V(s,h,e)})})}function ie(e){return l(this,null,function*(){let a=[];e.forEach(({type:o})=>{let n=le(o),s=G[n];a.push(s())});let r=yield Promise.all(a),t=new Map;return e.forEach(({type:o},n)=>{t.set(o,r[n])}),t})}function le(e){let a;switch(e){case"Feature Layer":case"Table":a="FeatureLayer";break;case"Oriented Imagery Layer":a="OrientedImageryLayer";break;case"Catalog Layer":a="CatalogLayer"}return a}function V(e,a,r){e.isTable?W(r.tables,a):W(r.layers,a)}function W(e,a){let r=e.findIndex(({id:t})=>t===a.id);r===-1?e.push(a):e[r]=a}function H(e,a){if(!e.length)throw new p(`${a}:missing-parameters`,"'layers' array should contain at least one feature layer")}function ce(e,a){let r=e.map(t=>t.portalItem.id);if(new Set(r).size>1)throw new p(`${a}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}function Q(e,a){let r=e.map(t=>t.layerId);if(new Set(r).size!==r.length)throw new p(`${a}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}function ue(e){return l(this,null,function*(){H(e,m),yield Promise.all(e.map(a=>a.load()));for(let a of e)A(a,m,S),K({layer:a,itemType:I,errorNamePrefix:m});ce(e,m),Q(e,m)})}function ye(e,a){return l(this,null,function*(){let{url:r,layerId:t,title:o,fullExtent:n,isTable:s}=e,i=f(r);a.url=i?.serverType==="FeatureServer"?r:`${r}/${t}`,a.title||=o,a.extent=null,s||n==null||(a.extent=yield b(n)),w(a,y.METADATA),w(a,y.MULTI_LAYER),L(a,y.SINGLE_LAYER),s&&L(a,y.TABLE)})}function pe(e,a){for(let n of e){let s=n.parsedUrl.path,i=f(s);if(!i?.url.path)throw new p(`${a}:invalid-parameters`,P(n,`has unsupported url pattern: ${s}`),{layer:n});let u=i?.serverType;if(u!=="FeatureServer"&&u!=="MapServer")throw new p(`${a}:invalid-parameters`,P(n,`has unsupported server type: ${u}`),{layer:n});if(u==="MapServer"&&e.length>1)throw new p(`${a}:invalid-parameters`,"Only one layer or table in a map service can be saved")}let r=f(e[0].parsedUrl.path),t=r?.url.path;if(!e.every(n=>f(n.parsedUrl.path)?.url.path===t))throw new p(`${a}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}function fe(e){return l(this,null,function*(){H(e,d),yield Promise.all(e.map(a=>a.load()));for(let a of e)A(a,d,S);pe(e,d),Q(e,d)})}function me(e,a){return l(this,null,function*(){let r=0,t=0;for(let{isTable:s}of a)s?t++:r++;let o=a[0].parsedUrl.path,n=f(o);if(e.url=n?.serverType==="FeatureServer"?n.url.path:o,e.title||=n.title,e.extent=null,r>0){let s=a.map(i=>i.fullExtent).filter(F).reduce((i,c)=>i.clone().union(c));s&&(e.extent=yield b(s))}w(e,y.METADATA),v(e,y.MULTI_LAYER,a.length>1),v(e,y.SINGLE_LAYER,a.length===1),v(e,y.TABLE,t>0&&r===0),N(e)})}function ge(e,a){return l(this,null,function*(){return D({layer:e,itemType:I,validateLayer:S,createItemData:(r,t)=>j(t,[r]),errorNamePrefix:Z},a)})}function Ae(e,a){return l(this,null,function*(){yield ue(e);let r=e[0].portalItem,t=E(r),o=yield Promise.all(e.map(s=>x(s,t,a))),n=yield j(r,e.map((s,i)=>({layer:s,layerJSON:o[i]})));return N(r),yield r.update({data:n}),yield Promise.all(e.slice(1).map(s=>s.portalItem.reload())),g(t),r.clone()})}function Pe(e,a,r){return l(this,null,function*(){return U({layer:e,itemType:I,validateLayer:S,createItemData:(t,o)=>Promise.resolve(B(t)),errorNamePrefix:ee,newItem:a,setItemProperties:ye},r)})}function Ee(e,a,r){return l(this,null,function*(){yield fe(e);let t=R({itemType:I,errorNamePrefix:d,newItem:a}),o=E(t),n=yield Promise.all(e.map(i=>x(i,o,r))),s=yield q(e.map((i,c)=>({layer:i,layerJSON:n[c]})));yield me(t,e),yield C(t,s,r);for(let i of e)i.portalItem=t.clone();return g(o),t})}export{ge as save,Ae as saveAll,Ee as saveAllAs,Pe as saveAs};
