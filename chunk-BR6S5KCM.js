import{a as M}from"./chunk-DQ5TDMUL.js";import{a as Et}from"./chunk-W5OI4BJ2.js";import{h as x}from"./chunk-XSMN6VN6.js";import{a as ht}from"./chunk-BPP5MIUB.js";import{a as u}from"./chunk-H5IJXG2U.js";import{b as Nt,f as et,h as It}from"./chunk-6FWNINU2.js";import{A as _,B as K,C as tt,I as dt,a as O,k as Z,l as z,m as gt,n as $,w as pt}from"./chunk-ES7AH7WX.js";import{b as lt,j as mt}from"./chunk-IQJU4QT3.js";function U(t,e=0){let o=t.stride;return Array.from(t.fields.keys()).map(s=>{let n=t.fields.get(s),a=n.constructor.ElementCount,l=Rt(n.constructor.ElementType),i=n.offset,d=!(!n.optional||!n.optional.glNormalized);return new Et(s,a,l,i,o,d,e)})}function Rt(t){let e=Pt[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}var Pt={u8:x.UNSIGNED_BYTE,u16:x.UNSIGNED_SHORT,u32:x.UNSIGNED_INT,i8:x.BYTE,i16:x.SHORT,i32:x.INT,f32:x.FLOAT};var St=M().vec3f(u.POSITION).u16(u.COMPONENTINDEX),Vt=M().vec2u8(u.SIDENESS),jt=U(Vt),k=M().vec3f(u.POSITION0).vec3f(u.POSITION1).vec2i16(u.NORMALCOMPRESSED).u16(u.COMPONENTINDEX).u8(u.VARIANTOFFSET,{glNormalized:!0}).u8(u.VARIANTSTROKE).u8(u.VARIANTEXTENSION,{glNormalized:!0}),G=M().vec3f(u.POSITION0).vec3f(u.POSITION1).vec2i16(u.NORMALCOMPRESSED).vec2i16(u.NORMAL2COMPRESSED).u16(u.COMPONENTINDEX).u8(u.VARIANTOFFSET,{glNormalized:!0}).u8(u.VARIANTSTROKE).u8(u.VARIANTEXTENSION,{glNormalized:!0}),Jt=new Map([[u.POSITION0,0],[u.POSITION1,1],[u.COMPONENTINDEX,2],[u.VARIANTOFFSET,3],[u.VARIANTSTROKE,4],[u.VARIANTEXTENSION,5],[u.NORMALCOMPRESSED,6],[u.NORMAL2COMPRESSED,7],[u.SIDENESS,8]]);var P=-1,Ot;function At(t,e,o,s=Wt){let n=t.vertices.position,a=t.vertices.componentIndex,l=et(s.anglePlanar),i=et(s.angleSignificantEdge),d=Math.cos(i),f=Math.cos(l),m=rt.edge,N=m.position0,E=m.position1,I=m.faceNormal0,w=m.faceNormal1,h=Ft(t),L=Bt(t),r=L.length/4,c=e.allocate(r),g=0,p=r,S=o.allocate(p),T=0,v=0,A=0,it=mt(0,r),X=new Float32Array(r);X.forEach((V,y,W)=>{n.getVec(L[4*y],N),n.getVec(L[4*y+1],E),W[y]=pt(N,E)}),it.sort((V,y)=>X[y]-X[V]);let ct=new Array,ft=new Array;for(let V=0;V<r;V++){let y=it[V],W=X[y],Q=L[4*y],xt=L[4*y+1],b=L[4*y+2],H=L[4*y+3],ut=H===P;if(n.getVec(Q,N),n.getVec(xt,E),ut)z(I,h[3*b],h[3*b+1],h[3*b+2]),Z(w,I),m.componentIndex=a.get(Q),m.cosAngle=K(I,w);else{if(z(I,h[3*b],h[3*b+1],h[3*b+2]),z(w,h[3*H],h[3*H+1],h[3*H+2]),m.componentIndex=a.get(Q),m.cosAngle=K(I,w),Dt(m,f))continue;m.cosAngle<-.9999&&Z(w,I)}v+=W,A++,ut||bt(m,d)?(e.write(c,g++,m),ct.push(W)):Ct(m,l)&&(o.write(S,T++,m),ft.push(W))}let vt=new Float32Array(ct.reverse()),Mt=new Float32Array(ft.reverse());return{regular:{instancesData:e.trim(c,g),lodInfo:{lengths:vt}},silhouette:{instancesData:o.trim(S,T),lodInfo:{lengths:Mt}},averageEdgeLength:v/A}}function bt(t,e){return t.cosAngle<e}function Dt(t,e){return t.cosAngle>e}function Ct(t,e){let o=It(t.cosAngle),s=rt.fwd,n=rt.ortho;return dt(s,t.position1,t.position0),o*(K(tt(n,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}function Bt(t){let e=t.faces.length/3,o=t.faces,s=t.neighbors,n=0;for(let i=0;i<e;i++){let d=s[3*i],f=s[3*i+1],m=s[3*i+2],N=o[3*i],E=o[3*i+1],I=o[3*i+2];n+=d===P||N<E?1:0,n+=f===P||E<I?1:0,n+=m===P||I<N?1:0}let a=new Int32Array(4*n),l=0;for(let i=0;i<e;i++){let d=s[3*i],f=s[3*i+1],m=s[3*i+2],N=o[3*i],E=o[3*i+1],I=o[3*i+2];(d===P||N<E)&&(a[l++]=N,a[l++]=E,a[l++]=i,a[l++]=d),(f===P||E<I)&&(a[l++]=E,a[l++]=I,a[l++]=i,a[l++]=f),(m===P||I<N)&&(a[l++]=I,a[l++]=N,a[l++]=i,a[l++]=m)}return a}function Ft(t){let e=t.faces.length/3,o=t.vertices.position,s=t.faces,n=ot.v0,a=ot.v1,l=ot.v2,i=new Float32Array(3*e);for(let d=0;d<e;d++){let f=s[3*d],m=s[3*d+1],N=s[3*d+2];o.getVec(f,n),o.getVec(m,a),o.getVec(N,l),$(a,a,n),$(l,l,n),tt(n,a,l),_(n,n),i[3*d]=n[0],i[3*d+1]=n[1],i[3*d+2]=n[2]}return i}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(Ot||(Ot={}));var rt={edge:{position0:O(),position1:O(),faceNormal0:O(),faceNormal1:O(),componentIndex:0,cosAngle:0},ortho:O(),fwd:O()},ot={v0:O(),v1:O(),v2:O()},Wt={anglePlanar:4,angleSignificantEdge:35};function nt(t,e,o){let s=e/3,n=new Uint32Array(o+1),a=new Uint32Array(o+1),l=(r,c)=>{r<c?n[r+1]++:a[c+1]++};for(let r=0;r<s;r++){let c=t[3*r],g=t[3*r+1],p=t[3*r+2];l(c,g),l(g,p),l(p,c)}let i=0,d=0;for(let r=0;r<o;r++){let c=n[r+1],g=a[r+1];n[r+1]=i,a[r+1]=d,i+=c,d+=g}let f=new Uint32Array(6*s),m=n[o],N=(r,c,g)=>{if(r<c){let p=n[r+1]++;f[2*p]=c,f[2*p+1]=g}else{let p=a[c+1]++;f[2*m+2*p]=r,f[2*m+2*p+1]=g}};for(let r=0;r<s;r++){let c=t[3*r],g=t[3*r+1],p=t[3*r+2];N(c,g,r),N(g,p,r),N(p,c,r)}let E=(r,c)=>{let g=2*r,p=c-r;for(let S=1;S<p;S++){let T=f[g+2*S],v=f[g+2*S+1],A=S-1;for(;A>=0&&f[g+2*A]>T;A--)f[g+2*A+2]=f[g+2*A],f[g+2*A+3]=f[g+2*A+1];f[g+2*A+2]=T,f[g+2*A+3]=v}};for(let r=0;r<o;r++)E(n[r],n[r+1]),E(m+a[r],m+a[r+1]);let I=new Int32Array(3*s),w=(r,c)=>r===t[3*c]?0:r===t[3*c+1]?1:r===t[3*c+2]?2:-1,h=(r,c)=>{let g=w(r,c);I[3*c+g]=-1},L=(r,c,g,p)=>{let S=w(r,c);I[3*c+S]=p;let T=w(g,p);I[3*p+T]=c};for(let r=0;r<o;r++){let c=n[r],g=n[r+1],p=a[r],S=a[r+1];for(;c<g&&p<S;){let T=f[2*c],v=f[2*m+2*p];T===v?(L(r,f[2*c+1],v,f[2*m+2*p+1]),c++,p++):T<v?(h(r,f[2*c+1]),c++):(h(v,f[2*m+2*p+1]),p++)}for(;c<g;)h(r,f[2*c+1]),c++;for(;p<S;)h(f[2*m+2*p],f[2*m+2*p+1]),p++}return I}function q(t,e,o,s,n,a=2){let l=1/(Math.abs(o)+Math.abs(s)+Math.abs(n)),i=o*l,d=s*l,f=n<=0?(i>=0?1:-1)*(1-Math.abs(d)):i,m=n<=0?(d>=0?1:-1)*(1-Math.abs(i)):d,N=e*a;t[N]=yt(f),t[N+1]=yt(m)}function yt(t){return Nt(Math.round(32767*t),-32767,32767)}var j=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?Ut:_t}write(e,o,s){let n=this._edgeHashFunction(s);Y.seed=n;let a=Y.getIntRange(0,255),l=Y.getIntRange(0,this.settings.variants-1),i=.7,d=Y.getFloat(),f=255*(.5*Xt(-(1-Math.min(d/i,1))+Math.max(0,d-i)/(1-i),1.2)+.5);e.position0.setVec(o,s.position0),e.position1.setVec(o,s.position1),e.componentIndex.set(o,s.componentIndex),e.variantOffset.set(o,a),e.variantStroke.set(o,l),e.variantExtension.set(o,f)}trim(e,o){return e.slice(0,o)}},st=new Float32Array(6),J=new Uint32Array(st.buffer),R=new Uint32Array(1);function _t(t){let e=st;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],R[0]=5381;for(let o=0;o<J.length;o++)R[0]=31*R[0]+J[o];return R[0]}function Ut(t){let e=st;e[0]=D(t.position0[0]),e[1]=D(t.position0[1]),e[2]=D(t.position0[2]),e[3]=D(t.position1[0]),e[4]=D(t.position1[1]),e[5]=D(t.position1[2]),R[0]=5381;for(let o=0;o<J.length;o++)R[0]=31*R[0]+J[o];return R[0]}var Tt=1e4;function D(t){return Math.round(t*Tt)/Tt}function Xt(t,e){let o=t<0?-1:1;return Math.abs(t)**e*o}var B=class{constructor(){this._commonWriter=new j}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return k.createBuffer(e)}write(e,o,s){this._commonWriter.write(e,o,s),gt(C,s.faceNormal0,s.faceNormal1),_(C,C);let{typedBuffer:n,typedBufferStride:a}=e.normalCompressed;q(n,o,C[0],C[1],C[2],a)}trim(e,o){return this._commonWriter.trim(e,o)}};B.Layout=k,B.glLayout=U(k,1);var F=class{constructor(){this._commonWriter=new j}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return G.createBuffer(e)}write(e,o,s){this._commonWriter.write(e,o,s);{let{typedBuffer:n,typedBufferStride:a}=e.normalCompressed;q(n,o,s.faceNormal0[0],s.faceNormal0[1],s.faceNormal0[2],a)}{let{typedBuffer:n,typedBufferStride:a}=e.normal2Compressed;q(n,o,s.faceNormal1[0],s.faceNormal1[1],s.faceNormal1[2],a)}}trim(e,o){return this._commonWriter.trim(e,o)}};F.Layout=G,F.glLayout=U(G,1);var C=O(),Y=new lt;function we(t){let e=Ht(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return wt.updateSettings(t.writerSettings),Lt.updateSettings(t.writerSettings),At(e,wt,Lt)}function Ht(t,e,o,s){if(e){let l=nt(o,s,t.count);return new at(o,s,l,t)}let n=ht(t.buffer,t.stride/4,{originalIndices:o,originalIndicesLength:s}),a=nt(n.indices,s,n.uniqueCount);return{faces:n.indices,facesLength:n.indices.length,neighbors:a,vertices:St.createView(n.buffer)}}var at=class{constructor(e,o,s,n){this.faces=e,this.facesLength=o,this.neighbors=s,this.vertices=n}},wt=new B,Lt=new F,Le=M().vec3f(u.POSITION0).vec3f(u.POSITION1),ve=M().vec3f(u.POSITION0).vec3f(u.POSITION1).u16(u.COMPONENTINDEX);export{St as a,At as b,we as c,Ht as d,Le as e,ve as f};
