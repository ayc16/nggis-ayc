import{a as De}from"./chunk-RUVYIKTG.js";import"./chunk-CGBXHEB2.js";import"./chunk-YNJY3BMZ.js";import"./chunk-7ZC37CAK.js";import"./chunk-72HDUQH4.js";import"./chunk-RXMXYODQ.js";import{l as Pe,m as Ge}from"./chunk-TJO74ND6.js";import{b as Se}from"./chunk-A3KX3DLS.js";import{b as He,c as Ie}from"./chunk-VZSQNMU3.js";import{a as qe,d as Oe}from"./chunk-VOLKMATP.js";import{b as Ee,c as k}from"./chunk-MYZY3TMU.js";import"./chunk-XJE2IOXJ.js";import"./chunk-3QUBAXI6.js";import"./chunk-LFPKLGKU.js";import"./chunk-GMW3QDVG.js";import"./chunk-BYXBJQAS.js";import"./chunk-AKKUUEQK.js";import"./chunk-BSIXRBVK.js";import"./chunk-G3LBVS5W.js";import"./chunk-HL3SHP76.js";import"./chunk-RI4EXXSR.js";import"./chunk-BYXBJQAS.js";import"./chunk-KNDM5UGY.js";import{a as z}from"./chunk-EKKBMKVP.js";import"./chunk-TEXQFKMJ.js";import"./chunk-V2ACH6PW.js";import"./chunk-NOUYXRP4.js";import"./chunk-CXKNFANK.js";import{i as Ve,j as Q}from"./chunk-57GB3TOJ.js";import"./chunk-RHABF3KL.js";import"./chunk-2MJIH6TV.js";import"./chunk-HX3FHHCG.js";import"./chunk-ZOOQQO74.js";import"./chunk-OGOKP66I.js";import{h as C}from"./chunk-BZEC7TCW.js";import"./chunk-WD4CT5CX.js";import{c as Te}from"./chunk-XAHD7XBV.js";import"./chunk-RXZ6D6Z5.js";import"./chunk-UZSTUBKI.js";import"./chunk-ZREXZJBZ.js";import"./chunk-GFEKSNS7.js";import"./chunk-R5S5CHNL.js";import"./chunk-UDAVCKBV.js";import"./chunk-7QY3BMVN.js";import"./chunk-BGI2WQLI.js";import"./chunk-Z33JZO3Q.js";import"./chunk-FYZRIMPP.js";import"./chunk-W5OI4BJ2.js";import{l as fe,r as L}from"./chunk-XSMN6VN6.js";import"./chunk-I46GU3Q4.js";import{a as ye}from"./chunk-7C6Z24SS.js";import"./chunk-LX3TXNPU.js";import"./chunk-KDRAUGQW.js";import{n as Ce}from"./chunk-QRAERHGP.js";import{a as Ae}from"./chunk-FOPE5Y6E.js";import"./chunk-R4ZRZJFL.js";import"./chunk-L657QK52.js";import"./chunk-XVXRQZ3E.js";import"./chunk-Z5N4P45E.js";import"./chunk-MJN6ZDZD.js";import{a as Re,b as Me}from"./chunk-UPCYQ2JS.js";import"./chunk-26EEXAHQ.js";import"./chunk-OX7MQO37.js";import"./chunk-AC7AQWXQ.js";import"./chunk-HPYQ6UOC.js";import{b as be}from"./chunk-37H4LYIE.js";import"./chunk-X4LAWCTR.js";import"./chunk-QPOMWSFR.js";import"./chunk-2MVYKHX3.js";import"./chunk-7DPBVZFZ.js";import"./chunk-ZB2MLS4M.js";import"./chunk-MAVOHF7Q.js";import"./chunk-JIO2NKRP.js";import"./chunk-JIFV566L.js";import"./chunk-A2WF4NJX.js";import"./chunk-VAIXCJGK.js";import"./chunk-MT7CYQIO.js";import"./chunk-C64FPBS5.js";import"./chunk-STCMK6X3.js";import"./chunk-2XAYS5PW.js";import"./chunk-2O2C5MZC.js";import"./chunk-2F3ICBUH.js";import"./chunk-WBNQAM3K.js";import"./chunk-KH5B55IZ.js";import"./chunk-NPQPIZAK.js";import"./chunk-LOEAA5XF.js";import"./chunk-LX5FIKVZ.js";import"./chunk-576BZULE.js";import"./chunk-N7KNO35F.js";import"./chunk-TALIOOAA.js";import"./chunk-6UOVQ25A.js";import"./chunk-BNSYK2BT.js";import"./chunk-DHY7QZ2H.js";import"./chunk-MFP2OFDR.js";import"./chunk-ADXKVFX6.js";import"./chunk-UVZRJ2I3.js";import"./chunk-65QIQYGA.js";import"./chunk-TLLESPR2.js";import"./chunk-NFADXGWT.js";import"./chunk-I3S324BU.js";import"./chunk-YTC2EJDQ.js";import"./chunk-2UDQ3IWX.js";import"./chunk-DCAB3MR3.js";import"./chunk-YC7IXNOA.js";import"./chunk-MMZZL453.js";import{e as ce}from"./chunk-XDMNA7OV.js";import"./chunk-NKZ7R6T6.js";import"./chunk-VHAPMMA5.js";import"./chunk-DR5D3NPO.js";import"./chunk-U6WVZEYH.js";import"./chunk-ERH7ZNSC.js";import"./chunk-GUOR3BIM.js";import{a as ue}from"./chunk-2EA2KAER.js";import{c as _e,g as ge,h as ve,i as we,j as xe}from"./chunk-V5AJXD2Y.js";import"./chunk-WXS2B4FF.js";import"./chunk-XFK3CDZ5.js";import"./chunk-4XBATNKX.js";import"./chunk-3IJY37BG.js";import{b as de}from"./chunk-J57HR4DB.js";import{a as E,b as oe,c as W,f as y}from"./chunk-GNCG2SQP.js";import"./chunk-5HCLBNUR.js";import"./chunk-RMOIVYM4.js";import"./chunk-5JXPUH2D.js";import"./chunk-F4I5LECK.js";import"./chunk-J4PQZSQE.js";import"./chunk-Q3WN5PJ6.js";import"./chunk-UMB6LRQI.js";import{d as he}from"./chunk-AQ74ANSJ.js";import"./chunk-SAOUSUZE.js";import"./chunk-IFPBW5UQ.js";import"./chunk-ZV7ILGPO.js";import"./chunk-6ZT4EXDX.js";import"./chunk-RHHHYJSZ.js";import"./chunk-QBQKFGOZ.js";import"./chunk-K5NHJTKR.js";import"./chunk-XKXYUJUA.js";import"./chunk-F7PIPM6E.js";import"./chunk-FR6Q4MSQ.js";import{a as le}from"./chunk-C6JT6KYF.js";import"./chunk-BCREO4Q5.js";import"./chunk-Z5Q76SB7.js";import"./chunk-E5R4OI7X.js";import"./chunk-6FWNINU2.js";import"./chunk-ES7AH7WX.js";import"./chunk-RSDQHAJX.js";import"./chunk-NYONONNN.js";import"./chunk-MZFPLWMN.js";import"./chunk-DS2JVXBM.js";import{b as se}from"./chunk-G3LLBABP.js";import"./chunk-T4B3RN6B.js";import"./chunk-MXADXAOS.js";import"./chunk-RJHITHLB.js";import"./chunk-U4U366GW.js";import"./chunk-JTJ3UVF7.js";import"./chunk-R4TNLPIN.js";import"./chunk-5HLV7XP5.js";import"./chunk-BENVXA3L.js";import{n as ae,p as me,t as pe}from"./chunk-UI76XBLJ.js";import"./chunk-UE2YGKE7.js";import{o as ne}from"./chunk-BE76S5KT.js";import"./chunk-3RDV3O6N.js";import"./chunk-D2ITYHSM.js";import"./chunk-FIITBHDP.js";import"./chunk-VSVNPPHQ.js";import"./chunk-CTGIUUCS.js";import{F as U}from"./chunk-VWEBO6QK.js";import{S as ie,u as re}from"./chunk-KAAR5ZJN.js";import{a as V}from"./chunk-W3WDPWBE.js";import{e as ee,p as te}from"./chunk-WKT5W7KT.js";import{c as j}from"./chunk-MLSR6YE6.js";import"./chunk-JPDAKIWT.js";import"./chunk-VU5W7W6Y.js";import{p as T,r as $}from"./chunk-X3IDZTNG.js";import"./chunk-IQJU4QT3.js";import{a as K,b as Z,h as b}from"./chunk-EAH6BNBL.js";var _=ye(),Qe={none:C.None,loop:C.Loop,oscillate:C.Oscillate};function ke(r){return r?Z(K({},r),{playAnimation:r.playing,repeatType:r.repeatType?Qe[r.repeatType]:void 0}):{}}var S=class extends qe{constructor(e){super(),this.elementView=e,this.isWrapAround=!1,this.perspectiveTransform=ue(),this._playHandle=null,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(E(()=>this.elementView.element.opacity,t=>this.opacity=t,y),E(()=>[this.elementView.coords],()=>{this.requestRender()},y),E(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._playHandle?.remove(),this.texture=j(this.texture),this.requestRender()},y),oe(()=>this.elementView.element.loaded,()=>{let t=this.elementView.element;this.ready(),t.type==="video"&&t.content!=null&&this._handles.push(ee(t.content,"play",()=>this.requestRender()))},y)),e.element.load().catch(t=>{T.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new $("element-load-error","Element cannot be displayed",{element:e,error:t}))})}getMesh(e){throw new Error("Method not implemented.")}destroy(){this._playHandle?.remove(),this._handles.forEach(e=>e.remove()),this.texture=j(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){let{context:t}=e,i=this.elementView.element.content;if(i!=null){let o=i instanceof HTMLImageElement,s=i instanceof HTMLVideoElement,n=o?i.naturalWidth:s?i.videoWidth:i.width,p=o?i.naturalHeight:s?i.videoHeight:i.height;if(this._updatePerspectiveTransform(n,p),this.texture)s&&!i.paused&&(this.texture.setData(i),this.requestRender(),this.texture.generateMipmap());else{let l=new Ve;if(l.wrapMode=fe.CLAMP_TO_EDGE,l.preMultiplyAlpha=!0,l.width=n,l.height=p,"getFrame"in i){let m=a=>{this.texture?this.texture.setData(a):this.texture=new Q(t,l,a),this.requestRender()};"animationOptions"in this.elementView.element&&(this._playHandle=De(i,ke(this.elementView.element.animationOptions),null,m))}else this.texture=new Q(t,l,i);this.texture.generateMipmap(),s&&!i.paused&&this.requestRender()}}super.beforeRender(e)}_createTransforms(){return null}updateDrawCoords(e,t){let i=this.elementView.coords;if(i==null)return;let[o,s,n,p]=i.rings[0],l=this._vertices,{x:m,y:a}=e,d=t!==0;d?l.set([s[0]-m,s[1]-a,o[0]-m,o[1]-a,n[0]-m,n[1]-a,p[0]-m,p[1]-a,p[0]-m,p[1]-a,s[0]+t-m,s[1]-a,s[0]+t-m,s[1]-a,o[0]+t-m,o[1]-a,n[0]+t-m,n[1]-a,p[0]+t-m,p[1]-a]):l.set([s[0]-m,s[1]-a,o[0]-m,o[1]-a,n[0]-m,n[1]-a,p[0]-m,p[1]-a]),this.isWrapAround=d}getVAO(e,t,i){if(this.elementView.coords==null)return null;let o=this._vertices;if(this._vao)this._geometryVbo.setData(o);else{this._geometryVbo=z.createVertex(e,L.DYNAMIC_DRAW,o);let s=z.createVertex(e,L.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new Se(e,i,t,{geometry:this._geometryVbo,tex:s})}return this._vao}_updatePerspectiveTransform(e,t){let i=this._vertices;Ee(_,[0,0,e,0,0,t,e,t],[i[0],i[1],i[4],i[5],i[2],i[3],i[6],i[7]]),de(this.perspectiveTransform,_[6]/_[8]*e,_[7]/_[8]*t)}};var A=class extends Ge{constructor(){super(...arguments),this._localOrigin=he(0,0),this._viewStateId=-1,this._dvsMat3=Ae()}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(let t of this.children)t.beforeRender(e)}prepareRenderPasses(e){let t=e.registerRenderPass({name:"overlay",brushes:[Pe.overlay],target:()=>this.children,drawPhase:Oe.MAP});return[...super.prepareRenderPasses(e),t]}_updateMatrices(e){let{state:t}=e,{id:i,size:o,pixelRatio:s,resolution:n,rotation:p,viewpoint:l,displayMat3:m}=t;if(this._viewStateId===i)return;let a=Math.PI/180*p,d=s*o[0],f=s*o[1],{x:q,y:w}=l.targetGeometry,O=ce(q,t.spatialReference);this._localOrigin.x=O,this._localOrigin.y=w;let P=n*d,x=n*f,h=_e(this._dvsMat3);ge(h,h,m),ve(h,h,be(d/2,f/2)),xe(h,h,Te(d/P,-f/x,1)),we(h,h,-a),this._viewStateId=i}_updateOverlays(e,t){let{state:i}=e,{rotation:o,spatialReference:s,worldScreenWidth:n,size:p,viewpoint:l}=i,m=this._localOrigin,a=0,d=ne(s);if(d&&s.isWrappable){let f=p[0],q=p[1],w=180/Math.PI*o,O=Math.abs(Math.cos(w)),P=Math.abs(Math.sin(w)),x=Math.round(f*O+q*P),[h,D]=d.valid,u=Ce(s),{x:F,y:Ue}=l.targetGeometry,We=[F,Ue],G=[0,0];i.toScreen(G,We);let R=[0,0],H;H=x>n?.5*n:.5*x;let N=Math.floor((F+.5*u)/u),Le=h+N*u,ze=D+N*u,I=[G[0]+H,0];i.toMap(R,I),R[0]>ze&&(a=u),I[0]=G[0]-H,i.toMap(R,I),R[0]<Le&&(a=-u);for(let M of t){let X=M.elementView.bounds;if(X==null)continue;let[Y,,J]=X;Y<h&&J>h?M.updateDrawCoords(m,u):J>D&&Y<D?M.updateDrawCoords(m,-u):M.updateDrawCoords(m,a)}}else for(let f of t)f.updateDrawCoords(m,a)}};var v=class extends He(Ie){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this.layer=null,this.elements=new se}attach(){this.addAttachHandles([W(()=>this.layer.effectiveSource,"refresh",()=>{this._tileStrategy.refresh(r=>this._updateTile(r)),this.requestUpdate()}),W(()=>this.layer.effectiveSource,"change",({element:r})=>this._elementUpdateHandler(r))]),this._overlayContainer=new A,this.container.addChild(this._overlayContainer),this._fetchQueue=new Re({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(r,e)=>this._queryElements(r,e)}),this._tileStrategy=new Me({cachePolicy:"purge",resampling:!0,acquireTile:r=>this._acquireTile(r),releaseTile:r=>this._releaseTile(r),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(r){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(r){this._tileStrategy.update(r),this._debugGraphicsView?.update(r)}hitTest(r,e){return b(this,null,function*(){let t=[],i=r.normalize(),o=[i.x,i.y];for(let{projectedElement:{normalizedCoords:s,element:n}}of this._elementReferences.values())s!=null&&ae(s.rings,o)&&t.push({type:"media",element:n,layer:this.layer,mapPoint:r,sourcePoint:n.toSource(r)});return t.reverse()})}canResume(){return this.layer.source!=null&&super.canResume()}doRefresh(){return b(this,null,function*(){this._fetchQueue.reset(),this._tileStrategy.refresh(r=>this._updateTile(r))})}_acquireTile(r){let e=new B(r.clone());return this._updateTile(e),e}_updateTile(r){this._updatingHandles.addPromise(this._fetchQueue.push(r.key).then(e=>{let[t,i]=r.setElements(e);this._referenceElements(r,t),this._dereferenceElements(r,i),this.requestUpdate()},e=>{te(e)||T.getLogger(this).error(e)}))}_releaseTile(r){this._fetchQueue.abort(r.key.id),r.elements&&this._dereferenceElements(r,r.elements),this.requestUpdate()}_queryElements(r,e){return b(this,null,function*(){let t=this.layer.effectiveSource;if(t==null)return[];this.view.featuresTilingScheme.getTileBounds(c,r,!0);let i=new pe({xmin:c[0],ymin:c[1],xmax:c[2],ymax:c[3],spatialReference:this.view.spatialReference});return t.queryElements(i,e)})}_referenceElements(r,e){if(this.layer.source!=null)for(let t of e)this._referenceElement(r,t)}_referenceElement(r,e){re(this._elementReferences,e.uid,()=>{let t=new k({element:e,spatialReference:this.view.spatialReference}),i=new S(t);return this._overlayContainer.addChild(i),this.elements.add(e),{tiles:new Set,projectedElement:t,overlay:i,debugGraphic:null}}).tiles.add(r)}_dereferenceElements(r,e){for(let t of e)this._dereferenceElement(r,t)}_dereferenceElement(r,e){let t=this._elementReferences.get(e.uid);t.tiles.delete(r),t.tiles.size||(this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),this._debugGraphicsView?.graphics.remove(t.debugGraphic))}_elementUpdateHandler(r){let e=this._elementReferences.get(r.uid);if(e){let i=e.projectedElement.normalizedCoords;if(i==null)return this._overlayContainer.removeChild(e.overlay),e.overlay.destroy(),e.projectedElement.destroy(),this._elementReferences.delete(r.uid),this.elements.remove(r),void this._debugGraphicsView?.graphics.remove(e.debugGraphic);let o=[],s=[];for(let n of this._tileStrategy.tiles){let p=je(this.view.featuresTilingScheme,n,i);e.tiles.has(n)?p||s.push(n):p&&o.push(n)}for(let n of o)this._referenceElement(n,r);for(let n of s)this._dereferenceElement(n,r);return e=this._elementReferences.get(r.uid),void(e?.debugGraphic&&(e.debugGraphic.geometry=e.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:e.debugGraphic,property:"geometry"})))}let t=new k({element:r,spatialReference:this.view.spatialReference}).normalizedCoords;if(t!=null)for(let i of this._tileStrategy.tiles)je(this.view.featuresTilingScheme,i,t)&&this._referenceElement(i,r)}};V([U()],v.prototype,"layer",void 0),V([U({readOnly:!0})],v.prototype,"elements",void 0),v=V([ie("esri.views.2d.layers.MediaLayerView2D")],v);var c=le(),g={xmin:0,ymin:0,xmax:0,ymax:0};function je(r,e,t){return r.getTileBounds(c,e.key,!0),g.xmin=c[0],g.ymin=c[1],g.xmax=c[2],g.ymax=c[3],me(g,t)}var B=class{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){let t=[],i=new Set(this.elements);this.elements=e;for(let o of e)i.has(o)?i.delete(o):t.push(o);return this.isReady=!0,[t,Array.from(i)]}destroy(){}},ji=v;export{ji as default};
