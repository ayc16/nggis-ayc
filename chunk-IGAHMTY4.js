import{a as z}from"./chunk-BEEYKJCE.js";import{a as d}from"./chunk-ZZUOGAMH.js";import{c as K,e as H,f as S,g as q,h as J,i as Q}from"./chunk-BTFKH6KF.js";import{a as j}from"./chunk-I7V2OAI2.js";import{e as N}from"./chunk-RAMEUAPV.js";import{e as B,f as D,g as b,p as A,q as Y}from"./chunk-3K3SLH5Z.js";import{i as n}from"./chunk-7SVLZCA4.js";import{d as o}from"./chunk-YKUB35EI.js";import{a as F}from"./chunk-MW7BA4EZ.js";import{b as R}from"./chunk-CDCW33GU.js";import{a as Z}from"./chunk-NIYDRLW4.js";import{a as f}from"./chunk-XHOTVM3O.js";import{e as U}from"./chunk-AM3VOA32.js";import{a as C}from"./chunk-GBTN5LIS.js";import{l as w}from"./chunk-SA4OMQAD.js";import{L as s,O as M}from"./chunk-AUTL5LCV.js";import{S as l}from"./chunk-KUJG22IX.js";import{a as r}from"./chunk-W3WDPWBE.js";import{t as G}from"./chunk-GISCFF3Z.js";import{b as T}from"./chunk-MLSR6YE6.js";import{b as k}from"./chunk-HQMV3KQV.js";import{a as P}from"./chunk-EAH6BNBL.js";var L,v=L=class extends C.EventedAccessor{constructor(e){super(e),this._hasZ=null,this._cursorScreenPoint=null,this._activePointerId=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=B(!!e.hasZ,!1,e.view.spatialReference),this._snappingManager=e.snappingManager,this._editGeometryOperations=new A(new b(e.editGeometryType??"polygon",this._coordinateHelper),f.Local),this._snappingGraphicsLayer=new F({id:L.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0}),this._snappingContext=new Y({editGeometryOperations:this._editGeometryOperations,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new z(this._snappingGraphicsLayer)}),this._activeComponent=new D(e.view.spatialReference,f.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}normalizeCtorArgs(e){let t=P({},e);return delete t.editGeometryType,delete t.snappingManager,t}initialize(){this._snappingOperation=new j({view:this.view}),this.view.type==="2d"&&this.view.map.layers.add(this._snappingGraphicsLayer)}destroy(){this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this._snappingOperation=T(this._snappingOperation),this._editGeometryOperations.destroy()}get _committedVertices(){return this._editGeometryOperations.data.components[0].vertices.map(e=>e.pos)}get vertices(){return this._stagedVertex!=null?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return this._hasZ!=null?this._hasZ:this.view.type==="3d"}set hasZ(e){this._hasZ=e,this.notifyChange("hasZ")}get _stagedVertex(){return this._snappingOperation.stagedPoint}set _stagedVertex(e){this._snappingOperation.stagedPoint=k(e)}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this.canUndo&&this._editGeometryOperations.undo()}redo(){this.canRedo&&this._editGeometryOperations.redo()}getCoordsFromScreenPoint(e){let t=e&&this.screenToMap(e);return t==null?null:t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]}getCoordsAndPointFromScreenPoint(e){let t=this.screenToMap(e);return t==null?null:t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}}screenToMap(e){let t=null;if(this.view.type==="3d")if(this.hasZ){let i=this.elevationInfo??$;t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(U(e.x,e.y),i,this._getGeometryZValue())}else{let i=this.elevationInfo??ee;t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(U(e.x,e.y),i,0),t!=null&&(t.z=void 0)}else t=this.view.toMap(e),t!=null&&(t.z=this.hasZ?this._getGeometryZValue():void 0);return t}_pushCursorVertex(e,t){let i=Z(e[0],e[1],void 0,this.view.spatialReference);this._stagedVertexUnsnapped=i;let a=this._snappingManager;if(a==null)return this._stagedVertex=i,void t();G(this._snappingOperation.snap({point:i},a,this._snappingContext)).then(()=>{t()})}_popCursorVertex(){this._stagedVertexUnsnapped=null,this._stagedVertex=null}_getGeometryZValue(){return this.defaultZ}_abortSnapping(){this._snappingOperation.abort()}_isDuplicateOfLastVertex(e){let t=this._editGeometryOperations.data.components[0].getLastVertex()?.pos;if(t&&e[0]===t[0]&&e[1]===t[1])return!0;let{x:i,y:a}=this._coordinateHelper.vectorToDehydratedPoint(e);return this._lastVertexUnsnapped!=null&&i===this._lastVertexUnsnapped.x&&a===this._lastVertexUnsnapped.y}_shouldHandlePointerEvent(e){return te(e)&&(this._activePointerId==null||this._activePointerId===e.pointerId)}_vertexAddHandler(e){let t=this._stagedVertex!=null?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);t!=null&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};v.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",r([s({readOnly:!0})],v.prototype,"vertices",null),r([s({type:Boolean,nonNullable:!0})],v.prototype,"interactiveUndoDisabled",void 0),r([s({readOnly:!0})],v.prototype,"history",void 0),r([s({readOnly:!0})],v.prototype,"redoHistory",void 0),r([s()],v.prototype,"snapToScene",void 0),r([s()],v.prototype,"view",void 0),r([s()],v.prototype,"elevationInfo",void 0),r([s({nonNullable:!0})],v.prototype,"defaultZ",void 0),r([s()],v.prototype,"hasZ",null),r([s()],v.prototype,"_snappingOperation",void 0),r([s()],v.prototype,"_stagedVertex",null),v=L=r([l("esri.views.draw.DrawAction")],v);var $={mode:"absolute-height",offset:0},ee={mode:"on-the-ground",offset:0};function te(e){return e.pointerType!=="mouse"||e.button===0}var g=v;var h=class{constructor(t,i,a){this.view=t,this.vertexIndex=i,this.vertices=a,this.defaultPrevented=!1,this.type="vertex-add"}preventDefault(){this.defaultPrevented=!0}};var u=class{constructor(t,i,a){this.view=t,this.vertexIndex=i,this.vertices=a,this.defaultPrevented=!1,this.type="vertex-remove"}preventDefault(){this.defaultPrevented=!0}},c=class{constructor(t,i,a,_=null){this.view=t,this.vertexIndex=i,this.vertices=a,this.mapPoint=_,this.coordinates=null,this.defaultPrevented=!1,this.type="cursor-update",this.coordinates=a.length===1?a[0]:null}preventDefault(){this.defaultPrevented=!0}},m=class{constructor(t){this.vertices=t,this.coordinates=null,this.defaultPrevented=!1,this.type="draw-complete",this.coordinates=t.length===1?t[0]:null}preventDefault(){this.defaultPrevented=!0}};var W=Symbol("view-handles"),X=Symbol("undo-redo-handles"),E=class extends g{constructor(e){super(e),this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1}initialize(){this._addViewHandles(),this._addUndoRedoHandles()}destroy(){this._removeViewHandles(),this._removeUndoRedoHandles(),this.emit("destroy")}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this._completeDrawing()}_addViewHandles(){this._removeViewHandles(),this.addHandles([this.view.on("click",e=>{e.stopPropagation()},o.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=d(e),e.pointerType==="touch"&&this._updateCursor())},o.TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=d(e),e.pointerType!=="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},o.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)this._vertexAddHandler(e);else{let t=e.pointerType==="touch";this._updateCursor(t)}},o.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},o.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},o.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},o.TOOL),this.view.on("key-down",e=>{let{key:t,repeat:i}=e;t===n.vertexAdd&&!i&&this._cursorScreenPoint?(e.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(e)):t!==n.complete||i?t!==n.undo||this.interactiveUndoDisabled||i?t!==n.redo||this.interactiveUndoDisabled||i?t!==n.pan||i||e.stopPropagation():(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e))},o.TOOL),this.view.on("key-up",e=>{e.key===n.pan&&e.stopPropagation()},o.TOOL)],W)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){let t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new u(this.view,e.vertices[0].index,t))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){let t=this._committedVertices.length-1,i=new h(this.view,t,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){let t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new h(this.view,e.vertices[0].index,t))}})],X)}_removeViewHandles(){this.removeHandles(W)}_removeUndoRedoHandles(){this.removeHandles(X)}_addVertex(e){let t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||this._editGeometryOperations.appendVertex(t)}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;let t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t==null||e||this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new c(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new w(this._stagedVertex):null)))}_completeDrawing(){if(this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;let e=new m(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this._removeViewHandles()}};E=r([l("esri.views.draw.MultipointDrawAction")],E);var p=class extends C.EventedMixin(N){constructor(e){super(e),this.defaultZ=0,this.elevationInfo=null,this.hasZ=!0,this.mode=null,this.snapToScene=null,this.type="draw-3d"}initialize(){let e=this.view,t=R(this.hasZ,this.elevationInfo);this.drawOperation=new q({view:e,manipulators:this.manipulators,geometryType:this.geometryType,drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:e.type==="3d"?new Q(e,t):null,elevationDrawSurface:e.type==="3d"?new J(t,this.defaultZ,e):null,hasM:!1,elevationInfo:t}),this.addHandles([this.drawOperation.on("vertex-add",i=>this.onVertexAdd(i)),this.drawOperation.on("vertex-remove",i=>this.onVertexRemove(i)),this.drawOperation.on("vertex-update",i=>this.onVertexUpdate(i)),this.drawOperation.on("cursor-update",i=>this.onCursorUpdate(i)),this.drawOperation.on("complete",i=>this.onComplete(i))]),this.finishToolCreation()}destroy(){this.drawOperation=T(this.drawOperation),this._set("view",null)}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}get updating(){return this.drawOperation?.updating??!1}completeCreateOperation(){this.drawOperation.complete()}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.geometryIncludingUncommittedVertices}onInputEvent(e){this.drawOperation.onInputEvent(e)}canRedo(){return this.drawOperation.canRedo}canUndo(){return this.drawOperation.canUndo}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}onComplete(e){this.emit("complete",e)}onCursorUpdate(e){this.emit("cursor-update",e)}onVertexAdd(e){this.emit("vertex-add",e)}onVertexRemove(e){this.emit("vertex-remove",e)}onVertexUpdate(e){this.emit("vertex-update",e)}};r([s({constructOnly:!0,nonNullable:!0})],p.prototype,"defaultZ",void 0),r([s()],p.prototype,"drawOperation",void 0),r([s({constructOnly:!0})],p.prototype,"elevationInfo",void 0),r([s({value:!0})],p.prototype,"enabled",null),r([s({constructOnly:!0})],p.prototype,"geometryType",void 0),r([s({constructOnly:!0})],p.prototype,"hasZ",void 0),r([s({constructOnly:!0})],p.prototype,"mode",void 0),r([s()],p.prototype,"snapToScene",void 0),r([s({readOnly:!0})],p.prototype,"type",void 0),r([s({readOnly:!0})],p.prototype,"updating",null),r([s({constructOnly:!0,nonNullable:!0})],p.prototype,"view",void 0),p=r([l("esri.views.draw.DrawTool")],p);var I=class extends g{constructor(e){super(e),this._addVertexOnPointerUp=!1,this._drawTool=null}initialize(){this._addViewHandles(),this.view.type==="3d"&&this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles([this.view.on("key-down",e=>{e.key===n.complete&&(this._drawTool?this.complete():(this._abortSnapping(),this._vertexAddHandler(e)))},o.TOOL)])}_addViewHandles2DOnly(){this.view.type==="2d"&&this.addHandles([this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=d(e),e.pointerType==="touch"&&this._updateCursor())},o.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._cursorScreenPoint=d(e),e.pointerType!=="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},o.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)e.stopPropagation(),this._vertexAddHandler(e);else{let t=e.pointerType==="touch";this._updateCursor(t)}},o.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},o.TOOL)])}_addDrawTool(){let e=new p({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"point",mode:"click"});this._drawTool=e,this.view.addAndActivateTool(e),this.addHandles([e.on("cursor-update",t=>{t.vertices.length===1&&this.emit("cursor-update",new c(this.view,t.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("complete",t=>{this.emit("draw-complete",new m(e.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})])}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){let t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(t),this.notifyChange("vertices"),this._completeDrawing())}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;let t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t==null||e||this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new c(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new w(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();let e=new m(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};I=r([l("esri.views.draw.PointDrawAction")],I);var y=class extends g{constructor(e){super(e),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.mode=S}initialize(){this._addViewHandles(),this.view.type==="3d"&&this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}undo(){this._drawTool?this._drawTool.undo():(super.undo(),this.notifyChange("vertices"))}redo(){this._drawTool?this._drawTool.redo():(super.redo(),this.notifyChange("vertices"))}canUndo(){return this._drawTool?.canUndo()??super.canUndo()}canRedo(){return this._drawTool?.canRedo()??super.canRedo()}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles(this.view.on("key-down",e=>{let{key:t,repeat:i}=e;t!==n.vertexAdd||i?t!==n.complete||i?t!==n.undo||this.interactiveUndoDisabled||i?t!==n.redo||this.interactiveUndoDisabled||i||(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e)):(e.stopPropagation(),this._handleVertexAddKey(e))},o.TOOL))}_addViewHandles2DOnly(){this.view.type==="2d"&&(this.addHandles([this.view.on("click",e=>{e.stopPropagation()},o.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=d(e),e.pointerType==="touch"&&this._updateCursor())},o.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._cursorScreenPoint=d(e),e.pointerType!=="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._cursorScreenPoint=d(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},o.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}else{let t=e.pointerType==="touch";this._updateCursor(t)}},o.TOOL),this.view.on("drag",e=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&e.stopPropagation()},o.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},o.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},o.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},o.TOOL),this.view.on("key-down",e=>{let{key:t,repeat:i}=e;t!==n.pan||i||(e.stopPropagation(),this._panEnabled=!0)},o.TOOL),this.view.on("key-up",e=>{e.key===n.pan&&(e.stopPropagation(),this._panEnabled=!1)},o.TOOL)]),this._addUndoRedoHandles())}_handleVertexAddKey(e){this._drawTool?this._drawTool.drawOperation.commitStagedVertex():this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(e))}_addUndoRedoHandles(){this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){let t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new u(this.view,e.vertices[0].index,t))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){let t=this._committedVertices.length-1,i=new h(this.view,t,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){let t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new h(this.view,e.vertices[0].index,t))}})])}_addDrawTool(){let e=new p({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polygon",mode:this.mode});this._drawTool=e,this.view.addAndActivateTool(e),e.on("vertex-add",t=>{if(t.vertices.length===1){let{view:i}=this,a=t.vertices[0].vertexIndex,_=e.getVertexCoords();this.emit("vertex-add",new h(i,a,_)),t.operation!=="undo"&&t.operation!=="redo"||this.emit(t.operation,new h(i,a,_))}}),e.on("vertex-remove",t=>{if(t.vertices.length===1){let{view:i}=this,a=t.vertices[0].vertexIndex,_=e.getVertexCoords();this.emit("vertex-remove",new u(i,a,_)),t.operation!=="undo"&&t.operation!=="redo"||this.emit(t.operation,new u(i,a,_))}}),e.on("cursor-update",t=>{t.vertices.length===1&&this.emit("cursor-update",new c(this.view,t.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("complete",t=>{this.emit("draw-complete",new m(e.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){let t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(t))}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;let t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t==null||e||this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new c(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new w(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<3)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();let e=new m(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};r([s()],y.prototype,"_dragEnabled",null),r([s()],y.prototype,"_clickEnabled",null),r([s({type:H})],y.prototype,"mode",void 0),y=r([l("esri.views.draw.PolygonDrawAction")],y);var x=class extends g{constructor(e){super(e),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.mode=S}initialize(){this._addViewHandles(),this.view.type==="3d"&&this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}undo(){this._drawTool?this._drawTool.undo():(super.undo(),this.notifyChange("vertices"))}redo(){this._drawTool?this._drawTool.redo():(super.redo(),this.notifyChange("vertices"))}canUndo(){return this._drawTool?.canUndo()??super.canUndo()}canRedo(){return this._drawTool?.canRedo()??super.canRedo()}complete(){this._completeDrawing()}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles([this.view.on("key-down",e=>{let{key:t,repeat:i}=e;t!==n.vertexAdd||i?t!==n.complete||i?t!==n.undo||this.interactiveUndoDisabled||i?t!==n.redo||this.interactiveUndoDisabled||i||(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e)):(e.stopPropagation(),this._handleVertexAddKey(e))},o.TOOL)])}_addViewHandles2DOnly(){this.view.type==="2d"&&(this.addHandles([this.view.on("click",e=>{e.stopPropagation()},o.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&!this._panEnabled&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=d(e),e.pointerType==="touch"&&this._updateCursor())},o.TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=d(e),e.pointerType!=="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._cursorScreenPoint=d(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},o.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}else{let t=e.pointerType==="touch";this._updateCursor(t)}},o.TOOL),this.view.on("drag",e=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&e.stopPropagation()},o.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},o.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},o.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},o.TOOL),this.view.on("key-down",e=>{let{key:t,repeat:i}=e;t!==n.pan||i||(e.stopPropagation(),this._panEnabled=!0)},o.TOOL),this.view.on("key-up",e=>{e.key===n.pan&&(e.stopPropagation(),this._panEnabled=!1)},o.TOOL)]),this._addUndoRedoHandles())}_handleVertexAddKey(e){this._drawTool?this._drawTool.drawOperation.commitStagedVertex():this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(e))}_addUndoRedoHandles(){this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){let t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new u(this.view,e.vertices[0].index,t))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){let t=this._committedVertices.length-1,i=new h(this.view,t,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){let t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new h(this.view,e.vertices[0].index,t))}})])}_addDrawTool(){let e=new p({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polyline",mode:this.mode});this._drawTool=e,this.view.addAndActivateTool(e),this.addHandles([e.on("vertex-add",t=>{if(t.vertices.length!==1)return;let{view:i}=this,a=t.vertices[0].vertexIndex,_=e.getVertexCoords();this.emit("vertex-add",new h(i,a,_)),t.operation!=="undo"&&t.operation!=="redo"||this.emit(t.operation,new h(i,a,_))}),e.on("vertex-remove",t=>{if(t.vertices.length!==1)return;let{view:i}=this,a=t.vertices[0].vertexIndex,_=e.getVertexCoords();this.emit("vertex-remove",new u(i,a,_)),t.operation!=="undo"&&t.operation!=="redo"||this.emit(t.operation,new u(i,a,_))}),e.on("cursor-update",t=>{t.vertices.length===1&&this.emit("cursor-update",new c(this.view,t.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("complete",t=>{this.emit("draw-complete",new m(e.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})])}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){let t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(t))}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;let t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t==null||e||this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new c(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new w(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<2)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();let e=new m(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};r([s()],x.prototype,"_clickEnabled",null),r([s()],x.prototype,"_dragEnabled",null),r([s({type:H})],x.prototype,"mode",void 0),x=r([l("esri.views.draw.PolylineDrawAction")],x);var ie=["freehand","click"],V=class extends g{constructor(e){super(e),this._isDragging=!1,this._panEnabled=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.viewAlignedCoordinateSystem=null,this.mode="freehand"}initialize(){this.view.type==="2d"?this._addViewHandles():this._addDrawTool()}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this.mode==="click"?this.addHandles(this._getClickModeViewHandles()):this.addHandles(this._getDragModeViewHandles())}_getDragModeViewHandles(){return[this.view.on("immediate-click",e=>{e.stopPropagation(),e.mapPoint&&!this._panEnabled&&this.getCoordsFromScreenPoint(d(e))!=null&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))},o.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._panEnabled||(this._resetGeometry(),this._addVertexOnPointerUp=!0,this._cursorScreenPoint=d(e),this._activePointerId=e.pointerId,this._vertexAddHandler(e),this._isDragging=!1,e.pointerType==="touch"&&this._updateCursor()))},o.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._activePointerId==null&&e.pointerType!=="touch"&&(this._cursorScreenPoint=d(e),this._updateCursor())},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0,this._cursorScreenPoint=d(e),this._updateCursor())},o.TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&this._addVertexOnPointerUp&&(this._abortSnapping(),this._activePointerId=null,this._isDragging&&this._vertexAddHandler(e),this._committedVertices.length===2&&this._drawCompleteHandler(e),this._isDragging=!1)},o.TOOL),this.view.on("key-down",e=>{e.key===n.complete&&this._cursorScreenPoint?(this._abortSnapping(),this._vertexAddHandler(e),this._drawCompleteHandler(e)):e.key===n.pan&&(this._panEnabled=!0)},o.TOOL),this.view.on("key-up",e=>{e.key===n.pan&&(this._panEnabled=!1)},o.TOOL),this.view.on("drag",e=>{this._activePointerId!=null&&e.stopPropagation()},o.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},o.TOOL)]}_getClickModeViewHandles(){return[this.view.on("pointer-down",e=>{this._abortSnapping(),this._cursorScreenPoint=d(e),this._activePointerId=e.pointerId,this._isDragging=!1,e.pointerType==="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._cursorScreenPoint=d(e),this._activePointerId==null&&e.pointerType!=="touch"&&this._updateCursor()},o.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0)},o.TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=null,e.stopPropagation(),this._isDragging||this._vertexAddHandler(e),this.vertices.length!==2||this._isDragging||this._drawCompleteHandler(e),this._isDragging=!1)},o.TOOL),this.view.on("key-down",e=>{e.key===n.vertexAdd&&this._cursorScreenPoint&&(this._vertexAddHandler(e),this.vertices.length===2&&this._drawCompleteHandler(e)),e.key===n.complete&&this._cursorScreenPoint&&this.vertices.length===2&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))},o.TOOL)]}_addDrawTool(){let e=new p({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"segment",mode:this.mode});this._drawTool=e,this.view.addAndActivateTool(e),this.addHandles([e.on("vertex-add",t=>{t.vertices.length===1&&this.emit("vertex-add",new h(this.view,t.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("cursor-update",t=>{t.vertices.length===1&&this.emit("cursor-update",new c(this.view,t.vertices[0].vertexIndex,e.getVertexCoords()))}),e.on("complete",t=>{this.emit("draw-complete",new m(e.getVertexCoords())),this._removeDrawTool()}),this.view.on("key-down",t=>{t.key!==n.vertexAdd||t.repeat||this.mode!=="click"?t.key!==n.complete||t.repeat||e.completeCreateOperation():e.drawOperation.numCommittedVertices>0?e.completeCreateOperation():e.drawOperation.commitStagedVertex()},o.TOOL)])}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){let t=this._coordinateHelper.arrayToVector(e);if(this._isDuplicateOfLastVertex(t))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(t),this._committedVertices.length===1&&(this.viewAlignedCoordinateSystem=K(this.view,this._committedVertices[0]));let i=this._committedVertices.length-1,a=new h(this.view,i,this.vertices);this.emit("vertex-add",a)}_updateCursor(){if(this._popCursorVertex(),!this._cursorScreenPoint)return;let e=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);e!=null&&this._pushCursorVertex(e.vertex,()=>this.emit("cursor-update",new c(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new w(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return this._drawTool.completeCreateOperation(),void this.removeAllHandles();if(this._activePointerId=null,this._popCursorVertex(),this._cursorScreenPoint=null,this._isDragging=!1,this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;let e=new m(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}_resetGeometry(){this._editGeometryOperations.destroy(),this._editGeometryOperations=new A(new b("polygon",this._coordinateHelper),f.Local),this._activeComponent=new D(this._coordinateHelper.spatialReference,f.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}};r([s({type:ie})],V.prototype,"mode",void 0),V=r([l("esri.views.draw.SegmentDrawAction")],V);var O=class extends M{constructor(){super(...arguments),this.activeAction=null,this.type="draw",this.view=null}destroy(){this.activeAction&&(this.activeAction.destroy(),this.activeAction=null)}create(e,t){this.reset();let i=P({view:this.view},t);switch(e){case"point":i.editGeometryType="point",this.activeAction=new I(i);break;case"polyline":i.editGeometryType="polyline",this.activeAction=new x(i);break;case"multipoint":i.editGeometryType="polygon",this.activeAction=new E(i);break;case"polygon":i.editGeometryType="polygon",this.activeAction=new y(i);break;case"rectangle":case"circle":case"ellipse":case"triangle":i.editGeometryType="polygon",this.activeAction=new V(i)}return this.activeAction}complete(){this.activeAction&&this.activeAction.complete(),this.activeAction=null}reset(){this.activeAction&&this.activeAction.destroy(),this.activeAction=null}};r([s()],O.prototype,"activeAction",void 0),r([s({readOnly:!0})],O.prototype,"type",void 0),r([s()],O.prototype,"view",void 0),O=r([l("esri.views.draw.Draw")],O);var Di=O;export{Di as a};
