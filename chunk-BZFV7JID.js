import{a as ut,b as ct,f as le,i as mt}from"./chunk-TKO337WO.js";import{a as re}from"./chunk-7A3VKK4T.js";import"./chunk-7KEDAKSE.js";import{d as J}from"./chunk-7BFGBHWH.js";import{a as Ie,d as nt}from"./chunk-A77UUT27.js";import{a as at}from"./chunk-T6D7CINY.js";import"./chunk-M7FS7O7K.js";import{b as it}from"./chunk-KTP7EII6.js";import"./chunk-R5S5CHNL.js";import"./chunk-MCO7DSFO.js";import"./chunk-HHJJPMV6.js";import"./chunk-IGM7PT7Z.js";import{m as Y}from"./chunk-UDAVCKBV.js";import"./chunk-7QY3BMVN.js";import{a as $e}from"./chunk-BGI2WQLI.js";import{a as Ee}from"./chunk-Z33JZO3Q.js";import"./chunk-FYZRIMPP.js";import"./chunk-EGGOXN6S.js";import"./chunk-LX3TXNPU.js";import"./chunk-M7CD5NAW.js";import"./chunk-KOW2YKW3.js";import"./chunk-OR5TQLC2.js";import{a as lt}from"./chunk-JIEAXAQO.js";import"./chunk-BBBNACDZ.js";import"./chunk-RZU6EEB3.js";import{a as pt}from"./chunk-SFRQ4PHZ.js";import"./chunk-NJFASAXZ.js";import{a as dt}from"./chunk-KXDUJJUF.js";import{b as st,d as Ne}from"./chunk-QPOMWSFR.js";import"./chunk-2MVYKHX3.js";import"./chunk-7DPBVZFZ.js";import{a as tt}from"./chunk-IM3BGYEV.js";import{a as Le}from"./chunk-6QEGDZGH.js";import"./chunk-ZNEMFYSX.js";import"./chunk-ZB2MLS4M.js";import{a as Ce}from"./chunk-BF4ZL3U3.js";import{d as ft}from"./chunk-6MKTTYAV.js";import{a as xe}from"./chunk-LCWKR6WR.js";import"./chunk-PPALSVK5.js";import"./chunk-MAVOHF7Q.js";import"./chunk-JIO2NKRP.js";import"./chunk-JIFV566L.js";import{g as ht}from"./chunk-YBNLKD57.js";import"./chunk-A2WF4NJX.js";import"./chunk-VAIXCJGK.js";import"./chunk-KE4KELLY.js";import"./chunk-KKBJ5AEP.js";import"./chunk-MT7CYQIO.js";import"./chunk-C64FPBS5.js";import"./chunk-STCMK6X3.js";import"./chunk-2XAYS5PW.js";import"./chunk-2O2C5MZC.js";import"./chunk-2F3ICBUH.js";import{a as ot}from"./chunk-C4OC7UNL.js";import"./chunk-WBNQAM3K.js";import"./chunk-KH5B55IZ.js";import"./chunk-NPQPIZAK.js";import"./chunk-LOEAA5XF.js";import"./chunk-KBOF5WGE.js";import"./chunk-LX5FIKVZ.js";import{n as rt}from"./chunk-576BZULE.js";import"./chunk-N7KNO35F.js";import"./chunk-TALIOOAA.js";import"./chunk-6UOVQ25A.js";import"./chunk-BNSYK2BT.js";import"./chunk-DHY7QZ2H.js";import"./chunk-MFP2OFDR.js";import"./chunk-B7SBOPIK.js";import"./chunk-PDWLAUMH.js";import{d as te}from"./chunk-UVZRJ2I3.js";import"./chunk-65QIQYGA.js";import"./chunk-TLLESPR2.js";import"./chunk-NFADXGWT.js";import"./chunk-I3S324BU.js";import{c as ke}from"./chunk-YTC2EJDQ.js";import"./chunk-2UDQ3IWX.js";import"./chunk-DCAB3MR3.js";import"./chunk-YC7IXNOA.js";import"./chunk-MMZZL453.js";import"./chunk-XDMNA7OV.js";import"./chunk-NKZ7R6T6.js";import"./chunk-VHAPMMA5.js";import"./chunk-DR5D3NPO.js";import"./chunk-U6WVZEYH.js";import"./chunk-ERH7ZNSC.js";import"./chunk-GUOR3BIM.js";import"./chunk-WXS2B4FF.js";import{g as ue,r as Me}from"./chunk-XFK3CDZ5.js";import"./chunk-4XBATNKX.js";import"./chunk-3IJY37BG.js";import"./chunk-GNCG2SQP.js";import"./chunk-5HCLBNUR.js";import"./chunk-ZGCXXZVI.js";import"./chunk-5FNV5J76.js";import"./chunk-A5VRDVEH.js";import"./chunk-JEEYT3GD.js";import"./chunk-RMOIVYM4.js";import"./chunk-5JXPUH2D.js";import"./chunk-F4I5LECK.js";import"./chunk-J4PQZSQE.js";import{g as yt}from"./chunk-Q3WN5PJ6.js";import{a as Qe}from"./chunk-UMB6LRQI.js";import"./chunk-AQ74ANSJ.js";import"./chunk-SAOUSUZE.js";import"./chunk-IFPBW5UQ.js";import"./chunk-ZV7ILGPO.js";import"./chunk-6ZT4EXDX.js";import{a as ne}from"./chunk-RHHHYJSZ.js";import{f as et}from"./chunk-QBQKFGOZ.js";import"./chunk-K5NHJTKR.js";import"./chunk-XKXYUJUA.js";import{o as we,p as he}from"./chunk-F7PIPM6E.js";import"./chunk-FR6Q4MSQ.js";import"./chunk-C6JT6KYF.js";import"./chunk-BCREO4Q5.js";import"./chunk-Z5Q76SB7.js";import"./chunk-E5R4OI7X.js";import"./chunk-6FWNINU2.js";import"./chunk-ES7AH7WX.js";import"./chunk-RSDQHAJX.js";import"./chunk-NYONONNN.js";import"./chunk-MZFPLWMN.js";import"./chunk-DS2JVXBM.js";import{b as Ue}from"./chunk-G3LLBABP.js";import"./chunk-T4B3RN6B.js";import"./chunk-MXADXAOS.js";import"./chunk-RJHITHLB.js";import"./chunk-5TVEQGKJ.js";import"./chunk-U4U366GW.js";import"./chunk-JTJ3UVF7.js";import"./chunk-R4TNLPIN.js";import"./chunk-5HLV7XP5.js";import"./chunk-BENVXA3L.js";import{j as ze,t as ee}from"./chunk-UI76XBLJ.js";import"./chunk-UE2YGKE7.js";import{C as ie}from"./chunk-BE76S5KT.js";import"./chunk-3RDV3O6N.js";import"./chunk-D2ITYHSM.js";import"./chunk-FIITBHDP.js";import{a as Xe}from"./chunk-VSVNPPHQ.js";import"./chunk-CTGIUUCS.js";import{F as y,I as Ze}from"./chunk-VWEBO6QK.js";import{S as X,u as Z}from"./chunk-KAAR5ZJN.js";import{a as c}from"./chunk-W3WDPWBE.js";import{h as Ke}from"./chunk-WKT5W7KT.js";import"./chunk-MLSR6YE6.js";import"./chunk-JPDAKIWT.js";import"./chunk-VU5W7W6Y.js";import{p as K,r as Q}from"./chunk-X3IDZTNG.js";import"./chunk-IQJU4QT3.js";import{a as Je,b as Ve,h as E}from"./chunk-EAH6BNBL.js";var St="ESRI__DESTINATION_ID",vt="ESRI__ORIGIN_ID",pe=class e{constructor(){this._featureLookup=new Map}static getInstance(){return e.instance||(e.instance=new e),e.instance}static resetInstance(){e.instance&&(e.instance=null)}deleteFromStore(t){t.forEach(i=>{this._featureLookup.delete(i)})}readFromStoreByList(t){let i=[];return t.forEach(a=>{let n=this.readFromStoreById(a);n&&i.push(n)}),i}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,i,a){let n=[];return t.forEach(r=>{if(!r?.id)return;r.properties||(r.properties=[]);let s,h=null;if(a&&r.properties[a]&&(h=Y(r.properties[a])),"originId"in r&&"destinationId"in r&&(r.properties[vt]=r.originId,r.properties[St]=r.destinationId),r.properties[i]=r.id,r.id&&this._featureLookup.has(r.id)&&this._featureLookup.get(r.id).attributes){let o=this._featureLookup.get(r.id),u=JSON.parse(JSON.stringify(Object.assign(o.attributes,r.properties)));a&&r.properties[a]&&(u[a]=et(r.properties[a])),s=new $e(h?JSON.parse(JSON.stringify(h)):o?.geometry?JSON.parse(JSON.stringify(o.geometry)):null,u,null,r.properties[i])}else s=new $e(h?JSON.parse(JSON.stringify(h)):null,r.properties,null,r.properties[i]);this._featureLookup.set(r.id,s),n.push(s)}),n}};var ce;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(ce||(ce={}));var Gt=[ce.ELEMENTUID,ce.TYPENAME],He,Be;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(He||(He={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(Be||(Be={}));var gt,De,_e,We;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(gt||(gt={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(De||(De={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(_e||(_e={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(We||(We={}));function Tt(e){if(!e.spatialReference.isWGS84)throw new Q("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let t;return t=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],t}function bt(e,t){return E(this,null,function*(){let i=[],a=new Map,n=[];if(t.dataModel?.relationshipTypes)for(let r of t.dataModel.relationshipTypes)r.name&&a.set(r.name,[]);for(let r of e)a.has(r.typeName)&&a.get(r.typeName)?.push(r.id);for(let[r,s]of a){if(s.length<1)continue;let h=new re({openCypherQuery:`MATCH (n)-[r:${r}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:s}});n.push(le(t,h).then(o=>E(this,null,function*(){let u=o.resultRowsStream.getReader();for(;;){let{done:C,value:L}=yield u.read();if(C)break;for(let T of L)i.push({id:T[0],typeName:T[1]}),i.push({id:T[2],typeName:T[3]})}})))}return yield Promise.all(n),i})}var I="ESRI__ID",me="ESRI__ORIGIN_ID",ye="ESRI__DESTINATION_ID",A="ESRI__LAYOUT_GEOMETRY",fe="ESRI__AGGREGATION_COUNT",ae=12,z=class extends Ze{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;let t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach(i=>{i.name&&(t.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(i.name),i.properties?.forEach(a=>{a.geometryType&&a.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:a.name??"",geometryType:a.geometryType})}))}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(i=>{i.name&&(t.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(i.name),i.properties?.forEach(a=>{a.geometryType&&a.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:a.name??"",geometryType:a.geometryType})}))}),e.inclusionModeDefinition?.namedTypeDefinitions.forEach((i,a)=>{if(t.get(a)==="entity")this.entityTypeNames.add(a);else{if(t.get(a)!=="relationship")return K.getLogger(this).warn(`A named type, ${a}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(a);this.relationshipTypeNames.add(a)}let n=new Map;i.members?.forEach(r=>{Z(this.memberIdTypeLookup,r.id,()=>new Set).add(a);let s=this.getById(r.id);s&&n.set(r.id,s)}),this.sublayerCaches.set(a,n)})}addToLayer(e){e.forEach(({typeName:t,id:i})=>{if(!this.inclusionModeDefinition)throw new Q("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){let a=this.inclusionModeDefinition.namedTypeDefinitions.get(t);a.members||(a.members=new Map),a.members.set(i,{id:i}),Z(this.memberIdTypeLookup,i,()=>new Set).add(t)}}else{let a=new Map;a.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:a}),Z(this.memberIdTypeLookup,i,()=>new Set).add(t)}})}getById(e){return pe.getInstance().readFromStoreById(e)}getData(e,t,i){return E(this,null,function*(){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let a;if(a=e||new te({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){let n=t.parentCompositeLayer,r=this._processingCacheUpdatesLookup.get(t.objectType.name??""),s=a.outFields,h=a.geometry,o="",u="";h&&h.extent&&(o=J(h.extent.ymin,h.extent.xmin,ae),u=J(h.extent.ymax,h.extent.xmax,ae)),s&&s.length===1&&s[0]===I&&a.where==="1=1"||(yield Promise.all(r??[]));let C=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],L=[];return C.forEach(T=>{if(this.relationshipTypeNames.has(t.objectType.name)?T.geometry=n.relationshipLinkChartDiagramLookup.get(T.attributes[t.objectIdField]):T.geometry=n.entityLinkChartDiagramLookup.get(T.attributes[t.objectIdField]),T.attributes[A]=T.geometry,o&&u){let x=n.linkChartGeohashLookup.get(T.attributes[t.objectIdField]);x?x>=o&&x<=u&&L.push(T):L.push(T)}else L.push(T)}),L}return this.retrieveDataFromService(a,t,i)})}getConnectedRecordIds(e,t){return E(this,null,function*(){let i=[],a="",n=[],r=new Map;if(e.forEach(s=>{if(this.memberIdTypeLookup.has(s))for(let h of this.memberIdTypeLookup.get(s)){if(!this.entityTypeNames.has(h))return;r.has(h)?r.get(h)?.push(s):r.set(h,[s])}}),t&&t?.length!==0){for(let s of t)a=a+s+"|";a=a.slice(0,-1)}return r.forEach((s,h)=>{let o;o=t&&t?.length!==0?`MATCH (n:${h})-[r:${a}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${h})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;let u=new Promise(C=>{E(this,null,function*(){let L=(yield le(this.knowledgeGraph,new re({openCypherQuery:o,bindParameters:{ids:s}}))).resultRowsStream.getReader();try{for(;;){let{done:T,value:x}=yield L.read();if(T)break;for(let l=0;l<x.length;l++){let f=x[l];i.push({id:f[0],typeName:f[1]}),i.push({id:f[2],typeName:f[3]})}}}catch(T){if(T.name!=="AbortError")throw T;K.getLogger(this).info("Request aborted as expected")}}).then(()=>{C()})});n.push(u)}),this.refreshCacheContent(),yield Promise.all(n),i})}refreshCacheContent(e,t,i,a=!0){return E(this,null,function*(){let n=pe.getInstance(),r=[],s=new Map,h=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(o=>{o.name&&h.set(o.name,o)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(o=>{o.name&&h.set(o.name,o)}),e||this.inclusionModeDefinition?e?e.forEach(o=>{if(this.memberIdTypeLookup.has(o))for(let u of this.memberIdTypeLookup.get(o))s.has(u)?s.get(u)?.push(o):s.set(u,[o])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((o,u)=>{o.useAllData?s.set(u,null):o.members&&o.members.forEach(C=>{s.has(u)&&s.get(u)!==null?s.get(u)?.push(C.id):s.set(u,[C.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(o=>{o.name&&s.set(o.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(o=>{o.name&&s.set(o.name,null)}));for(let[o,u]of s){let C=new Promise(L=>{E(this,null,function*(){let x=new Set,l=[],f,w="",M=!1;if(t||h.get(o)?.properties?.forEach(p=>{p.name&&x.add(p.name)}),i&&this.geographicLookup.has(o)){let p=this.geographicLookup.get(o)?.name;p&&x.add(p)}if(this.entityTypeNames.has(o))w=`MATCH (n:${o}) ${u?"WHERE id(n) IN $ids ":""}return ID(n)`,x.forEach(p=>{w+=`, n.${p}`,l.push(p)});else{if(!this.relationshipTypeNames.has(o))throw new Q("knowledge-graph:layer-data-manager",`The graph type of ${o} could not be determined. Was this type set in the KG data model and inclusion definition?`);M=!0,w=`MATCH ()-[n:${o}]->() ${u?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,x.forEach(p=>{w+=`, n.${p}`,l.push(p)})}f=new re(u?{openCypherQuery:w,bindParameters:{ids:u}}:{openCypherQuery:w});let S=(yield le(this.knowledgeGraph,f)).resultRowsStream.getReader();for(;;){let{done:p,value:N}=yield S.read();if(p)break;let D=[];for(let k=0;k<N.length;k++){let q=N[k],v=0,B=0,G={properties:{}};for(G.id=q[v],v++,B++,M&&(G.originId=q[v],v++,B++,G.destinationId=q[v],v++,B++,Z(this.nodeConnectionsLookup,G.originId,()=>new Set).add(G.id),Z(this.nodeConnectionsLookup,G.destinationId,()=>new Set).add(G.id),Z(this.relationshipConnectionsLookup,G.id,()=>[G.originId,G.destinationId]));v<q.length;v++)G.properties[l[v-B]]=q[v];D.push(G)}let b=n.writeToStore(D,I,this.geographicLookup.get(o)?.name);this.sublayerCaches.has(o)||this.sublayerCaches.set(o,new Map),a&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(o)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(o,{useAllData:!1,members:new Map}),a&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(o).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(o).members=new Map);let $=this.sublayerCaches.get(o);b.forEach(k=>{$?.set(k.attributes[I],k),a&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(o).members.has(k.attributes[I])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(o).members.set(k.attributes[I],{id:k.attributes[I]}),Z(this.memberIdTypeLookup,k.attributes[I],()=>new Set).add(o))})}}).then(()=>{L(null)})});r.push(C),this._processingCacheUpdatesLookup.get(o)?.push(C)}yield Promise.all(r)})}removeFromLayer(e){let t=new Set,i=new Set(e.map(a=>a.id));for(let a of e)t.add(a.typeName),this.memberIdTypeLookup.get(a.id)?.size===1?this.memberIdTypeLookup.delete(a.id):this.memberIdTypeLookup.get(a.id)?.delete(a.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,r)=>{r===a.typeName&&n.members?.has(a.id)&&n.members.delete(a.id)});t.forEach(a=>{this.sublayerCaches.get(a)?.forEach((n,r)=>{i.has(r)&&this.sublayerCaches.get(a)?.delete(r)})})}retrieveDataFromService(e,t,i){return E(this,null,function*(){let a=pe.getInstance(),n=new Set,r=[],s,h="",o=[],u=t.graphType==="relationship",C=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,L=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name),T=!C&&L?Array.from(L).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&e.objectIds!=null&&(T=e.objectIds);else if(e.objectIds!=null&&T&&T.length>0){let l=e.objectIds;e.objectIds=T.filter(f=>l.includes(f))}else if(e.objectIds!=null)T=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=T}if(e.outFields!=null){let l=e.outFields;l.includes("*")?t.fields.forEach(f=>{n.add(f.name)}):l.forEach(f=>{f!==I&&f!==t.geometryFieldName&&n.add(f)})}if(e.geometry!=null){let l=e.geometry,f,w=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,M=w?.spatialReference,S=w?.serviceCapabilities?.geometryCapabilities,p=S?.geometryMaxBoundingRectangleSizeX,N=S?.geometryMaxBoundingRectangleSizeY;if(l?.extent?.spatialReference&&!l.spatialReference?.isWGS84?(yield Me(l.extent.spatialReference,ie),f=ue(l.extent,ie)):f=l.extent,p&&N&&M){if(M.wkid!==4326){let D=new ee({spatialReference:M,xmax:p,ymax:N}),b=ue(D,ie);p=b.xmax,N=b.ymax}if(f.xmax-f.xmin>p)throw new Q("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${p}\xB0 latitude, limit exceeded`);if(f.ymax-f.ymin>N)throw new Q("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${N}\xB0 longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){let D=yield Qe(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(b=>{D.fieldNames.includes(b.name)&&n.add(b.name)})}h=u?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&n.add(t.geometryFieldName),n.forEach(D=>{h+=`, n.${D}`,r.push(D)}),s=new re({openCypherQuery:h,bindParameters:{param_filter_geom:new we({rings:Tt(f)})}})}else{let l="";if(e.where!=null&&e.where!=="1=1"){let M=yield Qe(e.where,t.fieldsIndex);t.fields.forEach(b=>{M.fieldNames.includes(b.name)&&n.add(b.name)});let S=new Set(["column-reference","string","number","binary-expression"]),p=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]),N=!1,D=b=>{if(b.type==="column-reference")return`n.${b.column}`;if(b.type==="string")return`'${b.value}'`;if(b.type==="number")return`${b.value}`;if(b.type==="binary-expression"&&S.has(b.left.type)&&S.has(b.right.type)&&p.has(b.operator))return`${D(b.left)} ${b.operator} ${D(b.right)}`;if(b.type==="binary-expression"&&b.operator==="LIKE"){let $="";if(b.left.type==="function"&&b.left.args.value[0].type==="column-reference")$+=`lower(n.${b.left.args.value[0].column})`;else{if(b.left.type!=="column-reference")return N=!0,"";$+=`lower(n.${b.left.column})`}if($+=" CONTAINS (",b.right.type!=="string")return N=!0,"";{let k=b.right.value;k.charAt(0)==="%"&&(k=k.slice(1)),k.charAt(k.length-1)==="%"&&(k=k.slice(0,-1)),$+=`'${k.toLowerCase()}')`}return $}return N=!0,""};l=D(M.parseTree),N&&(l="")}let f="";f=u?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let w=!1;T&&(w=!0,f+=" WHERE ID(n) IN $ids"),l&&(f+=w?" AND":" WHERE",f+=` ${l}`),f+=" return ID(n)",u&&(f+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&n.add(t.geometryFieldName),n.forEach(M=>{f+=`, n.${M}`,r.push(M)}),s=new re(T?{openCypherQuery:f,bindParameters:{ids:T}}:{openCypherQuery:f})}let x=(yield le(t.parentCompositeLayer.dataManager.knowledgeGraph,s,i)).resultRowsStream.getReader();for(;;){let{done:l,value:f}=yield x.read();if(l)break;let w=[];for(let M=0;M<f.length;M++){let S=f[M],p=0,N=0,D={properties:{}};for(D.id=S[p],p++,N++,u&&(D.originId=S[p],p++,N++,D.destinationId=S[p],p++,N++);p<S.length;p++)D.properties[r[p-N]]=S[p];w.push(D)}o=o.concat(a.writeToStore(w,I,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return o})}};c([y()],z.prototype,"knowledgeGraph",void 0),c([y()],z.prototype,"inclusionModeDefinition",void 0),c([y()],z.prototype,"entityTypeNames",void 0),c([y()],z.prototype,"relationshipTypeNames",void 0),c([y()],z.prototype,"geographicLookup",void 0),c([y()],z.prototype,"sublayerCaches",void 0),c([y()],z.prototype,"nodeConnectionsLookup",void 0),c([y()],z.prototype,"relationshipConnectionsLookup",void 0),c([y()],z.prototype,"memberIdTypeLookup",void 0),z=c([X("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],z);var wt=pt(),Lt=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return c([y(wt.fields)],t.prototype,"fields",void 0),c([y(wt.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=c([X("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};var _=class extends lt(Lt(Le(Ce(tt(xe))))){constructor(e){if(super(e),this.capabilities=nt(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=I,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then(()=>{let t=new MessageChannel;return new ht(t.port1,{channel:t,client:{queryFeatures:(i,a={})=>{let n=te.fromJSON(i);return this.queryFeaturesJSON(n,a)}}}),[t.port2]})},this.type="knowledge-graph-sublayer",e.parentCompositeLayer.type==="link-chart")e.graphType==="relationship"?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=A;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType!=="esriGeometryNull"){let t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?ne.fromJSON(t.geometryType):null;let i=t?.name,a=i?e.objectType.properties?.[i]:null;a?(this.hasM=a.hasM??!1,this.hasZ=a.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach(t=>{let i=null,a=t.fieldType;a==="esriFieldTypeOID"&&(a="esriFieldTypeInteger"),this.fields.push(ke.fromJSON({name:t.name,type:a,alias:t.alias,defaultValue:i,editable:t.editable,nullable:t.nullable}))}),this.fields.push(ke.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this.fields.push(ke.fromJSON({name:fe,type:"esriFieldTypeInteger",alias:fe,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),e.parentCompositeLayer.type==="link-chart"?e.graphType==="relationship"?this.renderer=Ne(Ie(ne.toJSON("polyline")).renderer):this.renderer=Ne(Ie(ne.toJSON("point")).renderer):this.renderer=Ne(Ie(ne.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){yt(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return dt(this,e)}createQuery(){return new te({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}queryFeatures(e,t){return E(this,null,function*(){let{resolvedQuery:i,queryEngine:a}=yield this._setupQueryObjects(e),n=ot.fromJSON(yield a.executeQuery(i.toJSON(),t?.signal));return n.features.forEach(r=>{r.sourceLayer=this}),n})}queryFeaturesJSON(e,t){return E(this,null,function*(){let{resolvedQuery:i,queryEngine:a}=yield this._setupQueryObjects(e);return yield a.executeQuery(i.toJSON(),t?.signal)})}queryFeatureCount(e,t){return E(this,null,function*(){let{resolvedQuery:i,queryEngine:a}=yield this._setupQueryObjects(e);return a.executeQueryForCount(i.toJSON(),t?.signal)})}queryExtent(){return E(this,arguments,function*(e={},t){let i=Ve(Je({},e),{returnGeometry:!0}),{resolvedQuery:a,queryEngine:n}=yield this._setupQueryObjects(i),r=yield n.executeQueryForExtent(a.toJSON(),t?.signal),s;return s=r.extent?.xmin!=null&&r.extent?.xmax!=null&&r.extent?.ymin!=null&&r.extent?.ymax!=null?new ee(r.extent):new ee,{count:r.count,extent:s}})}queryObjectIds(e,t){return E(this,null,function*(){let i=te.from(e),a;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)a=this._cachedQueryEngine;else{let n=yield this.parentCompositeLayer.dataManager.getData(i,this,t);a=this.loadQueryEngine(n)}return a.executeQueryForIds(i.toJSON(),t?.signal)})}loadQueryEngine(e){let t=new at({geometryType:ne.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),i=new it({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:ne.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return i.featureStore.addMany(e),i}refreshCachedQueryEngine(){return E(this,null,function*(){let e=yield this.parentCompositeLayer.dataManager.getData(new te({where:"1=1",outFields:[I]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)})}_setupQueryObjects(e,t){return E(this,null,function*(){let i=te.from(e),a=i.geometry,n;if(a&&!a.spatialReference?.isWGS84&&(yield Me(a.spatialReference,ie),i.geometry=ue(a instanceof we||a instanceof he?a:a.extent,ie)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{let r=yield this.parentCompositeLayer.dataManager.getData(i,this,t);n=this.loadQueryEngine(r)}return{resolvedQuery:i,queryEngine:n}})}};c([y()],_.prototype,"capabilities",void 0),c([y({readOnly:!0})],_.prototype,"defaultPopupTemplate",null),c([y()],_.prototype,"definitionExpression",void 0),c([y()],_.prototype,"displayField",void 0),c([y()],_.prototype,"elevationInfo",void 0),c([y()],_.prototype,"geometryType",void 0),c([y()],_.prototype,"geometryFieldName",void 0),c([y()],_.prototype,"graphType",void 0),c([y()],_.prototype,"hasM",void 0),c([y()],_.prototype,"hasZ",void 0),c([y()],_.prototype,"labelsVisible",void 0),c([y()],_.prototype,"labelingInfo",void 0),c([y()],_.prototype,"objectIdField",void 0),c([y()],_.prototype,"objectType",void 0),c([y()],_.prototype,"parentCompositeLayer",void 0),c([y(ft)],_.prototype,"popupEnabled",void 0),c([y({type:rt,json:{name:"popupInfo",write:!0}})],_.prototype,"popupTemplate",void 0),c([y({types:st,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],_.prototype,"renderer",null),c([y()],_.prototype,"source",void 0),c([y({json:{read:!1}})],_.prototype,"type",void 0),_=c([X("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],_);var Re=_;var Ye,R=null;function Nt(){return Ye||(Ye=import("./chunk-M25OFMUW.js").then(e=>e.l).then(({default:e})=>e({locateFile:t=>Xe(`esri/libs/linkchartlayout/${t}`)})).then(e=>{Ot(e)}),Ye)}function Ot(e){R=e}var H,ge;function de(e,t,i,a,n,r){let s=i.length,h=n.length,o=Float64Array.BYTES_PER_ELEMENT,u=Uint32Array.BYTES_PER_ELEMENT,C=Uint8Array.BYTES_PER_ELEMENT,L=16,T=L-1+s*(C+2*o)+h*(2*u),x=R._malloc(T);try{let l=x+L-x%L,f=l+s*o,w=f+s*o,M=w+h*u,S=M+h*u,p=()=>[R.HEAPF64.subarray(l>>3,(l>>3)+s),R.HEAPF64.subarray(f>>3,(f>>3)+s),R.HEAPU32.subarray(w>>2,(w>>2)+h),R.HEAPU32.subarray(M>>2,(M>>2)+h),R.HEAPU8.subarray(S,S+s)],[N,D,b,$,k]=p();N.set(i),D.set(a),b.set(n),$.set(r),k.set(t);let q=e(s,S,l,f,h,w,M),v=null;if(q){let j=R.getLayoutLinksTypes(),W=R.getLayoutLinksVerticesEndIndices(),P=R.getLayoutLinksVertices(),U=R.countLayoutLinksVertices();!h||j&&W?U&&!P?q=!1:v={types:new Uint8Array(R.HEAPU8.subarray(j,j+h)),vertexEndIndex:new Uint32Array(R.HEAPU32.subarray(W>>2,(W>>2)+h)),vertices:new Float64Array(R.HEAPF64.subarray(P>>3,(P>>3)+2*U))}:q=!1}let[B,G,d,g,m]=p();return i.set(B),a.set(G),n.set(d),r.set(g),t.set(m),{success:q,links:v}}finally{R._free(x),R.cleanupLayout()}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"})(H||(H={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(ge||(ge={}));var Ct=2,kt=1,Et=-1,Fe,Ae,Se,ve,Ge,Pe,Mt,It;(function(e){function t(){return R.getMinIdealEdgeLength()}function i(a,n,r,s,h,o=Ct,u=kt,C=Et){return de((L,T,x,l,f,w,M)=>R.applyForceDirectedLayout(L,T,x,l,f,w,M,o,u,C),a,n,r,s,h)}e.getMinIdealEdgeLength=t,e.apply=i})(Fe||(Fe={})),function(e){function t(i,a,n,r,s,h=Ct,o=kt,u=Et){return de((C,L,T,x,l,f,w)=>R.applyCommunityLayout(C,L,T,x,l,f,w,h,o,u),i,a,n,r,s)}e.apply=t}(Ae||(Ae={})),function(e){function t(i,a,n,r,s){return de(R.applySimpleLayout,i,a,n,r,s)}e.apply=t}(Se||(Se={})),function(e){function t(i,a,n,r,s){return de(R.applyHierarchicalLayout,i,a,n,r,s)}e.apply=t}(ve||(ve={})),function(e){function t(i,a,n,r,s){return de(R.applyRadialTreeLayout,i,a,n,r,s)}e.apply=t}(Ge||(Ge={})),function(e){function t(i,a,n,r,s){return de(R.applySmartTreeLayout,i,a,n,r,s)}e.apply=t}(Pe||(Pe={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Mt||(Mt={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(It||(It={}));var qt=(e,t,i)=>(e.has(t)||e.set(t,i()),e.get(t)),O=class extends Le(Ce(xe)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new Ue,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new ee({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new Ue,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new Q("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){let r=this.url.split("/");this.title=r[r.length-2]}let t=new Set,i=[],a=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new Q("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach(r=>{r.name&&this._graphTypeLookup.set(r.name,r)}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(r=>{r.name&&this._graphTypeLookup.set(r.name,r)}),e.inclusionModeDefinition?.generateAllSublayers?(i=e.knowledgeGraph.dataModel.entityTypes??[],a=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((r,s)=>{if(!this._graphTypeLookup.get(s))return K.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);this._graphTypeLookup.get(s)instanceof ct||"strictOrigin"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),a.push(this._graphTypeLookup.get(s))):this._graphTypeLookup.get(s)instanceof ut||"properties"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),i.push(this._graphTypeLookup.get(s))):(K.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))}):(i=e.knowledgeGraph.dataModel.entityTypes??[],a=e.knowledgeGraph.dataModel.relationshipTypes??[]);let n=new z({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=a,this.dataManager=n}load(e){return this.addResolvingPromise(new Promise(t=>{mt(this.url).then(i=>{if(this._initializeLayerProperties({knowledgeGraph:i,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(a.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(a.name,{useAllData:!0})})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(a=>{a.useAllData=!1,a.members?.forEach(n=>{let r;r=n.linkChartLocation instanceof Ee?n.linkChartLocation:n.linkChartLocation?Y(n.linkChartLocation):null,r&&r.coords.length===2&&r.lengths.length===0?(this.linkChartGeohashLookup.set(n.id,J(r.coords[1],r.coords[0],ae)),this.entityLinkChartDiagramLookup.set(n.id,r)):(this.linkChartGeohashLookup.set(n.id,""),this.relationshipLinkChartDiagramLookup.set(n.id,r))}),this.addResolvingPromise(this._initializeDiagram().then(()=>E(this,null,function*(){this.layers.forEach(n=>E(this,null,function*(){yield n.refreshCachedQueryEngine()})),this.tables.forEach(n=>E(this,null,function*(){yield n.refreshCachedQueryEngine()}))})))});else{let a=this.defaultLinkChartConfig?.layoutMode==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,a,!0).then(()=>E(this,null,function*(){Ke(e);let n=[],r=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(s=>{s.useAllData=!1})),yield this._initializeDiagram(),this.layers.forEach(s=>{r.push(s.refreshCachedQueryEngine()),n.push(new Promise(h=>{s.on("layerview-create",()=>{h(null)})}))}),this.tables.forEach(s=>{r.push(s.refreshCachedQueryEngine())}),yield Promise.all(r)})))}t(null)})})),Promise.resolve(this)}addRecords(e,t){return E(this,null,function*(){let i=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(i=yield bt(e,this.dataManager.knowledgeGraph));let a=e.concat(i).filter(n=>!this.sublayerIdsCache.get(n.typeName)?.has(n.id));yield this._handleNewRecords(a)})}removeRecords(a){return E(this,arguments,function*(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:i=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){let n=[];for(let s of e)this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(s.typeName)?.useAllData===!1&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(s.typeName)?.members?.has(s.id)&&n.push(s);if(t){let s=new Set,h=[];for(let o of n)if(this.dataManager.nodeConnectionsLookup.has(o.id))for(let u of this.dataManager.nodeConnectionsLookup.get(o.id))s.add(u);for(let o of s)if(this.dataManager.memberIdTypeLookup.has(o))for(let u of this.dataManager.memberIdTypeLookup.get(o))this.dataManager.relationshipTypeNames.has(u)&&h.push({id:o,typeName:u});n=n.concat(h)}this.dataManager.removeFromLayer(n);for(let s of n)this.sublayerIdsCache.get(s.typeName)?.delete(s.id),this.dataManager.relationshipTypeNames.has(s.typeName)?this.relationshipLinkChartDiagramLookup.delete(s.id):this.entityLinkChartDiagramLookup.delete(s.id);i&&(yield this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{}));let r=[];return this.layers.forEach(s=>{r.push(s.refreshCachedQueryEngine())}),yield Promise.all(r),this._refreshNamedTypes(),n})}expand(e,t){return E(this,null,function*(){let i=yield this.dataManager.getConnectedRecordIds(e,t),a=i.filter(n=>!this.sublayerIdsCache.get(n.typeName)?.has(n.id));return yield this._handleNewRecords(i),{records:a}})}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach(e=>{let t=new Re({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.memberEntityTypes.forEach(e=>{let t=new Re({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,t)=>{let i=qt(this.sublayerIdsCache,t,()=>new Set);e.members?.forEach(a=>{if(i.add(a.id),a.linkChartLocation)if(a.linkChartLocation instanceof Ee)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(a.id,a.linkChartLocation):this.entityLinkChartDiagramLookup.set(a.id,a.linkChartLocation),a.linkChartLocation.coords.length===2&&a.linkChartLocation.lengths.length===0?this.linkChartGeohashLookup.set(a.id,J(a.linkChartLocation.coords[1],a.linkChartLocation.coords[0],ae)):this.linkChartGeohashLookup.set(a.id,"");else{let n=Y(a.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(a.id,a.linkChartLocation?n:null):this.entityLinkChartDiagramLookup.set(a.id,a.linkChartLocation?n:null),"x"in a.linkChartLocation&&"y"in a.linkChartLocation?this.linkChartGeohashLookup.set(a.id,J(a.linkChartLocation.x,a.linkChartLocation.y,ae)):this.linkChartGeohashLookup.set(a.id,"")}})})}calculateLinkChartLayout(e="RADIAL_TREE",t){return E(this,null,function*(){let i=[],a=[],n=[];this.dataManager.sublayerCaches.forEach((d,g)=>{this.dataManager.entityTypeNames.has(g)?d.forEach(m=>{i.push({typeName:g,feature:m})}):this.dataManager.relationshipTypeNames.has(g)&&d.forEach(m=>{a.push({typeName:g,feature:m})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;let r=new Map,s=new Map,h=new Map,o=new Map,u=new Uint8Array(i.length),C=new Float64Array(i.length),L=new Float64Array(i.length),T=new Uint32Array(a.length),x=new Uint32Array(a.length),l=[],f="FORCE_DIRECTED",w=new ee({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),M,S="FORCE_DIRECTED",p=0,N=0;switch(S=e==="GEOGRAPHIC"?f:e,S){case"FORCE_DIRECTED":M=Fe.apply;break;case"COMMUNITY":M=Ae.apply;break;case"HIERARCHICAL":M=ve.apply;break;case"RADIAL_TREE":M=Ge.apply;break;case"SMART_TREE":M=Pe.apply;break;default:M=Se.apply}i.forEach(({typeName:d,feature:g})=>{if(t?.lockedNodeLocations?.has(g.attributes[I])){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(d)?u[p]=H.IsGeographic:u[p]=H.None;let m=t.lockedNodeLocations.get(g.attributes[I]);C[p]=m.x,L[p]=m.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(d)){u[p]=H.IsGeographic;let m=null,j=g.attributes[this.dataManager.geographicLookup.get(d).name];switch(this.dataManager.geographicLookup.get(d)?.geometryType){case"esriGeometryPoint":C[p]=j?.x,L[p]=j?.y;break;case"esriGeometryPolygon":m=j?.centroid,m?.x!=null&&m?.y!=null?(C[p]=m.x,L[p]=m.y):u[p]=H.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":m=j?.extent?.center,m?.x!=null&&m?.y!=null?(C[p]=m.x,L[p]=m.y):u[p]=H.IsMovable;break;default:u[p]=H.IsMovable}(C[p]==null||L[p]==null||Number.isNaN(C[p])||Number.isNaN(L[p]))&&(u[p]=H.IsMovable,C[p]=0,L[p]=0)}else u[p]=H.IsMovable,C[p]=0,L[p]=0;o.set(g.attributes[I],p),l[p]={feature:g,typeName:d},p++});let D=!1,b=new Map;a.forEach(d=>{let g=d.feature.attributes[me],m=d.feature.attributes[ye],j=o.get(g),W=o.get(m);if(j!==void 0&&W!==void 0){let P=g+"-"+m,U=b.get(P);U?.has(d.typeName)||(T[N]=j,x[N]=W,U===void 0?b.set(P,new Map([[d.typeName,N]])):U.set(d.typeName,N),N++),n.push(d)}else D=!0,this.relationshipLinkChartDiagramLookup.set(g,null),this.linkChartGeohashLookup.set(g,null)}),D&&K.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),yield Nt();let{success:$,links:k}=M(u,C,L,T.subarray(0,N),x.subarray(0,N));if(!$)throw new Q("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let d=0;d<l.length;d++){if(L[d]>84.9999?L[d]=84.9999:L[d]<-84.9999&&(L[d]=-84.9999),C[d]>179.9999?C[d]=179.9999:C[d]<-179.9999&&(C[d]=-179.9999),l[d].feature.attributes[A]=new ze(C[d],L[d]),r.has(l[d].typeName))r.get(l[d].typeName)?.set(l[d].feature.attributes[I],l[d].feature);else{let m=new Map;m.set(l[d].feature.attributes[I],l[d].feature),r.set(l[d].typeName,m)}h.set(l[d].feature.attributes[I],l[d].feature);let g=Y(l[d].feature.attributes[A]);this.entityLinkChartDiagramLookup.set(l[d].feature.attributes[I],l[d].feature.attributes[A]?g:null),this.linkChartGeohashLookup.set(l[d].feature.attributes[I],J(l[d].feature.attributes[A].y,l[d].feature.attributes[A].x,ae)),l[d].feature.attributes[A].x<w.xmin&&(w.xmin=l[d].feature.attributes[A].x),l[d].feature.attributes[A].x>w.xmax&&(w.xmax=l[d].feature.attributes[A].x),l[d].feature.attributes[A].y<w.ymin&&(w.ymin=l[d].feature.attributes[A].y),l[d].feature.attributes[A].y>w.ymax&&(w.ymax=l[d].feature.attributes[A].y)}if(this.linkChartExtent.xmin=w.xmin,this.linkChartExtent.xmax=w.xmax,this.linkChartExtent.ymin=w.ymin,this.linkChartExtent.ymax=w.ymax,!k)throw new Q("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");let q=new Map,v=new Map,B=new Map,G=new Set;for(let d=0;d<n.length;d++){let g=[],m=n[d],j=m.feature.attributes[me],W=m.feature.attributes[ye],P=j+"-"+W,U=b.get(P).get(m.typeName),se=U===0?0:k?.vertexEndIndex[U-1];if(!G.has(U)){if(G.add(U),k.types[U]===ge.Recursive){let F=[k.vertices[2*se],k.vertices[2*se+1]],je=[k.vertices[2*(se+1)],k.vertices[2*(se+1)+1]],oe=[.5*(F[0]+je[0]),.5*(F[1]+je[1])],be=[oe[0]-F[0],oe[1]-F[1]],Ft=[oe[0]+be[1],oe[1]-be[0]],At=[oe[0]-be[1],oe[1]+be[0]];g.push(F),g.push(Ft),g.push(je),g.push(At),g.push(F)}else{if(k.types[U]!==ge.Regular){K.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let F=se;F<k.vertexEndIndex[U];F++)g.push([k.vertices[2*F],k.vertices[2*F+1]])}let V=l[o.get(j)]?.feature.attributes[A],Te=l[o.get(W)]?.feature.attributes[A];g[0][0]===V.x&&g[0][1]===V.y||(g[0]=[V.x,V.y]),g[g.length-1][0]===Te.x&&g[g.length-1][1]===Te.y||(g[g.length-1]=[Te.x,Te.y]);for(let F=1;F<g.length-1;F++)g[F][1]>85.5?g[F][1]=85.5:g[F][1]<-85.5&&(g[F][1]=-85.5),g[F][0]>179.9999?g[F][0]=179.9999:g[F][0]<-179.9999&&(g[F][0]=-179.9999);q.has(P)?q.get(P).push(g):q.set(P,[g])}let xt=q.get(P);v.has(P)||(v.set(P,new Map),B.set(P,new Map));let Oe=v.get(P),qe=B.get(P);Oe.has(m.typeName)||(Oe.set(m.typeName,xt.shift()),qe.set(m.typeName,0));let Dt=Oe.get(m.typeName);qe.set(m.typeName,qe.get(m.typeName)+1);let _t=new he({paths:Dt});if(m.feature.attributes[A]=_t,s.has(m.typeName))s.get(m.typeName)?.set(m.feature.attributes[I],m.feature);else{let V=new Map;V.set(m.feature.attributes[I],m.feature),s.set(m.typeName,V)}h.set(m.feature.attributes[I],m.feature);let Rt=Y(m.feature.attributes[A]);this.relationshipLinkChartDiagramLookup.set(m.feature.attributes[I],m.feature.attributes[A]?Rt:null),this.linkChartGeohashLookup.set(m.feature.attributes[I],"")}for(let d of n)d.feature.attributes[fe]=B.get(d.feature.attributes[me]+"-"+d.feature.attributes[ye])?.get(d.typeName)??null;return this._currentLinkChartConfig={layoutMode:e},{nodes:r,links:s,idMap:h}})}applyNewLinkChartLayout(e="RADIAL_TREE",t){return E(this,null,function*(){let i=[];yield this.calculateLinkChartLayout(e,t),this.layers.forEach(a=>{i.push(a.refreshCachedQueryEngine())}),yield Promise.all(i),this._refreshNamedTypes()})}getCurrentNodeLocations(){let e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(t=>{t?.members?.forEach(i=>{let a=i.linkChartLocation,n,r=i.id;a&&(n="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]},e.set(r,new ze({x:n.x,y:n.y})))})}),e}synchronizeInclusionListWithCache(){return E(this,null,function*(){return new Promise(e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((t,i)=>{if(t.useAllData=!1,t.members&&t.members.size>0){if(!this.dataManager.sublayerCaches.get(i))return;let a=new Set(Array.from(this.dataManager.sublayerCaches.get(i).keys()));Array.from(t.members.keys()).filter(n=>!a.has(n)).forEach(n=>{t.members?.delete(n)})}}),e()})})}refreshLinkChartCache(e){return E(this,null,function*(){yield this.dataManager.refreshCacheContent(e);let t=[];this.layers.forEach(i=>{t.push(i.refreshCachedQueryEngine())}),yield Promise.all(t),this._refreshNamedTypes()})}_handleNewRecords(e){return E(this,null,function*(){let t=[];this.dataManager.addToLayer(e);for(let i of e)this.sublayerIdsCache.has(i.typeName)||(this.sublayerIdsCache.set(i.typeName,new Set),t.push(i.typeName)),this.sublayerIdsCache.get(i.typeName).add(i.id);for(let i of t)if(this._graphTypeLookup.has(i)){let a=this._graphTypeLookup.get(i),n="endPoints"in a?"relationship":"entity",r=new Re({objectType:a,parentCompositeLayer:this,graphType:n,title:i});n==="entity"?this.dataManager.entityTypeNames.add(i):this.dataManager.relationshipTypeNames.add(i),r.geometryType?this.layers.push(r):this.tables.push(r),this.dataManager.sublayerCaches.set(i,new Map)}yield this.dataManager.refreshCacheContent(e.map(i=>i.id)),yield this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode)})}_initializeDiagram(){return E(this,null,function*(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{e?.members?.forEach(i=>{let a=i.linkChartLocation,n,r=i.id;if(!a)return;n="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]};let s=Y(n);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(r,s):this.entityLinkChartDiagramLookup.set(r,s),this.linkChartGeohashLookup.set(r,J(n.x,n.y,ae)),this.linkChartExtent.xmin>n.x&&(this.linkChartExtent.xmin=n.x),this.linkChartExtent.xmax<n.x&&(this.linkChartExtent.xmax=n.x),this.linkChartExtent.ymin>n.y&&(this.linkChartExtent.ymin=n.y),this.linkChartExtent.ymax<n.y&&(this.linkChartExtent.ymax=n.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(t=>{let i=this.relationshipLinkChartDiagramLookup.get(t.attributes[me]),a=this.relationshipLinkChartDiagramLookup.get(t.attributes[ye]);if(i&&a){let n=Y(new he({paths:[[i.coords[0],i.coords[1]],[a.coords[0],a.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(t.attributes[I],n)}else this.relationshipLinkChartDiagramLookup.set(t.attributes[I],null);this.linkChartGeohashLookup.set(t.attributes[I],"")})})):yield this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations()}):yield this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})})}_refreshNamedTypes(){for(let e of this.layers)e.emit("refresh",{dataChanged:!0});for(let e of this.tables)e.emit("refresh",{dataChanged:!0})}};c([y()],O.prototype,"dataPreloadedInLocalCache",void 0),c([y()],O.prototype,"defaultLinkChartConfig",void 0),c([y()],O.prototype,"dataManager",void 0),c([y()],O.prototype,"knowledgeGraph",void 0),c([y()],O.prototype,"layers",void 0),c([y()],O.prototype,"entityLinkChartDiagramLookup",void 0),c([y()],O.prototype,"relationshipLinkChartDiagramLookup",void 0),c([y()],O.prototype,"linkChartExtent",void 0),c([y()],O.prototype,"linkChartGeohashLookup",void 0),c([y()],O.prototype,"memberEntityTypes",void 0),c([y()],O.prototype,"memberRelationshipTypes",void 0),c([y()],O.prototype,"sublayerIdsCache",void 0),c([y()],O.prototype,"tables",void 0),c([y({json:{read:!1}})],O.prototype,"type",void 0),O=c([X("esri.layers.LinkChartLayer")],O);var Ln=O;export{Ln as default};
