import{b as il}from"./chunk-BJQH3R2Y.js";import{b as yl}from"./chunk-KQ7IE7A4.js";import{b as pl}from"./chunk-JAAOLJTO.js";import{a as ll,b as hl,c as cl,e as ul}from"./chunk-CUPRPTZ4.js";import{b as nl}from"./chunk-B5ZLUQHV.js";import{a as al,c as ol}from"./chunk-SFGIVWEM.js";import{a as nr,b as ml,d as fl}from"./chunk-TB62XDET.js";import{b as aa,c as _l}from"./chunk-2TTSZYUA.js";import{a as dl,b as gl}from"./chunk-UJUCAWBP.js";import{a as el}from"./chunk-RCPMQJFX.js";import{A as zn,D as qn,E as kn,F as ia,G as Ur,H as Yn,I as Cs,J as jr,K as Zn,L as Xn,a as Ji,b as Qi,c as $i,e as me,f as rr,g as sr,h as Nn,i as Vn,j as Fn,k as Un,l as Ss,m as ir,o as jn,r as j,s as Bn,t as ea,v as ta,w as ra,x as Gn,y as Hn,z as Wn}from"./chunk-G3QDAYGZ.js";import{a as Sn,b as Cn,d as Ms}from"./chunk-SXPOFH4U.js";import{a as Kt}from"./chunk-FVCUBGKZ.js";import{c as sa}from"./chunk-LCBWJNVO.js";import{a as Ke,b as et,c as tt,d as or,e as Qn,f as $n,h as As}from"./chunk-JAXR3ZUJ.js";import{d as bs,e as En,f as An}from"./chunk-XN46SLSO.js";import{a as Es,b as D}from"./chunk-XSJRPCD6.js";import{a as xs,b as Ye,d as Tt,e as Mn,f as Ki,g as Pn,h as In,k as er,l as le,p as ar,u as Jn,w as Br}from"./chunk-UKQRI6U4.js";import{a as ae,c as Kn}from"./chunk-UDMTFKLM.js";import{a as Rs,b as Dn,d as Ln,e as tr,f as Ee,g as Oe}from"./chunk-AW3LMT4V.js";import{a as nn}from"./chunk-ADDH3SWI.js";import{j as ln,k as Dr}from"./chunk-GJBALZEB.js";import{a as Ve,b as Yi,c as te}from"./chunk-XAHD7XBV.js";import{e as vn,f as Tn,g as On,i as Fr,j as wn}from"./chunk-DL3OPG77.js";import{a as Zi,d as gs,e as mn,j as fn}from"./chunk-RBP2Z7C6.js";import{a as E,b as bn,f as Ts,h as Os,j as ws,k as Xi,l as $t}from"./chunk-DOFADBK3.js";import{b as L}from"./chunk-KRY2TW2S.js";import{a as Vr,d as dn,f as ki,h as pn}from"./chunk-OW7DVBQB.js";import{c as qi,d as Nr}from"./chunk-ZCDCCVZZ.js";import{a as en}from"./chunk-LAXYP2KV.js";import{b as We,d as Te,e as Hi}from"./chunk-TIXZ4OWB.js";import{a as ee,b as Lt,d as Mr,e as Yo,f as Zo,g as Xo}from"./chunk-NDZXQR2V.js";import{a as m,b as tn}from"./chunk-UVJ5D37D.js";import{a as Xt,b as Jt,c as ze,i as Jo,k as Qo,m as $o,r as Ko,x as Nt}from"./chunk-ZAQLF7TN.js";import{d as rn,e as Pr}from"./chunk-ZHUHFKYD.js";import{a as Qt,c as zi}from"./chunk-SKXQUOOX.js";import{b as sn}from"./chunk-RKJVW4XE.js";import{p as ko}from"./chunk-I3DWOIS7.js";import{a as tl,c as rl,d as sl}from"./chunk-YRIBUHP4.js";import{a as xn}from"./chunk-32VQE3PR.js";import{a as vs}from"./chunk-NIYDRLW4.js";import{a as Ce}from"./chunk-XHOTVM3O.js";import{a as $e,b as gn,c as _s,d as _n,f as yn,g as ys}from"./chunk-H3VY6XFU.js";import{F as ke,b as hn,i as fs,l as Vt,p as cn,q as Lr,x as un}from"./chunk-SJTQM4NH.js";import{a as an,b as on}from"./chunk-L6VKPRBR.js";import{c as Go,d as Ho}from"./chunk-OJB2TSJ7.js";import{b as Bo,c as ji}from"./chunk-CJYUOBHK.js";import{j as Do,k as Lo,l as No}from"./chunk-TX7DVQYF.js";import{a as k,c as ms}from"./chunk-PDBA6QOJ.js";import{a as Wi}from"./chunk-CF52RSJZ.js";import{a as F,d as qe}from"./chunk-ALWV3RJ2.js";import{a as Ir}from"./chunk-7C6Z24SS.js";import{v as jo}from"./chunk-IISBSAYJ.js";import{e as Uo,j as Mt}from"./chunk-PRVSRJH5.js";import{a as Yt,b as Pt,c as vt,d as It,g as Dt,j as Bi,m as Wo,n as Gi,o as ne,q as Zt,v as zo,z as qo}from"./chunk-2ETHV3H2.js";import{a as cs,c as no,h as Ai}from"./chunk-4XUOIGFO.js";import{a as Rn}from"./chunk-HTWD7KCG.js";import{e as bo,g as ht}from"./chunk-AM3VOA32.js";import{a as pe,b as Vo,c as yt,d as Fo,e as Ui,f as kt}from"./chunk-M2GLXRA2.js";import{A as ds,C as Po,E as Io,a as ve,d as us,f as Qe,g as Se,h as Li,k as Ro,l as So,m as Co,n as Eo,y as Ao,z as Mo}from"./chunk-EBWCXIFH.js";import{f as po}from"./chunk-M76YZBV5.js";import{g as co,h as uo}from"./chunk-HXQMOXFX.js";import{a as lt,b as xo,r as Di}from"./chunk-BKKKVIAS.js";import{a as Er,b as Ar,d as Ni,e as Vi,k as ct,l as ps,m as Fi}from"./chunk-ZVHU7VE3.js";import{a as Oo,b as _t,d as At,i as wo}from"./chunk-76YVRX2R.js";import{B as nt,D as vo,E as Pi,G as To,I as Ii,a as Le,b as G,c as z,d as Y,e as $,l as q,n as ot,q as _o,s as Q,t as He,u as Ne,v as Mi,w as X,x as yo}from"./chunk-OZF6BMOL.js";import{a as R,b as Cr,c as Ge,d as mo,f as fo,i as go}from"./chunk-GJP6PTKT.js";import{a as hs}from"./chunk-GBTN5LIS.js";import{I as lo,aa as ho}from"./chunk-4JWMB5SM.js";import{F as ls,L as S,O as qt,h as ao,w as ns}from"./chunk-AUTL5LCV.js";import{S as Je,r as Be}from"./chunk-KUJG22IX.js";import{a as f}from"./chunk-W3WDPWBE.js";import{k as oo}from"./chunk-GISCFF3Z.js";import{b as os,c as gt,f as Et}from"./chunk-MLSR6YE6.js";import{a as de}from"./chunk-CPDJJRWA.js";import{r as ft}from"./chunk-HQMV3KQV.js";import{a as Re,m as Ei,o as io}from"./chunk-CRMMDK2Z.js";import{a as Sr,b as so,h as mt}from"./chunk-EAH6BNBL.js";var Ft;(function(t){t[t.ASYNC=0]="ASYNC",t[t.SYNC=1]="SYNC"})(Ft||(Ft={}));var lr,Gr,Ps;(function(t){t[t.RasterImage=0]="RasterImage",t[t.Features=1]="Features"})(lr||(lr={})),function(t){t[t.MapLayer=0]="MapLayer",t[t.ViewLayer=1]="ViewLayer",t[t.Outline=2]="Outline",t[t.SnappingHint=3]="SnappingHint"}(Gr||(Gr={})),function(t){t[t.WithRasterImage=0]="WithRasterImage",t[t.WithoutRasterImage=1]="WithoutRasterImage"}(Ps||(Ps={}));function Is(t){return t.type==="point"}var vl=class{constructor(e,r=null,s=0){this.array=e,this.spatialReference=r,this.offset=s}};function oa(t){return"array"in t}function Hr(t,e,r="ground"){if(Is(e))return t.getElevation(e.x,e.y,e.z||0,e.spatialReference,r);if(oa(e)){let s=e.offset;return t.getElevation(e.array[s++],e.array[s++],e.array[s]||0,e.spatialReference??t.spatialReference,r)}return t.getElevation(e[0],e[1],e[2]||0,t.spatialReference,r)}function Tl(t,e,r,s,i,a,o,n,h,l,c){let u=Ph[c.mode],d,p,g=0;if(Mt(t,e,r,s,h.spatialReference,i,n))return u.requiresAlignment(c)?(g=u.applyElevationAlignmentBuffer(s,i,a,o,n,h,l,c),d=a,p=o):(d=s,p=i),Mt(d,h.spatialReference,p,a,l.spatialReference,o,n)?g:void 0}function Ol(t,e,r,s,i){let a=(Is(t)?t.z:oa(t)?t.array[t.offset+2]:t[2])||0;switch(r.mode){case"on-the-ground":{let o=Hr(e,t,"ground")??0;return i.verticalDistanceToGround=0,i.sampledElevation=o,void(i.z=o)}case"relative-to-ground":{let o=Hr(e,t,"ground")??0,n=r.geometryZWithOffset(a,s);return i.verticalDistanceToGround=n,i.sampledElevation=o,void(i.z=n+o)}case"relative-to-scene":{let o=Hr(e,t,"scene")??0,n=r.geometryZWithOffset(a,s);return i.verticalDistanceToGround=n,i.sampledElevation=o,void(i.z=n+o)}case"absolute-height":{let o=r.geometryZWithOffset(a,s),n=Hr(e,t,"ground")??0;return i.verticalDistanceToGround=o-n,i.sampledElevation=n,void(i.z=o)}default:return void(i.z=0)}}function ou(t,e,r,s){return Ol(t,e,r,s,hr),hr.z}function nu(t,e,r){return e==="on-the-ground"&&r==="on-the-ground"?t.staysOnTheGround:e===r||e!=="on-the-ground"&&r!=="on-the-ground"?e==null||r==null?t.definedChanged:la.UPDATE:t.onTheGroundChanged}function lu(t){return t==="relative-to-ground"||t==="relative-to-scene"}function hu(t){return t!=="absolute-height"}function cu(t,e,r,s,i){Ol(e,r,i,s,hr),Rh(t,hr.verticalDistanceToGround);let a=hr.sampledElevation,o=ve(Ih,t.transformation);return Ds[0]=e.x,Ds[1]=e.y,Ds[2]=hr.z,sn(e.spatialReference,Ds,o,s.spatialReference)?t.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),a}function Rh(t,e){for(let r=0;r<t.geometries.length;++r){let s=t.geometries[r].getMutableAttribute(m.CENTEROFFSETANDDISTANCE);s&&s.data[3]!==e&&(s.data[3]=e,t.geometryVertexAttributeUpdated(t.geometries[r],m.CENTEROFFSETANDDISTANCE))}}function Sh(t,e,r,s,i,a){let o=0,n=a.spatialReference;e*=3,s*=3;for(let h=0;h<i;++h){let l=t[e],c=t[e+1],u=t[e+2],d=a.getElevation(l,c,u,n,"ground")??0;o+=d,r[s]=l,r[s+1]=c,r[s+2]=d,e+=3,s+=3}return o/i}function Ch(t,e,r,s,i,a,o,n){let h=0,l=n.calculateOffsetRenderUnits(o),c=n.featureExpressionInfoContext,u=a.spatialReference;e*=3,s*=3;for(let d=0;d<i;++d){let p=t[e],g=t[e+1],_=t[e+2],O=a.getElevation(p,g,_,u,"ground")??0;h+=O,r[s]=p,r[s+1]=g,r[s+2]=c==null?_+O+l:O+l,e+=3,s+=3}return h/i}function Eh(t,e,r,s,i,a,o,n){let h=0,l=n.calculateOffsetRenderUnits(o),c=n.featureExpressionInfoContext,u=a.spatialReference;e*=3,s*=3;for(let d=0;d<i;++d){let p=t[e],g=t[e+1],_=t[e+2],O=a.getElevation(p,g,_,u,"scene")??0;h+=O,r[s]=p,r[s+1]=g,r[s+2]=c==null?_+O+l:O+l,e+=3,s+=3}return h/i}function Ah(t){let e=t.meterUnitOffset,r=t.featureExpressionInfoContext;return e!==0||r!=null}function Mh(t,e,r,s,i,a,o,n){let h=n.calculateOffsetRenderUnits(o),l=n.featureExpressionInfoContext;e*=3,s*=3;for(let c=0;c<i;++c){let u=t[e],d=t[e+1],p=t[e+2];r[s]=u,r[s+1]=d,r[s+2]=l==null?p+h:h,e+=3,s+=3}return 0}var na=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}},la;(function(t){t[t.NONE=0]="NONE",t[t.UPDATE=1]="UPDATE",t[t.RECREATE=2]="RECREATE"})(la||(la={}));var Ph={"absolute-height":{applyElevationAlignmentBuffer:Mh,requiresAlignment:Ah},"on-the-ground":{applyElevationAlignmentBuffer:Sh,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:Ch,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:Eh,requiresAlignment:()=>!0}},Ih=F(),hr=new na,Ds=R();var Dh=()=>ft.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function wl(t){return{cachedResult:t.cachedResult,arcade:t.arcade?{func:t.arcade.func,context:t.arcade.modules.arcadeUtils.createExecContext(null,{sr:t.arcade.context.spatialReference}),modules:t.arcade.modules}:null}}function gu(t,e,r,s){return mt(this,null,function*(){let i=t?.expression;if(typeof i!="string")return null;let a=Lh(i);if(a!=null)return{cachedResult:a};let o=yield Rn();oo(r);let n=o.arcadeUtils,h=n.createSyntaxTree(i);return n.dependsOnView(h)?(s?.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:n.createFunction(h),context:n.createExecContext(null,{sr:e}),modules:o}}})}function xl(t,e,r){return t.arcadeUtils.createFeature(e.attributes,e.geometry,r)}function bl(t,e){if(t!=null&&!Sl(t)){if(!e||!t.arcade)return void Dh().errorOncePerTick("Arcade support required but not provided");let r=e;r._geometry&&(r._geometry=rl(r._geometry)),t.arcade.modules.arcadeUtils.updateExecContext(t.arcade.context,e)}}function Rl(t){if(t!=null){if(Sl(t))return t.cachedResult;let e=t.arcade,r=e?.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof r!="number"&&(t.cachedResult=0,r=0),r}return 0}function _u(t,e=!1){let r=t?.featureExpressionInfo,s=r?.expression;return e||s==="0"||(r=null),r??null}var yu={cachedResult:0};function Sl(t){return t.cachedResult!=null}function Lh(t){return t==="0"?0:null}var Cl=class t{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=on(e)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,r){let s=this.calculateOffsetRenderUnits(r);return this.featureExpressionInfoContext!=null?s:e+s}calculateOffsetRenderUnits(e){let r=this._meterUnitOffset,s=this.featureExpressionInfoContext;return s!=null&&(r+=Rl(s)*this._metersPerElevationInfoUnit),r/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=an(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,r,s){if(e==null)return void(this._featureExpressionInfoContext=null);let i=e?.arcade;i&&r!=null&&s!=null?(this._featureExpressionInfoContext=wl(e),bl(this._featureExpressionInfoContext,xl(i.modules,r,s))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){let r=new t;return e!=null&&r.setFromElevationInfo(e),r}};var El;(function(t){t[t.EnableFastUpdates=0]="EnableFastUpdates",t[t.DisableFastUpdates=1]="DisableFastUpdates",t[t.UpdateFastLocalOrigin=2]="UpdateFastLocalOrigin"})(El||(El={}));function Uu(t,e){if(t.type==="point")return Ot(t,e,!1);if(tl(t))switch(t.type){case"extent":return Ot(t.center,e,!1);case"polygon":return Ot(t.centroid,e,!1);case"polyline":return Ot(Al(t),e,!0);case"mesh":return Ot(t.origin,e,!1)}else switch(t.type){case"extent":return Ot(Nh(t),e,!0);case"polygon":return Ot(Vh(t),e,!0);case"polyline":return Ot(Al(t),e,!0)}}function Al(t){let e=t.paths[0];if(!e||e.length===0)return null;let r=uo(e,co(e)/2);return vs(r[0],r[1],r[2],t.spatialReference)}function Nh(t){return vs(.5*(t.xmax+t.xmin),.5*(t.ymax+t.ymin),t.zmin!=null&&t.zmax!=null&&isFinite(t.zmin)&&isFinite(t.zmax)?.5*(t.zmax+t.zmin):void 0,t.spatialReference)}function Vh(t){let e=t.rings[0];if(!e||e.length===0)return null;let r=po(t.rings,!!t.hasZ);return vs(r[0],r[1],r[2],t.spatialReference)}function Ot(t,e,r){let s=r?t:sl(t);return e&&t?jo(t,s,e)?s:null:s}function ju(t,e,r,s=0){if(t){e||(e=lt());let i=t,a=.5*i.width*(r-1),o=.5*i.height*(r-1);return i.width<1e-7*i.height?a+=o/20:i.height<1e-7*i.width&&(o+=a/20),Ar(e,i.xmin-a-s,i.ymin-o-s,i.xmax+a+s,i.ymax+o+s),e}return null}function Bu(t,e,r=null){let s=Vo(kt);return t!=null&&(s[0]=t[0],s[1]=t[1],s[2]=t[2]),e!=null?s[3]=e:t!=null&&t.length>3&&(s[3]=t[3]),r&&(s[0]*=r,s[1]*=r,s[2]*=r,s[3]*=r),s}function Gu(t=fo,e,r,s=1){let i=new Array(3);if(e==null||r==null)i[0]=1,i[1]=1,i[2]=1;else{let a,o=0;for(let n=2;n>=0;n--){let h=t[n],l,c=h!=null,u=n===0&&!a&&!c,d=r[n];h==="symbol-value"||u?l=d!==0?e[n]/d:1:c&&h!=="proportional"&&isFinite(h)&&(l=d!==0?h/d:1),l!=null&&(i[n]=l,a=l,o=Math.max(o,Math.abs(l)))}for(let n=2;n>=0;n--)i[n]==null?i[n]=a:i[n]===0&&(i[n]=.001*o)}for(let a=2;a>=0;a--)i[a]/=s;return mo(i)}function Fh(t){return t.isPrimitive!=null}function Hu(t){return Uh(Fh(t)?[t.width,t.depth,t.height]:t)?null:"Symbol sizes may not be negative values"}function Uh(t){let e=r=>r==null||r>=0;return Array.isArray(t)?t.every(e):e(t)}function Wu(t,e,r,s=F()){return t&&Co(s,s,-t/180*Math.PI),e&&Ro(s,s,e/180*Math.PI),r&&So(s,s,r/180*Math.PI),s}function zu(t,e,r){if(r.minDemResolution!=null)return r.minDemResolution;let s=ho(e),i=Do(t)*s,a=Lo(t)*s,o=No(t)*(e.isGeographic?1:s);return i===0&&a===0&&o===0?r.minDemResolutionForPoints:.01*Math.max(i,a,o)}var Ls=class extends xs{get geometries(){return this._geometries}get transformation(){return this._transformation??qe}set transformation(e){this._transformation=ve(this._transformation??F(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?ve(this._shaderTransformation??F(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(e={}){super(),this.type=Ye.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new Ns),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){ee(this._parentLayer==null||e==null,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._emit("geometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){let r=this._geometries.splice(e,1)[0];r&&(this._emit("geometryRemoved",{object:this,geometry:r}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,r,s=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:r,sync:s}),tn(r)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(let r of this._geometries)r.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){let e=new Ji(ki.MaskOccludee);for(let r of this._geometries)r.occludees=Qi(r.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(let r of this._geometries)r.occludees=$i(r.occludees,e);this._emit("occlusionChanged",this)}highlight(){let e=new Ji(ki.Highlight);for(let r of this._geometries)r.highlights=Qi(r.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(let r of this._geometries)r.highlights=$i(r.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,r){return Se(r,this.transformation,e.transformation)}getCombinedShaderTransformation(e,r=F()){return Se(r,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new Vs,this._validateBoundingVolume(this._bvWorldSpace,Wr.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new Vs,this._validateBoundingVolume(this._bvObjectSpace,Wr.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,r){let s=r===Wr.ObjectSpace;for(let i of this._geometries){let a=i.boundingInfo;a&&jh(a,e,s?i.transformation:this.getCombinedShaderTransformation(i))}Mi(e.bounds,e.min,e.max,.5);for(let i of this._geometries){let a=i.boundingInfo;if(a==null)continue;let o=s?i.transformation:this.getCombinedShaderTransformation(i),n=fs(o);X(Ml,a.center,o);let h=ot(Ml,e.bounds),l=a.radius*n;e.bounds[3]=Math.max(e.bounds[3],h+l)}}_invalidateBoundingVolume(){let e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,r){this._parentLayer&&this._parentLayer.events.emit(e,r)}get test(){}},Ns=class{constructor(){this.min=Ge(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=Ge(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}},Vs=class extends Ns{constructor(){super(...arguments),this.bounds=ys()}};function jh(t,e,r){let s=t.bbMin,i=t.bbMax;if(Io(r)){let a=z(Bh,r[12],r[13],r[14]);Y(Ae,s,a),Y(Ze,i,a);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],Ae[o]),e.max[o]=Math.max(e.max[o],Ze[o])}else if(X(Ae,s,r),nt(s,i))for(let a=0;a<3;++a)e.min[a]=Math.min(e.min[a],Ae[a]),e.max[a]=Math.max(e.max[a],Ae[a]);else{X(Ze,i,r);for(let a=0;a<3;++a)e.min[a]=Math.min(e.min[a],Ae[a],Ze[a]),e.max[a]=Math.max(e.max[a],Ae[a],Ze[a]);for(let a=0;a<3;++a){G(Ae,s),G(Ze,i),Ae[a]=i[a],Ze[a]=s[a],X(Ae,Ae,r),X(Ze,Ze,r);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],Ae[o],Ze[o]),e.max[o]=Math.max(e.max[o],Ae[o],Ze[o])}}}var Bh=R(),Ae=R(),Ze=R(),Ml=R(),Wr;(function(t){t[t.WorldSpace=0]="WorldSpace",t[t.ObjectSpace=1]="ObjectSpace"})(Wr||(Wr={}));var Il=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];var Fs=class extends xs{get objects(){return this._objects}constructor(e,r,s=""){super(),this.stage=e,this.apiLayerUid=s,this.type=Ye.Layer,this.events=new hs,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new de,this._objectsAdded=new de,this._handles=new ao,this.apiLayerUid=s,this.visible=r?.visible??!0,this.pickable=r?.pickable??!0,this.updatePolicy=r?.updatePolicy??Ft.ASYNC,this._disableOctree=r?.disableOctree??!1,e.add(this);for(let i of Il)this._handles.add(this.events.on(i,a=>e.handleEvent(i,a)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),this._octree!=null&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(let r of e)r.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),this._octree!=null&&this._objectsAdded.pushArray(e)}removeMany(e){let r=new Array;if(this._objects.removeUnorderedMany(e,e.length,r),r.length!==0){for(let s of r)s.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:r}),this._octree!=null){for(let s=0;s<r.length;)this._objectsAdded.removeUnordered(r[s])?(r[s]=r[r.length-1],r.length-=1):++s;this._octree.remove(r)}}}sync(){this.updatePolicy!==Ft.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,r){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,r)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.length>50&&!this._disableOctree?(this._octree=new wn(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=os(this._octree),this._objectsAdded.clear()}};function Dl(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/e)}function Ll(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/r)}function Nl(t,e,r){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}function Vl(t,e,r){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}var Us=class{constructor(){this.adds=new de,this.removes=new de,this.updates=new de({allocator:e=>e||new ha,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},ha=class{},js=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var Fl,B;function Ul(t){let e=new Map,r=s=>{let i=e.get(s);return i||(i=new js,e.set(s,i)),i};return t.removes.forAll(s=>{ca(s)&&r(s.material).removes.push(s)}),t.adds.forAll(s=>{ca(s)&&r(s.material).adds.push(s)}),t.updates.forAll(s=>{ca(s.renderGeometry)&&r(s.renderGeometry.material).updates.push(s)}),e}function ca(t){return t.geometry.indexCount>=1}(function(t){t[t.Default=0]="Default",t[t.Screenshot=1]="Screenshot",t[t.ObjectAndLayerID=2]="ObjectAndLayerID"})(Fl||(Fl={})),function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(B||(B={}));var pa,I=pa=class extends qt{constructor(t){super(t),this._ray=$e(),this._viewport=yt(0,0,1,1),this._padding=yt(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=ms(1,1e3),this._viewDirty=!0,this._viewMatrix=F(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=F(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=F(),this._frustumDirty=!0,this._frustum=vn(),this._fullViewport=pe(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=R(),this._up=R(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get rows(){return this._rows}set rows(t){this._rows=Math.max(1,t)}get columns(){return this._columns}set columns(t){this._columns=Math.max(1,t)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return $(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){ve(this._viewMatrix,t),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),z(R(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),z(R(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),z(R(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;let t=Ni(pe(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&Fi(t,e)?e:t}get screenPadding(){if(this.pixelRatio===1)return this._padding;let t=Ni(pe(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&Fi(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[B.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[B.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[B.RIGHT]+this._padding[B.LEFT]}set fullWidth(t){this.width=t-(this._padding[B.RIGHT]+this._padding[B.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[B.TOP]+this._padding[B.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[B.TOP]+this._padding[B.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[B.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[B.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){ps(this._padding,t)||(this._viewport[0]+=t[B.LEFT]-this._padding[B.LEFT],this._viewport[1]+=t[B.BOTTOM]-this._padding[B.BOTTOM],this._viewport[2]-=t[B.RIGHT]+t[B.LEFT]-(this._padding[B.RIGHT]+this._padding[B.LEFT]),this._viewport[3]-=t[B.TOP]+t[B.BOTTOM]-(this._padding[B.TOP]+this._padding[B.BOTTOM]),Er(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Se(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return Qe(F(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||F()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Nl(this._fov,this.width,this.height)}set fovX(t){this._fov=Dl(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Vl(this._fov,this.width,this.height)}set fovY(t){this._fov=Ll(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return ot(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Qe(this._viewInverseTransposeMatrix,this.viewMatrix),us(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){let e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){let t=this.width,e=this.height,r=this.near*Math.tan(this.fovY/2)*2,s=r*this._aspect,i=r/this.rows,a=s/this.columns,o=-s/2+this.column*a,n=o+a,h=-r/2+this.row*i,l=h+i,c=Ao(F(),o*(1+2*this._padding[B.LEFT]/t),n*(1+2*this._padding[B.RIGHT]/t),h*(1+2*this._padding[B.BOTTOM]/e),l*(1+2*this._padding[B.TOP]/e),this.near,this.far),u=this._get("projectionMatrix");return u&&Po(u,c)?u:c}copyFrom(t){G(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,Er(this._viewport,t.viewport),this.notifyChange("_viewport"),Er(this._padding,t.padding),this.notifyChange("_padding"),Yt(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.row=t.row,this.column=t.column,this.rows=t.rows,this.columns=t.columns,this.relativeElevation=t.relativeElevation;let e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(ve(this._viewMatrix,t.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(Tn(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(ve(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Er(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return new pa().copyFrom(this)}equals(t){return nt(this.eye,t.eye)&&nt(this.center,t.center)&&nt(this.up,t.up)&&ps(this._viewport,t.viewport)&&ps(this._padding,t.padding)&&zo(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation&&this.row===t.row&&this.column===t.column&&this.rows===t.rows&&this.columns===t.columns}almostEquals(t){let e=Math.max(1,1/this.pixelRatio,1/t.pixelRatio);if(Math.abs(t.fov-this._fov)>=.001||Vi(t.screenPadding,this.screenPadding)>=e||Vi(this.screenViewport,t.screenViewport)>=e||this.row!==t.row||this.column!==t.column||this.rows!==t.rows||this.columns!==t.columns)return!1;Pi(he,t.eye,t.center),Pi(ua,this.eye,this.center);let r=He(he,ua),s=Ii(he),i=Ii(ua),a=5e-4;return r*r>=(1-1e-10)*s*i&&To(t.eye,this.eye)<Math.max(s,i)*a*a}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(hn(this.viewForward,$(he,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=bo()){return t[0]=(this.padding[B.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[B.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,r=.5){return t[0]=this.padding[B.LEFT]+this.width*e,t[1]=this.padding[B.BOTTOM]+this.height*r,t[2]=.5,t}setGLViewport(t){let e=this.viewport,r=this.padding;t.setViewport(e[0]-r[3],e[1]-r[2],e[2]+r[1]+r[3],e[3]+r[0]+r[2])}applyProjection(t,e){t!==N&&G(N,t),N[3]=1,ct(N,N,this.projectionMatrix);let r=Math.abs(N[3]);q(N,N,1/r);let s=this.fullViewport;e[0]=At(0,s[0]+s[2],.5+.5*N[0]),e[1]=At(0,s[1]+s[3],.5+.5*N[1]),e[2]=.5*(N[2]+1),e[3]=r}unapplyProjection(t,e){let r=this.fullViewport;N[0]=(t[0]/(r[0]+r[2])*2-1)*t[3],N[1]=(t[1]/(r[1]+r[3])*2-1)*t[3],N[2]=(2*t[2]-1)*t[3],N[3]=t[3],this.inverseProjectionMatrix!=null&&(ct(N,N,this.inverseProjectionMatrix),e[0]=N[0],e[1]=N[1],e[2]=N[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,da),this.renderToScreen(da,e),e}projectToRenderScreen(t,e){if(N[0]=t[0],N[1]=t[1],N[2]=t[2],N[3]=1,ct(N,N,this.viewProjectionMatrix),N[3]===0)return null;let r=N;q(r,r,1/Math.abs(N[3]));let s=this.fullViewport,i=At(0,s[0]+s[2],.5+.5*r[0]),a=At(0,s[1]+s[3],.5+.5*r[1]);return"x"in e?(e.x=i,e.y=a):(e[0]=i,e[1]=a,e.length>2&&(e[2]=.5*(r[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,da),e)}unprojectFromRenderScreen(t,e){if(Se(Bs,this.projectionMatrix,this.viewMatrix),!Qe(Bs,Bs))return null;let r=this.fullViewport;return N[0]=2*(t[0]-r[0])/r[2]-1,N[1]=2*(t[1]-r[1])/r[3]-1,N[2]=2*t[2]-1,N[3]=1,ct(N,N,Bs),N[3]===0?null:(e[0]=N[0]/N[3],e[1]=N[1]/N[3],e[2]=N[2]/N[3],e)}constrainWindowSize(t,e,r,s){let i=t*this.pixelRatio,a=e*this.pixelRatio,o=Math.max(i-r/2,0),n=Math.max(this.fullHeight-a-s/2,0),h=-Math.min(i-r/2,0),l=-Math.min(this.fullHeight-a-s/2,0),c=r-h- -Math.min(this.fullWidth-i-r/2,0),u=s-l- -Math.min(a-s/2,0);return[Math.round(o),Math.round(n),Math.round(c),Math.round(u)]}computeUp(t){t===Ce.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){let r=t[0]*this.pixelRatio,s=this.fullHeight-t[1]*this.pixelRatio;return e[0]=r,e[1]=s,e}renderToScreen(t,e){let r=t[0]/this.pixelRatio,s=(this.fullHeight-t[1])/this.pixelRatio;e[0]=r,e[1]=s}_computeUpGlobal(){$(he,this.center,this.eye);let t=Le(this.center);t<1?(z(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(He(he,this.center))>.9999*Le(he)*t||(Ne(this._up,he,this.center),Ne(this._up,this._up,he),Q(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){vo(he,this.eye,this.center),Math.abs(he[2])<=.9999&&(q(he,he,he[2]),z(this._up,-he[0],-he[1],1-he[2]),Q(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,r=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?nt(t,e)||(G(e,t),this._markViewDirty(),r.length&&this.notifyChange(r)):ft.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(On(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(ds(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};f([S()],I.prototype,"_viewport",void 0),f([S()],I.prototype,"_padding",void 0),f([S()],I.prototype,"_fov",void 0),f([S()],I.prototype,"_nearFar",void 0),f([S()],I.prototype,"_viewDirty",void 0),f([S()],I.prototype,"_viewMatrix",void 0),f([S()],I.prototype,"_pixelRatio",void 0),f([S()],I.prototype,"pixelRatio",null),f([S()],I.prototype,"row",void 0),f([S()],I.prototype,"column",void 0),f([S()],I.prototype,"_rows",void 0),f([S()],I.prototype,"rows",null),f([S()],I.prototype,"_columns",void 0),f([S()],I.prototype,"columns",null),f([S()],I.prototype,"eye",null),f([S()],I.prototype,"center",null),f([S()],I.prototype,"_center",void 0),f([S()],I.prototype,"up",null),f([S()],I.prototype,"_up",void 0),f([S()],I.prototype,"viewMatrix",null),f([S({readOnly:!0})],I.prototype,"viewForward",null),f([S({readOnly:!0})],I.prototype,"viewUp",null),f([S({readOnly:!0})],I.prototype,"viewRight",null),f([S({readOnly:!0})],I.prototype,"nearFar",null),f([S()],I.prototype,"near",null),f([S()],I.prototype,"far",null),f([S()],I.prototype,"viewport",null),f([S({readOnly:!0})],I.prototype,"screenViewport",null),f([S({readOnly:!0})],I.prototype,"screenPadding",null),f([S()],I.prototype,"x",null),f([S()],I.prototype,"y",null),f([S()],I.prototype,"width",null),f([S()],I.prototype,"height",null),f([S()],I.prototype,"fullWidth",null),f([S()],I.prototype,"fullHeight",null),f([S({readOnly:!0})],I.prototype,"_aspect",null),f([S()],I.prototype,"padding",null),f([S({readOnly:!0})],I.prototype,"projectionMatrix",null),f([S({readOnly:!0})],I.prototype,"inverseProjectionMatrix",null),f([S()],I.prototype,"fov",null),f([S()],I.prototype,"fovX",null),f([S()],I.prototype,"fovY",null),f([S()],I.prototype,"viewInverseTransposeMatrix",null),f([S({readOnly:!0})],I.prototype,"_projectionMatrixInternal",null),f([S()],I.prototype,"relativeElevation",void 0),I=pa=f([Je("esri.views.3d.webgl.RenderCamera")],I);var wt=I,N=pe(),Bs=F(),he=R(),ua=R(),da=ht();var ma=new Map([[m.POSITION,0],[m.PREVPOSITION,1],[m.NEXTPOSITION,2],[m.SUBDIVISIONFACTOR,3],[m.UV0,4],[m.COLOR,5],[m.COLORFEATUREATTRIBUTE,5],[m.SIZE,6],[m.SIZEFEATUREATTRIBUTE,6],[m.OPACITYFEATUREATTRIBUTE,7],[m.OBJECTANDLAYERIDCOLOR,8]]),zr=class t extends et{initializeProgram(e){return new tt(e.rctx,t.shader.get().build(this.configuration),ma)}_makePipelineState(e,r){let s=this.configuration,i=e===ae.NONE,a=e===ae.FrontFace,o=bn(s.output);return Oe({blending:s.output===E.Color?i?rr:sr(e):null,depthTest:{func:Ss(e)},depthWrite:i?s.writeDepth||o?tr:null:Nn(e),drawBuffers:s.output===E.Depth?{buffers:[Nt.NONE]}:ir(e),colorWrite:Ee,stencilWrite:s.hasOccludees?Ur:null,stencilTest:s.hasOccludees?r?jr:Cs:null,polygonOffset:i||a?s.hasPolygonOffset?jl:null:Fn})}initializePipeline(){let e=this.configuration;if(e.occluder){let r=e.hasPolygonOffset?jl:null;this._occluderPipelineTransparent=Oe({blending:rr,polygonOffset:r,depthTest:ia,depthWrite:null,colorWrite:Ee,stencilWrite:null,stencilTest:Xn,drawBuffers:e.output===E.Depth?{buffers:[Nt.NONE]}:null}),this._occluderPipelineOpaque=Oe({blending:rr,polygonOffset:r,depthTest:ia,depthWrite:null,colorWrite:Ee,stencilWrite:Yn,stencilTest:Zn,drawBuffers:e.output===E.Depth?{buffers:[Nt.NONE]}:null}),this._occluderPipelineMaskWrite=Oe({blending:null,polygonOffset:r,depthTest:kn,depthWrite:null,colorWrite:null,stencilWrite:Ur,stencilTest:jr,drawBuffers:e.output===E.Depth?{buffers:[Nt.NONE]}:null})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Jt.LINES:Jt.TRIANGLE_STRIP}getPipeline(e,r,s){return e?this._occludeePipelineState:this.configuration.occluder?s?this._occluderPipelineTransparent:r?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}};zr.shader=new Ke(ul,()=>import("./chunk-G4O6DRN3.js"));var jl={factor:0,units:-4};var we;(function(t){t[t.LEFT_JOIN_START=-2]="LEFT_JOIN_START",t[t.LEFT_JOIN_END=-1]="LEFT_JOIN_END",t[t.LEFT_CAP_START=-4]="LEFT_CAP_START",t[t.LEFT_CAP_END=-5]="LEFT_CAP_END",t[t.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",t[t.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",t[t.RIGHT_CAP_START=4]="RIGHT_CAP_START",t[t.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(we||(we={}));var Gs=class extends er{constructor(e){super(e,new Oa),this._configuration=new hl,this.produces=new Map([[j.OPAQUE_MATERIAL,r=>r===E.Highlight||r===E.ObjectAndLayerIdColor||r===E.Color&&this.parameters.renderOccluded===le.OccludeAndTransparentStencil],[j.OPAQUE_NO_SSAO_DEPTH,r=>$t(r)],[j.OCCLUDER_MATERIAL,r=>Xi(r)&&this.parameters.renderOccluded===le.OccludeAndTransparentStencil],[j.TRANSPARENT_OCCLUDER_MATERIAL,r=>Xi(r)&&this.parameters.renderOccluded===le.OccludeAndTransparentStencil],[j.TRANSPARENT_MATERIAL,r=>r===E.Color&&this.parameters.writeDepth&&this.parameters.renderOccluded!==le.OccludeAndTransparentStencil],[j.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,r=>r===E.Color&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==le.OccludeAndTransparentStencil],[j.DRAPED_MATERIAL,r=>Ts(r)]]),this._vertexAttributeLocations=ma}getConfiguration(e,r){this._configuration.output=e,this._configuration.draped=r.slot===j.DRAPED_MATERIAL;let s=this.parameters.stipplePattern!=null&&e!==E.Highlight;return this._configuration.stippleEnabled=s,this._configuration.stippleOffColorEnabled=s&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=s&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&Gh(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===le.OccludeAndTransparentStencil,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.multipassEnabled=r.multipassEnabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,r,s,i,a,o){if(!s.options.selectionMode)return;let n=e.attributes.get(m.POSITION).data,h=e.attributes.get(m.SIZE),l=this.parameters.width;if(this.parameters.vvSize){let _=e.attributes.get(m.SIZEFEATUREATTRIBUTE).data[0];l*=_t(this.parameters.vvSize.offset[0]+_*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else h&&(l*=h.data[0]);let c=i[0],u=i[1],d=(l/2+4)*e.screenToWorldRatio,p=Number.MAX_VALUE,g=0;for(let _=0;_<n.length-5;_+=3){let O=n[_],v=n[_+1],w=c-O,y=u-v,C=n[_+3]-O,x=n[_+4]-v,M=_t((C*w+x*y)/(C*C+x*x),0,1),T=C*M-w,W=x*M-y,H=T*T+W*W;H<p&&(p=H,g=_/3)}p<d*d&&a(o.dist,o.normal,g,!1)}intersect(e,r,s,i,a,o){if(!s.options.selectionMode||!e.visible)return;if(!Xo(r))return void ft.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");let n=e.attributes,h=n.get(m.POSITION).data,l=this.parameters.width;if(this.parameters.vvSize){let w=n.get(m.SIZEFEATUREATTRIBUTE).data[0];l*=_t(this.parameters.vvSize.offset[0]+w*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else n.has(m.SIZE)&&(l*=n.get(m.SIZE).data[0]);let c=s.camera,u=Hh;Yt(u,s.point);let d=l*c.pixelRatio/2+4*c.pixelRatio;z(qr[0],u[0]-d,u[1]+d,0),z(qr[1],u[0]+d,u[1]+d,0),z(qr[2],u[0]+d,u[1]-d,0),z(qr[3],u[0]-d,u[1]-d,0);for(let w=0;w<4;w++)if(!c.unprojectFromRenderScreen(qr[w],ut[w]))return;Lr(c.eye,ut[0],ut[1],ga),Lr(c.eye,ut[1],ut[2],_a),Lr(c.eye,ut[2],ut[3],ya),Lr(c.eye,ut[3],ut[0],va);let p=Number.MAX_VALUE,g=0,_=Wl(this.parameters,n)?h.length-2:h.length-5;for(let w=0;w<_;w+=3){ge[0]=h[w]+r[12],ge[1]=h[w+1]+r[13],ge[2]=h[w+2]+r[14];let y=(w+3)%h.length;if(_e[0]=h[y]+r[12],_e[1]=h[y+1]+r[13],_e[2]=h[y+2]+r[14],ke(ga,ge)<0&&ke(ga,_e)<0||ke(_a,ge)<0&&ke(_a,_e)<0||ke(ya,ge)<0&&ke(ya,_e)<0||ke(va,ge)<0&&ke(va,_e)<0)continue;if(c.projectToRenderScreen(ge,jt),c.projectToRenderScreen(_e,Bt),jt[2]<0&&Bt[2]>0){$(rt,ge,_e);let x=c.frustum,M=-ke(x[Fr.NEAR],ge)/He(rt,x[Fr.NEAR]);q(rt,rt,M),Y(ge,ge,rt),c.projectToRenderScreen(ge,jt)}else if(jt[2]>0&&Bt[2]<0){$(rt,_e,ge);let x=c.frustum,M=-ke(x[Fr.NEAR],_e)/He(rt,x[Fr.NEAR]);q(rt,rt,M),Y(_e,_e,rt),c.projectToRenderScreen(_e,Bt)}else if(jt[2]<0&&Bt[2]<0)continue;jt[2]=0,Bt[2]=0;let C=mn(gs(jt,Bt,Hl),u);C<p&&(p=C,G(Bl,ge),G(Gl,_e),g=w/3)}let O=s.rayBegin,v=s.rayEnd;if(p<d*d){let w=Number.MAX_VALUE;if(fn(gs(Bl,Gl,Hl),gs(O,v,Wh),Ut)){$(Ut,Ut,O);let y=Le(Ut);q(Ut,Ut,1/y),w=y/ot(O,v)}o(w,Ut,g,!1)}}get _layout(){let e=We().vec3f(m.POSITION).vec3f(m.PREVPOSITION).vec3f(m.NEXTPOSITION).f32(m.SUBDIVISIONFACTOR).vec2f(m.UV0);return this.parameters.vvSize?e.f32(m.SIZEFEATUREATTRIBUTE):e.f32(m.SIZE),this.parameters.vvColor?e.f32(m.COLORFEATUREATTRIBUTE):e.vec4f(m.COLOR),this.parameters.vvOpacity&&e.f32(m.OPACITYFEATUREATTRIBUTE),Re("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(m.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new wa(this._layout,this.parameters)}createGLMaterial(e){return new Ta(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}},Ta=class extends bs{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===E.Color&&this._updateOccludeeState(e);let r=this._material.parameters.stipplePattern;return this._stipplePattern!==r&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(r,this._stipplePattern)}),this._stipplePattern=r),this.ensureTechnique(zr,e)}},Oa=class extends Br{constructor(){super(...arguments),this.width=0,this.color=kt,this.join="miter",this.cap=ll.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}},wa=class{constructor(e,r){this.vertexBufferLayout=e,this._parameters=r,this.numJoinSubdivisions=0;let s=r.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=s;break;case"round":this.numJoinSubdivisions=cl+s}}_isClosed(e){return Wl(this._parameters,e.attributes)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){let s=e.attributes.get(m.POSITION).indices.length/2+1,i=this._isClosed(e),a=i?2:2*2;return a+=((i?s:s-1)-(i?0:1))*(2*this.numJoinSubdivisions+4),a+=2,this._parameters.wireframe&&(a=2+4*(a-2)),a}write(e,r,s,i,a){let o=zh,n=qh,h=kh,l=s.attributes.get(m.POSITION),c=l.indices,u=l.data.length/3,d=s.attributes.get(m.DISTANCETOSTART)?.data;c&&c.length!==2*(u-1)&&console.warn("RibbonLineMaterial does not support indices");let p=s.attributes.get(m.SIZEFEATUREATTRIBUTE)?.data[0]??s.attributes.get(m.SIZE)?.data[0]??1,g=[1,1,1,1],_=0,O=this.vertexBufferLayout.fields.has(m.COLORFEATUREATTRIBUTE);O?_=s.attributes.get(m.COLORFEATUREATTRIBUTE).data[0]:s.attributes.has(m.COLOR)&&(g=s.attributes.get(m.COLOR).data);let v=Re("enable-feature:objectAndLayerId-rendering")?s.objectAndLayerIdColor:null,w=this.vertexBufferLayout.fields.has(m.OPACITYFEATUREATTRIBUTE),y=w?s.attributes.get(m.OPACITYFEATUREATTRIBUTE).data[0]:0,C=new Float32Array(i.buffer),x=Re("enable-feature:objectAndLayerId-rendering")?new Uint8Array(i.buffer):null,M=this.vertexBufferLayout.stride/4,T=a*M,W=T,H=0,A=d?(J,De,P)=>H=d[P]:(J,De,P)=>H+=ot(J,De),ie=Re("enable-feature:objectAndLayerId-rendering"),U=(J,De,P,pt,be,br,Rr)=>{if(C[T++]=De[0],C[T++]=De[1],C[T++]=De[2],C[T++]=J[0],C[T++]=J[1],C[T++]=J[2],C[T++]=P[0],C[T++]=P[1],C[T++]=P[2],C[T++]=pt,C[T++]=Rr,C[T++]=be,C[T++]=p,O)C[T++]=_;else{let zt=Math.min(4*br,g.length-4);C[T++]=g[zt],C[T++]=g[zt+1],C[T++]=g[zt+2],C[T++]=g[zt+3]}w&&(C[T++]=y),ie&&(v!=null&&(x[4*T]=v[0],x[4*T+1]=v[1],x[4*T+2]=v[2],x[4*T+3]=v[3]),T++)};T+=M,z(n,l.data[0],l.data[1],l.data[2]),e&&X(n,n,e);let it=this._isClosed(s);if(it){let J=l.data.length-3;z(o,l.data[J],l.data[J+1],l.data[J+2]),e&&X(o,o,e)}else z(h,l.data[3],l.data[4],l.data[5]),e&&X(h,h,e),U(n,n,h,1,we.LEFT_CAP_START,0,0),U(n,n,h,1,we.RIGHT_CAP_START,0,0),G(o,n),G(n,h);let xr=it?0:1,at=it?u:u-1;for(let J=xr;J<at;J++){let De=(J+1)%u*3;z(h,l.data[De],l.data[De+1],l.data[De+2]),e&&X(h,h,e),A(o,n,J),U(o,n,h,0,we.LEFT_JOIN_END,J,H),U(o,n,h,0,we.RIGHT_JOIN_END,J,H);let P=this.numJoinSubdivisions;for(let pt=0;pt<P;++pt){let be=(pt+1)/(P+1);U(o,n,h,be,we.LEFT_JOIN_END,J,H),U(o,n,h,be,we.RIGHT_JOIN_END,J,H)}U(o,n,h,1,we.LEFT_JOIN_START,J,H),U(o,n,h,1,we.RIGHT_JOIN_START,J,H),G(o,n),G(n,h)}it?(z(h,l.data[3],l.data[4],l.data[5]),e&&X(h,h,e),H=A(o,n,at),U(o,n,h,0,we.LEFT_JOIN_END,xr,H),U(o,n,h,0,we.RIGHT_JOIN_END,xr,H)):(H=A(o,n,at),U(o,n,n,0,we.LEFT_CAP_END,at,H),U(o,n,n,0,we.RIGHT_CAP_END,at,H)),fa(C,W+M,C,W,M),T=fa(C,T-M,C,T,M),this._parameters.wireframe&&this._addWireframeVertices(i,W,T,M)}_addWireframeVertices(e,r,s,i){let a=new Float32Array(e.buffer,s*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT,s-r),n=0,h=l=>n=fa(o,l,a,n,i);for(let l=0;l<o.length-1;l+=2*i)h(l),h(l+2*i),h(l+1*i),h(l+2*i),h(l+1*i),h(l+3*i)}};function fa(t,e,r,s,i){for(let a=0;a<i;a++)r[s++]=t[e++];return s}function Wl(t,e){return t.isClosed?e.get(m.POSITION).indices.length>2:!1}function Gh(t){return t.anchor===nl.Tip&&t.hideOnShortSegments&&t.placement==="begin-end"&&t.worldSpace}var ge=R(),_e=R(),rt=R(),Ut=R(),Hh=R(),jt=ht(),Bt=ht(),Bl=R(),Gl=R(),Hl=Zi(),Wh=Zi(),zh=R(),qh=R(),kh=R(),qr=[ht(),ht(),ht(),ht()],ut=[R(),R(),R(),R()],ga=Vt(),_a=Vt(),ya=Vt(),va=Vt();var xa=class{constructor(e,r){this.vec3=e,this.id=r}};function cr(t,e,r,s){return new xa(Ge(t,e,r),s)}var Dp={stableRendering:!1},zl={rootOrigin:null};var Hs=class{constructor(e){this._originSR=e,this._rootOriginId="root/"+ls(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){let r=this._origins.get(this._rootOriginId);if(r==null){let c=zl.rootOrigin;if(c!=null)return this._origins.set(this._rootOriginId,cr(c[0],c[1],c[2],this._rootOriginId)),this.getOrigin(e);let u=cr(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,u),u}let s=this._gridSize,i=Math.round(e[0]/s),a=Math.round(e[1]/s),o=Math.round(e[2]/s),n=`${i}/${a}/${o}`,h=this._origins.get(n),l=.5*s;if($(oe,e,r.vec3),oe[0]=Math.abs(oe[0]),oe[1]=Math.abs(oe[1]),oe[2]=Math.abs(oe[2]),oe[0]<l&&oe[1]<l&&oe[2]<l){if(h){let c=Math.max(...oe);if($(oe,e,h.vec3),oe[0]=Math.abs(oe[0]),oe[1]=Math.abs(oe[1]),oe[2]=Math.abs(oe[2]),Math.max(...oe)<c)return h}return r}return h||(h=cr(i*s,a*s,o*s,n),this._origins.set(n,h)),h}_drawOriginBox(e,r=yt(1,1,0,1)){let s=window.view,i=s._stage,a=r.toString();if(!this._objects.has(a)){this._material=new Gs({width:2,color:r}),i.add(this._material);let p=new Fs(i,{pickable:!1}),g=new Ls({castShadow:!1});i.add(g),p.add(g),this._objects.set(a,g)}let o=this._objects.get(a),n=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],h=n.length,l=new Array(3*h),c=new Array,u=.5*this._gridSize;for(let p=0;p<h;p++)l[3*p]=e[0]+(1&n[p]?u:-u),l[3*p+1]=e[1]+(2&n[p]?u:-u),l[3*p+2]=e[2]+(4&n[p]?u:-u),p>0&&c.push(p-1,p);Mt(l,this._originSR,0,l,s.renderSpatialReference,0,h);let d=new me(this._material,[[m.POSITION,new L(l,c,3,!0)]],null,Ye.Line);i.add(d),o.addGeometry(d)}get test(){}},oe=R();var kr=class{constructor(){this._extent=lt(),this.resolution=0,this.renderLocalOrigin=cr(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new ba}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();let r=.001*e.range;if(this._extent[0]-r<=e.min){let s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Di(this._extent,e.range,0,s)}if(this._extent[2]+r>=e.max){let s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Di(this._extent,-e.range,0,s)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,xo(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){let r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},ba=class{constructor(){this.extents=[lt(),lt(),lt()],this.numViews=0}};var se;(function(t){t[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.WaterNormal=3]="WaterNormal",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"})(se||(se={}));var Ws=class{constructor(e,r,s){this._fbos=e,this._format=r,this._name=s}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=Et(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,r,s){this._handle&&this._handle.fbo?.width===r&&this._handle.fbo?.height===s||(this._handle?.release(),this._handle=this._fbos.acquire(r,s,this._name,this._format)),e.unbindTexture(this._handle?.fbo?.colorTexture),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}};var xt=class{constructor(e,r,s,i,a=or.RGBA_MIPMAP){this.output=s,this.content=i,this.fbo=new Ws(e,a,r)}get valid(){return this.fbo.valid}},zs=class{constructor(e){this.targets=[new xt(e,"overlay color",E.Color,se.Color),new xt(e,"overlay IM color",E.Color,se.ColorNoRasterImage),new xt(e,"overlay highlight",E.Highlight,se.Highlight,or.RGBA4),new xt(e,"overlay water",E.Normal,se.WaterNormal),new xt(e,"overlay occluded",E.Color,se.Occluded)],Re("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new xt(e,"overlay oid",E.ObjectAndLayerIdColor,se.ObjectAndLayerIdColor))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(let e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce((e,r,s)=>r.valid?e|=1<<s:e,0)}};var Ra;(function(t){t[t.Material=0]="Material",t[t.ShadowMap=1]="ShadowMap",t[t.Highlight=2]="Highlight",t[t.ViewshedShadowMap=3]="ViewshedShadowMap"})(Ra||(Ra={}));var Gt;(function(t){t[t.Disabled=0]="Disabled",t[t.Enabled=1]="Enabled",t[t.EnabledWithWater=2]="EnabledWithWater",t[t.COUNT=3]="COUNT"})(Gt||(Gt={}));var Bm=pe();var qs=class{constructor(e){this._context=e,this._perConstructorInstances=new Kt,this._frameCounter=0,this._keepAliveFrameCount=ql}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach(e=>e.forEach(r=>r.technique.destroy())),this._perConstructorInstances.clear()}acquire(e,r=Yh){let s=r.key,i=this._perConstructorInstances.get(e,s);if(i==null){let a=new e(this._context,r,()=>this.release(a));i=new Sa(a),this._perConstructorInstances.set(e,s,i)}return++i.refCount,i.technique}releaseAndAcquire(e,r,s){if(s!=null){if(r.key===s.key)return s;this.release(s)}return this.acquire(e,r)}release(e){if(e==null||this._perConstructorInstances.empty)return;let r=this._perConstructorInstances.get(e.constructor,e.key);r!=null&&(--r.refCount,r.refCount===0&&(r.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==ql&&this._perConstructorInstances.forEach((e,r)=>{e.forEach((s,i)=>{s.refCount===0&&s.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(s.technique.destroy(),this._perConstructorInstances.delete(r,i))})})}reloadAll(){return mt(this,null,function*(){let e=new Array;this._perConstructorInstances.forEach((r,s)=>{let i=(a,o)=>mt(this,null,function*(){let n=o.shader;n&&(yield n.reload(),a.forEach(h=>h.technique.reload(this._context)))});e.push(i(r,s))}),yield Promise.all(e)})}},Sa=class{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}},ql=-1,Yh=new Es;var Zh={required:[]},Zm={required:[E.Depth]},Yr=class extends qt{consumes(){return Zh}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}get materialReference(){return null}modify(e){}get numGeometries(){return 0}get hasOccludees(){return!1}queryRenderOccludedState(e){return!1}},ks=class extends Yr{},Ys=class extends Yr{constructor(){super(...arguments),this.drapedPriority=0}};var kl=class extends Yr{};var Zs=class{constructor(e,r,s,i){this._textures=e,this._techniques=r,this.materialChanged=s,this.requestRender=i,this._id2glMaterialRef=new Kt}dispose(){this._textures.destroy()}acquire(e,r,s){if(this._ownMaterial(e),!e.produces.get(r)?.(s))return null;let a=this._id2glMaterialRef.get(s,e.id);if(a==null){let o=e.createGLMaterial({material:e,techniques:this._techniques,textures:this._textures,output:s});a=new Ca(o),this._id2glMaterialRef.set(s,e.id,a)}return a.ref(),a.glMaterial}release(e,r){let s=this._id2glMaterialRef.get(r,e.id);s!=null&&(s.unref(),s.referenced||(gt(s.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&ft.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Ca=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,ee(this._refCnt>=0)}get referenced(){return this._refCnt>0}};var Xs=class{constructor(e,r){this.shadowMap=e,this.slicePlane=r,this.slot=j.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=ae.NONE,this.alignPixelEnabled=!1,this.decorations=pn.ON,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new wt,this._inverseViewport=k(),this.oldLighting=new As,this.newLighting=new As,this._fadedLighting=new As,this._lighting=this.newLighting,this.ssr=new Ea,this.multipassEnabled=!1,this.multipassTerrain=new Kn,this.multipassGeometry=new pl,this.hudRenderStyle=dl.Occluded,this.cloudsFade=new il,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){let{oldLighting:r,newLighting:s}=this;e>=1?this._lighting=s:(this._fadedLighting.lerpLighting(r,s,e),this._lighting=this._fadedLighting)}},Ea=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=F()}};var Js=class{constructor(e,r,s=null){this.rctx=e,this.sliceHelper=s,this.lastFrameCamera=new wt,this.output=E.Color,this.renderOccludedMask=Qs,this.bindParameters=new Xs(r,s!=null?s.plane:null),this.bindParameters.alignPixelEnabled=!0}};var Qs=le.Occlude|le.OccludeAndTransparent|le.OccludeAndTransparentStencil;var ur=class extends wt{constructor(){super(...arguments),this._projectionMatrix=F()}get projectionMatrix(){return this._projectionMatrix}};f([S()],ur.prototype,"_projectionMatrix",void 0),f([S({readOnly:!0})],ur.prototype,"projectionMatrix",null),ur=f([Je("esri.views.3d.webgl-engine.lib.CascadeCamera")],ur);var Ia;(function(t){t[t.Highlight=0]="Highlight",t[t.ExcludeHighlight=1]="ExcludeHighlight"})(Ia||(Ia={}));var fr=class{constructor(){this.camera=new ur,this.lightMat=F()}},Da=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},Ks=class{constructor(e,r){this._fbos=e,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Da,this._projectionView=F(),this._projectionViewInverse=F(),this._modelViewLight=F(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=pe(),this._cascades=[new fr,new fr,new fr,new fr],this._lastOrigin=null,this._maxTextureWidth=Math.min(Re("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Ar(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=Et(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=_t(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)Ma[e]=this._cascades[e];return Ma.length=this._numCascades,Ma}start(e,r,s,i,a){ee(this.enabled);let{near:o,far:n}=ec(s);this._computeCascadeDistances(o,n,i),this._textureHeight=this._computeTextureHeight(e,a,i),this._setupMatrices(e,r);let{viewMatrix:h,projectionMatrix:l}=e;for(let c=0;c<this._numCascades;++c)this._constructCascade(c,l,h,r);this._lastOrigin=null,this.clear()}finish(){ee(this.enabled),this._handle?.detachDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!nt(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||R(),G(this._lastOrigin,e);for(let r=0;r<this._numCascades;++r){Li($l,this._cascades[r].lightMat,e);for(let s=0;s<16;++s)Kl[16*r+s]=$l[s]}}return Kl}moveSnapshot(e){ee(this.enabled),this._handle?.detachDepth(),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle=null,this.clear()}copySnapshot(e){let r=this._handle?.getTexture()?.descriptor;if(!this.enabled||!r)return;this._snapshots[e]?.release();let{width:s,height:i}=r,a=e===Ia.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[e]=this._fbos.acquire(s,i,a,or.RGBA4);let o=this._fbos.rctx;this._bindFbo();let n=o.bindTexture(this._snapshots[e]?.getTexture(),Dr.TEXTURE_UNIT_FOR_UPDATES);o.gl.copyTexSubImage2D($o.TEXTURE_2D,0,0,0,0,0,s,i),o.bindTexture(n,Dr.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture():null}clear(){let e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clear(Xt.COLOR_BUFFER_BIT|Xt.DEPTH_BUFFER_BIT)}_computeTextureHeight(e,r,s){let i=Math.min(window.devicePixelRatio,r)/e.pixelRatio,a=s?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,o=Sn(Math.floor(Math.max(e.fullWidth,e.fullHeight)*i*a)),n=Math.min(this._maxTextureWidth,this._numCascades*o);return Cn(n/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",or.RGBA4)),this._handle?.acquireDepth(Qn.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=Et(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){let e=this._fbos.rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,r,s,i){let a=this._cascades[e],o=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],h=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]),l=(r[10]*n+r[14])/Math.abs(r[11]*n+r[15]);ee(h<l);for(let p=0;p<8;++p){Ar(Yl,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?h:l,1);let g=Fe[p];ct(g,Yl,this._projectionViewInverse),g[0]/=g[3],g[1]/=g[3],g[2]/=g[3]}_o(Aa,Fe[0]),a.camera.viewMatrix=Li(Xh,this._modelViewLight,Aa);for(let p=0;p<8;++p)X(Fe[p],Fe[p],a.camera.viewMatrix);let c=Fe[0][2],u=Fe[0][2];for(let p=1;p<8;++p)c=Math.min(c,Fe[p][2]),u=Math.max(u,Fe[p][2]);c-=200,u+=200,a.camera.near=-u,a.camera.far=-c,Kh(s,i,c,u,a.camera),Se(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);let d=this._textureHeight;a.camera.viewport=[e*d,0,d,d]}_setupMatrices(e,r){Se(this._projectionView,e.projectionMatrix,e.viewMatrix),Qe(this._projectionViewInverse,this._projectionView);let s=this._viewingMode===Ce.Global?e.eye:z(Aa,0,0,1);ds(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],s)}_computeCascadeDistances(e,r,s){let i=s?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Yo(r/e,4)),i);let a=(r-e)/this._numCascades,o=(r/e)**(1/this._numCascades),n=e,h=e;for(let l=0;l<this._numCascades+1;++l)this._cascadeDistances[l]=At(n,h,this.settings.splitSchemeLambda),n*=o,h+=a}get test(){}},Xh=F(),Yl=pe(),Fe=[];for(let t=0;t<8;++t)Fe.push(pe());var Zl=k(),Xl=k(),Jh=k(),Jl=k(),Ql=k(),Aa=R(),Ma=[],$l=F(),Kl=qe.concat(qe,qe,qe,qe),Me=k(),dr=k(),Ht=[k(),k(),k(),k()],re=k(),Pa=k(),bt=k(),Zr=k(),pr=k(),mr=k(),$s=k();function Qh(t,e,r,s,i,a,o,n){Pt(Me,0,0);for(let x=0;x<4;++x)vt(Me,Me,t[x]);Dt(Me,Me,.25),Pt(dr,0,0);for(let x=4;x<8;++x)vt(dr,dr,t[x]);Dt(dr,dr,.25),Zt(Ht[0],t[4],t[5],.5),Zt(Ht[1],t[5],t[6],.5),Zt(Ht[2],t[6],t[7],.5),Zt(Ht[3],t[7],t[4],.5);let h=0,l=Bi(Ht[0],Me);for(let x=1;x<4;++x){let M=Bi(Ht[x],Me);M<l&&(l=M,h=x)}It(re,Ht[h],t[h+4]);let c=re[0],u,d;re[0]=-re[1],re[1]=c,It(Pa,dr,Me),ne(Pa,re)<0&&Wo(re,re),Zt(re,re,Pa,r),Gi(re,re),u=d=ne(It(bt,t[0],Me),re);for(let x=1;x<8;++x){let M=ne(It(bt,t[x],Me),re);M<u?u=M:M>d&&(d=M)}Yt(s,Me),Dt(bt,re,u-e),vt(s,s,bt);let p=-1,g=1,_=0,O=0;for(let x=0;x<8;++x){It(Zr,t[x],s),Gi(Zr,Zr);let M=re[0]*Zr[1]-re[1]*Zr[0];M>0?M>p&&(p=M,_=x):M<g&&(g=M,O=x)}Lt(p>0,"leftArea"),Lt(g<0,"rightArea"),Dt(pr,re,u),vt(pr,pr,Me),Dt(mr,re,d),vt(mr,mr,Me),$s[0]=-re[1],$s[1]=re[0];let v=Mr(s,t[O],mr,vt(bt,mr,$s),1,i),w=Mr(s,t[_],mr,bt,1,a),y=Mr(s,t[_],pr,vt(bt,pr,$s),1,o),C=Mr(s,t[O],pr,bt,1,n);Lt(v,"rayRay"),Lt(w,"rayRay"),Lt(y,"rayRay"),Lt(C,"rayRay")}function V(t,e){return 3*e+t}var eh=k();function xe(t,e){return Pt(eh,t[e],t[e+3]),eh}var ye=k(),b=Ir();function $h(t,e,r,s,i){It(ye,r,s),Dt(ye,ye,.5),b[0]=ye[0],b[1]=ye[1],b[2]=0,b[3]=ye[1],b[4]=-ye[0],b[5]=0,b[6]=ye[0]*ye[0]+ye[1]*ye[1],b[7]=ye[0]*ye[1]-ye[1]*ye[0],b[8]=1,b[V(0,2)]=-ne(xe(b,0),t),b[V(1,2)]=-ne(xe(b,1),t);let a=ne(xe(b,0),r)+b[V(0,2)],o=ne(xe(b,1),r)+b[V(1,2)],n=ne(xe(b,0),s)+b[V(0,2)],h=ne(xe(b,1),s)+b[V(1,2)];a=-(a+n)/(o+h),b[V(0,0)]+=b[V(1,0)]*a,b[V(0,1)]+=b[V(1,1)]*a,b[V(0,2)]+=b[V(1,2)]*a,a=1/(ne(xe(b,0),r)+b[V(0,2)]),o=1/(ne(xe(b,1),r)+b[V(1,2)]),b[V(0,0)]*=a,b[V(0,1)]*=a,b[V(0,2)]*=a,b[V(1,0)]*=o,b[V(1,1)]*=o,b[V(1,2)]*=o,b[V(2,0)]=b[V(1,0)],b[V(2,1)]=b[V(1,1)],b[V(2,2)]=b[V(1,2)],b[V(1,2)]+=1,a=ne(xe(b,1),e)+b[V(1,2)],o=ne(xe(b,2),e)+b[V(2,2)],n=ne(xe(b,1),r)+b[V(1,2)],h=ne(xe(b,2),r)+b[V(2,2)],a=-.5*(a/o+n/h),b[V(1,0)]+=b[V(2,0)]*a,b[V(1,1)]+=b[V(2,1)]*a,b[V(1,2)]+=b[V(2,2)]*a,a=ne(xe(b,1),e)+b[V(1,2)],o=ne(xe(b,2),e)+b[V(2,2)],n=-o/a,b[V(1,0)]*=n,b[V(1,1)]*=n,b[V(1,2)]*=n,i[0]=b[0],i[1]=b[1],i[2]=0,i[3]=b[2],i[4]=b[3],i[5]=b[4],i[6]=0,i[7]=b[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=b[6],i[13]=b[7],i[14]=0,i[15]=b[8]}function Kh(t,e,r,s,i){let a=1/Fe[0][3],o=1/Fe[4][3];ee(a<o);let n=a+Math.sqrt(a*o),h=Math.sin(wo(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));n/=h,Qh(Fe,n,h,Zl,Xl,Jh,Jl,Ql),$h(Zl,Xl,Jl,Ql,i.projectionMatrix),i.projectionMatrix[10]=2/(r-s),i.projectionMatrix[14]=-(r+s)/(r-s)}function ec(t){let{near:e,far:r}=t;return e<2&&(e=2),r<2&&(r=2),e>=r&&(e=2,r=4),{near:e,far:r}}var Ue,dt;(function(t){t[t.OBJECT=0]="OBJECT",t[t.HUD=1]="HUD",t[t.TERRAIN=2]="TERRAIN",t[t.OVERLAY=3]="OVERLAY",t[t.I3S=4]="I3S",t[t.PCL=5]="PCL",t[t.LOD=6]="LOD",t[t.VOXEL=7]="VOXEL",t[t.TILES3D=8]="TILES3D"})(Ue||(Ue={}));var ei=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=dt.ALL,this.normalRequired=!0}};(function(t){t[t.MIN=0]="MIN",t[t.MINMAX=1]="MINMAX",t[t.ALL=2]="ALL"})(dt||(dt={}));var La=class{constructor(e,r,s){this.object=e,this.geometryId=r,this.triangleNr=s}},ti=class extends La{constructor(e,r,s,i){super(e,r,s),this.center=i!=null?Cr(i):null}};var Na=class{constructor(e){this.layerUid=e}},ri=class extends Na{constructor(e,r){super(e),this.graphicUid=r}};function Va(t){return t?.dist!=null}var ag=R();var si=class extends ri{constructor(e,r,s){super(e,r),this.triangleNr=s}};var th=1e-5,Fa=class{constructor(e){this.options=new ei,this._results=new Ua,this.transform=new Bn,this.tolerance=th,this.verticalOffset=null,this._ray=$e(),this._rayEnd=R(),this._rayBeginTransformed=R(),this._rayEndTransformed=R(),this.viewingMode=e??Ce.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,r,s){this.resetWithRay(_n(e,r,this._ray),s)}resetWithRay(e,r){this.camera=r,e!==this._ray&&_s(e,this._ray),this.options.verticalOffset!==0?this.viewingMode===Ce.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,Y(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,r,s,i,a){this.point=r,this.filterPredicate=i,this.tolerance=s??th;let o=ea(this.verticalOffset);if(e&&e.length>0){let n=a?h=>{a(h)&&this.intersectObject(h)}:h=>{this.intersectObject(h)};for(let h of e){let l=h.getSpatialQueryAccelerator?.();l!=null?(o!=null?l.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,n,o):l.forEachAlongRay(this._ray.origin,this._ray.direction,n),this.options.selectionMode&&this.options.hud&&l.forEachDegenerateObject(n)):h.objects.forAll(c=>n(c))}}this.sortResults()}intersectObject(e){let r=e.geometries;if(!r)return;let s=e.effectiveTransformation,i=ea(this.verticalOffset);for(let a of r){if(!a.visible)continue;let{material:o,id:n}=a;this.transform.setAndInvalidateLazyTransforms(s,a.transformation),X(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),X(this._rayEndTransformed,this.rayEnd,this.transform.inverse);let h=this.transform.transform;i!=null&&(i.objectTransform=this.transform),o.intersect(a,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(l,c,u,d,p,g)=>{if(l>=0){if(this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,l))return;let _=d?this._results.hud:this._results,O=d?v=>{let w=new ti(e,n,u,g);v.set(Ue.HUD,w,l,c,qe,p)}:v=>v.set(Ue.OBJECT,{object:e,geometryId:n,triangleNr:u},l,c,h,p);if((_.min.drapedLayerOrder==null||p>=_.min.drapedLayerOrder)&&(_.min.dist==null||l<_.min.dist)&&O(_.min),this.options.store!==dt.MIN&&(_.max.drapedLayerOrder==null||p<_.max.drapedLayerOrder)&&(_.max.dist==null||l>_.max.dist)&&O(_.max),this.options.store===dt.ALL)if(d){let v=new Jr(this._ray);O(v),this._results.hud.all.push(v)}else{let v=new Rt(this._ray);O(v),this._results.all.push(v)}}})}}sortResults(e=this._results.all){e.sort((r,s)=>r.dist!==s.dist?(r.dist??0)-(s.dist??0):r.drapedLayerOrder!==s.drapedLayerOrder?rh(r.drapedLayerOrder,s.drapedLayerOrder):rh(r.drapedLayerGraphicOrder,s.drapedLayerGraphicOrder))}};function rh(t,e){return(e??-Number.MAX_VALUE)-(t??-Number.MAX_VALUE)}function xg(t){return new Fa(t)}var Ua=class{constructor(){this.min=new Rt($e()),this.max=new Rt($e()),this.hud={min:new Jr($e()),max:new Jr($e()),all:new Array},this.ground=new Rt($e()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}},Rt=class{get ray(){return this._ray}get distanceInRenderSpace(){return this.dist!=null?(q(ii,this.ray.direction,this.dist),Le(ii)):null}getIntersectionPoint(e){return!!Va(this)&&(q(ii,this.ray.direction,this.dist),Y(e,this.ray.origin,ii),!0)}getTransformedNormal(e){return G(Xr,this.normal),Xr[3]=0,ct(Xr,Xr,this.transformation),G(e,Xr),Q(e,e)}constructor(e){this.intersector=Ue.OBJECT,this.normal=R(),this.transformation=F(),this._ray=$e(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=Ue.OBJECT,_s(e,this._ray)}set(e,r,s,i,a,o,n){this.intersector=e,this.dist=s,G(this.normal,i??go),ve(this.transformation,a??qe),this.target=r,this.drapedLayerOrder=o,this.drapedLayerGraphicOrder=n}copy(e){_s(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,G(this.normal,e.normal),ve(this.transformation,e.transformation)}},Jr=class extends Rt{constructor(){super(...arguments),this.intersector=Ue.HUD}};function sh(t){return new Rt(t)}var ii=R(),Xr=pe();var Qr,je;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(Qr||(Qr={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(je||(je={}));var ai=class{constructor(e,r){this._material=e,this._repository=r,this._map=new Map}dispose(){this._map.forEach((e,r)=>{e!=null&&this._repository.release(this._material,r)})}load(e,r,s){if(!this._material.produces.get(r)?.(s))return null;this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,r,s));let a=this._map.get(s);if(a!=null){if(a.ensureResources(e)===dn.LOADED)return a;this._repository.requestRender()}return null}};var oi=class extends sa{constructor(e=R()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}};var St=class{constructor(e=0,r=0){this.from=e,this.to=r}get numElements(){return this.to-this.from}};function ja(t){let e=new Map;t.forAll(s=>e.set(s.from,s));let r=!0;for(;r;){r=!1;for(let s=0;s<t.length;++s){let i=t.data[s],a=e.get(i.to);if(!a)return;i.to=a.to,e.delete(a.from),t.removeUnordered(a),r=!0}}}var $r=class extends St{constructor(e,r,s){super(r,s),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.geometry.highlights!=null&&this.isVisible}get hasOccludees(){return this.geometry.occludees!=null}};var ni=class{constructor(){this.first=0,this.count=0}};var hi=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new de({allocator:e=>e||new St,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=li(),this.drawCommandsHighlight=li(),this.drawCommandsOccludees=li(),this.drawCommandsShadowHighlightRest=li()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,r){this.deleteInstance(e),this._instances.set(e,r),this._numElements+=r.numElements}deleteInstance(e){let r=this._instances.get(e);r&&(this._numElements-=r.numElements,this._instances.delete(e))}updateInstance(e,r,s){let i=this._instances.get(e);i&&(this._numElements-=i.numElements,i.from=r,i.to=s,this._numElements+=i.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){let s=this.drawCommandsDefault.pushNew(),i=this.holes.front();return this.vao!=null&&this.holes.length===1&&i.to===Math.floor(this.vao.byteSize/e)?(s.first=0,void(s.count=i.from)):(s.first=1/0,s.count=0,this._instances.forEach(a=>{s.first=Math.min(s.first,a.from),s.count=Math.max(s.count,a.to)}),void(s.count-=s.first))}let r=Array.from(this._instances.values()).sort((s,i)=>s.from===i.from?s.to-i.to:s.from-i.from);for(let s of r)s.isVisible&&(ih(s.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,s),ih(s.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,s))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function ah(t){return t.vao!=null}function li(){return new de({allocator:t=>t||new ni,deallocator:t=>t})}function ih(t,e){let r=t.back();if(r==null){let s=t.pushNew();return s.first=e.from,void(s.count=e.numElements)}if(tc(r,e)){let s=e.from-r.first+e.numElements;r.count=s}else{let s=t.pushNew();s.first=e.from,s.count=e.numElements}}function tc(t,e){return t.first+t.count>=e.from}var ci=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(r=>r.instances.has(e))}};var ui=class{constructor(e,r){this._cache=e(r,(s,i,a)=>{switch(i){case ji.ALL:return s.forEach(o=>o.dispose()),0;case ji.SOME:{let o=s.shift();return o&&(a-=Math.round(o.usedMemory),o.dispose()),a}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){let r=this._cache.peek(e);if(!r)return;let s=r.pop();if(r.length>0){if(s){let i=this._cache.getSize(e)-Math.round(s.usedMemory);this._cache.updateSize(e,r,i)}}else this._cache.pop(e);return s}put(e,r,s=Bo){let i=this._cache.peek(e);if(!i)return void this._cache.put(e,[r],r.usedMemory,s);i.push(r);let a=this._cache.getSize(e)+Math.round(r.usedMemory);this._cache.updateSize(e,i,a)}};var di=class extends el{};var pi=class{constructor(e,r,s){this._rctx=e,this._locations=r,this._layout=s,this._cache=new ui(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){let r=e.toString(),s=this._cache.pop(r);return s||(s=new di(this._rctx,this._locations,{geometry:this._layout},{geometry:nn.createVertex(this._rctx,Ko.STATIC_DRAW)}),s.vertexBuffers.geometry.setSize(e),s)}deleteVao(e){if(e==null)return;let r=e.byteSize.toString();this._cache.put(r,e)}};var Kr=class extends Ys{constructor(t){super(t),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._produces=new Map,this.drapedPriority=0}destroy(){this._glMaterials=gt(this._glMaterials),this._dataByOrigin.forEach(t=>t.dispose()),this._dataByOrigin.clear(),this._vaoCache=gt(this._vaoCache)}initialize(){this.material.produces.forEach((t,e)=>{this._produces.set(e,r=>!(this._dataByOrigin.size===0||!(r!==E.Highlight&&r!==E.ShadowHighlight||this._hasHighlights))&&t(r))})}get produces(){return this._produces}initializeRenderContext(t,e){let{rctx:r}=t.renderContext;this._glMaterials=new ai(this.material,e??t.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new pi(r,this.material.vertexAttributeLocations,en(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(t){return this.material.queryRenderOccludedState(t)}get materialReference(){return this.material}get numGeometries(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((r,s)=>r+s.instances.size,0)),t}get usedMemory(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((r,s)=>r+s.vao.usedMemory,0)),t}forEachGeometry(t){this._dataByOrigin.forEach(e=>e.buffers.forEach(r=>r.instances.forEach(s=>t(s.geometry))))}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateDrawCommands()}_updateGeometries(t){let e=this._bufferWriter;if(e===null)return;let r=e.vertexBufferLayout.stride/4;for(let s of t){let i=s.renderGeometry,a=this._dataByOrigin.get(i.localOrigin.id),o=a?.findBuffer(i.id);if(o==null)return;let n=o.instances.get(i.id);if(s.updateType&(je.GEOMETRY|je.TRANSFORMATION)){let h=gi(e.elementCount(n.geometry.geometry)*r),l=e.vertexBufferLayout.createView(h.buffer);this._writeGeometry(i,l,0),o.vao.vertexBuffers.geometry.setSubData(h,n.from*r,0,n.numElements*r)}s.updateType&(je.HIGHLIGHT|je.OCCLUDEE|je.VISIBILITY)&&(o.drawCommandsDirty=!0)}}_computeDeltas(t,e){let r=new Kt;for(let s of t){let i=s.localOrigin;if(i==null)continue;let a=r.get(i.id,null);a==null&&(a=new _i(i.vec3),r.set(i.id,null,a)),a.changes.push(s)}for(let s of e){let i=s.localOrigin;if(i==null)continue;let a=this._dataByOrigin.get(i.id),o=a?.findBuffer(s.id);if(o==null)continue;let n=r.get(i.id,o);n==null&&(n=new _i(i.vec3),r.set(i.id,o,n)),n.changes.push(s)}return r}_addAndRemoveGeometries(t,e){if(this._bufferWriter===null||this._vaoCache===null)return;let{_bufferWriter:r,_dataByOrigin:s}=this,i=r.vertexBufferLayout.stride/4,a=this._computeDeltas(t,e);a.forEach((o,n)=>{let h=o.get(null),l=h!=null?h.changes:[];a.delete(n,null);let c=s.get(n);if(o.forEach((u,d)=>{if(a.delete(n,d),d==null)return void ee(!1,"No VAO for removed geometries");if(d.instances.size===u.changes.length)return this._vaoCache.deleteVao(d.vao),Ei(c.buffers,d),void(c.buffers.length===0&&l.length===0&&s.delete(n));let p=d.numElements,g=d.vao.byteSize/4,_=l.reduce((y,C)=>y+r.elementCount(C.geometry),0),O=u.changes.reduce((y,C)=>y+r.elementCount(C.geometry),0),v=Math.min((p+_-O)*i,fi),w=v>g;v>yi&&v<g/2?(u.changes.forEach(({id:y})=>d.deleteInstance(y)),d.instances.forEach(({geometry:y})=>l.push(y)),this._vaoCache.deleteVao(d.vao),Ei(c.buffers,d)):w?this._applyAndRebuild(d,l,u):this._applyRemoves(d,u)}),l.length>0)for(c==null&&(c=new ci(h.origin),s.set(n,c)),c.buffers.forEach(u=>this._applyAdds(u,l));l.length>0;)c.buffers.push(this._applyAndRebuild(new hi,l,null))})}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(t=>{t.buffers.forEach(e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,Be(e.instances,r=>(e.updateDrawState(r),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees})})}_applyAndRebuild(t,e,r){if(r!=null)for(let p of r.changes)t.deleteInstance(p.id);let s=this._bufferWriter,i=s.vertexBufferLayout.stride,a=i/4,o=Math.floor(fi/a),n=t.numElements;for(;e.length>0;){let p=e.pop(),g=s.elementCount(p.geometry);if(n+g>o&&n>0){e.push(p);break}n+=g;let _=new $r(p,0,0);ee(t.instances.get(p.id)==null),t.addInstance(p.id,_)}let h=n*a,l=gi(h),c=s.vertexBufferLayout.createView(l.buffer),u=0;t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,t.instances.forEach((p,g)=>{this._writeGeometry(p.geometry,c,u);let _=u;u+=s.elementCount(p.geometry.geometry),t.updateInstance(g,_,u),t.updateDrawState(p)}),this._vaoCache.deleteVao(t.vao),t.vao=this._vaoCache.newVao(lh(h)),t.vao.vertexBuffers.geometry.setSubData(l,0,0,u*a),t.holes.clear();let d=t.holes.pushNew();return d.from=u,d.to=Math.floor(t.vao.byteSize/i),t.updateDrawCommands(i),t}_applyRemoves(t,e){if(e.changes.length===0||this._bufferWriter===null)return;for(let o of e.changes){let n=o.id,h=t.instances.get(n);if(!h)continue;t.deleteInstance(n);let l=st.back();if(l){if(l.to===h.from){l.to=h.to;continue}if(l.from===h.to){l.from=h.from;continue}}let c=st.pushNew();c.from=h.from,c.to=h.to}ja(st);let r=this._bufferWriter.vertexBufferLayout.stride/4,s=st.reduce((o,n)=>Math.max(o,n.numElements),0)*r,i=gi(s);i.fill(0,0,s);let a=t.vao.vertexBuffers.geometry;st.forAll(o=>a.setSubData(i,o.from*r,0,o.numElements*r)),t.holes.pushArray(st.data,st.length),st.forAll((o,n)=>st.data[n]=null),st.clear(),t.drawCommandsDirty=!0}_applyAdds(t,e){if(e.length===0||this._bufferWriter===null)return;if(!ah(t))return void this._applyAndRebuild(t,e,null);let r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,i=t.numElements,a=e.reduce((O,v)=>O+r.elementCount(v.geometry),0),o=Math.min((i+a)*s,fi),n=4*o;if(t.vao.byteSize<lh(fi-yi)&&n>t.vao.byteSize)return void this._applyAndRebuild(t,e,null);ja(t.holes);let h=new Array;for(let O of e){let v=r.elementCount(O.geometry),w=rc(t.holes,v);h.push(w)}let l=t.vao.vertexBuffers.geometry,c=0,u=0,d=0,p=gi(o),g=r.vertexBufferLayout.createView(p.buffer);e.forEach((O,v)=>{let w=h[v];if(w==null)return;if(d!==w){let x=d-u;x>0&&l.setSubData(p,u*s,0,x*s),u=w,c=0}let y=r.elementCount(O.geometry);this._writeGeometry(O,g,c),c+=y,d=w+y;let C=new $r(O,w,w+y);ee(t.instances.get(O.id)==null),t.addInstance(O.id,C),t.drawCommandsDirty=!0});let _=d-u;_>0&&l.setSubData(p,u*s,0,_*s),io(e,(O,v)=>h[v]==null)}_writeGeometry(t,e,r){if(this._bufferWriter===null)return;let s=t.localOrigin.vec3;Zo(oh,-s[0],-s[1],-s[2]);let i=Se(sc,oh,t.transformation);Qe(mi,i),us(mi,mi),this._bufferWriter.write(i,mi,t.geometry,e,r)}updateAnimation(t){return this.material.update(t)}prepareTechnique(t){if(!this.material.shouldRender(t))return null;let{output:e,bindParameters:r}=t;if(!this.material.produces.get(r.slot)?.(e))return null;let i=e===E.Highlight||e===E.ShadowHighlight;if(i&&!this._hasHighlights)return null;let a=e===E.ShadowExcludeHighlight,o=!(i||a);for(let n of this._dataByOrigin.values())for(let h of n.buffers){if(i&&!h.hasHighlights)continue;let l=(i?h.drawCommandsHighlight:a&&h.needsMultipleCommands()?h.drawCommandsShadowHighlightRest:h.drawCommandsDefault)||null,c=o&&h.drawCommandsOccludees||null;if(l?.length||c?.length){let u=this._glMaterials.load(t.rctx,r.slot,e),d=u!=null?u.beginSlot(r):null;if(d!=null)return d}}return null}renderNode(t,e){let{output:r,bindParameters:s}=t,i=r===E.Highlight||r===E.ShadowHighlight,a=r===E.ShadowExcludeHighlight,o=!(i||a),n=s.slot===j.OCCLUDER_MATERIAL,h=s.slot===j.TRANSPARENT_OCCLUDER_MATERIAL,l=t.rctx;l.runAppleAmdDriverHelper(),l.bindTechnique(e,s,this.material.parameters);for(let c of this._dataByOrigin.values())for(let u of c.buffers){if(i&&!u.hasHighlights)continue;let d=(i?u.drawCommandsHighlight:a&&u.needsMultipleCommands()?u.drawCommandsShadowHighlightRest:u.drawCommandsDefault)||null,p=o&&u.drawCommandsOccludees||null;(d?.length||p?.length)&&(e.program.bindDraw(new oi(c.origin),s,this.material.parameters),e.ensureAttributeLocations(u.vao),l.bindVAO(u.vao),d?.length&&(l.setPipelineState(e.getPipeline(!1,n,h)),d.forAll(g=>l.drawArrays(e.primitiveType,g.first,g.count))),p?.length&&(l.setPipelineState(e.getPipeline(!0,n,h)),p.forAll(g=>l.drawArrays(e.primitiveType,g.first,g.count))))}}get test(){}};f([S({constructOnly:!0})],Kr.prototype,"material",void 0),Kr=f([Je("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],Kr);var _i=class{constructor(e){this.origin=e,this.changes=new Array}};function rc(t,e){let r;if(!t.some(i=>!(i.numElements<e)&&(r=i,!0)))return null;let s=r.from;return r.from+=e,r.from>=r.to&&t.removeUnordered(r),s}var oh=F(),sc=F(),mi=F(),st=new de({allocator:t=>t||new St,deallocator:null}),yi=65536,Ba=4*yi,nh=1024,hh=16777216,fi=hh/4,Ga=new Float32Array(yi);function gi(t){return Ga.length<t&&(Ga=new Float32Array(t)),Ga}function lh(t){let e=4*t;return e<=nh?nh:e<Ba?Oo(e):Math.max(Math.min(Math.ceil(1.5*e/Ba)*Ba,hh),e)}var Pe=class extends qt{constructor(t){super(t),this._pending=new Wa,this._changes=new Us,this._materialRenderers=new Map,this._sortedMaterialRenderers=new de,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(t=>t.destroy()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return Be(this._materialRenderers,t=>t.numGeometries!==0&&!t.queryRenderOccludedState(le.Occlude))}get isEmpty(){return!this.updating&&this._materialRenderers.size===0&&this._geometries.size===0}getMaterialRenderer(t){return this._materialRenderers.get(t)}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();let t=Ul(this._changes),e=!1;return t.forEach((r,s)=>{let i=this.getMaterialRenderer(s);if(!i&&r.adds.length>0){let a=new Kr({material:s});a.initializeRenderContext(this.rendererContext.pluginContext,this._materials),i=a,this._materialRenderers.set(s,i),e=!0}i&&(i.modify(r),i.numGeometries===0&&(this._materialRenderers.delete(s),i.destroy(),e=!0))}),this._changes.clear(),e&&this._updateSortedMaterialRenderers(),this._hasHighlights=Be(this._materialRenderers,r=>{let s=r.produces.get(j.DRAPED_MATERIAL);return!!s&&s(E.Highlight)}),this._hasWater=Be(this._materialRenderers,r=>{let s=r.produces.get(j.DRAPED_WATER);return!!s&&s(E.Normal)}),this.notifyChange("updating"),!0}addGeometries(t,e){if(t.length===0)return;let r=this._validateRenderGeometries(t);for(let i of r)this._geometries.set(i.id,i);let s=this._pending.empty;for(let i of r)this._pending.adds.add(i);s&&this.notifyChange("updating"),e===Qr.UPDATE&&this._notifyGraphicGeometryChanged(t)}removeGeometries(t,e){let r=this._pending.empty,s=this._pending.adds;for(let i of t)s.has(i)?(this._pending.removed.add(i),s.delete(i)):this._pending.removed.has(i)||this._pending.removes.add(i),this._geometries.delete(i.id);r&&!this._pending.empty&&this.notifyChange("updating"),e===Qr.UPDATE&&this._notifyGraphicGeometryChanged(t)}modifyGeometries(t,e){let r=this._changes.updates.length===0;for(let s of t){let i=this._changes.updates.pushNew();i.renderGeometry=this._validateRenderGeometry(s),i.updateType=e}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),e){case je.TRANSFORMATION:case je.GEOMETRY:return this._notifyGraphicGeometryChanged(t);case je.VISIBILITY:return this._notifyGraphicVisibilityChanged(t)}}updateAnimation(t){let e=!1;return this._sortedMaterialRenderers.forAll(r=>e=!!r.updateAnimation&&r.updateAnimation(t)||e),e}shouldRender(t){return this._sortedMaterialRenderers.some(e=>e.prepareTechnique(t))}render(t){this._sortedMaterialRenderers.forAll(e=>{let r=e.prepareTechnique(t);r!=null&&e.renderNode(t,r)})}intersect(t,e,r,s,i){return this._geometries.forEach(a=>{if(s&&!s(a))return;this._intersectRenderGeometry(a,r,e,0,t,i);let o=this.rendererContext.longitudeCyclical;o&&(a.boundingSphere[0]-a.boundingSphere[3]<o.min&&this._intersectRenderGeometry(a,r,e,o.range,t,i),a.boundingSphere[0]+a.boundingSphere[3]>o.max&&this._intersectRenderGeometry(a,r,e,-o.range,t,i)),i++}),i}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let t=0;for(let e of this._materialRenderers.values())e.drapedPriority=t++,this._sortedMaterialRenderers.push(e);this._sortedMaterialRenderers.sort((e,r)=>r.materialReference?.renderPriority===e.materialReference?.renderPriority?e.drapedPriority-r.drapedPriority:(r.materialReference?.renderPriority||0)-(e.materialReference?.renderPriority||0))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let t=0;t<this._changes.updates.length;){let e=this._changes.updates.data[t];this._pending.has(e.renderGeometry)?this._changes.updates.removeUnorderedIndex(t):t++}this._pending.clear()}_intersectRenderGeometry(t,e,r,s,i,a){if(!t.visible)return;let o=0;s+=t.transformation[12],o=t.transformation[13],Ha[0]=r[0]-s,Ha[1]=r[1]-o,t.screenToWorldRatio=this.rendererContext.screenToWorldRatio,t.material.intersectDraped(t,null,i,Ha,(n,h,l)=>{ic(e,l,a,t.material.renderPriority,i,t.layerUid,t.graphicUid)},e)}_notifyGraphicGeometryChanged(t){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let e;for(let r of t){let s=r.graphicUid;s!=null&&s!==e&&(this.drapeSource.notifyGraphicGeometryChanged(s),e=s)}}_notifyGraphicVisibilityChanged(t){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let e;for(let r of t){let s=r.graphicUid;s!=null&&s!==e&&(this.drapeSource.notifyGraphicVisibilityChanged(s),e=s)}}_validateRenderGeometries(t){for(let e of t)this._validateRenderGeometry(e);return t}_validateRenderGeometry(t){return t.localOrigin==null&&(t.localOrigin=this._localOriginFactory.getOrigin(t.boundingSphere)),t}get test(){}};f([S()],Pe.prototype,"drapeSource",void 0),f([S()],Pe.prototype,"updating",null),f([S()],Pe.prototype,"rctx",null),f([S({constructOnly:!0})],Pe.prototype,"rendererContext",void 0),f([S()],Pe.prototype,"_materials",null),f([S()],Pe.prototype,"_localOriginFactory",null),f([S({readOnly:!0})],Pe.prototype,"isEmpty",null),f([S()],Pe.prototype,"_materialRenderers",void 0),f([S()],Pe.prototype,"_geometries",void 0),Pe=f([Je("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Pe);var Wa=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function ic(t,e,r,s,i,a,o){let n=new si(a,o,e),h=l=>{l.set(Ue.OVERLAY,n,t.dist,t.normal,t.transformation,r,s)};if((i.results.min.drapedLayerOrder==null||r>=i.results.min.drapedLayerOrder)&&(i.results.min.dist==null||i.results.ground.dist<=i.results.min.dist)&&h(i.results.min),i.options.store!==dt.MIN&&(i.results.max.drapedLayerOrder==null||r<i.results.max.drapedLayerOrder)&&(i.results.max.dist==null||i.results.ground.dist>i.results.max.dist)&&h(i.results.max),i.options.store===dt.ALL){let l=sh(i.ray);h(l),i.results.all.push(l)}}var Ha=k();var es=class t extends et{initializeProgram(e){return new tt(e.rctx,t.shader.get().build(),Tt)}initializePipeline(){return this.configuration.hasAlpha?Oe({blending:Dn(ze.SRC_ALPHA,ze.ONE,ze.ONE_MINUS_SRC_ALPHA,ze.ONE_MINUS_SRC_ALPHA),colorWrite:Ee}):Oe({colorWrite:Ee})}};es.shader=new Ke(ol,()=>import("./chunk-IWZSGB3O.js"));var ts=class extends Es{constructor(){super(...arguments),this.hasAlpha=!1}};f([D()],ts.prototype,"hasAlpha",void 0);var rs=class t extends et{initializeProgram(e){return new tt(e.rctx,t.shader.get().build(),Tt)}initializePipeline(){return Oe({blending:Rs(ze.ONE,ze.ONE_MINUS_SRC_ALPHA),colorWrite:Ee})}};rs.shader=new Ke(fl,()=>import("./chunk-V2MJCTMW.js"));var Xe=class extends ks{constructor(t){super(t),this._overlays=null,this._renderTargets=null,this._overlayParameters=new ml,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new de,this._passParameters=new al,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new wt,this.worldToPCSRatio=1,this.events=new hs,this.longitudeCyclical=null,this.produces=new Map([[j.DRAPED_MATERIAL,e=>e!==E.Highlight||this.hasHighlights],[j.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){let t=this.view._stage.renderer.fboCache,e=this.view._stage.renderView,{waterTextures:r,stippleTextures:s,markerTextures:i}=e;this._techniques=new qs({rctx:this._rctx,viewingMode:Ce.Local,stippleTextures:s,markerTextures:i,waterTextures:r}),this._renderContext=new Js(this._rctx,new Ks(t,this.view.state.viewingMode),null),this.addHandles([cs(()=>r.updating,()=>this.events.emit("content-changed"),Ai),cs(()=>this.spatialReference,a=>this._localOriginFactory=new Hs(a),Ai),no(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]),this._materials=new Zs(e.textures,this._techniques,()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed")),this._bindParameters.slot=j.DRAPED_MATERIAL,this._bindParameters.mainDepth=null,this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=ae.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new $n(Ge(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(Go.STAGE,this))}destroy(){this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._debugTextureTechnique=Et(this._debugTextureTechnique),this._passParameters.texture=gt(this._passParameters.texture),this._techniques=os(this._techniques),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}initializeRenderContext(t){this.pluginContext=t}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||Be(this._renderers,t=>t.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(t){for(let e of this._renderers.values()){let r=e.getMaterialRenderer(t);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(t=>t.drapeSource.layer).filter(t=>!!t)}createGeometryDrapeSourceRenderer(t){return this.createDrapeSourceRenderer(t,Pe)}createDrapeSourceRenderer(t,e,r){let s=this._renderers.get(t);s?.destroy();let i=new e(so(Sr({},r),{rendererContext:this,drapeSource:t}));return this._renderers.set(t,i),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in t&&this.addHandles(cs(()=>t.fullOpacity,()=>this.events.emit("content-changed")),t),i}removeDrapeSourceRenderer(t){if(t==null)return;let e=this._renderers.get(t);e!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(t),this.removeHandles(t),e.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(t){this._hasTargetWithoutRasterImage=!!this._overlays&&ns(t,e=>e.drapeTargetType===Ps.WithoutRasterImage)}ensureDrapeSources(t){this._overlays?(this._hasDrapedFeatureSource=ns(t,e=>e.drapeSourceType===lr.Features),this._hasDrapedRasterSource=ns(t,e=>e.drapeSourceType===lr.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(t,e,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new zs(this.view._stage.renderer.fboCache),this._overlays=[new kr,new kr]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=gt(this._renderTargets),this.events.emit("textures-disposed")}getTexture(t){if(t!=null)return t===se.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(se.Color):this._renderTargets?.getTexture(t)}get running(){return this.updating}runTask(t){this._processDrapeSources(t,()=>!0)}_processDrapeSources(t,e){let r=!1;for(let[s,i]of this._renderers){if(t.done)break;(s.destroyed||e(s))&&i.commitChanges()&&(r=!0,t.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=Be(this._renderers,s=>s.hasHighlights),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Ho,t=>t.updatePolicy===Ft.SYNC)}get isEmpty(){return!ar.OVERLAY_DRAW_DEBUG_TEXTURE&&!Be(this._renderers,t=>!t.isEmpty)}get hasWater(){return this._hasWater}get rendersOccludedDraped(){let t=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=ch;let e=this._sortedRenderers.some(({renderer:r})=>r.shouldRender(this._renderContext));return this._renderContext.renderOccludedMask=t,e}renders(t){return ar.OVERLAY_DRAW_DEBUG_TEXTURE&&t!==se.Occluded||this._sortedRenderers.some(({renderer:e})=>e.shouldRender(this._renderContext))}get mode(){return this.isEmpty?Gt.Disabled:this._renderTargets?.getTexture(se.WaterNormal)?Gt.EnabledWithWater:this._renderTargets?.getTexture(se.Color)?Gt.Enabled:Gt.Disabled}updateAnimation(t){let e=!1;return this._renderers.forEach(r=>e=r.updateAnimation(t)||e),e}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(t){if(this._overlays&&this._renderTargets){for(let e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryViewsDirect();for(let e of this._renderTargets.targets){if(e.content===se.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;let r=this._drawTarget(nr.INNER,e,t),s=this._drawTarget(nr.OUTER,e,t);(r||s)&&e.fbo.generateMipMap()}}}_drawTarget(t,e,r){let s=this._overlays[t],i=s.canvasGeometries;if(i.numViews===0)return!1;let{alignPixelEnabled:a,contentPixelRatio:o}=r;this._screenToWorldRatio=o*s.mapUnitsPerPixel/this._bindParameters.overlayStretch;let n=e.output;if(this.isEmpty||n===E.Highlight&&!this.hasHighlights||n===E.Normal&&!this.hasWater||!s.hasSomeSizedView())return!1;let h=this._rctx;if(this._camera.pixelRatio=s.pixelRatio*o,this._renderContext.output=n,this._bindParameters.alignPixelEnabled=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=n===E.Normal?j.DRAPED_WATER:j.DRAPED_MATERIAL,e.content===se.Occluded&&(this._renderContext.renderOccludedMask=ch),!this.renders(e.content))return this._renderContext.renderOccludedMask=Qs,!1;let l=s.resolution;this._rctx.setViewport(t===nr.INNER?0:l,0,l,l);let c=2*s.resolution,u=s.resolution,d=e.fbo;if(d.bind(h,c,u),t===nr.INNER&&(h.setClearColor(0,0,0,0),h.clear(Xt.COLOR_BUFFER_BIT)),ar.OVERLAY_DRAW_DEBUG_TEXTURE&&e.content!==se.Occluded)for(let p=0;p<i.numViews;p++)this._setViewParameters(i.extents[p],s),this._ensureDebugPatternResources(s.resolution,ac[t]),this._rctx.bindTechnique(this._debugTextureTechnique,this._renderContext.bindParameters,this._passParameters),this._rctx.screen.draw();return this._sortedRenderers.forAll(({drapeSource:p,renderer:g})=>{if(e.content===se.ColorNoRasterImage&&p.drapeSourceType===lr.RasterImage)return;let{fullOpacity:_}=p,O=_!=null&&_<1&&n===E.Color?this.bindTemporaryFramebuffer(c,u):null;for(let v=0;v<i.numViews;v++)this._setViewParameters(i.extents[v],s),g.render(this._renderContext);if(O){d.bind(h,c,u),this._overlayParameters.texture=O.getTexture(),this._overlayParameters.opacity=_,this._overlayParameters.overlayIndex=t;let v=this.pluginContext.techniques.acquire(rs);this._rctx.bindTechnique(v,this._renderContext.bindParameters,this._overlayParameters),this._rctx.screen.draw(),v.release(),O.release()}}),h.bindFramebuffer(null),this._renderContext.renderOccludedMask=Qs,!0}bindTemporaryFramebuffer(t,e){let r=this.view._stage.renderer.fboCache,s=r.acquire(t,e,"overlay tmp");return r.rctx.unbindTexture(s.fbo?.colorTexture),r.rctx.bindFramebuffer(s.fbo),r.rctx.clear(Xt.COLOR_BUFFER_BIT),s}reloadShaders(){return mt(this,null,function*(){yield this._techniques.reloadAll()})}notifyContentChanged(){this.events.emit("content-changed")}intersect(t,e,r,s){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(let{renderer:a}of this._sortedRenderers)i=a.intersect?.(t,e,r,s,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;let t=this.view.map.allLayers,e=t.length;this._renderers.forEach((r,s)=>{let i=t.indexOf(s.layer),a=i>=0,o=s.renderGroup??(a?Gr.MapLayer:Gr.ViewLayer),n=e*o+(a?i:0);this._sortedRenderers.push(new za(s,r,n))}),this._sortedRenderers.sort((r,s)=>r.index-s.index)}_setViewParameters(t,e){let r=this._camera;r.viewport=[0,0,e.resolution,e.resolution],Mo(r.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],r.near,r.far),Eo(r.viewMatrix,[-t[0],-t[1],0])}_updateHasWater(){let t=Be(this._renderers,e=>e.hasWater);t!==this._hasWater&&(this._hasWater=t,this.events.emit("has-water",t))}_ensureDebugPatternResources(t,e){if(z(this._passParameters.color,e[0],e[1],e[2]),this._passParameters.texture)return;let r=new Uint8Array(t*t*4),s=0;for(let o=0;o<t;o++)for(let n=0;n<t;n++){let h=Math.floor(n/10),l=Math.floor(o/10);h<2||l<2||10*h>t-20||10*l>t-20?(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=255):(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=1&h&&1&l?1&n^1&o?0:255:1&h^1&l?0:128)}let i=new ln(t);i.samplingMode=Qo.NEAREST,this._passParameters.texture=new Dr(this._rctx,i,r);let a=new ts;a.hasAlpha=!0,this._debugTextureTechnique=this._techniques.acquire(es,a)}get test(){}};f([S()],Xe.prototype,"hasHighlights",void 0),f([S()],Xe.prototype,"_sortedDrapeSourceRenderersDirty",void 0),f([S()],Xe.prototype,"_techniques",void 0),f([S({constructOnly:!0})],Xe.prototype,"view",void 0),f([S()],Xe.prototype,"worldToPCSRatio",void 0),f([S()],Xe.prototype,"spatialReference",void 0),f([S({type:Boolean,readOnly:!0})],Xe.prototype,"updating",null),f([S()],Xe.prototype,"isEmpty",null),f([S({readOnly:!0})],Xe.prototype,"rendersOccludedDraped",null),Xe=f([Je("esri.views.3d.terrain.OverlayRenderer")],Xe);var za=class{constructor(e,r,s){this.drapeSource=e,this.renderer=r,this.index=s}},ac=[[1,.5,.5],[.5,.5,1]],uh=-2,ch=le.OccludeAndTransparent;var vi;(function(t){function e(o,n){let h=o[n],l=o[n+1],c=o[n+2];return Math.sqrt(h*h+l*l+c*c)}function r(o,n){let h=o[n],l=o[n+1],c=o[n+2],u=1/Math.sqrt(h*h+l*l+c*c);o[n]*=u,o[n+1]*=u,o[n+2]*=u}function s(o,n,h){o[n]*=h,o[n+1]*=h,o[n+2]*=h}function i(o,n,h,l,c,u=n){(c=c||o)[u]=o[n]+h[l],c[u+1]=o[n+1]+h[l+1],c[u+2]=o[n+2]+h[l+2]}function a(o,n,h,l,c,u=n){(c=c||o)[u]=o[n]-h[l],c[u+1]=o[n+1]-h[l+1],c[u+2]=o[n+2]-h[l+2]}t.length=e,t.normalize=r,t.scale=s,t.add=i,t.subtract=a})(vi||(vi={}));var gr=vi,qa=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],oc=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],nc=[0,0,1,0,1,1,0,1],lc=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],mh=new Array(36);for(let t=0;t<6;t++)for(let e=0;e<6;e++)mh[6*t+e]=t;var Wt=new Array(36);for(let t=0;t<6;t++)Wt[6*t]=0,Wt[6*t+1]=1,Wt[6*t+2]=2,Wt[6*t+3]=2,Wt[6*t+4]=3,Wt[6*t+5]=0;function w0(t,e){Array.isArray(e)||(e=[e,e,e]);let r=new Array(24);for(let s=0;s<8;s++)r[3*s]=qa[s][0]*e[0],r[3*s+1]=qa[s][1]*e[1],r[3*s+2]=qa[s][2]*e[2];return new me(t,[[m.POSITION,new L(r,lc,3,!0)],[m.NORMAL,new L(oc,mh,3)],[m.UV0,new L(nc,Wt,2)]])}var ka=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],hc=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],cc=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],uc=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function x0(t,e){Array.isArray(e)||(e=[e,e,e]);let r=new Array(18);for(let s=0;s<6;s++)r[3*s]=ka[s][0]*e[0],r[3*s+1]=ka[s][1]*e[1],r[3*s+2]=ka[s][2]*e[2];return new me(t,[[m.POSITION,new L(r,cc,3,!0)],[m.NORMAL,new L(hc,uc,3)]])}var Ti=te(-.5,0,-.5),Oi=te(.5,0,-.5),wi=te(0,0,.5),xi=te(0,.5,0),_r=Ve(),yr=Ve(),Tr=Ve(),Or=Ve(),wr=Ve();$(_r,Ti,xi),$(yr,Ti,Oi),Ne(Tr,_r,yr),Q(Tr,Tr),$(_r,Oi,xi),$(yr,Oi,wi),Ne(Or,_r,yr),Q(Or,Or),$(_r,wi,xi),$(yr,wi,Ti),Ne(wr,_r,yr),Q(wr,wr);var Ya=[Ti,Oi,wi,xi],dc=[0,-1,0,Tr[0],Tr[1],Tr[2],Or[0],Or[1],Or[2],wr[0],wr[1],wr[2]],pc=[0,1,2,3,1,0,3,2,1,3,0,2],mc=[0,0,0,1,1,1,2,2,2,3,3,3];function b0(t,e){Array.isArray(e)||(e=[e,e,e]);let r=new Array(12);for(let s=0;s<4;s++)r[3*s]=Ya[s][0]*e[0],r[3*s+1]=Ya[s][1]*e[1],r[3*s+2]=Ya[s][2]*e[2];return new me(t,[[m.POSITION,new L(r,pc,3,!0)],[m.NORMAL,new L(dc,mc,3)]])}function R0(t,e,r,s,i={uv:!0}){let a=-Math.PI,o=2*Math.PI,n=-Math.PI/2,h=Math.PI,l=Math.max(3,Math.floor(r)),c=Math.max(2,Math.floor(s)),u=(l+1)*(c+1),d=Te(3*u),p=Te(3*u),g=Te(2*u),_=[],O=0;for(let y=0;y<=c;y++){let C=[],x=y/c,M=n+x*h,T=Math.cos(M);for(let W=0;W<=l;W++){let H=W/l,A=a+H*o,ie=Math.cos(A)*T,U=Math.sin(M),it=-Math.sin(A)*T;d[3*O]=ie*e,d[3*O+1]=U*e,d[3*O+2]=it*e,p[3*O]=ie,p[3*O+1]=U,p[3*O+2]=it,g[2*O]=H,g[2*O+1]=x,C.push(O),++O}_.push(C)}let v=new Array;for(let y=0;y<c;y++)for(let C=0;C<l;C++){let x=_[y][C],M=_[y][C+1],T=_[y+1][C+1],W=_[y+1][C];y===0?(v.push(x),v.push(T),v.push(W)):y===c-1?(v.push(x),v.push(M),v.push(T)):(v.push(x),v.push(M),v.push(T),v.push(T),v.push(W),v.push(x))}let w=[[m.POSITION,new L(d,v,3,!0)],[m.NORMAL,new L(p,v,3,!0)]];return i.uv&&w.push([m.UV0,new L(g,v,2,!0)]),i.offset&&(w[0][0]=m.OFFSET,w.push([m.POSITION,new L(Float64Array.from(i.offset),Pr(v.length),3,!0)])),new me(t,w)}function S0(t,e,r,s){let i=fc(e,r,s);return new me(t,i)}function fc(t,e,r){let s=t,i,a;if(r)i=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],a=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{let l=s*(1+Math.sqrt(5))/2;i=[-s,l,0,s,l,0,-s,-l,0,s,-l,0,0,-s,l,0,s,l,0,-s,-l,0,s,-l,l,0,-s,l,0,s,-l,0,-s,-l,0,s],a=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let l=0;l<i.length;l+=3)gr.scale(i,l,t/gr.length(i,l));let o={};function n(l,c){l>c&&([l,c]=[c,l]);let u=l.toString()+"."+c.toString();if(o[u])return o[u];let d=i.length;return i.length+=3,gr.add(i,3*l,i,3*c,i,d),gr.scale(i,d,t/gr.length(i,d)),d/=3,o[u]=d,d}for(let l=0;l<e;l++){let c=a.length,u=new Array(4*c);for(let d=0;d<c;d+=3){let p=a[d],g=a[d+1],_=a[d+2],O=n(p,g),v=n(g,_),w=n(_,p),y=4*d;u[y]=p,u[y+1]=O,u[y+2]=w,u[y+3]=g,u[y+4]=v,u[y+5]=O,u[y+6]=_,u[y+7]=w,u[y+8]=v,u[y+9]=O,u[y+10]=v,u[y+11]=w}a=u,o={}}let h=Hi(i);for(let l=0;l<h.length;l+=3)gr.normalize(h,l);return[[m.POSITION,new L(Hi(i),a,3,!0)],[m.NORMAL,new L(h,a,3,!0)]]}function C0(t,e,r,s,i,a,o,n,h=null){let l=r?Cr(r):R(),c=e?Cr(e):Ge(0,0,1);o??=k();let u=s?[255*s[0],255*s[1],255*s[2],s.length>3?255*s[3]:255]:[255,255,255,255],d=i!=null&&i.length===2?i:[1,1],p=Pr(1),g=[[m.POSITION,new L(l,p,3,!0)],[m.NORMAL,new L(c,p,3,!0)],[m.UV0,new L(o,p,o.length)],[m.COLOR,new L(u,p,4,!0)],[m.SIZE,new L(d,p,2)]];if(a!=null&&(a=[a[0],a[1],a[2],a[3]],g.push([m.CENTEROFFSETANDDISTANCE,new L(a,p,4)])),n){let _=[n[0],n[1],n[2],n[3]];g.push([m.FEATUREATTRIBUTE,new L(_,p,4)])}return new me(t,g,null,Ye.Point,h)}function E0(t,e,r,s,i,a=!0,o=!0){let n=0,h=r,l=e,c=te(0,n,0),u=te(0,n+l,0),d=te(0,-1,0),p=te(0,1,0);i&&(n=l,u=te(0,0,0),c=te(0,n,0),d=te(0,1,0),p=te(0,-1,0));let g=[u,c],_=[d,p],O=s+2,v=Math.sqrt(l*l+h*h);if(i)for(let T=s-1;T>=0;T--){let W=T*(2*Math.PI/s),H=te(Math.cos(W)*h,n,Math.sin(W)*h);g.push(H);let A=te(l*Math.cos(W)/v,-h/v,l*Math.sin(W)/v);_.push(A)}else for(let T=0;T<s;T++){let W=T*(2*Math.PI/s),H=te(Math.cos(W)*h,n,Math.sin(W)*h);g.push(H);let A=te(l*Math.cos(W)/v,h/v,l*Math.sin(W)/v);_.push(A)}let w=new Array,y=new Array;if(a){for(let T=3;T<g.length;T++)w.push(1),w.push(T-1),w.push(T),y.push(0),y.push(0),y.push(0);w.push(g.length-1),w.push(2),w.push(1),y.push(0),y.push(0),y.push(0)}if(o){for(let T=3;T<g.length;T++)w.push(T),w.push(T-1),w.push(0),y.push(T),y.push(T-1),y.push(1);w.push(0),w.push(2),w.push(g.length-1),y.push(1),y.push(2),y.push(_.length-1)}let C=Te(3*O);for(let T=0;T<O;T++)C[3*T]=g[T][0],C[3*T+1]=g[T][1],C[3*T+2]=g[T][2];let x=Te(3*O);for(let T=0;T<O;T++)x[3*T]=_[T][0],x[3*T+1]=_[T][1],x[3*T+2]=_[T][2];let M=[[m.POSITION,new L(C,w,3,!0)],[m.NORMAL,new L(x,y,3,!0)]];return new me(t,M)}function A0(t,e,r,s,i,a,o){let n=i?Yi(i):te(1,0,0),h=a?Yi(a):te(0,0,0);o??=!0;let l=Ve();Q(l,n);let c=Ve();q(c,l,Math.abs(e));let u=Ve();q(u,c,-.5),Y(u,u,h);let d=te(0,1,0);Math.abs(1-He(l,d))<.2&&z(d,0,0,1);let p=Ve();Ne(p,l,d),Q(p,p),Ne(d,p,l);let g=2*s+(o?2:0),_=s+(o?2:0),O=Te(3*g),v=Te(3*_),w=Te(2*g),y=new Array(3*s*(o?4:2)),C=new Array(3*s*(o?4:2));o&&(O[3*(g-2)]=u[0],O[3*(g-2)+1]=u[1],O[3*(g-2)+2]=u[2],w[2*(g-2)]=0,w[2*(g-2)+1]=0,O[3*(g-1)]=O[3*(g-2)]+c[0],O[3*(g-1)+1]=O[3*(g-2)+1]+c[1],O[3*(g-1)+2]=O[3*(g-2)+2]+c[2],w[2*(g-1)]=1,w[2*(g-1)+1]=1,v[3*(_-2)]=-l[0],v[3*(_-2)+1]=-l[1],v[3*(_-2)+2]=-l[2],v[3*(_-1)]=l[0],v[3*(_-1)+1]=l[1],v[3*(_-1)+2]=l[2]);let x=(A,ie,U)=>{y[A]=ie,C[A]=U},M=0,T=Ve(),W=Ve();for(let A=0;A<s;A++){let ie=A*(2*Math.PI/s);q(T,d,Math.sin(ie)),q(W,p,Math.cos(ie)),Y(T,T,W),v[3*A]=T[0],v[3*A+1]=T[1],v[3*A+2]=T[2],q(T,T,r),Y(T,T,u),O[3*A]=T[0],O[3*A+1]=T[1],O[3*A+2]=T[2],w[2*A]=A/s,w[2*A+1]=0,O[3*(A+s)]=O[3*A]+c[0],O[3*(A+s)+1]=O[3*A+1]+c[1],O[3*(A+s)+2]=O[3*A+2]+c[2],w[2*(A+s)]=A/s,w[2*A+1]=1;let U=(A+1)%s;x(M++,A,A),x(M++,A+s,A),x(M++,U,U),x(M++,U,U),x(M++,A+s,A),x(M++,U+s,U)}if(o){for(let A=0;A<s;A++){let ie=(A+1)%s;x(M++,g-2,_-2),x(M++,A,_-2),x(M++,ie,_-2)}for(let A=0;A<s;A++){let ie=(A+1)%s;x(M++,A+s,_-1),x(M++,g-1,_-1),x(M++,ie+s,_-1)}}let H=[[m.POSITION,new L(O,y,3,!0)],[m.NORMAL,new L(v,C,3,!0)],[m.UV0,new L(w,y,2,!0)]];return new me(t,H)}function M0(t,e,r,s,i,a){s=s||10,i=i==null||i,ee(e.length>1);let o=[[0,0,0]],n=[],h=[];for(let l=0;l<s;l++){n.push([0,-l-1,-(l+1)%s-1]);let c=l/s*2*Math.PI;h.push([Math.cos(c)*r,Math.sin(c)*r])}return gc(t,h,e,o,n,i,a)}function gc(t,e,r,s,i,a,o=te(0,0,0)){let n=e.length,h=Te(r.length*n*3+(6*s.length||0)),l=Te(r.length*n*3+(s?6:0)),c=new Array,u=new Array,d=0,p=0,g=R(),_=R(),O=R(),v=R(),w=R(),y=R(),C=R(),x=R(),M=R(),T=R(),W=R(),H=R(),A=R(),ie=Vt();z(M,0,1,0),$(_,r[1],r[0]),Q(_,_),a?(Y(x,r[0],o),Q(O,x)):z(O,0,0,1),dh(_,O,M,M,w,O,ph),G(v,O),G(H,w);for(let P=0;P<s.length;P++)q(y,w,s[P][0]),q(x,O,s[P][2]),Y(y,y,x),Y(y,y,r[0]),h[d++]=y[0],h[d++]=y[1],h[d++]=y[2];l[p++]=-_[0],l[p++]=-_[1],l[p++]=-_[2];for(let P=0;P<i.length;P++)c.push(i[P][0]>0?i[P][0]:-i[P][0]-1+s.length),c.push(i[P][1]>0?i[P][1]:-i[P][1]-1+s.length),c.push(i[P][2]>0?i[P][2]:-i[P][2]-1+s.length),u.push(0),u.push(0),u.push(0);let U=s.length,it=s.length-1;for(let P=0;P<r.length;P++){let pt=!1;P>0&&(G(g,_),P<r.length-1?($(_,r[P+1],r[P]),Q(_,_)):pt=!0,Y(T,g,_),Q(T,T),Y(W,r[P-1],v),cn(r[P],T,ie),un(ie,gn(W,g),x)?($(x,x,r[P]),Q(O,x),Ne(w,T,O),Q(w,w)):dh(T,v,H,M,w,O,ph),G(v,O),G(H,w)),a&&(Y(x,r[P],o),Q(A,x));for(let be=0;be<n;be++)if(q(y,w,e[be][0]),q(x,O,e[be][1]),Y(y,y,x),Q(C,y),l[p++]=C[0],l[p++]=C[1],l[p++]=C[2],Y(y,y,r[P]),h[d++]=y[0],h[d++]=y[1],h[d++]=y[2],!pt){let br=(be+1)%n;c.push(U+be),c.push(U+n+be),c.push(U+br),c.push(U+br),c.push(U+n+be),c.push(U+n+br);for(let Rr=0;Rr<6;Rr++){let zt=c.length-6;u.push(c[zt+Rr]-it)}}U+=n}let xr=r[r.length-1];for(let P=0;P<s.length;P++)q(y,w,s[P][0]),q(x,O,s[P][1]),Y(y,y,x),Y(y,y,xr),h[d++]=y[0],h[d++]=y[1],h[d++]=y[2];let at=p/3;l[p++]=_[0],l[p++]=_[1],l[p++]=_[2];let J=U-n;for(let P=0;P<i.length;P++)c.push(i[P][0]>=0?U+i[P][0]:-i[P][0]-1+J),c.push(i[P][2]>=0?U+i[P][2]:-i[P][2]-1+J),c.push(i[P][1]>=0?U+i[P][1]:-i[P][1]-1+J),u.push(at),u.push(at),u.push(at);let De=[[m.POSITION,new L(h,c,3,!0)],[m.NORMAL,new L(l,u,3,!0)]];return new me(t,De)}function P0(t,e,r,s){ee(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),ee(e[0].length===3,"createPolylineGeometry(): malformed vertex"),ee(r==null||r.length===e.length,"createPolylineGeometry: need same number of points and normals"),ee(r==null||r[0].length===3,"createPolylineGeometry(): malformed normal");let i=Qt(3*e.length),a=new Array(2*(e.length-1)),o=0,n=0;for(let l=0;l<e.length;l++){for(let c=0;c<3;c++)i[o++]=e[l][c];l>0&&(a[n++]=l-1,a[n++]=l)}let h=[[m.POSITION,new L(i,a,3,!0)]];if(r){let l=Te(3*r.length),c=0;for(let u=0;u<e.length;u++)for(let d=0;d<3;d++)l[c++]=r[u][d];h.push([m.NORMAL,new L(l,a,3,!0)])}return s&&h.push([m.COLOR,new L(s,rn(s.length/4),4)]),new me(t,h,null,Ye.Line)}function I0(t,e,r,s,i,a=0){let o=new Array(18),n=[[-r,a,i/2],[s,a,i/2],[0,e+a,i/2],[-r,a,-i/2],[s,a,-i/2],[0,e+a,-i/2]],h=[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5];for(let l=0;l<6;l++)o[3*l]=n[l][0],o[3*l+1]=n[l][1],o[3*l+2]=n[l][2];return new me(t,[[m.POSITION,new L(o,h,3,!0)]])}function D0(t,e){let r=t.getMutableAttribute(m.POSITION).data;for(let s=0;s<r.length;s+=3){let i=r[s],a=r[s+1],o=r[s+2];z(vr,i,a,o),X(vr,vr,e),r[s]=vr[0],r[s+1]=vr[1],r[s+2]=vr[2]}}function L0(t,e=t){let r=t.attributes,s=r.get(m.POSITION).data,i=r.get(m.NORMAL).data;if(i){let a=e.getMutableAttribute(m.NORMAL).data;for(let o=0;o<i.length;o+=3){let n=i[o+1];a[o+1]=-i[o+2],a[o+2]=n}}if(s){let a=e.getMutableAttribute(m.POSITION).data;for(let o=0;o<s.length;o+=3){let n=s[o+1];a[o+1]=-s[o+2],a[o+2]=n}}}function Za(t,e,r,s,i){return!(Math.abs(He(e,t))>i)&&(Ne(r,t,e),Q(r,r),Ne(s,r,t),Q(s,s),!0)}function dh(t,e,r,s,i,a,o){return Za(t,e,i,a,o)||Za(t,r,i,a,o)||Za(t,s,i,a,o)}var ph=.99619469809,vr=R();var fh=class{constructor(e,r={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=F(),this._shaderTransformation=null,this._boundingSphere=null,this.id=ls(),this.layerUid=r.layerUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation!=null&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){ve(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=F(),Se(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??=ys(),X(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*fs(this.shaderTransformation)),this._boundingSphere):yn}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};var bi=class extends er{intersect(e,r,s,i,a,o){return jn(e,s,i,a,void 0,o)}};var ss=class t extends et{initializeProgram(e){return new tt(e.rctx,t.shader.get().build(this.configuration),Tt)}_createPipeline(e,r){let s=this.configuration,i=e===ae.NONE,a=e===ae.FrontFace;return Oe({blending:s.output===E.Color&&s.transparent?i?rr:sr(e):null,culling:Ln(s.cullFace),depthTest:s.draped?null:{func:Ss(e)},depthWrite:s.draped?null:(i||a)&&s.writeDepth?tr:null,drawBuffers:s.output===E.Depth?{buffers:[Nt.NONE]}:ir(e),colorWrite:Ee,stencilWrite:s.hasOccludees?Ur:null,stencilTest:s.hasOccludees?r?jr:Cs:null,polygonOffset:i||a?s.polygonOffset?_c:null:Un(s.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}};ss.shader=new Ke(yl,()=>import("./chunk-U5LZLALX.js"));var _c={factor:1,units:1};var K=class extends Ms{constructor(){super(...arguments),this.output=E.Color,this.cullFace=Vr.None,this.transparencyPassType=ae.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1}};f([D({count:E.COUNT})],K.prototype,"output",void 0),f([D({count:Vr.COUNT})],K.prototype,"cullFace",void 0),f([D({count:ae.COUNT})],K.prototype,"transparencyPassType",void 0),f([D()],K.prototype,"hasSlicePlane",void 0),f([D()],K.prototype,"hasVertexColors",void 0),f([D()],K.prototype,"transparent",void 0),f([D()],K.prototype,"polygonOffset",void 0),f([D()],K.prototype,"enableOffset",void 0),f([D()],K.prototype,"writeDepth",void 0),f([D()],K.prototype,"hasOccludees",void 0),f([D()],K.prototype,"multipassEnabled",void 0),f([D()],K.prototype,"cullAboveGround",void 0),f([D()],K.prototype,"objectAndLayerIdColorInstanced",void 0),f([D()],K.prototype,"vvColor",void 0),f([D()],K.prototype,"draped",void 0),f([D({constValue:!1})],K.prototype,"occlusionPass",void 0),f([D({constValue:!0})],K.prototype,"hasVvInstancing",void 0),f([D({constValue:!1})],K.prototype,"vvSize",void 0),f([D({constValue:!1})],K.prototype,"vvOpacity",void 0);var gh=class extends bi{constructor(e){super(e,new Ja),this.supportsEdges=!0,this.produces=new Map([[j.OPAQUE_MATERIAL,r=>r===E.Highlight||Os(r)&&!this._isTransparent],[j.OPAQUE_NO_SSAO_DEPTH,r=>$t(r)&&this.parameters.writeLinearDepth&&!this._isTransparent],[j.TRANSPARENT_MATERIAL,r=>Os(r)&&this._isTransparent&&this.parameters.writeDepth],[j.TRANSPARENT_NO_SSAO_DEPTH,r=>$t(r)&&this.parameters.writeLinearDepth&&this._isTransparent&&this.parameters.writeDepth],[j.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,r=>(Os(r)||$t(r)&&this.parameters.writeLinearDepth)&&this._isTransparent&&!this.parameters.writeDepth],[j.DRAPED_MATERIAL,r=>Ts(r)]]),this._configuration=new K}getConfiguration(e,r){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._isTransparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<Vn,this._configuration.multipassEnabled=r.multipassEnabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}createGLMaterial(e){return new Xa(e)}createBufferWriter(){let e=We().vec3f(m.POSITION);return Re("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(m.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?e.f32(m.COLORFEATUREATTRIBUTE):e.vec4u8(m.COLOR),new qn(e)}get _isTransparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}},Xa=class extends bs{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output===E.Color&&this._updateOccludeeState(e),this.ensureTechnique(ss,e)}},Ja=class extends Br{constructor(){super(...arguments),this.color=Ui,this.forceTransparentMode=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Vr.None,this.hasOccludees=!1,this.draped=!1}};var ce={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},yc={dash:ce.dash,"dash-dot":[...ce.dash,...ce.dot],dot:ce.dot,"long-dash":ce["long-dash"],"long-dash-dot":[...ce["long-dash"],...ce.dot],"long-dash-dot-dot":[...ce["long-dash"],...ce.dot,...ce.dot],none:null,"short-dash":ce["short-dash"],"short-dash-dot":[...ce["short-dash"],...ce["short-dot"]],"short-dash-dot-dot":[...ce["short-dash"],...ce["short-dot"],...ce["short-dot"]],"short-dot":ce["short-dot"],solid:null},vc=8;function Tc(t,e){return t==null?t:{pattern:t.slice(),pixelRatio:e}}function Ev(t){return{pattern:[t,t],pixelRatio:2}}function Av(t){return t!=null&&t.type==="style"?Oc(t.style):null}function Oc(t){return t!=null?Tc(yc[t],vc):null}function zv(t,e,r=null){let s=[],i=e.mapPositions;wc(e,s);let a=s[0][1].data,o=s[0][1].indices.length,n=Pr(o);return xc(e,s,n),Sc(e,s,n),bc(e,s,n),Rc(e,s,n),Cc(e,s,n),Ec(e,s,n),Ac(e,s,a),new me(t,s,i,Ye.Line,r)}function wc(t,e){let{attributeData:{position:r},removeDuplicateStartEnd:s}=t,i=Mc(r)&&s,a=r.length/3-(i?1:0),o=new Array(2*(a-1)),n=i?r.slice(0,-3):r,h=0;for(let l=0;l<a-1;l++)o[h++]=l,o[h++]=l+1;e.push([m.POSITION,new L(n,o,3,i)])}function xc(t,e,r){if(t.attributeData.colorFeature!=null)return;let s=t.attributeData.color;e.push([m.COLOR,new L(s??kt,r,4)])}function bc(t,e,r){t.attributeData.normal&&e.push([m.NORMAL,new L(t.attributeData.normal,r,3)])}function Rc(t,e,r){t.attributeData.colorFeature!=null&&e.push([m.COLORFEATUREATTRIBUTE,new L([t.attributeData.colorFeature],r,1,!0)])}function Sc(t,e,r){t.attributeData.sizeFeature==null&&e.push([m.SIZE,new L([t.attributeData.size??1],r,1,!0)])}function Cc(t,e,r){t.attributeData.sizeFeature!=null&&e.push([m.SIZEFEATUREATTRIBUTE,new L([t.attributeData.sizeFeature],r,1,!0)])}function Ec(t,e,r){t.attributeData.opacityFeature!=null&&e.push([m.OPACITYFEATUREATTRIBUTE,new L([t.attributeData.opacityFeature],r,1,!0)])}function Ac(t,e,r){if(t.overlayInfo==null||t.overlayInfo.renderCoordsHelper.viewingMode!==Ce.Global||!t.overlayInfo.spatialReference.isGeographic)return;let s=Qt(r.length),i=lo(t.overlayInfo.spatialReference);for(let u=0;u<s.length;u+=3)Uo(r,u,s,u,i);let a=r.length/3,o=Te(a+1),n=Pc,h=Ic,l=0,c=0;Pt(n,s[c++],s[c++]),c++,o[0]=0;for(let u=1;u<a+1;++u)u===a&&(c=0),Pt(h,s[c++],s[c++]),c++,l+=qo(n,h),o[u]=l,[n,h]=[h,n];e.push([m.DISTANCETOSTART,new L(o,e[0][1].indices,1,!0)])}function Mc(t){let e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}var Pc=k(),Ic=k();function Qv(t,e,r,s){let i=t.type==="polygon"?Nr.CCW_IS_HOLE:Nr.NONE,a=t.type==="polygon"?t.rings:t.paths,{position:o,outlines:n}=qi(a,!!t.hasZ,i,t.spatialReference),h=Qt(o.length),l=Tl(o,t.spatialReference,0,h,0,o,0,o.length/3,e,r,s),c=l!=null;return{lines:c?_h(n,o,h):[],projectionSuccess:c,sampledElevation:l}}function $v(t,e){let r=t.type==="polygon"?Nr.CCW_IS_HOLE:Nr.NONE,s=t.type==="polygon"?t.rings:t.paths,{position:i,outlines:a}=qi(s,!1,r),o=Mt(i,t.spatialReference,0,i,e,0,i.length/3);for(let n=2;n<i.length;n+=3)i[n]=uh;return{lines:o?_h(a,i):[],projectionSuccess:o}}function _h(t,e,r=null){let s=new Array;for(let{index:i,count:a}of t){if(a<=1)continue;let o=3*i,n=3*a;s.push({position:zi(e,3*i,3*a),mapPositions:r!=null?zi(r,o,n):void 0})}return s}function Dc(t){return t instanceof Float32Array&&t.length>=16}function Lc(t){return Array.isArray(t)&&t.length>=16}function yh(t){return Dc(t)||Lc(t)}var Ri=class{constructor(){this.factor=new Si,this.factorAlignment=new Si}},Si=class{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}};var is=class t extends et{initializeConfiguration(e,r){r.spherical=e.viewingMode===Ce.Global}initializeProgram(e){return new tt(e.rctx,t.shader.get().build(this.configuration),Tt)}initializePipeline(){let e=this.configuration.transparencyPassType,r=this.configuration,s=e===ae.NONE,i=e===ae.FrontFace,a=this.configuration.hasPolygonOffset?Nc:null,o=r.draped?null:(s||i)&&r.output!==E.Highlight&&(r.depthEnabled||r.occlusionPass)?tr:null;return Oe({blending:r.output===E.Color||r.output===E.Highlight?s?Vc:sr(e):null,depthTest:r.draped?null:{func:Jo.LEQUAL},depthWrite:o,drawBuffers:ir(e),colorWrite:Ee,polygonOffset:a})}get primitiveType(){return this.configuration.occlusionPass?Jt.POINTS:Jt.TRIANGLES}};is.shader=new Ke(_l,()=>import("./chunk-6UBH3NMD.js"));var Nc={factor:0,units:-4},Vc=Rs(ze.ONE,ze.ONE_MINUS_SRC_ALPHA);var Z=class extends Ms{constructor(){super(...arguments),this.output=E.Color,this.transparencyPassType=ae.NONE,this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}};f([D({count:E.COUNT})],Z.prototype,"output",void 0),f([D({count:ae.COUNT})],Z.prototype,"transparencyPassType",void 0),f([D()],Z.prototype,"screenCenterOffsetUnitsEnabled",void 0),f([D()],Z.prototype,"spherical",void 0),f([D()],Z.prototype,"occlusionTestEnabled",void 0),f([D()],Z.prototype,"signedDistanceFieldEnabled",void 0),f([D()],Z.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),f([D()],Z.prototype,"vvSize",void 0),f([D()],Z.prototype,"vvColor",void 0),f([D()],Z.prototype,"hasVerticalOffset",void 0),f([D()],Z.prototype,"hasScreenSizePerspective",void 0),f([D()],Z.prototype,"debugDrawLabelBorder",void 0),f([D()],Z.prototype,"hasSlicePlane",void 0),f([D()],Z.prototype,"hasPolygonOffset",void 0),f([D()],Z.prototype,"depthEnabled",void 0),f([D()],Z.prototype,"pixelSnappingEnabled",void 0),f([D()],Z.prototype,"draped",void 0),f([D()],Z.prototype,"multipassEnabled",void 0),f([D()],Z.prototype,"cullAboveGround",void 0),f([D()],Z.prototype,"occlusionPass",void 0),f([D()],Z.prototype,"objectAndLayerIdColorInstanced",void 0),f([D({constValue:!0})],Z.prototype,"hasSliceInVertexProgram",void 0),f([D({constValue:!1})],Z.prototype,"hasVvInstancing",void 0);var vh=class extends er{constructor(e){super(e,new to),this._configuration=new Z,this.produces=new Map([[j.HUD_MATERIAL,r=>ws(r)&&!this.parameters.drawInSecondSlot],[j.LABEL_MATERIAL,r=>ws(r)&&this.parameters.drawInSecondSlot],[j.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[j.DRAPED_MATERIAL,r=>ws(r)]])}getConfiguration(e,r){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen",this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=r.slot===j.OCCLUSION_PIXELS&&this.parameters.occlusionTest,e===E.Color&&(this._configuration.debugDrawLabelBorder=!!ar.LABELS_SHOW_BORDER),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.multipassEnabled=r.multipassEnabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}intersect(e,r,s,i,a,o){if(!(s.options.selectionMode&&s.options.hud&&e.visible&&s.point))return;let n=this.parameters,h=s.point,l=s.camera,{scaleX:c,scaleY:u}=this._getScreenScale(e);c*=l.pixelRatio,u*=l.pixelRatio,Wi($a,r),e.attributes.has(m.FEATUREATTRIBUTE)&&Uc($a);let d=e.attributes.get(m.POSITION),p=e.attributes.get(m.SIZE),g=e.attributes.get(m.NORMAL),_=e.attributes.get(m.CENTEROFFSETANDDISTANCE);ee(d.size>=3);let O=aa(n),v=this.parameters.centerOffsetUnits==="screen";for(let w=0;w<d.data.length/d.size;w++){let y=w*d.size;z(ue,d.data[y],d.data[y+1],d.data[y+2]),X(ue,ue,r);let C=w*p.size;Ct[0]=p.data[C]*c,Ct[1]=p.data[C+1]*u,X(ue,ue,l.viewMatrix);let x=w*_.size;if(z(Ie,_.data[x],_.data[x+1],_.data[x+2]),!v&&(ue[0]+=Ie[0],ue[1]+=Ie[1],Ie[2]!==0)){let T=Ie[2];Q(Ie,ue),$(ue,ue,q(Ie,Ie,T))}let M=w*g.size;if(z(as,g.data[M],g.data[M+1],g.data[M+2]),Th(as,$a,l,Ka),this._applyVerticalOffsetTransformationView(ue,Ka,l,Qa),l.applyProjection(ue,fe),fe[0]>-1){v&&(Ie[0]||Ie[1])&&(fe[0]+=Ie[0]*l.pixelRatio,Ie[1]!==0&&(fe[1]+=Mn(Ie[1],Qa.factorAlignment)*l.pixelRatio),l.unapplyProjection(fe,ue)),fe[0]+=this.parameters.screenOffset[0]*l.pixelRatio,fe[1]+=this.parameters.screenOffset[1]*l.pixelRatio,fe[0]=Math.floor(fe[0]),fe[1]=Math.floor(fe[1]),Pn(Ct,Qa.factor,Ct);let T=Wc*l.pixelRatio,W=0;if(n.textureIsSignedDistanceField&&(W=n.outlineSize*l.pixelRatio/2),Oh(h,fe[0],fe[1],Ct,T,W,n,O)){let H=s.ray;if(X(wh,ue,Qe(Bc,l.viewMatrix)),fe[0]=h[0],fe[1]=h[1],l.unprojectFromRenderScreen(fe,ue)){let A=R();G(A,H.direction);let ie=1/Le(A);q(A,A,ie),o(ot(H.origin,ue)*ie,A,-1,!0,1,wh)}}}}}intersectDraped(e,r,s,i,a,o){let n=e.attributes.get(m.POSITION),h=e.attributes.get(m.SIZE),l=this.parameters,c=aa(l),{scaleX:u,scaleY:d}=this._getScreenScale(e);u*=e.screenToWorldRatio,d*=e.screenToWorldRatio;let p=zc*e.screenToWorldRatio;for(let g=0;g<n.data.length/n.size;g++){let _=g*n.size,O=n.data[_],v=n.data[_+1],w=g*h.size;Ct[0]=h.data[w]*u,Ct[1]=h.data[w+1]*d;let y=0;l.textureIsSignedDistanceField&&(y=l.outlineSize*e.screenToWorldRatio/2),Oh(i,O,v,Ct,p,y,l,c)&&a(o.dist,o.normal,-1,!1)}}createBufferWriter(){return new ro(this)}_updateScaleInfo(e,r,s){let i=this.parameters;i.screenSizePerspective!=null?Ki(s,r,i.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),i.screenSizePerspectiveAlignment!=null?Ki(s,r,i.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,r,s,i,a,o,n){let h=Th(r,s,a,Ka);return this._applyVerticalGroundOffsetView(e,h,a,n),this._applyVerticalOffsetTransformationView(n,h,a,o),this._applyPolygonOffsetView(n,h,i[3],a,n),this._applyCenterOffsetView(n,i,n),n}applyShaderOffsetsNDC(e,r,s,i,a){return this._applyCenterOffsetNDC(e,r,s,i),a!=null&&G(a,i),this._applyPolygonOffsetNDC(i,r,s,i),i}_applyPolygonOffsetView(e,r,s,i,a){let o=i.aboveGround?1:-1,n=Math.sign(s);n===0&&(n=o);let h=o*n;if(this.parameters.shaderPolygonOffset<=0)return G(a,e);let l=_t(Math.abs(r.cosAngle),.01,1),c=1-Math.sqrt(1-l*l)/l/i.viewport[2];return q(a,e,h>0?c:1/c),a}_applyVerticalGroundOffsetView(e,r,s,i){let a=Le(e),o=s.aboveGround?1:-1,n=s.computeRenderPixelSizeAtDist(a)*gl,h=q(ue,r.normal,o*n);return Y(i,e,h),i}_applyVerticalOffsetTransformationView(e,r,s,i){let a=this.parameters;if(!a.verticalOffset?.screenLength){if(a.screenSizePerspective||a.screenSizePerspectiveAlignment){let l=Le(e);this._updateScaleInfo(i,l,r.cosAngle)}else i.factor.scale=1,i.factorAlignment.scale=1;return e}let o=Le(e),n=a.screenSizePerspectiveAlignment??a.screenSizePerspective,h=In(s,o,a.verticalOffset,r.cosAngle,n);return this._updateScaleInfo(i,o,r.cosAngle),q(r.normal,r.normal,h),Y(e,e,r.normal)}_applyCenterOffsetView(e,r,s){let i=this.parameters.centerOffsetUnits!=="screen";return s!==e&&G(s,e),i&&(s[0]+=r[0],s[1]+=r[1],r[2]&&(Q(as,s),Y(s,s,q(as,as,r[2])))),s}_applyCenterOffsetNDC(e,r,s,i){let a=this.parameters.centerOffsetUnits!=="screen";return i!==e&&G(i,e),a||(i[0]+=r[0]/s.fullWidth*2,i[1]+=r[1]/s.fullHeight*2),i}_applyPolygonOffsetNDC(e,r,s,i){let a=this.parameters.shaderPolygonOffset;if(e!==i&&G(i,e),a){let o=s.aboveGround?1:-1,n=o*Math.sign(r[3]);i[2]-=(n||o)*a}return i}createGLMaterial(e){return new eo(e)}calculateRelativeScreenBounds(e,r,s=lt()){return Fc(this.parameters,e,r,s),s[2]=s[0]+e[0],s[3]=s[1]+e[1],s}_getScreenScale(e){let r=e.attributes.get(m.FEATUREATTRIBUTE);if(r==null)return{scaleX:1,scaleY:1};let s=Fo(r.data,Hc),[i,a]=Jn(Gc,this.parameters,s);return{scaleX:i,scaleY:a}}},eo=class extends En{constructor(e){super(Sr(Sr({},e),e.material.parameters))}selectProgram(e){return this.ensureTechnique(is,e)}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}};function Fc(t,e,r,s){s[0]=t.anchorPosition[0]*-e[0]+t.screenOffset[0]*r,s[1]=t.anchorPosition[1]*-e[1]+t.screenOffset[1]*r}function Th(t,e,r,s){return yh(e)&&(e=Wi(jc,e)),yo(s.normal,t,e),X(s.normal,s.normal,r.viewInverseTransposeMatrix),s.cosAngle=He(xh,qc),s}function Uc(t){let e=t[0],r=t[1],s=t[2],i=t[3],a=t[4],o=t[5],n=t[6],h=t[7],l=t[8],c=1/Math.sqrt(e*e+r*r+s*s),u=1/Math.sqrt(i*i+a*a+o*o),d=1/Math.sqrt(n*n+h*h+l*l);return t[0]=e*c,t[1]=r*c,t[2]=s*c,t[3]=i*u,t[4]=a*u,t[5]=o*u,t[6]=n*d,t[7]=h*d,t[8]=l*d,t}function Oh(t,e,r,s,i,a,o,n){let h=e-i-(n[0]>0?s[0]*n[0]:0),l=h+s[0]+2*i,c=r-i-(n[1]>0?s[1]*n[1]:0),u=c+s[1]+2*i,d=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&d!=null&&(h+=s[0]*d[0],c+=s[1]*d[1],l-=s[0]*(1-d[2]),u-=s[1]*(1-d[3]),h-=a,l+=a,c-=a,u+=a),t[0]>h&&t[0]<l&&t[1]>c&&t[1]<u}var Qa=new Ri,ue=R(),as=R(),fe=pe(),xh=R(),wh=R(),$a=Ir(),jc=Ir(),Bc=F(),Ie=R(),Gc=R(),Hc=pe(),Ka={normal:xh,cosAngle:0},Wc=1,zc=2,Ct=[0,0],qc=Ge(0,0,1),to=class extends An{constructor(){super(...arguments),this.renderOccluded=le.Occlude,this.isDecoration=!1,this.color=yt(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=ms(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=yt(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1}},bh=We().vec3f(m.POSITION).vec3f(m.NORMAL).vec2f(m.UV0).vec4u8(m.COLOR).vec2f(m.SIZE).vec4f(m.CENTEROFFSETANDDISTANCE).vec4f(m.FEATUREATTRIBUTE),kc=bh.clone().vec4u8(m.OBJECTANDLAYERIDCOLOR),ro=class{constructor(e){this._material=e,this.vertexBufferLayout=Re("enable-feature:objectAndLayerId-rendering")?kc:bh}elementCount(e){return 6*e.attributes.get(m.POSITION).indices.length}write(e,r,s,i,a){Gn(s.attributes.get(m.POSITION),e,i.position,a,6),Hn(s.attributes.get(m.NORMAL),r,i.normal,a,6);let o=s.attributes.get(m.UV0).data,n,h,l,c;if(o==null||o.length<4){let v=this._material.parameters;n=0,h=0,l=v.texCoordScale[0],c=v.texCoordScale[1]}else n=o[0],h=o[1],l=o[2],c=o[3];l=Math.min(1.99999,l+1),c=Math.min(1.99999,c+1);let u=s.attributes.get(m.POSITION).indices.length,d=a,p=i.uv0;for(let v=0;v<u;++v)p.set(d,0,n),p.set(d,1,h),d++,p.set(d,0,l),p.set(d,1,h),d++,p.set(d,0,l),p.set(d,1,c),d++,p.set(d,0,l),p.set(d,1,c),d++,p.set(d,0,n),p.set(d,1,c),d++,p.set(d,0,n),p.set(d,1,h),d++;Wn(s.attributes.get(m.COLOR),4,i.color,a,6);let{data:g,indices:_}=s.attributes.get(m.SIZE);u=_.length;let O=i.size;d=a;for(let v=0;v<u;++v){let w=g[2*_[v]],y=g[2*_[v]+1];for(let C=0;C<6;++C)O.set(d,0,w),O.set(d,1,y),d++}if(s.attributes.get(m.CENTEROFFSETANDDISTANCE)?ta(s.attributes.get(m.CENTEROFFSETANDDISTANCE),i.centerOffsetAndDistance,a,6):ra(i.centerOffsetAndDistance,a,6*u),s.attributes.get(m.FEATUREATTRIBUTE)?ta(s.attributes.get(m.FEATUREATTRIBUTE),i.featureAttribute,a,6):ra(i.featureAttribute,a,6*u),s.objectAndLayerIdColor!=null){let v=s.attributes.get(m.POSITION)?.indices;if(v){let w=v.length,y=i.getField(m.OBJECTANDLAYERIDCOLOR,ko);zn(s.objectAndLayerIdColor,y,w,a,6)}}}};function rT(t,e,r){return!!xn(t,e,Ci,r.spatialReference)&&(r.x=Ci[0],r.y=Ci[1],r.z=Ci[2],!0)}var Ci=R();var nT=We().vec3f(m.POSITION),lT=We().vec3f(m.POSITION).vec2f(m.UV0),hT=We().vec3f(m.POSITION).vec4u8(m.COLOR),cT=We().vec3f(m.POSITION).vec2f(m.UV0).vec4u8(m.OBJECTANDLAYERIDCOLOR);export{lr as a,Gr as b,Qr as c,je as d,Ft as e,Ls as f,Fs as g,Zm as h,Ys as i,kl as j,di as k,wt as l,Dp as m,Gs as n,Hs as o,Ue as p,dt as q,ri as r,xg as s,sh as t,ai as u,uh as v,w0 as w,x0 as x,b0 as y,R0 as z,S0 as A,C0 as B,E0 as C,A0 as D,M0 as E,gc as F,P0 as G,I0 as H,D0 as I,L0 as J,dh as K,fh as L,vl as M,Hr as N,Tl as O,Ol as P,ou as Q,nu as R,lu as S,hu as T,cu as U,Rh as V,na as W,la as X,gu as Y,xl as Z,bl as _,_u as $,yu as aa,Cl as ba,vh as ca,bi as da,gh as ea,El as fa,Ev as ga,Av as ha,zv as ia,Qv as ja,$v as ka,Uu as la,ju as ma,Bu as na,Gu as oa,Hu as pa,Uh as qa,Wu as ra,zu as sa,nT as ta,lT as ua,hT as va,cT as wa,rT as xa};
